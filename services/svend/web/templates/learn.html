{% extends "base_app.html" %}

{% block title %}Learn - SVEND{% endblock %}

{% block extra_head %}
<!-- Marked.js for markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- KaTeX for LaTeX rendering -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
<!-- Plotly for DSW inline results -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
{% endblock %}

{% block content %}
<div id="learn-app">
    <!-- Header -->
    <div class="learn-header">
        <div class="learn-header-content">
            <div>
                <h1>Learn</h1>
                <p class="learn-subtitle">Master statistical analysis by doing — guided exercises with real tools</p>
            </div>
            <div class="learn-progress-summary" id="progress-summary">
                <div class="progress-ring">
                    <svg viewBox="0 0 36 36">
                        <path class="progress-ring-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                        <path class="progress-ring-fill" id="progress-ring-fill" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                    </svg>
                    <span class="progress-pct" id="progress-pct">0%</span>
                </div>
                <div class="progress-text">
                    <span id="sections-completed">0</span> of <span id="sections-total">0</span> sections
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="learn-content">
        <!-- Sidebar: Module List -->
        <aside class="learn-sidebar">
            <div class="sidebar-section">
                <h3>Curriculum</h3>
                <div id="module-list" class="module-list">
                    <!-- Populated by JS -->
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Search</h3>
                <input type="text" id="search-input" placeholder="Search topics..." class="search-input">
            </div>
        </aside>

        <!-- Main: Module/Section Content -->
        <main class="learn-main">
            <!-- Welcome View (default) -->
            <div id="welcome-view" class="view active">
                <div class="card welcome-card">
                    <h2>Learn by Doing</h2>
                    <p>Each section has a guided exercise with real sample data. Run analyses, see results, build intuition.</p>
                    <ul class="welcome-list">
                        <li><strong>Guided exercises</strong> — Work through real problems with sample data, not just reading</li>
                        <li><strong>Run in DSW</strong> — Every analysis you learn, you immediately try with real tools</li>
                        <li><strong>10 modules</strong> — From Bayesian thinking to advanced methods and DOE</li>
                        <li><strong>Build skills</strong> — Progress through foundations, inference, causal reasoning, and mastery</li>
                    </ul>
                    <button class="btn btn-primary" onclick="startCourse()">Start Learning</button>
                </div>
            </div>

            <!-- Module View -->
            <div id="module-view" class="view">
                <div class="module-header">
                    <h2 id="module-title"></h2>
                    <p id="module-description"></p>
                </div>
                <div id="section-list" class="section-list">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Section Content View -->
            <div id="section-view" class="view">
                <div class="section-header">
                    <button class="btn btn-secondary btn-sm" onclick="backToModule()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                        Back to Module
                    </button>
                    <span class="section-breadcrumb" id="section-breadcrumb"></span>
                </div>
                <div id="section-content" class="section-content">
                    <!-- Populated by JS -->
                </div>
                <div class="section-footer">
                    <button class="btn btn-primary" id="complete-section-btn" onclick="completeSection()">
                        Mark as Complete
                    </button>
                </div>
            </div>

            <!-- Assessment View -->
            <div id="assessment-view" class="view">
                <div class="assessment-header">
                    <h2>Knowledge Check</h2>
                    <p>Answer <span id="question-count">15</span> questions. Passing score: <span id="passing-score">80%</span></p>
                    <div class="assessment-timer" id="assessment-timer">30:00</div>
                </div>
                <div id="assessment-questions" class="assessment-questions">
                    <!-- Populated by JS -->
                </div>
                <div class="assessment-footer">
                    <button class="btn btn-primary" id="submit-assessment-btn" onclick="submitAssessment()">
                        Submit Assessment
                    </button>
                </div>
            </div>

            <!-- Results View -->
            <div id="results-view" class="view">
                <div id="results-content" class="results-content">
                    <!-- Populated by JS -->
                </div>
            </div>

        </main>
    </div>
</div>

<style>
/* Learn Page Styles */
.learn-header {
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border);
}

.learn-header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.learn-subtitle {
    color: var(--text-secondary);
    margin: 0;
}

.learn-progress-summary {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.progress-ring {
    position: relative;
    width: 60px;
    height: 60px;
}

.progress-ring svg {
    transform: rotate(-90deg);
}

.progress-ring-bg {
    fill: none;
    stroke: var(--bg-tertiary);
    stroke-width: 3;
}

.progress-ring-fill {
    fill: none;
    stroke: var(--accent-primary);
    stroke-width: 3;
    stroke-linecap: round;
    transition: stroke-dasharray 0.5s ease;
}

.progress-pct {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text-primary);
}

.progress-text {
    color: var(--text-secondary);
    font-size: 0.85rem;
}

/* Layout */
.learn-content {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 2rem;
}

/* Sidebar */
.learn-sidebar {
    position: sticky;
    top: 2rem;
    align-self: start;
}

.sidebar-section {
    margin-bottom: 2rem;
}

.sidebar-section h3 {
    margin-bottom: 1rem;
}

.module-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.module-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.module-item:hover {
    border-color: var(--accent-primary-border);
}

.module-item.active {
    border-color: var(--accent-primary);
    background: var(--accent-primary-dim);
}

.module-item.completed {
    border-left: 3px solid var(--accent-primary);
}

.module-icon {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: var(--bg-tertiary);
    color: var(--text-dim);
    font-size: 0.75rem;
}

.module-item.completed .module-icon {
    background: var(--accent-primary-dim);
    color: var(--accent-primary);
}

.module-info {
    flex: 1;
}

.module-name {
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-primary);
}

.module-progress {
    font-size: 0.75rem;
    color: var(--text-dim);
}

.search-input {
    width: 100%;
}

/* Main Content */
.learn-main {
    min-height: 60vh;
}

.view {
    display: none;
}

.view.active {
    display: block;
}

/* Welcome */
.welcome-card {
    max-width: 700px;
}

.welcome-list {
    list-style: none;
    padding: 0;
    margin: 1.5rem 0;
}

.welcome-list li {
    padding: 0.5rem 0;
    padding-left: 1.5rem;
    position: relative;
    color: var(--text-secondary);
}

.welcome-list li::before {
    content: ">";
    position: absolute;
    left: 0;
    color: var(--accent-primary);
}

/* Section List */
.section-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.section-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.25rem;
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.section-item:hover {
    border-color: var(--accent-primary-border);
}

.section-item.completed {
    border-left: 3px solid var(--accent-primary);
}

.section-item.coming-soon {
    opacity: 0.6;
    cursor: not-allowed;
}

.section-status {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: var(--bg-tertiary);
    color: var(--text-dim);
    flex-shrink: 0;
}

.section-item.completed .section-status {
    background: var(--accent-primary-dim);
    color: var(--accent-primary);
}

.section-info {
    flex: 1;
}

.section-title {
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
}

.section-desc {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.section-meta {
    display: flex;
    gap: 1rem;
    margin-top: 0.5rem;
}

.section-meta span {
    font-size: 0.75rem;
    color: var(--text-dim);
}

/* Section Content */
.section-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.section-breadcrumb {
    color: var(--text-dim);
    font-size: 0.85rem;
}

.section-content {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 2rem;
    margin-bottom: 1.5rem;
}

.section-content h3 {
    color: var(--text-primary);
    margin-bottom: 1rem;
}

.topic-list {
    list-style: none;
    padding: 0;
}

.topic-list li {
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border);
    color: var(--text-secondary);
}

.topic-list li:last-child {
    border-bottom: none;
}

.section-footer {
    display: flex;
    justify-content: flex-end;
}

/* Assessment */
.assessment-header {
    text-align: center;
    margin-bottom: 2rem;
}

.assessment-timer {
    font-size: 1.5rem;
    font-weight: 500;
    color: var(--accent-primary);
    font-family: 'JetBrains Mono', monospace;
}

.assessment-questions {
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

.question-card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 1.5rem;
}

.question-number {
    font-size: 0.75rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 0.5rem;
}

.question-text {
    font-size: 1rem;
    color: var(--text-primary);
    margin-bottom: 1.25rem;
}

.question-options {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.option-label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.option-label:hover {
    border-color: var(--accent-primary-border);
}

.option-label input[type="radio"] {
    width: auto;
    margin: 0;
}

.option-label.selected {
    border-color: var(--accent-primary);
    background: var(--accent-primary-dim);
}

.assessment-footer {
    margin-top: 2rem;
    display: flex;
    justify-content: center;
}

/* Results */
.results-content {
    text-align: center;
}

.results-score {
    font-size: 4rem;
    font-weight: 300;
    margin: 1rem 0;
}

.results-score.passed {
    color: var(--accent-primary);
}

.results-score.failed {
    color: var(--error);
}

.results-message {
    font-size: 1.25rem;
    margin-bottom: 2rem;
}

.results-breakdown {
    max-width: 600px;
    margin: 0 auto;
    text-align: left;
}

.result-item {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    margin-bottom: 0.5rem;
}

.result-item.correct {
    border-left: 3px solid var(--accent-primary);
}

.result-item.incorrect {
    border-left: 3px solid var(--error);
}

/* Exercise Block */
.exercise-block {
    background: var(--bg-secondary);
    border: 2px solid var(--accent);
    border-radius: 8px;
    padding: 1.5rem;
    margin: 1.5rem 0;
}

.exercise-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    font-size: 1.1rem;
    color: var(--accent);
}

.exercise-steps {
    margin: 0;
    padding-left: 1.5rem;
    color: var(--text-primary);
    line-height: 1.8;
}

.exercise-steps li {
    margin-bottom: 0.5rem;
}

/* Widget prominent wrapper */
.widget-prominent {
    margin: 1.5rem 0;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.5rem;
}

/* Go Deeper collapsible */
.deep-dive-section {
    margin: 2rem 0;
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
}

.deep-dive-toggle {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    width: 100%;
    padding: 1rem 1.25rem;
    background: var(--bg-secondary);
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 600;
    text-align: left;
}

.deep-dive-toggle:hover {
    color: var(--text-primary);
    background: var(--bg-tertiary, var(--bg-secondary));
}

.deep-dive-arrow {
    transition: transform 0.2s;
}

.deep-dive-toggle.open .deep-dive-arrow {
    transform: rotate(180deg);
}

.deep-dive-content {
    padding: 1.5rem;
    border-top: 1px solid var(--border);
}

/* Section intro */
.section-intro {
    font-size: 1.05rem;
    line-height: 1.7;
    margin-bottom: 1rem;
}

/* Responsive */
@media (max-width: 900px) {
    .learn-content {
        grid-template-columns: 1fr;
    }

    .learn-sidebar {
        position: static;
    }
}

/* Rich Content Styles */
.section-content h2 {
    color: var(--text-primary);
    margin-bottom: 1.5rem;
    font-size: 1.5rem;
}

.section-content h3 {
    color: var(--text-primary);
    margin-top: 2rem;
    margin-bottom: 1rem;
}

.section-content p {
    color: var(--text-secondary);
    line-height: 1.7;
    margin-bottom: 1rem;
}

.section-content ul, .section-content ol {
    color: var(--text-secondary);
    margin-bottom: 1rem;
    padding-left: 1.5rem;
}

.section-content li {
    margin-bottom: 0.5rem;
    line-height: 1.6;
}

.section-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
}

.section-content th, .section-content td {
    border: 1px solid var(--border);
    padding: 0.75rem;
    text-align: left;
}

.section-content th {
    background: var(--bg-tertiary);
    color: var(--text-primary);
}

.section-content td {
    color: var(--text-secondary);
}

.section-content code {
    background: var(--bg-tertiary);
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.9em;
}

.section-content pre {
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 1rem;
    overflow-x: auto;
    margin: 1rem 0;
}

.section-content pre code {
    background: none;
    padding: 0;
}

.section-content strong {
    color: var(--text-primary);
}

.section-content blockquote {
    border-left: 3px solid var(--accent-primary);
    margin: 1rem 0;
    padding-left: 1rem;
    color: var(--text-secondary);
}

/* Key Takeaways */
.key-takeaways {
    background: var(--accent-primary-dim);
    border: 1px solid var(--accent-primary-border);
    border-radius: 4px;
    padding: 1.5rem;
    margin: 2rem 0;
}

.key-takeaways h3 {
    margin-top: 0;
    color: var(--accent-primary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.key-takeaways ul {
    margin: 0;
    color: var(--text-primary);
}

.key-takeaways li {
    margin-bottom: 0.5rem;
}

/* Practice Questions */
.practice-questions {
    margin-top: 2rem;
}

.practice-questions h3 {
    margin-bottom: 1rem;
}

.practice-question {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 1.5rem;
    margin-bottom: 1rem;
}

.practice-question .question-text {
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 1rem;
}

.practice-question .hint-toggle {
    color: var(--accent-primary);
    cursor: pointer;
    font-size: 0.9rem;
    margin-right: 1rem;
}

.practice-question .answer-toggle {
    color: var(--text-dim);
    cursor: pointer;
    font-size: 0.9rem;
}

.practice-question .hint, .practice-question .answer {
    display: none;
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 4px;
}

.practice-question .hint {
    background: var(--accent-primary-dim);
    border-left: 3px solid var(--accent-primary);
}

.practice-question .answer {
    background: var(--bg-tertiary);
    border-left: 3px solid var(--accent-secondary);
}

.practice-question .hint.visible, .practice-question .answer.visible {
    display: block;
}

/* Interactive Widgets */
.interactive-widget {
    background: var(--card-bg);
    border: 2px solid var(--accent-primary-border);
    border-radius: 8px;
    padding: 2rem;
    margin: 2rem 0;
}

.interactive-widget h3 {
    margin-top: 0;
    color: var(--accent-primary);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.widget-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.widget-row label {
    min-width: 150px;
    color: var(--text-secondary);
}

.widget-row input[type="number"], .widget-row input[type="range"] {
    flex: 1;
    max-width: 200px;
}

.widget-row input[type="range"] {
    -webkit-appearance: none;
    height: 8px;
    background: var(--bg-tertiary);
    border-radius: 4px;
}

.widget-row input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    background: var(--accent-primary);
    border-radius: 50%;
    cursor: pointer;
}

.widget-value {
    min-width: 60px;
    font-family: 'JetBrains Mono', monospace;
    color: var(--text-primary);
}

.widget-result {
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 1.5rem;
    margin-top: 1.5rem;
}

.widget-result .result-label {
    font-size: 0.85rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 0.5rem;
}

.widget-result .result-value {
    font-size: 2rem;
    font-weight: 500;
    color: var(--accent-primary);
    font-family: 'JetBrains Mono', monospace;
}

.widget-result .result-explanation {
    margin-top: 1rem;
    color: var(--text-secondary);
    font-size: 0.9rem;
}

/* KaTeX display equations */
.katex-display {
    margin: 1.5rem 0;
    overflow-x: auto;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// State
let currentView = 'welcome';
let currentModule = null;
let currentSection = null;
let modules = [];
let progress = {};
let assessmentId = null;
let assessmentQuestions = [];
let assessmentTimer = null;
let assessmentTimeLeft = 30 * 60; // 30 minutes in seconds

// Initialize
document.addEventListener('DOMContentLoaded', async () => {
    await loadModules();
    await loadProgress();
    renderModuleList();
    updateProgressDisplay();
});

// API calls
async function loadModules() {
    try {
        const response = await fetch('/api/learn/modules/', { credentials: 'include' });
        if (response.ok) {
            const data = await response.json();
            modules = data.modules;
        }
    } catch (err) {
        console.error('Failed to load modules:', err);
    }
}

async function loadProgress() {
    try {
        const response = await fetch('/api/learn/progress/', { credentials: 'include' });
        if (response.ok) {
            progress = await response.json();
        }
    } catch (err) {
        console.error('Failed to load progress:', err);
    }
}

// Rendering
function renderModuleList() {
    const container = document.getElementById('module-list');
    container.innerHTML = modules.map(m => `
        <div class="module-item ${m.completed_sections === m.section_count ? 'completed' : ''}"
             onclick="selectModule('${m.id}')" data-module="${m.id}">
            <div class="module-icon">
                ${m.completed_sections === m.section_count ? '&#10003;' : m.order}
            </div>
            <div class="module-info">
                <div class="module-name">${m.title}</div>
                <div class="module-progress">${m.completed_sections}/${m.section_count} complete</div>
            </div>
        </div>
    `).join('');
}

function updateProgressDisplay() {
    if (!progress.total_sections) return;

    const pct = progress.overall_progress_pct;
    document.getElementById('progress-pct').textContent = pct + '%';
    document.getElementById('progress-ring-fill').setAttribute('stroke-dasharray', `${pct}, 100`);
    document.getElementById('sections-completed').textContent = progress.completed_sections;
    document.getElementById('sections-total').textContent = progress.total_sections;
}

// Navigation
function showView(viewId) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById(viewId + '-view').classList.add('active');
    currentView = viewId;
}

function startCourse() {
    if (modules.length > 0) {
        selectModule(modules[0].id);
    }
}

async function selectModule(moduleId) {
    try {
        const response = await fetch(`/api/learn/modules/${moduleId}/`, { credentials: 'include' });
        if (response.ok) {
            const data = await response.json();
            currentModule = data;

            document.getElementById('module-title').textContent = data.title;
            document.getElementById('module-description').textContent = data.description;

            document.getElementById('section-list').innerHTML = data.sections.map(s => `
                <div class="section-item ${s.completed ? 'completed' : ''} ${s.coming_soon ? 'coming-soon' : ''}"
                     onclick="${s.coming_soon ? '' : `selectSection('${moduleId}', '${s.id}')`}">
                    <div class="section-status">
                        ${s.completed ? '&#10003;' : s.coming_soon ? '...' : '&gt;'}
                    </div>
                    <div class="section-info">
                        <div class="section-title">${s.title}</div>
                        <div class="section-desc">${s.description}</div>
                        <div class="section-meta">
                            <span>${s.estimated_minutes} min</span>
                            <span>${s.topics.length} topics</span>
                            ${s.interactive ? '<span style="color: var(--accent-primary);">Interactive</span>' : ''}
                            ${s.coming_soon ? '<span style="color: var(--accent-gold);">Coming Soon</span>' : ''}
                        </div>
                    </div>
                </div>
            `).join('');

            // Update sidebar active state
            document.querySelectorAll('.module-item').forEach(el => {
                el.classList.toggle('active', el.dataset.module === moduleId);
            });

            showView('module');
        }
    } catch (err) {
        console.error('Failed to load module:', err);
    }
}

async function selectSection(moduleId, sectionId) {
    try {
        const response = await fetch(`/api/learn/modules/${moduleId}/sections/${sectionId}/`, { credentials: 'include' });
        if (response.ok) {
            const data = await response.json();
            currentSection = data;

            document.getElementById('section-breadcrumb').textContent = `${data.module_title} > ${data.title}`;

            // Render section content
            let html = '';
            window.sectionInteracted = false;

            // Check if we have rich content
            if (data.rich_content && data.rich_content.content) {
                // Store section data for widget access
                window.currentSectionData = data.rich_content;
                const rc = data.rich_content;

                // 1. INTRO — short hook (explicit intro field or auto-extracted first paragraph)
                let introText = '';
                let deepDiveContent = rc.content;
                if (rc.intro) {
                    introText = rc.intro;
                } else {
                    // Auto-extract: first block before the first ## heading
                    const firstHeading = rc.content.indexOf('\n## ');
                    if (firstHeading > 0) {
                        introText = rc.content.substring(0, firstHeading).trim();
                        deepDiveContent = rc.content.substring(firstHeading);
                    } else {
                        // No headings — use first 2 paragraphs
                        const paras = rc.content.split('\n\n');
                        introText = paras.slice(0, 2).join('\n\n');
                        deepDiveContent = paras.slice(2).join('\n\n');
                    }
                }

                html += `<div class="section-intro markdown-content">${marked.parse(introText)}</div>`;

                // 2. EXERCISE — guided activity with interactive widget (prominent)
                if (rc.exercise) {
                    html += `
                        <div class="exercise-block">
                            <div class="exercise-header">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="5 3 19 12 5 21 5 3"/>
                                </svg>
                                <strong>${rc.exercise.title || 'Try It'}</strong>
                            </div>
                            ${rc.exercise.steps ? `
                                <ol class="exercise-steps">
                                    ${rc.exercise.steps.map(s => `<li>${s}</li>`).join('')}
                                </ol>
                            ` : ''}
                            ${rc.exercise.description ? `<p style="color:var(--text-secondary); margin-bottom:1rem;">${rc.exercise.description}</p>` : ''}
                        </div>
                    `;
                }

                // Render interactive widget if available (always prominent)
                if (rc.interactive) {
                    html += `<div class="widget-prominent">${renderInteractiveWidget(rc.interactive)}</div>`;
                }

                // "Run in DSW" button if section has dsw_type
                if (rc.exercise && rc.exercise.dsw_type) {
                    html += `
                        <div style="margin: 1.5rem 0; display:flex; gap:0.75rem; flex-wrap:wrap;">
                            <button class="btn btn-primary" onclick="runInDSW('${rc.exercise.dsw_type}')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle; margin-right:0.25rem;">
                                    <polygon points="5 3 19 12 5 21 5 3"/>
                                </svg>
                                Run in DSW
                            </button>
                            <a href="/app/workbench/" class="btn btn-secondary" style="text-decoration:none;">
                                Open Workbench
                            </a>
                        </div>
                        <div id="dsw-inline-result" style="display:none; margin-bottom:1.5rem;"></div>
                    `;
                }

                // 3. GO DEEPER — collapsible full content
                if (deepDiveContent.trim()) {
                    html += `
                        <div class="deep-dive-section">
                            <button class="deep-dive-toggle" onclick="toggleDeepDive(this)">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="deep-dive-arrow">
                                    <polyline points="6 9 12 15 18 9"/>
                                </svg>
                                Go Deeper — Full Explanation
                            </button>
                            <div class="deep-dive-content markdown-content" style="display:none;">
                                ${marked.parse(deepDiveContent)}
                            </div>
                        </div>
                    `;
                }

                // 4. KEY TAKEAWAYS
                if (rc.key_takeaways && rc.key_takeaways.length > 0) {
                    html += `
                        <div class="key-takeaways">
                            <h3>
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Key Takeaways
                            </h3>
                            <ul>
                                ${rc.key_takeaways.map(t => `<li>${t}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                // 5. PRACTICE QUESTIONS
                if (rc.practice_questions && rc.practice_questions.length > 0) {
                    html += `
                        <div class="practice-questions">
                            <h3>Practice Questions</h3>
                            ${rc.practice_questions.map((q, i) => `
                                <div class="practice-question">
                                    <div class="question-text">${q.question}</div>
                                    <div>
                                        ${q.hint ? `<span class="hint-toggle" onclick="toggleHint(${i})">Show Hint</span>` : ''}
                                        <span class="answer-toggle" onclick="toggleAnswer(${i})">Show Answer</span>
                                    </div>
                                    ${q.hint ? `<div class="hint" id="hint-${i}">${q.hint}</div>` : ''}
                                    <div class="answer" id="answer-${i}">${q.answer}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } else {
                // Fallback for sections without rich content
                html = `
                    <h2>${data.title}</h2>
                    <p style="margin-bottom: 2rem;">${data.description}</p>

                    <h3>Topics Covered</h3>
                    <ul class="topic-list">
                        ${data.topics.map(t => `<li>${t}</li>`).join('')}
                    </ul>

                    <div style="margin-top: 2rem; padding: 1.5rem; background: var(--accent-primary-dim); border-radius: 4px;">
                        <p style="margin: 0; color: var(--text-primary);">
                            <strong>Coming Soon:</strong> Full interactive content for this section is being developed.
                            For now, review the topics above and mark as complete when you're familiar with them.
                        </p>
                    </div>
                `;
            }

            document.getElementById('section-content').innerHTML = html;

            // Render LaTeX equations with KaTeX
            if (typeof renderMathInElement !== 'undefined') {
                renderMathInElement(document.getElementById('section-content'), {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\[', right: '\\]', display: true},
                        {left: '\\(', right: '\\)', display: false}
                    ],
                    throwOnError: false
                });
            }

            // Initialize any interactive widgets
            initializeWidgets();

            // Update complete button state
            const btn = document.getElementById('complete-section-btn');
            const hasWidget = !!(data.rich_content && data.rich_content.interactive);
            if (data.completed) {
                btn.textContent = 'Completed';
                btn.disabled = true;
                btn.style.opacity = '1';
            } else if (hasWidget) {
                btn.textContent = 'Try the exercise first';
                btn.disabled = false;
                btn.style.opacity = '0.5';
            } else {
                btn.textContent = 'Mark as Complete';
                btn.disabled = false;
                btn.style.opacity = '1';
            }

            showView('section');
        }
    } catch (err) {
        console.error('Failed to load section:', err);
    }
}

// Toggle hint/answer visibility
function toggleHint(idx) {
    const el = document.getElementById(`hint-${idx}`);
    el.classList.toggle('visible');
}

function toggleAnswer(idx) {
    const el = document.getElementById(`answer-${idx}`);
    el.classList.toggle('visible');
}

// Deep dive toggle
function toggleDeepDive(btn) {
    btn.classList.toggle('open');
    const content = btn.nextElementSibling;
    content.style.display = content.style.display === 'none' ? 'block' : 'none';
}

// Mark that user has interacted with the section's widget
function markInteracted() {
    window.sectionInteracted = true;
    const btn = document.getElementById('complete-section-btn');
    if (btn && !btn.disabled) {
        btn.style.opacity = '1';
    }
}

// Listen for any click/input inside widget-prominent to track interaction
document.addEventListener('click', (e) => {
    if (e.target.closest('.widget-prominent') || e.target.closest('.interactive-widget')) {
        markInteracted();
    }
});
document.addEventListener('input', (e) => {
    if (e.target.closest('.widget-prominent') || e.target.closest('.interactive-widget')) {
        markInteracted();
    }
});

// Format DSW summary text (color tags → styled spans)
function formatDSWSummary(text) {
    return text
        .replace(/<<COLOR:accent>>(.*?)<<\/COLOR>>/g, '<span style="color:var(--accent)">$1</span>')
        .replace(/<<COLOR:title>>(.*?)<<\/COLOR>>/g, '<span style="color:var(--text-primary);font-weight:bold">$1</span>')
        .replace(/<<COLOR:highlight>>(.*?)<<\/COLOR>>/g, '<span style="color:var(--accent)">$1</span>')
        .replace(/<<COLOR:text>>(.*?)<<\/COLOR>>/g, '<span style="color:var(--text-primary)">$1</span>')
        .replace(/<<COLOR:dim>>(.*?)<<\/COLOR>>/g, '<span style="color:var(--text-tertiary)">$1</span>')
        .replace(/<<COLOR:success>>(.*?)<<\/COLOR>>/g, '<span style="color:#00b894">$1</span>')
        .replace(/<<COLOR:good>>(.*?)<<\/COLOR>>/g, '<span style="color:#00b894">$1</span>')
        .replace(/<<COLOR:warning>>(.*?)<<\/COLOR>>/g, '<span style="color:#fdcb6e">$1</span>')
        .replace(/<<COLOR:danger>>(.*?)<<\/COLOR>>/g, '<span style="color:#d63031">$1</span>')
        .replace(/<<COLOR:bad>>(.*?)<<\/COLOR>>/g, '<span style="color:#d63031">$1</span>');
}

// Run analysis in DSW inline
async function runInDSW(dswType) {
    const rc = window.currentSectionData;
    if (!rc || !rc.exercise) return;

    const resultDiv = document.getElementById('dsw-inline-result');
    if (!resultDiv) return;
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = '<p style="color:var(--text-secondary);">Running analysis...</p>';
    markInteracted();

    // Parse "type:analysis" format, default category to "stats"
    let analysisCategory = 'stats';
    let analysisId = dswType;
    if (dswType.includes(':')) {
        [analysisCategory, analysisId] = dswType.split(':');
    }

    // Data: section-specific sample_data or SHARED_DATASET (served as fallback)
    const sampleData = rc.sample_data || {};

    // Config from exercise.dsw_config
    const config = rc.exercise.dsw_config || {};

    const body = {
        type: analysisCategory,
        analysis: analysisId,
        config: config,
        data: sampleData,
    };

    try {
        const response = await fetch('/api/dsw/analysis/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify(body),
        });

        if (response.ok) {
            const result = await response.json();
            let html = `<div style="background:var(--bg-secondary); border:1px solid var(--border); border-radius:8px; padding:1.25rem;">`;
            html += `<h4 style="margin:0 0 0.75rem 0; color:var(--accent);">DSW Result: ${analysisId}</h4>`;

            // Formatted summary
            if (result.summary) {
                html += `<pre style="white-space:pre-wrap; font-size:0.85rem; color:var(--text-primary); max-height:300px; overflow:auto;">${formatDSWSummary(result.summary)}</pre>`;
            }

            // Guide observation
            if (result.guide_observation) {
                html += `<p style="color:var(--accent); font-style:italic; margin:0.75rem 0 0.5rem 0;">${result.guide_observation}</p>`;
            }

            // Plot containers
            if (result.plots && result.plots.length > 0) {
                result.plots.forEach((plot, i) => {
                    html += `<div id="learn-plot-${i}" style="margin:0.75rem 0; min-height:300px;"></div>`;
                });
            }

            html += `</div>`;
            resultDiv.innerHTML = html;

            // Render Plotly charts after DOM update
            if (result.plots && result.plots.length > 0) {
                setTimeout(() => {
                    result.plots.forEach((plot, i) => {
                        const layout = {
                            ...plot.layout,
                            template: 'plotly_dark',
                            paper_bgcolor: 'transparent',
                            plot_bgcolor: 'transparent',
                            margin: { t: 40, r: 20, b: 40, l: 60 },
                            title: { text: plot.title, font: { size: 14, color: '#b0b0b0' } }
                        };
                        Plotly.newPlot(`learn-plot-${i}`, plot.data, layout, { responsive: true, displayModeBar: false });
                    });
                }, 50);
            }
        } else {
            const err = await response.json().catch(() => ({}));
            resultDiv.innerHTML = `
                <div style="background:var(--bg-secondary); border:1px solid var(--border); border-radius:8px; padding:1.25rem;">
                    <p style="color:var(--text-secondary);">DSW returned an error.</p>
                    <p style="color:var(--text-secondary); font-size:0.85rem;">${err.error || 'Try running this in the Workbench with your own data.'}</p>
                    <a href="/app/workbench/" class="btn btn-secondary" style="text-decoration:none; margin-top:0.5rem; display:inline-block;">Open Workbench</a>
                </div>
            `;
        }
    } catch (e) {
        resultDiv.innerHTML = `
            <div style="background:var(--bg-secondary); border:1px solid var(--border); border-radius:8px; padding:1.25rem;">
                <p style="color:var(--text-secondary);">Could not reach DSW. <a href="/app/workbench/">Open Workbench</a> to try manually.</p>
            </div>
        `;
    }
}

// Render interactive widgets based on type
function renderInteractiveWidget(interactive) {
    switch (interactive.type) {
        case 'bayesian_calculator':
            return renderBayesianCalculator(interactive.config);
        case 'base_rate_calculator':
            return renderBaseRateCalculator(interactive.config);
        case 'sample_size_calculator':
            return renderSampleSizeCalculator(interactive.config);
        case 'power_calculator':
            return renderPowerCalculator(interactive.config);
        case 'hypothesis_tracker':
            return renderHypothesisTracker(interactive.config);
        case 'evidence_rater':
            return renderEvidenceRater(interactive.config);
        case 'test_selector':
            return renderTestSelector(interactive.config);
        case 'results_interpreter':
            return renderResultsInterpreter(interactive.config);
        case 'data_cleaner':
            return renderDataCleaner(interactive.config);
        case 'regression_simulator':
            return renderRegressionSimulator(interactive.config);
        case 'randomization_demo':
            return renderRandomizationDemo(interactive.config);
        case 'dag_builder':
            return renderDAGBuilder(interactive.config);
        case 'multiple_comparison_demo':
            return renderMultipleComparisonDemo(interactive.config);
        case 'trial_analyzer':
            return renderTrialAnalyzer(interactive.config);
        case 'ab_analyzer':
            return renderABAnalyzer(interactive.config);
        case 'dsw_demo':
            return renderDSWDemo(interactive.config);
        case 'spc_demo':
            return renderSPCDemo(interactive.config);
        case 'pvalue_simulator':
            return renderPValueSimulator(interactive.config);
        case 'ci_visualizer':
            return renderCIVisualizer(interactive.config);
        case 'effect_size_calculator':
            return renderEffectSizeCalculator(interactive.config);
        case 'blocking_demo':
            return renderBlockingDemo(interactive.config);
        case 'bias_detector':
            return renderBiasDetector(interactive.config);
        case 'distribution_explorer':
            return renderDistributionExplorer(interactive.config);
        case 'eda_explorer':
            return renderEDAExplorer(interactive.config);
        case 'natural_experiment_demo':
            return renderNaturalExperimentDemo(interactive.config);
        case 'paper_evaluator':
            return renderPaperEvaluator(interactive.config);
        case 'study_evaluator':
            return renderStudyEvaluator(interactive.config);
        case 'forest_plot_reader':
            return renderForestPlotReader(interactive.config);
        case 'decision_framework':
            return renderDecisionFramework(interactive.config);
        case 'project_planner':
            return renderProjectPlanner(interactive.config);
        case 'capstone_workspace':
            return renderCapstoneWorkspace(interactive.config);
        case 'nonparametric_demo':
            return renderNonparametricDemo(interactive.config);
        case 'timeseries_demo':
            return renderTimeseriesDemo(interactive.config);
        case 'survival_demo':
            return renderSurvivalDemo(interactive.config);
        case 'clustering_demo':
            return renderClusteringDemo(interactive.config);
        default:
            return '';
    }
}

// Bayesian Calculator Widget
function renderBayesianCalculator(config) {
    return `
        <div class="interactive-widget" id="bayesian-calculator">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                </svg>
                Interactive: Bayesian Calculator
            </h3>

            <div class="widget-row">
                <label>Prior Probability:</label>
                <input type="range" id="bayes-prior" min="1" max="99" value="30" oninput="updateBayesian()">
                <span class="widget-value" id="bayes-prior-val">30%</span>
            </div>

            <div class="widget-row">
                <label>Likelihood Ratio:</label>
                <input type="range" id="bayes-lr" min="1" max="20" step="0.5" value="3" oninput="updateBayesian()">
                <span class="widget-value" id="bayes-lr-val">3.0x</span>
            </div>

            <div class="widget-row">
                <label>Confidence:</label>
                <input type="range" id="bayes-conf" min="10" max="100" value="80" oninput="updateBayesian()">
                <span class="widget-value" id="bayes-conf-val">80%</span>
            </div>

            <div class="widget-result">
                <div class="result-label">Posterior Probability</div>
                <div class="result-value" id="bayes-posterior">56%</div>
                <div class="result-explanation" id="bayes-explanation">
                    Starting with 30% confidence, after seeing evidence with LR=3 (adjusted to 2.6 at 80% confidence),
                    your updated confidence is 56%.
                </div>
            </div>
        </div>
    `;
}

function updateBayesian() {
    const prior = parseFloat(document.getElementById('bayes-prior').value) / 100;
    const lr = parseFloat(document.getElementById('bayes-lr').value);
    const conf = parseFloat(document.getElementById('bayes-conf').value) / 100;

    // Update display values
    document.getElementById('bayes-prior-val').textContent = Math.round(prior * 100) + '%';
    document.getElementById('bayes-lr-val').textContent = lr.toFixed(1) + 'x';
    document.getElementById('bayes-conf-val').textContent = Math.round(conf * 100) + '%';

    // Calculate adjusted LR
    const adjustedLR = 1 + (lr - 1) * conf;

    // Calculate posterior using odds form
    const priorOdds = prior / (1 - prior);
    const posteriorOdds = priorOdds * adjustedLR;
    const posterior = posteriorOdds / (1 + posteriorOdds);

    document.getElementById('bayes-posterior').textContent = Math.round(posterior * 100) + '%';
    document.getElementById('bayes-explanation').textContent =
        `Starting with ${Math.round(prior * 100)}% confidence, after seeing evidence with LR=${lr.toFixed(1)} ` +
        `(adjusted to ${adjustedLR.toFixed(1)} at ${Math.round(conf * 100)}% confidence), ` +
        `your updated confidence is ${Math.round(posterior * 100)}%.`;
}

// Sample Size Calculator Widget
function renderSampleSizeCalculator(config) {
    return `
        <div class="interactive-widget" id="sample-size-calculator">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="8.5" cy="7" r="4"/>
                    <path d="M20 8v6M23 11h-6"/>
                </svg>
                Interactive: Sample Size Calculator
            </h3>

            <div class="widget-row">
                <label>Confidence Level:</label>
                <select id="sample-conf" onchange="updateSampleSize()">
                    <option value="1.645">90%</option>
                    <option value="1.96" selected>95%</option>
                    <option value="2.576">99%</option>
                </select>
            </div>

            <div class="widget-row">
                <label>Margin of Error:</label>
                <input type="range" id="sample-margin" min="1" max="10" value="3" oninput="updateSampleSize()">
                <span class="widget-value" id="sample-margin-val">±3%</span>
            </div>

            <div class="widget-row">
                <label>Expected Proportion:</label>
                <input type="range" id="sample-prop" min="5" max="95" value="50" oninput="updateSampleSize()">
                <span class="widget-value" id="sample-prop-val">50%</span>
            </div>

            <div class="widget-result">
                <div class="result-label">Required Sample Size</div>
                <div class="result-value" id="sample-n">1,068</div>
                <div class="result-explanation" id="sample-explanation">
                    To estimate a proportion with ±3% margin of error at 95% confidence, you need at least 1,068 samples.
                </div>
            </div>
        </div>
    `;
}

function updateSampleSize() {
    const z = parseFloat(document.getElementById('sample-conf').value);
    const margin = parseFloat(document.getElementById('sample-margin').value) / 100;
    const p = parseFloat(document.getElementById('sample-prop').value) / 100;

    document.getElementById('sample-margin-val').textContent = '±' + Math.round(margin * 100) + '%';
    document.getElementById('sample-prop-val').textContent = Math.round(p * 100) + '%';

    // Calculate n = z^2 * p(1-p) / e^2
    const n = Math.ceil((z * z * p * (1 - p)) / (margin * margin));

    document.getElementById('sample-n').textContent = n.toLocaleString();

    const confLevel = {1.645: '90%', 1.96: '95%', 2.576: '99%'}[z] || '95%';
    document.getElementById('sample-explanation').textContent =
        `To estimate a proportion with ±${Math.round(margin * 100)}% margin of error at ${confLevel} confidence, ` +
        `you need at least ${n.toLocaleString()} samples.`;
}

// Hypothesis Tracker Widget
function renderHypothesisTracker(config) {
    return `
        <div class="interactive-widget" id="hypothesis-tracker">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/>
                    <rect x="9" y="3" width="6" height="4" rx="2"/>
                    <path d="M9 14l2 2 4-4"/>
                </svg>
                Interactive: Hypothesis Tracker
            </h3>

            <div id="hypotheses-list">
                <div class="hypothesis-item" data-idx="0">
                    <input type="text" placeholder="Hypothesis A..." value="UI change caused drop" class="hyp-input">
                    <input type="range" min="0" max="100" value="25" class="hyp-prob" oninput="updateHypProbs()">
                    <span class="hyp-prob-val">25%</span>
                </div>
                <div class="hypothesis-item" data-idx="1">
                    <input type="text" placeholder="Hypothesis B..." value="Seasonality" class="hyp-input">
                    <input type="range" min="0" max="100" value="25" class="hyp-prob" oninput="updateHypProbs()">
                    <span class="hyp-prob-val">25%</span>
                </div>
                <div class="hypothesis-item" data-idx="2">
                    <input type="text" placeholder="Hypothesis C..." value="Competitor action" class="hyp-input">
                    <input type="range" min="0" max="100" value="25" class="hyp-prob" oninput="updateHypProbs()">
                    <span class="hyp-prob-val">25%</span>
                </div>
                <div class="hypothesis-item" data-idx="3">
                    <input type="text" placeholder="Hypothesis D..." value="Data bug" class="hyp-input">
                    <input type="range" min="0" max="100" value="25" class="hyp-prob" oninput="updateHypProbs()">
                    <span class="hyp-prob-val">25%</span>
                </div>
            </div>

            <div class="widget-result">
                <div class="result-label">Total Probability</div>
                <div class="result-value" id="hyp-total">100%</div>
                <div class="result-explanation">
                    Adjust probabilities as you gather evidence. Try to keep total at or near 100%.
                </div>
            </div>
        </div>
        <style>
            .hypothesis-item {
                display: flex;
                align-items: center;
                gap: 1rem;
                margin-bottom: 0.75rem;
            }
            .hypothesis-item .hyp-input {
                flex: 1;
            }
            .hypothesis-item .hyp-prob {
                width: 150px;
            }
            .hypothesis-item .hyp-prob-val {
                width: 50px;
                font-family: 'JetBrains Mono', monospace;
            }
        </style>
    `;
}

function updateHypProbs() {
    const items = document.querySelectorAll('.hypothesis-item');
    let total = 0;
    items.forEach(item => {
        const slider = item.querySelector('.hyp-prob');
        const valEl = item.querySelector('.hyp-prob-val');
        const val = parseInt(slider.value);
        valEl.textContent = val + '%';
        total += val;
    });
    const totalEl = document.getElementById('hyp-total');
    totalEl.textContent = total + '%';
    totalEl.style.color = total === 100 ? 'var(--accent-primary)' : 'var(--error)';
}

// Evidence Rater Widget
function renderEvidenceRater(config) {
    return `
        <div class="interactive-widget" id="evidence-rater">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                </svg>
                Interactive: Evidence Quality Rater
            </h3>

            <div class="widget-row">
                <label>Source Type:</label>
                <select id="ev-source" onchange="updateEvidenceRating()">
                    <option value="0.95">Controlled experiment</option>
                    <option value="0.7" selected>Observational study</option>
                    <option value="0.6">Expert opinion</option>
                    <option value="0.3">Anecdote</option>
                </select>
            </div>

            <div class="widget-row">
                <label>Sample Size:</label>
                <select id="ev-sample" onchange="updateEvidenceRating()">
                    <option value="0.5">Small (n < 30)</option>
                    <option value="0.7" selected>Moderate (30-100)</option>
                    <option value="0.85">Large (100-1000)</option>
                    <option value="0.95">Very Large (1000+)</option>
                </select>
            </div>

            <div class="widget-row">
                <label>Replication:</label>
                <select id="ev-rep" onchange="updateEvidenceRating()">
                    <option value="0.6" selected>Single study</option>
                    <option value="0.8">Replicated 2-3 times</option>
                    <option value="0.95">Meta-analysis</option>
                </select>
            </div>

            <div class="widget-row">
                <label>Bias Risk:</label>
                <select id="ev-bias" onchange="updateEvidenceRating()">
                    <option value="0.95">Low (independent, blinded)</option>
                    <option value="0.75" selected>Moderate</option>
                    <option value="0.5">High (conflicts of interest)</option>
                </select>
            </div>

            <div class="widget-result">
                <div class="result-label">Combined Confidence Score</div>
                <div class="result-value" id="ev-score">25%</div>
                <div class="result-explanation" id="ev-explanation">
                    Use this confidence score when applying this evidence to your analysis.
                </div>
            </div>
        </div>
    `;
}

function updateEvidenceRating() {
    const source = parseFloat(document.getElementById('ev-source').value);
    const sample = parseFloat(document.getElementById('ev-sample').value);
    const rep = parseFloat(document.getElementById('ev-rep').value);
    const bias = parseFloat(document.getElementById('ev-bias').value);

    const combined = source * sample * rep * bias;
    document.getElementById('ev-score').textContent = Math.round(combined * 100) + '%';

    let quality = 'low';
    if (combined > 0.6) quality = 'moderate';
    if (combined > 0.8) quality = 'high';

    document.getElementById('ev-explanation').textContent =
        `This evidence has ${quality} quality. Use ${Math.round(combined * 100)}% confidence when applying it.`;
}

// Test Selector Widget (simplified)
function renderTestSelector(config) {
    return `
        <div class="interactive-widget" id="test-selector">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                </svg>
                Interactive: Test Selector
            </h3>

            <div class="widget-row">
                <label>Outcome Variable:</label>
                <select id="test-outcome" onchange="updateTestRecommendation()">
                    <option value="continuous">Continuous (height, revenue)</option>
                    <option value="binary">Binary (yes/no)</option>
                    <option value="categorical">Categorical (A/B/C)</option>
                    <option value="count">Count (events/day)</option>
                </select>
            </div>

            <div class="widget-row">
                <label>Number of Groups:</label>
                <select id="test-groups" onchange="updateTestRecommendation()">
                    <option value="1">1 (single group)</option>
                    <option value="2" selected>2 groups</option>
                    <option value="3">3+ groups</option>
                </select>
            </div>

            <div class="widget-row">
                <label>Paired/Matched:</label>
                <select id="test-paired" onchange="updateTestRecommendation()">
                    <option value="no" selected>No (independent)</option>
                    <option value="yes">Yes (same subjects)</option>
                </select>
            </div>

            <div class="widget-result">
                <div class="result-label">Recommended Test</div>
                <div class="result-value" id="test-rec" style="font-size: 1.5rem;">Independent t-test</div>
                <div class="result-explanation" id="test-explanation">
                    For comparing means of 2 independent groups with continuous outcomes.
                </div>
            </div>
        </div>
    `;
}

function updateTestRecommendation() {
    const outcome = document.getElementById('test-outcome').value;
    const groups = document.getElementById('test-groups').value;
    const paired = document.getElementById('test-paired').value;

    let test = 'Unknown';
    let explanation = '';

    if (outcome === 'continuous') {
        if (groups === '1') {
            test = 'One-sample t-test';
            explanation = 'For testing if a single group mean differs from a known value.';
        } else if (groups === '2') {
            if (paired === 'yes') {
                test = 'Paired t-test';
                explanation = 'For comparing means of the same subjects before/after.';
            } else {
                test = 'Independent t-test';
                explanation = 'For comparing means of 2 independent groups.';
            }
        } else {
            if (paired === 'yes') {
                test = 'Repeated measures ANOVA';
                explanation = 'For comparing means of the same subjects across 3+ conditions.';
            } else {
                test = 'One-way ANOVA';
                explanation = 'For comparing means of 3+ independent groups.';
            }
        }
    } else if (outcome === 'binary' || outcome === 'categorical') {
        if (groups === '2') {
            test = 'Chi-square test';
            explanation = 'For comparing proportions between 2 groups.';
        } else {
            test = 'Chi-square test';
            explanation = 'For comparing proportions across multiple groups.';
        }
    } else if (outcome === 'count') {
        test = 'Poisson regression';
        explanation = 'For modeling count data with rate outcomes.';
    }

    document.getElementById('test-rec').textContent = test;
    document.getElementById('test-explanation').textContent = explanation;
}

// Results Interpreter Widget (simplified)
function renderResultsInterpreter(config) {
    return `
        <div class="interactive-widget" id="results-interpreter">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 20V10M12 20V4M6 20v-6"/>
                </svg>
                Interactive: Results Interpreter
            </h3>

            <div class="widget-row">
                <label>P-value:</label>
                <input type="number" id="ri-pvalue" min="0" max="1" step="0.001" value="0.03" oninput="updateResultsInterpretation()">
            </div>

            <div class="widget-row">
                <label>Effect Size (Cohen's d):</label>
                <input type="number" id="ri-effectsize" min="0" max="3" step="0.1" value="0.2" oninput="updateResultsInterpretation()">
            </div>

            <div class="widget-row">
                <label>Sample Size (n):</label>
                <input type="number" id="ri-samplesize" min="10" max="1000000" step="10" value="1000" oninput="updateResultsInterpretation()">
            </div>

            <div class="widget-result">
                <div class="result-label">Interpretation</div>
                <div class="result-value" id="ri-verdict" style="font-size: 1.25rem;">Statistically significant, small effect</div>
                <div class="result-explanation" id="ri-explanation">
                    The result is statistically significant (p < 0.05), but the effect size is small (d = 0.2).
                    Consider whether this effect is practically meaningful before making decisions.
                </div>
            </div>
        </div>
    `;
}

function updateResultsInterpretation() {
    const pvalue = parseFloat(document.getElementById('ri-pvalue').value);
    const effectSize = parseFloat(document.getElementById('ri-effectsize').value);
    const sampleSize = parseInt(document.getElementById('ri-samplesize').value);

    const significant = pvalue < 0.05;
    let effectLabel = 'negligible';
    if (effectSize >= 0.2) effectLabel = 'small';
    if (effectSize >= 0.5) effectLabel = 'medium';
    if (effectSize >= 0.8) effectLabel = 'large';

    let verdict = '';
    let explanation = '';

    if (significant && effectLabel !== 'negligible') {
        if (sampleSize > 10000 && effectLabel === 'small') {
            verdict = 'Statistically significant, likely overpowered';
            explanation = `With n=${sampleSize.toLocaleString()}, even tiny effects become significant. The effect size (d=${effectSize}) is small. This may not be practically meaningful.`;
        } else {
            verdict = `Statistically significant, ${effectLabel} effect`;
            explanation = `The result is statistically significant (p=${pvalue}) with a ${effectLabel} effect size (d=${effectSize}). This appears to be a meaningful finding.`;
        }
    } else if (significant && effectLabel === 'negligible') {
        verdict = 'Significant but negligible effect';
        explanation = `While p=${pvalue} is below 0.05, the effect size (d=${effectSize}) is too small to matter practically. Large sample sizes can make trivial differences "significant."`;
    } else {
        verdict = 'Not statistically significant';
        explanation = `The result is not statistically significant (p=${pvalue}). This could mean no real effect exists, or the sample size was too small to detect one.`;
    }

    document.getElementById('ri-verdict').textContent = verdict;
    document.getElementById('ri-explanation').textContent = explanation;
}

// Data Cleaner Widget (simplified)
function renderDataCleaner(config) {
    return `
        <div class="interactive-widget" id="data-cleaner">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
                Interactive: Missing Data Strategy Selector
            </h3>

            <div class="widget-row">
                <label>% Missing:</label>
                <input type="range" id="dc-pct" min="1" max="80" value="15" oninput="updateDataCleaningRec()">
                <span class="widget-value" id="dc-pct-val">15%</span>
            </div>

            <div class="widget-row">
                <label>Missingness Type:</label>
                <select id="dc-type" onchange="updateDataCleaningRec()">
                    <option value="mcar">MCAR (completely random)</option>
                    <option value="mar" selected>MAR (related to observed)</option>
                    <option value="mnar">MNAR (related to missing value)</option>
                </select>
            </div>

            <div class="widget-row">
                <label>Variable Importance:</label>
                <select id="dc-importance" onchange="updateDataCleaningRec()">
                    <option value="high">High (key outcome/predictor)</option>
                    <option value="medium" selected>Medium</option>
                    <option value="low">Low (auxiliary variable)</option>
                </select>
            </div>

            <div class="widget-result">
                <div class="result-label">Recommended Strategy</div>
                <div class="result-value" id="dc-rec" style="font-size: 1.25rem;">Multiple Imputation</div>
                <div class="result-explanation" id="dc-explanation">
                    With 15% missing data that is MAR, multiple imputation will preserve variance and provide unbiased estimates.
                </div>
            </div>
        </div>
    `;
}

function updateDataCleaningRec() {
    const pct = parseInt(document.getElementById('dc-pct').value);
    const type = document.getElementById('dc-type').value;
    const importance = document.getElementById('dc-importance').value;

    document.getElementById('dc-pct-val').textContent = pct + '%';

    let strategy = '';
    let explanation = '';

    if (type === 'mnar') {
        strategy = 'Caution Required';
        explanation = `With MNAR data (${pct}% missing), no imputation method can fully correct the bias. Consider sensitivity analyses or collecting additional data to understand the missingness mechanism.`;
    } else if (pct > 50) {
        if (importance === 'low') {
            strategy = 'Drop Variable';
            explanation = `With ${pct}% missing and low importance, consider dropping this variable entirely. Imputing more than half the values introduces too much uncertainty.`;
        } else {
            strategy = 'Multiple Imputation + Sensitivity';
            explanation = `With ${pct}% missing in an important variable, use multiple imputation but run sensitivity analyses to check if results are robust to imputation assumptions.`;
        }
    } else if (pct > 20) {
        strategy = 'Multiple Imputation';
        explanation = `With ${pct}% missing data that is ${type.toUpperCase()}, multiple imputation will preserve variance and reduce bias. Simple mean/mode imputation would distort the distribution.`;
    } else if (pct > 5) {
        if (type === 'mcar') {
            strategy = 'Mean/Mode or Regression Imputation';
            explanation = `With only ${pct}% missing data that is MCAR, simpler methods like mean imputation are acceptable, though regression imputation is better if practical.`;
        } else {
            strategy = 'Regression Imputation';
            explanation = `With ${pct}% missing data that is MAR, use regression imputation or multiple imputation to account for the relationship with observed variables.`;
        }
    } else {
        strategy = 'Listwise Deletion OK';
        explanation = `With only ${pct}% missing data that is ${type.toUpperCase()}, listwise deletion (dropping incomplete rows) is acceptable and loses little information.`;
    }

    document.getElementById('dc-rec').textContent = strategy;
    document.getElementById('dc-explanation').textContent = explanation;
}

// Base Rate Calculator Widget
function renderBaseRateCalculator(config) {
    return `
        <div class="interactive-widget" id="base-rate-calculator">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 6v6l4 2"/>
                </svg>
                Interactive: Base Rate Calculator
            </h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                See how base rates affect the probability you actually have a condition given a positive test.
            </p>

            <div class="widget-row">
                <label>Base Rate (prevalence):</label>
                <input type="range" id="br-prevalence" min="0.1" max="20" step="0.1" value="1" oninput="updateBaseRate()">
                <span class="widget-value" id="br-prevalence-val">1%</span>
            </div>

            <div class="widget-row">
                <label>Sensitivity (true positive):</label>
                <input type="range" id="br-sensitivity" min="50" max="99" value="95" oninput="updateBaseRate()">
                <span class="widget-value" id="br-sensitivity-val">95%</span>
            </div>

            <div class="widget-row">
                <label>Specificity (true negative):</label>
                <input type="range" id="br-specificity" min="50" max="99" value="95" oninput="updateBaseRate()">
                <span class="widget-value" id="br-specificity-val">95%</span>
            </div>

            <div class="widget-result">
                <div class="result-label">If You Test Positive, Probability You Have It</div>
                <div class="result-value" id="br-ppv">16%</div>
                <div class="result-explanation" id="br-explanation">
                    In 1,000 people: 10 have condition (9.5 test positive), 990 don't (49.5 test positive).
                    Of 59 positive tests, only 9.5 are true positives = 16%.
                </div>
            </div>

            <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 4px;">
                <div style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 0.5rem;">Natural Frequencies (per 1,000 people)</div>
                <div id="br-frequencies" style="font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: var(--text-secondary);">
                </div>
            </div>
        </div>
    `;
}

function updateBaseRate() {
    const prevalence = parseFloat(document.getElementById('br-prevalence').value) / 100;
    const sensitivity = parseFloat(document.getElementById('br-sensitivity').value) / 100;
    const specificity = parseFloat(document.getElementById('br-specificity').value) / 100;

    document.getElementById('br-prevalence-val').textContent = (prevalence * 100).toFixed(1) + '%';
    document.getElementById('br-sensitivity-val').textContent = Math.round(sensitivity * 100) + '%';
    document.getElementById('br-specificity-val').textContent = Math.round(specificity * 100) + '%';

    // Calculate using 1000 people
    const n = 1000;
    const haveCondition = n * prevalence;
    const dontHave = n - haveCondition;

    const truePositives = haveCondition * sensitivity;
    const falseNegatives = haveCondition * (1 - sensitivity);
    const falsePositives = dontHave * (1 - specificity);
    const trueNegatives = dontHave * specificity;

    const totalPositives = truePositives + falsePositives;
    const ppv = totalPositives > 0 ? truePositives / totalPositives : 0;

    document.getElementById('br-ppv').textContent = Math.round(ppv * 100) + '%';
    document.getElementById('br-ppv').style.color = ppv < 0.5 ? 'var(--warning)' : 'var(--accent-primary)';

    document.getElementById('br-explanation').textContent =
        `In ${n.toLocaleString()} people: ${haveCondition.toFixed(1)} have condition (${truePositives.toFixed(1)} test positive), ` +
        `${dontHave.toFixed(1)} don't (${falsePositives.toFixed(1)} test positive). ` +
        `Of ${totalPositives.toFixed(1)} positive tests, only ${truePositives.toFixed(1)} are true positives = ${Math.round(ppv * 100)}%.`;

    document.getElementById('br-frequencies').innerHTML = `
        Have condition: ${haveCondition.toFixed(1)} → Test +: ${truePositives.toFixed(1)}, Test -: ${falseNegatives.toFixed(1)}<br>
        Don't have: ${dontHave.toFixed(1)} → Test +: ${falsePositives.toFixed(1)}, Test -: ${trueNegatives.toFixed(1)}<br>
        <strong>Total positive tests: ${totalPositives.toFixed(1)} (${truePositives.toFixed(1)} true, ${falsePositives.toFixed(1)} false)</strong>
    `;
}

// Power Calculator Widget - Interactive visualization
function renderPowerCalculator(config) {
    return `
        <div class="interactive-widget" id="power-calculator">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                </svg>
                Interactive: Power Analysis Calculator
            </h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                See how sample size, effect size, and power are related. Fix any two to solve for the third.
            </p>

            <div class="widget-row">
                <label>Effect Size (Cohen's d):</label>
                <input type="range" id="pwr-effect" min="0.1" max="1.2" step="0.05" value="0.5" oninput="updatePower()">
                <span class="widget-value" id="pwr-effect-val">0.50 (medium)</span>
            </div>

            <div class="widget-row">
                <label>Sample Size (per group):</label>
                <input type="range" id="pwr-n" min="10" max="500" step="5" value="64" oninput="updatePower()">
                <span class="widget-value" id="pwr-n-val">64</span>
            </div>

            <div class="widget-row">
                <label>Alpha (significance level):</label>
                <select id="pwr-alpha" onchange="updatePower()">
                    <option value="0.10">0.10</option>
                    <option value="0.05" selected>0.05</option>
                    <option value="0.01">0.01</option>
                </select>
            </div>

            <div class="widget-result">
                <div class="result-label">Statistical Power</div>
                <div class="result-value" id="pwr-power">80%</div>
                <div class="result-explanation" id="pwr-explanation">
                    With n=64 per group and d=0.5, you have 80% power to detect the effect at α=0.05.
                </div>
            </div>

            <div style="margin-top: 1.5rem;">
                <div style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 0.5rem;">Power Curve (effect size vs power at current n)</div>
                <div id="power-curve" style="height: 120px; background: var(--bg-tertiary); border-radius: 4px; position: relative; overflow: hidden;">
                    <canvas id="power-curve-canvas" width="400" height="120"></canvas>
                </div>
            </div>

            <div style="margin-top: 1rem; display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; font-size: 0.85rem;">
                <div style="text-align: center; padding: 0.75rem; background: var(--bg-tertiary); border-radius: 4px;">
                    <div style="color: var(--text-dim);">For d=0.2 (small)</div>
                    <div style="color: var(--accent-primary); font-weight: 500;" id="pwr-n-small">n=394/group</div>
                </div>
                <div style="text-align: center; padding: 0.75rem; background: var(--bg-tertiary); border-radius: 4px;">
                    <div style="color: var(--text-dim);">For d=0.5 (medium)</div>
                    <div style="color: var(--accent-primary); font-weight: 500;" id="pwr-n-medium">n=64/group</div>
                </div>
                <div style="text-align: center; padding: 0.75rem; background: var(--bg-tertiary); border-radius: 4px;">
                    <div style="color: var(--text-dim);">For d=0.8 (large)</div>
                    <div style="color: var(--accent-primary); font-weight: 500;" id="pwr-n-large">n=26/group</div>
                </div>
            </div>
        </div>
    `;
}

function updatePower() {
    const d = parseFloat(document.getElementById('pwr-effect').value);
    const n = parseInt(document.getElementById('pwr-n').value);
    const alpha = parseFloat(document.getElementById('pwr-alpha').value);

    // Effect size label
    let effectLabel = 'small';
    if (d >= 0.5) effectLabel = 'medium';
    if (d >= 0.8) effectLabel = 'large';
    document.getElementById('pwr-effect-val').textContent = d.toFixed(2) + ` (${effectLabel})`;
    document.getElementById('pwr-n-val').textContent = n;

    // Calculate power using approximation
    // Power ≈ Φ(d√(n/2) - z_α/2)
    const z_alpha = alpha === 0.10 ? 1.645 : (alpha === 0.05 ? 1.96 : 2.576);
    const ncp = d * Math.sqrt(n / 2); // non-centrality parameter
    const power = normalCDF(ncp - z_alpha);

    document.getElementById('pwr-power').textContent = Math.round(power * 100) + '%';
    document.getElementById('pwr-power').style.color = power >= 0.8 ? 'var(--accent-primary)' : 'var(--warning)';

    document.getElementById('pwr-explanation').textContent =
        `With n=${n} per group and d=${d.toFixed(2)}, you have ${Math.round(power * 100)}% power to detect the effect at α=${alpha}. ` +
        (power < 0.8 ? 'Consider increasing sample size.' : 'Adequate power achieved.');

    // Calculate required n for standard effect sizes (at 80% power)
    const z_beta = 0.84; // for 80% power
    const calcN = (effect) => Math.ceil(2 * Math.pow((z_alpha + z_beta) / effect, 2));
    document.getElementById('pwr-n-small').textContent = `n=${calcN(0.2)}/group`;
    document.getElementById('pwr-n-medium').textContent = `n=${calcN(0.5)}/group`;
    document.getElementById('pwr-n-large').textContent = `n=${calcN(0.8)}/group`;

    // Draw power curve
    drawPowerCurve(n, alpha);
}

function normalCDF(x) {
    // Approximation of standard normal CDF
    const a1 =  0.254829592;
    const a2 = -0.284496736;
    const a3 =  1.421413741;
    const a4 = -1.453152027;
    const a5 =  1.061405429;
    const p  =  0.3275911;
    const sign = x < 0 ? -1 : 1;
    x = Math.abs(x) / Math.sqrt(2);
    const t = 1.0 / (1.0 + p * x);
    const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
    return 0.5 * (1.0 + sign * y);
}

function drawPowerCurve(n, alpha) {
    const canvas = document.getElementById('power-curve-canvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;

    ctx.clearRect(0, 0, width, height);

    // Draw axes
    ctx.strokeStyle = 'rgba(74, 159, 110, 0.3)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(40, 10);
    ctx.lineTo(40, height - 20);
    ctx.lineTo(width - 10, height - 20);
    ctx.stroke();

    // Labels
    ctx.fillStyle = 'rgba(154, 170, 154, 0.8)';
    ctx.font = '10px Inter';
    ctx.fillText('Power', 5, 15);
    ctx.fillText('100%', 10, 15);
    ctx.fillText('50%', 15, height/2);
    ctx.fillText('0%', 18, height - 22);
    ctx.fillText('Effect Size (d)', width/2 - 30, height - 5);
    ctx.fillText('0.2', 60, height - 8);
    ctx.fillText('0.5', 160, height - 8);
    ctx.fillText('0.8', 260, height - 8);
    ctx.fillText('1.0', 340, height - 8);

    // Draw 80% power line
    ctx.strokeStyle = 'rgba(232, 197, 71, 0.5)';
    ctx.setLineDash([5, 5]);
    ctx.beginPath();
    const y80 = 10 + (1 - 0.8) * (height - 30);
    ctx.moveTo(40, y80);
    ctx.lineTo(width - 10, y80);
    ctx.stroke();
    ctx.setLineDash([]);

    // Draw power curve
    const z_alpha = alpha === 0.10 ? 1.645 : (alpha === 0.05 ? 1.96 : 2.576);
    ctx.strokeStyle = 'var(--accent-primary)';
    ctx.lineWidth = 2;
    ctx.beginPath();

    for (let i = 0; i <= 100; i++) {
        const d = 0.1 + (i / 100) * 1.0; // d from 0.1 to 1.1
        const ncp = d * Math.sqrt(n / 2);
        const power = normalCDF(ncp - z_alpha);
        const x = 40 + (d - 0.1) / 1.0 * (width - 50);
        const y = 10 + (1 - power) * (height - 30);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    }
    ctx.stroke();

    // Mark current effect size
    const currentD = parseFloat(document.getElementById('pwr-effect').value);
    const currentNCP = currentD * Math.sqrt(n / 2);
    const currentPower = normalCDF(currentNCP - z_alpha);
    const cx = 40 + (currentD - 0.1) / 1.0 * (width - 50);
    const cy = 10 + (1 - currentPower) * (height - 30);

    ctx.fillStyle = 'var(--accent-primary)';
    ctx.beginPath();
    ctx.arc(cx, cy, 5, 0, Math.PI * 2);
    ctx.fill();
}

// Regression to Mean Simulator
function renderRegressionSimulator(config) {
    return `
        <div class="interactive-widget" id="regression-simulator">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 3v18h18"/>
                    <path d="M18 9l-5 5-4-4-3 3"/>
                </svg>
                Interactive: Regression to the Mean
            </h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                Select extreme performers at Time 1. See how they regress toward the mean at Time 2.
            </p>

            <div class="widget-row">
                <label>Correlation (r) between T1 and T2:</label>
                <input type="range" id="rtm-corr" min="0" max="100" value="50" oninput="updateRTM()">
                <span class="widget-value" id="rtm-corr-val">0.50</span>
            </div>

            <div class="widget-row">
                <label>Select top performers at T1:</label>
                <select id="rtm-selection" onchange="updateRTM()">
                    <option value="10">Top 10%</option>
                    <option value="20" selected>Top 20%</option>
                    <option value="50">Top 50%</option>
                </select>
            </div>

            <div class="widget-result">
                <div class="result-label">Expected T2 Performance (relative to mean)</div>
                <div class="result-value" id="rtm-result">+0.63 SD</div>
                <div class="result-explanation" id="rtm-explanation">
                    Top 20% at T1 (avg +1.28 SD above mean) will average only +0.64 SD at T2.
                    This looks like decline but it's just regression to the mean.
                </div>
            </div>

            <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 4px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="text-align: center;">
                        <div style="font-size: 0.75rem; color: var(--text-dim);">T1 Selection</div>
                        <div style="font-size: 1.5rem; color: var(--accent-primary);" id="rtm-t1">+1.28 SD</div>
                    </div>
                    <div style="font-size: 2rem; color: var(--text-dim);">→</div>
                    <div style="text-align: center;">
                        <div style="font-size: 0.75rem; color: var(--text-dim);">Expected T2</div>
                        <div style="font-size: 1.5rem; color: var(--warning);" id="rtm-t2">+0.64 SD</div>
                    </div>
                    <div style="font-size: 2rem; color: var(--text-dim);">→</div>
                    <div style="text-align: center;">
                        <div style="font-size: 0.75rem; color: var(--text-dim);">Apparent "Decline"</div>
                        <div style="font-size: 1.5rem; color: var(--error);" id="rtm-decline">-0.64 SD</div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function updateRTM() {
    const r = parseFloat(document.getElementById('rtm-corr').value) / 100;
    const pct = parseInt(document.getElementById('rtm-selection').value);

    document.getElementById('rtm-corr-val').textContent = r.toFixed(2);

    // Z-score for top X%
    const zScores = { 10: 1.28, 20: 0.84, 50: 0 };
    const avgT1 = zScores[pct] || 0.84;

    // Expected T2 = r * T1 (regression to mean formula)
    const expectedT2 = r * avgT1;
    const decline = avgT1 - expectedT2;

    document.getElementById('rtm-t1').textContent = '+' + avgT1.toFixed(2) + ' SD';
    document.getElementById('rtm-t2').textContent = '+' + expectedT2.toFixed(2) + ' SD';
    document.getElementById('rtm-decline').textContent = '-' + decline.toFixed(2) + ' SD';

    document.getElementById('rtm-result').textContent = '+' + expectedT2.toFixed(2) + ' SD';
    document.getElementById('rtm-explanation').textContent =
        `Top ${pct}% at T1 (avg +${avgT1.toFixed(2)} SD above mean) will average only +${expectedT2.toFixed(2)} SD at T2. ` +
        (r < 1 ? `This ${decline.toFixed(2)} SD "decline" is just regression to the mean, not real deterioration.` : '');
}

// Randomization Demo Widget
function renderRandomizationDemo(config) {
    return `
        <div class="interactive-widget" id="randomization-demo">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="2" width="20" height="8" rx="2"/>
                    <rect x="2" y="14" width="20" height="8" rx="2"/>
                    <path d="M6 6h.01M6 18h.01"/>
                </svg>
                Interactive: Randomization Demo
            </h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                See how randomization balances groups on both observed and unobserved variables.
            </p>

            <button class="btn btn-primary" onclick="runRandomization()" style="margin-bottom: 1rem;">
                Randomize 100 Participants
            </button>

            <div id="rand-results" style="display: none;">
                <table style="width: 100%; font-size: 0.85rem;">
                    <thead>
                        <tr>
                            <th style="text-align: left;">Variable</th>
                            <th style="text-align: center;">Treatment</th>
                            <th style="text-align: center;">Control</th>
                            <th style="text-align: center;">Difference</th>
                        </tr>
                    </thead>
                    <tbody id="rand-table-body">
                    </tbody>
                </table>

                <div class="widget-result" style="margin-top: 1rem;">
                    <div class="result-explanation" id="rand-explanation">
                        Even though we didn't try to balance anything, groups are similar on all variables!
                    </div>
                </div>
            </div>
        </div>
    `;
}

function runRandomization() {
    // Simulate 100 participants with various characteristics
    const participants = [];
    for (let i = 0; i < 100; i++) {
        participants.push({
            age: 30 + Math.random() * 40,
            female: Math.random() < 0.5,
            severity: Math.random() * 10,
            motivation: Math.random() * 10,  // "unobserved"
            genetics: Math.random() * 10      // "unobserved"
        });
    }

    // Randomly assign
    const shuffled = [...participants].sort(() => Math.random() - 0.5);
    const treatment = shuffled.slice(0, 50);
    const control = shuffled.slice(50);

    // Calculate means
    const mean = (arr, key) => arr.reduce((s, p) => s + p[key], 0) / arr.length;
    const pct = (arr, key) => arr.filter(p => p[key]).length / arr.length * 100;

    const vars = [
        { name: 'Age (years)', t: mean(treatment, 'age').toFixed(1), c: mean(control, 'age').toFixed(1), type: 'cont' },
        { name: 'Female (%)', t: pct(treatment, 'female').toFixed(0) + '%', c: pct(control, 'female').toFixed(0) + '%', type: 'pct' },
        { name: 'Severity (0-10)', t: mean(treatment, 'severity').toFixed(1), c: mean(control, 'severity').toFixed(1), type: 'cont' },
        { name: 'Motivation* (0-10)', t: mean(treatment, 'motivation').toFixed(1), c: mean(control, 'motivation').toFixed(1), type: 'cont' },
        { name: 'Genetic risk* (0-10)', t: mean(treatment, 'genetics').toFixed(1), c: mean(control, 'genetics').toFixed(1), type: 'cont' }
    ];

    let html = '';
    vars.forEach(v => {
        const tVal = parseFloat(v.t);
        const cVal = parseFloat(v.c);
        const diff = v.type === 'pct' ?
            (parseFloat(v.t) - parseFloat(v.c)).toFixed(0) + ' pp' :
            (tVal - cVal).toFixed(1);
        const isSmall = Math.abs(tVal - cVal) < (v.type === 'pct' ? 10 : 1);

        html += `<tr>
            <td>${v.name}</td>
            <td style="text-align: center;">${v.t}</td>
            <td style="text-align: center;">${v.c}</td>
            <td style="text-align: center; color: ${isSmall ? 'var(--accent-primary)' : 'var(--warning)'};">${diff}</td>
        </tr>`;
    });

    document.getElementById('rand-table-body').innerHTML = html;
    document.getElementById('rand-results').style.display = 'block';
    document.getElementById('rand-explanation').innerHTML =
        '<strong>*Unobserved variables</strong> (motivation, genetics) are also balanced! ' +
        'This is why randomization is so powerful - it balances everything, including things we can\'t measure.';
}

// Multiple Comparison Demo
function renderMultipleComparisonDemo(config) {
    return `
        <div class="interactive-widget" id="multiple-comparison-demo">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 20V10M18 20V4M6 20v-4"/>
                </svg>
                Interactive: Multiple Comparisons
            </h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                Run many tests on random data and see how false positives accumulate.
            </p>

            <div class="widget-row">
                <label>Number of tests:</label>
                <input type="range" id="mc-tests" min="1" max="50" value="20" oninput="document.getElementById('mc-tests-val').textContent = this.value">
                <span class="widget-value" id="mc-tests-val">20</span>
            </div>

            <button class="btn btn-primary" onclick="runMultipleTests()" style="margin-bottom: 1rem;">
                Run Tests (all nulls are true)
            </button>

            <div class="widget-result">
                <div class="result-label">Results</div>
                <div id="mc-results" style="font-family: 'JetBrains Mono', monospace; font-size: 0.85rem;">
                    Click "Run Tests" to simulate testing 20 hypotheses where no real effects exist.
                </div>
            </div>

            <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 4px;">
                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                    <strong>Expected false positives</strong> at α=0.05:<br>
                    <span id="mc-expected">20 tests × 5% = 1 expected false positive</span>
                </div>
            </div>
        </div>
    `;
}

function runMultipleTests() {
    const nTests = parseInt(document.getElementById('mc-tests').value);
    const alpha = 0.05;

    // Generate p-values under null (uniform distribution)
    const pValues = [];
    for (let i = 0; i < nTests; i++) {
        pValues.push(Math.random());
    }

    // Count significant results
    const significant = pValues.filter(p => p < alpha);
    const bonferroniSig = pValues.filter(p => p < alpha / nTests);

    // Display results
    let html = `<strong>${significant.length} of ${nTests} tests significant (p < 0.05)</strong><br><br>`;

    html += '<div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">';
    pValues.forEach((p, i) => {
        const isSig = p < alpha;
        const color = isSig ? 'var(--error)' : 'var(--text-dim)';
        html += `<span style="padding: 0.25rem 0.5rem; background: ${isSig ? 'rgba(208, 96, 96, 0.2)' : 'var(--bg-secondary)'}; border-radius: 2px; color: ${color}; font-size: 0.75rem;">
            ${p.toFixed(3)}${isSig ? '*' : ''}
        </span>`;
    });
    html += '</div>';

    html += `<br><strong>After Bonferroni correction (α = ${(alpha/nTests).toFixed(4)}):</strong> ${bonferroniSig.length} significant`;

    document.getElementById('mc-results').innerHTML = html;
    document.getElementById('mc-expected').textContent =
        `${nTests} tests × 5% = ${(nTests * 0.05).toFixed(1)} expected false positives. ` +
        `P(at least one) = ${(100 * (1 - Math.pow(0.95, nTests))).toFixed(0)}%`;
}

// DAG Builder (simplified)
function renderDAGBuilder(config) {
    return `
        <div class="interactive-widget" id="dag-builder">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="5" cy="12" r="3"/>
                    <circle cx="19" cy="12" r="3"/>
                    <circle cx="12" cy="5" r="3"/>
                    <path d="M8 12h8M7 10l3-3M17 10l-3-3"/>
                </svg>
                Interactive: Confounding vs Collider
            </h3>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1rem;">
                <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 4px; text-align: center;">
                    <div style="font-weight: 500; color: var(--accent-primary); margin-bottom: 0.5rem;">Confounder</div>
                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; color: var(--text-secondary);">
                        &nbsp;&nbsp;&nbsp;C<br>
                        &nbsp;&nbsp;↙ ↘<br>
                        X → Y
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-dim); margin-top: 0.5rem;">
                        C causes both X and Y<br>
                        <strong style="color: var(--accent-primary);">Adjust for C</strong>
                    </div>
                </div>

                <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 4px; text-align: center;">
                    <div style="font-weight: 500; color: var(--error); margin-bottom: 0.5rem;">Collider</div>
                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; color: var(--text-secondary);">
                        &nbsp;&nbsp;&nbsp;C<br>
                        &nbsp;&nbsp;↖ ↗<br>
                        X → Y
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-dim); margin-top: 0.5rem;">
                        X and Y both cause C<br>
                        <strong style="color: var(--error);">Do NOT adjust for C</strong>
                    </div>
                </div>
            </div>

            <div style="margin-top: 1.5rem; padding: 1rem; background: var(--accent-primary-dim); border-radius: 4px;">
                <div style="font-size: 0.9rem; color: var(--text-primary);">
                    <strong>Example:</strong> Talent and attractiveness both cause Hollywood success (collider).
                    Among Hollywood stars, talent appears negatively correlated with attractiveness.
                    This is <em>collider bias</em> - the correlation doesn't exist in the general population.
                </div>
            </div>
        </div>
    `;
}

// Trial Analyzer Widget
function renderTrialAnalyzer(config) {
    return `
        <div class="interactive-widget" id="trial-analyzer">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                </svg>
                Interactive: ITT vs Per-Protocol Analysis
            </h3>

            <div class="widget-row">
                <label>Treatment responders:</label>
                <input type="range" id="trial-resp-t" min="20" max="80" value="60" oninput="updateTrialAnalysis()">
                <span class="widget-value" id="trial-resp-t-val">60%</span>
            </div>

            <div class="widget-row">
                <label>Control responders:</label>
                <input type="range" id="trial-resp-c" min="20" max="80" value="40" oninput="updateTrialAnalysis()">
                <span class="widget-value" id="trial-resp-c-val">40%</span>
            </div>

            <div class="widget-row">
                <label>Treatment dropout rate:</label>
                <input type="range" id="trial-drop-t" min="0" max="50" value="25" oninput="updateTrialAnalysis()">
                <span class="widget-value" id="trial-drop-t-val">25%</span>
            </div>

            <div class="widget-row">
                <label>Control dropout rate:</label>
                <input type="range" id="trial-drop-c" min="0" max="50" value="10" oninput="updateTrialAnalysis()">
                <span class="widget-value" id="trial-drop-c-val">10%</span>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1.5rem;">
                <div class="widget-result">
                    <div class="result-label">ITT Analysis</div>
                    <div class="result-value" id="trial-itt" style="font-size: 1.25rem;">48% vs 36%</div>
                    <div class="result-explanation">Dropouts counted as non-responders (conservative)</div>
                </div>
                <div class="widget-result">
                    <div class="result-label">Per-Protocol Analysis</div>
                    <div class="result-value" id="trial-pp" style="font-size: 1.25rem;">64% vs 40%</div>
                    <div class="result-explanation">Only completers analyzed (may be biased)</div>
                </div>
            </div>
        </div>
    `;
}

function updateTrialAnalysis() {
    const respT = parseInt(document.getElementById('trial-resp-t').value);
    const respC = parseInt(document.getElementById('trial-resp-c').value);
    const dropT = parseInt(document.getElementById('trial-drop-t').value);
    const dropC = parseInt(document.getElementById('trial-drop-c').value);

    document.getElementById('trial-resp-t-val').textContent = respT + '%';
    document.getElementById('trial-resp-c-val').textContent = respC + '%';
    document.getElementById('trial-drop-t-val').textContent = dropT + '%';
    document.getElementById('trial-drop-c-val').textContent = dropC + '%';

    // Per-protocol: only completers
    const ppT = respT;
    const ppC = respC;

    // ITT: dropouts are non-responders
    // Response among completers * completion rate
    const ittT = Math.round(respT * (100 - dropT) / 100);
    const ittC = Math.round(respC * (100 - dropC) / 100);

    document.getElementById('trial-itt').textContent = `${ittT}% vs ${ittC}%`;
    document.getElementById('trial-pp').textContent = `${ppT}% vs ${ppC}%`;
}

// A/B Analyzer Widget
function renderABAnalyzer(config) {
    return `
        <div class="interactive-widget" id="ab-analyzer">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"/>
                    <rect x="14" y="3" width="7" height="7"/>
                    <rect x="14" y="14" width="7" height="7"/>
                    <rect x="3" y="14" width="7" height="7"/>
                </svg>
                Interactive: A/B Test Metrics
            </h3>

            <div class="widget-row">
                <label>Control conversion:</label>
                <input type="range" id="ab-conv-c" min="1" max="20" step="0.5" value="5" oninput="updateABAnalysis()">
                <span class="widget-value" id="ab-conv-c-val">5.0%</span>
            </div>

            <div class="widget-row">
                <label>Treatment conversion:</label>
                <input type="range" id="ab-conv-t" min="1" max="20" step="0.5" value="6" oninput="updateABAnalysis()">
                <span class="widget-value" id="ab-conv-t-val">6.0%</span>
            </div>

            <div class="widget-row">
                <label>Control AOV:</label>
                <input type="range" id="ab-aov-c" min="20" max="200" step="5" value="100" oninput="updateABAnalysis()">
                <span class="widget-value" id="ab-aov-c-val">$100</span>
            </div>

            <div class="widget-row">
                <label>Treatment AOV:</label>
                <input type="range" id="ab-aov-t" min="20" max="200" step="5" value="95" oninput="updateABAnalysis()">
                <span class="widget-value" id="ab-aov-t-val">$95</span>
            </div>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1.5rem;">
                <div class="widget-result">
                    <div class="result-label">Conversion Lift</div>
                    <div class="result-value" id="ab-conv-lift" style="font-size: 1.25rem;">+20%</div>
                </div>
                <div class="widget-result">
                    <div class="result-label">AOV Change</div>
                    <div class="result-value" id="ab-aov-lift" style="font-size: 1.25rem;">-5%</div>
                </div>
                <div class="widget-result">
                    <div class="result-label">Revenue/User</div>
                    <div class="result-value" id="ab-rev-lift" style="font-size: 1.25rem;">+14%</div>
                </div>
            </div>

            <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 4px; font-size: 0.9rem; color: var(--text-secondary);" id="ab-recommendation">
            </div>
        </div>
    `;
}

function updateABAnalysis() {
    const convC = parseFloat(document.getElementById('ab-conv-c').value);
    const convT = parseFloat(document.getElementById('ab-conv-t').value);
    const aovC = parseFloat(document.getElementById('ab-aov-c').value);
    const aovT = parseFloat(document.getElementById('ab-aov-t').value);

    document.getElementById('ab-conv-c-val').textContent = convC.toFixed(1) + '%';
    document.getElementById('ab-conv-t-val').textContent = convT.toFixed(1) + '%';
    document.getElementById('ab-aov-c-val').textContent = '$' + aovC;
    document.getElementById('ab-aov-t-val').textContent = '$' + aovT;

    const convLift = ((convT - convC) / convC * 100);
    const aovLift = ((aovT - aovC) / aovC * 100);
    const revC = convC * aovC / 100;
    const revT = convT * aovT / 100;
    const revLift = ((revT - revC) / revC * 100);

    document.getElementById('ab-conv-lift').textContent = (convLift >= 0 ? '+' : '') + convLift.toFixed(0) + '%';
    document.getElementById('ab-conv-lift').style.color = convLift >= 0 ? 'var(--accent-primary)' : 'var(--error)';

    document.getElementById('ab-aov-lift').textContent = (aovLift >= 0 ? '+' : '') + aovLift.toFixed(0) + '%';
    document.getElementById('ab-aov-lift').style.color = aovLift >= 0 ? 'var(--accent-primary)' : 'var(--error)';

    document.getElementById('ab-rev-lift').textContent = (revLift >= 0 ? '+' : '') + revLift.toFixed(0) + '%';
    document.getElementById('ab-rev-lift').style.color = revLift >= 0 ? 'var(--accent-primary)' : 'var(--error)';

    let rec = `<strong>Revenue per user:</strong> Control $${revC.toFixed(2)} → Treatment $${revT.toFixed(2)}<br>`;
    if (revLift > 0) {
        rec += `<span style="color: var(--accent-primary);">✓ Ship the treatment</span> - net positive revenue impact despite `;
        if (aovLift < 0) rec += 'lower AOV';
        else rec += 'the changes';
    } else {
        rec += `<span style="color: var(--error);">✗ Don't ship</span> - overall revenue impact is negative`;
    }
    document.getElementById('ab-recommendation').innerHTML = rec;
}

// =============================================================================
// DSW Demo — wired to /api/dsw/analysis/ for live analysis
// =============================================================================
function renderDSWDemo(config) {
    return `
        <div class="interactive-widget" id="dsw-demo">
            <h3>Try It: Run a DSW Analysis</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">Enter comma-separated numbers to run a live descriptive analysis.</p>
            <div class="widget-row">
                <label>Sample Data:</label>
                <input type="text" id="dsw-data" value="12, 15, 14, 10, 13, 16, 11, 14, 13, 15" style="flex:1;">
            </div>
            <div class="widget-row">
                <label>Analysis Type:</label>
                <select id="dsw-type">
                    <option value="descriptive">Descriptive Statistics</option>
                    <option value="normality">Normality Test</option>
                    <option value="distribution">Distribution Analysis</option>
                </select>
            </div>
            <button class="btn btn-primary btn-sm" onclick="runDSWDemo()" id="dsw-run-btn">Run Analysis</button>
            <div class="widget-result" id="dsw-result" style="display:none; margin-top:1rem;">
                <div class="result-label">Analysis Output</div>
                <pre id="dsw-output" style="white-space:pre-wrap; font-size:0.85rem; max-height:300px; overflow-y:auto;"></pre>
            </div>
        </div>
    `;
}

async function runDSWDemo() {
    const btn = document.getElementById('dsw-run-btn');
    btn.disabled = true; btn.textContent = 'Running...';
    const raw = document.getElementById('dsw-data').value;
    const values = raw.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v));
    const analysisType = document.getElementById('dsw-type').value;
    try {
        const resp = await fetch('/api/dsw/analysis/', {
            method: 'POST', credentials: 'include',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ analysis_type: analysisType, data: {values}, column: 'values' })
        });
        const data = await resp.json();
        document.getElementById('dsw-result').style.display = 'block';
        if (data.results) {
            document.getElementById('dsw-output').textContent = JSON.stringify(data.results, null, 2);
        } else if (data.interpretation) {
            document.getElementById('dsw-output').textContent = data.interpretation;
        } else {
            document.getElementById('dsw-output').textContent = JSON.stringify(data, null, 2);
        }
    } catch(e) {
        document.getElementById('dsw-result').style.display = 'block';
        // Fallback: client-side descriptive stats
        const n = values.length;
        const mean = values.reduce((a,b) => a+b, 0) / n;
        const sorted = [...values].sort((a,b) => a-b);
        const median = n % 2 ? sorted[Math.floor(n/2)] : (sorted[n/2-1]+sorted[n/2])/2;
        const variance = values.reduce((s,v) => s + (v-mean)**2, 0) / (n-1);
        const sd = Math.sqrt(variance);
        document.getElementById('dsw-output').textContent =
            `n: ${n}\nMean: ${mean.toFixed(2)}\nMedian: ${median.toFixed(2)}\nSD: ${sd.toFixed(2)}\nMin: ${sorted[0]}\nMax: ${sorted[n-1]}\nRange: ${(sorted[n-1]-sorted[0]).toFixed(2)}`;
    }
    btn.disabled = false; btn.textContent = 'Run Analysis';
}

// =============================================================================
// SPC Demo — wired to /api/spc/chart/ for live control charts
// =============================================================================
function renderSPCDemo(config) {
    return `
        <div class="interactive-widget" id="spc-demo">
            <h3>Try It: Control Chart Analysis</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">Enter measurements to generate a control chart. Try adding an out-of-control point!</p>
            <div class="widget-row">
                <label>Measurements:</label>
                <input type="text" id="spc-data" value="10.02, 10.01, 9.98, 10.03, 10.00, 9.99, 10.01, 10.02, 9.97, 10.00, 10.01, 9.99, 10.03, 10.00, 9.98" style="flex:1;">
            </div>
            <div class="widget-row">
                <label>Spec Target:</label>
                <input type="number" id="spc-target" value="10.00" step="0.01" style="width:100px;">
                <label style="min-width:auto;">Spec Tolerance (±):</label>
                <input type="number" id="spc-tol" value="0.05" step="0.01" style="width:100px;">
            </div>
            <button class="btn btn-primary btn-sm" onclick="runSPCDemo()" id="spc-run-btn">Generate Chart</button>
            <div class="widget-result" id="spc-result" style="display:none; margin-top:1rem;">
                <pre id="spc-output" style="white-space:pre-wrap; font-size:0.85rem;"></pre>
            </div>
        </div>
    `;
}

function runSPCDemo() {
    const raw = document.getElementById('spc-data').value;
    const values = raw.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v));
    const target = parseFloat(document.getElementById('spc-target').value);
    const tol = parseFloat(document.getElementById('spc-tol').value);
    const n = values.length;
    const mean = values.reduce((a,b)=>a+b,0)/n;
    const sd = Math.sqrt(values.reduce((s,v)=>s+(v-mean)**2,0)/(n-1));
    const ucl = mean + 3*sd;
    const lcl = mean - 3*sd;
    const usl = target + tol;
    const lsl = target - tol;
    const ooc = values.filter(v => v > ucl || v < lcl);
    const cp = (usl - lsl) / (6 * sd);
    const cpk = Math.min((usl - mean) / (3*sd), (mean - lsl) / (3*sd));
    let chart = 'Point | Value    | Status\n------+----------+--------\n';
    values.forEach((v, i) => {
        const status = v > ucl ? '*** ABOVE UCL' : v < lcl ? '*** BELOW LCL' : 'OK';
        chart += `  ${String(i+1).padStart(2)}  | ${v.toFixed(3).padStart(8)} | ${status}\n`;
    });
    chart += `\n--- Control Limits ---\nUCL:  ${ucl.toFixed(4)}\nMean: ${mean.toFixed(4)}\nLCL:  ${lcl.toFixed(4)}\n`;
    chart += `\n--- Capability ---\nCp:  ${cp.toFixed(2)} ${cp >= 1.33 ? '(Capable)' : '(Not capable)'}\nCpk: ${cpk.toFixed(2)} ${cpk >= 1.33 ? '(Centered)' : '(Off-center)'}`;
    chart += `\n\nOut of control points: ${ooc.length}`;
    document.getElementById('spc-result').style.display = 'block';
    document.getElementById('spc-output').textContent = chart;
}

// =============================================================================
// P-Value Simulator
// =============================================================================
function renderPValueSimulator(config) {
    return `
        <div class="interactive-widget" id="pvalue-sim">
            <h3>Interactive: P-Value Simulator</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">Simulate repeated experiments to see how p-values vary even when the true effect is the same.</p>
            <div class="widget-row">
                <label>True effect (d):</label>
                <input type="range" id="pval-effect" min="0" max="10" step="1" value="5" oninput="updatePValueSim()">
                <span class="widget-value" id="pval-effect-val">0.5</span>
            </div>
            <div class="widget-row">
                <label>Sample size per group:</label>
                <input type="range" id="pval-n" min="10" max="200" step="10" value="30" oninput="updatePValueSim()">
                <span class="widget-value" id="pval-n-val">30</span>
            </div>
            <button class="btn btn-primary btn-sm" onclick="runPValueSim()">Run 20 Experiments</button>
            <div class="widget-result" id="pval-result" style="display:none; margin-top:1rem;">
                <pre id="pval-output" style="white-space:pre-wrap; font-size:0.85rem;"></pre>
            </div>
        </div>
    `;
}

function updatePValueSim() {
    const d = parseFloat(document.getElementById('pval-effect').value) / 10;
    document.getElementById('pval-effect-val').textContent = d.toFixed(1);
    document.getElementById('pval-n-val').textContent = document.getElementById('pval-n').value;
}

function runPValueSim() {
    const d = parseFloat(document.getElementById('pval-effect').value) / 10;
    const n = parseInt(document.getElementById('pval-n').value);
    // Simulate using approximate z-test
    let results = [];
    let sigCount = 0;
    for (let i = 0; i < 20; i++) {
        // Simulate z-stat: d * sqrt(n/2) + random noise
        const se = Math.sqrt(2/n);
        const observed_d = d + randNormal() * se;
        const z = observed_d / se;
        const p = 2 * (1 - normalCDF(Math.abs(z)));
        const sig = p < 0.05;
        if (sig) sigCount++;
        results.push({ trial: i+1, d: observed_d, p, sig });
    }
    let output = 'Trial | Observed d | p-value  | Significant?\n------+------------+----------+-------------\n';
    results.forEach(r => {
        output += `  ${String(r.trial).padStart(2)}  | ${r.d.toFixed(3).padStart(10)} | ${r.p.toFixed(4).padStart(8)} | ${r.sig ? 'YES *' : 'no'}\n`;
    });
    output += `\n${sigCount}/20 reached p<0.05 (${Math.round(sigCount/20*100)}%)`;
    output += `\nTrue effect: d=${d.toFixed(1)}`;
    if (d === 0) output += '\n\nThe null is TRUE here — any "significant" results are false positives!';
    else output += `\n\nNotice how p-values dance around, even though the truth never changed.`;
    document.getElementById('pval-result').style.display = 'block';
    document.getElementById('pval-output').textContent = output;
}

function randNormal() {
    let u = 0, v = 0;
    while (u === 0) u = Math.random();
    while (v === 0) v = Math.random();
    return Math.sqrt(-2 * Math.log(u)) * Math.cos(2 * Math.PI * v);
}

function normalCDF(x) {
    const a1=0.254829592, a2=-0.284496736, a3=1.421413741, a4=-1.453152027, a5=1.061405429;
    const p=0.3275911;
    const sign = x < 0 ? -1 : 1;
    x = Math.abs(x) / Math.sqrt(2);
    const t = 1 / (1 + p*x);
    const y = 1 - (((((a5*t+a4)*t)+a3)*t+a2)*t+a1)*t*Math.exp(-x*x);
    return 0.5 * (1 + sign * y);
}

// =============================================================================
// CI Visualizer
// =============================================================================
function renderCIVisualizer(config) {
    return `
        <div class="interactive-widget" id="ci-viz">
            <h3>Interactive: Confidence Interval Visualizer</h3>
            <div class="widget-row">
                <label>Sample mean:</label>
                <input type="number" id="ci-mean" value="5.2" step="0.1" style="width:100px;" oninput="updateCI()">
            </div>
            <div class="widget-row">
                <label>Standard error:</label>
                <input type="range" id="ci-se" min="5" max="30" value="15" oninput="updateCI()">
                <span class="widget-value" id="ci-se-val">1.5</span>
            </div>
            <div class="widget-row">
                <label>Confidence level:</label>
                <select id="ci-level" onchange="updateCI()">
                    <option value="1.645">90%</option>
                    <option value="1.96" selected>95%</option>
                    <option value="2.576">99%</option>
                </select>
            </div>
            <div class="widget-result" id="ci-result">
                <div class="result-label">Confidence Interval</div>
                <div class="result-value" id="ci-value" style="font-size:1.5rem;"></div>
                <div class="result-explanation" id="ci-explain"></div>
            </div>
        </div>
    `;
}

function updateCI() {
    const mean = parseFloat(document.getElementById('ci-mean').value);
    const se = parseFloat(document.getElementById('ci-se').value) / 10;
    const z = parseFloat(document.getElementById('ci-level').value);
    document.getElementById('ci-se-val').textContent = se.toFixed(1);
    const lo = mean - z * se;
    const hi = mean + z * se;
    document.getElementById('ci-value').textContent = `[${lo.toFixed(2)}, ${hi.toFixed(2)}]`;
    const width = (hi - lo).toFixed(2);
    const includesZero = lo <= 0 && hi >= 0;
    document.getElementById('ci-explain').innerHTML =
        `Point estimate: ${mean.toFixed(1)} | Width: ${width}<br>` +
        (includesZero
            ? '<span style="color:var(--text-dim);">CI includes zero — effect not statistically significant at this level</span>'
            : '<span style="color:var(--accent-primary);">CI excludes zero — effect is statistically significant</span>');
}

// =============================================================================
// Effect Size Calculator
// =============================================================================
function renderEffectSizeCalculator(config) {
    return `
        <div class="interactive-widget" id="effect-calc">
            <h3>Interactive: Effect Size Calculator</h3>
            <div class="widget-row">
                <label>Group 1 mean:</label>
                <input type="number" id="es-m1" value="50" step="1" style="width:100px;" oninput="updateEffectSize()">
            </div>
            <div class="widget-row">
                <label>Group 2 mean:</label>
                <input type="number" id="es-m2" value="55" step="1" style="width:100px;" oninput="updateEffectSize()">
            </div>
            <div class="widget-row">
                <label>Pooled SD:</label>
                <input type="number" id="es-sd" value="10" step="1" style="width:100px;" oninput="updateEffectSize()">
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1.5rem;">
                <div class="widget-result">
                    <div class="result-label">Cohen's d</div>
                    <div class="result-value" id="es-d" style="font-size:1.5rem;"></div>
                    <div class="result-explanation" id="es-d-interp"></div>
                </div>
                <div class="widget-result">
                    <div class="result-label">Overlap</div>
                    <div class="result-value" id="es-overlap" style="font-size:1.5rem;"></div>
                    <div class="result-explanation">% of distributions overlapping</div>
                </div>
            </div>
        </div>
    `;
}

function updateEffectSize() {
    const m1 = parseFloat(document.getElementById('es-m1').value);
    const m2 = parseFloat(document.getElementById('es-m2').value);
    const sd = parseFloat(document.getElementById('es-sd').value);
    if (!sd) return;
    const d = Math.abs(m2 - m1) / sd;
    document.getElementById('es-d').textContent = d.toFixed(2);
    const interp = d < 0.2 ? 'Negligible' : d < 0.5 ? 'Small' : d < 0.8 ? 'Medium' : 'Large';
    document.getElementById('es-d-interp').textContent = interp;
    // Cohen's U3 overlap approximation
    const overlap = Math.round((2 * normalCDF(-d/2)) * 100);
    document.getElementById('es-overlap').textContent = (100 - overlap) + '%';
}

// =============================================================================
// Blocking Demo
// =============================================================================
function renderBlockingDemo(config) {
    return `
        <div class="interactive-widget" id="blocking-demo">
            <h3>Interactive: Blocking Demonstration</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">See how blocking reduces noise and increases power to detect treatment effects.</p>
            <div class="widget-row">
                <label>True treatment effect:</label>
                <input type="range" id="block-effect" min="0" max="20" value="5" oninput="updateBlockingDemo()">
                <span class="widget-value" id="block-effect-val">5</span>
            </div>
            <div class="widget-row">
                <label>Block variation:</label>
                <input type="range" id="block-noise" min="0" max="30" value="15" oninput="updateBlockingDemo()">
                <span class="widget-value" id="block-noise-val">15</span>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1.5rem;">
                <div class="widget-result">
                    <div class="result-label">Without Blocking</div>
                    <div class="result-explanation" id="block-without"></div>
                </div>
                <div class="widget-result">
                    <div class="result-label">With Blocking</div>
                    <div class="result-explanation" id="block-with"></div>
                </div>
            </div>
        </div>
    `;
}

function updateBlockingDemo() {
    const effect = parseInt(document.getElementById('block-effect').value);
    const blockVar = parseInt(document.getElementById('block-noise').value);
    document.getElementById('block-effect-val').textContent = effect;
    document.getElementById('block-noise-val').textContent = blockVar;
    const residualSD = 10;
    const totalSD_no = Math.sqrt(residualSD**2 + blockVar**2);
    const totalSD_yes = residualSD;
    const se_no = totalSD_no / Math.sqrt(20);
    const se_yes = totalSD_yes / Math.sqrt(20);
    const z_no = effect / se_no;
    const z_yes = effect / se_yes;
    const p_no = 2 * (1 - normalCDF(Math.abs(z_no)));
    const p_yes = 2 * (1 - normalCDF(Math.abs(z_yes)));
    document.getElementById('block-without').innerHTML =
        `Total SD: ${totalSD_no.toFixed(1)}<br>SE: ${se_no.toFixed(2)}<br>p-value: ${p_no < 0.001 ? '<0.001' : p_no.toFixed(3)}<br>${p_no < 0.05 ? '<span style="color:var(--accent-primary);">Significant</span>' : '<span style="color:var(--error);">Not significant</span>'}`;
    document.getElementById('block-with').innerHTML =
        `Total SD: ${totalSD_yes.toFixed(1)}<br>SE: ${se_yes.toFixed(2)}<br>p-value: ${p_yes < 0.001 ? '<0.001' : p_yes.toFixed(3)}<br>${p_yes < 0.05 ? '<span style="color:var(--accent-primary);">Significant</span>' : '<span style="color:var(--error);">Not significant</span>'}`;
}

// =============================================================================
// Bias Detector — checklist-style interactive
// =============================================================================
function renderBiasDetector(config) {
    const biases = [
        { id: 'selection', label: 'Selection Bias', q: 'Is the sample representative of the target population?' },
        { id: 'survivor', label: 'Survivorship Bias', q: 'Are we only seeing the successes/survivors?' },
        { id: 'attrition', label: 'Attrition Bias', q: 'Did participants drop out non-randomly?' },
        { id: 'measurement', label: 'Measurement Bias', q: 'Could measurement be systematically off?' },
        { id: 'confounding', label: 'Confounding', q: 'Are there unmeasured variables driving the result?' },
        { id: 'hawthorne', label: 'Hawthorne Effect', q: 'Does being observed change behavior?' },
    ];
    return `
        <div class="interactive-widget" id="bias-detector">
            <h3>Interactive: Bias Checklist</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">Use this checklist to evaluate any study design for potential biases.</p>
            ${biases.map(b => `
                <div style="display:flex; align-items:flex-start; gap:0.75rem; padding:0.75rem 0; border-bottom:1px solid var(--border);">
                    <input type="checkbox" id="bias-${b.id}" style="margin-top:3px; width:auto;">
                    <div>
                        <strong style="color:var(--text-primary);">${b.label}</strong>
                        <div style="color:var(--text-secondary); font-size:0.9rem;">${b.q}</div>
                    </div>
                </div>
            `).join('')}
            <div style="margin-top:1rem; padding:1rem; background:var(--bg-tertiary); border-radius:4px; font-size:0.9rem; color:var(--text-secondary);">
                Check each bias you've ruled out. Unchecked items are potential threats to your study's validity.
            </div>
        </div>
    `;
}

// =============================================================================
// Distribution Explorer
// =============================================================================
function renderDistributionExplorer(config) {
    return `
        <div class="interactive-widget" id="dist-explorer">
            <h3>Interactive: Distribution Explorer</h3>
            <div class="widget-row">
                <label>Distribution:</label>
                <select id="dist-type" onchange="updateDistExplorer()">
                    <option value="normal">Normal</option>
                    <option value="skewed">Right-Skewed (Log-normal)</option>
                    <option value="bimodal">Bimodal</option>
                    <option value="uniform">Uniform</option>
                    <option value="heavy">Heavy-Tailed</option>
                </select>
            </div>
            <div class="widget-row">
                <label>Sample size:</label>
                <input type="range" id="dist-n" min="20" max="500" step="20" value="100" oninput="updateDistExplorer()">
                <span class="widget-value" id="dist-n-val">100</span>
            </div>
            <button class="btn btn-primary btn-sm" onclick="updateDistExplorer()">Generate Sample</button>
            <div class="widget-result" id="dist-result" style="margin-top:1rem;">
                <pre id="dist-output" style="white-space:pre-wrap; font-size:0.85rem;"></pre>
            </div>
        </div>
    `;
}

function updateDistExplorer() {
    const type = document.getElementById('dist-type').value;
    const n = parseInt(document.getElementById('dist-n').value);
    document.getElementById('dist-n-val').textContent = n;
    let values = [];
    for (let i = 0; i < n; i++) {
        if (type === 'normal') values.push(randNormal() * 10 + 50);
        else if (type === 'skewed') values.push(Math.exp(randNormal() * 0.5 + 3));
        else if (type === 'bimodal') values.push((Math.random() < 0.5 ? 30 : 70) + randNormal() * 5);
        else if (type === 'uniform') values.push(Math.random() * 100);
        else values.push(50 + randNormal() * 10 / (0.1 + Math.random()));
    }
    const mean = values.reduce((a,b)=>a+b,0)/n;
    const sorted = [...values].sort((a,b)=>a-b);
    const median = n%2 ? sorted[Math.floor(n/2)] : (sorted[n/2-1]+sorted[n/2])/2;
    const sd = Math.sqrt(values.reduce((s,v)=>s+(v-mean)**2,0)/(n-1));
    const skew = values.reduce((s,v)=>s+((v-mean)/sd)**3,0)/n;
    const kurt = values.reduce((s,v)=>s+((v-mean)/sd)**4,0)/n - 3;
    // ASCII histogram
    const bins = 10;
    const min = sorted[0], max = sorted[n-1];
    const binW = (max-min)/bins;
    const counts = Array(bins).fill(0);
    values.forEach(v => { const b = Math.min(Math.floor((v-min)/binW), bins-1); counts[b]++; });
    const maxC = Math.max(...counts);
    let hist = '';
    counts.forEach((c, i) => {
        const bar = '#'.repeat(Math.round(c/maxC*30));
        hist += `${(min+i*binW).toFixed(1).padStart(8)} | ${bar} (${c})\n`;
    });
    document.getElementById('dist-output').textContent =
        `Distribution: ${type} (n=${n})\n\nMean: ${mean.toFixed(2)} | Median: ${median.toFixed(2)} | SD: ${sd.toFixed(2)}\nSkewness: ${skew.toFixed(2)} | Kurtosis: ${kurt.toFixed(2)}\n\n${hist}\n` +
        (Math.abs(skew) < 0.5 ? 'Roughly symmetric' : skew > 0 ? 'Right-skewed (mean > median)' : 'Left-skewed (mean < median)');
}

// =============================================================================
// Simpler interactive widgets (checklist / framework style)
// =============================================================================

function renderEDAExplorer(config) {
    return `
        <div class="interactive-widget" id="eda-explorer">
            <h3>Interactive: EDA Checklist</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">Track your EDA workflow to ensure thoroughness and prevent HARKing.</p>
            <div id="eda-steps">
                ${['Inspect column types and missing values', 'Plot distribution of each numeric variable',
                   'Identify and investigate outliers', 'Check bivariate relationships (scatter/box plots)',
                   'Look for subgroup patterns', 'Document all observations BEFORE testing',
                   'Flag hypotheses generated (not confirmed!) by EDA'].map((s, i) => `
                    <div style="display:flex; align-items:center; gap:0.75rem; padding:0.5rem 0;">
                        <input type="checkbox" id="eda-${i}" style="width:auto;" onchange="updateEDAProgress()">
                        <label for="eda-${i}" style="color:var(--text-secondary); min-width:0;">${s}</label>
                    </div>
                `).join('')}
            </div>
            <div class="widget-result" style="margin-top:1rem;">
                <div class="result-label">EDA Completion</div>
                <div class="result-value" id="eda-pct" style="font-size:1.5rem;">0%</div>
            </div>
        </div>
    `;
}

function updateEDAProgress() {
    const checks = document.querySelectorAll('#eda-steps input[type="checkbox"]');
    const done = [...checks].filter(c => c.checked).length;
    document.getElementById('eda-pct').textContent = Math.round(done / checks.length * 100) + '%';
}

function renderNaturalExperimentDemo(config) {
    return `
        <div class="interactive-widget">
            <h3>Interactive: Natural Experiment Evaluator</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">Evaluate the validity of a natural experiment design.</p>
            <div style="display:flex; flex-direction:column; gap:0.75rem;">
                ${[
                    { q: 'Is assignment as-if random?', hint: 'Could subjects have manipulated their assignment?' },
                    { q: 'Is the exclusion restriction plausible?', hint: 'Does the instrument affect outcome only through treatment?' },
                    { q: 'Are parallel trends likely?', hint: 'Would treatment and control groups have moved together?' },
                    { q: 'Is the comparison group valid?', hint: 'Are there systematic differences beyond the treatment?' },
                ].map((item, i) => `
                    <div style="padding:1rem; background:var(--bg-secondary); border:1px solid var(--border); border-radius:4px;">
                        <div style="display:flex; gap:0.5rem; align-items:center;">
                            <select id="ne-${i}" style="width:120px;">
                                <option value="">Evaluate...</option>
                                <option value="strong">Strong</option>
                                <option value="moderate">Moderate</option>
                                <option value="weak">Weak</option>
                                <option value="violated">Violated</option>
                            </select>
                            <strong style="color:var(--text-primary);">${item.q}</strong>
                        </div>
                        <div style="color:var(--text-dim); font-size:0.85rem; margin-top:0.25rem;">${item.hint}</div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

function renderPaperEvaluator(config) {
    return `
        <div class="interactive-widget">
            <h3>Interactive: Paper Evaluation Checklist</h3>
            ${[
                'Read figures and tables first (before abstract)',
                'Check sample size and power',
                'Verify analysis was preregistered',
                'Look for effect sizes and CIs (not just p-values)',
                'Check what outcomes are NOT reported',
                'Evaluate confounders and adjustments',
                'Assess conflict of interest disclosures',
                'Check if conclusions match evidence strength',
            ].map((s, i) => `
                <div style="display:flex; align-items:center; gap:0.75rem; padding:0.5rem 0; border-bottom:1px solid var(--border);">
                    <input type="checkbox" style="width:auto;">
                    <span style="color:var(--text-secondary);">${s}</span>
                </div>
            `).join('')}
        </div>
    `;
}

function renderStudyEvaluator(config) {
    return `
        <div class="interactive-widget">
            <h3>Interactive: Study Quality Rater</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">Rate a study on key quality dimensions.</p>
            ${[
                { label: 'Sample size adequacy', id: 'se-sample' },
                { label: 'Randomization quality', id: 'se-random' },
                { label: 'Blinding', id: 'se-blind' },
                { label: 'Attrition handling', id: 'se-attrition' },
                { label: 'Analysis appropriateness', id: 'se-analysis' },
            ].map(item => `
                <div class="widget-row">
                    <label>${item.label}:</label>
                    <input type="range" id="${item.id}" min="1" max="5" value="3" style="flex:1; max-width:200px;" oninput="document.getElementById('${item.id}-v').textContent=['Poor','Fair','Adequate','Good','Excellent'][this.value-1]">
                    <span class="widget-value" id="${item.id}-v">Adequate</span>
                </div>
            `).join('')}
        </div>
    `;
}

function renderForestPlotReader(config) {
    return `
        <div class="interactive-widget">
            <h3>Interactive: Forest Plot Reader</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">Practice reading a forest plot. Each line is a study.</p>
            <pre style="font-family: 'JetBrains Mono', monospace; font-size:0.85rem; color:var(--text-primary); line-height:1.6;">
Study          Effect [95% CI]        Weight
────────────────────────────────────────────
Smith 2018     0.45 [ 0.20, 0.70]     15%   ──●──
Jones 2019     0.62 [ 0.35, 0.89]     20%      ──●──
Lee 2020       0.10 [-0.18, 0.38]     10%   ●
Chen 2021      0.50 [ 0.30, 0.70]     25%    ─●─
Brown 2022     0.55 [ 0.28, 0.82]     30%     ──●──
────────────────────────────────────────────
Combined       0.48 [ 0.35, 0.61]            ◆
                     |
               ← Favors control  |  Favors treatment →
                     0
            </pre>
            <div style="margin-top:1rem; padding:1rem; background:var(--bg-tertiary); border-radius:4px; font-size:0.9rem; color:var(--text-secondary);">
                <strong>I² = 42%</strong> (moderate heterogeneity)<br>
                <strong>Key observations:</strong> Lee 2020 crosses zero (non-significant). Combined effect is d=0.48 — a medium effect. Most studies favor treatment. Moderate heterogeneity suggests some real variation between studies.
            </div>
        </div>
    `;
}

function renderDecisionFramework(config) {
    return `
        <div class="interactive-widget">
            <h3>Interactive: Should You Use Statistics?</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">Answer these questions to decide if quantitative analysis is appropriate.</p>
            <div id="decision-qs">
                ${[
                    { q: 'Is the question empirical (answerable with data)?', y: 'Good start.', n: 'Consider qualitative methods or expert judgment.' },
                    { q: 'Does relevant, measurable data exist?', y: 'Proceed.', n: 'You may need to collect data first, or use qualitative methods.' },
                    { q: 'Is the metric you have actually measuring what you care about?', y: 'Good.', n: 'Beware McNamara fallacy — measuring the wrong thing precisely.' },
                    { q: 'Will the metric stay valid once people know about it?', y: 'Safe to use.', n: "Goodhart's law risk — consider using multiple metrics." },
                ].map((item, i) => `
                    <div style="padding:1rem; background:var(--bg-secondary); border:1px solid var(--border); border-radius:4px; margin-bottom:0.5rem;">
                        <div style="color:var(--text-primary); margin-bottom:0.5rem;">${item.q}</div>
                        <div style="display:flex; gap:1rem;">
                            <button class="btn btn-secondary btn-sm" onclick="this.parentElement.nextElementSibling.textContent='${item.y}'; this.parentElement.nextElementSibling.style.display='block'; this.style.background='var(--accent-primary-dim)';">Yes</button>
                            <button class="btn btn-secondary btn-sm" onclick="this.parentElement.nextElementSibling.textContent='${item.n}'; this.parentElement.nextElementSibling.style.display='block'; this.style.background='var(--error-dim, #3a2020)';">No</button>
                        </div>
                        <div style="display:none; margin-top:0.75rem; padding:0.75rem; background:var(--bg-tertiary); border-radius:4px; color:var(--text-secondary); font-size:0.9rem;"></div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

function renderProjectPlanner(config) {
    return `
        <div class="interactive-widget">
            <h3>Interactive: Capstone Project Planner</h3>
            <div style="display:flex; flex-direction:column; gap:1rem;">
                <div>
                    <label style="color:var(--text-primary); font-weight:500;">1. Research Question</label>
                    <textarea id="cap-question" rows="2" placeholder="What is your primary research question?" style="width:100%; margin-top:0.5rem;"></textarea>
                </div>
                <div>
                    <label style="color:var(--text-primary); font-weight:500;">2. Hypotheses (state BEFORE analysis)</label>
                    <textarea id="cap-hyp" rows="2" placeholder="H₀: ... H₁: ..." style="width:100%; margin-top:0.5rem;"></textarea>
                </div>
                <div>
                    <label style="color:var(--text-primary); font-weight:500;">3. Planned Analysis</label>
                    <textarea id="cap-method" rows="2" placeholder="What statistical test/method will you use and why?" style="width:100%; margin-top:0.5rem;"></textarea>
                </div>
                <div>
                    <label style="color:var(--text-primary); font-weight:500;">4. Primary Outcome</label>
                    <textarea id="cap-outcome" rows="1" placeholder="What is your primary outcome measure?" style="width:100%; margin-top:0.5rem;"></textarea>
                </div>
            </div>
        </div>
    `;
}

function renderCapstoneWorkspace(config) {
    return `
        <div class="interactive-widget">
            <h3>Capstone Submission Checklist</h3>
            ${[
                'Research question clearly stated',
                'Hypotheses defined before analysis',
                'Data handling documented',
                'Appropriate statistical methods used',
                'Effect sizes and CIs reported',
                'Limitations prominently discussed',
                'Conclusions match evidence strength',
                'Report is 2,000-3,000 words',
                'Code/analysis files included',
            ].map((s, i) => `
                <div style="display:flex; align-items:center; gap:0.75rem; padding:0.5rem 0; border-bottom:1px solid var(--border);">
                    <input type="checkbox" id="cap-check-${i}" style="width:auto;">
                    <label for="cap-check-${i}" style="color:var(--text-secondary);">${s}</label>
                </div>
            `).join('')}
        </div>
    `;
}

// Nonparametric Demo Widget — runs Mann-Whitney U test on fake data
function renderNonparametricDemo(config) {
    const a = config.group_a || [];
    const b = config.group_b || [];
    return `
        <div class="interactive-widget" id="nonparam-demo">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 3v18h18"/><rect x="7" y="10" width="3" height="8"/><rect x="14" y="6" width="3" height="12"/>
                </svg>
                ${config.title || 'Mann-Whitney U Test Demo'}
            </h3>
            <p style="color:var(--text-secondary); margin-bottom:1rem;">${config.description || ''}</p>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:1rem;">
                <div>
                    <label style="font-weight:600; color:var(--text-primary);">${config.group_a_label || 'Group A'} (n=${a.length})</label>
                    <textarea id="np-group-a" rows="4" style="width:100%; margin-top:0.25rem; background:var(--bg-secondary); color:var(--text-primary); border:1px solid var(--border); border-radius:6px; padding:0.5rem; font-family:monospace; font-size:0.85rem;">${a.join(', ')}</textarea>
                </div>
                <div>
                    <label style="font-weight:600; color:var(--text-primary);">${config.group_b_label || 'Group B'} (n=${b.length})</label>
                    <textarea id="np-group-b" rows="4" style="width:100%; margin-top:0.25rem; background:var(--bg-secondary); color:var(--text-primary); border:1px solid var(--border); border-radius:6px; padding:0.5rem; font-family:monospace; font-size:0.85rem;">${b.join(', ')}</textarea>
                </div>
            </div>
            <button onclick="runMannWhitney()" style="background:var(--accent); color:white; border:none; padding:0.5rem 1.5rem; border-radius:6px; cursor:pointer; font-weight:600;">Run Mann-Whitney U Test</button>
            <div id="np-result" class="widget-result" style="margin-top:1rem; display:none;"></div>
            <div id="np-boxplot" style="margin-top:1rem;"></div>
        </div>
    `;
}

function runMannWhitney() {
    const parseNums = s => s.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v));
    const a = parseNums(document.getElementById('np-group-a').value);
    const b = parseNums(document.getElementById('np-group-b').value);
    if (a.length < 3 || b.length < 3) { alert('Need at least 3 values per group'); return; }

    // Rank all values
    const all = a.map(v => ({v, g:'A'})).concat(b.map(v => ({v, g:'B'})));
    all.sort((x,y) => x.v - y.v);
    // Assign ranks with tie-handling (average ranks)
    let i = 0;
    while (i < all.length) {
        let j = i;
        while (j < all.length && all[j].v === all[i].v) j++;
        const avgRank = (i + j + 1) / 2; // 1-indexed average
        for (let k = i; k < j; k++) all[k].rank = avgRank;
        i = j;
    }
    const rankSumA = all.filter(x => x.g === 'A').reduce((s,x) => s + x.rank, 0);
    const n1 = a.length, n2 = b.length;
    const U1 = rankSumA - n1*(n1+1)/2;
    const U2 = n1*n2 - U1;
    const U = Math.min(U1, U2);
    // Normal approximation
    const mu = n1*n2/2;
    const sigma = Math.sqrt(n1*n2*(n1+n2+1)/12);
    const z = (U - mu) / sigma;
    const p = 2 * (1 - normalCDF(Math.abs(z)));
    // Effect size: rank-biserial correlation
    const rbc = 1 - (2*U)/(n1*n2);
    // Medians
    const median = arr => { const s = [...arr].sort((a,b) => a-b); const m = Math.floor(s.length/2); return s.length%2 ? s[m] : (s[m-1]+s[m])/2; };
    const medA = median(a), medB = median(b);

    // Render box plots (ASCII-style with bars)
    const min = v => Math.min(...v), max = v => Math.max(...v);
    const q1 = arr => { const s=[...arr].sort((a,b)=>a-b); return s[Math.floor(s.length*0.25)]; };
    const q3 = arr => { const s=[...arr].sort((a,b)=>a-b); return s[Math.floor(s.length*0.75)]; };
    const lo = Math.min(min(a), min(b)), hi = Math.max(max(a), max(b));
    const scale = v => ((v - lo) / (hi - lo) * 100);

    const boxHTML = (arr, label) => {
        const mn=min(arr), mx=max(arr), m=median(arr), q1v=q1(arr), q3v=q3(arr);
        return `<div style="margin:0.5rem 0;">
            <div style="font-weight:600; font-size:0.85rem; margin-bottom:0.25rem;">${label} (median: ${m.toFixed(1)})</div>
            <div style="position:relative; height:24px; background:var(--bg-secondary); border-radius:4px;">
                <div style="position:absolute; left:${scale(mn)}%; width:${scale(mx)-scale(mn)}%; height:2px; top:11px; background:var(--text-secondary);"></div>
                <div style="position:absolute; left:${scale(q1v)}%; width:${scale(q3v)-scale(q1v)}%; height:20px; top:2px; background:var(--accent); opacity:0.3; border-radius:3px;"></div>
                <div style="position:absolute; left:${scale(m)}%; width:2px; height:20px; top:2px; background:var(--accent);"></div>
            </div>
        </div>`;
    };

    const labelA = document.getElementById('np-group-a').previousElementSibling.textContent.replace(/\s*\(.*/, '').trim();
    const labelB = document.getElementById('np-group-b').previousElementSibling.textContent.replace(/\s*\(.*/, '').trim();
    document.getElementById('np-boxplot').innerHTML = boxHTML(a, labelA) +
        boxHTML(b, labelB) +
        `<div style="display:flex; justify-content:space-between; font-size:0.75rem; color:var(--text-secondary); margin-top:0.25rem;"><span>${lo}</span><span>${hi}</span></div>`;

    const sig = p < 0.05;
    document.getElementById('np-result').style.display = 'block';
    document.getElementById('np-result').innerHTML = `
        <div style="font-size:1.2rem; font-weight:700; color:${sig ? 'var(--accent)' : 'var(--text-secondary)'};">
            ${sig ? 'Significant difference detected' : 'No significant difference'}
        </div>
        <table style="width:100%; margin-top:0.75rem; font-size:0.9rem;">
            <tr><td style="color:var(--text-secondary);">U statistic</td><td style="font-weight:600;">${U.toFixed(1)}</td></tr>
            <tr><td style="color:var(--text-secondary);">Z score</td><td style="font-weight:600;">${z.toFixed(3)}</td></tr>
            <tr><td style="color:var(--text-secondary);">P-value (two-sided)</td><td style="font-weight:600; color:${sig ? 'var(--accent)' : 'inherit'};">${p.toFixed(4)}</td></tr>
            <tr><td style="color:var(--text-secondary);">Rank-biserial r</td><td style="font-weight:600;">${rbc.toFixed(3)} (${Math.abs(rbc)<0.3?'small':Math.abs(rbc)<0.5?'medium':'large'} effect)</td></tr>
            <tr><td style="color:var(--text-secondary);">Median A / Median B</td><td style="font-weight:600;">${medA.toFixed(1)} / ${medB.toFixed(1)}</td></tr>
        </table>
        <p style="margin-top:0.75rem; font-size:0.85rem; color:var(--text-secondary);">
            ${sig ? 'The groups differ significantly. The rank-biserial correlation shows the effect size.' : 'Cannot reject the null hypothesis that both groups come from the same distribution.'}
            Try editing the data above to see how results change.
        </p>
    `;
}

// Time Series Demo Widget — decomposition with trend/seasonal/residual
function renderTimeseriesDemo(config) {
    const data = config.data || [];
    const labels = config.labels || data.map((_, i) => i + 1);
    return `
        <div class="interactive-widget" id="ts-demo">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 3v18h18"/><polyline points="3,17 8,12 13,15 18,8 21,10"/>
                </svg>
                ${config.title || 'Time Series Decomposition'}
            </h3>
            <p style="color:var(--text-secondary); margin-bottom:1rem;">${config.description || ''}</p>
            <div style="margin-bottom:1rem;">
                <label style="font-weight:600;">Seasonal Period: </label>
                <select id="ts-period" onchange="updateTSDemo()" style="background:var(--bg-secondary); color:var(--text-primary); border:1px solid var(--border); border-radius:4px; padding:0.25rem;">
                    <option value="4" ${config.period===4?'selected':''}>4 (Quarterly)</option>
                    <option value="7" ${config.period===7?'selected':''}>7 (Weekly)</option>
                    <option value="12" ${config.period===12?'selected':''}>12 (Monthly)</option>
                </select>
                <label style="font-weight:600; margin-left:1rem;">Model: </label>
                <select id="ts-model" onchange="updateTSDemo()" style="background:var(--bg-secondary); color:var(--text-primary); border:1px solid var(--border); border-radius:4px; padding:0.25rem;">
                    <option value="additive">Additive</option>
                    <option value="multiplicative">Multiplicative</option>
                </select>
            </div>
            <div id="ts-chart" style="font-family:monospace; font-size:0.8rem;"></div>
            <div id="ts-components" style="margin-top:1rem;"></div>
        </div>
    `;
}

function updateTSDemo() {
    const el = document.getElementById('ts-demo');
    if (!el) return;
    // Get data from the config stored during render
    const section = window.currentSectionData;
    if (!section || !section.interactive || !section.interactive.config) return;
    const data = section.interactive.config.data || [];
    const labels = section.interactive.config.labels || data.map((_, i) => i + 1);
    const period = parseInt(document.getElementById('ts-period').value);
    const model = document.getElementById('ts-model').value;
    if (data.length < period * 2) { document.getElementById('ts-chart').innerHTML = '<p>Need at least 2 full periods of data</p>'; return; }

    // Moving average trend
    const trend = [];
    const half = Math.floor(period / 2);
    for (let i = 0; i < data.length; i++) {
        if (i < half || i >= data.length - half) { trend.push(null); continue; }
        let sum = 0;
        for (let j = -half; j <= half; j++) sum += data[i + j];
        // For even periods, use centered MA
        if (period % 2 === 0) {
            sum = (sum - data[i - half] / 2 - data[i + half] / 2);
            trend.push(sum / period);
        } else {
            trend.push(sum / period);
        }
    }

    // Seasonal component
    const seasonal = new Array(data.length).fill(0);
    const seasonalAvg = new Array(period).fill(0);
    const seasonalCount = new Array(period).fill(0);
    for (let i = 0; i < data.length; i++) {
        if (trend[i] === null) continue;
        const s = model === 'additive' ? data[i] - trend[i] : data[i] / trend[i];
        seasonalAvg[i % period] += s;
        seasonalCount[i % period]++;
    }
    for (let j = 0; j < period; j++) {
        if (seasonalCount[j] > 0) seasonalAvg[j] /= seasonalCount[j];
    }
    for (let i = 0; i < data.length; i++) seasonal[i] = seasonalAvg[i % period];

    // Residual
    const residual = data.map((v, i) => {
        if (trend[i] === null) return null;
        return model === 'additive' ? v - trend[i] - seasonal[i] : v / (trend[i] * seasonal[i]);
    });

    // Render ASCII-style sparklines
    const sparkline = (vals, label, color) => {
        const valid = vals.filter(v => v !== null);
        if (valid.length === 0) return '';
        const mn = Math.min(...valid), mx = Math.max(...valid);
        const range = mx - mn || 1;
        const height = 60;
        const barW = Math.max(2, Math.floor(300 / vals.length));
        const bars = vals.map((v, i) => {
            if (v === null) return `<div style="display:inline-block;width:${barW}px;height:${height}px;"></div>`;
            const h = ((v - mn) / range) * (height - 4) + 2;
            return `<div style="display:inline-block;width:${barW}px;height:${height}px;position:relative;vertical-align:bottom;">
                <div style="position:absolute;bottom:0;width:${barW-1}px;height:${h}px;background:${color};border-radius:1px;"></div>
            </div>`;
        }).join('');
        return `<div style="margin-bottom:1rem;">
            <div style="font-weight:600; font-size:0.85rem; margin-bottom:0.25rem;">${label}</div>
            <div style="display:flex; align-items:flex-end; height:${height}px; overflow:hidden;">${bars}</div>
            <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:var(--text-secondary);"><span>${mn.toFixed(1)}</span><span>${mx.toFixed(1)}</span></div>
        </div>`;
    };

    document.getElementById('ts-chart').innerHTML =
        sparkline(data, 'Original Data', 'var(--accent)') +
        sparkline(trend, 'Trend (Moving Average)', '#10b981') +
        sparkline(seasonal, `Seasonal (period=${period})`, '#f59e0b') +
        sparkline(residual, `Residual (${model})`, '#ef4444');

    // Summary stats
    const validRes = residual.filter(v => v !== null);
    const resMean = validRes.reduce((a,b)=>a+b,0)/validRes.length;
    const resSD = Math.sqrt(validRes.reduce((a,v)=>a+(v-resMean)**2,0)/validRes.length);
    document.getElementById('ts-components').innerHTML = `
        <div style="background:var(--bg-secondary); padding:0.75rem; border-radius:6px; font-size:0.85rem;">
            <strong>Decomposition Summary (${model})</strong><br>
            Data points: ${data.length} | Period: ${period} | Trend range: ${Math.min(...trend.filter(v=>v!==null)).toFixed(1)} — ${Math.max(...trend.filter(v=>v!==null)).toFixed(1)}<br>
            Seasonal amplitude: ${(Math.max(...seasonalAvg) - Math.min(...seasonalAvg)).toFixed(2)} | Residual SD: ${resSD.toFixed(3)}
            ${model === 'additive' ? '<br><em>Try switching to multiplicative if seasonal swings grow with the level.</em>' : ''}
        </div>
    `;
}

// Survival Demo Widget — Kaplan-Meier curve from fake data
function renderSurvivalDemo(config) {
    return `
        <div class="interactive-widget" id="surv-demo">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 3v18h18"/><polyline points="3,5 8,5 8,9 12,9 12,14 16,14 16,18 21,18"/>
                </svg>
                ${config.title || 'Kaplan-Meier Survival Curve'}
            </h3>
            <p style="color:var(--text-secondary); margin-bottom:1rem;">${config.description || ''}</p>
            <div id="surv-chart" style="margin-bottom:1rem;"></div>
            <div id="surv-stats" style="background:var(--bg-secondary); padding:0.75rem; border-radius:6px; font-size:0.85rem;"></div>
        </div>
    `;
}

function updateSurvivalDemo() {
    const el = document.getElementById('surv-demo');
    if (!el) return;
    const section = window.currentSectionData;
    if (!section || !section.interactive || !section.interactive.config) return;
    const times = section.interactive.config.times || [];
    const events = section.interactive.config.events || [];
    const unit = section.interactive.config.unit || 'time';
    if (times.length === 0) return;

    // Build KM estimate
    const data = times.map((t, i) => ({time: t, event: events[i]})).sort((a,b) => a.time - b.time);
    let nAtRisk = data.length;
    let survival = 1.0;
    const kmPoints = [{time: 0, survival: 1.0}];
    const eventTimes = [];

    let i = 0;
    while (i < data.length) {
        const t = data[i].time;
        let deaths = 0, censored = 0;
        while (i < data.length && data[i].time === t) {
            if (data[i].event === 1) deaths++;
            else censored++;
            i++;
        }
        if (deaths > 0) {
            survival *= (nAtRisk - deaths) / nAtRisk;
            eventTimes.push({time: t, deaths, nAtRisk, survival});
            kmPoints.push({time: t, survival});
        }
        nAtRisk -= (deaths + censored);
    }

    // Draw KM curve using CSS/divs
    const maxTime = Math.max(...times);
    const chartW = 400, chartH = 200;
    const scaleX = t => (t / maxTime) * chartW;
    const scaleY = s => (1 - s) * chartH;

    let pathParts = [];
    for (let j = 0; j < kmPoints.length; j++) {
        const x = scaleX(kmPoints[j].time);
        const y = scaleY(kmPoints[j].survival);
        if (j === 0) {
            pathParts.push(`M ${x} ${y}`);
        } else {
            // Horizontal line to new time, then vertical drop
            const prevY = scaleY(kmPoints[j-1].survival);
            pathParts.push(`L ${x} ${prevY}`);
            pathParts.push(`L ${x} ${y}`);
        }
    }
    // Extend to end
    pathParts.push(`L ${chartW} ${scaleY(kmPoints[kmPoints.length-1].survival)}`);

    // Censoring tick marks
    const censoredData = data.filter(d => d.event === 0);
    // For censored at the same time as event, find the survival at that point
    const censorTicks = censoredData.map(d => {
        let s = 1.0;
        for (const e of eventTimes) {
            if (e.time <= d.time) s = e.survival;
            else break;
        }
        return {x: scaleX(d.time), y: scaleY(s)};
    });

    const ticksHTML = censorTicks.map(c =>
        `<line x1="${c.x}" y1="${c.y-6}" x2="${c.x}" y2="${c.y+6}" stroke="var(--accent)" stroke-width="2"/>`
    ).join('');

    document.getElementById('surv-chart').innerHTML = `
        <svg width="${chartW + 60}" height="${chartH + 40}" style="overflow:visible;">
            <g transform="translate(50, 10)">
                <!-- Grid -->
                ${[0, 0.25, 0.5, 0.75, 1.0].map(s => `
                    <line x1="0" y1="${scaleY(s)}" x2="${chartW}" y2="${scaleY(s)}" stroke="var(--border)" stroke-dasharray="3,3"/>
                    <text x="-8" y="${scaleY(s)+4}" text-anchor="end" fill="var(--text-secondary)" font-size="11">${(s*100).toFixed(0)}%</text>
                `).join('')}
                ${[0, 0.25, 0.5, 0.75, 1.0].map(f => `
                    <text x="${f*chartW}" y="${chartH+20}" text-anchor="middle" fill="var(--text-secondary)" font-size="11">${(f*maxTime).toFixed(0)}</text>
                `).join('')}
                <!-- KM Curve -->
                <path d="${pathParts.join(' ')}" fill="none" stroke="var(--accent)" stroke-width="2.5"/>
                <!-- Censoring ticks -->
                ${ticksHTML}
                <!-- Median line if applicable -->
                ${kmPoints[kmPoints.length-1].survival < 0.5 ? `
                    <line x1="0" y1="${scaleY(0.5)}" x2="${chartW}" y2="${scaleY(0.5)}" stroke="var(--text-secondary)" stroke-dasharray="5,5" stroke-width="1"/>
                    <text x="${chartW+5}" y="${scaleY(0.5)+4}" fill="var(--text-secondary)" font-size="10">50%</text>
                ` : ''}
                <!-- Axes -->
                <line x1="0" y1="0" x2="0" y2="${chartH}" stroke="var(--text-secondary)" stroke-width="1"/>
                <line x1="0" y1="${chartH}" x2="${chartW}" y2="${chartH}" stroke="var(--text-secondary)" stroke-width="1"/>
                <text x="${chartW/2}" y="${chartH+35}" text-anchor="middle" fill="var(--text-secondary)" font-size="12">${unit}</text>
                <text x="-40" y="${chartH/2}" text-anchor="middle" fill="var(--text-secondary)" font-size="12" transform="rotate(-90,-40,${chartH/2})">Survival</text>
            </g>
        </svg>
    `;

    // Median survival
    let medianSurv = 'Not reached';
    for (const e of eventTimes) {
        if (e.survival < 0.5) { medianSurv = `${e.time} ${unit}`; break; }
    }
    const totalEvents = events.filter(e => e === 1).length;
    const totalCensored = events.filter(e => e === 0).length;

    document.getElementById('surv-stats').innerHTML = `
        <strong>Kaplan-Meier Summary</strong><br>
        Total subjects: ${times.length} | Events: ${totalEvents} | Censored: ${totalCensored} (${(totalCensored/times.length*100).toFixed(1)}%)<br>
        Median survival: ${medianSurv}<br>
        Survival at max observation: ${(kmPoints[kmPoints.length-1].survival*100).toFixed(1)}%<br>
        <em style="color:var(--text-secondary);">| marks = censored observations. Steps down = events (failures).</em>
    `;
}

// Clustering Demo Widget — interactive K-means on 2D data
function renderClusteringDemo(config) {
    return `
        <div class="interactive-widget" id="cluster-demo">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="8" cy="8" r="3"/><circle cx="16" cy="16" r="3"/><circle cx="16" cy="8" r="2"/><circle cx="8" cy="16" r="2"/>
                </svg>
                ${config.title || 'K-Means Clustering Demo'}
            </h3>
            <p style="color:var(--text-secondary); margin-bottom:1rem;">${config.description || ''}</p>
            <div style="margin-bottom:1rem;">
                <label style="font-weight:600;">Number of clusters (k): </label>
                <input type="range" id="cluster-k" min="2" max="${config.max_k || 6}" value="${config.default_k || 3}" oninput="document.getElementById('cluster-k-val').textContent=this.value; updateClusterDemo()">
                <span id="cluster-k-val" class="widget-value">${config.default_k || 3}</span>
            </div>
            <div id="cluster-chart" style="margin-bottom:1rem;"></div>
            <div id="cluster-stats" style="background:var(--bg-secondary); padding:0.75rem; border-radius:6px; font-size:0.85rem;"></div>
        </div>
    `;
}

function updateClusterDemo() {
    const el = document.getElementById('cluster-demo');
    if (!el) return;
    const section = window.currentSectionData;
    if (!section || !section.interactive || !section.interactive.config) return;
    const config = section.interactive.config;
    const x = config.x_data || [];
    const y = config.y_data || [];
    const k = parseInt(document.getElementById('cluster-k').value);
    if (x.length === 0) return;

    // Normalize data for clustering
    const xMin = Math.min(...x), xMax = Math.max(...x), yMin = Math.min(...y), yMax = Math.max(...y);
    const xNorm = x.map(v => (v - xMin) / (xMax - xMin || 1));
    const yNorm = y.map(v => (v - yMin) / (yMax - yMin || 1));

    // K-means (simple implementation)
    // Initialize centroids using k-means++ style (first k distinct points)
    let centroids = [];
    const indices = Array.from({length: x.length}, (_, i) => i);
    // Shuffle and pick first k
    for (let i = indices.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [indices[i], indices[j]] = [indices[j], indices[i]]; }
    for (let i = 0; i < k; i++) centroids.push({x: xNorm[indices[i]], y: yNorm[indices[i]]});

    let assignments = new Array(x.length).fill(0);
    for (let iter = 0; iter < 50; iter++) {
        // Assign to nearest centroid
        let changed = false;
        for (let i = 0; i < x.length; i++) {
            let minDist = Infinity, best = 0;
            for (let c = 0; c < k; c++) {
                const d = (xNorm[i]-centroids[c].x)**2 + (yNorm[i]-centroids[c].y)**2;
                if (d < minDist) { minDist = d; best = c; }
            }
            if (assignments[i] !== best) { assignments[i] = best; changed = true; }
        }
        if (!changed) break;
        // Update centroids
        for (let c = 0; c < k; c++) {
            const members = assignments.map((a, i) => a === c ? i : -1).filter(i => i >= 0);
            if (members.length > 0) {
                centroids[c] = {
                    x: members.reduce((s, i) => s + xNorm[i], 0) / members.length,
                    y: members.reduce((s, i) => s + yNorm[i], 0) / members.length,
                };
            }
        }
    }

    // Silhouette score
    let silTotal = 0;
    for (let i = 0; i < x.length; i++) {
        // a(i) = avg dist to same cluster
        const same = assignments.map((a, j) => a === assignments[i] && j !== i ? j : -1).filter(j => j >= 0);
        const ai = same.length > 0 ? same.reduce((s, j) => s + Math.sqrt((xNorm[i]-xNorm[j])**2+(yNorm[i]-yNorm[j])**2), 0) / same.length : 0;
        // b(i) = min avg dist to other cluster
        let bi = Infinity;
        for (let c = 0; c < k; c++) {
            if (c === assignments[i]) continue;
            const others = assignments.map((a, j) => a === c ? j : -1).filter(j => j >= 0);
            if (others.length === 0) continue;
            const avgDist = others.reduce((s, j) => s + Math.sqrt((xNorm[i]-xNorm[j])**2+(yNorm[i]-yNorm[j])**2), 0) / others.length;
            bi = Math.min(bi, avgDist);
        }
        silTotal += bi === Infinity ? 0 : (bi - ai) / Math.max(ai, bi);
    }
    const silhouette = silTotal / x.length;

    // Draw scatter plot
    const chartW = 400, chartH = 300;
    const colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];
    const scaleXp = v => ((v - xMin) / (xMax - xMin)) * (chartW - 20) + 10;
    const scaleYp = v => chartH - ((v - yMin) / (yMax - yMin)) * (chartH - 20) - 10;

    const dots = x.map((xv, i) =>
        `<circle cx="${scaleXp(xv)}" cy="${scaleYp(y[i])}" r="5" fill="${colors[assignments[i] % colors.length]}" opacity="0.8"/>`
    ).join('');

    const centroidMarks = centroids.map((c, i) => {
        const cx = c.x * (xMax - xMin) + xMin;
        const cy = c.y * (yMax - yMin) + yMin;
        return `<circle cx="${scaleXp(cx)}" cy="${scaleYp(cy)}" r="8" fill="none" stroke="${colors[i % colors.length]}" stroke-width="3"/>
                <line x1="${scaleXp(cx)-5}" y1="${scaleYp(cy)}" x2="${scaleXp(cx)+5}" y2="${scaleYp(cy)}" stroke="${colors[i % colors.length]}" stroke-width="2"/>
                <line x1="${scaleXp(cx)}" y1="${scaleYp(cy)-5}" x2="${scaleXp(cx)}" y2="${scaleYp(cy)+5}" stroke="${colors[i % colors.length]}" stroke-width="2"/>`;
    }).join('');

    document.getElementById('cluster-chart').innerHTML = `
        <svg width="${chartW + 80}" height="${chartH + 40}" style="overflow:visible;">
            <g transform="translate(60, 10)">
                ${dots}
                ${centroidMarks}
                <line x1="0" y1="${chartH}" x2="${chartW}" y2="${chartH}" stroke="var(--text-secondary)"/>
                <line x1="0" y1="0" x2="0" y2="${chartH}" stroke="var(--text-secondary)"/>
                <text x="${chartW/2}" y="${chartH+30}" text-anchor="middle" fill="var(--text-secondary)" font-size="12">${config.x_label || 'X'}</text>
                <text x="-45" y="${chartH/2}" text-anchor="middle" fill="var(--text-secondary)" font-size="12" transform="rotate(-90,-45,${chartH/2})">${config.y_label || 'Y'}</text>
                ${[0, 0.5, 1].map(f => `<text x="-5" y="${scaleYp(yMin + f*(yMax-yMin))+4}" text-anchor="end" fill="var(--text-secondary)" font-size="10">${(yMin + f*(yMax-yMin)).toFixed(0)}</text>`).join('')}
                ${[0, 0.5, 1].map(f => `<text x="${scaleXp(xMin + f*(xMax-xMin))}" y="${chartH+15}" text-anchor="middle" fill="var(--text-secondary)" font-size="10">${(xMin + f*(xMax-xMin)).toFixed(0)}</text>`).join('')}
            </g>
        </svg>
    `;

    // Cluster summary
    const clusterInfo = [];
    for (let c = 0; c < k; c++) {
        const members = assignments.map((a, i) => a === c ? i : -1).filter(i => i >= 0);
        const avgX = members.reduce((s, i) => s + x[i], 0) / members.length;
        const avgY = members.reduce((s, i) => s + y[i], 0) / members.length;
        clusterInfo.push(`<span style="color:${colors[c % colors.length]}; font-weight:600;">Cluster ${c+1}</span>: n=${members.length}, avg ${config.x_label||'X'}=${avgX.toFixed(0)}, avg ${config.y_label||'Y'}=${avgY.toFixed(1)}`);
    }

    document.getElementById('cluster-stats').innerHTML = `
        <strong>K-Means Results (k=${k})</strong><br>
        Silhouette Score: <strong style="color:${silhouette > 0.5 ? '#10b981' : silhouette > 0.25 ? '#f59e0b' : '#ef4444'};">${silhouette.toFixed(3)}</strong>
        ${silhouette > 0.5 ? '(good separation)' : silhouette > 0.25 ? '(moderate separation)' : '(weak separation — try different k)'}<br>
        ${clusterInfo.join('<br>')}<br>
        <em style="color:var(--text-secondary);">+ marks = centroids. Drag the k slider to see how clusters change.</em>
    `;
}

// Initialize widgets after they are rendered
function initializeWidgets() {
    // Check which widgets exist and initialize them
    if (document.getElementById('bayesian-calculator')) {
        updateBayesian();
    }
    if (document.getElementById('base-rate-calculator')) {
        updateBaseRate();
    }
    if (document.getElementById('sample-size-calculator')) {
        updateSampleSize();
    }
    if (document.getElementById('power-calculator')) {
        updatePower();
    }
    if (document.getElementById('hypothesis-tracker')) {
        updateHypProbs();
    }
    if (document.getElementById('evidence-rater')) {
        updateEvidenceRating();
    }
    if (document.getElementById('test-selector')) {
        updateTestRecommendation();
    }
    if (document.getElementById('results-interpreter')) {
        updateResultsInterpretation();
    }
    if (document.getElementById('data-cleaner')) {
        updateDataCleaningRec();
    }
    if (document.getElementById('regression-simulator')) {
        updateRTM();
    }
    if (document.getElementById('trial-analyzer')) {
        updateTrialAnalysis();
    }
    if (document.getElementById('ab-analyzer')) {
        updateABAnalysis();
    }
    if (document.getElementById('pvalue-sim')) {
        updatePValueSim();
    }
    if (document.getElementById('ci-viz')) {
        updateCI();
    }
    if (document.getElementById('effect-calc')) {
        updateEffectSize();
    }
    if (document.getElementById('blocking-demo')) {
        updateBlockingDemo();
    }
    if (document.getElementById('dist-explorer')) {
        updateDistExplorer();
    }
    if (document.getElementById('ts-demo')) {
        updateTSDemo();
    }
    if (document.getElementById('surv-demo')) {
        updateSurvivalDemo();
    }
    if (document.getElementById('cluster-demo')) {
        updateClusterDemo();
    }
}

function backToModule() {
    if (currentModule) {
        selectModule(currentModule.id);
    }
}

async function completeSection() {
    if (!currentModule || !currentSection) return;

    // Gate on interaction if section has a widget
    const hasWidget = currentSection.rich_content && currentSection.rich_content.interactive;
    if (hasWidget && !window.sectionInteracted) {
        const btn = document.getElementById('complete-section-btn');
        btn.textContent = 'Try the exercise first';
        btn.style.animation = 'shake 0.3s';
        setTimeout(() => btn.style.animation = '', 300);
        return;
    }

    try {
        const response = await fetch(`/api/learn/progress/${currentModule.id}/complete/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ section_id: currentSection.id })
        });

        if (response.ok) {
            svendTrack('feature_use', {category: 'learn', action: 'complete_section', label: currentSection.id});
            const btn = document.getElementById('complete-section-btn');
            btn.textContent = 'Completed!';
            btn.disabled = true;

            // Refresh progress
            await loadProgress();
            await loadModules();
            renderModuleList();
            updateProgressDisplay();
        }
    } catch (err) {
        console.error('Failed to mark complete:', err);
    }
}

// Assessment
async function startAssessment() {
    try {
        const response = await fetch('/api/learn/assessment/generate/', {
            method: 'POST',
            credentials: 'include'
        });

        if (response.ok) {
            const data = await response.json();
            assessmentId = data.assessment_id;
            assessmentQuestions = data.questions;
            assessmentTimeLeft = data.time_limit_minutes * 60;

            renderAssessment();
            startTimer();
            showView('assessment');
        } else {
            const error = await response.json();
            alert(error.error || 'Failed to generate assessment');
        }
    } catch (err) {
        console.error('Failed to start assessment:', err);
        alert('Failed to start assessment. Please try again.');
    }
}

function renderAssessment() {
    document.getElementById('question-count').textContent = assessmentQuestions.length;

    document.getElementById('assessment-questions').innerHTML = assessmentQuestions.map((q, i) => `
        <div class="question-card" data-question="${i}">
            <div class="question-number">Question ${i + 1} of ${assessmentQuestions.length}</div>
            <div class="question-topic" style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 0.5rem;">
                Topic: ${q.topic}
            </div>
            <div class="question-text">${q.question}</div>
            <div class="question-options">
                ${q.options.map((opt, j) => `
                    <label class="option-label" onclick="selectOption(${i}, ${j})">
                        <input type="radio" name="q${i}" value="${j}">
                        <span>${opt}</span>
                    </label>
                `).join('')}
            </div>
        </div>
    `).join('');
}

function selectOption(questionIndex, optionIndex) {
    const card = document.querySelector(`[data-question="${questionIndex}"]`);
    card.querySelectorAll('.option-label').forEach((label, i) => {
        label.classList.toggle('selected', i === optionIndex);
    });
}

function startTimer() {
    const timerEl = document.getElementById('assessment-timer');

    assessmentTimer = setInterval(() => {
        assessmentTimeLeft--;

        const minutes = Math.floor(assessmentTimeLeft / 60);
        const seconds = assessmentTimeLeft % 60;
        timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

        if (assessmentTimeLeft <= 0) {
            clearInterval(assessmentTimer);
            submitAssessment();
        }
    }, 1000);
}

async function submitAssessment() {
    clearInterval(assessmentTimer);

    // Collect answers
    const answers = {};
    assessmentQuestions.forEach((_, i) => {
        const selected = document.querySelector(`input[name="q${i}"]:checked`);
        if (selected) {
            answers[i] = parseInt(selected.value);
        }
    });

    try {
        const response = await fetch('/api/learn/assessment/submit/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                assessment_id: assessmentId,
                answers: answers
            })
        });

        if (response.ok) {
            const data = await response.json();
            showResults(data);
        } else {
            alert('Failed to submit assessment');
        }
    } catch (err) {
        console.error('Failed to submit:', err);
        alert('Failed to submit assessment');
    }
}

function showResults(data) {
    const pct = Math.round(data.score * 100);

    document.getElementById('results-content').innerHTML = `
        <h2>Assessment Results</h2>
        <div class="results-score ${data.passed ? 'passed' : 'failed'}">${pct}%</div>
        <p class="results-message">
            ${data.passed
                ? 'Congratulations! You passed the assessment.'
                : `You need ${Math.round(data.passing_score * 100)}% to pass. Keep studying and try again.`}
        </p>
        <p style="color: var(--text-secondary); margin-bottom: 2rem;">
            ${data.correct} of ${data.total} questions correct
        </p>

        <button class="btn btn-secondary" onclick="showView('welcome')">
            Return to Course
        </button>

        <h3 style="margin-top: 3rem;">Question Breakdown</h3>
        <div class="results-breakdown">
            ${data.results.map((r, i) => `
                <div class="result-item ${r.is_correct ? 'correct' : 'incorrect'}">
                    <div>
                        <strong>Q${i + 1}:</strong> ${r.question}
                        <br>
                        <small style="color: var(--text-dim);">
                            Your answer: ${r.your_answer || 'No answer'}
                            ${!r.is_correct ? `<br>Correct: ${r.correct_answer}` : ''}
                        </small>
                        ${r.explanation ? `<br><small style="color: var(--text-secondary);">${r.explanation}</small>` : ''}
                    </div>
                </div>
            `).join('')}
        </div>
    `;

    showView('results');

    // Refresh progress
    loadProgress();
}

// Search
document.getElementById('search-input')?.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase();
    // Simple search through module names - would expand to full text search
    document.querySelectorAll('.module-item').forEach(el => {
        const name = el.querySelector('.module-name').textContent.toLowerCase();
        el.style.display = name.includes(query) ? '' : 'none';
    });
});
</script>
{% endblock %}
