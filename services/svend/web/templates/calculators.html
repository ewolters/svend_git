{% extends "base_app.html" %}
{% block title %}Operations Workbench - SVEND{% endblock %}

{% block extra_head %}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<style>
/* ============================================================================
   OPERATIONS WORKBENCH - Full Layout
   ============================================================================ */

body > main { padding: 0 !important; }
body > main > .container { max-width: none !important; padding: 0 !important; }

.ops-container {
    display: flex;
    height: calc(100vh - 60px);
    background: var(--bg-primary);
}

/* Sidebar */
.ops-sidebar {
    width: 240px;
    background: var(--bg-card);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
}

.ops-sidebar-header {
    padding: 20px;
    border-bottom: 1px solid var(--border);
}

.ops-sidebar-header h1 {
    font-size: 16px;
    font-weight: 600;
    margin: 0 0 4px 0;
}

.ops-sidebar-header p {
    font-size: 11px;
    color: var(--text-dim);
    margin: 0;
}

.ops-nav {
    flex: 1;
    overflow-y: auto;
    padding: 12px 0;
    display: flex;
    flex-direction: column;
    align-items: stretch;
}

.ops-nav-group {
    margin-bottom: 16px;
    display: flex;
    flex-direction: column;
    align-items: stretch;
}

.ops-nav-group-title {
    margin: 0;
    padding: 8px 12px;
    font-size: 10px;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.ops-nav-item {
    margin: 0;
    padding: 10px 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
    position: relative;
}

.ops-nav-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    background: transparent;
    transition: background 0.15s;
}

.ops-nav-item:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.ops-nav-item.active {
    background: rgba(74, 159, 110, 0.1);
    color: var(--accent);
}

.ops-nav-item.active::before {
    background: var(--accent);
}

.ops-nav-item svg {
    width: 18px;
    height: 18px;
    min-width: 18px;
    opacity: 0.7;
}

.ops-nav-item.active svg {
    opacity: 1;
}

.ops-nav-item.coming-soon { opacity: 0.45; }
.ops-nav-item.coming-soon::after {
    content: 'SOON';
    font-size: 8px;
    font-weight: 700;
    letter-spacing: 0.5px;
    background: var(--accent);
    color: white;
    padding: 1px 5px;
    border-radius: 3px;
    margin-left: auto;
}

.ops-nav-item span {
    font-size: 13px;
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Main Content */
.ops-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.ops-header {
    padding: 20px 32px;
    border-bottom: 1px solid var(--border);
    background: var(--bg-card);
    position: relative;
}

.ops-header h2 {
    font-size: 20px;
    font-weight: 600;
    margin: 0 0 4px 0;
}

.ops-header p {
    font-size: 13px;
    color: var(--text-secondary);
    margin: 0;
}

.ops-content {
    flex: 1;
    overflow-y: auto;
    padding: 32px;
}

/* Calculator Layout */
.calc-layout {
    display: none;
    max-width: 1000px;
}

.calc-layout.active {
    display: block;
}

@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.7; transform: scale(0.95); }
}

.calc-section {
    margin-bottom: 32px;
}

.calc-section-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 16px;
}

/* Input Grid */
.calc-inputs {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
}

.calc-input {
    display: flex;
    flex-direction: column;
}

.calc-input label {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 6px;
}

.calc-input input, .calc-input select {
    padding: 12px 16px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-size: 16px;
    font-weight: 500;
}

.calc-input input:focus, .calc-input select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(74, 159, 110, 0.1);
}

select, .calc-input select {
    color-scheme: dark;
}

select option {
    background: #1a1f1a;
    color: #e8efe8;
}

.calc-input .input-hint {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 4px;
}

/* Results */
.calc-results {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.calc-result-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
}

.calc-result-card.primary {
    background: linear-gradient(135deg, rgba(74, 159, 110, 0.15), rgba(74, 159, 110, 0.05));
    border-color: var(--accent);
}

.calc-result-label {
    font-size: 11px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.calc-result-value {
    font-size: 36px;
    font-weight: 700;
    color: var(--text-primary);
    line-height: 1;
}

.calc-result-card.primary .calc-result-value {
    color: var(--accent);
}

.calc-result-unit {
    font-size: 14px;
    font-weight: 400;
    color: var(--text-secondary);
    margin-left: 4px;
}

/* Breakdown Table */
.calc-breakdown {
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 16px;
    margin-top: 16px;
}

.calc-breakdown-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
}

.calc-breakdown-row:last-child {
    border-bottom: none;
}

.calc-breakdown-row span:first-child {
    color: var(--text-secondary);
}

.calc-breakdown-row span:last-child {
    font-weight: 500;
    color: var(--text-primary);
}

/* Charts */
.calc-chart {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    padding-bottom: 32px;
    margin-top: 24px;
    overflow: hidden;
}

.calc-chart > div[id$="-chart"] {
    width: 100% !important;
}

.calc-chart-title {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 16px;
}

/* DSW Pull */
.calc-dsw-pull {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: rgba(74, 159, 110, 0.1);
    border: 1px solid var(--accent);
    border-radius: 8px;
    color: var(--accent);
    font-size: 13px;
    cursor: pointer;
    margin-bottom: 20px;
    transition: all 0.15s;
}

.calc-dsw-pull:hover {
    background: rgba(74, 159, 110, 0.2);
}

.calc-dsw-pull svg {
    width: 18px;
    height: 18px;
}

/* Pull Button — Standardized Cross-Calculator Integration */
.calc-pull-btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 11px;
    font-family: inherit;
    transition: all 0.15s;
    margin-left: 6px;
    opacity: 0.5;
    white-space: nowrap;
    vertical-align: middle;
}
.calc-pull-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
    opacity: 1;
}
.calc-pull-btn.has-link {
    border-color: var(--accent);
    color: var(--accent);
    opacity: 1;
    animation: pulse-link 2s infinite;
}
.calc-pull-btn svg {
    width: 12px;
    height: 12px;
    flex-shrink: 0;
}

/* Standalone Pull Button (for complex data transfers between calculators) */
.calc-pull-btn.standalone {
    padding: 6px 12px;
    font-size: 12px;
    margin-left: 0;
    margin-bottom: 12px;
    background: var(--bg-secondary);
    opacity: 0.7;
}
.calc-pull-btn.standalone:hover { opacity: 1; }

@keyframes pulse-link {
    0%, 100% { box-shadow: 0 0 0 0 rgba(74, 159, 110, 0.4); }
    50% { box-shadow: 0 0 0 4px rgba(74, 159, 110, 0); }
}

@keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 0.8; }
    50% { transform: scale(1.1); opacity: 1; }
}

@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}


/* Monte Carlo Toggle */
.calc-monte-toggle {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 14px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-secondary);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.15s;
}

.calc-monte-toggle:hover {
    border-color: var(--accent);
    color: var(--accent);
}

.calc-monte-toggle.active {
    background: rgba(74, 159, 110, 0.15);
    border-color: var(--accent);
    color: var(--accent);
}

.calc-monte-toggle svg {
    width: 14px;
    height: 14px;
}

.calc-monte-results {
    display: none;
    margin-top: 16px;
    padding: 16px;
    background: var(--bg-secondary);
    border-radius: 8px;
}

.calc-monte-results.visible {
    display: block;
}

.calc-monte-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
    margin-bottom: 16px;
}

.calc-monte-stat {
    text-align: center;
    padding: 10px;
    background: var(--bg-card);
    border-radius: 6px;
}

.calc-monte-stat-label {
    font-size: 10px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.calc-monte-stat-value {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
    margin-top: 4px;
}

/* Next Steps / Cross-link Cards */
.calc-next-steps { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 16px; }
.calc-next-step {
    display: flex; align-items: center; gap: 8px;
    padding: 10px 14px; background: var(--bg-secondary);
    border: 1px solid var(--border); border-radius: 8px;
    color: var(--text-secondary); font-size: 12px;
    cursor: pointer; transition: all 0.15s; flex: 1; min-width: 200px;
}
.calc-next-step:hover { border-color: var(--accent); color: var(--accent); background: rgba(74,159,110,0.05); }
.calc-next-step svg { width: 16px; height: 16px; min-width: 16px; opacity: 0.6; }
.calc-next-step-title { font-weight: 600; font-size: 12px; }
.calc-next-step-desc { font-size: 11px; color: var(--text-dim); margin-top: 2px; }

/* Derivation / Show Work Section */
.calc-derivation {
    margin-top: 20px;
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
}

.calc-derivation-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    background: var(--bg-secondary);
    cursor: pointer;
    color: var(--text-secondary);
    font-size: 13px;
    transition: all 0.15s;
}

.calc-derivation-header:hover {
    color: var(--text-primary);
    background: var(--bg-tertiary);
}

.calc-derivation-header svg {
    width: 16px;
    height: 16px;
    transition: transform 0.2s;
}

.calc-derivation.expanded .calc-derivation-header svg {
    transform: rotate(90deg);
}

.calc-derivation-body {
    display: none;
    padding: 16px;
    font-family: 'SF Mono', 'Fira Code', monospace;
    font-size: 13px;
    line-height: 1.8;
    color: var(--text-secondary);
    background: var(--bg-card);
}

.calc-derivation.expanded .calc-derivation-body {
    display: block;
}

.calc-derivation-body .formula {
    color: var(--accent);
    font-weight: 500;
}

.calc-derivation-body .step {
    margin-bottom: 12px;
    padding-left: 16px;
    border-left: 2px solid var(--border);
}

.calc-derivation-body .step-num {
    color: var(--text-dim);
    font-size: 11px;
}

/* Yamazumi Specific */
.yamazumi-stations {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 20px;
}

.yamazumi-station {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--bg-secondary);
    border-radius: 8px;
}

.yamazumi-station-name {
    flex: 1;
    font-size: 14px;
    font-weight: 500;
}

.yamazumi-station input {
    width: 100px;
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--bg-card);
    color: var(--text-primary);
    font-size: 14px;
    text-align: right;
}

.yamazumi-station-remove {
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    padding: 4px;
    font-size: 18px;
}

.yamazumi-station-remove:hover {
    color: #e74c3c;
}

.yamazumi-add {
    padding: 12px;
    border: 2px dashed var(--border);
    border-radius: 8px;
    color: var(--text-secondary);
    text-align: center;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.15s;
}

.yamazumi-add:hover {
    border-color: var(--accent);
    color: var(--accent);
}

/* OEE Gauge */
.oee-display {
    text-align: center;
    padding: 40px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    margin-bottom: 24px;
}

.oee-value {
    font-size: 72px;
    font-weight: 700;
    line-height: 1;
}

.oee-label {
    font-size: 14px;
    color: var(--text-dim);
    margin-top: 8px;
}

.oee-world-class { color: #27ae60; }
.oee-good { color: #f39c12; }
.oee-poor { color: #e74c3c; }

.oee-factors {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
}

.oee-factor {
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
}

.oee-factor-value {
    font-size: 28px;
    font-weight: 600;
    margin-bottom: 4px;
}

.oee-factor-label {
    font-size: 12px;
    color: var(--text-dim);
    text-transform: uppercase;
}

/* Bottleneck */
.bottleneck-stations {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 20px;
}

.bottleneck-station {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--bg-secondary);
    border-radius: 8px;
}

.bottleneck-station input[type="text"] {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--bg-card);
    color: var(--text-primary);
    font-size: 14px;
}

.bottleneck-station input[type="number"] {
    width: 100px;
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--bg-card);
    color: var(--text-primary);
    font-size: 14px;
    text-align: right;
}

.bottleneck-constraint {
    background: linear-gradient(135deg, rgba(231, 76, 60, 0.15), rgba(231, 76, 60, 0.05));
    border: 1px solid #e74c3c;
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
}

.bottleneck-constraint-title {
    font-size: 11px;
    color: #e74c3c;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.bottleneck-constraint-name {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
}

/* Custom Stepper Widget */
.stepper {
    display: inline-flex;
    align-items: stretch;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--bg-secondary);
    overflow: hidden;
    height: 44px;
}

.stepper-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    background: var(--bg-tertiary);
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.15s;
    font-size: 20px;
    font-weight: 400;
    user-select: none;
    padding: 0;
}

.stepper-btn:hover {
    background: var(--accent);
    color: white;
}

.stepper-btn:active {
    transform: scale(0.95);
}

.stepper-btn:first-child {
    border-right: 1px solid var(--border);
}

.stepper-btn:last-child {
    border-left: 1px solid var(--border);
}

.stepper-value {
    min-width: 60px;
    padding: 0 12px;
    text-align: center;
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
    background: var(--bg-secondary);
    border: none;
    outline: none;
    -moz-appearance: textfield;
}

.stepper-value::-webkit-outer-spin-button,
.stepper-value::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.stepper-value:focus {
    background: var(--bg-card);
}

/* Smaller stepper for inline/table use */
.stepper.stepper-sm {
    height: 32px;
}

.stepper.stepper-sm .stepper-btn {
    width: 28px;
    font-size: 16px;
}

.stepper.stepper-sm .stepper-value {
    min-width: 48px;
    padding: 0 8px;
    font-size: 14px;
}

/* Hide default spinners globally for consistency */
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

input[type="number"] {
    -moz-appearance: textfield;
}

/* Print */
@media print {
    .ops-sidebar { display: none; }
    .ops-main { margin: 0; }
    .calc-layout { display: block !important; page-break-inside: avoid; }
}
</style>
{% endblock %}

{% block content %}
<div class="ops-container">
    <!-- Sidebar -->
    <aside class="ops-sidebar">
        <div class="ops-sidebar-header">
            <h1>Operations</h1>
            <p>Lean calculations & planning</p>
        </div>
        <nav class="ops-nav">
            <div class="ops-nav-group">
                <div class="ops-nav-group-title">Crewing</div>
                <div class="ops-nav-item active" onclick="showCalc('takt')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    <span>Takt Time</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('rto')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    <span>RTO (Staffing)</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('yamazumi')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
                    <span>Yamazumi</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('line-sim')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="9" width="4" height="6" rx="1"/><rect x="10" y="9" width="4" height="6" rx="1"/><rect x="18" y="9" width="4" height="6" rx="1"/><path d="M6 12h4M14 12h4"/></svg>
                    <span>Line Simulator</span>
                </div>
                <div class="ops-nav-item coming-soon" onclick="showCalc('cell-sim')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 8h4v8H4zM16 8h4v8h-4z"/><path d="M8 12h8"/><circle cx="12" cy="8" r="2"/><circle cx="12" cy="16" r="2"/></svg>
                    <span>Cell Design</span>
                </div>
            </div>
            <div class="ops-nav-group">
                <div class="ops-nav-group-title">Inventory</div>
                <div class="ops-nav-item" onclick="showCalc('kanban')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                    <span>Kanban Sizing</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('epei')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4"/><path d="M12 18v4"/><path d="M4.93 4.93l2.83 2.83"/><path d="M16.24 16.24l2.83 2.83"/><path d="M2 12h4"/><path d="M18 12h4"/><path d="M4.93 19.07l2.83-2.83"/><path d="M16.24 7.76l2.83-2.83"/></svg>
                    <span>EPEI</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('safety')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                    <span>Safety Stock</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('eoq')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
                    <span>EOQ</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('kanban-sim')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="6" height="4" rx="1"/><rect x="2" y="10" width="6" height="4" rx="1"/><rect x="2" y="16" width="6" height="4" rx="1"/><path d="M8 6h4l2 6-2 6h-4"/><rect x="16" y="8" width="6" height="8" rx="1"/></svg>
                    <span>Kanban Simulator</span>
                </div>
                <div class="ops-nav-item coming-soon" onclick="showCalc('safety-sim')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 20h18"/><path d="M5 20V10l7-7 7 7v10"/><path d="M9 20v-4h6v4"/><path d="M3 20l2-2M21 20l-2-2"/></svg>
                    <span>Safety Stock Sim</span>
                </div>
            </div>
            <div class="ops-nav-group">
                <div class="ops-nav-group-title">Capacity</div>
                <div class="ops-nav-item" onclick="showCalc('oee')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                    <span>OEE</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('bottleneck')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M2 12h20"/><circle cx="12" cy="12" r="4"/></svg>
                    <span>Bottleneck</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('toc-sim')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="10" width="4" height="4" rx="1"/><rect x="7" y="10" width="4" height="4" rx="1"/><rect x="13" y="9" width="4" height="6" rx="1" fill="currentColor" opacity="0.3"/><rect x="19" y="10" width="4" height="4" rx="1"/><path d="M5 12h2M11 12h2M17 12h2"/></svg>
                    <span>TOC / DBR</span>
                </div>
            </div>
            <div class="ops-nav-group">
                <div class="ops-nav-group-title">Flow</div>
                <div class="ops-nav-item" onclick="showCalc('littles')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                    <span>Little's Law</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('pitch')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 3v18"/></svg>
                    <span>Pitch</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('pfa')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/><path d="M7 12h3M14 12h3"/></svg>
                    <span>Product Flow (PFA)</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('wfa')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="3"/><path d="M12 8v8M8 21l4-5 4 5"/></svg>
                    <span>Workflow (WFA)</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('beer-game')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="8" width="4" height="8" rx="1"/><rect x="8" y="8" width="4" height="8" rx="1"/><rect x="14" y="8" width="4" height="8" rx="1"/><rect x="20" y="8" width="2" height="8" rx="0.5"/><path d="M6 10h2M12 10h2M18 10h2"/><path d="M4 8V5M10 8V4M16 8V6"/></svg>
                    <span>Beer Game</span>
                </div>
            </div>
            <div class="ops-nav-group">
                <div class="ops-nav-group-title">Scheduling</div>
                <div class="ops-nav-item" onclick="showCalc('sequencer')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="4" rx="1"/><rect x="3" y="10" width="14" height="4" rx="1"/><rect x="3" y="16" width="10" height="4" rx="1"/></svg>
                    <span>Job Sequencer</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('seq-optimizer')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4"/><circle cx="12" cy="12" r="4"/></svg>
                    <span>Sequence Optimizer</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('capacity-load')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><rect x="7" y="10" width="3" height="8"/><rect x="12" y="6" width="3" height="12"/><rect x="17" y="13" width="3" height="5"/></svg>
                    <span>Capacity Load</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('mixed-model')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="6" width="4" height="4" fill="currentColor"/><rect x="7" y="6" width="4" height="4"/><rect x="12" y="6" width="4" height="4" fill="currentColor"/><rect x="17" y="6" width="4" height="4"/><rect x="2" y="14" width="4" height="4"/><rect x="7" y="14" width="4" height="4" fill="currentColor"/><rect x="12" y="14" width="4" height="4"/><rect x="17" y="14" width="4" height="4" fill="currentColor"/></svg>
                    <span>Mixed-Model</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('due-date-sim')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/><path d="M8 14h.01M12 14h.01M16 14h.01M8 18h.01M12 18h.01"/></svg>
                    <span>Due Date Risk</span>
                </div>
            </div>
            <div class="ops-nav-group">
                <div class="ops-nav-group-title">Queuing Lab</div>
                <div class="ops-nav-item" onclick="showCalc('queue')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/><path d="M7 12h3M14 12h3"/></svg>
                    <span>M/M/c Basic</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('queue-finite')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="8" width="18" height="8" rx="1"/><circle cx="7" cy="12" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="17" cy="12" r="1.5"/></svg>
                    <span>M/M/c/K Finite</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('queue-priority')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                    <span>Priority Queue</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('queue-optimizer')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4"/><circle cx="12" cy="12" r="3"/></svg>
                    <span>Staffing Optimizer</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('queue-sim')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 3v18l7-4 7 4V3z"/></svg>
                    <span>Live Simulator</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('queue-compare')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="8" height="18" rx="1"/><rect x="13" y="3" width="8" height="18" rx="1"/></svg>
                    <span>A/B Compare</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('queue-tandem')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="5" cy="12" r="3"/><circle cx="19" cy="12" r="3"/><path d="M8 12h8"/><path d="M13 9l3 3-3 3"/></svg>
                    <span>Multi-Stage</span>
                </div>
            </div>
            <div class="ops-nav-group">
                <div class="ops-nav-group-title">Quality</div>
                <div class="ops-nav-item" onclick="showCalc('rty')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    <span>RTY</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('dpmo')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                    <span>DPMO / Sigma</span>
                </div>
            </div>
            <div class="ops-nav-group">
                <div class="ops-nav-group-title">Financial</div>
                <div class="ops-nav-item" onclick="showCalc('turns')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                    <span>Inventory Turns</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('coq')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                    <span>Cost of Quality</span>
                </div>
            </div>
            <div class="ops-nav-group">
                <div class="ops-nav-group-title">Changeover</div>
                <div class="ops-nav-item" onclick="showCalc('smed')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6M12 17v6M4.22 4.22l4.24 4.24M15.54 15.54l4.24 4.24M1 12h6M17 12h6M4.22 19.78l4.24-4.24M15.54 8.46l4.24-4.24"/></svg>
                    <span>SMED</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('changeover')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><path d="M10 6h4M10 17h4M6 10v4M17 10v4"/></svg>
                    <span>Changeover Matrix</span>
                </div>
                <div class="ops-nav-item coming-soon" onclick="showCalc('smed-sim')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/><path d="M16 16l2 2"/></svg>
                    <span>SMED Simulator</span>
                </div>
            </div>
            <div class="ops-nav-group">
                <div class="ops-nav-group-title">Risk & Quality</div>
                <div class="ops-nav-item" onclick="showCalc('fmea')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    <span>FMEA / RPN</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('cpk')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M7 12c0-4 2-8 5-8s5 4 5 8-2 8-5 8-5-4-5-8z"/></svg>
                    <span>Cp / Cpk</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('samplesize')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                    <span>Sample Size</span>
                </div>
                <div class="ops-nav-item coming-soon" onclick="showCalc('fmea-sim')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><path d="M12 9v4M12 17h.01"/></svg>
                    <span>FMEA Monte Carlo</span>
                </div>
            </div>
            <div class="ops-nav-group">
                <div class="ops-nav-group-title">Line Performance</div>
                <div class="ops-nav-item" onclick="showCalc('lineeff')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                    <span>Line Efficiency</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('ole')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    <span>OLE</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('cycletime')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    <span>Cycle Time Study</span>
                </div>
            </div>
            <div class="ops-nav-group">
                <div class="ops-nav-group-title">Analysis</div>
                <div class="ops-nav-item" onclick="showCalc('beforeafter')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
                    <span>Before / After</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('heijunka')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M3 15h18M9 3v18M15 3v18"/></svg>
                    <span>Heijunka</span>
                </div>
                <div class="ops-nav-item coming-soon" onclick="showCalc('heijunka-sim')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M3 15h18M9 3v18M15 3v18"/><circle cx="6" cy="6" r="1.5" fill="currentColor"/><circle cx="12" cy="12" r="1.5" fill="currentColor"/><circle cx="18" cy="6" r="1.5" fill="currentColor"/></svg>
                    <span>Heijunka Simulator</span>
                </div>
            </div>
            <div class="ops-nav-group">
                <div class="ops-nav-group-title">3P</div>
                <div class="ops-nav-item" onclick="showCalc('qfd')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21V8l9-5 9 5v13"/><path d="M12 3v5"/><rect x="6" y="10" width="12" height="11"/><path d="M6 14h12M6 18h12M10 10v11M14 10v11"/></svg>
                    <span>House of Quality</span>
                </div>
            </div>
            <div class="ops-nav-group">
                <div class="ops-nav-group-title">Quality & DOE</div>
                <div class="ops-nav-item" onclick="showCalc('desirability')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4"/><circle cx="12" cy="12" r="5"/><path d="M12 9v3l2 1"/></svg>
                    <span>Desirability Optimizer</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('spc-rare')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/><circle cx="15" cy="5" r="2" fill="#e74c3c" stroke="none"/></svg>
                    <span>SPC Rare Events</span>
                </div>
                <div class="ops-nav-item" onclick="showCalc('probit')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 20C2 20 6 20 8 18C10 16 11 14 12 12C13 10 14 6 16 4C18 2 22 2 22 2"/><circle cx="12" cy="12" r="2"/></svg>
                    <span>Dose-Response</span>
                </div>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="ops-main">
        <header class="ops-header" id="calc-header">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px;">
                <div>
                    <h2 id="calc-title">Takt Time</h2>
                    <p id="calc-desc">Calculate the pace of production to meet customer demand</p>
                </div>
                <!-- VSM Import + Scenario Manager -->
                <div style="display: flex; align-items: center; gap: 12px; flex-shrink: 0;">
                <button onclick="openVSMImport()" title="Import data from Value Stream Map" style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 5px; transition: all 0.15s;" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-secondary)'">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
                    VSM
                </button>
                <div id="scenario-manager" style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                    <select id="scenario-select" style="padding: 6px 10px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 12px; min-width: 140px;">
                        <option value="">Current Session</option>
                    </select>
                    <button onclick="saveScenario()" title="Save current state" style="padding: 6px 10px; background: var(--accent); border: none; border-radius: 6px; color: white; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                        Save
                    </button>
                    <button onclick="toggleScenarioMenu()" title="More options" style="padding: 6px 8px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
                    </button>
                </div>
            </div>
            <!-- Scenario dropdown menu -->
            <div id="scenario-menu" style="display: none; position: absolute; right: 24px; top: 70px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 100; min-width: 180px;">
                <div onclick="saveScenarioAs()" style="padding: 10px 14px; cursor: pointer; font-size: 13px; color: var(--text-secondary); border-bottom: 1px solid var(--border);" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='transparent'">
                    Save As New...
                </div>
                <div onclick="renameScenario()" style="padding: 10px 14px; cursor: pointer; font-size: 13px; color: var(--text-secondary); border-bottom: 1px solid var(--border);" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='transparent'">
                    Rename...
                </div>
                <div onclick="deleteScenario()" style="padding: 10px 14px; cursor: pointer; font-size: 13px; color: var(--text-secondary); border-bottom: 1px solid var(--border);" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='transparent'">
                    Delete
                </div>
                <div style="border-top: 1px solid var(--border);"></div>
                <div onclick="exportScenarios()" style="padding: 10px 14px; cursor: pointer; font-size: 13px; color: var(--text-secondary); display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='transparent'">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Export All
                </div>
                <div onclick="document.getElementById('import-file').click()" style="padding: 10px 14px; cursor: pointer; font-size: 13px; color: var(--text-secondary); display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='transparent'">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    Import...
                </div>
                <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importScenarios(event)">
            </div>
            </div>
        </header>

        <!-- VSM Import Modal -->
        <div id="vsm-import-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:1000; display:none; align-items:center; justify-content:center;">
            <div style="background:#121a12; border:1px solid rgba(74,159,110,0.3); border-radius:8px; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.5);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                    <h3 style="margin:0; font-size:16px; color:var(--text-primary);">Import from Value Stream Map</h3>
                    <button onclick="closeVSMImport()" style="background:none; border:none; color:var(--text-dim); cursor:pointer; font-size:20px; padding:4px;">&times;</button>
                </div>
                <div style="margin-bottom:16px;">
                    <label style="font-size:12px; color:var(--text-dim); display:block; margin-bottom:6px;">Select VSM</label>
                    <select id="vsm-import-select" onchange="previewVSMImport()" style="width:100%; padding:10px; background:var(--bg-secondary); border:1px solid var(--border); border-radius:8px; color:var(--text-primary); font-size:13px;">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div id="vsm-import-preview" style="margin-bottom:16px; display:none;">
                    <label style="font-size:12px; color:var(--text-dim); display:block; margin-bottom:6px;">Process Steps</label>
                    <div id="vsm-import-steps" style="background:var(--bg-secondary); border-radius:8px; padding:12px; max-height:200px; overflow-y:auto; font-size:12px;"></div>
                    <div id="vsm-import-meta" style="margin-top:8px; font-size:11px; color:var(--text-dim);"></div>
                </div>
                <div style="display:flex; gap:8px; justify-content:flex-end;">
                    <button onclick="closeVSMImport()" style="padding:8px 16px; background:var(--bg-secondary); border:1px solid var(--border); border-radius:6px; color:var(--text-secondary); cursor:pointer; font-size:13px;">Cancel</button>
                    <button onclick="doVSMImport()" id="vsm-import-btn" style="padding:8px 20px; background:var(--accent); border:none; border-radius:6px; color:white; cursor:pointer; font-size:13px; font-weight:600;">Import into Current Calculator</button>
                </div>
            </div>
        </div>

        <div class="ops-content">
            <!-- Takt Time -->
            <div class="calc-layout active" id="layout-takt">
                <div class="calc-section">
                    <div class="calc-section-title">Inputs</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Available Time</label>
                            <input type="number" id="takt-available" value="480" oninput="calcTakt()">
                            <span class="input-hint">minutes per shift</span>
                        </div>
                        <div class="calc-input">
                            <label>Planned Breaks</label>
                            <input type="number" id="takt-breaks" value="30" oninput="calcTakt()">
                            <span class="input-hint">minutes</span>
                        </div>
                        <div class="calc-input">
                            <label>Customer Demand</label>
                            <input type="number" id="takt-demand" value="100" oninput="calcTakt()">
                            <span class="input-hint">units per shift</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Result</div>
                    <div class="calc-results">
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Takt Time</div>
                            <div class="calc-result-value" id="takt-result">4.50<span class="calc-result-unit">min</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">In Seconds</div>
                            <div class="calc-result-value" id="takt-seconds">270<span class="calc-result-unit">sec</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Net Available</div>
                            <div class="calc-result-value" id="takt-net">450<span class="calc-result-unit">min</span></div>
                        </div>
                    </div>
                    <div class="calc-breakdown">
                        <div class="calc-breakdown-row">
                            <span>Formula</span>
                            <span>Net Available Time ÷ Customer Demand</span>
                        </div>
                        <div class="calc-breakdown-row">
                            <span>Interpretation</span>
                            <span>Must complete 1 unit every <span id="takt-interpret">4.5 min</span> to meet demand</span>
                        </div>
                    </div>

                    <div style="margin-top:12px; text-align:right;">
                        <button onclick="exportTaktToVSM()" style="background:var(--surface-alt); border:1px solid var(--border); color:var(--text-secondary); padding:6px 14px; border-radius:6px; cursor:pointer; font-size:12px; display:inline-flex; align-items:center; gap:6px;" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-secondary)'">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><polyline points="9 15 12 12 15 15"/></svg>
                            Export to VSM
                        </button>
                    </div>

                    <div id="takt-chart" style="height: 280px; margin-top: 16px;"></div>

                    <div class="calc-derivation" id="takt-derivation">
                        <div class="calc-derivation-header" onclick="toggleDerivation('takt-derivation')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                            Show Derivation
                        </div>
                        <div class="calc-derivation-body" id="takt-derivation-body">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
                <div id="takt-next-steps" class="calc-next-steps" style="display:none"></div>
            </div>

            <!-- RTO (Staffing) -->
            <div class="calc-layout" id="layout-rto">
                <button class="calc-dsw-pull" onclick="pullDSWStats('rto')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 11-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
                    Pull Cycle Time Stats from DSW
                </button>

                <div class="calc-section">
                    <div class="calc-section-title">Inputs</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Total Cycle Time</label>
                            <input type="number" id="rto-cycle" value="180" oninput="calcRTO()">
                            <span class="input-hint">seconds (all tasks combined)</span>
                        </div>
                        <div class="calc-input">
                            <label>Takt Time
                                <button class="calc-pull-btn" data-link-from="takt" onclick="SvendOps.pull('takt', 'rto-takt')" title="Pull from Takt Time calculator">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                                    ← Takt
                                </button>
                            </label>
                            <input type="number" id="rto-takt" value="60" oninput="calcRTO()">
                            <span class="input-hint">seconds per unit</span>
                        </div>
                        <div class="calc-input">
                            <label>Cycle Time CoV</label>
                            <input type="number" id="rto-cov" value="10" step="1" oninput="calcRTO()">
                            <span class="input-hint">% coefficient of variation</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Result</div>
                    <div class="calc-results">
                        <div class="calc-result-card">
                            <div class="calc-result-label">RTO (Base)</div>
                            <div class="calc-result-value" id="rto-base">3.00</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">RTO + CoV Margin</div>
                            <div class="calc-result-value" id="rto-margin">3.30</div>
                        </div>
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Staff Recommendation</div>
                            <div class="calc-result-value" id="rto-staff">4<span class="calc-result-unit">people</span></div>
                        </div>
                    </div>
                    <div class="calc-breakdown">
                        <div class="calc-breakdown-row">
                            <span>RTO Formula</span>
                            <span>Cycle Time ÷ Takt Time</span>
                        </div>
                        <div class="calc-breakdown-row">
                            <span>CoV Margin Formula</span>
                            <span>RTO × (1 + CoV)</span>
                        </div>
                        <div class="calc-breakdown-row">
                            <span>Line Efficiency</span>
                            <span id="rto-efficiency">82.5%</span>
                        </div>
                        <div class="calc-breakdown-row">
                            <span>Buffer for Variation</span>
                            <span id="rto-buffer">+0.30 operators</span>
                        </div>
                    </div>
                </div>

                <div class="calc-derivation" id="rto-derivation">
                    <div class="calc-derivation-header" onclick="toggleDerivation('rto-derivation')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        Show Derivation
                    </div>
                    <div class="calc-derivation-body" id="rto-derivation-body">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Yamazumi -->
            <div class="calc-layout" id="layout-yamazumi">
                <div class="calc-section">
                    <div class="calc-section-title">Takt Reference</div>
                    <div class="calc-inputs" style="max-width: 300px;">
                        <div class="calc-input">
                            <label>Takt Time
                                <button class="calc-pull-btn" data-link-from="takt" onclick="SvendOps.pull('takt', 'yama-takt'); renderYamazumi();" title="Pull from Takt Time calculator">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                                    ← Takt
                                </button>
                            </label>
                            <input type="number" id="yama-takt" value="60" oninput="renderYamazumi()">
                            <span class="input-hint">seconds per unit</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Stations / Operators</div>
                    <div class="yamazumi-stations" id="yamazumi-stations"></div>
                    <div class="yamazumi-add" onclick="addYamazumiStation()">+ Add Station</div>
                </div>

                <div class="calc-chart">
                    <div class="calc-chart-title" style="display:flex; align-items:center; justify-content:space-between;">
                        <span>Line Balance</span>
                        <label id="yama-wc-toggle" style="display:none; font-size:11px; font-weight:400; color:var(--text-secondary); cursor:pointer; user-select:none; align-items:center; gap:6px;">
                            <span style="position:relative; display:inline-block; width:32px; height:18px; vertical-align:middle;">
                                <input type="checkbox" id="yama-combine-wc" onchange="toggleYamazumiWCMode()" style="opacity:0; width:0; height:0; position:absolute;">
                                <span id="yama-toggle-track" style="position:absolute; top:0; left:0; right:0; bottom:0; background:var(--border); border-radius:9px; transition:background 0.2s;"></span>
                                <span id="yama-toggle-knob" style="position:absolute; top:2px; left:2px; width:14px; height:14px; background:white; border-radius:50%; transition:transform 0.2s;"></span>
                            </span>
                            Combine work centers
                        </label>
                    </div>
                    <div id="yamazumi-chart" style="height: 350px;"></div>
                </div>

                <div class="calc-results" style="margin-top: 24px;">
                    <div class="calc-result-card">
                        <div class="calc-result-label">Total Cycle Time</div>
                        <div class="calc-result-value" id="yama-total">180<span class="calc-result-unit">sec</span></div>
                    </div>
                    <div class="calc-result-card">
                        <div class="calc-result-label">RTO</div>
                        <div class="calc-result-value" id="yama-rto">3.00</div>
                    </div>
                    <div class="calc-result-card primary">
                        <div class="calc-result-label">Line Efficiency</div>
                        <div class="calc-result-value" id="yama-efficiency">100<span class="calc-result-unit">%</span></div>
                    </div>
                    <div class="calc-result-card">
                        <div class="calc-result-label">Free Capacity</div>
                        <div class="calc-result-value" id="yama-free">30<span class="calc-result-unit">sec</span></div>
                    </div>
                    <div class="calc-result-card">
                        <div class="calc-result-label">Avg Utilization</div>
                        <div class="calc-result-value" id="yama-util">83.3<span class="calc-result-unit">%</span></div>
                    </div>
                </div>
            </div>

            <!-- Line Simulator -->
            <div class="calc-layout" id="layout-line-sim">
                <div class="calc-section">
                    <div class="calc-section-title">Line Configuration</div>
                    <div class="calc-inputs" style="max-width: 600px;">
                        <div class="calc-input">
                            <label>Takt Time
                                <button class="calc-pull-btn" data-link-from="takt" onclick="SvendOps.pull('takt', 'ls-takt'); updateLineSimParams();" title="Pull from Takt Time calculator">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                                    ← Takt
                                </button>
                            </label>
                            <input type="number" id="ls-takt" value="60" oninput="updateLineSimParams()">
                            <span class="input-hint">seconds per unit (customer demand)</span>
                        </div>
                        <div class="calc-input">
                            <label>Cycle Time Variability (CoV)</label>
                            <input type="range" id="ls-cov" min="0" max="50" value="15" oninput="updateLineSimParams()">
                            <span class="input-hint" id="ls-cov-label">15% — Typical for manual work</span>
                        </div>
                        <div class="calc-input">
                            <label>Max WIP Buffer per Station</label>
                            <input type="number" id="ls-max-wip" value="5" min="1" max="20" oninput="updateLineSimParams()">
                            <span class="input-hint">units (blocking if full)</span>
                        </div>
                        <div class="calc-input">
                            <label>Flow Mode</label>
                            <select id="ls-flow-mode" onchange="updateLineSimParams()" style="padding: 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                <option value="one-piece">One-Piece Flow</option>
                                <option value="batch">Batch Production</option>
                            </select>
                            <span class="input-hint" id="ls-flow-hint">Units move individually through the line</span>
                        </div>
                        <div class="calc-input" id="ls-batch-size-container" style="display: none;">
                            <label>Batch Size</label>
                            <input type="number" id="ls-batch-size" value="5" min="2" max="20" oninput="updateLineSimParams()">
                            <span class="input-hint">units per batch (watch the WIP explode)</span>
                        </div>
                        <div class="calc-input">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="ls-breakdowns" style="width: 16px; height: 16px;">
                                Random Breakdowns
                            </label>
                            <span class="input-hint" id="ls-breakdown-hint">Inject random equipment failures</span>
                        </div>
                        <div class="calc-input">
                            <label>Simulation Mode</label>
                            <select id="ls-sim-mode" onchange="updateSimMode()" style="padding: 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                <option value="infinite">Infinite Supply</option>
                                <option value="orders">Order-Driven (Schedule)</option>
                            </select>
                            <span class="input-hint" id="ls-sim-mode-hint">Continuous production vs customer orders</span>
                        </div>
                    </div>
                </div>

                <!-- Order-Driven Mode Panel (hidden by default) -->
                <div id="ls-order-panel" class="calc-section" style="display: none; background: linear-gradient(135deg, rgba(74, 159, 110, 0.1) 0%, rgba(52, 152, 219, 0.1) 100%); border: 1px solid var(--accent); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                    <div class="calc-section-title" style="color: var(--accent);">📦 Order-Driven Simulation</div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 20px;">
                        <!-- Product Types -->
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 12px; font-size: 13px;">Product Types</div>
                            <div id="ls-products" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px;">
                                <!-- Populated by JS -->
                            </div>
                            <button onclick="addProduct()" style="padding: 6px 12px; background: var(--bg-secondary); border: 1px dashed var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer; font-size: 12px;">
                                + Add Product Type
                            </button>
                        </div>

                        <!-- Changeover Settings -->
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 12px; font-size: 13px;">Changeover Settings</div>
                            <div class="calc-input" style="margin-bottom: 12px;">
                                <label>Changeover Time (between products)
                                    <button class="calc-pull-btn" data-link-from="changeoverInternal" onclick="SvendOps.pull('changeoverInternal', 'ls-changeover-time')" title="Pull from SMED calculator">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                                        ← SMED
                                    </button>
                                </label>
                                <input type="number" id="ls-changeover-time" value="120" min="0" style="padding: 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); width: 100px;">
                                <span class="input-hint">seconds (applies to all stations)</span>
                            </div>
                            <div style="font-size: 12px; color: var(--text-dim);">
                                <em>💡 Tip: Use SMED calculator to reduce this</em>
                            </div>
                        </div>
                    </div>

                    <!-- Order Queue -->
                    <div style="margin-top: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="font-weight: 600; color: var(--text-primary); font-size: 13px;">Order Queue</div>
                            <button onclick="addOrder()" style="padding: 4px 10px; background: var(--accent); border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 11px;">
                                + Add Order
                            </button>
                            <button onclick="generateSampleOrders()" style="padding: 4px 10px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-secondary); cursor: pointer; font-size: 11px;">
                                Generate Sample
                            </button>
                        </div>
                        <div id="ls-orders" style="max-height: 200px; overflow-y: auto; background: var(--bg-card); border-radius: 8px; padding: 12px;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                <thead>
                                    <tr style="border-bottom: 1px solid var(--border); color: var(--text-dim);">
                                        <th style="padding: 6px; text-align: left;">Order</th>
                                        <th style="padding: 6px; text-align: left;">Product</th>
                                        <th style="padding: 6px; text-align: right;">Qty</th>
                                        <th style="padding: 6px; text-align: right;">Due (sim sec)</th>
                                        <th style="padding: 6px; text-align: center;">Status</th>
                                        <th style="padding: 6px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="ls-orders-body">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <div class="calc-section-title" style="margin: 0;">Stations</div>
                        <button onclick="importFromYamazumi()" style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 6px;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            Import from Yamazumi
                        </button>
                    </div>
                    <div id="ls-stations" style="display: flex; flex-direction: column; gap: 8px;">
                        <!-- Populated by JS -->
                    </div>
                    <button onclick="addLineStation()" style="margin-top: 12px; padding: 8px 16px; background: var(--bg-secondary); border: 1px dashed var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer;">
                        + Add Station
                    </button>
                </div>

                <div class="calc-section">
                    <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 16px;">
                        <button id="ls-start" onclick="startLineSim()" style="padding: 12px 24px; background: var(--accent); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer;">
                            ▶ Start Line
                        </button>
                        <button onclick="resetLineSim()" style="padding: 12px 24px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer;">
                            Reset
                        </button>
                        <button onclick="toggleLineCompare()" id="ls-compare-btn" style="padding: 12px 24px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer;">
                            ⚖ A/B Compare
                        </button>
                        <div style="flex: 1;"></div>
                        <div style="display: flex; align-items: center; gap: 8px; color: var(--text-dim); font-size: 12px;">
                            <span>Speed:</span>
                            <input type="range" id="ls-speed" min="1" max="10" value="5" style="width: 80px;">
                        </div>
                    </div>
                </div>

                <!-- A/B Compare Panel (hidden by default) -->
                <div id="ls-compare-panel" class="calc-section" style="display: none; background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                    <div class="calc-section-title">A/B Scenario Comparison</div>

                    <!-- Simulation Settings -->
                    <div style="display: flex; gap: 20px; margin-bottom: 20px; padding: 12px; background: var(--bg-card); border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 12px; color: var(--text-dim);">Sim Duration:</label>
                            <select id="ls-compare-duration" style="padding: 4px 8px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); font-size: 12px;">
                                <option value="60">60 sec (quick)</option>
                                <option value="300" selected>5 min (standard)</option>
                                <option value="600">10 min (thorough)</option>
                                <option value="1800">30 min (steady-state)</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 12px; color: var(--text-dim);">Warm-up:</label>
                            <select id="ls-compare-warmup" style="padding: 4px 8px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); font-size: 12px;">
                                <option value="0">None (cold start)</option>
                                <option value="60" selected>60 sec (wet the line)</option>
                                <option value="120">2 min (steady buffers)</option>
                                <option value="300">5 min (full steady-state)</option>
                            </select>
                        </div>
                        <div style="flex: 1; font-size: 11px; color: var(--text-dim); display: flex; align-items: center;">
                            💡 Warm-up runs before measuring — gives B&Q a fair shot
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        <!-- Scenario A -->
                        <div>
                            <div style="font-weight: 600; color: #e74c3c; margin-bottom: 12px;">A: Current State</div>
                            <div style="font-size: 12px; color: var(--text-dim); margin-bottom: 8px;">Uses current station configuration</div>
                            <div id="ls-compare-a-stats" style="font-size: 13px;"></div>
                        </div>

                        <!-- Scenario B - Flexible Adjustments -->
                        <div>
                            <div style="font-weight: 600; color: #4a9f6e; margin-bottom: 12px;">B: Proposed Changes</div>
                            <div style="display: flex; flex-direction: column; gap: 8px; font-size: 12px;">
                                <!-- Quick presets -->
                                <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px;">
                                    <button onclick="applyComparePreset('reduce-bottleneck')" class="compare-preset-btn" style="padding: 4px 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: var(--text-secondary); cursor: pointer; font-size: 11px;">-10% bottleneck</button>
                                    <button onclick="applyComparePreset('add-buffer')" class="compare-preset-btn" style="padding: 4px 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: var(--text-secondary); cursor: pointer; font-size: 11px;">2x buffer</button>
                                    <button onclick="applyComparePreset('one-piece')" class="compare-preset-btn" style="padding: 4px 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: var(--text-secondary); cursor: pointer; font-size: 11px;">one-piece</button>
                                    <button onclick="applyComparePreset('reduce-cov')" class="compare-preset-btn" style="padding: 4px 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: var(--text-secondary); cursor: pointer; font-size: 11px;">½ variability</button>
                                    <button onclick="resetCompareB()" style="padding: 4px 8px; background: transparent; border: 1px solid var(--border); border-radius: 4px; color: var(--text-dim); cursor: pointer; font-size: 11px;">reset</button>
                                </div>

                                <!-- Custom adjustments -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                    <div>
                                        <label style="color: var(--text-dim);">Buffer capacity:</label>
                                        <input type="number" id="ls-compare-b-buffer" value="" placeholder="(same)" style="width: 100%; padding: 4px 6px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); font-size: 12px;">
                                    </div>
                                    <div>
                                        <label style="color: var(--text-dim);">CoV %:</label>
                                        <input type="number" id="ls-compare-b-cov" value="" placeholder="(same)" style="width: 100%; padding: 4px 6px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); font-size: 12px;">
                                    </div>
                                    <div>
                                        <label style="color: var(--text-dim);">Batch size:</label>
                                        <input type="number" id="ls-compare-b-batch" value="" placeholder="(same)" style="width: 100%; padding: 4px 6px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); font-size: 12px;">
                                    </div>
                                    <div>
                                        <label style="color: var(--text-dim);">Bottleneck CT adj:</label>
                                        <input type="number" id="ls-compare-b-ct-adj" value="" placeholder="% (e.g. -10)" style="width: 100%; padding: 4px 6px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); font-size: 12px;">
                                    </div>
                                </div>

                                <!-- Station-specific CT overrides -->
                                <div style="margin-top: 8px;">
                                    <label style="color: var(--text-dim);">Station CT overrides (optional):</label>
                                    <div id="ls-compare-b-stations" style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px;">
                                        <!-- Populated by JS -->
                                    </div>
                                </div>
                            </div>
                            <div id="ls-compare-b-stats" style="font-size: 13px; margin-top: 12px;"></div>
                        </div>
                    </div>

                    <div style="margin-top: 16px; display: flex; gap: 12px; align-items: center;">
                        <button onclick="runLineCompare()" style="padding: 10px 20px; background: var(--accent); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer;">
                            Run Comparison
                        </button>
                        <div id="ls-compare-status" style="font-size: 12px; color: var(--text-dim);"></div>
                        <div id="ls-compare-verdict" style="flex: 1; display: flex; align-items: center; padding: 0 16px; font-size: 14px;"></div>
                    </div>
                </div>

                <!-- Scenarios Panel -->
                <div class="calc-section" style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                        <span style="font-size: 12px; color: var(--text-dim); font-weight: 600;">SCENARIOS:</span>
                        <select id="ls-scenarios" style="padding: 6px 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 12px; min-width: 150px;">
                            <option value="">— Select saved scenario —</option>
                        </select>
                        <button onclick="loadLineScenario()" style="padding: 6px 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer; font-size: 12px;">
                            Load
                        </button>
                        <input type="text" id="ls-scenario-name" placeholder="Scenario name..." style="padding: 6px 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 12px; width: 140px;">
                        <button onclick="saveLineScenario()" style="padding: 6px 12px; background: var(--accent); border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 12px;">
                            Save Current
                        </button>
                        <button onclick="deleteLineScenario()" style="padding: 6px 12px; background: transparent; border: 1px solid var(--border); border-radius: 6px; color: var(--text-dim); cursor: pointer; font-size: 12px;">
                            Delete
                        </button>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Live Line Visualization</div>
                    <div id="ls-visual" style="background: var(--bg-secondary); border-radius: 12px; padding: 24px; overflow-x: auto;">
                        <div id="ls-line" style="display: flex; align-items: center; gap: 8px; min-width: max-content;">
                            <!-- Populated by JS: stations with WIP buffers between -->
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Live Metrics</div>
                    <div class="calc-results">
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Units Completed</div>
                            <div class="calc-result-value" id="ls-completed">0</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Throughput</div>
                            <div class="calc-result-value" id="ls-throughput">0<span class="calc-result-unit">/hr</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Total WIP</div>
                            <div class="calc-result-value" id="ls-total-wip">0</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Line Efficiency</div>
                            <div class="calc-result-value" id="ls-efficiency">0<span class="calc-result-unit">%</span></div>
                        </div>
                    </div>
                </div>

                <!-- Order Delivery Metrics (shown in order mode) -->
                <div id="ls-delivery-section" class="calc-section" style="display: none;">
                    <div class="calc-section-title" style="color: var(--accent);">📦 Order Delivery Performance</div>
                    <div class="calc-results">
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">On-Time Delivery</div>
                            <div class="calc-result-value" id="ls-otd">—<span class="calc-result-unit">%</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Orders Complete</div>
                            <div class="calc-result-value" id="ls-orders-complete">0<span class="calc-result-unit">/ 0</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Avg Lead Time</div>
                            <div class="calc-result-value" id="ls-avg-lead">—<span class="calc-result-unit">sec</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Changeover Loss</div>
                            <div class="calc-result-value" id="ls-changeover-loss">0<span class="calc-result-unit">sec</span></div>
                        </div>
                    </div>

                    <!-- Late Order Analysis -->
                    <div id="ls-late-analysis" style="margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 8px; display: none;">
                        <div style="font-weight: 600; color: #e74c3c; margin-bottom: 8px;">⚠ Late Orders — Root Cause Analysis</div>
                        <div id="ls-late-orders" style="font-size: 13px; color: var(--text-secondary);">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Station Performance</div>
                    <div id="ls-station-stats" style="overflow-x: auto;">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div class="calc-chart">
                    <div class="calc-chart-title">WIP & Throughput Over Time</div>
                    <div id="ls-chart" style="height: 280px;"></div>
                </div>

                <div class="calc-section" style="margin-top: 20px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <div class="calc-section-title" style="margin: 0;">Bottleneck Analysis</div>
                        <button onclick="exportLineReport()" style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 6px;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                            Export Report
                        </button>
                    </div>
                    <div id="ls-bottleneck" style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; font-size: 13px; color: var(--text-secondary);">
                        <em>Start simulation to identify bottleneck...</em>
                    </div>
                </div>
            </div>

            <!-- Kanban -->
            <div class="calc-layout" id="layout-kanban">
                <div class="calc-section">
                    <div class="calc-section-title">Inputs</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Daily Demand</label>
                            <input type="number" id="kanban-demand" value="100" oninput="calcKanban()">
                            <span class="input-hint">units per day</span>
                        </div>
                        <div class="calc-input">
                            <label>Lead Time</label>
                            <input type="number" id="kanban-lead" value="2" step="0.1" oninput="calcKanban()">
                            <span class="input-hint">days</span>
                        </div>
                        <div class="calc-input">
                            <label>Safety Factor</label>
                            <input type="number" id="kanban-safety" value="20" oninput="calcKanban()">
                            <span class="input-hint">% buffer</span>
                        </div>
                        <div class="calc-input">
                            <label>Container Size
                                <button class="calc-pull-btn" data-link-from="eoq" onclick="SvendOps.pull('eoq', 'kanban-container')" title="Pull from EOQ calculator">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                                    ← EOQ
                                </button>
                            </label>
                            <input type="number" id="kanban-container" value="25" oninput="calcKanban()">
                            <span class="input-hint">units per container</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Result</div>
                    <div class="calc-results">
                        <div class="calc-result-card">
                            <div class="calc-result-label">Base Stock</div>
                            <div class="calc-result-value" id="kanban-base">200<span class="calc-result-unit">units</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Safety Stock</div>
                            <div class="calc-result-value" id="kanban-ss">40<span class="calc-result-unit">units</span></div>
                        </div>
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Kanbans Required</div>
                            <div class="calc-result-value" id="kanban-cards">10<span class="calc-result-unit">cards</span></div>
                        </div>
                    </div>
                    <div class="calc-breakdown">
                        <div class="calc-breakdown-row">
                            <span>Formula</span>
                            <span>(D × LT × (1 + SF)) ÷ Container</span>
                        </div>
                        <div class="calc-breakdown-row">
                            <span>Total Inventory</span>
                            <span id="kanban-total">240 units</span>
                        </div>
                    </div>
                </div>

                <div id="kanban-visual" style="padding: 20px 0; display: none;"></div>

                <button class="calc-monte-toggle" onclick="toggleKanbanMonteCarlo(this)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
                    Run Monte Carlo Simulation
                </button>
                <div class="calc-monte-results" id="kanban-monte-results">
                    <div class="calc-monte-summary">
                        <div class="calc-monte-stat">
                            <div class="calc-monte-stat-label">Mean Cards</div>
                            <div class="calc-monte-stat-value" id="kanban-monte-mean">-</div>
                        </div>
                        <div class="calc-monte-stat">
                            <div class="calc-monte-stat-label">5th %ile</div>
                            <div class="calc-monte-stat-value" id="kanban-monte-p5">-</div>
                        </div>
                        <div class="calc-monte-stat">
                            <div class="calc-monte-stat-label">95th %ile</div>
                            <div class="calc-monte-stat-value" id="kanban-monte-p95">-</div>
                        </div>
                        <div class="calc-monte-stat">
                            <div class="calc-monte-stat-label">Std Dev</div>
                            <div class="calc-monte-stat-value" id="kanban-monte-std">-</div>
                        </div>
                    </div>
                    <div id="kanban-monte-chart" style="height: 250px;"></div>
                    <p style="font-size: 11px; color: var(--text-dim); margin-top: 12px; text-align: center;">
                        Varies demand ±10%, lead time ±15%, safety factor ±10%
                    </p>
                </div>

                <div class="calc-derivation" id="kanban-derivation">
                    <div class="calc-derivation-header" onclick="toggleDerivation('kanban-derivation')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        Show Derivation
                    </div>
                    <div class="calc-derivation-body" id="kanban-derivation-body">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- EPEI -->
            <div class="calc-layout" id="layout-epei">
                <div class="calc-section">
                    <div class="calc-section-title">Inputs</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Available Production Time</label>
                            <input type="number" id="epei-available" value="8" oninput="calcEPEI()">
                            <span class="input-hint">hours per day</span>
                        </div>
                        <div class="calc-input">
                            <label>Number of Part Numbers</label>
                            <input type="number" id="epei-parts" value="5" oninput="calcEPEI()">
                            <span class="input-hint">SKUs in rotation</span>
                        </div>
                        <div class="calc-input">
                            <label>Changeover Time
                                <button class="calc-pull-btn" data-link-from="changeoverInternal"
                                        onclick="SvendOps.pull('changeoverInternal', 'epei-changeover')"
                                        title="Pull from SMED calculator">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                                    ← SMED
                                </button>
                            </label>
                            <input type="number" id="epei-changeover" value="15" oninput="calcEPEI()">
                            <span class="input-hint">minutes per changeover</span>
                        </div>
                        <div class="calc-input">
                            <label>Target C/O Allowance</label>
                            <input type="number" id="epei-target" value="10" oninput="calcEPEI()">
                            <span class="input-hint">% of available time</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Result</div>
                    <div class="calc-results">
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">EPEI</div>
                            <div class="calc-result-value" id="epei-result">1.6<span class="calc-result-unit">days</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Total C/O per Cycle</div>
                            <div class="calc-result-value" id="epei-total">75<span class="calc-result-unit">min</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">C/O Budget per Day</div>
                            <div class="calc-result-value" id="epei-budget">48<span class="calc-result-unit">min</span></div>
                        </div>
                    </div>
                    <div class="calc-breakdown">
                        <div class="calc-breakdown-row">
                            <span>Interpretation</span>
                            <span>Run every part every <span id="epei-interpret">1.6</span> days</span>
                        </div>
                    </div>
                </div>

                <div class="calc-derivation" id="epei-derivation">
                    <div class="calc-derivation-header" onclick="toggleDerivation('epei-derivation')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        Show Derivation
                    </div>
                    <div class="calc-derivation-body" id="epei-derivation-body">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div id="epei-next-steps" class="calc-next-steps" style="display:none"></div>
            </div>

            <!-- Safety Stock -->
            <div class="calc-layout" id="layout-safety">
                <button class="calc-dsw-pull" onclick="pullDSWStats('safety')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 11-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
                    Pull Demand Statistics from DSW
                </button>

                <div class="calc-section">
                    <div class="calc-section-title">Demand Inputs</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Average Daily Demand</label>
                            <input type="number" id="safety-demand" value="100" oninput="calcSafety()">
                            <span class="input-hint">units</span>
                        </div>
                        <div class="calc-input">
                            <label>Demand Std Dev</label>
                            <input type="number" id="safety-demand-std" value="15" oninput="calcSafety()">
                            <span class="input-hint">daily variation</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Lead Time Inputs</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Lead Time</label>
                            <input type="number" id="safety-lead" value="5" step="0.1" oninput="calcSafety()">
                            <span class="input-hint">days</span>
                        </div>
                        <div class="calc-input">
                            <label>Lead Time Std Dev</label>
                            <input type="number" id="safety-lead-std" value="1" step="0.1" oninput="calcSafety()">
                            <span class="input-hint">days variation</span>
                        </div>
                        <div class="calc-input">
                            <label>Service Level</label>
                            <select id="safety-service" onchange="calcSafety()">
                                <option value="1.28">90%</option>
                                <option value="1.65" selected>95%</option>
                                <option value="1.96">97.5%</option>
                                <option value="2.33">99%</option>
                                <option value="2.58">99.5%</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Result</div>
                    <div class="calc-results">
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Safety Stock</div>
                            <div class="calc-result-value" id="safety-result">172<span class="calc-result-unit">units</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Reorder Point</div>
                            <div class="calc-result-value" id="safety-rop">672<span class="calc-result-unit">units</span></div>
                        </div>
                    </div>
                    <div class="calc-breakdown">
                        <div class="calc-breakdown-row">
                            <span>Z-score</span>
                            <span id="safety-z">1.65</span>
                        </div>
                        <div class="calc-breakdown-row">
                            <span>Combined Std Dev</span>
                            <span id="safety-combined">104 units</span>
                        </div>
                        <div class="calc-breakdown-row">
                            <span>Formula</span>
                            <span>Z × √(LT×σd² + d²×σLT²)</span>
                        </div>
                    </div>
                </div>

                <div class="calc-chart">
                    <div class="calc-chart-title">Demand Distribution & Service Level</div>
                    <div id="safety-chart" style="height: 350px;"></div>
                </div>

                <button class="calc-monte-toggle" onclick="toggleSafetyMonteCarlo(this)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
                    Run Monte Carlo Simulation
                </button>
                <div class="calc-monte-results" id="safety-monte-results">
                    <div class="calc-monte-summary">
                        <div class="calc-monte-stat">
                            <div class="calc-monte-stat-label">Mean SS</div>
                            <div class="calc-monte-stat-value" id="safety-monte-mean">-</div>
                        </div>
                        <div class="calc-monte-stat">
                            <div class="calc-monte-stat-label">5th %ile</div>
                            <div class="calc-monte-stat-value" id="safety-monte-p5">-</div>
                        </div>
                        <div class="calc-monte-stat">
                            <div class="calc-monte-stat-label">95th %ile</div>
                            <div class="calc-monte-stat-value" id="safety-monte-p95">-</div>
                        </div>
                        <div class="calc-monte-stat">
                            <div class="calc-monte-stat-label">Std Dev</div>
                            <div class="calc-monte-stat-value" id="safety-monte-std">-</div>
                        </div>
                    </div>
                    <div id="safety-monte-chart" style="height: 250px;"></div>
                    <p style="font-size: 11px; color: var(--text-dim); margin-top: 12px; text-align: center;">
                        Varies demand ±10%, demand σ ±15%, lead time ±10%, lead time σ ±15%
                    </p>
                </div>

                <div class="calc-derivation" id="safety-derivation">
                    <div class="calc-derivation-header" onclick="toggleDerivation('safety-derivation')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        Show Derivation
                    </div>
                    <div class="calc-derivation-body" id="safety-derivation-body">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div id="safety-next-steps" class="calc-next-steps" style="display:none"></div>
            </div>

            <!-- EOQ -->
            <div class="calc-layout" id="layout-eoq">
                <div class="calc-section">
                    <div class="calc-section-title">Inputs</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Annual Demand</label>
                            <input type="number" id="eoq-demand" value="10000" oninput="calcEOQ()">
                            <span class="input-hint">units per year</span>
                        </div>
                        <div class="calc-input">
                            <label>Order Cost</label>
                            <input type="number" id="eoq-order" value="50" oninput="calcEOQ()">
                            <span class="input-hint">$ per order</span>
                        </div>
                        <div class="calc-input">
                            <label>Unit Cost</label>
                            <input type="number" id="eoq-unit" value="10" oninput="calcEOQ()">
                            <span class="input-hint">$ per unit</span>
                        </div>
                        <div class="calc-input">
                            <label>Holding Cost</label>
                            <input type="number" id="eoq-holding" value="20" oninput="calcEOQ()">
                            <span class="input-hint">% of unit cost/year</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Result</div>
                    <div class="calc-results">
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">EOQ</div>
                            <div class="calc-result-value" id="eoq-result">707<span class="calc-result-unit">units</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Orders per Year</div>
                            <div class="calc-result-value" id="eoq-orders">14</div>
                        </div>
                    </div>
                    <div class="calc-breakdown">
                        <div class="calc-breakdown-row">
                            <span>Annual Order Cost</span>
                            <span id="eoq-order-cost">$707</span>
                        </div>
                        <div class="calc-breakdown-row">
                            <span>Annual Holding Cost</span>
                            <span id="eoq-hold-cost">$707</span>
                        </div>
                        <div class="calc-breakdown-row">
                            <span>Total Inventory Cost</span>
                            <span id="eoq-total">$1,414</span>
                        </div>
                        <div class="calc-breakdown-row">
                            <span>Formula</span>
                            <span>√(2DS / H)</span>
                        </div>
                    </div>
                </div>

                <div class="calc-chart">
                    <div class="calc-chart-title">Cost Optimization Curve</div>
                    <div id="eoq-chart" style="height: 350px;"></div>
                </div>

                <div class="calc-section" style="margin-top: 24px;">
                    <button class="calc-monte-toggle" onclick="toggleEOQMonteCarlo(this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
                        Run Monte Carlo Simulation
                    </button>
                    <div class="calc-monte-results" id="eoq-monte-results">
                        <div class="calc-monte-summary">
                            <div class="calc-monte-stat">
                                <div class="calc-monte-stat-label">Mean EOQ</div>
                                <div class="calc-monte-stat-value" id="eoq-monte-mean">-</div>
                            </div>
                            <div class="calc-monte-stat">
                                <div class="calc-monte-stat-label">5th %ile</div>
                                <div class="calc-monte-stat-value" id="eoq-monte-p5">-</div>
                            </div>
                            <div class="calc-monte-stat">
                                <div class="calc-monte-stat-label">95th %ile</div>
                                <div class="calc-monte-stat-value" id="eoq-monte-p95">-</div>
                            </div>
                            <div class="calc-monte-stat">
                                <div class="calc-monte-stat-label">Std Dev</div>
                                <div class="calc-monte-stat-value" id="eoq-monte-std">-</div>
                            </div>
                        </div>
                        <div id="eoq-monte-chart" style="height: 250px;"></div>
                        <p style="font-size: 11px; color: var(--text-dim); margin-top: 12px; text-align: center;">
                            Assumes ±10% variability in demand, order cost, and holding cost
                        </p>
                    </div>
                </div>

                <div class="calc-derivation" id="eoq-derivation">
                    <div class="calc-derivation-header" onclick="toggleDerivation('eoq-derivation')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        Show Derivation
                    </div>
                    <div class="calc-derivation-body" id="eoq-derivation-body">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- OEE -->
            <div class="calc-layout" id="layout-oee">
                <div class="calc-section">
                    <div class="calc-section-title">Inputs</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Planned Production Time</label>
                            <input type="number" id="oee-planned" value="480" oninput="calcOEE()">
                            <span class="input-hint">minutes</span>
                        </div>
                        <div class="calc-input">
                            <label>Downtime</label>
                            <input type="number" id="oee-downtime" value="60" oninput="calcOEE()">
                            <span class="input-hint">minutes (unplanned stops)</span>
                        </div>
                        <div class="calc-input">
                            <label>Ideal Cycle Time
                                <button class="calc-pull-btn" data-link-from="bottleneckCT" onclick="SvendOps.pull('bottleneckCT', 'oee-ideal')" title="Pull from Bottleneck calculator">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                                    ← Bottleneck
                                </button>
                            </label>
                            <input type="number" id="oee-ideal" value="30" oninput="calcOEE()">
                            <span class="input-hint">seconds per unit</span>
                        </div>
                        <div class="calc-input">
                            <label>Total Parts Produced</label>
                            <input type="number" id="oee-produced" value="700" oninput="calcOEE()">
                            <span class="input-hint">units</span>
                        </div>
                        <div class="calc-input">
                            <label>Defective Parts</label>
                            <input type="number" id="oee-defects" value="35" oninput="calcOEE()">
                            <span class="input-hint">units</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">OEE Score</div>
                    <div class="oee-display" style="margin-bottom: 0;">
                        <div class="oee-value" id="oee-result">72.9%</div>
                        <div class="oee-label">Overall Equipment Effectiveness</div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">The Three Pillars</div>
                    <div class="oee-factors">
                        <div class="oee-factor">
                            <div class="oee-factor-value" id="oee-availability">87.5%</div>
                            <div class="oee-factor-label">Availability</div>
                            <div style="font-size:11px; color:var(--text-dim); margin-top:8px; line-height:1.4;">
                                Planned time actually running. Losses: breakdowns, changeovers, material shortages.
                            </div>
                        </div>
                        <div class="oee-factor">
                            <div class="oee-factor-value" id="oee-performance">83.3%</div>
                            <div class="oee-factor-label">Performance</div>
                            <div style="font-size:11px; color:var(--text-dim); margin-top:8px; line-height:1.4;">
                                Actual speed vs. ideal speed. Losses: slow cycles, minor stops, jams.
                            </div>
                        </div>
                        <div class="oee-factor">
                            <div class="oee-factor-value" id="oee-quality">95.0%</div>
                            <div class="oee-factor-label">Quality</div>
                            <div style="font-size:11px; color:var(--text-dim); margin-top:8px; line-height:1.4;">
                                Good parts vs. total parts. Losses: scrap, rework, startup rejects.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Loss Breakdown</div>
                    <div style="max-width: 420px; margin: 0 auto;">
                        <div id="oee-chart" style="height: 320px;"></div>
                    </div>
                    <div class="calc-breakdown" style="margin-top: 20px;">
                        <div class="calc-breakdown-row">
                            <span>Run Time</span>
                            <span id="oee-runtime">420 min</span>
                        </div>
                        <div class="calc-breakdown-row">
                            <span>Good Parts</span>
                            <span id="oee-good">665 units</span>
                        </div>
                        <div class="calc-breakdown-row">
                            <span>World Class Benchmark</span>
                            <span>85%</span>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:20px;">
                        <div style="padding:16px; background:var(--bg-secondary); border-radius:10px; border-left: 3px solid var(--accent-primary);">
                            <div style="font-size:12px; font-weight:600; color:var(--text-primary); margin-bottom:8px;">Reading OEE</div>
                            <div style="font-size:11px; color:var(--text-dim); line-height:1.5;">
                                <b>85%+</b> &mdash; World class. Very few unplanned losses.<br>
                                <b>65&ndash;85%</b> &mdash; Typical. Room for targeted improvement.<br>
                                <b>&lt;65%</b> &mdash; Significant losses. Identify the biggest pillar gap first.
                            </div>
                        </div>
                        <div style="padding:16px; background:var(--bg-secondary); border-radius:10px; border-left: 3px solid #f39c12;">
                            <div style="font-size:12px; font-weight:600; color:var(--text-primary); margin-bottom:8px;">The OEE Trap</div>
                            <div style="font-size:11px; color:var(--text-dim); line-height:1.5;">
                                OEE is a <em>diagnostic</em>, not a target. Chasing a single number invites gaming&mdash;running
                                long batches to hide changeovers, reclassifying defects, or inflating "planned" time.
                                Use the three pillars separately to find which loss category dominates, then drill
                                into the specific Six Big Losses within that pillar.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="calc-derivation" id="oee-derivation">
                    <div class="calc-derivation-header" onclick="toggleDerivation('oee-derivation')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        Show Derivation
                    </div>
                    <div class="calc-derivation-body" id="oee-derivation-body">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div id="oee-next-steps" class="calc-next-steps" style="display:none"></div>
            </div>

            <!-- Bottleneck -->
            <div class="calc-layout" id="layout-bottleneck">
                <div class="calc-section">
                    <div class="calc-section-title">Process Steps</div>
                    <div class="bottleneck-stations" id="bottleneck-stations"></div>
                    <div class="yamazumi-add" onclick="addBottleneckStation()">+ Add Process Step</div>
                </div>

                <div class="calc-chart">
                    <div class="calc-chart-title">Cycle Time by Process</div>
                    <div id="bottleneck-chart" style="height: 350px;"></div>
                </div>

                <div class="bottleneck-constraint" id="bottleneck-constraint">
                    <div class="bottleneck-constraint-title">System Constraint</div>
                    <div class="bottleneck-constraint-name" id="bottleneck-name">Welding</div>
                    <div class="calc-breakdown" style="background: transparent; padding: 0; margin-top: 12px;">
                        <div class="calc-breakdown-row">
                            <span>Constraint Cycle Time</span>
                            <span id="bottleneck-ct">72 sec</span>
                        </div>
                        <div class="calc-breakdown-row">
                            <span>Max System Throughput</span>
                            <span id="bottleneck-throughput">50 units/hr</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Little's Law -->
            <div class="calc-layout" id="layout-littles">
                <div class="calc-section">
                    <div class="calc-section-title">Solve For</div>
                    <div class="calc-inputs" style="max-width: 300px;">
                        <div class="calc-input">
                            <select id="littles-solve" onchange="calcLittles()">
                                <option value="wip">WIP (given Throughput & Lead Time)</option>
                                <option value="throughput">Throughput (given WIP & Lead Time)</option>
                                <option value="leadtime">Lead Time (given WIP & Throughput)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Inputs</div>
                    <div class="calc-inputs">
                        <div class="calc-input" id="littles-wip-group">
                            <label>WIP (Work in Process)</label>
                            <input type="number" id="littles-wip" value="50" oninput="calcLittles()">
                            <span class="input-hint">units in system</span>
                        </div>
                        <div class="calc-input" id="littles-thr-group">
                            <label>Throughput (TH)
                                <button class="calc-pull-btn" data-link-from="bottleneckThroughput" onclick="SvendOps.pull('bottleneckThroughput', 'littles-thr')" title="Pull from Bottleneck calculator">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                                    ← Bottleneck
                                </button>
                            </label>
                            <input type="number" id="littles-thr" value="10" oninput="calcLittles()">
                            <span class="input-hint">units per hour</span>
                        </div>
                        <div class="calc-input" id="littles-lt-group">
                            <label>Lead Time (CT)</label>
                            <input type="number" id="littles-lt" value="5" oninput="calcLittles()">
                            <span class="input-hint">hours</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Result</div>
                    <div class="calc-results">
                        <div class="calc-result-card primary">
                            <div class="calc-result-label" id="littles-result-label">WIP</div>
                            <div class="calc-result-value" id="littles-result">50<span class="calc-result-unit" id="littles-result-unit">units</span></div>
                        </div>
                    </div>
                    <div class="calc-breakdown">
                        <div class="calc-breakdown-row">
                            <span>Formula</span>
                            <span>WIP = Throughput × Lead Time</span>
                        </div>
                        <div class="calc-breakdown-row">
                            <span>Interpretation</span>
                            <span id="littles-interpret">L = λW (the fundamental law of flow)</span>
                        </div>
                    </div>
                </div>

                <div id="littles-chart" style="height: 250px; margin-top: 16px;"></div>

                <div class="calc-derivation" id="littles-derivation">
                    <div class="calc-derivation-header" onclick="toggleDerivation('littles-derivation')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        Show Derivation
                    </div>
                    <div class="calc-derivation-body" id="littles-derivation-body">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Queuing M/M/c -->
            <div class="calc-layout" id="layout-queue">
                <div class="calc-section">
                    <div class="calc-section-title">System Parameters</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Arrival Rate (λ)</label>
                            <input type="number" id="queue-lambda" value="8" step="0.1" oninput="calcQueue()">
                            <span class="input-hint">customers per hour</span>
                        </div>
                        <div class="calc-input">
                            <label>Service Rate (μ)
                                <button class="calc-pull-btn" data-link-from="bottleneckThroughput"
                                        onclick="SvendOps.pull('bottleneckThroughput', 'queue-mu')"
                                        title="Pull from Bottleneck calculator">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                                    ← Bottleneck
                                </button>
                            </label>
                            <input type="number" id="queue-mu" value="3" step="0.1" oninput="calcQueue()">
                            <span class="input-hint">customers per hour per server</span>
                        </div>
                        <div class="calc-input">
                            <label>Number of Servers (c)</label>
                            <input type="number" id="queue-c" value="3" min="1" oninput="calcQueue()">
                            <span class="input-hint">parallel servers</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Results</div>
                    <div class="calc-results">
                        <div class="calc-result-card">
                            <div class="calc-result-label">Utilization (ρ)</div>
                            <div class="calc-result-value" id="queue-rho">88.9<span class="calc-result-unit">%</span></div>
                        </div>
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Avg Wait Time (Wq)</div>
                            <div class="calc-result-value" id="queue-wq">12.5<span class="calc-result-unit">min</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Avg Queue Length (Lq)</div>
                            <div class="calc-result-value" id="queue-lq">1.7</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Avg Time in System (W)</div>
                            <div class="calc-result-value" id="queue-w">32.5<span class="calc-result-unit">min</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Avg in System (L)</div>
                            <div class="calc-result-value" id="queue-l">4.3</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">P(Wait)</div>
                            <div class="calc-result-value" id="queue-pw">70.2<span class="calc-result-unit">%</span></div>
                        </div>
                    </div>
                    <div class="calc-breakdown">
                        <div class="calc-breakdown-row">
                            <span>System Stable?</span>
                            <span id="queue-stable">Yes (λ < cμ)</span>
                        </div>
                        <div class="calc-breakdown-row">
                            <span>Capacity</span>
                            <span id="queue-capacity">9.0 customers/hr</span>
                        </div>
                    </div>
                </div>

                <div class="calc-chart">
                    <div class="calc-chart-title">Wait Time vs Utilization</div>
                    <div id="queue-chart" style="height: 350px;"></div>
                </div>

                <div class="calc-section" style="margin-top: 24px;">
                    <button class="calc-monte-toggle" onclick="toggleQueueMonteCarlo(this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
                        Run Monte Carlo Simulation
                    </button>
                    <div class="calc-monte-results" id="queue-monte-results">
                        <div class="calc-monte-summary">
                            <div class="calc-monte-stat">
                                <div class="calc-monte-stat-label">Mean Wait</div>
                                <div class="calc-monte-stat-value" id="queue-monte-mean">-</div>
                            </div>
                            <div class="calc-monte-stat">
                                <div class="calc-monte-stat-label">5th %ile</div>
                                <div class="calc-monte-stat-value" id="queue-monte-p5">-</div>
                            </div>
                            <div class="calc-monte-stat">
                                <div class="calc-monte-stat-label">95th %ile</div>
                                <div class="calc-monte-stat-value" id="queue-monte-p95">-</div>
                            </div>
                            <div class="calc-monte-stat">
                                <div class="calc-monte-stat-label">Std Dev</div>
                                <div class="calc-monte-stat-value" id="queue-monte-std">-</div>
                            </div>
                        </div>
                        <div id="queue-monte-chart" style="height: 250px;"></div>
                        <p style="font-size: 11px; color: var(--text-dim); margin-top: 12px; text-align: center;">
                            Assumes ±15% variability in arrival and service rates
                        </p>
                    </div>
                </div>

                <div class="calc-derivation" id="queue-derivation">
                    <div class="calc-derivation-header" onclick="toggleDerivation('queue-derivation')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        Show Derivation (Erlang C)
                    </div>
                    <div class="calc-derivation-body" id="queue-derivation-body">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- M/M/c/K Finite Queue -->
            <div class="calc-layout" id="layout-queue-finite">
                <div class="calc-section">
                    <div class="calc-section-title">System Parameters</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Arrival Rate (λ)</label>
                            <input type="number" id="qf-lambda" value="10" step="0.1" oninput="calcQueueFinite()">
                            <span class="input-hint">customers per hour</span>
                        </div>
                        <div class="calc-input">
                            <label>Service Rate (μ)</label>
                            <input type="number" id="qf-mu" value="4" step="0.1" oninput="calcQueueFinite()">
                            <span class="input-hint">per server per hour</span>
                        </div>
                        <div class="calc-input">
                            <label>Servers (c)</label>
                            <input type="number" id="qf-c" value="3" min="1" oninput="calcQueueFinite()">
                            <span class="input-hint">parallel servers</span>
                        </div>
                        <div class="calc-input">
                            <label>Max Capacity (K)</label>
                            <input type="number" id="qf-k" value="10" min="1" oninput="calcQueueFinite()">
                            <span class="input-hint">max in system (queue + service)</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Results</div>
                    <div class="calc-results">
                        <div class="calc-result-card">
                            <div class="calc-result-label">Utilization (ρ)</div>
                            <div class="calc-result-value" id="qf-rho">83.3<span class="calc-result-unit">%</span></div>
                        </div>
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Avg Wait (Wq)</div>
                            <div class="calc-result-value" id="qf-wq">8.2<span class="calc-result-unit">min</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Avg Queue (Lq)</div>
                            <div class="calc-result-value" id="qf-lq">1.4</div>
                        </div>
                        <div class="calc-result-card" style="background: rgba(231, 76, 60, 0.1); border-color: #e74c3c;">
                            <div class="calc-result-label">Blocking Prob (Pk)</div>
                            <div class="calc-result-value" id="qf-pk" style="color: #e74c3c;">2.3<span class="calc-result-unit">%</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Effective λ</div>
                            <div class="calc-result-value" id="qf-eff-lambda">9.8<span class="calc-result-unit">/hr</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Lost/Hour</div>
                            <div class="calc-result-value" id="qf-lost">0.2</div>
                        </div>
                    </div>
                    <div class="calc-breakdown">
                        <div class="calc-breakdown-row">
                            <span>Interpretation</span>
                            <span id="qf-interpret">~2% of arrivals are turned away (queue full)</span>
                        </div>
                    </div>
                </div>

                <div class="calc-chart">
                    <div class="calc-chart-title">Blocking Probability vs Capacity</div>
                    <div id="qf-chart" style="height: 300px;"></div>
                </div>

                <div class="calc-section" style="margin-top: 24px;">
                    <button class="calc-monte-toggle" onclick="toggleQFMonteCarlo(this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
                        Simulate Variability
                    </button>
                    <div class="calc-monte-results" id="qf-monte-results">
                        <div class="calc-monte-summary">
                            <div class="calc-monte-stat">
                                <div class="calc-monte-stat-label">Mean Blocking</div>
                                <div class="calc-monte-stat-value" id="qf-monte-mean">-</div>
                            </div>
                            <div class="calc-monte-stat">
                                <div class="calc-monte-stat-label">95th %ile</div>
                                <div class="calc-monte-stat-value" id="qf-monte-p95">-</div>
                            </div>
                            <div class="calc-monte-stat">
                                <div class="calc-monte-stat-label">Max Observed</div>
                                <div class="calc-monte-stat-value" id="qf-monte-max">-</div>
                            </div>
                        </div>
                        <div id="qf-monte-chart" style="height: 220px;"></div>
                    </div>
                </div>

                <div class="calc-derivation" id="queue-finite-derivation">
                    <div class="calc-derivation-header" onclick="toggleDerivation('queue-finite-derivation')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        Show Derivation
                    </div>
                    <div class="calc-derivation-body" id="queue-finite-derivation-body">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Priority Queue -->
            <div class="calc-layout" id="layout-queue-priority">
                <div class="calc-section">
                    <div class="calc-section-title">System Parameters</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Servers (c)</label>
                            <input type="number" id="qp-c" value="3" min="1" oninput="calcQueuePriority()">
                            <span class="input-hint">parallel servers</span>
                        </div>
                        <div class="calc-input">
                            <label>Service Rate (μ)
                                <button class="calc-pull-btn" data-link-from="bottleneckThroughput" onclick="SvendOps.pull('bottleneckThroughput', 'qp-mu')" title="Pull from Bottleneck calculator">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                                    ← Bottleneck
                                </button>
                            </label>
                            <input type="number" id="qp-mu" value="4" step="0.1" oninput="calcQueuePriority()">
                            <span class="input-hint">per server per hour</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Priority Classes</div>
                    <div id="qp-classes" style="display: flex; flex-direction: column; gap: 12px;">
                        <!-- Populated by JS -->
                    </div>
                    <button onclick="addPriorityClass()" style="margin-top: 12px; padding: 8px 16px; background: var(--bg-secondary); border: 1px dashed var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer;">
                        + Add Priority Class
                    </button>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Results by Priority</div>
                    <div id="qp-results" style="overflow-x: auto;">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div class="calc-chart">
                    <div class="calc-chart-title">Wait Time by Priority Class</div>
                    <div id="qp-chart" style="height: 300px;"></div>
                </div>

                <div class="calc-derivation" id="queue-priority-derivation">
                    <div class="calc-derivation-header" onclick="toggleDerivation('queue-priority-derivation')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        Show Derivation
                    </div>
                    <div class="calc-derivation-body" id="queue-priority-derivation-body">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Staffing Optimizer -->
            <div class="calc-layout" id="layout-queue-optimizer">
                <div class="calc-section">
                    <div class="calc-section-title">Demand & Service</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Arrival Rate (λ)</label>
                            <input type="number" id="qo-lambda" value="20" step="0.5" oninput="calcOptimizer()">
                            <span class="input-hint">customers per hour</span>
                        </div>
                        <div class="calc-input">
                            <label>Service Rate (μ)</label>
                            <input type="number" id="qo-mu" value="5" step="0.1" oninput="calcOptimizer()">
                            <span class="input-hint">per server per hour</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Cost Parameters</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Server Cost</label>
                            <input type="number" id="qo-server-cost" value="25" oninput="calcOptimizer()">
                            <span class="input-hint">$ per hour per server</span>
                        </div>
                        <div class="calc-input">
                            <label>Wait Cost</label>
                            <input type="number" id="qo-wait-cost" value="50" oninput="calcOptimizer()">
                            <span class="input-hint">$ per hour of customer waiting</span>
                        </div>
                        <div class="calc-input">
                            <label>Target Wait (optional)</label>
                            <input type="number" id="qo-target-wait" value="" placeholder="e.g., 5" oninput="calcOptimizer()">
                            <span class="input-hint">max acceptable minutes</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Optimal Staffing</div>
                    <div class="calc-results">
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Optimal Servers</div>
                            <div class="calc-result-value" id="qo-optimal">5</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Total Cost/Hr</div>
                            <div class="calc-result-value" id="qo-total-cost">$142</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Avg Wait</div>
                            <div class="calc-result-value" id="qo-wait">2.3<span class="calc-result-unit">min</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Utilization</div>
                            <div class="calc-result-value" id="qo-util">80<span class="calc-result-unit">%</span></div>
                        </div>
                    </div>
                </div>

                <div class="calc-chart">
                    <div class="calc-chart-title">Cost vs Number of Servers</div>
                    <div id="qo-chart" style="height: 350px;"></div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Staffing Table</div>
                    <div id="qo-table" style="overflow-x: auto;">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div class="calc-derivation" id="queue-optimizer-derivation">
                    <div class="calc-derivation-header" onclick="toggleDerivation('queue-optimizer-derivation')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        Show Derivation
                    </div>
                    <div class="calc-derivation-body" id="queue-optimizer-derivation-body">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Live Queue Simulator -->
            <div class="calc-layout" id="layout-queue-sim">
                <div class="calc-section">
                    <div class="calc-section-title">Simulation Parameters</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Arrival Rate (λ)</label>
                            <input type="number" id="qs-lambda" value="8" step="0.5" oninput="updateSimParams()">
                            <span class="input-hint">customers per hour</span>
                        </div>
                        <div class="calc-input">
                            <label>Service Rate (μ)</label>
                            <input type="number" id="qs-mu" value="3" step="0.1" oninput="updateSimParams()">
                            <span class="input-hint">per server per hour</span>
                        </div>
                        <div class="calc-input">
                            <label>Servers</label>
                            <input type="number" id="qs-c" value="3" min="1" max="10" oninput="updateSimParams()">
                        </div>
                        <div class="calc-input">
                            <label>Variability (CoV)</label>
                            <input type="range" id="qs-cov" min="0" max="100" value="30" oninput="updateSimParams()">
                            <span class="input-hint" id="qs-cov-label">30% — Moderate variability</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                        <button id="qs-start" onclick="startSimulation()" style="padding: 12px 24px; background: var(--accent); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer;">
                            ▶ Start Simulation
                        </button>
                        <button onclick="resetSimulation()" style="padding: 12px 24px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer;">
                            Reset
                        </button>
                        <div style="flex: 1;"></div>
                        <div style="display: flex; align-items: center; gap: 8px; color: var(--text-dim); font-size: 12px;">
                            <span>Speed:</span>
                            <input type="range" id="qs-speed" min="1" max="10" value="5" style="width: 80px;">
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Live Queue Visualization</div>
                    <div id="qs-visual" style="background: var(--bg-secondary); border-radius: 8px; padding: 20px; min-height: 200px; position: relative; overflow: hidden;">
                        <div id="qs-servers" style="display: flex; gap: 16px; justify-content: center; margin-bottom: 24px;">
                            <!-- Server icons populated by JS -->
                        </div>
                        <div id="qs-queue-visual" style="display: flex; gap: 4px; justify-content: center; flex-wrap: wrap; min-height: 40px;">
                            <!-- Queue dots populated by JS -->
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Live Statistics</div>
                    <div class="calc-results">
                        <div class="calc-result-card">
                            <div class="calc-result-label">Customers Served</div>
                            <div class="calc-result-value" id="qs-served">0</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Current Queue</div>
                            <div class="calc-result-value" id="qs-current-queue">0</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Avg Wait (Observed)</div>
                            <div class="calc-result-value" id="qs-avg-wait">0<span class="calc-result-unit">min</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Max Queue Seen</div>
                            <div class="calc-result-value" id="qs-max-queue">0</div>
                        </div>
                    </div>
                </div>

                <div class="calc-chart">
                    <div class="calc-chart-title">Queue Length Over Time</div>
                    <div id="qs-chart" style="height: 250px;"></div>
                </div>

                <div class="calc-section" style="margin-top: 20px;">
                    <div class="calc-section-title">Burst Analysis — What Broke?</div>
                    <div id="qs-burst-analysis" style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; font-size: 13px; color: var(--text-secondary);">
                        <em>Start simulation to analyze arrival bursts...</em>
                    </div>
                </div>
            </div>

            <!-- A/B Scenario Compare -->
            <div class="calc-layout" id="layout-queue-compare">
                <div class="calc-section">
                    <div class="calc-section-title">Side-by-Side Comparison</div>
                    <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 20px;">
                        Compare current state vs a proposed change. Watch both simulations run simultaneously.
                    </p>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                    <!-- Scenario A -->
                    <div style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; border: 2px solid #e74c3c;">
                        <h3 style="font-size: 14px; color: #e74c3c; margin-bottom: 16px;">📍 Scenario A: Current State</h3>
                        <div class="calc-inputs" style="gap: 12px;">
                            <div class="calc-input">
                                <label>Arrival Rate (λ)</label>
                                <input type="number" id="qc-a-lambda" value="12" step="0.5" oninput="updateCompareParams()">
                            </div>
                            <div class="calc-input">
                                <label>Service Rate (μ)</label>
                                <input type="number" id="qc-a-mu" value="4" step="0.1" oninput="updateCompareParams()">
                            </div>
                            <div class="calc-input">
                                <label>Servers</label>
                                <input type="number" id="qc-a-c" value="3" min="1" oninput="updateCompareParams()">
                            </div>
                        </div>
                        <div id="qc-a-servers" style="display: flex; gap: 8px; justify-content: center; margin: 16px 0;"></div>
                        <div id="qc-a-queue" style="display: flex; gap: 3px; flex-wrap: wrap; justify-content: center; min-height: 30px;"></div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 16px; font-size: 12px;">
                            <div style="text-align: center; padding: 8px; background: var(--bg-card); border-radius: 6px;">
                                <div style="color: var(--text-dim);">Served</div>
                                <div style="font-size: 18px; font-weight: 600;" id="qc-a-served">0</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: var(--bg-card); border-radius: 6px;">
                                <div style="color: var(--text-dim);">Avg Wait</div>
                                <div style="font-size: 18px; font-weight: 600;" id="qc-a-wait">0m</div>
                            </div>
                        </div>
                    </div>

                    <!-- Scenario B -->
                    <div style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; border: 2px solid #27ae60;">
                        <h3 style="font-size: 14px; color: #27ae60; margin-bottom: 16px;">🎯 Scenario B: Proposed Change</h3>
                        <div class="calc-inputs" style="gap: 12px;">
                            <div class="calc-input">
                                <label>Arrival Rate (λ)</label>
                                <input type="number" id="qc-b-lambda" value="12" step="0.5" oninput="updateCompareParams()">
                            </div>
                            <div class="calc-input">
                                <label>Service Rate (μ)</label>
                                <input type="number" id="qc-b-mu" value="4" step="0.1" oninput="updateCompareParams()">
                            </div>
                            <div class="calc-input">
                                <label>Servers</label>
                                <input type="number" id="qc-b-c" value="4" min="1" oninput="updateCompareParams()">
                            </div>
                        </div>
                        <div id="qc-b-servers" style="display: flex; gap: 8px; justify-content: center; margin: 16px 0;"></div>
                        <div id="qc-b-queue" style="display: flex; gap: 3px; flex-wrap: wrap; justify-content: center; min-height: 30px;"></div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 16px; font-size: 12px;">
                            <div style="text-align: center; padding: 8px; background: var(--bg-card); border-radius: 6px;">
                                <div style="color: var(--text-dim);">Served</div>
                                <div style="font-size: 18px; font-weight: 600;" id="qc-b-served">0</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: var(--bg-card); border-radius: 6px;">
                                <div style="color: var(--text-dim);">Avg Wait</div>
                                <div style="font-size: 18px; font-weight: 600;" id="qc-b-wait">0m</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="calc-section" style="margin-top: 24px;">
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <button id="qc-start" onclick="startCompare()" style="padding: 12px 24px; background: var(--accent); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer;">
                            ▶ Run Both Scenarios
                        </button>
                        <button onclick="resetCompare()" style="padding: 12px 24px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer;">
                            Reset
                        </button>
                        <div style="flex: 1;"></div>
                        <div id="qc-verdict" style="font-size: 14px; font-weight: 600; padding: 8px 16px; border-radius: 6px; background: var(--bg-card);">
                            Run to compare...
                        </div>
                    </div>
                </div>

                <div class="calc-chart">
                    <div class="calc-chart-title">Queue Length Comparison Over Time</div>
                    <div id="qc-chart" style="height: 300px;"></div>
                </div>
            </div>

            <!-- Multi-Stage (Tandem) Queue -->
            <div class="calc-layout" id="layout-queue-tandem">
                <div class="calc-section">
                    <div class="calc-section-title">Multi-Stage Process</div>
                    <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 20px;">
                        Model sequential stages — ER: Triage → Doctor → Discharge. Manufacturing: Assembly → QC → Pack.
                    </p>
                    <div id="qt-stages" style="display: flex; flex-direction: column; gap: 12px;">
                        <!-- Populated by JS -->
                    </div>
                    <button onclick="addTandemStage()" style="margin-top: 12px; padding: 8px 16px; background: var(--bg-secondary); border: 1px dashed var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer;">
                        + Add Stage
                    </button>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Arrival Rate</div>
                    <div class="calc-inputs" style="max-width: 300px;">
                        <div class="calc-input">
                            <label>System Arrival Rate (λ)</label>
                            <input type="number" id="qt-lambda" value="10" step="0.5" oninput="calcTandem()">
                            <span class="input-hint">customers per hour entering stage 1</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">End-to-End Results</div>
                    <div class="calc-results">
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Total Time in System</div>
                            <div class="calc-result-value" id="qt-total-time">24<span class="calc-result-unit">min</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Total Wait Time</div>
                            <div class="calc-result-value" id="qt-total-wait">9<span class="calc-result-unit">min</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Bottleneck Stage</div>
                            <div class="calc-result-value" id="qt-bottleneck" style="font-size: 18px;">Doctor</div>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Stage-by-Stage Breakdown</div>
                    <div id="qt-breakdown" style="overflow-x: auto;">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div class="calc-chart">
                    <div class="calc-chart-title">Time Breakdown by Stage</div>
                    <div id="qt-chart" style="height: 300px;"></div>
                </div>

                <div class="calc-section" style="margin-top: 24px;">
                    <button class="calc-monte-toggle" onclick="toggleTandemMonteCarlo(this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
                        Simulate End-to-End Variability
                    </button>
                    <div class="calc-monte-results" id="qt-monte-results">
                        <div class="calc-monte-summary">
                            <div class="calc-monte-stat">
                                <div class="calc-monte-stat-label">Mean Total</div>
                                <div class="calc-monte-stat-value" id="qt-monte-mean">-</div>
                            </div>
                            <div class="calc-monte-stat">
                                <div class="calc-monte-stat-label">5th %ile</div>
                                <div class="calc-monte-stat-value" id="qt-monte-p5">-</div>
                            </div>
                            <div class="calc-monte-stat">
                                <div class="calc-monte-stat-label">95th %ile</div>
                                <div class="calc-monte-stat-value" id="qt-monte-p95">-</div>
                            </div>
                        </div>
                        <div id="qt-monte-chart" style="height: 220px;"></div>
                    </div>
                </div>

                <div class="calc-derivation" id="queue-tandem-derivation">
                    <div class="calc-derivation-header" onclick="toggleDerivation('queue-tandem-derivation')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        Show Derivation
                    </div>
                    <div class="calc-derivation-body" id="queue-tandem-derivation-body">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Pitch -->
            <div class="calc-layout" id="layout-pitch">
                <div class="calc-section">
                    <div class="calc-section-title">Inputs</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Takt Time
                                <button class="calc-pull-btn" data-link-from="takt" onclick="SvendOps.pull('takt', 'pitch-takt')" title="Pull from Takt Time calculator">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                                    ← Takt
                                </button>
                            </label>
                            <input type="number" id="pitch-takt" value="60" oninput="calcPitch()">
                            <span class="input-hint">seconds per unit</span>
                        </div>
                        <div class="calc-input">
                            <label>Pack-Out Quantity</label>
                            <input type="number" id="pitch-pack" value="12" oninput="calcPitch()">
                            <span class="input-hint">units per container</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Result</div>
                    <div class="calc-results">
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Pitch</div>
                            <div class="calc-result-value" id="pitch-result">12<span class="calc-result-unit">min</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Withdrawals per Hour</div>
                            <div class="calc-result-value" id="pitch-per-hour">5</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Per Shift (8hr)</div>
                            <div class="calc-result-value" id="pitch-per-shift">40</div>
                        </div>
                    </div>
                    <div class="calc-breakdown">
                        <div class="calc-breakdown-row">
                            <span>Formula</span>
                            <span>Pitch = Takt × Pack-out Qty</span>
                        </div>
                        <div class="calc-breakdown-row">
                            <span>Use</span>
                            <span>Water spider pickup interval</span>
                        </div>
                    </div>
                </div>

                <div class="calc-derivation" id="pitch-derivation">
                    <div class="calc-derivation-header" onclick="toggleDerivation('pitch-derivation')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        Show Derivation
                    </div>
                    <div class="calc-derivation-body" id="pitch-derivation-body">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- PFA: Product Flow Analysis -->
            <div class="calc-layout" id="layout-pfa">
                <div class="calc-section">
                    <div class="calc-section-title">Product Journey</div>
                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
                        Follow the <strong>product</strong> through the process. Record each step with TIPS categories:
                        <span style="color: #3498db;">Transport</span>,
                        <span style="color: #9b59b6;">Inspect</span>,
                        <span style="color: #4a9f6e;">Process</span>,
                        <span style="color: #e67e22;">Storage</span> (B=Between, L=Lot delay, W=Within).
                    </p>
                    <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                        <button onclick="addPFAStep()" style="padding: 8px 16px; background: var(--accent); border: none; border-radius: 6px; color: white; font-weight: 500; cursor: pointer;">+ Add Step</button>
                        <button onclick="loadPFAExample()" style="padding: 8px 16px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer;">Load Example</button>
                        <button onclick="capturePFABaseline()" style="padding: 8px 16px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer;">Capture Baseline</button>
                        <button onclick="clearPFABaseline()" id="pfa-clear-baseline" style="display: none; padding: 8px 16px; background: rgba(231, 76, 60, 0.1); border: 1px solid #e74c3c; border-radius: 6px; color: #e74c3c; cursor: pointer;">Clear Baseline</button>
                    </div>
                    <div id="pfa-steps" style="display: flex; flex-direction: column; gap: 8px;"></div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Analysis</div>
                    <div class="calc-results">
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Process Ratio</div>
                            <div class="calc-result-value" id="pfa-process-ratio">0<span class="calc-result-unit">%</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Total Time</div>
                            <div class="calc-result-value" id="pfa-total-time">0<span class="calc-result-unit">min</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Total Distance</div>
                            <div class="calc-result-value" id="pfa-total-dist">0<span class="calc-result-unit">m</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Steps</div>
                            <div class="calc-result-value" id="pfa-step-count">0</div>
                        </div>
                    </div>
                    <div id="pfa-baseline-compare" style="display: none; margin-bottom: 16px; padding: 16px; background: rgba(74, 159, 110, 0.1); border: 1px solid var(--accent); border-radius: 8px;">
                        <div style="font-size: 12px; color: var(--accent); text-transform: uppercase; margin-bottom: 8px;">vs Baseline</div>
                        <div id="pfa-baseline-delta" style="font-size: 14px;"></div>
                    </div>
                    <div class="calc-breakdown" id="pfa-breakdown"></div>
                </div>

                <div class="calc-section">
                    <div class="calc-chart">
                        <div class="calc-chart-title">Time by Category</div>
                        <div id="pfa-chart" style="height: 250px;"></div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-chart">
                        <div class="calc-chart-title">Process Flow</div>
                        <div id="pfa-flow" style="overflow-x: auto; padding: 16px 0;"></div>
                    </div>
                </div>
            </div>

            <!-- WFA: Workflow Analysis -->
            <div class="calc-layout" id="layout-wfa">
                <div class="calc-section">
                    <div class="calc-section-title">Task Elements</div>
                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
                        Follow the <strong>worker</strong> through the task. Classify each element:
                        <span style="color: #4a9f6e;">VA</span> (value-add),
                        <span style="color: #3498db;">RW</span> (required work),
                        <span style="color: #9b59b6;">P</span> (parts),
                        <span style="color: #e67e22;">T</span> (tools),
                        <span style="color: #f39c12;">I</span> (inspection),
                        <span style="color: #1abc9c;">MH</span> (material handling),
                        <span style="color: #e74c3c;">UW</span> (unnecessary work),
                        <span style="color: #95a5a6;">IT</span> (idle time).
                    </p>
                    <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                        <button onclick="addWFAElement()" style="padding: 8px 16px; background: var(--accent); border: none; border-radius: 6px; color: white; font-weight: 500; cursor: pointer;">+ Add Element</button>
                        <button onclick="loadWFAExample()" style="padding: 8px 16px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer;">Load Example</button>
                        <button onclick="captureWFABaseline()" style="padding: 8px 16px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer;">Capture Baseline</button>
                        <button onclick="clearWFABaseline()" id="wfa-clear-baseline" style="display: none; padding: 8px 16px; background: rgba(231, 76, 60, 0.1); border: 1px solid #e74c3c; border-radius: 6px; color: #e74c3c; cursor: pointer;">Clear Baseline</button>
                    </div>
                    <div id="wfa-elements" style="display: flex; flex-direction: column; gap: 8px;"></div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Analysis</div>
                    <div class="calc-results">
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">VA Ratio</div>
                            <div class="calc-result-value" id="wfa-va-ratio">0<span class="calc-result-unit">%</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Total Time</div>
                            <div class="calc-result-value" id="wfa-total-time">0<span class="calc-result-unit">sec</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">NVA/R</div>
                            <div class="calc-result-value" id="wfa-nvar">0<span class="calc-result-unit">%</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">NVA/N (Waste)</div>
                            <div class="calc-result-value" id="wfa-nvan">0<span class="calc-result-unit">%</span></div>
                        </div>
                    </div>
                    <div id="wfa-baseline-compare" style="display: none; margin-bottom: 16px; padding: 16px; background: rgba(74, 159, 110, 0.1); border: 1px solid var(--accent); border-radius: 8px;">
                        <div style="font-size: 12px; color: var(--accent); text-transform: uppercase; margin-bottom: 8px;">vs Baseline</div>
                        <div id="wfa-baseline-delta" style="font-size: 14px;"></div>
                    </div>
                    <div class="calc-breakdown" id="wfa-breakdown"></div>
                </div>

                <div class="calc-section">
                    <div class="calc-chart">
                        <div class="calc-chart-title">Time by Category</div>
                        <div id="wfa-chart" style="height: 250px;"></div>
                    </div>
                </div>

                <div class="calc-section">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div style="background: var(--bg-secondary); border-radius: 8px; padding: 16px;">
                            <div style="font-size: 12px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px;">NVA/R — Required (Target Later)</div>
                            <div id="wfa-nvar-list" style="font-size: 13px; color: var(--text-secondary);"></div>
                        </div>
                        <div style="background: rgba(231, 76, 60, 0.1); border: 1px solid rgba(231, 76, 60, 0.3); border-radius: 8px; padding: 16px;">
                            <div style="font-size: 12px; color: #e74c3c; text-transform: uppercase; margin-bottom: 12px;">NVA/N — Eliminate Now</div>
                            <div id="wfa-nvan-list" style="font-size: 13px; color: var(--text-secondary);"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RTY -->
            <div class="calc-layout" id="layout-rty">
                <div class="calc-section">
                    <div class="calc-section-title">Process Steps</div>
                    <div class="yamazumi-stations" id="rty-steps"></div>
                    <div class="yamazumi-add" onclick="addRTYStep()">+ Add Process Step</div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Result</div>
                    <div class="calc-results">
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Rolled Throughput Yield</div>
                            <div class="calc-result-value" id="rty-result">85.7<span class="calc-result-unit">%</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Total Defect Opportunities</div>
                            <div class="calc-result-value" id="rty-defects">14.3<span class="calc-result-unit">%</span></div>
                        </div>
                    </div>
                    <div class="calc-breakdown">
                        <div class="calc-breakdown-row">
                            <span>Formula</span>
                            <span>RTY = FPY₁ × FPY₂ × ... × FPYₙ</span>
                        </div>
                        <div class="calc-breakdown-row">
                            <span>Hidden Factory</span>
                            <span id="rty-hidden">14.3% rework/scrap hidden in process</span>
                        </div>
                    </div>
                </div>

                <div class="calc-chart">
                    <div class="calc-chart-title">Yield Waterfall</div>
                    <div id="rty-chart" style="height: 350px;"></div>
                </div>

                <div class="calc-derivation" id="rty-derivation">
                    <div class="calc-derivation-header" onclick="toggleDerivation('rty-derivation')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        Show Derivation
                    </div>
                    <div class="calc-derivation-body" id="rty-derivation-body">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div id="rty-next-steps" class="calc-next-steps" style="display:none"></div>
            </div>

            <!-- DPMO / Sigma -->
            <div class="calc-layout" id="layout-dpmo">
                <div class="calc-section">
                    <div class="calc-section-title">Calculate From</div>
                    <div class="calc-inputs" style="max-width: 300px;">
                        <div class="calc-input">
                            <select id="dpmo-mode" onchange="updateDPMOMode()">
                                <option value="defects">Defects & Opportunities</option>
                                <option value="dpmo">DPMO directly</option>
                                <option value="yield">Process Yield (%)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Inputs</div>
                    <div class="calc-inputs" id="dpmo-inputs">
                        <div class="calc-input" id="dpmo-defects-group">
                            <label>Number of Defects</label>
                            <input type="number" id="dpmo-defects" value="15" oninput="calcDPMO()">
                        </div>
                        <div class="calc-input" id="dpmo-units-group">
                            <label>Units Inspected</label>
                            <input type="number" id="dpmo-units" value="1000" oninput="calcDPMO()">
                        </div>
                        <div class="calc-input" id="dpmo-opp-group">
                            <label>Opportunities per Unit</label>
                            <input type="number" id="dpmo-opp" value="5" oninput="calcDPMO()">
                            <span class="input-hint">defect opportunities</span>
                        </div>
                        <div class="calc-input" id="dpmo-direct-group" style="display:none;">
                            <label>DPMO</label>
                            <input type="number" id="dpmo-direct" value="3400" oninput="calcDPMO()">
                        </div>
                        <div class="calc-input" id="dpmo-yield-group" style="display:none;">
                            <label>Process Yield</label>
                            <input type="number" id="dpmo-yield" value="99.5" step="0.01" oninput="calcDPMO()">
                            <span class="input-hint">%</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Results</div>
                    <div class="calc-results">
                        <div class="calc-result-card">
                            <div class="calc-result-label">DPMO</div>
                            <div class="calc-result-value" id="dpmo-result">3,000</div>
                        </div>
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Sigma Level</div>
                            <div class="calc-result-value" id="dpmo-sigma">4.2<span class="calc-result-unit">σ</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Yield</div>
                            <div class="calc-result-value" id="dpmo-yield-result">99.70<span class="calc-result-unit">%</span></div>
                        </div>
                    </div>
                    <div class="calc-breakdown">
                        <div class="calc-breakdown-row">
                            <span>World Class (6σ)</span>
                            <span>3.4 DPMO = 99.99966%</span>
                        </div>
                        <div class="calc-breakdown-row">
                            <span>Defect Rate</span>
                            <span id="dpmo-rate">0.30%</span>
                        </div>
                    </div>
                </div>

                <div id="dpmo-chart" style="height: 280px; margin-top: 16px;"></div>

                <div class="calc-derivation" id="dpmo-derivation">
                    <div class="calc-derivation-header" onclick="toggleDerivation('dpmo-derivation')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        Show Derivation
                    </div>
                    <div class="calc-derivation-body" id="dpmo-derivation-body">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div id="dpmo-next-steps" class="calc-next-steps" style="display:none"></div>
            </div>

            <!-- Inventory Turns -->
            <div class="calc-layout" id="layout-turns">
                <div class="calc-section">
                    <div class="calc-section-title">Inputs</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Cost of Goods Sold (Annual)</label>
                            <input type="number" id="turns-cogs" value="5000000" oninput="calcTurns()">
                            <span class="input-hint">$ per year</span>
                        </div>
                        <div class="calc-input">
                            <label>Average Inventory Value
                                <button class="calc-pull-btn" data-link-from="kanbanInventory" onclick="SvendOps.pull('kanbanInventory', 'turns-inv')" title="Pull from Kanban calculator">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                                    ← Kanban
                                </button>
                            </label>
                            <input type="number" id="turns-inv" value="500000" oninput="calcTurns()">
                            <span class="input-hint">$</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Results</div>
                    <div class="calc-results">
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Inventory Turns</div>
                            <div class="calc-result-value" id="turns-result">10.0<span class="calc-result-unit">/yr</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Days on Hand</div>
                            <div class="calc-result-value" id="turns-doh">36.5<span class="calc-result-unit">days</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Weeks on Hand</div>
                            <div class="calc-result-value" id="turns-woh">5.2<span class="calc-result-unit">weeks</span></div>
                        </div>
                    </div>
                    <div class="calc-breakdown">
                        <div class="calc-breakdown-row">
                            <span>Formula</span>
                            <span>Turns = COGS ÷ Avg Inventory</span>
                        </div>
                        <div class="calc-breakdown-row">
                            <span>Days on Hand</span>
                            <span>365 ÷ Turns</span>
                        </div>
                    </div>
                </div>

                <div id="turns-chart" style="height: 280px; margin-top: 16px;"></div>

                <div class="calc-derivation" id="turns-derivation">
                    <div class="calc-derivation-header" onclick="toggleDerivation('turns-derivation')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        Show Derivation
                    </div>
                    <div class="calc-derivation-body" id="turns-derivation-body">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Cost of Quality -->
            <div class="calc-layout" id="layout-coq">
                <div class="calc-section">
                    <div class="calc-section-title">Prevention Costs</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Training</label>
                            <input type="number" id="coq-training" value="25000" oninput="calcCOQ()">
                        </div>
                        <div class="calc-input">
                            <label>Process Planning</label>
                            <input type="number" id="coq-planning" value="15000" oninput="calcCOQ()">
                        </div>
                        <div class="calc-input">
                            <label>Quality Systems</label>
                            <input type="number" id="coq-systems" value="20000" oninput="calcCOQ()">
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Appraisal Costs</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Inspection</label>
                            <input type="number" id="coq-inspection" value="50000" oninput="calcCOQ()">
                        </div>
                        <div class="calc-input">
                            <label>Testing</label>
                            <input type="number" id="coq-testing" value="30000" oninput="calcCOQ()">
                        </div>
                        <div class="calc-input">
                            <label>Audits</label>
                            <input type="number" id="coq-audits" value="10000" oninput="calcCOQ()">
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Failure Costs</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Internal (Scrap/Rework)</label>
                            <input type="number" id="coq-internal" value="75000" oninput="calcCOQ()">
                        </div>
                        <div class="calc-input">
                            <label>External (Warranty/Returns)</label>
                            <input type="number" id="coq-external" value="100000" oninput="calcCOQ()">
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Results</div>
                    <div class="calc-results">
                        <div class="calc-result-card">
                            <div class="calc-result-label">Prevention</div>
                            <div class="calc-result-value" id="coq-prev-total">$60K</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Appraisal</div>
                            <div class="calc-result-value" id="coq-appr-total">$90K</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Failure</div>
                            <div class="calc-result-value" id="coq-fail-total">$175K</div>
                        </div>
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Total COQ</div>
                            <div class="calc-result-value" id="coq-total">$325K</div>
                        </div>
                    </div>
                </div>

                <div class="calc-chart">
                    <div class="calc-chart-title">Cost of Quality Breakdown</div>
                    <div id="coq-chart" style="height: 350px;"></div>
                </div>

                <div class="calc-derivation" id="coq-derivation">
                    <div class="calc-derivation-header" onclick="toggleDerivation('coq-derivation')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        Show Derivation
                    </div>
                    <div class="calc-derivation-body" id="coq-derivation-body">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- SMED Analysis -->
            <div class="calc-layout" id="layout-smed">
                <!-- SMED Event Header -->
                <div class="calc-section" style="background: linear-gradient(135deg, rgba(232, 197, 71, 0.1) 0%, rgba(74, 159, 110, 0.1) 100%); border: 1px solid var(--accent); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
                        <div>
                            <div style="font-size: 18px; font-weight: 600; color: var(--text-primary);">SMED Event Worksheet</div>
                            <div style="font-size: 12px; color: var(--text-dim); margin-top: 4px;">Single-Minute Exchange of Die — Shigeo Shingo's methodology</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="captureBaseline()" style="padding: 8px 16px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer; font-size: 12px;">
                                📸 Capture Baseline
                            </button>
                            <button onclick="clearBaseline()" id="smed-clear-baseline" style="padding: 8px 16px; background: transparent; border: 1px solid var(--border); border-radius: 6px; color: var(--text-dim); cursor: pointer; font-size: 12px; display: none;">
                                Clear Baseline
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Changeover Elements -->
                <div class="calc-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <div class="calc-section-title" style="margin: 0;">Changeover Elements</div>
                        <div style="display: flex; gap: 8px; font-size: 11px;">
                            <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 12px; height: 12px; background: #e74c3c; border-radius: 2px;"></span> Internal (machine stopped)</span>
                            <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 12px; height: 12px; background: #4a9f6e; border-radius: 2px;"></span> External (while running)</span>
                        </div>
                    </div>
                    <div class="yamazumi-stations" id="smed-elements"></div>
                    <div style="display: flex; gap: 12px; margin-top: 12px;">
                        <div class="yamazumi-add" onclick="addSMEDElement()" style="flex: 1;">+ Add Element</div>
                        <button onclick="suggestConversions()" style="padding: 8px 16px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer; font-size: 12px;">
                            💡 Suggest Conversions
                        </button>
                    </div>
                </div>

                <!-- Improvement Ideas per Element -->
                <div id="smed-suggestions" class="calc-section" style="display: none; background: rgba(74, 159, 110, 0.05); border-radius: 8px; padding: 16px;">
                    <div class="calc-section-title" style="color: var(--accent);">💡 Conversion Opportunities</div>
                    <div id="smed-suggestions-list" style="font-size: 13px;"></div>
                </div>

                <!-- Results with Before/After -->
                <div class="calc-section">
                    <div class="calc-section-title">Results</div>

                    <!-- Baseline comparison (hidden until baseline captured) -->
                    <div id="smed-baseline-compare" style="display: none; margin-bottom: 20px; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 16px; align-items: center;">
                            <div style="text-align: center;">
                                <div style="font-size: 11px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 4px;">Before</div>
                                <div style="font-size: 24px; font-weight: 600; color: #e74c3c;" id="smed-baseline-total">—</div>
                                <div style="font-size: 11px; color: var(--text-dim);">min internal</div>
                            </div>
                            <div style="font-size: 24px; color: var(--accent);">→</div>
                            <div style="text-align: center;">
                                <div style="font-size: 11px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 4px;">After</div>
                                <div style="font-size: 24px; font-weight: 600; color: #4a9f6e;" id="smed-after-total">—</div>
                                <div style="font-size: 11px; color: var(--text-dim);">min internal</div>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                            <span style="font-size: 14px; font-weight: 600;" id="smed-improvement">—</span>
                        </div>
                    </div>

                    <div class="calc-results">
                        <div class="calc-result-card">
                            <div class="calc-result-label">Current Total</div>
                            <div class="calc-result-value" id="smed-current">45<span class="calc-result-unit">min</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Internal (Machine Stopped)</div>
                            <div class="calc-result-value" id="smed-internal">30<span class="calc-result-unit">min</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">External (While Running)</div>
                            <div class="calc-result-value" id="smed-external">15<span class="calc-result-unit">min</span></div>
                        </div>
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Target (Internal Only)</div>
                            <div class="calc-result-value" id="smed-target">30<span class="calc-result-unit">min</span></div>
                        </div>
                    </div>
                    <div class="calc-breakdown">
                        <div class="calc-breakdown-row">
                            <span>Potential Reduction</span>
                            <span id="smed-reduction">33% (15 min saved)</span>
                        </div>
                        <div class="calc-breakdown-row">
                            <span>SMED Goal</span>
                            <span>Convert internal → external, then reduce both</span>
                        </div>
                    </div>
                </div>

                <!-- Impact Calculator -->
                <div class="calc-section" style="background: var(--bg-secondary); border-radius: 12px; padding: 20px;">
                    <div class="calc-section-title">Impact Calculator</div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px;">
                        <div class="calc-input">
                            <label>Changeovers per Day</label>
                            <input type="number" id="smed-changeovers-day" value="4" oninput="calcSMEDImpact()">
                        </div>
                        <div class="calc-input">
                            <label>Operating Days per Year</label>
                            <input type="number" id="smed-days-year" value="250" oninput="calcSMEDImpact()">
                        </div>
                        <div class="calc-input">
                            <label>Hourly Cost/Value ($)</label>
                            <input type="number" id="smed-hourly-cost" value="150" oninput="calcSMEDImpact()">
                        </div>
                    </div>
                    <div id="smed-impact-results" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                        <div style="text-align: center;">
                            <div style="font-size: 11px; color: var(--text-dim); text-transform: uppercase;">Hours Recovered/Year</div>
                            <div style="font-size: 20px; font-weight: 600; color: var(--accent);" id="smed-hours-saved">—</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 11px; color: var(--text-dim); text-transform: uppercase;">Capacity Gain</div>
                            <div style="font-size: 20px; font-weight: 600; color: var(--accent);" id="smed-capacity-gain">—</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 11px; color: var(--text-dim); text-transform: uppercase;">Annual Value</div>
                            <div style="font-size: 20px; font-weight: 600; color: #4a9f6e;" id="smed-annual-value">—</div>
                        </div>
                    </div>
                </div>

                <!-- Link to Line Simulator -->
                <div class="calc-section" style="background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(74, 159, 110, 0.1) 100%); border: 1px solid var(--accent); border-radius: 12px; padding: 20px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
                        <div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">Apply to Line Simulator</div>
                            <div style="font-size: 12px; color: var(--text-dim); margin-top: 4px;">Push internal time (<span id="smed-internal-seconds">—</span>) as changeover time</div>
                        </div>
                        <button onclick="applySMEDToLineSim()" style="padding: 10px 20px; background: var(--accent); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                            Apply & See Impact
                        </button>
                    </div>
                </div>

                <div class="calc-chart">
                    <div class="calc-chart-title">Changeover Waterfall</div>
                    <div id="smed-chart" style="height: 350px;"></div>
                </div>

                <div class="calc-derivation" id="smed-derivation">
                    <div class="calc-derivation-header" onclick="toggleDerivation('smed-derivation')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        Show Derivation
                    </div>
                    <div class="calc-derivation-body" id="smed-derivation-body">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div id="smed-next-steps" class="calc-next-steps" style="display:none"></div>
            </div>

            <!-- Changeover Matrix -->
            <div class="calc-layout" id="layout-changeover">
                <div class="calc-section">
                    <div class="calc-section-title">Products</div>
                    <div class="calc-inputs" style="max-width: 400px;">
                        <div class="calc-input">
                            <label>Product Names (comma separated)</label>
                            <input type="text" id="changeover-products" value="A, B, C, D" oninput="renderChangeoverMatrix()">
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Changeover Times (minutes)</div>
                    <div id="changeover-matrix" style="overflow-x: auto;"></div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Analysis</div>
                    <div class="calc-results">
                        <div class="calc-result-card">
                            <div class="calc-result-label">Average Changeover</div>
                            <div class="calc-result-value" id="changeover-avg">15<span class="calc-result-unit">min</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Min</div>
                            <div class="calc-result-value" id="changeover-min">5<span class="calc-result-unit">min</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Max</div>
                            <div class="calc-result-value" id="changeover-max">30<span class="calc-result-unit">min</span></div>
                        </div>
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Best Sequence</div>
                            <div class="calc-result-value" id="changeover-best" style="font-size: 18px;">A→B→C→D</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FMEA / RPN -->
            <div class="calc-layout" id="layout-fmea">
                <div class="calc-section">
                    <div class="calc-section-title">Failure Modes</div>
                    <div id="fmea-items" style="display: flex; flex-direction: column; gap: 12px;"></div>
                    <div class="yamazumi-add" onclick="addFMEAItem()" style="margin-top: 12px;">+ Add Failure Mode</div>
                </div>

                <div class="calc-chart">
                    <div class="calc-chart-title">RPN Priority Chart</div>
                    <div id="fmea-chart" style="height: 350px;"></div>
                </div>

                <div class="calc-breakdown" style="margin-top: 20px;">
                    <div class="calc-breakdown-row">
                        <span>RPN Formula</span>
                        <span>Severity × Occurrence × Detection</span>
                    </div>
                    <div class="calc-breakdown-row">
                        <span>Action Threshold</span>
                        <span>RPN > 100 typically requires action</span>
                    </div>
                    <div class="calc-breakdown-row">
                        <span>Scale</span>
                        <span>Each factor: 1 (best) to 10 (worst)</span>
                    </div>
                </div>

                <div class="calc-derivation" id="fmea-derivation">
                    <div class="calc-derivation-header" onclick="toggleDerivation('fmea-derivation')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        Show Derivation
                    </div>
                    <div class="calc-derivation-body" id="fmea-derivation-body">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Cp / Cpk -->
            <div class="calc-layout" id="layout-cpk">
                <div class="calc-section">
                    <div class="calc-section-title">Specification Limits</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>USL (Upper Spec Limit)</label>
                            <input type="number" id="cpk-usl" value="10.5" step="0.01" oninput="calcCpk()">
                        </div>
                        <div class="calc-input">
                            <label>LSL (Lower Spec Limit)</label>
                            <input type="number" id="cpk-lsl" value="9.5" step="0.01" oninput="calcCpk()">
                        </div>
                        <div class="calc-input">
                            <label>Target (optional)</label>
                            <input type="number" id="cpk-target" step="0.01" placeholder="Midpoint" oninput="calcCpk()">
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Process Data</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Process Mean (X̄)</label>
                            <input type="number" id="cpk-mean" value="10.1" step="0.001" oninput="calcCpk()">
                        </div>
                        <div class="calc-input">
                            <label>Process Std Dev (σ)</label>
                            <input type="number" id="cpk-std" value="0.15" step="0.001" oninput="calcCpk()">
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Results</div>
                    <div class="calc-results">
                        <div class="calc-result-card">
                            <div class="calc-result-label">Cp (Potential)</div>
                            <div class="calc-result-value" id="cpk-cp">1.11</div>
                        </div>
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Cpk (Actual)</div>
                            <div class="calc-result-value" id="cpk-cpk">0.89</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Cpu</div>
                            <div class="calc-result-value" id="cpk-cpu">0.89</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Cpl</div>
                            <div class="calc-result-value" id="cpk-cpl">1.33</div>
                        </div>
                    </div>
                    <div class="calc-breakdown">
                        <div class="calc-breakdown-row">
                            <span>Expected Defect Rate</span>
                            <span id="cpk-defects">1.2%</span>
                        </div>
                        <div class="calc-breakdown-row">
                            <span>Assessment</span>
                            <span id="cpk-assessment">Process centered high, reduce variation</span>
                        </div>
                    </div>
                </div>

                <div class="calc-chart">
                    <div class="calc-chart-title">Process Distribution vs Spec Limits</div>
                    <div id="cpk-chart" style="height: 350px;"></div>
                </div>

                <button class="calc-monte-toggle" onclick="toggleCpkMonteCarlo(this)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M8 17v-3"/></svg>
                    Run Monte Carlo Simulation
                </button>
                <div class="calc-monte-results" id="cpk-monte-results">
                    <div class="calc-monte-summary">
                        <div class="calc-monte-stat">
                            <div class="calc-monte-stat-label">Mean Cpk</div>
                            <div class="calc-monte-stat-value" id="cpk-monte-mean">-</div>
                        </div>
                        <div class="calc-monte-stat">
                            <div class="calc-monte-stat-label">5th %ile</div>
                            <div class="calc-monte-stat-value" id="cpk-monte-p5">-</div>
                        </div>
                        <div class="calc-monte-stat">
                            <div class="calc-monte-stat-label">95th %ile</div>
                            <div class="calc-monte-stat-value" id="cpk-monte-p95">-</div>
                        </div>
                        <div class="calc-monte-stat">
                            <div class="calc-monte-stat-label">Std Dev</div>
                            <div class="calc-monte-stat-value" id="cpk-monte-std">-</div>
                        </div>
                    </div>
                    <div id="cpk-monte-chart" style="height: 250px;"></div>
                    <p style="font-size: 11px; color: var(--text-dim); margin-top: 12px; text-align: center;">
                        Varies process mean ±5%, process σ ±10%; spec limits held fixed
                    </p>
                </div>

                <div class="calc-derivation" id="cpk-derivation">
                    <div class="calc-derivation-header" onclick="toggleDerivation('cpk-derivation')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        Show Derivation
                    </div>
                    <div class="calc-derivation-body" id="cpk-derivation-body">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div id="cpk-next-steps" class="calc-next-steps" style="display:none"></div>
            </div>

            <!-- Sample Size -->
            <div class="calc-layout" id="layout-samplesize">
                <div class="calc-section">
                    <div class="calc-section-title">Study Type</div>
                    <div class="calc-inputs" style="max-width: 300px;">
                        <div class="calc-input">
                            <select id="sample-type" onchange="updateSampleForm()">
                                <option value="mean">Estimate Mean (Continuous)</option>
                                <option value="proportion">Estimate Proportion (Attribute)</option>
                                <option value="comparison">Compare Two Means</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Parameters</div>
                    <div class="calc-inputs" id="sample-inputs">
                        <div class="calc-input" id="sample-conf-group">
                            <label>Confidence Level</label>
                            <select id="sample-conf" onchange="calcSampleSize()">
                                <option value="1.645">90%</option>
                                <option value="1.96" selected>95%</option>
                                <option value="2.576">99%</option>
                            </select>
                        </div>
                        <div class="calc-input" id="sample-margin-group">
                            <label>Margin of Error</label>
                            <input type="number" id="sample-margin" value="0.5" step="0.1" oninput="calcSampleSize()">
                            <span class="input-hint">± units or percentage points</span>
                        </div>
                        <div class="calc-input" id="sample-std-group">
                            <label>Estimated Std Dev</label>
                            <input type="number" id="sample-std" value="2" step="0.1" oninput="calcSampleSize()">
                            <span class="input-hint">σ from pilot or history</span>
                        </div>
                        <div class="calc-input" id="sample-prop-group" style="display:none;">
                            <label>Expected Proportion</label>
                            <input type="number" id="sample-prop" value="50" step="1" oninput="calcSampleSize()">
                            <span class="input-hint">% (use 50 if unknown)</span>
                        </div>
                        <div class="calc-input" id="sample-power-group" style="display:none;">
                            <label>Power</label>
                            <select id="sample-power" onchange="calcSampleSize()">
                                <option value="0.84">80%</option>
                                <option value="1.28" selected>90%</option>
                                <option value="1.645">95%</option>
                            </select>
                        </div>
                        <div class="calc-input" id="sample-effect-group" style="display:none;">
                            <label>Minimum Detectable Difference</label>
                            <input type="number" id="sample-effect" value="1" step="0.1" oninput="calcSampleSize()">
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Result</div>
                    <div class="calc-results">
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Required Sample Size</div>
                            <div class="calc-result-value" id="sample-result">62<span class="calc-result-unit" id="sample-unit">samples</span></div>
                        </div>
                    </div>
                    <div class="calc-breakdown">
                        <div class="calc-breakdown-row">
                            <span>Formula</span>
                            <span id="sample-formula">n = (Zσ/E)²</span>
                        </div>
                    </div>
                </div>

                <div class="calc-derivation" id="samplesize-derivation">
                    <div class="calc-derivation-header" onclick="toggleDerivation('samplesize-derivation')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        Show Derivation
                    </div>
                    <div class="calc-derivation-body" id="samplesize-derivation-body">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Line Efficiency -->
            <div class="calc-layout" id="layout-lineeff">
                <div class="calc-section">
                    <div class="calc-section-title">Inputs</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Theoretical Rate</label>
                            <input type="number" id="lineeff-theoretical" value="500" oninput="calcLineEff()">
                            <span class="input-hint">units per hour (nameplate)</span>
                        </div>
                        <div class="calc-input">
                            <label>Scheduled Time</label>
                            <input type="number" id="lineeff-scheduled" value="480" oninput="calcLineEff()">
                            <span class="input-hint">minutes</span>
                        </div>
                        <div class="calc-input">
                            <label>Actual Output</label>
                            <input type="number" id="lineeff-actual" value="3200" oninput="calcLineEff()">
                            <span class="input-hint">good units produced</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Loss Categories (minutes)</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Planned Downtime</label>
                            <input type="number" id="lineeff-planned" value="30" oninput="calcLineEff()">
                            <span class="input-hint">breaks, meetings</span>
                        </div>
                        <div class="calc-input">
                            <label>Unplanned Downtime</label>
                            <input type="number" id="lineeff-unplanned" value="45" oninput="calcLineEff()">
                            <span class="input-hint">breakdowns, jams</span>
                        </div>
                        <div class="calc-input">
                            <label>Changeover
                                <button class="calc-pull-btn" data-link-from="changeoverInternal" onclick="SvendOps.pull('changeoverInternal', 'lineeff-changeover')" title="Pull from SMED calculator">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                                    ← SMED
                                </button>
                            </label>
                            <input type="number" id="lineeff-changeover" value="20" oninput="calcLineEff()">
                        </div>
                        <div class="calc-input">
                            <label>Minor Stops</label>
                            <input type="number" id="lineeff-minor" value="15" oninput="calcLineEff()">
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Results</div>
                    <div class="calc-results">
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Line Efficiency</div>
                            <div class="calc-result-value" id="lineeff-result">80.0<span class="calc-result-unit">%</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Actual Rate</div>
                            <div class="calc-result-value" id="lineeff-rate">400<span class="calc-result-unit">/hr</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Lost Units</div>
                            <div class="calc-result-value" id="lineeff-lost">800</div>
                        </div>
                    </div>
                </div>

                <div class="calc-chart">
                    <div class="calc-chart-title">Time Loss Waterfall</div>
                    <div id="lineeff-chart" style="height: 350px;"></div>
                </div>

                <div class="calc-derivation" id="lineeff-derivation">
                    <div class="calc-derivation-header" onclick="toggleDerivation('lineeff-derivation')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        Show Derivation
                    </div>
                    <div class="calc-derivation-body" id="lineeff-derivation-body">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- OLE -->
            <div class="calc-layout" id="layout-ole">
                <div class="calc-section">
                    <div class="calc-section-title">Availability Inputs</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Scheduled Hours</label>
                            <input type="number" id="ole-scheduled" value="8" step="0.1" oninput="calcOLE()">
                        </div>
                        <div class="calc-input">
                            <label>Absenteeism</label>
                            <input type="number" id="ole-absent" value="0.5" step="0.1" oninput="calcOLE()">
                            <span class="input-hint">hours</span>
                        </div>
                        <div class="calc-input">
                            <label>Unplanned Breaks</label>
                            <input type="number" id="ole-breaks" value="0.3" step="0.1" oninput="calcOLE()">
                            <span class="input-hint">hours</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Performance Inputs</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Standard Output</label>
                            <input type="number" id="ole-standard" value="100" oninput="calcOLE()">
                            <span class="input-hint">units per available hour</span>
                        </div>
                        <div class="calc-input">
                            <label>Actual Output</label>
                            <input type="number" id="ole-actual" value="650" oninput="calcOLE()">
                            <span class="input-hint">total units</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Quality Inputs</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Good Units</label>
                            <input type="number" id="ole-good" value="620" oninput="calcOLE()">
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">OLE Score</div>
                    <div class="oee-display" style="margin-bottom: 0;">
                        <div class="oee-value" id="ole-result">72.5%</div>
                        <div class="oee-label">Overall Labor Effectiveness</div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">The Three Pillars</div>
                    <div class="oee-factors">
                        <div class="oee-factor">
                            <div class="oee-factor-value" id="ole-availability">90.0%</div>
                            <div class="oee-factor-label">Availability</div>
                            <div style="font-size:11px; color:var(--text-dim); margin-top:8px; line-height:1.4;">
                                Scheduled time actually worked. Losses: absenteeism, tardiness, unplanned breaks, unauthorized time away.
                            </div>
                        </div>
                        <div class="oee-factor">
                            <div class="oee-factor-value" id="ole-performance">90.3%</div>
                            <div class="oee-factor-label">Performance</div>
                            <div style="font-size:11px; color:var(--text-dim); margin-top:8px; line-height:1.4;">
                                Actual output vs. expected rate. Losses: skill gaps, inadequate training, poor tools, process confusion.
                            </div>
                        </div>
                        <div class="oee-factor">
                            <div class="oee-factor-value" id="ole-quality">95.4%</div>
                            <div class="oee-factor-label">Quality</div>
                            <div style="font-size:11px; color:var(--text-dim); margin-top:8px; line-height:1.4;">
                                Good output vs. total output. Losses: errors, rework, customer complaints, defective work product.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Loss Breakdown</div>
                    <div style="max-width: 420px; margin: 0 auto;">
                        <div id="ole-chart" style="height: 320px;"></div>
                    </div>
                    <div class="calc-breakdown" style="margin-top: 20px;">
                        <div class="calc-breakdown-row">
                            <span>Available Hours</span>
                            <span id="ole-avail-hours">7.2 hrs</span>
                        </div>
                        <div class="calc-breakdown-row">
                            <span>Good Units</span>
                            <span id="ole-good-display">620 units</span>
                        </div>
                        <div class="calc-breakdown-row">
                            <span>World Class Benchmark</span>
                            <span>85%</span>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:20px;">
                        <div style="padding:16px; background:var(--bg-secondary); border-radius:10px; border-left: 3px solid var(--accent-primary);">
                            <div style="font-size:12px; font-weight:600; color:var(--text-primary); margin-bottom:8px;">Reading OLE</div>
                            <div style="font-size:11px; color:var(--text-dim); line-height:1.5;">
                                <b>85%+</b> &mdash; World class. Workforce fully utilized and effective.<br>
                                <b>65&ndash;85%</b> &mdash; Typical. Look at which pillar is dragging.<br>
                                <b>&lt;65%</b> &mdash; Major losses. Often a training or scheduling problem.
                            </div>
                        </div>
                        <div style="padding:16px; background:var(--bg-secondary); border-radius:10px; border-left: 3px solid #f39c12;">
                            <div style="font-size:12px; font-weight:600; color:var(--text-primary); margin-bottom:8px;">OLE vs. OEE</div>
                            <div style="font-size:11px; color:var(--text-dim); line-height:1.5;">
                                OEE measures <em>equipment</em> losses; OLE measures <em>human</em> losses. A line can have
                                high OEE but low OLE if machines run fine but operators are underutilized, poorly trained,
                                or frequently absent. Use both together&mdash;improving one pillar in isolation often
                                just shifts the constraint.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="calc-derivation" id="ole-derivation">
                    <div class="calc-derivation-header" onclick="toggleDerivation('ole-derivation')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        Show Derivation
                    </div>
                    <div class="calc-derivation-body" id="ole-derivation-body">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Cycle Time Study -->
            <div class="calc-layout" id="layout-cycletime">
                <div class="calc-section">
                    <div class="calc-section-title">Work Elements</div>
                    <div id="cycletime-elements" style="display: flex; flex-direction: column; gap: 8px;"></div>
                    <div class="yamazumi-add" onclick="addCycleElement()" style="margin-top: 12px;">+ Add Element</div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Results</div>
                    <div class="calc-results">
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Total Cycle Time</div>
                            <div class="calc-result-value" id="cycle-total">120<span class="calc-result-unit">sec</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Value-Add</div>
                            <div class="calc-result-value" id="cycle-va">60<span class="calc-result-unit">sec</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Non Value-Add</div>
                            <div class="calc-result-value" id="cycle-nva">40<span class="calc-result-unit">sec</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Wait</div>
                            <div class="calc-result-value" id="cycle-wait">20<span class="calc-result-unit">sec</span></div>
                        </div>
                    </div>
                    <div class="calc-breakdown">
                        <div class="calc-breakdown-row">
                            <span>VA Ratio</span>
                            <span id="cycle-va-pct">50%</span>
                        </div>
                        <div class="calc-breakdown-row">
                            <span>Waste (NVA + Wait)</span>
                            <span id="cycle-waste-pct">50%</span>
                        </div>
                    </div>
                </div>

                <div class="calc-chart">
                    <div class="calc-chart-title">Time Breakdown</div>
                    <div id="cycletime-chart" style="height: 350px;"></div>
                </div>

                <div class="calc-derivation" id="cycletime-derivation">
                    <div class="calc-derivation-header" onclick="toggleDerivation('cycletime-derivation')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        Show Derivation
                    </div>
                    <div class="calc-derivation-body" id="cycletime-derivation-body">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Before / After -->
            <div class="calc-layout" id="layout-beforeafter">
                <div class="calc-section">
                    <div class="calc-section-title">Metrics</div>
                    <div id="beforeafter-metrics" style="display: flex; flex-direction: column; gap: 12px;"></div>
                    <div class="yamazumi-add" onclick="addBAMetric()" style="margin-top: 12px;">+ Add Metric</div>
                </div>

                <div class="calc-chart">
                    <div class="calc-chart-title">Improvement Summary</div>
                    <div id="beforeafter-chart" style="height: 350px;"></div>
                </div>
            </div>

            <!-- Heijunka -->
            <div class="calc-layout" id="layout-heijunka">
                <div class="calc-section">
                    <div class="calc-section-title">Production Parameters</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Available Time per Day</label>
                            <input type="number" id="heijunka-time" value="480" oninput="calcHeijunka()">
                            <span class="input-hint">minutes</span>
                        </div>
                        <div class="calc-input">
                            <label>Pitch Interval
                                <button class="calc-pull-btn" data-link-from="pitch" onclick="SvendOps.pull('pitch', 'heijunka-pitch')" title="Pull from Pitch calculator">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                                    ← Pitch
                                </button>
                            </label>
                            <input type="number" id="heijunka-pitch" value="20" oninput="calcHeijunka()">
                            <span class="input-hint">minutes</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Product Mix (Daily Demand)</div>
                    <div id="heijunka-products" style="display: flex; flex-direction: column; gap: 8px;"></div>
                    <div class="yamazumi-add" onclick="addHeijunkaProduct()" style="margin-top: 12px;">+ Add Product</div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Leveled Sequence</div>
                    <div class="calc-results">
                        <div class="calc-result-card">
                            <div class="calc-result-label">Pitch Intervals</div>
                            <div class="calc-result-value" id="heijunka-intervals">24</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Total Units</div>
                            <div class="calc-result-value" id="heijunka-total">240</div>
                        </div>
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Units per Pitch</div>
                            <div class="calc-result-value" id="heijunka-per-pitch">10</div>
                        </div>
                    </div>
                    <div class="calc-breakdown">
                        <div class="calc-breakdown-row">
                            <span>Repeating Pattern</span>
                            <span id="heijunka-pattern">AABBC (repeats 24×)</span>
                        </div>
                    </div>
                </div>

                <div class="calc-chart">
                    <div class="calc-chart-title">Heijunka Box (First 10 Intervals)</div>
                    <div id="heijunka-chart" style="height: 350px;"></div>
                </div>

                <div class="calc-derivation" id="heijunka-derivation">
                    <div class="calc-derivation-header" onclick="toggleDerivation('heijunka-derivation')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        Show Derivation
                    </div>
                    <div class="calc-derivation-body" id="heijunka-derivation-body">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- ============================================================ -->
            <!-- SCHEDULING TOOLS -->
            <!-- ============================================================ -->

            <!-- Job Sequencer -->
            <div class="calc-layout" id="layout-sequencer">
                <div class="calc-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <div class="calc-section-title" style="margin: 0;">Jobs</div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="loadSampleJobs()" style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer; font-size: 12px;">
                                Load Sample
                            </button>
                            <button class="calc-pull-btn standalone" onclick="pullJobsFromLineSim()" title="Pull orders from Line Simulator">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                                ← Line Sim
                            </button>
                        </div>
                    </div>
                    <div id="sequencer-jobs" class="yamazumi-stations"></div>
                    <div class="yamazumi-add" onclick="addSequencerJob()" style="margin-top: 12px;">+ Add Job</div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Schedule (Drag to Reorder)</div>
                    <div id="sequencer-gantt" style="min-height: 200px; background: var(--bg-secondary); border-radius: 8px; padding: 16px; overflow-x: auto;">
                        <!-- Gantt chart rendered here -->
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Metrics</div>
                    <div class="calc-results">
                        <div class="calc-result-card">
                            <div class="calc-result-label">Makespan</div>
                            <div class="calc-result-value" id="seq-makespan">0<span class="calc-result-unit">min</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Total Flow Time</div>
                            <div class="calc-result-value" id="seq-flowtime">0<span class="calc-result-unit">min</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Total Setup</div>
                            <div class="calc-result-value" id="seq-setup">0<span class="calc-result-unit">min</span></div>
                        </div>
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Jobs Late</div>
                            <div class="calc-result-value" id="seq-late">0</div>
                        </div>
                    </div>
                    <div class="calc-breakdown" style="margin-top: 16px;">
                        <div class="calc-breakdown-row">
                            <span>Total Tardiness</span>
                            <span id="seq-tardiness">0 min (0 jobs late)</span>
                        </div>
                        <div class="calc-breakdown-row">
                            <span>Avg Flow Time</span>
                            <span id="seq-avg-flow">0 min</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section" style="background: linear-gradient(135deg, rgba(74, 159, 110, 0.1) 0%, rgba(52, 152, 219, 0.1) 100%); border: 1px solid var(--accent); border-radius: 12px; padding: 16px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
                        <div>
                            <div style="font-size: 14px; font-weight: 600;">Push to Line Simulator</div>
                            <div style="font-size: 12px; color: var(--text-dim);">Create orders from job sequence</div>
                        </div>
                        <button onclick="pushSequenceToLineSim()" style="padding: 8px 16px; background: var(--accent); border: none; border-radius: 6px; color: white; font-weight: 500; cursor: pointer;">
                            Push & Simulate →
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sequence Optimizer -->
            <div class="calc-layout" id="layout-seq-optimizer">
                <div class="calc-section">
                    <div class="calc-section-title">Optimization Settings</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Objective</label>
                            <select id="opt-objective" onchange="runSequenceOptimizer()" style="padding: 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                <option value="setup">Minimize Total Setup Time</option>
                                <option value="tardiness">Minimize Total Tardiness</option>
                                <option value="makespan">Minimize Makespan</option>
                                <option value="flowtime">Minimize Avg Flow Time</option>
                            </select>
                        </div>
                        <div class="calc-input">
                            <label>Algorithm</label>
                            <select id="opt-algorithm" onchange="runSequenceOptimizer()" style="padding: 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                <option value="nearest">Nearest Neighbor (Fast)</option>
                                <option value="2opt">2-Opt Improvement (Better)</option>
                                <option value="edd">Earliest Due Date</option>
                                <option value="spt">Shortest Processing Time</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 16px; display: flex; gap: 8px;">
                        <button onclick="runSequenceOptimizer()" style="padding: 10px 20px; background: var(--accent); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; flex: 1;">
                            Optimize Sequence
                        </button>
                        <button class="calc-pull-btn standalone" onclick="pullFromSequencer()" title="Pull jobs from Job Sequencer">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                            ← Sequencer
                        </button>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Comparison</div>
                    <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: start;">
                        <!-- Current -->
                        <div style="background: var(--bg-secondary); border-radius: 8px; padding: 16px;">
                            <div style="font-size: 12px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 8px;">Current Sequence</div>
                            <div id="opt-current-seq" style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; word-break: break-word;">—</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                                <div>Setup: <span id="opt-current-setup" style="color: #e74c3c; font-weight: 600;">—</span></div>
                                <div>Tardiness: <span id="opt-current-tard" style="color: var(--text-secondary);">—</span></div>
                                <div>Makespan: <span id="opt-current-make" style="color: var(--text-secondary);">—</span></div>
                                <div>Avg Flow: <span id="opt-current-flow" style="color: var(--text-secondary);">—</span></div>
                            </div>
                        </div>
                        <!-- Arrow -->
                        <div style="font-size: 24px; color: var(--accent); padding-top: 40px;">→</div>
                        <!-- Optimized -->
                        <div style="background: rgba(74, 159, 110, 0.1); border: 1px solid var(--accent); border-radius: 8px; padding: 16px;">
                            <div style="font-size: 12px; color: var(--accent); text-transform: uppercase; margin-bottom: 8px;">Optimized Sequence</div>
                            <div id="opt-new-seq" style="font-size: 13px; color: var(--text-primary); margin-bottom: 12px; word-break: break-word;">—</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                                <div>Setup: <span id="opt-new-setup" style="color: #4a9f6e; font-weight: 600;">—</span></div>
                                <div>Tardiness: <span id="opt-new-tard" style="color: var(--text-secondary);">—</span></div>
                                <div>Makespan: <span id="opt-new-make" style="color: var(--text-secondary);">—</span></div>
                                <div>Avg Flow: <span id="opt-new-flow" style="color: var(--text-secondary);">—</span></div>
                            </div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                        <span style="font-size: 14px; font-weight: 600;" id="opt-improvement">Run optimizer to see improvement</span>
                    </div>
                </div>

                <div class="calc-section">
                    <div style="display: flex; gap: 8px;">
                        <button onclick="applyOptimizedSequence()" style="padding: 10px 20px; background: var(--accent); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; flex: 1;">
                            Apply to Job Sequencer
                        </button>
                    </div>
                </div>
            </div>

            <!-- Capacity Load Chart -->
            <div class="calc-layout" id="layout-capacity-load">
                <div class="calc-section">
                    <div class="calc-section-title">Capacity Settings</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Available Hours per Day</label>
                            <input type="number" id="cap-hours-day" value="8" oninput="calcCapacityLoad()">
                        </div>
                        <div class="calc-input">
                            <label>Days to Show</label>
                            <input type="number" id="cap-days" value="10" min="5" max="30" oninput="calcCapacityLoad()">
                        </div>
                        <div class="calc-input">
                            <label>Efficiency Factor</label>
                            <input type="number" id="cap-efficiency" value="85" min="1" max="100" oninput="calcCapacityLoad()">
                            <span class="input-hint">% of theoretical</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <div class="calc-section-title" style="margin: 0;">Work Orders</div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="loadSampleWorkOrders()" style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer; font-size: 12px;">
                                Load Sample
                            </button>
                            <button class="calc-pull-btn standalone" onclick="pullFromSequencerToCapacity()" title="Pull jobs from Job Sequencer">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                                ← Sequencer
                            </button>
                        </div>
                    </div>
                    <div id="capacity-orders" class="yamazumi-stations"></div>
                    <div class="yamazumi-add" onclick="addCapacityOrder()" style="margin-top: 12px;">+ Add Work Order</div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Results</div>
                    <div class="calc-results">
                        <div class="calc-result-card">
                            <div class="calc-result-label">Total Load</div>
                            <div class="calc-result-value" id="cap-total-load">0<span class="calc-result-unit">hrs</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Available Capacity</div>
                            <div class="calc-result-value" id="cap-available">0<span class="calc-result-unit">hrs</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Utilization</div>
                            <div class="calc-result-value" id="cap-utilization">0<span class="calc-result-unit">%</span></div>
                        </div>
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Days Overloaded</div>
                            <div class="calc-result-value" id="cap-overload-days">0</div>
                        </div>
                    </div>
                </div>

                <div class="calc-chart">
                    <div class="calc-chart-title">Capacity Load by Day</div>
                    <div id="capacity-chart" style="height: 350px;"></div>
                </div>

                <div class="calc-derivation" id="capacity-load-derivation">
                    <div class="calc-derivation-header" onclick="toggleDerivation('capacity-load-derivation')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        Show Derivation
                    </div>
                    <div class="calc-derivation-body" id="capacity-load-derivation-body">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Mixed-Model Sequencer -->
            <div class="calc-layout" id="layout-mixed-model">
                <div class="calc-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <div class="calc-section-title" style="margin: 0;">Product Mix</div>
                        <button class="calc-pull-btn standalone" onclick="pullFromHeijunka()" title="Pull product mix from Heijunka">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                            ← Heijunka
                        </button>
                    </div>
                    <div id="mixed-products" class="yamazumi-stations"></div>
                    <div class="yamazumi-add" onclick="addMixedProduct()" style="margin-top: 12px;">+ Add Product</div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Sequencing Method</div>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="radio" name="mix-method" value="ratio" checked onchange="calcMixedModel()">
                            <span>Ratio-Based (Toyota)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="radio" name="mix-method" value="smooth" onchange="calcMixedModel()">
                            <span>Goal Chasing</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="radio" name="mix-method" value="batch" onchange="calcMixedModel()">
                            <span>Batched (Compare)</span>
                        </label>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Generated Sequence</div>
                    <div id="mixed-sequence" style="display: flex; flex-wrap: wrap; gap: 4px; padding: 16px; background: var(--bg-secondary); border-radius: 8px; min-height: 60px;">
                        <!-- Sequence blocks rendered here -->
                    </div>
                    <div class="calc-breakdown" style="margin-top: 16px;">
                        <div class="calc-breakdown-row">
                            <span>Sequence Length</span>
                            <span id="mixed-length">0 units</span>
                        </div>
                        <div class="calc-breakdown-row">
                            <span>Max Consecutive Same</span>
                            <span id="mixed-max-consec">0</span>
                        </div>
                        <div class="calc-breakdown-row">
                            <span>Smoothness Index</span>
                            <span id="mixed-smoothness">—</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section" style="background: linear-gradient(135deg, rgba(74, 159, 110, 0.1) 0%, rgba(52, 152, 219, 0.1) 100%); border: 1px solid var(--accent); border-radius: 12px; padding: 16px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
                        <div>
                            <div style="font-size: 14px; font-weight: 600;">Push to Line Simulator</div>
                            <div style="font-size: 12px; color: var(--text-dim);">Create orders from leveled sequence</div>
                        </div>
                        <button onclick="pushMixedToLineSim()" style="padding: 8px 16px; background: var(--accent); border: none; border-radius: 6px; color: white; font-weight: 500; cursor: pointer;">
                            Push & Simulate →
                        </button>
                    </div>
                </div>

                <div class="calc-chart">
                    <div class="calc-chart-title">Production Pattern Comparison</div>
                    <div id="mixed-chart" style="height: 300px;"></div>
                </div>
            </div>

            <!-- Due Date Risk Simulator -->
            <div class="calc-layout" id="layout-due-date-sim">
                <div class="calc-section">
                    <div class="calc-section-title">Simulation Parameters</div>
                    <div class="calc-inputs">
                        <div class="calc-input">
                            <label>Processing Time Variation (CV)</label>
                            <input type="number" id="dds-cv" value="0.15" step="0.05" min="0" max="1" oninput="runDueDateSim()">
                            <span class="input-hint">coefficient of variation</span>
                        </div>
                        <div class="calc-input">
                            <label>Breakdown Probability</label>
                            <input type="number" id="dds-breakdown" value="5" min="0" max="50" oninput="runDueDateSim()">
                            <span class="input-hint">% per day</span>
                        </div>
                        <div class="calc-input">
                            <label>Avg Breakdown Duration</label>
                            <input type="number" id="dds-breakdown-dur" value="60" oninput="runDueDateSim()">
                            <span class="input-hint">minutes</span>
                        </div>
                        <div class="calc-input">
                            <label>Simulations</label>
                            <input type="number" id="dds-runs" value="500" min="100" max="5000" step="100">
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <div class="calc-section-title" style="margin: 0;">Orders</div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="loadSampleDDSOrders()" style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer; font-size: 12px;">
                                Load Sample
                            </button>
                            <button class="calc-pull-btn standalone" onclick="pullFromSequencerToDDS()" title="Pull jobs from Job Sequencer">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                                ← Sequencer
                            </button>
                        </div>
                    </div>
                    <div id="dds-orders" class="yamazumi-stations"></div>
                    <div class="yamazumi-add" onclick="addDDSOrder()" style="margin-top: 12px;">+ Add Order</div>
                </div>

                <div class="calc-section">
                    <button onclick="runDueDateSim()" style="width: 100%; padding: 12px; background: var(--accent); border: none; border-radius: 8px; color: white; font-weight: 600; font-size: 14px; cursor: pointer;">
                        Run Monte Carlo Simulation
                    </button>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Results</div>
                    <div class="calc-results">
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Overall On-Time %</div>
                            <div class="calc-result-value" id="dds-otd">—<span class="calc-result-unit">%</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Avg Days Early/Late</div>
                            <div class="calc-result-value" id="dds-avg-delta">—</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Worst Case (95%)</div>
                            <div class="calc-result-value" id="dds-worst">—</div>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Per-Order Risk</div>
                    <div id="dds-order-results" style="display: grid; gap: 8px;">
                        <!-- Order results rendered here -->
                    </div>
                </div>

                <div class="calc-chart">
                    <div class="calc-chart-title">Completion Time Distribution</div>
                    <div id="dds-chart" style="height: 300px;"></div>
                </div>
            </div>

            <!-- ============================================================ -->
            <!-- METHOD TOOLS -->
            <!-- ============================================================ -->

            <!-- House of Quality (QFD) -->
            <div class="calc-layout" id="layout-qfd">
                <!-- Phase Navigation -->
                <div class="calc-section" style="padding: 0; background: transparent;">
                    <div style="display: flex; border-bottom: 2px solid var(--border); margin-bottom: 20px;">
                        <button onclick="setQFDPhase(1)" id="qfd-tab-1" class="qfd-tab active" style="flex: 1; padding: 12px; background: transparent; border: none; border-bottom: 2px solid var(--accent); margin-bottom: -2px; color: var(--accent); font-weight: 600; cursor: pointer;">
                            1. House of Quality
                        </button>
                        <button onclick="setQFDPhase(2)" id="qfd-tab-2" class="qfd-tab" style="flex: 1; padding: 12px; background: transparent; border: none; border-bottom: 2px solid transparent; margin-bottom: -2px; color: var(--text-dim); cursor: pointer;">
                            2. Part Deployment
                        </button>
                        <button onclick="setQFDPhase(3)" id="qfd-tab-3" class="qfd-tab" style="flex: 1; padding: 12px; background: transparent; border: none; border-bottom: 2px solid transparent; margin-bottom: -2px; color: var(--text-dim); cursor: pointer;">
                            3. Process Planning
                        </button>
                        <button onclick="setQFDPhase(4)" id="qfd-tab-4" class="qfd-tab" style="flex: 1; padding: 12px; background: transparent; border: none; border-bottom: 2px solid transparent; margin-bottom: -2px; color: var(--text-dim); cursor: pointer;">
                            4. Production Control
                        </button>
                    </div>
                </div>

                <!-- Phase 1: House of Quality -->
                <div id="qfd-phase-1" class="qfd-phase">
                    <div class="calc-section">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                            <div class="calc-section-title" style="margin: 0;">Customer Requirements (WHATs)</div>
                            <button onclick="loadSampleQFD()" style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer; font-size: 12px;">
                                Load Example
                            </button>
                        </div>
                        <div id="qfd-whats" class="yamazumi-stations"></div>
                        <div class="yamazumi-add" onclick="addQFDWhat()" style="margin-top: 8px;">+ Add Requirement</div>
                    </div>

                    <div class="calc-section">
                        <div class="calc-section-title">Engineering Characteristics (HOWs)</div>
                        <div id="qfd-hows" class="yamazumi-stations"></div>
                        <div class="yamazumi-add" onclick="addQFDHow()" style="margin-top: 8px;">+ Add Characteristic</div>
                    </div>

                    <div class="calc-section">
                        <div class="calc-section-title">Relationship Matrix & Correlation Roof</div>
                        <div id="qfd-matrix" style="overflow-x: auto;"></div>
                    </div>

                    <div class="calc-section">
                        <div class="calc-section-title">Priority Analysis</div>
                        <div class="calc-results">
                            <div class="calc-result-card">
                                <div class="calc-result-label">Top Priority HOW</div>
                                <div class="calc-result-value" id="qfd-top-how" style="font-size: 16px;">—</div>
                            </div>
                            <div class="calc-result-card">
                                <div class="calc-result-label">Coverage</div>
                                <div class="calc-result-value" id="qfd-coverage">—<span class="calc-result-unit">%</span></div>
                            </div>
                            <div class="calc-result-card">
                                <div class="calc-result-label">Conflicts</div>
                                <div class="calc-result-value" id="qfd-conflicts">0</div>
                            </div>
                        </div>
                        <div id="qfd-priority-chart" style="height: 200px; margin-top: 16px;"></div>
                    </div>

                    <div style="display: flex; justify-content: flex-end; margin-top: 16px;">
                        <button onclick="cascadeToPhase2()" style="padding: 10px 20px; background: var(--accent); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer;">
                            Cascade to Part Deployment →
                        </button>
                    </div>
                </div>

                <!-- Phase 2: Part Deployment -->
                <div id="qfd-phase-2" class="qfd-phase" style="display: none;">
                    <div class="calc-section">
                        <div class="calc-section-title">Engineering Characteristics (from Phase 1)</div>
                        <div id="qfd-phase2-inputs" style="display: flex; flex-wrap: wrap; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; min-height: 40px;">
                            <!-- Populated from Phase 1 -->
                        </div>
                    </div>

                    <div class="calc-section">
                        <div class="calc-section-title">Part Characteristics</div>
                        <div id="qfd-parts" class="yamazumi-stations"></div>
                        <div class="yamazumi-add" onclick="addQFDPart()" style="margin-top: 8px;">+ Add Part Characteristic</div>
                    </div>

                    <div class="calc-section">
                        <div class="calc-section-title">Deployment Matrix</div>
                        <div id="qfd-matrix-2" style="overflow-x: auto;"></div>
                    </div>

                    <div style="display: flex; justify-content: space-between; margin-top: 16px;">
                        <button onclick="setQFDPhase(1)" style="padding: 10px 20px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer;">
                            ← Back to House of Quality
                        </button>
                        <button onclick="cascadeToPhase3()" style="padding: 10px 20px; background: var(--accent); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer;">
                            Cascade to Process Planning →
                        </button>
                    </div>
                </div>

                <!-- Phase 3: Process Planning -->
                <div id="qfd-phase-3" class="qfd-phase" style="display: none;">
                    <div class="calc-section">
                        <div class="calc-section-title">Part Characteristics (from Phase 2)</div>
                        <div id="qfd-phase3-inputs" style="display: flex; flex-wrap: wrap; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; min-height: 40px;">
                            <!-- Populated from Phase 2 -->
                        </div>
                    </div>

                    <div class="calc-section">
                        <div class="calc-section-title">Process Parameters</div>
                        <div id="qfd-processes" class="yamazumi-stations"></div>
                        <div class="yamazumi-add" onclick="addQFDProcess()" style="margin-top: 8px;">+ Add Process Parameter</div>
                    </div>

                    <div class="calc-section">
                        <div class="calc-section-title">Process Matrix</div>
                        <div id="qfd-matrix-3" style="overflow-x: auto;"></div>
                    </div>

                    <div style="display: flex; justify-content: space-between; margin-top: 16px;">
                        <button onclick="setQFDPhase(2)" style="padding: 10px 20px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer;">
                            ← Back to Part Deployment
                        </button>
                        <button onclick="cascadeToPhase4()" style="padding: 10px 20px; background: var(--accent); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer;">
                            Cascade to Production Control →
                        </button>
                    </div>
                </div>

                <!-- Phase 4: Production Planning -->
                <div id="qfd-phase-4" class="qfd-phase" style="display: none;">
                    <div class="calc-section">
                        <div class="calc-section-title">Process Parameters (from Phase 3)</div>
                        <div id="qfd-phase4-inputs" style="display: flex; flex-wrap: wrap; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; min-height: 40px;">
                            <!-- Populated from Phase 3 -->
                        </div>
                    </div>

                    <div class="calc-section">
                        <div class="calc-section-title">Production Controls</div>
                        <div id="qfd-controls" class="yamazumi-stations"></div>
                        <div class="yamazumi-add" onclick="addQFDControl()" style="margin-top: 8px;">+ Add Control Point</div>
                    </div>

                    <div class="calc-section">
                        <div class="calc-section-title">Control Matrix</div>
                        <div id="qfd-matrix-4" style="overflow-x: auto;"></div>
                    </div>

                    <div class="calc-section" style="background: linear-gradient(135deg, rgba(74, 159, 110, 0.1) 0%, rgba(232, 197, 71, 0.1) 100%); border: 1px solid var(--accent); border-radius: 12px; padding: 20px;">
                        <div class="calc-section-title" style="color: var(--accent);">Full Traceability</div>
                        <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
                            Customer requirements now trace through engineering specs → part characteristics → process parameters → production controls.
                            Any control point can be traced back to the original customer need it serves.
                        </div>
                        <button onclick="exportQFDTrace()" style="margin-top: 12px; padding: 8px 16px; background: var(--accent); border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 12px;">
                            Export Traceability Matrix
                        </button>
                    </div>

                    <div style="display: flex; justify-content: flex-start; margin-top: 16px;">
                        <button onclick="setQFDPhase(3)" style="padding: 10px 20px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer;">
                            ← Back to Process Planning
                        </button>
                    </div>
                </div>
            </div>

            <!-- ============================================================ -->
            <!-- SIMULATORS -->
            <!-- ============================================================ -->

            <!-- Kanban Pull System Simulator -->
            <div class="calc-layout" id="layout-kanban-sim">
                <div class="calc-section">
                    <div class="calc-section-title">Configuration</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; max-width: 700px;">
                        <div class="calc-input">
                            <label>Mode</label>
                            <div style="display: flex; gap: 0; border-radius: 8px; overflow: hidden; border: 1px solid var(--border);">
                                <button id="ks-mode-push" onclick="setKanbanMode('push')" style="flex:1; padding: 10px; background: var(--bg-secondary); border: none; color: var(--text-dim); cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.15s;">PUSH</button>
                                <button id="ks-mode-pull" onclick="setKanbanMode('pull')" style="flex:1; padding: 10px; background: rgba(74,159,110,0.2); border: none; color: var(--accent); cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.15s;">PULL</button>
                            </div>
                        </div>
                        <div class="calc-input">
                            <label>Kanban Cards per Loop</label>
                            <input type="number" id="ks-kanban-cards" value="3" min="1" max="10" oninput="updateKanbanParams()">
                            <span class="input-hint" id="ks-kanban-hint">cards per supermarket (PULL only)</span>
                        </div>
                        <div class="calc-input">
                            <label>Customer Demand Interval</label>
                            <input type="number" id="ks-demand-interval" value="50" min="10" max="200" step="5" oninput="updateKanbanParams()">
                            <span class="input-hint">seconds between customer pulls</span>
                        </div>
                        <div class="calc-input">
                            <label>Variability (CoV)</label>
                            <input type="range" id="ks-cov" min="0" max="50" value="20" oninput="document.getElementById('ks-cov-label').textContent = this.value + '%'">
                            <span class="input-hint" id="ks-cov-label">20%</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Stations</div>
                    <div id="ks-stations" style="display: flex; flex-direction: column; gap: 8px;"></div>
                    <div style="margin-top: 8px; font-size: 11px; color: var(--text-dim);">Cycle time in seconds per unit</div>
                </div>

                <div class="calc-section">
                    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                        <button id="ks-start" onclick="startKanbanSim()" style="padding: 10px 24px; background: var(--accent); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600; font-size: 14px;">&#9654; Start</button>
                        <button onclick="resetKanbanSim()" style="padding: 10px 20px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-secondary); cursor: pointer;">Reset</button>
                        <div style="display: flex; align-items: center; gap: 8px; margin-left: auto;">
                            <span style="font-size: 12px; color: var(--text-dim);">Speed:</span>
                            <input type="range" id="ks-speed" min="1" max="10" value="5" style="width: 100px;">
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Live Visualization</div>
                    <div id="ks-visual" style="background: var(--bg-secondary); border-radius: 12px; padding: 24px; overflow-x: auto;">
                        <div id="ks-line" style="display: flex; align-items: center; justify-content: center; gap: 4px; min-width: max-content; min-height: 120px;">
                            <div style="color: var(--text-dim); font-size: 13px;">Press Start to begin simulation</div>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Live Metrics</div>
                    <div class="calc-results">
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Total WIP</div>
                            <div class="calc-result-value" id="ks-wip">0</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Throughput</div>
                            <div class="calc-result-value" id="ks-throughput">0<span class="calc-result-unit">/hr</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Avg Lead Time</div>
                            <div class="calc-result-value" id="ks-leadtime">0<span class="calc-result-unit">sec</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Stockouts</div>
                            <div class="calc-result-value" id="ks-stockouts">0</div>
                        </div>
                    </div>
                </div>

                <div class="calc-chart">
                    <div class="calc-chart-title">WIP Over Time</div>
                    <div id="ks-chart" style="height: 250px;"></div>
                </div>

                <div class="calc-section" style="margin-top: 20px;">
                    <div class="calc-section-title">Insights</div>
                    <div id="ks-insights" style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; font-size: 13px; color: var(--text-secondary);">
                        <em>Start simulation to generate insights...</em>
                    </div>
                </div>
            </div>

            <!-- Beer Game — Bullwhip Effect -->
            <div class="calc-layout" id="layout-beer-game">
                <div class="calc-section">
                    <div class="calc-section-title">Configuration</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; max-width: 700px;">
                        <div class="calc-input">
                            <label>Customer Demand Pattern</label>
                            <select id="bg-demand" onchange="updateBeerParams()">
                                <option value="constant">Constant (4/wk)</option>
                                <option value="step" selected>Step Change (4→8 at wk 5)</option>
                                <option value="seasonal">Seasonal (sine wave)</option>
                                <option value="random">Random (uniform 2-6)</option>
                            </select>
                        </div>
                        <div class="calc-input">
                            <label>Lead Time Between Tiers</label>
                            <input type="number" id="bg-leadtime" value="2" min="1" max="4" oninput="updateBeerParams()">
                            <span class="input-hint">weeks</span>
                        </div>
                        <div class="calc-input">
                            <label>Ordering Policy</label>
                            <select id="bg-policy" onchange="updateBeerParams()">
                                <option value="order-up-to" selected>Order-Up-To (target inventory)</option>
                                <option value="match-demand">Match Demand (naive)</option>
                            </select>
                        </div>
                        <div class="calc-input">
                            <label>Target Inventory</label>
                            <input type="number" id="bg-target" value="12" min="4" max="40" oninput="updateBeerParams()">
                            <span class="input-hint">units per tier</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                        <button id="bg-start" onclick="startBeerGame()" style="padding: 10px 24px; background: var(--accent); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600; font-size: 14px;">&#9654; Start</button>
                        <button onclick="resetBeerGame()" style="padding: 10px 20px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-secondary); cursor: pointer;">Reset</button>
                        <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-left: 16px;">Week: <span id="bg-week">0</span></div>
                        <div style="display: flex; align-items: center; gap: 8px; margin-left: auto;">
                            <span style="font-size: 12px; color: var(--text-dim);">Speed:</span>
                            <input type="range" id="bg-speed" min="1" max="10" value="4" style="width: 100px;">
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Supply Chain</div>
                    <div id="bg-visual" style="background: var(--bg-secondary); border-radius: 12px; padding: 24px; overflow-x: auto;">
                        <div id="bg-chain" style="display: flex; align-items: center; justify-content: space-between; gap: 8px; min-height: 160px;">
                            <div style="color: var(--text-dim); font-size: 13px; width: 100%; text-align: center;">Press Start to begin simulation</div>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Metrics</div>
                    <div class="calc-results">
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Bullwhip Ratio</div>
                            <div class="calc-result-value" id="bg-bullwhip">—</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Total SC Cost</div>
                            <div class="calc-result-value" id="bg-cost">$0</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Total Backlog</div>
                            <div class="calc-result-value" id="bg-backlog">0</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Avg Inventory</div>
                            <div class="calc-result-value" id="bg-avg-inv">0</div>
                        </div>
                    </div>
                </div>

                <div class="calc-chart">
                    <div class="calc-chart-title">Orders Placed Over Time (Bullwhip Amplification)</div>
                    <div id="bg-chart" style="height: 300px;"></div>
                </div>

                <div class="calc-section" style="margin-top: 20px;">
                    <div class="calc-section-title">Insights</div>
                    <div id="bg-insights" style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; font-size: 13px; color: var(--text-secondary);">
                        <em>Start simulation to generate insights...</em>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
                    <div style="padding: 16px; background: var(--bg-secondary); border-radius: 10px; border-left: 3px solid var(--accent-primary);">
                        <div style="font-size: 12px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">The Bullwhip Effect</div>
                        <div style="font-size: 11px; color: var(--text-dim); line-height: 1.5;">
                            Small demand changes at retail amplify exponentially upstream. A 10% increase at the register
                            can become a 40% spike at the factory. Causes: batching orders, demand signal processing,
                            lead time delays, and price fluctuations.
                        </div>
                    </div>
                    <div style="padding: 16px; background: var(--bg-secondary); border-radius: 10px; border-left: 3px solid #f39c12;">
                        <div style="font-size: 12px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Taming the Whip</div>
                        <div style="font-size: 11px; color: var(--text-dim); line-height: 1.5;">
                            Countermeasures: share point-of-sale data upstream, reduce lead times (compress the chain),
                            use smaller/more-frequent orders, implement VMI (vendor-managed inventory), or level
                            production with heijunka. Try changing the ordering policy above to see the difference.
                        </div>
                    </div>
                </div>
            </div>

            <!-- TOC / Drum-Buffer-Rope Simulator -->
            <div class="calc-layout" id="layout-toc-sim">
                <div class="calc-section">
                    <div class="calc-section-title">Configuration</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; max-width: 700px;">
                        <div class="calc-input">
                            <label>Mode</label>
                            <div style="display: flex; gap: 0; border-radius: 8px; overflow: hidden; border: 1px solid var(--border);">
                                <button id="toc-mode-uncontrolled" onclick="setTocMode('uncontrolled')" style="flex:1; padding: 10px; background: var(--bg-secondary); border: none; color: var(--text-dim); cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.15s;">UNCONTROLLED</button>
                                <button id="toc-mode-dbr" onclick="setTocMode('dbr')" style="flex:1; padding: 10px; background: rgba(74,159,110,0.2); border: none; color: var(--accent); cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.15s;">DBR</button>
                            </div>
                        </div>
                        <div class="calc-input">
                            <label>Buffer Before Constraint</label>
                            <input type="number" id="toc-buffer-size" value="5" min="0" max="20" oninput="updateTocParams()">
                            <span class="input-hint">units (DBR mode)</span>
                        </div>
                        <div class="calc-input">
                            <label>Variability (CoV)</label>
                            <input type="range" id="toc-cov" min="0" max="50" value="20" oninput="document.getElementById('toc-cov-label').textContent = this.value + '%'">
                            <span class="input-hint" id="toc-cov-label">20%</span>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Stations <span style="font-size: 11px; color: var(--text-dim); font-weight: 400; margin-left: 8px;">capacity = units/hr</span></div>
                    <div id="toc-stations" style="display: flex; flex-direction: column; gap: 8px;"></div>
                </div>

                <div class="calc-section">
                    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                        <button id="toc-start" onclick="startTocSim()" style="padding: 10px 24px; background: var(--accent); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600; font-size: 14px;">&#9654; Start</button>
                        <button onclick="resetTocSim()" style="padding: 10px 20px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-secondary); cursor: pointer;">Reset</button>
                        <div style="display: flex; align-items: center; gap: 8px; margin-left: auto;">
                            <span style="font-size: 12px; color: var(--text-dim);">Speed:</span>
                            <input type="range" id="toc-speed" min="1" max="10" value="5" style="width: 100px;">
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Live Visualization</div>
                    <div id="toc-visual" style="background: var(--bg-secondary); border-radius: 12px; padding: 24px; overflow-x: auto;">
                        <div id="toc-line" style="display: flex; align-items: center; justify-content: center; gap: 4px; min-width: max-content; min-height: 120px;">
                            <div style="color: var(--text-dim); font-size: 13px;">Press Start to begin simulation</div>
                        </div>
                    </div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title">Live Metrics</div>
                    <div class="calc-results">
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">System Throughput</div>
                            <div class="calc-result-value" id="toc-throughput">0<span class="calc-result-unit">/hr</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Total WIP</div>
                            <div class="calc-result-value" id="toc-wip">0</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Constraint Util.</div>
                            <div class="calc-result-value" id="toc-util">0<span class="calc-result-unit">%</span></div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Avg Lead Time</div>
                            <div class="calc-result-value" id="toc-leadtime">0<span class="calc-result-unit">sec</span></div>
                        </div>
                    </div>
                </div>

                <div class="calc-chart">
                    <div class="calc-chart-title">Throughput & WIP Over Time</div>
                    <div id="toc-chart" style="height: 250px;"></div>
                </div>

                <div class="calc-section" style="margin-top: 20px;">
                    <div class="calc-section-title">Insights</div>
                    <div id="toc-insights" style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; font-size: 13px; color: var(--text-secondary);">
                        <em>Start simulation to generate insights...</em>
                    </div>
                </div>
            </div>

            <!-- Coming Soon Placeholders -->
            <div class="calc-layout" id="layout-safety-sim">
                <div class="calc-section" style="text-align: center; padding: 80px 20px;">
                    <div style="font-size: 48px; margin-bottom: 16px; filter: grayscale(0.3);">&#x1F4CA;</div>
                    <div style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Safety Stock Simulator</div>
                    <div style="color: var(--text-dim); max-width: 460px; margin: 0 auto; line-height: 1.6;">
                        Watch inventory levels over 100+ simulated days with stochastic demand and lead time variability.
                        See exactly when and why stockouts happen — and how your reorder point math prevents them.
                    </div>
                    <div style="margin-top: 24px; padding: 8px 20px; background: var(--bg-secondary); border-radius: 20px; display: inline-block; font-size: 12px; color: var(--text-dim); font-weight: 600; letter-spacing: 0.5px;">COMING SOON</div>
                </div>
            </div>

            <div class="calc-layout" id="layout-heijunka-sim">
                <div class="calc-section" style="text-align: center; padding: 80px 20px;">
                    <div style="font-size: 48px; margin-bottom: 16px; filter: grayscale(0.3);">&#x1F4E6;</div>
                    <div style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Heijunka Simulator</div>
                    <div style="color: var(--text-dim); max-width: 460px; margin: 0 auto; line-height: 1.6;">
                        Side-by-side comparison: batched production (all A, then all B) vs leveled flow (ABABAB).
                        Watch WIP buildup, customer wait times, and changeover frequency in real-time.
                    </div>
                    <div style="margin-top: 24px; padding: 8px 20px; background: var(--bg-secondary); border-radius: 20px; display: inline-block; font-size: 12px; color: var(--text-dim); font-weight: 600; letter-spacing: 0.5px;">COMING SOON</div>
                </div>
            </div>

            <div class="calc-layout" id="layout-smed-sim">
                <div class="calc-section" style="text-align: center; padding: 80px 20px;">
                    <div style="font-size: 48px; margin-bottom: 16px; filter: grayscale(0.3);">&#x23F1;</div>
                    <div style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">SMED Simulator</div>
                    <div style="color: var(--text-dim); max-width: 460px; margin: 0 auto; line-height: 1.6;">
                        Animate changeover reduction in real-time. Drag elements from internal to external,
                        parallelize operations, and watch the changeover timeline shrink before your eyes.
                    </div>
                    <div style="margin-top: 24px; padding: 8px 20px; background: var(--bg-secondary); border-radius: 20px; display: inline-block; font-size: 12px; color: var(--text-dim); font-weight: 600; letter-spacing: 0.5px;">COMING SOON</div>
                </div>
            </div>

            <div class="calc-layout" id="layout-cell-sim">
                <div class="calc-section" style="text-align: center; padding: 80px 20px;">
                    <div style="font-size: 48px; margin-bottom: 16px; filter: grayscale(0.3);">&#x1F3ED;</div>
                    <div style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Cell Design Simulator</div>
                    <div style="color: var(--text-dim); max-width: 460px; margin: 0 auto; line-height: 1.6;">
                        Compare operator walking patterns across straight-line, U-cell, and parallel layouts.
                        See how cell design affects cycle time, multi-process handling, and operator utilization.
                    </div>
                    <div style="margin-top: 24px; padding: 8px 20px; background: var(--bg-secondary); border-radius: 20px; display: inline-block; font-size: 12px; color: var(--text-dim); font-weight: 600; letter-spacing: 0.5px;">COMING SOON</div>
                </div>
            </div>

            <div class="calc-layout" id="layout-fmea-sim">
                <div class="calc-section" style="text-align: center; padding: 80px 20px;">
                    <div style="font-size: 48px; margin-bottom: 16px; filter: grayscale(0.3);">&#x26A0;</div>
                    <div style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">FMEA Monte Carlo</div>
                    <div style="color: var(--text-dim); max-width: 460px; margin: 0 auto; line-height: 1.6;">
                        Run thousands of failure scenarios. See how compounding small risks create system-level
                        failures and identify which failure modes drive the most overall risk.
                    </div>
                    <div style="margin-top: 24px; padding: 8px 20px; background: var(--bg-secondary); border-radius: 20px; display: inline-block; font-size: 12px; color: var(--text-dim); font-weight: 600; letter-spacing: 0.5px;">COMING SOON</div>
                </div>
            </div>

            <!-- ============================================================ -->
            <!-- MULTI-RESPONSE DESIRABILITY OPTIMIZER                        -->
            <!-- ============================================================ -->
            <div class="calc-layout" id="layout-desirability">
                <div class="calc-section">
                    <div class="calc-section-title">Responses <button onclick="desirLoadExample()" style="margin-left:12px;padding:4px 14px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;color:var(--accent);cursor:pointer;font-size:12px;font-weight:600;">Load Example</button></div>
                    <div id="desir-responses">
                        <!-- Populated by JS -->
                    </div>
                    <button onclick="desirAddResponse()" style="margin-top:8px;padding:6px 16px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;color:var(--text-secondary);cursor:pointer;font-size:13px;">+ Add Response</button>
                </div>
                <div class="calc-section">
                    <div class="calc-section-title">Factors</div>
                    <div id="desir-factors">
                        <!-- Populated by JS -->
                    </div>
                    <button onclick="desirAddFactor()" style="margin-top:8px;padding:6px 16px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;color:var(--text-secondary);cursor:pointer;font-size:13px;">+ Add Factor</button>
                </div>
                <div class="calc-section">
                    <div class="calc-section-title">Response Models <span style="font-size:12px;color:var(--text-dim);font-weight:400;">(linear coefficients: Y = b0 + b1*X1 + b2*X2 + ...)</span></div>
                    <div id="desir-models" style="display:grid;gap:12px;">
                        <!-- Populated by JS when responses & factors defined -->
                    </div>
                </div>
                <div class="calc-section">
                    <button onclick="runDesirability()" style="padding:10px 28px;background:var(--accent);border:none;border-radius:8px;color:white;cursor:pointer;font-weight:600;font-size:14px;">&#9654; Optimize</button>
                </div>
                <div class="calc-section">
                    <div class="calc-section-title">Desirability Profiles</div>
                    <div id="desir-profiles" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;"></div>
                </div>
                <div class="calc-section">
                    <div class="calc-section-title">Composite Desirability Surface</div>
                    <div id="desir-contour" style="height:400px;"></div>
                </div>
                <div class="calc-section">
                    <div class="calc-section-title">Results</div>
                    <div class="calc-results" id="desir-results">
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Composite D</div>
                            <div class="calc-result-value" id="desir-D">—</div>
                        </div>
                    </div>
                </div>
                <div class="calc-section" id="desir-insight-section" style="display:none;">
                    <div class="calc-section-title">Insights</div>
                    <div id="desir-insights" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;font-size:13px;line-height:1.6;"></div>
                </div>
            </div>

            <!-- ============================================================ -->
            <!-- SPC RARE EVENTS LAB (G Chart + T Chart)                      -->
            <!-- ============================================================ -->
            <div class="calc-layout" id="layout-spc-rare">
                <div class="calc-section">
                    <div class="calc-section-title">Configuration</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;max-width:800px;">
                        <div class="calc-input">
                            <label>Chart Type</label>
                            <select id="re-type" onchange="reUpdateConfig()">
                                <option value="G">G Chart (count between events)</option>
                                <option value="T">T Chart (time between events)</option>
                            </select>
                        </div>
                        <div class="calc-input">
                            <label>Baseline Event Rate</label>
                            <input type="number" id="re-rate" value="0.02" min="0.001" max="0.5" step="0.005">
                            <span class="input-hint">probability per opportunity</span>
                        </div>
                        <div class="calc-input">
                            <label>Sample Size</label>
                            <input type="number" id="re-n" value="60" min="10" max="200" step="5">
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;max-width:800px;margin-top:12px;">
                        <div class="calc-input">
                            <label>Inject Shift at Sample #</label>
                            <input type="number" id="re-shift-at" value="30" min="0" max="200">
                            <span class="input-hint">0 = no shift</span>
                        </div>
                        <div class="calc-input">
                            <label>Shift Magnitude</label>
                            <input type="range" id="re-shift-mag" min="0.5" max="5" step="0.1" value="3" oninput="document.getElementById('re-shift-mag-val').textContent=this.value+'x'">
                            <span class="input-hint"><span id="re-shift-mag-val">3x</span> rate multiplier</span>
                        </div>
                        <div class="calc-input">
                            <label>Mode</label>
                            <select id="re-mode">
                                <option value="instant">Generate All</option>
                                <option value="simulate">Simulate (live)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="calc-section">
                    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                        <button id="re-start" onclick="reStart()" style="padding:10px 24px;background:var(--accent);border:none;border-radius:8px;color:white;cursor:pointer;font-weight:600;font-size:14px;">&#9654; Generate</button>
                        <button onclick="reReset()" style="padding:10px 20px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;color:var(--text-secondary);cursor:pointer;">Reset</button>
                        <div id="re-progress" style="font-size:14px;font-weight:600;color:var(--text-primary);margin-left:16px;"></div>
                        <div id="re-speed-box" style="display:none;align-items:center;gap:8px;margin-left:auto;">
                            <span style="font-size:12px;color:var(--text-dim);">Speed:</span>
                            <input type="range" id="re-speed" min="1" max="10" value="5" style="width:100px;">
                        </div>
                    </div>
                </div>
                <div class="calc-section">
                    <div class="calc-section-title">Control Chart</div>
                    <div id="re-chart" style="height:350px;"></div>
                </div>
                <div class="calc-section">
                    <div class="calc-section-title">Metrics</div>
                    <div class="calc-results">
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">Estimated Rate</div>
                            <div class="calc-result-value" id="re-est-rate">—</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Mean Between Events</div>
                            <div class="calc-result-value" id="re-mean">—</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">OOC Points</div>
                            <div class="calc-result-value" id="re-ooc">—</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Detection Delay</div>
                            <div class="calc-result-value" id="re-delay">—</div>
                        </div>
                    </div>
                </div>
                <div class="calc-section">
                    <div class="calc-section-title">Distribution Fit</div>
                    <div id="re-dist-chart" style="height:280px;"></div>
                </div>
                <div class="calc-section" id="re-insight-section" style="display:none;">
                    <div class="calc-section-title">Insights</div>
                    <div id="re-insights" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;font-size:13px;line-height:1.6;"></div>
                </div>
            </div>

            <!-- ============================================================ -->
            <!-- PROBIT / DOSE-RESPONSE EXPLORER                              -->
            <!-- ============================================================ -->
            <div class="calc-layout" id="layout-probit">
                <div class="calc-section">
                    <div class="calc-section-title">Dose-Response Data <button onclick="probitLoadExample()" style="margin-left:12px;padding:4px 14px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;color:var(--accent);cursor:pointer;font-size:12px;font-weight:600;">Load Example</button></div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;max-width:500px;margin-bottom:12px;">
                        <div class="calc-input">
                            <label>Model</label>
                            <select id="probit-model" onchange="probitUpdate()">
                                <option value="probit">Probit</option>
                                <option value="logit">Logit</option>
                            </select>
                        </div>
                        <div class="calc-input">
                            <label>Confidence Level</label>
                            <select id="probit-conf" onchange="probitUpdate()">
                                <option value="0.90">90%</option>
                                <option value="0.95" selected>95%</option>
                                <option value="0.99">99%</option>
                            </select>
                        </div>
                    </div>
                    <table id="probit-table" style="width:100%;max-width:600px;border-collapse:collapse;font-size:13px;">
                        <thead>
                            <tr style="border-bottom:2px solid var(--border);">
                                <th style="text-align:left;padding:8px;">Dose</th>
                                <th style="text-align:left;padding:8px;">N Tested</th>
                                <th style="text-align:left;padding:8px;">N Responding</th>
                                <th style="width:40px;"></th>
                            </tr>
                        </thead>
                        <tbody id="probit-tbody">
                        </tbody>
                    </table>
                    <button onclick="probitAddRow()" style="margin-top:8px;padding:6px 16px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;color:var(--text-secondary);cursor:pointer;font-size:13px;">+ Add Row</button>
                    <button onclick="probitUpdate()" style="margin-top:8px;margin-left:8px;padding:6px 16px;background:var(--accent);border:none;border-radius:6px;color:white;cursor:pointer;font-size:13px;font-weight:600;">Fit Model</button>
                </div>
                <div class="calc-section">
                    <div class="calc-section-title">Dose-Response Curve</div>
                    <div id="probit-chart" style="height:400px;"></div>
                </div>
                <div class="calc-section">
                    <div class="calc-section-title">Results</div>
                    <div class="calc-results">
                        <div class="calc-result-card primary">
                            <div class="calc-result-label">ED50 (LD50)</div>
                            <div class="calc-result-value" id="probit-ed50">—</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">ED50 95% CI</div>
                            <div class="calc-result-value" id="probit-ed50-ci">—</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">ED10</div>
                            <div class="calc-result-value" id="probit-ed10">—</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">ED90</div>
                            <div class="calc-result-value" id="probit-ed90">—</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Slope at ED50</div>
                            <div class="calc-result-value" id="probit-slope">—</div>
                        </div>
                        <div class="calc-result-card">
                            <div class="calc-result-label">Goodness of Fit (p)</div>
                            <div class="calc-result-value" id="probit-gof">—</div>
                        </div>
                    </div>
                </div>
                <div class="calc-section" id="probit-insight-section" style="display:none;">
                    <div class="calc-section-title">Insights</div>
                    <div id="probit-insights" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;font-size:13px;line-height:1.6;"></div>
                </div>
            </div>

        </div>
    </main>
</div>

<script>
// ============================================================================
// Navigation
// ============================================================================

const calcMeta = {
    takt: { title: 'Takt Time', desc: 'Calculate the pace of production to meet customer demand' },
    rto: { title: 'RTO (Required to Operate)', desc: 'Determine staffing requirements with variation buffer' },
    yamazumi: { title: 'Yamazumi Chart', desc: 'Visualize line balance and identify imbalances' },
    'line-sim': { title: 'Line Simulator', desc: 'Watch WIP flow through stations in real-time. See bottlenecks form. Run line balancing events.' },
    kanban: { title: 'Kanban Sizing', desc: 'Calculate the number of kanban cards needed' },
    epei: { title: 'EPEI (Every Part Every Interval)', desc: 'Determine production interval for part mix' },
    safety: { title: 'Safety Stock', desc: 'Calculate buffer inventory for demand and lead time variation' },
    eoq: { title: 'Economic Order Quantity', desc: 'Optimize order size to minimize total inventory cost' },
    oee: { title: 'OEE (Overall Equipment Effectiveness)', desc: 'Measure equipment productivity: Availability × Performance × Quality' },
    bottleneck: { title: 'Bottleneck Analysis', desc: 'Identify the constraint limiting system throughput' },
    littles: { title: "Little's Law", desc: 'WIP = Throughput × Lead Time — the fundamental flow equation' },
    queue: { title: 'M/M/c Queue', desc: 'Classic multi-server queue with exponential arrivals and service — call centers, checkout lanes, help desks' },
    'queue-finite': { title: 'M/M/c/K Finite Queue', desc: 'Limited queue capacity — customers balk when queue is full (drive-throughs, ERs with diversion)' },
    'queue-priority': { title: 'Priority Queue', desc: 'Multiple priority classes with preemption — ER triage, tiered support, VIP lanes' },
    'queue-optimizer': { title: 'Staffing Optimizer', desc: 'Find optimal server count given costs and service level targets' },
    'queue-sim': { title: 'Live Queue Simulator', desc: 'Watch queues form in real-time with Monte Carlo variability' },
    'queue-compare': { title: 'A/B Scenario Compare', desc: 'Run two simulations side-by-side — current vs proposed, see the difference live' },
    'queue-tandem': { title: 'Multi-Stage Queue', desc: 'Tandem queues — patient flows through triage → doctor → checkout, manufacturing lines' },
    pitch: { title: 'Pitch', desc: 'Takt × pack-out quantity for paced material withdrawal' },
    pfa: { title: 'Product Flow Analysis', desc: 'TIPS observation — follow the product through Transport, Inspect, Process, Storage' },
    wfa: { title: 'Workflow Analysis', desc: 'Therblig-based task breakdown — VA, required NVA, and unnecessary waste' },
    rty: { title: 'Rolled Throughput Yield', desc: 'Calculate first-pass yield across multiple process steps' },
    dpmo: { title: 'DPMO & Sigma Level', desc: 'Convert defect rates to sigma levels and vice versa' },
    turns: { title: 'Inventory Turns', desc: 'Calculate inventory turnover rate and days on hand' },
    coq: { title: 'Cost of Quality', desc: 'Analyze prevention, appraisal, and failure costs' },
    smed: { title: 'SMED Analysis', desc: 'Single Minute Exchange of Die — classify and reduce changeover elements' },
    changeover: { title: 'Changeover Matrix', desc: 'Sequence-dependent setup times between products' },
    fmea: { title: 'FMEA / RPN', desc: 'Failure Mode & Effects Analysis — Severity × Occurrence × Detection' },
    cpk: { title: 'Cp / Cpk Calculator', desc: 'Quick process capability check against spec limits' },
    samplesize: { title: 'Sample Size', desc: 'Calculate required sample size for studies and audits' },
    lineeff: { title: 'Line Efficiency', desc: 'Theoretical vs actual rate, losses by category' },
    ole: { title: 'OLE (Overall Labor Effectiveness)', desc: 'Availability × Performance × Quality for labor' },
    cycletime: { title: 'Cycle Time Study', desc: 'VA / NVA / Wait breakdown with visualization' },
    beforeafter: { title: 'Before / After', desc: 'Compare metrics pre and post improvement' },
    heijunka: { title: 'Heijunka (Leveling)', desc: 'Production mix smoothing and sequencing' },
    // Scheduling
    sequencer: { title: 'Job Sequencer', desc: 'Drag-and-drop job scheduling with live metrics — makespan, tardiness, setup time' },
    'seq-optimizer': { title: 'Sequence Optimizer', desc: 'Find optimal job sequence to minimize setup time or tardiness' },
    'capacity-load': { title: 'Capacity Load Chart', desc: 'Visualize work load against available capacity by time period' },
    'mixed-model': { title: 'Mixed-Model Sequencer', desc: 'Level production mix to smooth workflow — Toyota\'s heijunka sequencing' },
    'due-date-sim': { title: 'Due Date Risk Simulator', desc: 'Monte Carlo simulation of on-time delivery probability' },
    // Method
    qfd: { title: 'House of Quality (QFD)', desc: 'Quality Function Deployment — cascade customer requirements through design, parts, process, and production' },
    // Simulators
    'kanban-sim': { title: 'Kanban Pull System Simulator', desc: 'Watch kanban cards circulate. Toggle PUSH vs PULL and see why pull systems control WIP.' },
    'beer-game': { title: 'Beer Game — Bullwhip Effect', desc: 'The MIT Beer Game. Watch small demand changes amplify through a 4-tier supply chain.' },
    'toc-sim': { title: 'TOC / Drum-Buffer-Rope', desc: 'Theory of Constraints in action. Protect the bottleneck, control the system.' },
    'safety-sim': { title: 'Safety Stock Simulator', desc: 'Watch inventory levels over time with stochastic demand. See stockouts happen — or not.' },
    'heijunka-sim': { title: 'Heijunka Simulator', desc: 'Batched vs leveled production side-by-side. See the WIP and lead time difference.' },
    'smed-sim': { title: 'SMED Simulator', desc: 'Animate changeover reduction. Drag elements from internal to external and watch the bar shrink.' },
    'cell-sim': { title: 'Cell Design Simulator', desc: 'Animate operator walking patterns in line, U-cell, and parallel layouts.' },
    'fmea-sim': { title: 'FMEA Monte Carlo', desc: 'Run failure cascades. See how compounding small risks create system-level failures.' },
    // Quality & DOE
    'desirability': { title: 'Multi-Response Desirability', desc: 'Optimize multiple responses simultaneously. Drag sliders to find the sweet spot.' },
    'spc-rare': { title: 'SPC Rare Events Lab', desc: 'G chart and T chart for rare events. Generate data, inject shifts, watch detection live.' },
    'probit': { title: 'Probit / Dose-Response', desc: 'Fit probit or logit models to dose-response data. Get ED50/LD50 with confidence intervals.' },
};

// ============================================================================
// Shared State — Cross-Calculator Data Bus
// ============================================================================

const SvendOps = {
    // Published values from calculators
    values: {},

    // Publish a value (other calculators can pull from this)
    publish(key, value, unit, source) {
        this.values[key] = { value, unit, source, timestamp: Date.now() };
        this.updateLinkIndicators();
    },

    // Get a published value
    get(key) {
        return this.values[key]?.value || null;
    },

    // Update visual indicators showing available linked values
    updateLinkIndicators() {
        document.querySelectorAll('[data-link-from]').forEach(el => {
            const key = el.dataset.linkFrom;
            if (this.values[key]) {
                el.classList.add('has-link');
                el.title = `Pull from ${this.values[key].source}: ${this.values[key].value} ${this.values[key].unit}`;
            }
        });
    },

    // Pull a value into an input field with visual feedback
    pull(key, targetId) {
        const val = this.get(key);
        if (val !== null) {
            const el = document.getElementById(targetId);
            el.value = val;
            el.dispatchEvent(new Event('input'));
            // Flash green highlight on target input
            el.style.transition = 'box-shadow 0.2s';
            el.style.boxShadow = '0 0 0 2px rgba(74, 159, 110, 0.5)';
            setTimeout(() => { el.style.boxShadow = ''; }, 1200);
        } else {
            showToast('No data available yet — run the source calculator first');
        }
    }
};

/**
 * Render "Next Steps" cross-link cards after a calculation completes.
 * @param {string} containerId  - ID of the container div (e.g. 'takt-next-steps')
 * @param {Array<{title:string, desc:string, calcId:string, pullKey?:string, pullTarget?:string}>} steps
 */
function renderNextSteps(containerId, steps) {
    const container = document.getElementById(containerId);
    if (!container) return;
    const chevron = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>';
    container.innerHTML = steps.map(s => {
        const pull = s.pullKey && s.pullTarget
            ? `SvendOps.pull('${s.pullKey}','${s.pullTarget}');`
            : '';
        return `<div class="calc-next-step" onclick="${pull}navigateToCalc('${s.calcId}')">
            ${chevron}
            <div>
                <div class="calc-next-step-title">${s.title}</div>
                <div class="calc-next-step-desc">${s.desc}</div>
            </div>
        </div>`;
    }).join('');
    container.style.display = 'flex';
}

/**
 * Navigate to a calculator by ID — works without event context.
 * Clicks the correct nav button to trigger showCalc properly.
 */
function navigateToCalc(calcId) {
    const btn = document.querySelector(`.ops-nav-item[onclick*="'${calcId}'"]`);
    if (btn) { btn.click(); btn.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }
}

// ============================================================================
// Custom Stepper Widget
// ============================================================================

/**
 * Convert a number input to a custom stepper widget
 * Preserves all original attributes and behaviors
 */
function createStepper(input, options = {}) {
    // Skip if already converted
    if (input.dataset.stepperized) return;
    input.dataset.stepperized = 'true';

    const step = parseFloat(input.step) || 1;
    const min = input.hasAttribute('min') ? parseFloat(input.min) : null;
    const max = input.hasAttribute('max') ? parseFloat(input.max) : null;
    const isSmall = options.small || false;

    // Create wrapper
    const wrapper = document.createElement('div');
    wrapper.className = 'stepper' + (isSmall ? ' stepper-sm' : '');

    // Minus button
    const minusBtn = document.createElement('button');
    minusBtn.type = 'button';
    minusBtn.className = 'stepper-btn';
    minusBtn.textContent = '−';
    minusBtn.tabIndex = -1;

    // Plus button
    const plusBtn = document.createElement('button');
    plusBtn.type = 'button';
    plusBtn.className = 'stepper-btn';
    plusBtn.textContent = '+';
    plusBtn.tabIndex = -1;

    // Move input styling
    input.className = 'stepper-value';

    // Build stepper
    input.parentNode.insertBefore(wrapper, input);
    wrapper.appendChild(minusBtn);
    wrapper.appendChild(input);
    wrapper.appendChild(plusBtn);

    // Button handlers
    function adjust(delta) {
        let val = parseFloat(input.value) || 0;
        val += delta;
        if (min !== null) val = Math.max(min, val);
        if (max !== null) val = Math.min(max, val);
        // Round to avoid float errors
        val = Math.round(val * 1e10) / 1e10;
        input.value = val;
        input.dispatchEvent(new Event('input', { bubbles: true }));
    }

    minusBtn.addEventListener('click', (e) => {
        e.preventDefault();
        adjust(-step);
    });

    plusBtn.addEventListener('click', (e) => {
        e.preventDefault();
        adjust(step);
    });

    // Hold-to-repeat
    let holdTimer = null;
    let holdInterval = null;

    function startHold(delta) {
        holdTimer = setTimeout(() => {
            holdInterval = setInterval(() => adjust(delta), 75);
        }, 400);
    }

    function stopHold() {
        clearTimeout(holdTimer);
        clearInterval(holdInterval);
    }

    [minusBtn, plusBtn].forEach((btn, i) => {
        const delta = i === 0 ? -step : step;
        btn.addEventListener('mousedown', () => startHold(delta));
        btn.addEventListener('mouseup', stopHold);
        btn.addEventListener('mouseleave', stopHold);
        btn.addEventListener('touchstart', (e) => { e.preventDefault(); startHold(delta); });
        btn.addEventListener('touchend', stopHold);
    });

    return wrapper;
}

/**
 * Convert all number inputs in calc-input containers to steppers
 * Run this on page load
 */
function initializeSteppers() {
    // Main calc inputs (larger steppers)
    document.querySelectorAll('.calc-input input[type="number"]').forEach(input => {
        createStepper(input);
    });
}

// ============================================================================
// Monte Carlo Simulation Engine
// ============================================================================

const MonteCarlo = {
    // Run simulation with variability
    simulate(calcFn, inputs, iterations = 2000) {
        const results = [];
        for (let i = 0; i < iterations; i++) {
            // Add random variability to each input
            const variedInputs = inputs.map(inp => {
                const variability = inp.cv || 0.1; // Default ±10%
                const noise = 1 + (Math.random() - 0.5) * 2 * variability;
                return inp.value * noise;
            });
            results.push(calcFn(...variedInputs));
        }
        return this.analyze(results);
    },

    // Analyze simulation results
    analyze(results) {
        results.sort((a, b) => a - b);
        const n = results.length;
        const mean = results.reduce((a, b) => a + b, 0) / n;
        const variance = results.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / n;
        const std = Math.sqrt(variance);

        return {
            mean,
            std,
            min: results[0],
            max: results[n - 1],
            p5: results[Math.floor(n * 0.05)],
            p25: results[Math.floor(n * 0.25)],
            p50: results[Math.floor(n * 0.50)],
            p75: results[Math.floor(n * 0.75)],
            p95: results[Math.floor(n * 0.95)],
            histogram: this.buildHistogram(results, 20),
            raw: results
        };
    },

    // Build histogram buckets
    buildHistogram(results, buckets) {
        const min = results[0];
        const max = results[results.length - 1];
        const range = max - min || 1;
        const bucketSize = range / buckets;

        const hist = new Array(buckets).fill(0);
        results.forEach(r => {
            const idx = Math.min(buckets - 1, Math.floor((r - min) / bucketSize));
            hist[idx]++;
        });

        return {
            counts: hist,
            labels: hist.map((_, i) => (min + (i + 0.5) * bucketSize).toFixed(1))
        };
    },

    // Render histogram chart
    renderHistogram(containerId, simResult, title, unit) {
        const container = document.getElementById(containerId);
        if (!container) return;

        const hist = simResult.histogram;

        Plotly.newPlot(containerId, [{
            type: 'bar',
            x: hist.labels,
            y: hist.counts,
            marker: { color: 'rgba(74, 159, 110, 0.7)' },
            hovertemplate: '%{x} ' + unit + ': %{y} runs<extra></extra>'
        }, {
            type: 'scatter',
            mode: 'lines',
            x: [simResult.p5, simResult.p5],
            y: [0, Math.max(...hist.counts)],
            line: { color: '#e74c3c', width: 2, dash: 'dash' },
            name: '5th %ile',
            hoverinfo: 'name'
        }, {
            type: 'scatter',
            mode: 'lines',
            x: [simResult.p95, simResult.p95],
            y: [0, Math.max(...hist.counts)],
            line: { color: '#e74c3c', width: 2, dash: 'dash' },
            name: '95th %ile',
            hoverinfo: 'name'
        }], {
            margin: { t: 30, b: 50, l: 50, r: 20 },
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            title: { text: title, font: { size: 13, color: '#a0a0a0' } },
            xaxis: { title: unit, tickfont: { size: 10, color: '#a0a0a0' }, gridcolor: 'rgba(150,150,150,0.1)' },
            yaxis: { title: 'Frequency', tickfont: { size: 10, color: '#a0a0a0' }, gridcolor: 'rgba(150,150,150,0.1)' },
            showlegend: false,
            annotations: [{
                x: simResult.mean,
                y: Math.max(...hist.counts) * 0.9,
                text: `μ = ${simResult.mean.toFixed(1)}`,
                showarrow: false,
                font: { size: 11, color: '#4a9f6e' }
            }]
        }, { responsive: true, displayModeBar: false });
    }
};

// ============================================================================
// Derivation Helper — Show Your Work
// ============================================================================

function toggleDerivation(id) {
    const el = document.getElementById(id);
    el.classList.toggle('expanded');
}

let currentCalcId = 'takt';

function showCalc(id) {
    currentCalcId = id;
    // Update nav
    document.querySelectorAll('.ops-nav-item').forEach(el => el.classList.remove('active'));
    event.currentTarget.classList.add('active');

    // Update header
    document.getElementById('calc-title').textContent = calcMeta[id].title;
    document.getElementById('calc-desc').textContent = calcMeta[id].desc;

    // Show layout
    document.querySelectorAll('.calc-layout').forEach(el => el.classList.remove('active'));
    document.getElementById(`layout-${id}`).classList.add('active');
}

// ============================================================================
// VSM Import/Export Integration
// ============================================================================

let vsmImportCache = []; // cached list of user's VSMs

async function openVSMImport() {
    const modal = document.getElementById('vsm-import-modal');
    modal.style.display = 'flex';
    const select = document.getElementById('vsm-import-select');
    select.innerHTML = '<option value="">Loading...</option>';
    document.getElementById('vsm-import-preview').style.display = 'none';

    try {
        const resp = await fetch('/api/vsm/', { credentials: 'same-origin' });
        if (!resp.ok) throw new Error('Failed to fetch VSMs');
        const data = await resp.json();
        vsmImportCache = data.maps || [];

        if (vsmImportCache.length === 0) {
            select.innerHTML = '<option value="">No VSMs found — create one in Visual > VSM first</option>';
            return;
        }

        select.innerHTML = '<option value="">— Select a VSM —</option>' +
            vsmImportCache.map((m, i) => `<option value="${i}">${m.name} (${m.process_steps?.length || 0} steps)</option>`).join('');
    } catch (e) {
        select.innerHTML = '<option value="">Error loading VSMs</option>';
    }
}

function closeVSMImport() {
    document.getElementById('vsm-import-modal').style.display = 'none';
}

function previewVSMImport() {
    const idx = document.getElementById('vsm-import-select').value;
    const preview = document.getElementById('vsm-import-preview');
    if (idx === '') { preview.style.display = 'none'; return; }

    const vsm = vsmImportCache[parseInt(idx)];
    if (!vsm) return;
    preview.style.display = 'block';

    const steps = vsm.process_steps || [];
    const wcs = vsm.work_centers || [];
    const effectiveStations = buildEffectiveStations(steps, wcs);
    const stepsEl = document.getElementById('vsm-import-steps');
    if (effectiveStations.length === 0) {
        stepsEl.innerHTML = '<div style="color:var(--text-dim);">No process steps in this VSM</div>';
    } else {
        stepsEl.innerHTML = `<table style="width:100%; border-collapse:collapse;">
            <tr style="color:var(--text-dim); font-size:10px; text-transform:uppercase; letter-spacing:0.5px;">
                <th style="text-align:left; padding:4px 8px;">Station</th>
                <th style="text-align:right; padding:4px 8px;">C/T (s)</th>
                <th style="text-align:right; padding:4px 8px;">Type</th>
            </tr>
            ${effectiveStations.map(s => `<tr style="border-top:1px solid var(--border);">
                <td style="padding:6px 8px; color:var(--text-primary);">${s.name}${s.is_work_center ? ' <span style="color:var(--accent);font-size:10px;">[WC]</span>' : ''}</td>
                <td style="padding:6px 8px; text-align:right; color:var(--text-secondary);">${s.cycle_time ? s.cycle_time.toFixed(1) : '—'}${s.is_work_center ? ' (eff.)' : ''}</td>
                <td style="padding:6px 8px; text-align:right; color:var(--text-dim); font-size:11px;">${s.is_work_center ? s.n_machines + ' machines' : 'Single'}</td>
            </tr>`).join('')}
        </table>`;
    }

    const metaEl = document.getElementById('vsm-import-meta');
    const parts = [];
    if (vsm.takt_time) parts.push(`Takt: ${vsm.takt_time}s`);
    if (vsm.customer_demand) parts.push(`Demand: ${vsm.customer_demand}`);
    if (vsm.product_family) parts.push(`Family: ${vsm.product_family}`);
    if (wcs.length > 0) parts.push(`${wcs.length} work center${wcs.length !== 1 ? 's' : ''}`);
    metaEl.textContent = parts.join(' · ') || 'No additional metadata';
}

function buildEffectiveStations(steps, workCenters) {
    // Collapses work center members into single effective stations.
    // Standalone steps pass through unchanged.
    // Work center effective CT = 1 / sum(1/CT_i) for parallel machines.
    const wcMap = {};
    workCenters.forEach(wc => { wcMap[wc.id] = { ...wc, members: [] }; });

    const standalone = [];
    steps.forEach(s => {
        if (s.work_center_id && wcMap[s.work_center_id]) {
            wcMap[s.work_center_id].members.push(s);
        } else {
            standalone.push(s);
        }
    });

    // Build ordered list by x-position
    const all = [];

    // Add standalone steps
    standalone.forEach(s => {
        all.push({ name: s.name || 'Process', cycle_time: s.cycle_time || 30, x: s.x || 0 });
    });

    // Add work centers as collapsed stations
    Object.values(wcMap).forEach(wc => {
        if (wc.members.length === 0) return;
        const rateSum = wc.members.reduce((sum, m) => {
            const ct = m.cycle_time || 0;
            return ct > 0 ? sum + 1.0 / ct : sum;
        }, 0);
        const effCT = rateSum > 0 ? 1.0 / rateSum : 30;
        const memberNames = wc.members.map(m => m.name).join('+');
        all.push({
            name: wc.name || memberNames,
            cycle_time: Math.round(effCT * 10) / 10,
            x: wc.x || 0,
            is_work_center: true,
            n_machines: wc.members.length
        });
    });

    // Sort by x position to maintain process order
    all.sort((a, b) => a.x - b.x);
    return all;
}

function doVSMImport() {
    const idx = document.getElementById('vsm-import-select').value;
    if (idx === '') return;
    const vsm = vsmImportCache[parseInt(idx)];
    if (!vsm) return;

    const steps = vsm.process_steps || [];
    const wcs = vsm.work_centers || [];
    const id = currentCalcId;

    // Build effective station list: standalone steps + work centers (collapsed)
    const effectiveStations = buildEffectiveStations(steps, wcs);

    // Dispatch to calculator-specific import functions
    switch (id) {
        case 'line-sim': loadVSMIntoLineSim(effectiveStations); break;
        case 'kanban-sim': loadVSMIntoKanbanSim(effectiveStations); break;
        case 'toc-sim': loadVSMIntoTocSim(effectiveStations); break;
        case 'bottleneck': loadVSMIntoBottleneck(effectiveStations); break;
        case 'yamazumi': loadYamazumiFromVSMExpanded(steps, wcs); break;
        case 'takt': loadVSMIntoTakt(vsm); break;
        case 'oee': loadVSMIntoOEE(steps); break;
        case 'kanban': loadVSMIntoKanbanSizing(vsm); break;
        default:
            // Generic: try to load into simulators that have stations
            if (effectiveStations.length > 0) {
                loadVSMIntoLineSim(effectiveStations);
                alert(`Imported ${effectiveStations.length} stations. Switched to Line Simulator.`);
                document.querySelector('[onclick="showCalc(\'line-sim\')"]')?.click();
                closeVSMImport();
                return;
            }
            alert('This calculator does not support VSM import directly.');
            return;
    }

    closeVSMImport();
}

// --- Calculator-specific VSM import functions ---

function loadVSMIntoLineSim(stations) {
    if (stations.length === 0) return;
    lineStations.length = 0;
    stations.forEach(s => {
        lineStations.push({ name: s.name, cycleTime: s.cycle_time });
    });
    renderLineStations();
    resetLineSim();
}

function loadVSMIntoKanbanSim(stations) {
    if (stations.length === 0) return;
    kanbanStations.length = 0;
    stations.forEach(s => {
        kanbanStations.push({ name: s.name, cycleTime: s.cycle_time });
    });
    renderKanbanStations();
    resetKanbanSim();
}

function loadVSMIntoTocSim(stations) {
    if (stations.length === 0) return;
    tocStationsData.length = 0;
    stations.forEach(s => {
        const ct = s.cycle_time || 60;
        // Work centers with N machines have combined capacity = N * (3600/effective_CT) isn't right
        // effective_CT already accounts for parallel machines, so capacity = 3600 / effective_CT
        const capacity = Math.round(3600 / ct);
        tocStationsData.push({ name: s.name, capacity });
    });
    renderTocStations();
    resetTocSim();
}

function loadVSMIntoBottleneck(stations) {
    if (stations.length === 0) return;
    bottleneckData.length = 0;
    stations.forEach(s => {
        bottleneckData.push({ name: s.name, time: s.cycle_time });
    });
    renderBottleneckStations();
    calcBottleneck();
}

// Yamazumi stores raw VSM import data for toggle between expanded/collapsed work centers
let yamazumiVSMRaw = null; // { steps: [...], workCenters: [...] }

function loadVSMIntoYamazumi(stations) {
    if (stations.length === 0) return;
    yamazumiData.length = 0;
    stations.forEach(s => {
        yamazumiData.push({ name: s.name, time: s.cycle_time });
    });
    renderYamazumiInputs();
    renderYamazumi();
}

function loadYamazumiFromVSMExpanded(steps, workCenters) {
    // Store raw data for toggle
    yamazumiVSMRaw = { steps: JSON.parse(JSON.stringify(steps)), workCenters: JSON.parse(JSON.stringify(workCenters)) };

    // Show toggle only when work centers exist
    const toggle = document.getElementById('yama-wc-toggle');
    const hasWC = workCenters.length > 0 && steps.some(s => s.work_center_id);
    toggle.style.display = hasWC ? 'flex' : 'none';

    // Reset checkbox to unchecked (expanded = default)
    document.getElementById('yama-combine-wc').checked = false;
    document.getElementById('yama-toggle-knob').style.transform = 'translateX(0)';
    document.getElementById('yama-toggle-track').style.background = 'var(--border)';

    // Expanded: each machine is its own bar, sorted by x position
    yamazumiData.length = 0;
    [...steps].sort((a, b) => (a.x || 0) - (b.x || 0)).forEach(s => {
        const wcId = s.work_center_id;
        let prefix = '';
        if (wcId) {
            const wc = workCenters.find(w => w.id === wcId);
            if (wc) prefix = wc.name + ': ';
        }
        yamazumiData.push({ name: prefix + (s.name || 'Process'), time: s.cycle_time || 30 });
    });
    renderYamazumiInputs();
    renderYamazumi();
}

function toggleYamazumiWCMode() {
    if (!yamazumiVSMRaw) return;
    const combine = document.getElementById('yama-combine-wc').checked;
    // Update toggle visual
    document.getElementById('yama-toggle-knob').style.transform = combine ? 'translateX(14px)' : 'translateX(0)';
    document.getElementById('yama-toggle-track').style.background = combine ? 'var(--accent)' : 'var(--border)';

    const { steps, workCenters } = yamazumiVSMRaw;

    if (combine) {
        // Collapsed: use buildEffectiveStations
        const effective = buildEffectiveStations(steps, workCenters);
        yamazumiData.length = 0;
        effective.forEach(s => {
            yamazumiData.push({
                name: s.is_work_center ? s.name + ' (eff.)' : s.name,
                time: s.cycle_time
            });
        });
    } else {
        // Expanded: each machine
        yamazumiData.length = 0;
        [...steps].sort((a, b) => (a.x || 0) - (b.x || 0)).forEach(s => {
            const wcId = s.work_center_id;
            let prefix = '';
            if (wcId) {
                const wc = workCenters.find(w => w.id === wcId);
                if (wc) prefix = wc.name + ': ';
            }
            yamazumiData.push({ name: prefix + (s.name || 'Process'), time: s.cycle_time || 30 });
        });
    }
    renderYamazumiInputs();
    renderYamazumi();
}

function loadVSMIntoTakt(vsm) {
    if (vsm.takt_time) {
        const taktSec = vsm.takt_time;
        // Reverse-engineer: takt = available / demand, so if we know takt we can set inputs
        // Just set available=480 and calculate demand from takt
        const available = parseFloat(document.getElementById('takt-available').value) || 480;
        const breaks = parseFloat(document.getElementById('takt-breaks').value) || 0;
        const net = available - breaks;
        const demand = Math.round(net / (taktSec / 60)); // takt is in sec, available is in min
        document.getElementById('takt-demand').value = demand;
        calcTakt();
    }
    if (vsm.customer_demand) {
        // Try to parse a number from customer_demand string
        const num = parseFloat(vsm.customer_demand.replace(/[^\d.]/g, ''));
        if (num > 0) {
            document.getElementById('takt-demand').value = num;
            calcTakt();
        }
    }
}

function loadVSMIntoOEE(steps) {
    // Use the first step with data
    const step = steps.find(s => s.cycle_time || s.uptime) || steps[0];
    if (!step) return;
    if (step.uptime) {
        document.getElementById('oee-uptime').value = step.uptime;
    }
    if (typeof calcOEE === 'function') calcOEE();
}

function loadVSMIntoKanbanSizing(vsm) {
    if (vsm.customer_demand) {
        const num = parseFloat(vsm.customer_demand.replace(/[^\d.]/g, ''));
        if (num > 0) document.getElementById('kanban-demand').value = num;
    }
    // Lead time from inventory days of supply
    const invs = vsm.inventory || [];
    if (invs.length > 0) {
        const avgDays = invs.reduce((s, inv) => s + (inv.days_of_supply || 0), 0) / invs.length;
        if (avgDays > 0) document.getElementById('kanban-lead').value = avgDays.toFixed(1);
    }
    if (typeof calcKanban === 'function') calcKanban();
}

// --- Export Takt to VSM ---

async function exportTaktToVSM() {
    const taktSec = SvendOps.get('takt');
    if (!taktSec) { alert('Calculate takt time first'); return; }

    // Fetch VSMs
    try {
        const resp = await fetch('/api/vsm/', { credentials: 'same-origin' });
        const data = await resp.json();
        const maps = data.maps || [];
        if (maps.length === 0) { alert('No VSMs found'); return; }

        const name = maps.length === 1 ? maps[0].name :
            prompt('Enter VSM name to update:\n' + maps.map(m => '• ' + m.name).join('\n'));
        if (!name) return;

        const target = maps.find(m => m.name === name) || maps[0];

        await fetch(`/api/vsm/${target.id}/`, {
            method: 'PUT',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ takt_time: taktSec })
        });

        alert(`Takt time (${taktSec.toFixed(1)}s) exported to "${target.name}"`);
    } catch (e) {
        alert('Failed to export: ' + e.message);
    }
}

// ============================================================================
// Takt Time
// ============================================================================

function calcTakt() {
    const available = parseFloat(document.getElementById('takt-available').value) || 0;
    const breaks = parseFloat(document.getElementById('takt-breaks').value) || 0;
    const demand = parseFloat(document.getElementById('takt-demand').value) || 1;

    const net = available - breaks;
    const taktMin = net / demand;
    const taktSec = taktMin * 60;

    document.getElementById('takt-result').innerHTML = `${taktMin.toFixed(2)}<span class="calc-result-unit">min</span>`;
    document.getElementById('takt-seconds').innerHTML = `${Math.round(taktSec)}<span class="calc-result-unit">sec</span>`;
    document.getElementById('takt-net').innerHTML = `${net}<span class="calc-result-unit">min</span>`;
    document.getElementById('takt-interpret').textContent = `${taktMin.toFixed(1)} min`;

    // Publish to shared state
    SvendOps.publish('takt', taktSec, 'sec', 'Takt Time');
    SvendOps.publish('taktMin', taktMin, 'min', 'Takt Time');

    // Update derivation
    document.getElementById('takt-derivation-body').innerHTML = `
        <div class="step">
            <div class="step-num">Step 1: Calculate Net Available Time</div>
            <span class="formula">Net Time = Available − Breaks</span><br>
            Net Time = ${available} − ${breaks} = <strong>${net} min</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 2: Calculate Takt Time</div>
            <span class="formula">Takt = Net Time ÷ Demand</span><br>
            Takt = ${net} ÷ ${demand} = <strong>${taktMin.toFixed(2)} min</strong> = <strong>${Math.round(taktSec)} sec</strong>
        </div>
        <div class="step">
            <div class="step-num">Interpretation</div>
            To meet customer demand of <strong>${demand} units/shift</strong>,
            you must complete one unit every <strong>${taktMin.toFixed(1)} minutes</strong> (${Math.round(taktSec)} seconds).
        </div>
    `;

    // Takt gauge chart
    const gaugeMax = Math.max(taktMin * 2, 10);
    Plotly.newPlot('takt-chart', [{
        type: 'indicator', mode: 'gauge+number',
        value: taktMin,
        number: { suffix: ' min', font: { size: 28, color: '#e0e0e0' } },
        gauge: {
            axis: { range: [0, gaugeMax], tickfont: { color: '#9aaa9a' } },
            bar: { color: '#4a9f6e' },
            bgcolor: 'rgba(255,255,255,0.05)',
            steps: [
                { range: [0, 1], color: 'rgba(231,76,60,0.25)' },
                { range: [1, 5], color: 'rgba(74,159,110,0.25)' },
                { range: [5, gaugeMax], color: 'rgba(243,156,18,0.25)' }
            ],
            threshold: { line: { color: '#e74c3c', width: 2 }, value: taktMin }
        }
    }], {
        margin: { t: 30, b: 10, l: 30, r: 30 },
        paper_bgcolor: 'transparent',
        font: { color: '#9aaa9a' },
        annotations: [
            { x: 0.17, y: 0.28, text: '<1 min: high-speed risk', showarrow: false, font: { size: 10, color: '#e74c3c' } },
            { x: 0.5, y: -0.05, text: '1-5 min: optimal', showarrow: false, font: { size: 10, color: '#4a9f6e' } },
            { x: 0.83, y: 0.28, text: '>5 min: batch risk', showarrow: false, font: { size: 10, color: '#f39c12' } }
        ]
    }, { responsive: true, displayModeBar: false });

    renderNextSteps('takt-next-steps', [
        { title: 'Staff the Line', desc: 'Calculate operators needed at this takt', calcId: 'rto' },
        { title: 'Balance Stations', desc: 'Build a Yamazumi chart to balance work', calcId: 'yamazumi' },
        { title: 'Set Pitch', desc: 'Calculate pitch interval from takt', calcId: 'pitch' },
        { title: 'Simulate Flow', desc: 'Run a line simulation at this rate', calcId: 'linesim' },
    ]);
}

// ============================================================================
// RTO
// ============================================================================

function calcRTO() {
    const cycle = parseFloat(document.getElementById('rto-cycle').value) || 0;
    const takt = parseFloat(document.getElementById('rto-takt').value) || 1;
    const covPct = parseFloat(document.getElementById('rto-cov').value) || 0;

    const rto = cycle / takt;
    const cov = covPct / 100;
    const rtoMargin = rto * (1 + cov);
    const staff = Math.ceil(rtoMargin);
    const efficiency = (rto / staff) * 100;
    const buffer = rtoMargin - rto;

    document.getElementById('rto-base').textContent = rto.toFixed(2);
    document.getElementById('rto-margin').textContent = rtoMargin.toFixed(2);
    document.getElementById('rto-staff').innerHTML = `${staff}<span class="calc-result-unit">people</span>`;
    document.getElementById('rto-efficiency').textContent = `${efficiency.toFixed(1)}%`;
    document.getElementById('rto-buffer').textContent = `+${buffer.toFixed(2)} operators`;

    // Update derivation
    document.getElementById('rto-derivation-body').innerHTML = `
        <div class="step">
            <div class="step-num">Step 1: Calculate Base RTO</div>
            <span class="formula">RTO = Cycle Time ÷ Takt Time</span><br>
            RTO = ${cycle} ÷ ${takt} = <strong>${rto.toFixed(2)} operators</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 2: Add Variation Margin</div>
            <span class="formula">RTO + Margin = RTO × (1 + CoV)</span><br>
            = ${rto.toFixed(2)} × (1 + ${cov.toFixed(2)}) = <strong>${rtoMargin.toFixed(2)} operators</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 3: Round Up to Whole People</div>
            <span class="formula">Staff = ⌈RTO + Margin⌉</span><br>
            Staff = ⌈${rtoMargin.toFixed(2)}⌉ = <strong>${staff} people</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 4: Calculate Line Efficiency</div>
            <span class="formula">Efficiency = (Base RTO ÷ Staff) × 100</span><br>
            = (${rto.toFixed(2)} ÷ ${staff}) × 100 = <strong>${efficiency.toFixed(1)}%</strong>
        </div>
    `;

    // Publish to shared state
    SvendOps.publish('rtoStaff', staff, 'people', 'RTO');
    SvendOps.publish('lineEfficiency', efficiency, '%', 'RTO');
}

// ============================================================================
// Yamazumi
// ============================================================================

let yamazumiData = [
    { name: 'Station 1', time: 45 },
    { name: 'Station 2', time: 50 },
    { name: 'Station 3', time: 55 },
];

function renderYamazumiInputs() {
    const container = document.getElementById('yamazumi-stations');
    container.innerHTML = yamazumiData.map((s, i) => `
        <div class="yamazumi-station">
            <span class="yamazumi-station-name">${s.name}</span>
            <input type="number" value="${s.time}" oninput="updateYamazumi(${i}, this.value)">
            <span style="color: var(--text-dim);">sec</span>
            <button class="yamazumi-station-remove" onclick="removeYamazumiStation(${i})">&times;</button>
        </div>
    `).join('');
    renderYamazumi();
}

function addYamazumiStation() {
    yamazumiData.push({ name: `Station ${yamazumiData.length + 1}`, time: 30 });
    renderYamazumiInputs();
}

function removeYamazumiStation(idx) {
    yamazumiData.splice(idx, 1);
    renderYamazumiInputs();
}

function updateYamazumi(idx, value) {
    yamazumiData[idx].time = parseFloat(value) || 0;
    renderYamazumi();
}

function renderYamazumi() {
    const takt = parseFloat(document.getElementById('yama-takt').value) || 60;
    const times = yamazumiData.map(s => s.time);
    const names = yamazumiData.map(s => s.name);

    // Calculate free capacity (time below takt)
    const freeCapacity = times.map(t => Math.max(0, takt - t));
    const utilization = times.map(t => Math.min(100, (t / takt) * 100));

    // Work time bar (bottom of stack)
    const workTrace = {
        x: names,
        y: times,
        type: 'bar',
        name: 'Work',
        marker: { color: times.map(t => t > takt ? '#e74c3c' : '#4a9f6e') },
        text: times.map((t, i) => `${t}s (${utilization[i].toFixed(0)}%)`),
        textposition: 'inside',
        textfont: { color: '#fff', size: 11 },
        hovertemplate: '%{x}<br>Work: %{y}s<br>Utilization: %{text}<extra></extra>',
    };

    // Free capacity bar (top of stack) - only for stations under takt
    const capacityTrace = {
        x: names,
        y: freeCapacity,
        type: 'bar',
        name: 'Free Capacity',
        marker: { color: 'rgba(255,255,255,0.15)' },
        text: freeCapacity.map(f => f > 0 ? `+${f.toFixed(0)}s` : ''),
        textposition: 'inside',
        textfont: { color: 'rgba(255,255,255,0.6)', size: 10 },
        hovertemplate: '%{x}<br>Free: %{y}s<extra></extra>',
    };

    Plotly.newPlot('yamazumi-chart', [workTrace, capacityTrace], {
        barmode: 'stack',
        shapes: [{
            type: 'line', x0: -0.5, x1: names.length - 0.5, y0: takt, y1: takt,
            line: { color: '#e74c3c', width: 2, dash: 'dash' }
        }],
        annotations: [{
            x: names.length - 0.5, y: takt, text: `Takt: ${takt}s`,
            showarrow: false, xanchor: 'left', font: { color: '#e74c3c', size: 11 }
        }],
        margin: { t: 20, b: 60, l: 50, r: 80 },
        paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
        font: { color: '#9aaa9a' },
        yaxis: { title: 'Cycle Time (sec)', gridcolor: 'rgba(255,255,255,0.1)' },
        xaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
        showlegend: true,
        legend: { orientation: 'h', y: -0.15, x: 0.5, xanchor: 'center' },
    }, { responsive: true, displayModeBar: false });

    const total = times.reduce((a, b) => a + b, 0);
    const totalFree = freeCapacity.reduce((a, b) => a + b, 0);
    const rto = total / takt;
    const efficiency = (rto / yamazumiData.length) * 100;
    const avgUtil = utilization.reduce((a, b) => a + b, 0) / utilization.length;

    document.getElementById('yama-total').innerHTML = `${total}<span class="calc-result-unit">sec</span>`;
    document.getElementById('yama-rto').textContent = rto.toFixed(2);
    document.getElementById('yama-efficiency').innerHTML = `${efficiency.toFixed(1)}<span class="calc-result-unit">%</span>`;
    document.getElementById('yama-free').innerHTML = `${totalFree.toFixed(0)}<span class="calc-result-unit">sec</span>`;
    document.getElementById('yama-util').innerHTML = `${avgUtil.toFixed(1)}<span class="calc-result-unit">%</span>`;
}

// ============================================================================
// Line Simulator
// ============================================================================

let lineStations = [
    { name: 'Station 1', cycleTime: 45 },
    { name: 'Station 2', cycleTime: 50 },
    { name: 'Station 3', cycleTime: 55 },
    { name: 'Station 4', cycleTime: 48 },
];

// Product types for order-driven mode
let lineProducts = [
    { id: 'A', name: 'Product A', color: '#4a9f6e', ctMultiplier: 1.0 },
    { id: 'B', name: 'Product B', color: '#3498db', ctMultiplier: 1.2 },
];

// Order queue for order-driven mode
let lineOrders = [];
let orderIdCounter = 1;

let lineSimState = {
    running: false,
    interval: null,
    time: 0,
    completed: 0,
    history: { time: [], wip: [], throughput: [] },
    stationStats: [], // { working: 0, blocked: 0, starved: 0, processed: 0 }
    // Order-driven mode state
    currentOrder: null,
    currentOrderProgress: 0,
    currentProduct: null,
    changingOver: false,
    changeoverRemaining: 0,
    totalChangeoverTime: 0,
    orderResults: [], // { orderId, product, qty, dueTime, completedTime, wasLate, lateReason }
};

function renderLineStations() {
    const container = document.getElementById('ls-stations');
    container.innerHTML = lineStations.map((s, i) => `
        <div style="display: flex; align-items: center; gap: 12px; padding: 8px 12px; background: var(--bg-secondary); border-radius: 6px;">
            <input type="text" value="${s.name}" onchange="lineStations[${i}].name = this.value; renderLineVisual();"
                   style="width: 100px; padding: 6px 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); font-size: 13px;">
            <span style="color: var(--text-dim); font-size: 12px;">CT:</span>
            <input type="number" value="${s.cycleTime}" onchange="lineStations[${i}].cycleTime = parseFloat(this.value) || 30; renderLineVisual();"
                   style="width: 60px; padding: 6px 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); font-size: 13px;">
            <span style="color: var(--text-dim); font-size: 12px;">sec</span>
            <button onclick="removeLineStation(${i})" style="padding: 4px 8px; background: transparent; border: none; color: var(--text-dim); cursor: pointer; font-size: 16px;">&times;</button>
        </div>
    `).join('');
    renderLineVisual();
}

function addLineStation() {
    lineStations.push({ name: `Station ${lineStations.length + 1}`, cycleTime: 45 });
    renderLineStations();
}

function removeLineStation(idx) {
    if (lineStations.length > 2) {
        lineStations.splice(idx, 1);
        renderLineStations();
    }
}

function updateLineSimParams() {
    const cov = parseFloat(document.getElementById('ls-cov').value);
    const labels = ['0% — Perfect automation', '5% — High automation', '10% — Low variability', '15% — Typical manual', '25% — High variability', '35% — Problematic', '50% — Chaos'];
    const label = cov <= 0 ? labels[0] : cov <= 5 ? labels[1] : cov <= 10 ? labels[2] : cov <= 15 ? labels[3] : cov <= 25 ? labels[4] : cov <= 35 ? labels[5] : labels[6];
    document.getElementById('ls-cov-label').textContent = label;

    // Handle flow mode
    const flowMode = document.getElementById('ls-flow-mode').value;
    const batchContainer = document.getElementById('ls-batch-size-container');
    const flowHint = document.getElementById('ls-flow-hint');

    if (flowMode === 'batch') {
        batchContainer.style.display = 'block';
        const batchSize = document.getElementById('ls-batch-size').value;
        flowHint.textContent = `Batches of ${batchSize} units — watch WIP accumulate`;
        flowHint.style.color = '#f39c12';
    } else {
        batchContainer.style.display = 'none';
        flowHint.textContent = 'Units move individually through the line';
        flowHint.style.color = '';
    }

    renderLineVisual();
}

function renderLineVisual() {
    const takt = parseFloat(document.getElementById('ls-takt').value) || 60;
    const maxWip = parseInt(document.getElementById('ls-max-wip').value) || 5;
    const container = document.getElementById('ls-line');
    const simMode = document.getElementById('ls-sim-mode').value;

    // Changeover indicator
    const isChangingOver = lineSimState.changingOver;
    const changeoverRemaining = lineSimState.changeoverRemaining || 0;

    // Current order/product info
    const currentOrder = lineSimState.currentOrder;
    const currentProduct = lineSimState.currentProduct;
    const orderProgress = lineSimState.currentOrderProgress || 0;

    // Build visual: [Input/Order] -> [Station 1] -> [Buffer] -> [Station 2] -> ... -> [Output]
    let inputLabel = 'Input';
    let inputColor = 'linear-gradient(135deg, #4a9f6e 0%, #3d8a5e 100%)';
    let inputContent = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';

    if (simMode === 'orders') {
        if (isChangingOver) {
            inputLabel = `C/O ${changeoverRemaining.toFixed(0)}s`;
            inputColor = 'linear-gradient(135deg, #f39c12 0%, #e67e22 100%)';
            inputContent = '<span style="color: white; font-size: 16px;">⟳</span>';
        } else if (currentOrder) {
            const productColor = currentProduct?.color || '#4a9f6e';
            inputLabel = `#${currentOrder.id}: ${orderProgress}/${currentOrder.qty}`;
            inputColor = `linear-gradient(135deg, ${productColor} 0%, ${productColor}dd 100%)`;
            inputContent = `<span style="color: white; font-weight: 600; font-size: 12px;">${currentProduct?.name?.charAt(0) || '?'}</span>`;
        }
    }

    let html = `
        <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
            <div style="width: 50px; height: 50px; background: ${inputColor}; border-radius: 50%; display: flex; align-items: center; justify-content: center; ${isChangingOver ? 'animation: pulse 1s infinite;' : ''}">
                ${inputContent}
            </div>
            <span style="font-size: 10px; color: var(--text-dim); max-width: 70px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${inputLabel}</span>
        </div>
    `;

    lineStations.forEach((station, i) => {
        const utilization = (station.cycleTime / takt) * 100;
        const overloaded = utilization > 100;
        const stationColor = overloaded ? '#e74c3c' : utilization > 85 ? '#f39c12' : '#4a9f6e';
        const state = lineSimState.stationStats[i] || {};
        const stateLabel = state.currentState || 'idle';
        const stateColor = stateLabel === 'working' ? stationColor : stateLabel === 'blocked' ? '#e74c3c' : stateLabel === 'starved' ? '#f39c12' : 'var(--text-dim)';

        // Arrow
        html += `<svg width="30" height="20" viewBox="0 0 30 20" style="flex-shrink: 0;"><path d="M0 10 L20 10 M15 5 L20 10 L15 15" stroke="var(--border)" stroke-width="2" fill="none"/></svg>`;

        // Station
        html += `
            <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                <div id="ls-station-${i}" style="width: 80px; height: 60px; background: var(--bg-card); border: 2px solid ${stationColor}; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;">
                    <span style="font-size: 11px; font-weight: 600; color: var(--text-primary);">${station.name}</span>
                    <span style="font-size: 10px; color: ${stationColor};">${station.cycleTime}s</span>
                    <div id="ls-station-state-${i}" style="position: absolute; top: -8px; right: -8px; width: 16px; height: 16px; background: ${stateColor}; border-radius: 50%; border: 2px solid var(--bg-secondary);"></div>
                </div>
                <span style="font-size: 10px; color: var(--text-dim);">${utilization.toFixed(0)}%</span>
            </div>
        `;

        // WIP Buffer (except after last station)
        if (i < lineStations.length - 1) {
            const wip = state.outputBuffer || 0;
            const wipPct = (wip / maxWip) * 100;
            const wipColor = wipPct >= 100 ? '#e74c3c' : wipPct > 60 ? '#f39c12' : '#4a9f6e';

            html += `<svg width="30" height="20" viewBox="0 0 30 20" style="flex-shrink: 0;"><path d="M0 10 L20 10 M15 5 L20 10 L15 15" stroke="var(--border)" stroke-width="2" fill="none"/></svg>`;
            html += `
                <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                    <div id="ls-buffer-${i}" style="width: 40px; height: 50px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; display: flex; flex-direction: column; justify-content: flex-end; overflow: hidden;">
                        <div style="height: ${wipPct}%; background: ${wipColor}; transition: height 0.3s;"></div>
                    </div>
                    <span id="ls-buffer-label-${i}" style="font-size: 10px; color: var(--text-dim);">${wip}/${maxWip}</span>
                </div>
            `;
        }
    });

    // Output
    html += `
        <svg width="30" height="20" viewBox="0 0 30 20" style="flex-shrink: 0;"><path d="M0 10 L20 10 M15 5 L20 10 L15 15" stroke="var(--border)" stroke-width="2" fill="none"/></svg>
        <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <span id="ls-output-count" style="color: white; font-weight: 600; font-size: 14px;">${lineSimState.completed}</span>
            </div>
            <span style="font-size: 10px; color: var(--text-dim);">Output</span>
        </div>
    `;

    container.innerHTML = html;
}

function startLineSim() {
    if (lineSimState.running) {
        // Pause
        lineSimState.running = false;
        clearInterval(lineSimState.interval);
        document.getElementById('ls-start').innerHTML = '▶ Resume';
        return;
    }

    lineSimState.running = true;
    document.getElementById('ls-start').innerHTML = '⏸ Pause';

    const takt = parseFloat(document.getElementById('ls-takt').value) || 60;
    const cov = parseFloat(document.getElementById('ls-cov').value) / 100;
    const maxWip = parseInt(document.getElementById('ls-max-wip').value) || 5;
    const speedFactor = parseInt(document.getElementById('ls-speed').value);
    const flowMode = document.getElementById('ls-flow-mode').value;
    const batchSize = flowMode === 'batch' ? parseInt(document.getElementById('ls-batch-size').value) || 5 : 1;
    const simMode = document.getElementById('ls-sim-mode').value;
    const changeoverTime = parseFloat(document.getElementById('ls-changeover-time')?.value) || 120;

    // Initialize station states if fresh start
    if (lineSimState.time === 0) {
        lineSimState.stationStats = lineStations.map(() => ({
            working: 0,
            blocked: 0,
            starved: 0,
            processed: 0,
            currentState: 'starved',
            timeRemaining: 0,
            outputBuffer: 0,
            hasUnit: false,
            batchCount: 0,
        }));
        lineSimState.history = { time: [], wip: [], throughput: [] };
        lineSimState.completed = 0;
        lineSimState.batchSize = batchSize;
        lineSimState.currentOrder = null;
        lineSimState.currentOrderProgress = 0;
        lineSimState.currentProduct = null;
        lineSimState.changingOver = false;
        lineSimState.changeoverRemaining = 0;
        lineSimState.totalChangeoverTime = 0;
        lineSimState.orderResults = [];

        // In order mode, mark first order as in-progress
        if (simMode === 'orders' && lineOrders.length > 0) {
            lineOrders.forEach(o => { o.status = 'pending'; });
        }
    }

    // Simulation tick (100ms real time = speedFactor seconds sim time)
    const tickInterval = 100;
    const simSecondsPerTick = speedFactor * 0.5;

    lineSimState.interval = setInterval(() => {
        lineSimState.time += simSecondsPerTick;

        const breakdownsEnabled = document.getElementById('ls-breakdowns').checked;

        // === ORDER-DRIVEN MODE: Handle changeovers and order tracking ===
        let ctMultiplier = 1.0;
        if (simMode === 'orders') {
            // Handle changeover state
            if (lineSimState.changingOver) {
                lineSimState.changeoverRemaining -= simSecondsPerTick;
                lineSimState.totalChangeoverTime += simSecondsPerTick;
                if (lineSimState.changeoverRemaining <= 0) {
                    lineSimState.changingOver = false;
                }
                // During changeover, all stations are idle - skip processing
                updateOrderMetrics(simSecondsPerTick);
                return;
            }

            // Get current order or next pending order
            if (!lineSimState.currentOrder) {
                const nextOrder = lineOrders.find(o => o.status === 'pending');
                if (nextOrder) {
                    // Check if we need a changeover
                    const newProduct = lineProducts[nextOrder.productIdx];
                    if (lineSimState.currentProduct && lineSimState.currentProduct.id !== newProduct?.id) {
                        // Trigger changeover
                        lineSimState.changingOver = true;
                        lineSimState.changeoverRemaining = changeoverTime;
                        // Record if this changeover will cause lateness
                        if (lineSimState.time + changeoverTime > nextOrder.dueTime) {
                            nextOrder.lateReason = `Changeover to ${newProduct?.name} started at t=${lineSimState.time.toFixed(0)}s, will take ${changeoverTime}s`;
                        }
                        updateOrderMetrics(simSecondsPerTick);
                        return;
                    }

                    // Start the order
                    lineSimState.currentOrder = nextOrder;
                    lineSimState.currentOrderProgress = 0;
                    lineSimState.currentProduct = newProduct;
                    nextOrder.status = 'in-progress';
                    nextOrder.startTime = lineSimState.time;
                    renderOrders();
                } else {
                    // No more orders - stop simulation
                    lineSimState.running = false;
                    clearInterval(lineSimState.interval);
                    document.getElementById('ls-start').innerHTML = '▶ All Orders Complete';
                    updateDeliveryMetrics();
                    return;
                }
            }

            // Apply product cycle time multiplier
            ctMultiplier = lineSimState.currentProduct?.ctMultiplier || 1.0;
        }

        // Process each station (from last to first to avoid double-moving)
        for (let i = lineStations.length - 1; i >= 0; i--) {
            const station = lineStations[i];
            const state = lineSimState.stationStats[i];
            const prevState = i > 0 ? lineSimState.stationStats[i - 1] : null;
            const isFirstStation = i === 0;
            const isLastStation = i === lineStations.length - 1;

            // Check for breakdown (if enabled)
            if (breakdownsEnabled && state.currentState !== 'down') {
                // ~0.5% chance per tick of breakdown (MTBF ~100 ticks ≈ 50 sim seconds)
                if (Math.random() < 0.005) {
                    state.currentState = 'down';
                    state.downTimeRemaining = 15 + Math.random() * 30; // 15-45 sec repair
                    state.downtime = (state.downtime || 0);
                    // Record if breakdown will cause lateness
                    if (simMode === 'orders' && lineSimState.currentOrder) {
                        const order = lineSimState.currentOrder;
                        if (!order.lateReason && lineSimState.time > order.dueTime * 0.7) {
                            order.lateReason = `Breakdown at ${station.name} (t=${lineSimState.time.toFixed(0)}s)`;
                        }
                    }
                }
            }

            // Handle breakdown state
            if (state.currentState === 'down') {
                state.downTimeRemaining -= simSecondsPerTick;
                state.downtime = (state.downtime || 0) + simSecondsPerTick;
                if (state.downTimeRemaining <= 0) {
                    state.currentState = state.hasUnit ? 'working' : 'starved';
                }
                continue; // Skip normal processing while down
            }

            // Add variability to cycle time (per unit in batch), apply product multiplier
            const actualCT = station.cycleTime * ctMultiplier * (1 + (Math.random() - 0.5) * 2 * cov);

            if (state.hasUnit) {
                // Currently processing
                state.timeRemaining -= simSecondsPerTick;

                if (state.timeRemaining <= 0) {
                    // Finished processing
                    if (isLastStation) {
                        // Output the unit(s)
                        const unitsCompleted = state.batchCount;
                        lineSimState.completed += unitsCompleted;
                        state.hasUnit = false;
                        state.processed += unitsCompleted;
                        state.batchCount = 0;
                        state.currentState = 'starved';

                        // Order mode: track progress
                        if (simMode === 'orders' && lineSimState.currentOrder) {
                            lineSimState.currentOrderProgress += unitsCompleted;
                            if (lineSimState.currentOrderProgress >= lineSimState.currentOrder.qty) {
                                // Order complete!
                                const order = lineSimState.currentOrder;
                                order.status = 'complete';
                                order.completedTime = lineSimState.time;
                                order.wasLate = lineSimState.time > order.dueTime;
                                if (order.wasLate && !order.lateReason) {
                                    order.lateReason = 'Cumulative delays exceeded buffer';
                                }

                                lineSimState.orderResults.push({
                                    orderId: order.id,
                                    productIdx: order.productIdx,
                                    qty: order.qty,
                                    dueTime: order.dueTime,
                                    completedTime: order.completedTime,
                                    wasLate: order.wasLate,
                                    lateReason: order.lateReason,
                                });

                                lineSimState.currentOrder = null;
                                lineSimState.currentOrderProgress = 0;
                                renderOrders();
                                updateDeliveryMetrics();
                            }
                        }
                    } else if (state.outputBuffer + state.batchCount <= maxWip) {
                        // Move to buffer
                        state.outputBuffer += state.batchCount;
                        state.hasUnit = false;
                        state.processed += state.batchCount;
                        state.batchCount = 0;
                        state.currentState = 'starved';
                    } else {
                        // Blocked!
                        state.currentState = 'blocked';
                        // Record blocking as potential late cause
                        if (simMode === 'orders' && lineSimState.currentOrder) {
                            const order = lineSimState.currentOrder;
                            if (!order.lateReason && lineSimState.time > order.dueTime * 0.8) {
                                order.lateReason = `Blocking at ${station.name} (buffer full, t=${lineSimState.time.toFixed(0)}s)`;
                            }
                        }
                        state.blocked += simSecondsPerTick;
                    }
                } else {
                    state.currentState = 'working';
                    state.working += simSecondsPerTick;
                }
            } else {
                // Try to get a unit (or batch)
                if (isFirstStation) {
                    // Order mode: only pull if we have an active order with remaining qty
                    if (simMode === 'orders') {
                        if (lineSimState.currentOrder && lineSimState.currentOrderProgress < lineSimState.currentOrder.qty) {
                            const remaining = lineSimState.currentOrder.qty - lineSimState.currentOrderProgress;
                            const pullQty = Math.min(batchSize, remaining);
                            state.hasUnit = true;
                            state.batchCount = pullQty;
                            state.timeRemaining = actualCT * pullQty;
                            state.currentState = 'working';
                        } else {
                            // No order or order complete - starve until next order
                            state.currentState = 'starved';
                            state.starved += simSecondsPerTick;
                        }
                    } else {
                        // Infinite supply mode
                        state.hasUnit = true;
                        state.batchCount = batchSize;
                        state.timeRemaining = actualCT * batchSize;
                        state.currentState = 'working';
                    }
                } else if (prevState && prevState.outputBuffer >= batchSize) {
                    // Pull batch from previous buffer
                    prevState.outputBuffer -= batchSize;
                    state.hasUnit = true;
                    state.batchCount = batchSize;
                    state.timeRemaining = actualCT * batchSize;
                    state.currentState = 'working';
                } else if (batchSize === 1 && prevState && prevState.outputBuffer > 0) {
                    // One-piece flow: pull single unit
                    prevState.outputBuffer--;
                    state.hasUnit = true;
                    state.batchCount = 1;
                    state.timeRemaining = actualCT;
                    state.currentState = 'working';
                } else {
                    // Starved (waiting for batch to accumulate)
                    state.currentState = 'starved';
                    state.starved += simSecondsPerTick;
                }
            }
        }

        // Update metrics
        const totalWip = lineSimState.stationStats.reduce((sum, s) => sum + s.outputBuffer + (s.hasUnit ? s.batchCount : 0), 0);
        const throughputPerHour = (lineSimState.completed / lineSimState.time) * 3600;

        // Calculate line efficiency (excluding downtime from denominator for OEE-style calc)
        const totalWorking = lineSimState.stationStats.reduce((sum, s) => sum + s.working, 0);
        const totalTime = lineSimState.stationStats.reduce((sum, s) => sum + s.working + s.blocked + s.starved + (s.downtime || 0), 0);
        const efficiency = totalTime > 0 ? (totalWorking / totalTime) * 100 : 0;

        // Record history (every ~5 sim seconds)
        if (lineSimState.history.time.length === 0 || lineSimState.time - lineSimState.history.time[lineSimState.history.time.length - 1] >= 5) {
            lineSimState.history.time.push(lineSimState.time);
            lineSimState.history.wip.push(totalWip);
            lineSimState.history.throughput.push(throughputPerHour);
        }

        // Update UI
        document.getElementById('ls-completed').textContent = lineSimState.completed;
        document.getElementById('ls-throughput').innerHTML = `${throughputPerHour.toFixed(1)}<span class="calc-result-unit">/hr</span>`;
        document.getElementById('ls-total-wip').textContent = totalWip;
        document.getElementById('ls-efficiency').innerHTML = `${efficiency.toFixed(1)}<span class="calc-result-unit">%</span>`;

        // Publish live sim values
        SvendOps.publish('simThroughput', parseFloat(throughputPerHour.toFixed(1)), 'units/hr', 'Line Sim');
        SvendOps.publish('simWIP', totalWip, 'units', 'Line Sim');
        SvendOps.publish('simEfficiency', parseFloat(efficiency.toFixed(1)), '%', 'Line Sim');

        // Update visual
        updateLineVisual(maxWip);

        // Update chart
        updateLineChart();

        // Update station stats table
        updateLineStationStats(takt);

        // Bottleneck analysis
        updateLineBottleneck(takt);

    }, tickInterval);
}

function updateLineVisual(maxWip) {
    lineSimState.stationStats.forEach((state, i) => {
        const stateEl = document.getElementById(`ls-station-state-${i}`);
        if (stateEl) {
            const stateColor = state.currentState === 'down' ? '#666' :
                               state.currentState === 'working' ? '#4a9f6e' :
                               state.currentState === 'blocked' ? '#e74c3c' : '#f39c12';
            stateEl.style.background = stateColor;

            // Flash the station border on breakdown
            const stationEl = document.getElementById(`ls-station-${i}`);
            if (stationEl) {
                stationEl.style.borderColor = state.currentState === 'down' ? '#666' : '';
                stationEl.style.opacity = state.currentState === 'down' ? '0.6' : '1';
            }
        }

        if (i < lineStations.length - 1) {
            const bufferEl = document.getElementById(`ls-buffer-${i}`);
            const labelEl = document.getElementById(`ls-buffer-label-${i}`);
            if (bufferEl && labelEl) {
                const wipPct = (state.outputBuffer / maxWip) * 100;
                const wipColor = wipPct >= 100 ? '#e74c3c' : wipPct > 60 ? '#f39c12' : '#4a9f6e';
                bufferEl.innerHTML = `<div style="height: ${wipPct}%; background: ${wipColor}; transition: height 0.2s;"></div>`;
                labelEl.textContent = `${state.outputBuffer}/${maxWip}`;
            }
        }
    });

    const outputEl = document.getElementById('ls-output-count');
    if (outputEl) outputEl.textContent = lineSimState.completed;
}

function updateLineChart() {
    const h = lineSimState.history;
    if (h.time.length < 2) return;

    Plotly.newPlot('ls-chart', [
        {
            x: h.time,
            y: h.wip,
            type: 'scatter',
            mode: 'lines',
            name: 'WIP',
            line: { color: '#f39c12', width: 2 },
            yaxis: 'y',
        },
        {
            x: h.time,
            y: h.throughput,
            type: 'scatter',
            mode: 'lines',
            name: 'Throughput/hr',
            line: { color: '#4a9f6e', width: 2 },
            yaxis: 'y2',
        }
    ], {
        margin: { t: 20, b: 60, l: 50, r: 50 },
        paper_bgcolor: 'transparent',
        plot_bgcolor: 'transparent',
        font: { color: '#9aaa9a' },
        xaxis: { title: 'Time (sec)', gridcolor: 'rgba(255,255,255,0.1)' },
        yaxis: { title: 'WIP', gridcolor: 'rgba(255,255,255,0.1)', side: 'left' },
        yaxis2: { title: 'Units/hr', overlaying: 'y', side: 'right', gridcolor: 'transparent' },
        legend: { orientation: 'h', y: 1.05, x: 0.5, xanchor: 'center' },
        showlegend: true,
    }, { responsive: true, displayModeBar: false });
}

function updateLineStationStats(takt) {
    const container = document.getElementById('ls-station-stats');
    const breakdownsEnabled = document.getElementById('ls-breakdowns').checked;

    let html = `
        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
            <thead>
                <tr style="border-bottom: 1px solid var(--border);">
                    <th style="padding: 8px; text-align: left;">Station</th>
                    <th style="padding: 8px; text-align: right;">CT</th>
                    <th style="padding: 8px; text-align: right;">Processed</th>
                    <th style="padding: 8px; text-align: right;">Working %</th>
                    <th style="padding: 8px; text-align: right;">Blocked %</th>
                    <th style="padding: 8px; text-align: right;">Starved %</th>
                    ${breakdownsEnabled ? '<th style="padding: 8px; text-align: right;">Down %</th>' : ''}
                    <th style="padding: 8px; text-align: left;">Status</th>
                </tr>
            </thead>
            <tbody>
    `;

    lineStations.forEach((station, i) => {
        const state = lineSimState.stationStats[i];
        const downtime = state.downtime || 0;
        const totalTime = state.working + state.blocked + state.starved + downtime;
        const workPct = totalTime > 0 ? (state.working / totalTime) * 100 : 0;
        const blockPct = totalTime > 0 ? (state.blocked / totalTime) * 100 : 0;
        const starvePct = totalTime > 0 ? (state.starved / totalTime) * 100 : 0;
        const downPct = totalTime > 0 ? (downtime / totalTime) * 100 : 0;

        const utilization = (station.cycleTime / takt) * 100;
        let status = 'Normal';
        let statusColor = '#4a9f6e';
        if (state.currentState === 'down') { status = 'DOWN'; statusColor = '#666'; }
        else if (blockPct > 20) { status = 'Bottleneck'; statusColor = '#e74c3c'; }
        else if (starvePct > 30) { status = 'Underutilized'; statusColor = '#f39c12'; }
        else if (utilization > 100) { status = 'Overloaded'; statusColor = '#e74c3c'; }
        else if (downPct > 10) { status = 'Unreliable'; statusColor = '#666'; }

        html += `
            <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 8px;">${station.name}</td>
                <td style="padding: 8px; text-align: right;">${station.cycleTime}s</td>
                <td style="padding: 8px; text-align: right;">${state.processed}</td>
                <td style="padding: 8px; text-align: right; color: #4a9f6e;">${workPct.toFixed(1)}%</td>
                <td style="padding: 8px; text-align: right; color: #e74c3c;">${blockPct.toFixed(1)}%</td>
                <td style="padding: 8px; text-align: right; color: #f39c12;">${starvePct.toFixed(1)}%</td>
                ${breakdownsEnabled ? `<td style="padding: 8px; text-align: right; color: #666;">${downPct.toFixed(1)}%</td>` : ''}
                <td style="padding: 8px; color: ${statusColor};">${status}</td>
            </tr>
        `;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
}

function updateLineBottleneck(takt) {
    const container = document.getElementById('ls-bottleneck');

    // Find the station with highest blocked time
    let bottleneckIdx = -1;
    let maxBlockTime = 0;
    lineSimState.stationStats.forEach((state, i) => {
        if (state.blocked > maxBlockTime) {
            maxBlockTime = state.blocked;
            bottleneckIdx = i;
        }
    });

    // Also check for theoretical bottleneck (highest CT)
    let theoreticalBottleneck = 0;
    let maxCT = 0;
    lineStations.forEach((s, i) => {
        if (s.cycleTime > maxCT) {
            maxCT = s.cycleTime;
            theoreticalBottleneck = i;
        }
    });

    const theoreticalThroughput = 3600 / maxCT;
    const actualThroughput = lineSimState.time > 0 ? (lineSimState.completed / lineSimState.time) * 3600 : 0;
    const lostThroughput = theoreticalThroughput - actualThroughput;

    // Check flow mode
    const flowMode = document.getElementById('ls-flow-mode').value;
    const batchSize = flowMode === 'batch' ? parseInt(document.getElementById('ls-batch-size').value) || 5 : 1;
    const breakdownsEnabled = document.getElementById('ls-breakdowns').checked;

    // Calculate total WIP and downtime
    const totalWip = lineSimState.stationStats.reduce((sum, s) => sum + s.outputBuffer + (s.hasUnit ? (s.batchCount || 1) : 0), 0);
    const totalDowntime = lineSimState.stationStats.reduce((sum, s) => sum + (s.downtime || 0), 0);
    const downtimePct = lineSimState.time > 0 ? (totalDowntime / (lineSimState.time * lineStations.length)) * 100 : 0;

    let html = '';

    if (lineSimState.time < 30) {
        html = '<em>Running simulation... gathering data...</em>';
    } else {
        let improvementHtml = '';

        // Takt violation
        if (maxCT > takt) {
            improvementHtml += `<div style="color: #e74c3c; margin-bottom: 4px;">⚠ ${lineStations[theoreticalBottleneck].name} CT (${maxCT}s) exceeds takt (${takt}s)</div>`;
        }

        // Variability cost
        if (lostThroughput > 5) {
            improvementHtml += `<div style="margin-bottom: 4px;">📉 Variability costing ~${lostThroughput.toFixed(1)} units/hr</div>`;
        }

        // Batch mode impact
        if (flowMode === 'batch') {
            const wipWithOnePiece = lineStations.length; // theoretical minimum
            const wipMultiplier = totalWip / wipWithOnePiece;
            improvementHtml += `<div style="color: #f39c12; margin-bottom: 4px;">📦 Batch mode: WIP is ~${wipMultiplier.toFixed(1)}x higher than one-piece flow</div>`;
            improvementHtml += `<div style="margin-bottom: 4px;">💡 Switch to one-piece flow to reduce WIP from ${totalWip} to ~${wipWithOnePiece}</div>`;
        }

        // Buffer suggestion
        if (bottleneckIdx >= 0 && bottleneckIdx !== theoreticalBottleneck && maxBlockTime > 10) {
            improvementHtml += `<div style="margin-bottom: 4px;">🔄 Buffer before ${lineStations[bottleneckIdx].name} may need increase</div>`;
        }

        // Downtime impact
        if (breakdownsEnabled && downtimePct > 5) {
            const throughputLostToDowntime = theoreticalThroughput * (downtimePct / 100);
            improvementHtml += `<div style="color: #666; margin-bottom: 4px;">🔧 Downtime (${downtimePct.toFixed(1)}%) costing ~${throughputLostToDowntime.toFixed(1)} units/hr</div>`;
            improvementHtml += `<div style="margin-bottom: 4px;">💡 TPM focus: improve MTBF or reduce repair time</div>`;
        }

        // Default suggestion
        if (!improvementHtml) {
            improvementHtml = `<div style="margin-bottom: 4px;">💡 Reduce ${lineStations[theoreticalBottleneck].name} CT or add parallel capacity</div>`;
        }

        html = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div>
                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Constraint Analysis</div>
                    <div style="margin-bottom: 4px;"><strong>Theoretical bottleneck:</strong> ${lineStations[theoreticalBottleneck].name} (CT: ${maxCT}s)</div>
                    <div style="margin-bottom: 4px;"><strong>Max theoretical throughput:</strong> ${theoreticalThroughput.toFixed(1)} units/hr</div>
                    <div style="margin-bottom: 4px;"><strong>Actual throughput:</strong> ${actualThroughput.toFixed(1)} units/hr (${((actualThroughput/theoreticalThroughput)*100).toFixed(0)}%)</div>
                    ${bottleneckIdx >= 0 && maxBlockTime > 10 ? `
                        <div style="margin-bottom: 4px;"><strong>Actual bottleneck:</strong> <span style="color: #e74c3c;">${lineStations[bottleneckIdx].name}</span> (${(maxBlockTime).toFixed(0)}s blocked)</div>
                    ` : ''}
                    <div style="margin-bottom: 4px;"><strong>Total WIP:</strong> ${totalWip} units</div>
                </div>
                <div>
                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Improvement Opportunities</div>
                    ${improvementHtml}
                </div>
            </div>
        `;
    }

    container.innerHTML = html;
}

function resetLineSim() {
    lineSimState.running = false;
    if (lineSimState.interval) clearInterval(lineSimState.interval);
    lineSimState.time = 0;
    lineSimState.completed = 0;
    lineSimState.history = { time: [], wip: [], throughput: [] };
    lineSimState.stationStats = [];
    lineSimState.currentOrder = null;
    lineSimState.currentOrderProgress = 0;
    lineSimState.currentProduct = null;
    lineSimState.changingOver = false;
    lineSimState.changeoverRemaining = 0;
    lineSimState.totalChangeoverTime = 0;
    lineSimState.orderResults = [];

    document.getElementById('ls-start').innerHTML = '▶ Start Line';
    document.getElementById('ls-completed').textContent = '0';
    document.getElementById('ls-throughput').innerHTML = '0<span class="calc-result-unit">/hr</span>';
    document.getElementById('ls-total-wip').textContent = '0';
    document.getElementById('ls-efficiency').innerHTML = '0<span class="calc-result-unit">%</span>';
    document.getElementById('ls-station-stats').innerHTML = '';
    document.getElementById('ls-bottleneck').innerHTML = '<em>Start simulation to identify bottleneck...</em>';

    // Reset order statuses
    lineOrders.forEach(o => { o.status = 'pending'; o.completedTime = null; });
    renderOrders();
    updateDeliveryMetrics();

    Plotly.purge('ls-chart');
    renderLineVisual();
}

// ============================================================================
// Order-Driven Mode Functions
// ============================================================================

function updateSimMode() {
    const mode = document.getElementById('ls-sim-mode').value;
    const orderPanel = document.getElementById('ls-order-panel');
    const deliverySection = document.getElementById('ls-delivery-section');
    const hint = document.getElementById('ls-sim-mode-hint');

    if (mode === 'orders') {
        orderPanel.style.display = 'block';
        deliverySection.style.display = 'block';
        hint.textContent = 'Process customer orders with due dates';
        hint.style.color = 'var(--accent)';
        renderProducts();
        renderOrders();
    } else {
        orderPanel.style.display = 'none';
        deliverySection.style.display = 'none';
        hint.textContent = 'Continuous production vs customer orders';
        hint.style.color = '';
    }
    resetLineSim();
}

// Product management
function renderProducts() {
    const container = document.getElementById('ls-products');
    container.innerHTML = lineProducts.map((p, i) => `
        <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-card); border-radius: 6px; border-left: 4px solid ${p.color};">
            <input type="text" value="${p.name}" onchange="lineProducts[${i}].name = this.value; renderOrders();"
                   style="flex: 1; padding: 4px 8px; background: transparent; border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); font-size: 12px;">
            <span style="font-size: 11px; color: var(--text-dim);">CT×</span>
            <input type="number" value="${p.ctMultiplier}" step="0.1" min="0.5" max="3"
                   onchange="lineProducts[${i}].ctMultiplier = parseFloat(this.value) || 1;"
                   style="width: 50px; padding: 4px; background: transparent; border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); font-size: 12px; text-align: center;">
            <input type="color" value="${p.color}" onchange="lineProducts[${i}].color = this.value; renderProducts(); renderOrders();"
                   style="width: 24px; height: 24px; border: none; cursor: pointer;">
            ${lineProducts.length > 1 ? `<button onclick="removeProduct(${i})" style="background: none; border: none; color: var(--text-dim); cursor: pointer;">&times;</button>` : ''}
        </div>
    `).join('');
}

function addProduct() {
    const colors = ['#e74c3c', '#9b59b6', '#f39c12', '#1abc9c', '#e91e63'];
    const nextColor = colors[lineProducts.length % colors.length];
    const nextId = String.fromCharCode(65 + lineProducts.length); // A, B, C...
    lineProducts.push({
        id: nextId,
        name: `Product ${nextId}`,
        color: nextColor,
        ctMultiplier: 1.0 + (Math.random() * 0.4 - 0.2) // 0.8 to 1.2
    });
    renderProducts();
}

function removeProduct(idx) {
    if (lineProducts.length > 1) {
        lineProducts.splice(idx, 1);
        renderProducts();
        // Remove orders with this product
        lineOrders = lineOrders.filter(o => o.productIdx < lineProducts.length);
        renderOrders();
    }
}

// Order management
function renderOrders() {
    const tbody = document.getElementById('ls-orders-body');
    if (!tbody) return;

    if (lineOrders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="padding: 12px; text-align: center; color: var(--text-dim);"><em>No orders — click "Generate Sample" or add manually</em></td></tr>';
        return;
    }

    tbody.innerHTML = lineOrders.map((o, i) => {
        const product = lineProducts[o.productIdx] || lineProducts[0];
        const statusColor = o.status === 'complete' ? (o.wasLate ? '#e74c3c' : '#4a9f6e') :
                           o.status === 'in-progress' ? '#f39c12' : 'var(--text-dim)';
        const statusText = o.status === 'complete' ? (o.wasLate ? 'LATE' : 'ON TIME') :
                          o.status === 'in-progress' ? 'IN PROGRESS' : 'Pending';

        return `
            <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 6px; font-weight: 600;">#${o.id}</td>
                <td style="padding: 6px;"><span style="display: inline-block; width: 8px; height: 8px; background: ${product.color}; border-radius: 2px; margin-right: 6px;"></span>${product.name}</td>
                <td style="padding: 6px; text-align: right;">${o.qty}</td>
                <td style="padding: 6px; text-align: right;">${o.dueTime}s</td>
                <td style="padding: 6px; text-align: center; color: ${statusColor}; font-weight: 600; font-size: 11px;">${statusText}</td>
                <td style="padding: 6px;"><button onclick="removeOrder(${i})" style="background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 14px;">&times;</button></td>
            </tr>
        `;
    }).join('');
}

function addOrder() {
    lineOrders.push({
        id: orderIdCounter++,
        productIdx: lineOrders.length % lineProducts.length,
        qty: 5 + Math.floor(Math.random() * 10),
        dueTime: 300 + lineOrders.length * 200 + Math.floor(Math.random() * 100),
        status: 'pending',
        completedTime: null,
        wasLate: false,
        lateReason: null,
    });
    renderOrders();
}

function removeOrder(idx) {
    lineOrders.splice(idx, 1);
    renderOrders();
}

function generateSampleOrders() {
    lineOrders = [];
    orderIdCounter = 1;

    // Generate 6-8 orders with realistic timing
    const numOrders = 6 + Math.floor(Math.random() * 3);
    let cumulativeTime = 200;

    for (let i = 0; i < numOrders; i++) {
        const productIdx = i % lineProducts.length;
        const qty = 3 + Math.floor(Math.random() * 8);
        // Due time gives some slack but not too much
        const baseLeadTime = qty * 60; // ~60s per unit estimate
        const slack = 50 + Math.random() * 100;

        lineOrders.push({
            id: orderIdCounter++,
            productIdx,
            qty,
            dueTime: Math.round(cumulativeTime + baseLeadTime + slack),
            status: 'pending',
            completedTime: null,
            wasLate: false,
            lateReason: null,
        });

        cumulativeTime += baseLeadTime * 0.8; // Orders overlap slightly
    }

    renderOrders();
}

// Helper to update metrics during changeover or waiting
function updateOrderMetrics(simSecondsPerTick) {
    const takt = parseFloat(document.getElementById('ls-takt').value) || 60;
    const maxWip = parseInt(document.getElementById('ls-max-wip').value) || 5;

    // Update regular metrics even during changeover
    const totalWip = lineSimState.stationStats.reduce((sum, s) => sum + s.outputBuffer + (s.hasUnit ? (s.batchCount || 1) : 0), 0);
    const throughputPerHour = lineSimState.time > 0 ? (lineSimState.completed / lineSimState.time) * 3600 : 0;

    document.getElementById('ls-completed').textContent = lineSimState.completed;
    document.getElementById('ls-throughput').innerHTML = `${throughputPerHour.toFixed(1)}<span class="calc-result-unit">/hr</span>`;
    document.getElementById('ls-total-wip').textContent = totalWip;

    // Update delivery metrics
    updateDeliveryMetrics();

    // Update visual
    updateLineVisual(maxWip);
}

function updateDeliveryMetrics() {
    const completed = lineSimState.orderResults.filter(r => r.completedTime !== null);
    const onTime = completed.filter(r => !r.wasLate);
    const late = completed.filter(r => r.wasLate);

    const totalOrders = lineOrders.length;
    const otdPct = completed.length > 0 ? (onTime.length / completed.length) * 100 : 0;
    const avgLead = completed.length > 0 ?
        completed.reduce((sum, r) => sum + r.completedTime, 0) / completed.length : 0;

    document.getElementById('ls-otd').innerHTML = completed.length > 0 ?
        `<span style="color: ${otdPct >= 95 ? '#4a9f6e' : otdPct >= 80 ? '#f39c12' : '#e74c3c'}">${otdPct.toFixed(0)}</span><span class="calc-result-unit">%</span>` :
        '—<span class="calc-result-unit">%</span>';
    document.getElementById('ls-orders-complete').innerHTML = `${completed.length}<span class="calc-result-unit">/ ${totalOrders}</span>`;
    document.getElementById('ls-avg-lead').innerHTML = completed.length > 0 ?
        `${avgLead.toFixed(0)}<span class="calc-result-unit">sec</span>` : '—<span class="calc-result-unit">sec</span>';
    document.getElementById('ls-changeover-loss').innerHTML = `${lineSimState.totalChangeoverTime.toFixed(0)}<span class="calc-result-unit">sec</span>`;

    // Late order analysis
    const lateAnalysis = document.getElementById('ls-late-analysis');
    const lateOrdersDiv = document.getElementById('ls-late-orders');

    if (late.length > 0) {
        lateAnalysis.style.display = 'block';
        lateOrdersDiv.innerHTML = late.map(r => {
            const product = lineProducts[r.productIdx] || lineProducts[0];
            return `
                <div style="margin-bottom: 8px; padding: 8px; background: rgba(231, 76, 60, 0.1); border-radius: 4px;">
                    <div><strong>Order #${r.orderId}</strong> (${product.name}, ${r.qty} units)</div>
                    <div style="font-size: 12px;">Due: ${r.dueTime}s | Completed: ${r.completedTime.toFixed(0)}s | <span style="color: #e74c3c;">Late by ${(r.completedTime - r.dueTime).toFixed(0)}s</span></div>
                    ${r.lateReason ? `<div style="font-size: 12px; color: #e74c3c; margin-top: 4px;">📍 ${r.lateReason}</div>` : ''}
                </div>
            `;
        }).join('');
    } else {
        lateAnalysis.style.display = 'none';
    }
}

// Import stations from Yamazumi chart
function importFromYamazumi() {
    if (yamazumiData && yamazumiData.length > 0) {
        lineStations = yamazumiData.map(s => ({
            name: s.name,
            cycleTime: s.time
        }));
        renderLineStations();
        resetLineSim();
    } else {
        alert('No Yamazumi data found. Add stations to Yamazumi first.');
    }
}

// Toggle A/B compare panel
function toggleLineCompare() {
    const panel = document.getElementById('ls-compare-panel');
    const btn = document.getElementById('ls-compare-btn');
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        btn.style.background = 'var(--accent)';
        btn.style.color = 'white';
        btn.style.borderColor = 'var(--accent)';
        renderCompareStationOverrides();
    } else {
        panel.style.display = 'none';
        btn.style.background = 'var(--bg-secondary)';
        btn.style.color = 'var(--text-secondary)';
        btn.style.borderColor = 'var(--border)';
    }
}

function renderCompareStationOverrides() {
    const container = document.getElementById('ls-compare-b-stations');
    if (!container) return;

    container.innerHTML = lineStations.map((s, i) => `
        <div style="display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-card); border-radius: 4px;">
            <span style="font-size: 11px; color: var(--text-dim); width: 60px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${s.name}</span>
            <input type="number" id="ls-compare-b-st-${i}" value="" placeholder="${s.cycleTime}"
                   style="width: 50px; padding: 2px 4px; background: transparent; border: 1px solid var(--border); border-radius: 3px; color: var(--text-primary); font-size: 11px; text-align: center;">
        </div>
    `).join('');
}

function applyComparePreset(preset) {
    const cov = parseFloat(document.getElementById('ls-cov').value);
    const maxWip = parseInt(document.getElementById('ls-max-wip').value) || 5;
    const batchSize = parseInt(document.getElementById('ls-batch-size').value) || 1;

    // Find bottleneck
    let bottleneckIdx = 0;
    let maxCT = 0;
    lineStations.forEach((s, i) => {
        if (s.cycleTime > maxCT) { maxCT = s.cycleTime; bottleneckIdx = i; }
    });

    // Clear all first
    resetCompareB();

    switch (preset) {
        case 'reduce-bottleneck':
            document.getElementById(`ls-compare-b-st-${bottleneckIdx}`).value = Math.round(maxCT * 0.9);
            break;
        case 'add-buffer':
            document.getElementById('ls-compare-b-buffer').value = maxWip * 2;
            break;
        case 'one-piece':
            document.getElementById('ls-compare-b-batch').value = 1;
            break;
        case 'reduce-cov':
            document.getElementById('ls-compare-b-cov').value = Math.round(cov / 2);
            break;
    }
}

function resetCompareB() {
    document.getElementById('ls-compare-b-buffer').value = '';
    document.getElementById('ls-compare-b-cov').value = '';
    document.getElementById('ls-compare-b-batch').value = '';
    document.getElementById('ls-compare-b-ct-adj').value = '';
    lineStations.forEach((s, i) => {
        const input = document.getElementById(`ls-compare-b-st-${i}`);
        if (input) input.value = '';
    });
}

// Run A/B comparison simulation
function runLineCompare() {
    const cov = parseFloat(document.getElementById('ls-cov').value) / 100;
    const maxWip = parseInt(document.getElementById('ls-max-wip').value) || 5;
    const flowMode = document.getElementById('ls-flow-mode').value;
    const batchSize = flowMode === 'batch' ? parseInt(document.getElementById('ls-batch-size').value) || 5 : 1;

    // Get simulation settings
    const simDuration = parseInt(document.getElementById('ls-compare-duration').value) || 300;
    const warmupTime = parseInt(document.getElementById('ls-compare-warmup').value) || 0;

    // Generate random seed for fair comparison
    const seed = Math.random();

    // Status update
    const statusEl = document.getElementById('ls-compare-status');
    statusEl.textContent = 'Running simulations...';

    // Use setTimeout to allow UI update
    setTimeout(() => {
        // Run scenario A (current state)
        const resultA = runLineSimWithWarmup(lineStations, cov, maxWip, batchSize, seed, simDuration, warmupTime);

        // Build scenario B from inputs
        let stationsB = JSON.parse(JSON.stringify(lineStations));
        let covB = cov;
        let maxWipB = maxWip;
        let batchSizeB = batchSize;

        // Apply custom buffer
        const bufferB = document.getElementById('ls-compare-b-buffer').value;
        if (bufferB) maxWipB = parseInt(bufferB);

        // Apply custom CoV
        const covBInput = document.getElementById('ls-compare-b-cov').value;
        if (covBInput) covB = parseFloat(covBInput) / 100;

        // Apply custom batch size
        const batchB = document.getElementById('ls-compare-b-batch').value;
        if (batchB) batchSizeB = parseInt(batchB);

        // Apply bottleneck CT adjustment (percentage)
        const ctAdj = document.getElementById('ls-compare-b-ct-adj').value;
        if (ctAdj) {
            let bottleneckIdx = 0;
            let maxCT = 0;
            stationsB.forEach((s, i) => {
                if (s.cycleTime > maxCT) { maxCT = s.cycleTime; bottleneckIdx = i; }
            });
            stationsB[bottleneckIdx].cycleTime *= (1 + parseFloat(ctAdj) / 100);
        }

        // Apply station-specific overrides
        lineStations.forEach((s, i) => {
            const override = document.getElementById(`ls-compare-b-st-${i}`)?.value;
            if (override) stationsB[i].cycleTime = parseFloat(override);
        });

        const resultB = runLineSimWithWarmup(stationsB, covB, maxWipB, batchSizeB, seed, simDuration, warmupTime);

        // Display results
        const warmupNote = warmupTime > 0 ? ` <span style="color: var(--text-dim);">(after ${warmupTime}s warmup)</span>` : '';

        document.getElementById('ls-compare-a-stats').innerHTML = `
            <div style="margin-bottom: 4px;"><strong>Throughput:</strong> ${resultA.throughput.toFixed(1)}/hr</div>
            <div style="margin-bottom: 4px;"><strong>Units:</strong> ${resultA.completed}</div>
            <div style="margin-bottom: 4px;"><strong>Avg WIP:</strong> ${resultA.avgWip.toFixed(1)}</div>
            <div><strong>Efficiency:</strong> ${resultA.efficiency.toFixed(1)}%</div>
        `;

        document.getElementById('ls-compare-b-stats').innerHTML = `
            <div style="margin-bottom: 4px;"><strong>Throughput:</strong> ${resultB.throughput.toFixed(1)}/hr</div>
            <div style="margin-bottom: 4px;"><strong>Units:</strong> ${resultB.completed}</div>
            <div style="margin-bottom: 4px;"><strong>Avg WIP:</strong> ${resultB.avgWip.toFixed(1)}</div>
            <div><strong>Efficiency:</strong> ${resultB.efficiency.toFixed(1)}%</div>
        `;

        // Verdict
        const throughputDelta = resultA.throughput > 0 ? ((resultB.throughput - resultA.throughput) / resultA.throughput) * 100 : 0;
        const wipDelta = resultA.avgWip > 0 ? ((resultB.avgWip - resultA.avgWip) / resultA.avgWip) * 100 : 0;

        let verdict = '';
        if (throughputDelta > 5) {
            verdict = `<span style="color: #4a9f6e; font-weight: 600;">✓ B wins: +${throughputDelta.toFixed(1)}% throughput</span>`;
        } else if (throughputDelta < -5) {
            verdict = `<span style="color: #e74c3c; font-weight: 600;">✗ A wins: B is ${Math.abs(throughputDelta).toFixed(1)}% worse</span>`;
        } else {
            verdict = `<span style="color: #f39c12;">≈ Negligible difference (${throughputDelta > 0 ? '+' : ''}${throughputDelta.toFixed(1)}%)</span>`;
        }

        if (Math.abs(wipDelta) > 10) {
            verdict += `<span style="margin-left: 16px; color: var(--text-dim);">WIP: ${wipDelta > 0 ? '+' : ''}${wipDelta.toFixed(0)}%</span>`;
        }

        document.getElementById('ls-compare-verdict').innerHTML = verdict;
        statusEl.textContent = `Simulated ${simDuration}s${warmupTime > 0 ? ` (+ ${warmupTime}s warmup)` : ''}`;
    }, 10);
}

// Run simulation with optional warmup (non-visual, for comparison)
function runLineSimWithWarmup(stations, cov, maxWip, batchSize, seed, duration = 300, warmup = 0) {
    // Seeded random for reproducibility
    let rng = seed;
    const seededRandom = () => {
        rng = (rng * 9301 + 49297) % 233280;
        return rng / 233280;
    };

    const simDuration = duration + warmup;
    const dt = 0.5;

    let state = stations.map(() => ({
        working: 0, blocked: 0, starved: 0,
        timeRemaining: 0, outputBuffer: 0, hasUnit: false, batchCount: 0
    }));

    let completed = 0;
    let completedDuringMeasure = 0;
    let totalWip = 0;
    let wipSamples = 0;
    let inMeasurePhase = warmup === 0;

    for (let t = 0; t < simDuration; t += dt) {
        // Check if we just entered measure phase
        if (!inMeasurePhase && t >= warmup) {
            inMeasurePhase = true;
            completedDuringMeasure = 0; // Reset for measurement
        }
        // Process stations (last to first)
        for (let i = stations.length - 1; i >= 0; i--) {
            const station = stations[i];
            const st = state[i];
            const prevState = i > 0 ? state[i - 1] : null;
            const isFirst = i === 0;
            const isLast = i === stations.length - 1;

            const actualCT = station.cycleTime * (1 + (seededRandom() - 0.5) * 2 * cov);

            if (st.hasUnit) {
                st.timeRemaining -= dt;
                if (st.timeRemaining <= 0) {
                    if (isLast) {
                        completed += batchSize;
                        if (inMeasurePhase) completedDuringMeasure += batchSize;
                        st.hasUnit = false;
                        st.batchCount = 0;
                    } else if (st.outputBuffer < maxWip) {
                        st.outputBuffer += batchSize;
                        st.hasUnit = false;
                        st.batchCount = 0;
                    } else {
                        st.blocked += dt;
                    }
                } else {
                    st.working += dt;
                }
            } else {
                if (isFirst) {
                    st.hasUnit = true;
                    st.batchCount = batchSize;
                    st.timeRemaining = actualCT * batchSize;
                } else if (prevState && prevState.outputBuffer >= batchSize) {
                    prevState.outputBuffer -= batchSize;
                    st.hasUnit = true;
                    st.batchCount = batchSize;
                    st.timeRemaining = actualCT * batchSize;
                } else {
                    st.starved += dt;
                }
            }
        }

        // Only count metrics after warmup
        if (t >= warmup) {
            const wip = state.reduce((sum, s) => sum + s.outputBuffer + (s.hasUnit ? s.batchCount : 0), 0);
            totalWip += wip;
            wipSamples++;
        }
    }

    const totalWorking = state.reduce((sum, s) => sum + s.working, 0);
    const totalTime = state.reduce((sum, s) => sum + s.working + s.blocked + s.starved, 0);
    const measureDuration = duration; // Only the non-warmup portion

    return {
        completed: completedDuringMeasure,
        throughput: measureDuration > 0 ? (completedDuringMeasure / measureDuration) * 3600 : 0,
        avgWip: wipSamples > 0 ? totalWip / wipSamples : 0,
        efficiency: totalTime > 0 ? (totalWorking / totalTime) * 100 : 0,
    };
}

// Scenario management (localStorage)
const LINE_SCENARIOS_KEY = 'svend_line_scenarios';

function getLineScenarios() {
    try {
        return JSON.parse(localStorage.getItem(LINE_SCENARIOS_KEY) || '{}');
    } catch {
        return {};
    }
}

function saveLineScenario() {
    const name = document.getElementById('ls-scenario-name').value.trim();
    if (!name) {
        alert('Please enter a scenario name');
        return;
    }

    const scenario = {
        stations: JSON.parse(JSON.stringify(lineStations)),
        takt: document.getElementById('ls-takt').value,
        cov: document.getElementById('ls-cov').value,
        maxWip: document.getElementById('ls-max-wip').value,
        flowMode: document.getElementById('ls-flow-mode').value,
        batchSize: document.getElementById('ls-batch-size').value,
        breakdowns: document.getElementById('ls-breakdowns').checked,
        savedAt: new Date().toISOString(),
    };

    const scenarios = getLineScenarios();
    scenarios[name] = scenario;
    localStorage.setItem(LINE_SCENARIOS_KEY, JSON.stringify(scenarios));

    document.getElementById('ls-scenario-name').value = '';
    refreshScenarioDropdown();
    alert(`Scenario "${name}" saved!`);
}

function loadLineScenario() {
    const select = document.getElementById('ls-scenarios');
    const name = select.value;
    if (!name) return;

    const scenarios = getLineScenarios();
    const scenario = scenarios[name];
    if (!scenario) return;

    // Stop any running simulation
    resetLineSim();

    // Load settings
    lineStations = JSON.parse(JSON.stringify(scenario.stations));
    document.getElementById('ls-takt').value = scenario.takt || 60;
    document.getElementById('ls-cov').value = scenario.cov || 15;
    document.getElementById('ls-max-wip').value = scenario.maxWip || 5;
    document.getElementById('ls-flow-mode').value = scenario.flowMode || 'one-piece';
    document.getElementById('ls-batch-size').value = scenario.batchSize || 5;
    document.getElementById('ls-breakdowns').checked = scenario.breakdowns || false;

    renderLineStations();
    updateLineSimParams();
}

function deleteLineScenario() {
    const select = document.getElementById('ls-scenarios');
    const name = select.value;
    if (!name) return;

    if (!confirm(`Delete scenario "${name}"?`)) return;

    const scenarios = getLineScenarios();
    delete scenarios[name];
    localStorage.setItem(LINE_SCENARIOS_KEY, JSON.stringify(scenarios));
    refreshScenarioDropdown();
}

function refreshScenarioDropdown() {
    const select = document.getElementById('ls-scenarios');
    const scenarios = getLineScenarios();

    select.innerHTML = '<option value="">— Select saved scenario —</option>';
    Object.keys(scenarios).sort().forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
    });
}

function exportLineReport() {
    if (lineSimState.time < 10) {
        alert('Run the simulation first to generate data for the report.');
        return;
    }

    const takt = parseFloat(document.getElementById('ls-takt').value) || 60;
    const cov = parseFloat(document.getElementById('ls-cov').value);
    const maxWip = parseInt(document.getElementById('ls-max-wip').value) || 5;
    const flowMode = document.getElementById('ls-flow-mode').value;
    const batchSize = flowMode === 'batch' ? parseInt(document.getElementById('ls-batch-size').value) || 5 : 1;

    // Find bottleneck
    let bottleneckIdx = 0;
    let maxCT = 0;
    lineStations.forEach((s, i) => {
        if (s.cycleTime > maxCT) { maxCT = s.cycleTime; bottleneckIdx = i; }
    });

    const theoreticalThroughput = 3600 / maxCT;
    const actualThroughput = (lineSimState.completed / lineSimState.time) * 3600;
    const totalWip = lineSimState.stationStats.reduce((sum, s) => sum + s.outputBuffer + (s.hasUnit ? (s.batchCount || 1) : 0), 0);

    let report = `LINE SIMULATION REPORT
Generated: ${new Date().toLocaleString()}
================================================================================

CONFIGURATION
─────────────────────────────────────────────────────────────────────────────────
Takt Time:           ${takt} seconds
Variability (CoV):   ${cov}%
Buffer Capacity:     ${maxWip} units per station
Flow Mode:           ${flowMode === 'batch' ? `Batch (${batchSize} units)` : 'One-Piece Flow'}

STATIONS
─────────────────────────────────────────────────────────────────────────────────
`;

    lineStations.forEach((station, i) => {
        const state = lineSimState.stationStats[i];
        const totalTime = state.working + state.blocked + state.starved + (state.downtime || 0);
        const workPct = totalTime > 0 ? (state.working / totalTime) * 100 : 0;
        const blockPct = totalTime > 0 ? (state.blocked / totalTime) * 100 : 0;
        const starvePct = totalTime > 0 ? (state.starved / totalTime) * 100 : 0;

        report += `${station.name.padEnd(15)} CT: ${station.cycleTime}s | Processed: ${state.processed} | Working: ${workPct.toFixed(1)}% | Blocked: ${blockPct.toFixed(1)}% | Starved: ${starvePct.toFixed(1)}%\n`;
    });

    report += `
RESULTS (${(lineSimState.time / 60).toFixed(1)} minutes simulated)
─────────────────────────────────────────────────────────────────────────────────
Units Completed:       ${lineSimState.completed}
Actual Throughput:     ${actualThroughput.toFixed(1)} units/hour
Theoretical Max:       ${theoreticalThroughput.toFixed(1)} units/hour
Efficiency:            ${((actualThroughput / theoreticalThroughput) * 100).toFixed(1)}%
Total WIP:             ${totalWip} units

CONSTRAINT ANALYSIS
─────────────────────────────────────────────────────────────────────────────────
Bottleneck Station:    ${lineStations[bottleneckIdx].name} (CT: ${maxCT}s)
Capacity Loss:         ${(theoreticalThroughput - actualThroughput).toFixed(1)} units/hour
`;

    if (flowMode === 'batch') {
        report += `\n⚠ BATCH MODE ACTIVE: WIP is elevated due to batch processing. Consider one-piece flow.\n`;
    }

    if (maxCT > takt) {
        report += `\n⚠ TAKT VIOLATION: ${lineStations[bottleneckIdx].name} CT (${maxCT}s) exceeds takt time (${takt}s).\n`;
    }

    report += `
================================================================================
Report generated by SVEND Operations Workbench
`;

    // Copy to clipboard and offer download
    navigator.clipboard.writeText(report).then(() => {
        const blob = new Blob([report], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `line-sim-report-${new Date().toISOString().slice(0, 10)}.txt`;
        a.click();
        URL.revokeObjectURL(url);
    });
}

function initLineSim() {
    renderLineStations();
    updateLineSimParams();
    renderCompareStationOverrides();
    refreshScenarioDropdown();
    renderProducts();
    generateSampleOrders(); // Start with sample orders
}

// ============================================================================
// Kanban
// ============================================================================

function calcKanban() {
    const demand = parseFloat(document.getElementById('kanban-demand').value) || 0;
    const lead = parseFloat(document.getElementById('kanban-lead').value) || 0;
    const safetyPct = parseFloat(document.getElementById('kanban-safety').value) || 0;
    const container = parseFloat(document.getElementById('kanban-container').value) || 1;

    const base = demand * lead;
    const safety = base * (safetyPct / 100);
    const total = base + safety;
    const cards = Math.ceil(total / container);

    document.getElementById('kanban-base').innerHTML = `${Math.round(base)}<span class="calc-result-unit">units</span>`;
    document.getElementById('kanban-ss').innerHTML = `${Math.round(safety)}<span class="calc-result-unit">units</span>`;
    document.getElementById('kanban-cards').innerHTML = `${cards}<span class="calc-result-unit">cards</span>`;
    document.getElementById('kanban-total').textContent = `${Math.round(total)} units`;

    // Update derivation
    document.getElementById('kanban-derivation-body').innerHTML = `
        <div class="step">
            <div class="step-num">Step 1: Calculate Base Stock</div>
            <span class="formula">Base = Demand × Lead Time</span><br>
            Base = ${demand} × ${lead} = <strong>${Math.round(base)} units</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 2: Calculate Safety Stock</div>
            <span class="formula">Safety = Base × Safety Factor %</span><br>
            Safety = ${Math.round(base)} × ${safetyPct}% = <strong>${Math.round(safety)} units</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 3: Calculate Kanban Cards</div>
            <span class="formula">Cards = ⌈(Base + Safety) ÷ Container Size⌉</span><br>
            Cards = ⌈(${Math.round(base)} + ${Math.round(safety)}) ÷ ${container}⌉ = ⌈${(total / container).toFixed(2)}⌉ = <strong>${cards} cards</strong>
        </div>
        <div class="step">
            <div class="step-num">Interpretation</div>
            Total inventory in the loop: <strong>${Math.round(total)} units</strong> across ${cards} containers of ${container} units each.
        </div>
    `;

    // Publish to shared state
    SvendOps.publish('kanbanCards', cards, 'cards', 'Kanban');
    SvendOps.publish('kanbanInventory', Math.round(total), 'units', 'Kanban');

    // Kanban pipeline visual
    const baseCards = Math.ceil(base / container);
    const safetyCards = cards - baseCards;
    const baseTokens = Array(Math.min(baseCards, 12)).fill('<span style="display:inline-block;width:18px;height:24px;background:#4a9f6e;border-radius:3px;margin:2px;"></span>').join('');
    const safetyTokens = Array(Math.min(safetyCards, 6)).fill('<span style="display:inline-block;width:18px;height:24px;background:#f39c12;border-radius:3px;margin:2px;"></span>').join('');
    const vis = document.getElementById('kanban-visual');
    vis.innerHTML = `
        <div style="display:flex;align-items:center;gap:16px;justify-content:center;flex-wrap:wrap;">
            <div style="text-align:center;padding:12px 16px;border:1px solid var(--border);border-radius:8px;background:var(--bg-secondary);">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#9aaa9a" stroke-width="2"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
                <div style="font-size:11px;color:var(--text-dim);margin-top:4px;">Supplier</div>
            </div>
            <div style="font-size:20px;color:var(--text-dim);">→</div>
            <div style="text-align:center;padding:8px 12px;min-width:80px;">
                <div style="display:flex;flex-wrap:wrap;justify-content:center;max-width:240px;">${baseTokens}${safetyTokens}</div>
                <div style="font-size:11px;color:var(--text-dim);margin-top:6px;">
                    <span style="color:#4a9f6e;">${baseCards} base</span> + <span style="color:#f39c12;">${safetyCards} safety</span> = ${cards} cards
                </div>
                <div style="font-size:10px;color:var(--text-dim);">${cards} × ${container} = ${Math.round(total)} units in loop</div>
            </div>
            <div style="font-size:20px;color:var(--text-dim);">→</div>
            <div style="text-align:center;padding:12px 16px;border:1px solid var(--border);border-radius:8px;background:var(--bg-secondary);">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#9aaa9a" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                <div style="font-size:11px;color:var(--text-dim);margin-top:4px;">Customer</div>
            </div>
        </div>`;
    vis.style.display = 'block';
}

function toggleKanbanMonteCarlo(btn) {
    btn.classList.toggle('active');
    const results = document.getElementById('kanban-monte-results');
    results.classList.toggle('visible');
    if (btn.classList.contains('active')) { runKanbanMonteCarlo(); }
}

function runKanbanMonteCarlo() {
    const demand = parseFloat(document.getElementById('kanban-demand').value) || 0;
    const lead = parseFloat(document.getElementById('kanban-lead').value) || 0;
    const safetyPct = parseFloat(document.getElementById('kanban-safety').value) || 0;
    const container = parseFloat(document.getElementById('kanban-container').value) || 1;

    const calcCards = (d, l, sf) => {
        const base = d * l;
        const safety = base * (sf / 100);
        return Math.ceil((base + safety) / container);
    };

    const inputs = [
        { value: demand, cv: 0.1 },
        { value: lead, cv: 0.15 },
        { value: safetyPct, cv: 0.1 }
    ];

    const sim = MonteCarlo.simulate(calcCards, inputs, 2000);

    document.getElementById('kanban-monte-mean').textContent = sim.mean.toFixed(1);
    document.getElementById('kanban-monte-p5').textContent = Math.round(sim.p5);
    document.getElementById('kanban-monte-p95').textContent = Math.round(sim.p95);
    document.getElementById('kanban-monte-std').textContent = `±${sim.std.toFixed(1)}`;

    MonteCarlo.renderHistogram('kanban-monte-chart', sim, 'Kanban Cards Distribution (2000 runs)', 'cards');
}

// ============================================================================
// EPEI
// ============================================================================

function calcEPEI() {
    const available = parseFloat(document.getElementById('epei-available').value) || 0;
    const parts = parseFloat(document.getElementById('epei-parts').value) || 1;
    const changeover = parseFloat(document.getElementById('epei-changeover').value) || 0;
    const targetPct = parseFloat(document.getElementById('epei-target').value) || 10;

    const totalCO = parts * changeover;
    const budget = available * 60 * (targetPct / 100);
    const epei = totalCO / budget;

    document.getElementById('epei-result').innerHTML = `${epei.toFixed(1)}<span class="calc-result-unit">days</span>`;
    document.getElementById('epei-total').innerHTML = `${totalCO}<span class="calc-result-unit">min</span>`;
    document.getElementById('epei-budget').innerHTML = `${Math.round(budget)}<span class="calc-result-unit">min</span>`;
    document.getElementById('epei-interpret').textContent = epei.toFixed(1);

    // Update derivation
    document.getElementById('epei-derivation-body').innerHTML = `
        <div class="step">
            <div class="step-num">Step 1: Total Changeover Time per Cycle</div>
            <span class="formula">Total C/O = Parts × Changeover Time</span><br>
            Total C/O = ${parts} × ${changeover} = <strong>${totalCO} min</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 2: Changeover Budget per Day</div>
            <span class="formula">Budget = Available Hours × 60 × Target %</span><br>
            Budget = ${available} × 60 × ${targetPct}% = <strong>${Math.round(budget)} min/day</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 3: Calculate EPEI</div>
            <span class="formula">EPEI = Total C/O ÷ Daily Budget</span><br>
            EPEI = ${totalCO} ÷ ${Math.round(budget)} = <strong>${epei.toFixed(1)} days</strong>
        </div>
        <div class="step">
            <div class="step-num">Interpretation</div>
            With ${parts} parts and ${changeover} min per changeover, you can run <strong>Every Part Every ${epei.toFixed(1)} days</strong> within the ${targetPct}% time budget.
        </div>
    `;

    // Publish to shared state
    SvendOps.publish('epei', epei, 'days', 'EPEI');

    renderNextSteps('epei-next-steps', [
        { title: 'Build Heijunka Box', desc: 'Create a level schedule from EPEI', calcId: 'heijunka' },
        { title: 'Run SMED Event', desc: 'Reduce changeover to shorten EPEI', calcId: 'smed' },
    ]);
}

// ============================================================================
// Safety Stock
// ============================================================================

function calcSafety() {
    const demand = parseFloat(document.getElementById('safety-demand').value) || 0;
    const demandStd = parseFloat(document.getElementById('safety-demand-std').value) || 0;
    const lead = parseFloat(document.getElementById('safety-lead').value) || 0;
    const leadStd = parseFloat(document.getElementById('safety-lead-std').value) || 0;
    const z = parseFloat(document.getElementById('safety-service').value) || 1.65;

    const combined = Math.sqrt((lead * demandStd * demandStd) + (demand * demand * leadStd * leadStd));
    const safety = z * combined;
    const rop = (demand * lead) + safety;
    const meanDemand = demand * lead;

    document.getElementById('safety-result').innerHTML = `${Math.round(safety)}<span class="calc-result-unit">units</span>`;
    document.getElementById('safety-rop').innerHTML = `${Math.round(rop)}<span class="calc-result-unit">units</span>`;
    document.getElementById('safety-z').textContent = z.toFixed(2);
    document.getElementById('safety-combined').textContent = `${Math.round(combined)} units`;

    // Normal distribution curve
    const xMin = meanDemand - 4 * combined;
    const xMax = meanDemand + 4 * combined;
    const step = (xMax - xMin) / 100;
    const xVals = [];
    const yVals = [];
    const fillX = [];
    const fillY = [];

    for (let x = xMin; x <= xMax; x += step) {
        const y = Math.exp(-0.5 * Math.pow((x - meanDemand) / combined, 2)) / (combined * Math.sqrt(2 * Math.PI));
        xVals.push(x);
        yVals.push(y);
        if (x <= rop) {
            fillX.push(x);
            fillY.push(y);
        }
    }

    Plotly.newPlot('safety-chart', [
        {
            x: fillX,
            y: fillY,
            type: 'scatter',
            mode: 'none',
            fill: 'tozeroy',
            fillcolor: 'rgba(74, 159, 110, 0.4)',
            name: 'Service Level',
            hoverinfo: 'skip'
        },
        {
            x: xVals,
            y: yVals,
            type: 'scatter',
            mode: 'lines',
            name: 'Demand Distribution',
            line: { color: '#4a9f6e', width: 2 }
        }
    ], {
        shapes: [
            {
                type: 'line',
                x0: meanDemand, x1: meanDemand,
                y0: 0, y1: Math.max(...yVals) * 1.1,
                line: { color: '#3a7f8f', width: 2, dash: 'dash' }
            },
            {
                type: 'line',
                x0: rop, x1: rop,
                y0: 0, y1: Math.max(...yVals) * 1.1,
                line: { color: '#e74c3c', width: 2 }
            }
        ],
        annotations: [
            {
                x: meanDemand, y: Math.max(...yVals) * 1.05,
                text: `Mean: ${Math.round(meanDemand)}`,
                showarrow: false,
                font: { color: '#3a7f8f', size: 11 }
            },
            {
                x: rop, y: Math.max(...yVals) * 0.85,
                text: `ROP: ${Math.round(rop)}`,
                showarrow: false,
                font: { color: '#e74c3c', size: 11 },
                xanchor: 'left'
            }
        ],
        margin: { t: 20, b: 40, l: 50, r: 20 },
        paper_bgcolor: 'transparent',
        plot_bgcolor: 'transparent',
        font: { color: '#9aaa9a' },
        xaxis: {
            title: 'Demand During Lead Time (units)',
            gridcolor: 'rgba(255,255,255,0.1)',
            zeroline: false
        },
        yaxis: {
            title: 'Probability',
            gridcolor: 'rgba(255,255,255,0.1)',
            zeroline: false,
            showticklabels: false
        },
        showlegend: false
    }, { responsive: true, displayModeBar: false });

    // Update derivation
    document.getElementById('safety-derivation-body').innerHTML = `
        <div class="step">
            <div class="step-num">Step 1: Mean Demand During Lead Time</div>
            <span class="formula">Mean = Demand × Lead Time</span><br>
            Mean = ${demand} × ${lead} = <strong>${Math.round(meanDemand)} units</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 2: Combined Standard Deviation</div>
            <span class="formula">σ_combined = √(LT × σ_d² + D² × σ_LT²)</span><br>
            = √(${lead} × ${demandStd}² + ${demand}² × ${leadStd}²)<br>
            = √(${(lead * demandStd * demandStd).toFixed(0)} + ${(demand * demand * leadStd * leadStd).toFixed(0)}) = <strong>${combined.toFixed(1)} units</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 3: Safety Stock</div>
            <span class="formula">Safety Stock = Z × σ_combined</span><br>
            = ${z.toFixed(2)} × ${combined.toFixed(1)} = <strong>${Math.round(safety)} units</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 4: Reorder Point</div>
            <span class="formula">ROP = Mean Demand + Safety Stock</span><br>
            ROP = ${Math.round(meanDemand)} + ${Math.round(safety)} = <strong>${Math.round(rop)} units</strong>
        </div>
    `;

    // Publish to shared state
    SvendOps.publish('safetyStock', Math.round(safety), 'units', 'Safety Stock');
    SvendOps.publish('rop', Math.round(rop), 'units', 'Safety Stock');

    renderNextSteps('safety-next-steps', [
        { title: 'Size Kanbans', desc: 'Calculate kanban cards including safety stock', calcId: 'kanban' },
        { title: 'Set Reorder Qty', desc: 'Find optimal order quantity with EOQ', calcId: 'eoq' },
        { title: 'Check Turns', desc: 'Evaluate inventory turns performance', calcId: 'turns' },
    ]);
}

function toggleSafetyMonteCarlo(btn) {
    btn.classList.toggle('active');
    const results = document.getElementById('safety-monte-results');
    results.classList.toggle('visible');
    if (btn.classList.contains('active')) { runSafetyMonteCarlo(); }
}

function runSafetyMonteCarlo() {
    const demand = parseFloat(document.getElementById('safety-demand').value) || 0;
    const demandStd = parseFloat(document.getElementById('safety-demand-std').value) || 0;
    const lead = parseFloat(document.getElementById('safety-lead').value) || 0;
    const leadStd = parseFloat(document.getElementById('safety-lead-std').value) || 0;
    const z = parseFloat(document.getElementById('safety-service').value) || 1.65;

    const calcSS = (d, ds, l, ls) => {
        return z * Math.sqrt(l * ds * ds + d * d * ls * ls);
    };

    const inputs = [
        { value: demand, cv: 0.1 },
        { value: demandStd, cv: 0.15 },
        { value: lead, cv: 0.1 },
        { value: leadStd, cv: 0.15 }
    ];

    const sim = MonteCarlo.simulate(calcSS, inputs, 2000);

    document.getElementById('safety-monte-mean').textContent = Math.round(sim.mean);
    document.getElementById('safety-monte-p5').textContent = Math.round(sim.p5);
    document.getElementById('safety-monte-p95').textContent = Math.round(sim.p95);
    document.getElementById('safety-monte-std').textContent = `±${Math.round(sim.std)}`;

    MonteCarlo.renderHistogram('safety-monte-chart', sim, 'Safety Stock Distribution (2000 runs)', 'units');
}

// ============================================================================
// EOQ
// ============================================================================

function calcEOQ() {
    const demand = parseFloat(document.getElementById('eoq-demand').value) || 0;
    const orderCost = parseFloat(document.getElementById('eoq-order').value) || 0;
    const unitCost = parseFloat(document.getElementById('eoq-unit').value) || 0;
    const holdingPct = parseFloat(document.getElementById('eoq-holding').value) || 0;

    const holding = unitCost * (holdingPct / 100);
    const eoq = Math.sqrt((2 * demand * orderCost) / holding);
    const orders = demand / eoq;
    const annualOrder = orders * orderCost;
    const annualHold = (eoq / 2) * holding;
    const total = annualOrder + annualHold;

    document.getElementById('eoq-result').innerHTML = `${Math.round(eoq)}<span class="calc-result-unit">units</span>`;
    document.getElementById('eoq-orders').textContent = Math.round(orders);
    document.getElementById('eoq-order-cost').textContent = `$${Math.round(annualOrder).toLocaleString()}`;
    document.getElementById('eoq-hold-cost').textContent = `$${Math.round(annualHold).toLocaleString()}`;
    document.getElementById('eoq-total').textContent = `$${Math.round(total).toLocaleString()}`;

    // EOQ Cost Curve
    const minQ = Math.max(50, eoq * 0.2);
    const maxQ = eoq * 3;
    const step = (maxQ - minQ) / 50;
    const quantities = [];
    const orderCosts = [];
    const holdCosts = [];
    const totalCosts = [];

    for (let q = minQ; q <= maxQ; q += step) {
        quantities.push(Math.round(q));
        const oc = (demand / q) * orderCost;
        const hc = (q / 2) * holding;
        orderCosts.push(oc);
        holdCosts.push(hc);
        totalCosts.push(oc + hc);
    }

    Plotly.newPlot('eoq-chart', [
        {
            x: quantities,
            y: orderCosts,
            type: 'scatter',
            mode: 'lines',
            name: 'Order Cost',
            line: { color: '#3a7f8f', width: 2 }
        },
        {
            x: quantities,
            y: holdCosts,
            type: 'scatter',
            mode: 'lines',
            name: 'Holding Cost',
            line: { color: '#e89547', width: 2 }
        },
        {
            x: quantities,
            y: totalCosts,
            type: 'scatter',
            mode: 'lines',
            name: 'Total Cost',
            line: { color: '#4a9f6e', width: 3 }
        }
    ], {
        shapes: [{
            type: 'line',
            x0: eoq, x1: eoq,
            y0: 0, y1: total * 1.5,
            line: { color: '#e74c3c', width: 2, dash: 'dash' }
        }],
        annotations: [{
            x: eoq, y: total,
            text: `EOQ: ${Math.round(eoq)}`,
            showarrow: true,
            arrowhead: 2,
            arrowcolor: '#e74c3c',
            font: { color: '#e74c3c', size: 12 },
            ax: 40, ay: -30
        }],
        margin: { t: 20, b: 50, l: 60, r: 20 },
        paper_bgcolor: 'transparent',
        plot_bgcolor: 'transparent',
        font: { color: '#9aaa9a' },
        xaxis: {
            title: 'Order Quantity',
            gridcolor: 'rgba(255,255,255,0.1)',
            zeroline: false
        },
        yaxis: {
            title: 'Annual Cost ($)',
            gridcolor: 'rgba(255,255,255,0.1)',
            zeroline: false
        },
        legend: {
            orientation: 'h',
            y: -0.35,
            x: 0.5,
            xanchor: 'center'
        },
        hovermode: 'x unified'
    }, { responsive: true, displayModeBar: false });

    // Update derivation
    document.getElementById('eoq-derivation-body').innerHTML = `
        <div class="step">
            <div class="step-num">Step 1: Calculate Annual Holding Cost Rate</div>
            <span class="formula">H = Unit Cost × Holding %</span><br>
            H = $${unitCost} × ${holdingPct}% = <strong>$${holding.toFixed(2)}/unit/year</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 2: Apply EOQ Formula</div>
            <span class="formula">EOQ = √(2DS / H)</span><br>
            Where D = ${demand.toLocaleString()} units/year, S = $${orderCost}/order, H = $${holding.toFixed(2)}/unit/year<br>
            EOQ = √(2 × ${demand.toLocaleString()} × ${orderCost} / ${holding.toFixed(2)})<br>
            EOQ = √(${(2 * demand * orderCost).toLocaleString()} / ${holding.toFixed(2)})<br>
            EOQ = √${Math.round(2 * demand * orderCost / holding).toLocaleString()} = <strong>${Math.round(eoq)} units</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 3: Verify Cost Balance</div>
            <span class="formula">At EOQ, Order Cost = Holding Cost (optimal point)</span><br>
            Order Cost = (D/Q) × S = (${demand.toLocaleString()}/${Math.round(eoq)}) × $${orderCost} = <strong>$${Math.round(annualOrder).toLocaleString()}</strong><br>
            Holding Cost = (Q/2) × H = (${Math.round(eoq)}/2) × $${holding.toFixed(2)} = <strong>$${Math.round(annualHold).toLocaleString()}</strong><br>
            ✓ Costs are balanced at the optimal point
        </div>
    `;

    // Publish to shared state
    SvendOps.publish('eoq', Math.round(eoq), 'units', 'EOQ');
}

function toggleEOQMonteCarlo(btn) {
    btn.classList.toggle('active');
    const results = document.getElementById('eoq-monte-results');
    results.classList.toggle('visible');

    if (btn.classList.contains('active')) {
        runEOQMonteCarlo();
    }
}

function runEOQMonteCarlo() {
    const demand = parseFloat(document.getElementById('eoq-demand').value) || 0;
    const orderCost = parseFloat(document.getElementById('eoq-order').value) || 0;
    const unitCost = parseFloat(document.getElementById('eoq-unit').value) || 0;
    const holdingPct = parseFloat(document.getElementById('eoq-holding').value) || 0;

    // EOQ formula with variable inputs
    const calcEOQValue = (d, s, h) => {
        const holding = unitCost * (h / 100);
        return Math.sqrt((2 * d * s) / holding);
    };

    const inputs = [
        { value: demand, cv: 0.1 },      // ±10% demand variability
        { value: orderCost, cv: 0.1 },   // ±10% order cost variability
        { value: holdingPct, cv: 0.1 }   // ±10% holding cost variability
    ];

    const sim = MonteCarlo.simulate(calcEOQValue, inputs, 2000);

    document.getElementById('eoq-monte-mean').textContent = Math.round(sim.mean);
    document.getElementById('eoq-monte-p5').textContent = Math.round(sim.p5);
    document.getElementById('eoq-monte-p95').textContent = Math.round(sim.p95);
    document.getElementById('eoq-monte-std').textContent = `±${Math.round(sim.std)}`;

    MonteCarlo.renderHistogram('eoq-monte-chart', sim, 'EOQ Distribution (2000 runs)', 'units');
}

// ============================================================================
// OEE
// ============================================================================

function calcOEE() {
    const planned = parseFloat(document.getElementById('oee-planned').value) || 0;
    const downtime = parseFloat(document.getElementById('oee-downtime').value) || 0;
    const ideal = parseFloat(document.getElementById('oee-ideal').value) || 1;
    const produced = parseFloat(document.getElementById('oee-produced').value) || 0;
    const defects = parseFloat(document.getElementById('oee-defects').value) || 0;

    const runtime = planned - downtime;
    const good = produced - defects;
    const availability = runtime / planned;
    const performance = Math.min(1, (produced * ideal / 60) / runtime);
    const quality = good / produced;
    const oee = availability * performance * quality * 100;

    const oeeEl = document.getElementById('oee-result');
    oeeEl.textContent = `${oee.toFixed(1)}%`;
    oeeEl.className = 'oee-value ' + (oee >= 85 ? 'oee-world-class' : oee >= 65 ? 'oee-good' : 'oee-poor');

    document.getElementById('oee-availability').textContent = `${(availability * 100).toFixed(1)}%`;
    document.getElementById('oee-performance').textContent = `${(performance * 100).toFixed(1)}%`;
    document.getElementById('oee-quality').textContent = `${(quality * 100).toFixed(1)}%`;
    document.getElementById('oee-runtime').textContent = `${runtime} min`;
    document.getElementById('oee-good').textContent = `${good} units`;

    // Update derivation
    document.getElementById('oee-derivation-body').innerHTML = `
        <div class="step">
            <div class="step-num">Step 1: Availability</div>
            <span class="formula">Availability = (Planned − Downtime) ÷ Planned</span><br>
            = (${planned} − ${downtime}) ÷ ${planned} = ${runtime} ÷ ${planned} = <strong>${(availability * 100).toFixed(1)}%</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 2: Performance</div>
            <span class="formula">Performance = (Produced × Ideal Cycle) ÷ Runtime</span><br>
            = (${produced} × ${ideal}/60) ÷ ${runtime} = <strong>${(performance * 100).toFixed(1)}%</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 3: Quality</div>
            <span class="formula">Quality = (Produced − Defects) ÷ Produced</span><br>
            = (${produced} − ${defects}) ÷ ${produced} = ${good} ÷ ${produced} = <strong>${(quality * 100).toFixed(1)}%</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 4: OEE</div>
            <span class="formula">OEE = Availability × Performance × Quality</span><br>
            = ${(availability * 100).toFixed(1)}% × ${(performance * 100).toFixed(1)}% × ${(quality * 100).toFixed(1)}% = <strong>${oee.toFixed(1)}%</strong>
        </div>
    `;

    // OEE Loss Breakdown Donut Chart
    const availLoss = (1 - availability) * 100;
    const perfLoss = availability * (1 - performance) * 100;
    const qualLoss = availability * performance * (1 - quality) * 100;

    Plotly.newPlot('oee-chart', [{
        values: [oee, availLoss, perfLoss, qualLoss],
        labels: ['OEE', 'Avail Loss', 'Perf Loss', 'Quality Loss'],
        type: 'pie',
        hole: 0.55,
        marker: {
            colors: [
                oee >= 85 ? '#27ae60' : oee >= 65 ? '#f39c12' : '#e74c3c',
                '#e74c3c',
                '#f39c12',
                '#9b59b6'
            ]
        },
        textinfo: 'percent',
        textposition: 'inside',
        textfont: { size: 12, color: '#fff' },
        hovertemplate: '%{label}: %{value:.1f}%<extra></extra>',
        sort: false
    }], {
        margin: { t: 10, b: 40, l: 10, r: 10 },
        paper_bgcolor: 'transparent',
        showlegend: true,
        legend: {
            orientation: 'h',
            y: -0.1,
            x: 0.5,
            xanchor: 'center',
            font: { size: 10, color: '#9aaa9a' }
        },
        annotations: [{
            text: `<b>${oee.toFixed(0)}%</b>`,
            showarrow: false,
            font: { size: 32, color: oee >= 85 ? '#27ae60' : oee >= 65 ? '#f39c12' : '#e74c3c' }
        }]
    }, { responsive: true, displayModeBar: false });

    // Publish to shared state
    SvendOps.publish('oee', oee, '%', 'OEE');
    SvendOps.publish('oeeAvailability', parseFloat((availability * 100).toFixed(1)), '%', 'OEE');

    renderNextSteps('oee-next-steps', [
        { title: 'Bottleneck Analysis', desc: 'Find the constraint driving downtime', calcId: 'bottleneck' },
        { title: 'SMED', desc: 'Reduce changeover to improve availability', calcId: 'smed' },
        { title: 'Line Efficiency', desc: 'Check labor utilization on this line', calcId: 'lineeff' },
    ]);
}

// ============================================================================
// Bottleneck
// ============================================================================

let bottleneckData = [
    { name: 'Cutting', time: 45 },
    { name: 'Welding', time: 72 },
    { name: 'Assembly', time: 58 },
    { name: 'Testing', time: 40 },
];

function renderBottleneckInputs() {
    const container = document.getElementById('bottleneck-stations');
    container.innerHTML = bottleneckData.map((s, i) => `
        <div class="bottleneck-station">
            <input type="text" value="${s.name}" oninput="updateBottleneckName(${i}, this.value)">
            <input type="number" value="${s.time}" oninput="updateBottleneckTime(${i}, this.value)">
            <span style="color: var(--text-dim);">sec</span>
            <button class="yamazumi-station-remove" onclick="removeBottleneckStation(${i})">&times;</button>
        </div>
    `).join('');
    renderBottleneck();
}

function addBottleneckStation() {
    bottleneckData.push({ name: `Step ${bottleneckData.length + 1}`, time: 30 });
    renderBottleneckInputs();
}

function removeBottleneckStation(idx) {
    bottleneckData.splice(idx, 1);
    renderBottleneckInputs();
}

function updateBottleneckName(idx, value) {
    bottleneckData[idx].name = value;
    renderBottleneck();
}

function updateBottleneckTime(idx, value) {
    bottleneckData[idx].time = parseFloat(value) || 0;
    renderBottleneck();
}

function renderBottleneck() {
    if (bottleneckData.length === 0) return;

    const maxTime = Math.max(...bottleneckData.map(s => s.time));
    const bottleneckIdx = bottleneckData.findIndex(s => s.time === maxTime);
    const colors = bottleneckData.map((s, i) => i === bottleneckIdx ? '#e74c3c' : '#4a9f6e');

    Plotly.newPlot('bottleneck-chart', [{
        x: bottleneckData.map(s => s.name),
        y: bottleneckData.map(s => s.time),
        type: 'bar',
        marker: { color: colors },
        text: bottleneckData.map(s => `${s.time}s`),
        textposition: 'outside',
    }], {
        margin: { t: 20, b: 60, l: 50, r: 20 },
        paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
        font: { color: '#9aaa9a' },
        yaxis: { title: 'Cycle Time (sec)', gridcolor: 'rgba(255,255,255,0.1)' },
        xaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
    }, { responsive: true, displayModeBar: false });

    const constraint = bottleneckData[bottleneckIdx];
    document.getElementById('bottleneck-name').textContent = constraint.name;
    document.getElementById('bottleneck-ct').textContent = `${constraint.time} sec`;
    document.getElementById('bottleneck-throughput').textContent = `${(3600 / constraint.time).toFixed(1)} units/hr`;

    // Publish to shared state
    SvendOps.publish('bottleneckCT', constraint.time, 'sec', 'Bottleneck');
    SvendOps.publish('bottleneckThroughput', parseFloat((3600 / constraint.time).toFixed(1)), 'units/hr', 'Bottleneck');
}

// ============================================================================
// Little's Law
// ============================================================================

function calcLittles() {
    const solve = document.getElementById('littles-solve').value;
    const wip = parseFloat(document.getElementById('littles-wip').value) || 0;
    const thr = parseFloat(document.getElementById('littles-thr').value) || 1;
    const lt = parseFloat(document.getElementById('littles-lt').value) || 1;

    // Show/hide input groups based on solve mode
    document.getElementById('littles-wip-group').style.display = solve === 'wip' ? 'none' : 'flex';
    document.getElementById('littles-thr-group').style.display = solve === 'throughput' ? 'none' : 'flex';
    document.getElementById('littles-lt-group').style.display = solve === 'leadtime' ? 'none' : 'flex';

    let result, label, unit;
    if (solve === 'wip') {
        result = thr * lt;
        label = 'WIP';
        unit = 'units';
    } else if (solve === 'throughput') {
        result = wip / lt;
        label = 'Throughput';
        unit = 'units/hr';
    } else {
        result = wip / thr;
        label = 'Lead Time';
        unit = 'hours';
    }

    document.getElementById('littles-result-label').textContent = label;
    document.getElementById('littles-result').innerHTML = `${result.toFixed(1)}<span class="calc-result-unit">${unit}</span>`;

    // Update derivation
    let derivation = '';
    if (solve === 'wip') {
        derivation = `
            <div class="step">
                <div class="step-num">Little's Law: Solve for WIP</div>
                <span class="formula">L = λ × W</span><br>
                WIP = Throughput × Lead Time<br>
                WIP = ${thr} × ${lt} = <strong>${result.toFixed(1)} units</strong>
            </div>`;
    } else if (solve === 'throughput') {
        derivation = `
            <div class="step">
                <div class="step-num">Little's Law: Solve for Throughput</div>
                <span class="formula">λ = L ÷ W</span><br>
                Throughput = WIP ÷ Lead Time<br>
                Throughput = ${wip} ÷ ${lt} = <strong>${result.toFixed(1)} units/hr</strong>
            </div>`;
    } else {
        derivation = `
            <div class="step">
                <div class="step-num">Little's Law: Solve for Lead Time</div>
                <span class="formula">W = L ÷ λ</span><br>
                Lead Time = WIP ÷ Throughput<br>
                Lead Time = ${wip} ÷ ${thr} = <strong>${result.toFixed(1)} hours</strong>
            </div>`;
    }
    derivation += `
        <div class="step">
            <div class="step-num">Interpretation</div>
            Little's Law (L = λW) is a fundamental relationship that holds for <em>any</em> stable system, regardless of arrival distribution or service pattern.
        </div>`;
    document.getElementById('littles-derivation-body').innerHTML = derivation;

    // Publish to shared state
    SvendOps.publish('littlesResult', parseFloat(result.toFixed(1)), unit, "Little's Law");

    // Little's Law bar chart — show all 3 variables
    const actualWip = solve === 'wip' ? result : wip;
    const actualThr = solve === 'throughput' ? result : thr;
    const actualLt = solve === 'leadtime' ? result : lt;
    Plotly.newPlot('littles-chart', [{
        x: ['WIP (L)', 'Throughput (λ)', 'Lead Time (W)'],
        y: [actualWip, actualThr, actualLt],
        type: 'bar',
        marker: { color: ['#3498db', '#27ae60', '#f39c12'] },
        text: [`${actualWip.toFixed(1)} units`, `${actualThr.toFixed(1)} /hr`, `${actualLt.toFixed(1)} hrs`],
        textposition: 'outside',
        textfont: { size: 12, color: '#a0a0a0' }
    }], {
        margin: { t: 40, b: 40, l: 50, r: 20 },
        paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
        font: { color: '#9aaa9a' },
        yaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
        xaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
        annotations: [{
            x: 0.5, y: 1.12, xref: 'paper', yref: 'paper',
            text: `L = λ × W → ${actualWip.toFixed(1)} = ${actualThr.toFixed(1)} × ${actualLt.toFixed(1)}`,
            showarrow: false, font: { size: 12, color: '#e0e0e0' }
        }]
    }, { responsive: true, displayModeBar: false });
}

// ============================================================================
// Queuing Theory (M/M/c)
// ============================================================================

function factorial(n) {
    if (n <= 1) return 1;
    let result = 1;
    for (let i = 2; i <= n; i++) result *= i;
    return result;
}

function calcQueue() {
    const lambda = parseFloat(document.getElementById('queue-lambda').value) || 0;
    const mu = parseFloat(document.getElementById('queue-mu').value) || 1;
    const c = parseInt(document.getElementById('queue-c').value) || 1;

    const rho = lambda / (c * mu);
    const r = lambda / mu;

    // Check stability
    if (rho >= 1) {
        document.getElementById('queue-rho').innerHTML = `${(rho * 100).toFixed(1)}<span class="calc-result-unit">%</span>`;
        document.getElementById('queue-stable').innerHTML = '<span style="color:#e74c3c">No (λ ≥ cμ) - System unstable!</span>';
        document.getElementById('queue-wq').innerHTML = '∞';
        document.getElementById('queue-lq').textContent = '∞';
        document.getElementById('queue-w').innerHTML = '∞';
        document.getElementById('queue-l').textContent = '∞';
        document.getElementById('queue-pw').innerHTML = '100<span class="calc-result-unit">%</span>';
        document.getElementById('queue-capacity').textContent = `${(c * mu).toFixed(1)} customers/hr`;
        return;
    }

    // P0 calculation (probability of empty system)
    let sum = 0;
    for (let n = 0; n < c; n++) {
        sum += Math.pow(r, n) / factorial(n);
    }
    sum += (Math.pow(r, c) / factorial(c)) * (1 / (1 - rho));
    const P0 = 1 / sum;

    // Probability of waiting (Erlang C formula)
    const Pc = (Math.pow(r, c) / factorial(c)) * (1 / (1 - rho)) * P0;

    // Queue length
    const Lq = Pc * rho / (1 - rho);

    // Wait time in queue
    const Wq = Lq / lambda;

    // Total time in system
    const W = Wq + (1 / mu);

    // Total in system
    const L = lambda * W;

    document.getElementById('queue-rho').innerHTML = `${(rho * 100).toFixed(1)}<span class="calc-result-unit">%</span>`;
    document.getElementById('queue-wq').innerHTML = `${(Wq * 60).toFixed(1)}<span class="calc-result-unit">min</span>`;
    document.getElementById('queue-lq').textContent = Lq.toFixed(2);
    document.getElementById('queue-w').innerHTML = `${(W * 60).toFixed(1)}<span class="calc-result-unit">min</span>`;
    document.getElementById('queue-l').textContent = L.toFixed(2);
    document.getElementById('queue-pw').innerHTML = `${(Pc * 100).toFixed(1)}<span class="calc-result-unit">%</span>`;
    document.getElementById('queue-stable').innerHTML = '<span style="color:#27ae60">Yes (λ < cμ)</span>';
    document.getElementById('queue-capacity').textContent = `${(c * mu).toFixed(1)} customers/hr`;

    // Wait time vs utilization chart
    const utils = [];
    const waitTimes = [];
    for (let u = 0.1; u < 0.99; u += 0.02) {
        const testLambda = u * c * mu;
        const testR = testLambda / mu;
        let testSum = 0;
        for (let n = 0; n < c; n++) {
            testSum += Math.pow(testR, n) / factorial(n);
        }
        testSum += (Math.pow(testR, c) / factorial(c)) * (1 / (1 - u));
        const testP0 = 1 / testSum;
        const testPc = (Math.pow(testR, c) / factorial(c)) * (1 / (1 - u)) * testP0;
        const testLq = testPc * u / (1 - u);
        const testWq = testLq / testLambda * 60; // in minutes

        utils.push(u * 100);
        waitTimes.push(testWq);
    }

    Plotly.newPlot('queue-chart', [{
        x: utils,
        y: waitTimes,
        type: 'scatter',
        mode: 'lines',
        fill: 'tozeroy',
        fillcolor: 'rgba(74, 159, 110, 0.2)',
        line: { color: '#4a9f6e', width: 2 }
    }], {
        shapes: [{
            type: 'line',
            x0: rho * 100, x1: rho * 100,
            y0: 0, y1: Math.max(...waitTimes),
            line: { color: '#e74c3c', width: 2, dash: 'dash' }
        }],
        annotations: [{
            x: rho * 100, y: Wq * 60,
            text: `Current: ${(Wq * 60).toFixed(1)} min`,
            showarrow: true, arrowhead: 2, arrowcolor: '#e74c3c',
            font: { color: '#e74c3c', size: 11 },
            ax: 40, ay: -20
        }],
        margin: { t: 20, b: 50, l: 60, r: 20 },
        paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
        font: { color: '#9aaa9a' },
        xaxis: { title: 'Utilization (%)', gridcolor: 'rgba(255,255,255,0.1)' },
        yaxis: { title: 'Wait Time (min)', gridcolor: 'rgba(255,255,255,0.1)' }
    }, { responsive: true, displayModeBar: false });

    // Update derivation
    document.getElementById('queue-derivation-body').innerHTML = `
        <div class="step">
            <div class="step-num">Step 1: Calculate Utilization</div>
            <span class="formula">ρ = λ / (c × μ)</span><br>
            ρ = ${lambda} / (${c} × ${mu}) = ${lambda} / ${c * mu} = <strong>${(rho * 100).toFixed(1)}%</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 2: Calculate P₀ (Empty System Probability)</div>
            <span class="formula">P₀ = 1 / [Σₙ(rⁿ/n!) + (rᶜ/c!)(1/(1-ρ))]</span><br>
            Where r = λ/μ = ${lambda}/${mu} = ${r.toFixed(2)}<br>
            P₀ = <strong>${(P0 * 100).toFixed(2)}%</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 3: Calculate Pᶜ (Erlang C — Probability of Waiting)</div>
            <span class="formula">Pᶜ = (rᶜ/c!) × (1/(1-ρ)) × P₀</span><br>
            Pᶜ = <strong>${(Pc * 100).toFixed(1)}%</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 4: Calculate Queue Length and Wait Time</div>
            <span class="formula">Lq = Pᶜ × ρ / (1-ρ)</span> = ${Lq.toFixed(2)} customers<br>
            <span class="formula">Wq = Lq / λ</span> = ${Lq.toFixed(2)} / ${lambda} = <strong>${(Wq * 60).toFixed(1)} min</strong>
        </div>
        <div class="step">
            <div class="step-num">Insight</div>
            At ${(rho * 100).toFixed(0)}% utilization, ${(Pc * 100).toFixed(0)}% of arrivals must wait.
            ${rho > 0.8 ? '<br><span style="color:#e74c3c">⚠️ High utilization — wait times increase exponentially above 80%</span>' : ''}
        </div>
    `;
}

function toggleQueueMonteCarlo(btn) {
    btn.classList.toggle('active');
    const results = document.getElementById('queue-monte-results');
    results.classList.toggle('visible');

    if (btn.classList.contains('active')) {
        runQueueMonteCarlo();
    }
}

function runQueueMonteCarlo() {
    const lambda = parseFloat(document.getElementById('queue-lambda').value) || 0;
    const mu = parseFloat(document.getElementById('queue-mu').value) || 1;
    const c = parseInt(document.getElementById('queue-c').value) || 1;

    // Queue wait time with variable inputs
    const calcWaitTime = (lam, serv) => {
        const rho = lam / (c * serv);
        if (rho >= 1) return 999; // Unstable

        const r = lam / serv;
        let sum = 0;
        for (let n = 0; n < c; n++) {
            sum += Math.pow(r, n) / factorial(n);
        }
        sum += (Math.pow(r, c) / factorial(c)) * (1 / (1 - rho));
        const P0 = 1 / sum;
        const Pc = (Math.pow(r, c) / factorial(c)) * (1 / (1 - rho)) * P0;
        const Lq = Pc * rho / (1 - rho);
        const Wq = Lq / lam * 60; // in minutes
        return Wq;
    };

    const inputs = [
        { value: lambda, cv: 0.15 },  // ±15% arrival variability
        { value: mu, cv: 0.15 }       // ±15% service variability
    ];

    const sim = MonteCarlo.simulate(calcWaitTime, inputs, 2000);

    // Filter out unstable results
    const validResults = sim.raw.filter(r => r < 900);
    if (validResults.length < 100) {
        document.getElementById('queue-monte-mean').textContent = 'Unstable';
        return;
    }

    document.getElementById('queue-monte-mean').textContent = sim.mean.toFixed(1) + ' min';
    document.getElementById('queue-monte-p5').textContent = sim.p5.toFixed(1) + ' min';
    document.getElementById('queue-monte-p95').textContent = sim.p95.toFixed(1) + ' min';
    document.getElementById('queue-monte-std').textContent = `±${sim.std.toFixed(1)}`;

    MonteCarlo.renderHistogram('queue-monte-chart', sim, 'Wait Time Distribution (2000 runs)', 'min');
}

// ============================================================================
// M/M/c/K Finite Queue
// ============================================================================

function calcQueueFinite() {
    const lambda = parseFloat(document.getElementById('qf-lambda').value) || 0;
    const mu = parseFloat(document.getElementById('qf-mu').value) || 1;
    const c = parseInt(document.getElementById('qf-c').value) || 1;
    const K = parseInt(document.getElementById('qf-k').value) || 10;

    const r = lambda / mu;
    const rho = lambda / (c * mu);

    // Calculate state probabilities P(n) for n = 0 to K
    const P = new Array(K + 1).fill(0);

    // First calculate unnormalized probabilities
    P[0] = 1;
    for (let n = 1; n <= K; n++) {
        if (n < c) {
            P[n] = P[n-1] * r / n;
        } else {
            P[n] = P[n-1] * r / c;
        }
    }

    // Normalize
    const sumP = P.reduce((a, b) => a + b, 0);
    for (let n = 0; n <= K; n++) {
        P[n] /= sumP;
    }

    const Pk = P[K]; // Blocking probability
    const effLambda = lambda * (1 - Pk);
    const lost = lambda * Pk;

    // Calculate L (avg in system)
    let L = 0;
    for (let n = 0; n <= K; n++) {
        L += n * P[n];
    }

    // Calculate Lq (avg in queue)
    let Lq = 0;
    for (let n = c; n <= K; n++) {
        Lq += (n - c) * P[n];
    }

    const W = L / effLambda;
    const Wq = Lq / effLambda;

    document.getElementById('qf-rho').innerHTML = `${(rho * 100).toFixed(1)}<span class="calc-result-unit">%</span>`;
    document.getElementById('qf-wq').innerHTML = `${(Wq * 60).toFixed(1)}<span class="calc-result-unit">min</span>`;
    document.getElementById('qf-lq').textContent = Lq.toFixed(2);
    document.getElementById('qf-pk').innerHTML = `${(Pk * 100).toFixed(1)}<span class="calc-result-unit">%</span>`;
    document.getElementById('qf-eff-lambda').innerHTML = `${effLambda.toFixed(1)}<span class="calc-result-unit">/hr</span>`;
    document.getElementById('qf-lost').textContent = lost.toFixed(2);
    document.getElementById('qf-interpret').textContent =
        Pk > 0.05 ? `⚠️ ${(Pk * 100).toFixed(0)}% of arrivals turned away — consider more capacity` :
        Pk > 0.01 ? `${(Pk * 100).toFixed(1)}% blocking — acceptable for most applications` :
        `<1% blocking — system well-sized`;

    // Update derivation
    document.getElementById('queue-finite-derivation-body').innerHTML = `
        <div class="step">
            <div class="step-num">Step 1: Traffic Intensity</div>
            <span class="formula">r = λ/μ = ${lambda}/${mu} = ${r.toFixed(2)}</span><br>
            <span class="formula">ρ = λ/(cμ) = ${lambda}/(${c}×${mu}) = ${(rho * 100).toFixed(1)}%</span>
        </div>
        <div class="step">
            <div class="step-num">Step 2: State Probabilities P(0)...P(K)</div>
            M/M/${c}/${K} finite queue — calculate ${K + 1} state probabilities and normalize.<br>
            P₀ = <strong>${(P[0] * 100).toFixed(2)}%</strong> (empty system probability)
        </div>
        <div class="step">
            <div class="step-num">Step 3: Blocking Probability</div>
            <span class="formula">P(K) = probability system is full</span><br>
            P(${K}) = <strong>${(Pk * 100).toFixed(2)}%</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 4: Performance Metrics</div>
            <span class="formula">Effective λ = λ(1 − P_K)</span> = ${lambda} × ${(1 - Pk).toFixed(4)} = <strong>${effLambda.toFixed(2)}/hr</strong><br>
            <span class="formula">L = Σ n×P(n)</span> = <strong>${L.toFixed(2)} in system</strong><br>
            <span class="formula">Lq = Σ (n−c)×P(n) for n≥c</span> = <strong>${Lq.toFixed(2)} in queue</strong><br>
            <span class="formula">W = L/λ_eff</span> = <strong>${(W * 60).toFixed(1)} min in system</strong><br>
            <span class="formula">Wq = Lq/λ_eff</span> = <strong>${(Wq * 60).toFixed(1)} min waiting</strong>
        </div>
    `;

    // Chart: Blocking probability vs capacity
    const caps = [];
    const blockProbs = [];
    for (let testK = c; testK <= Math.max(K + 10, 20); testK++) {
        const testP = calcBlockingProb(lambda, mu, c, testK);
        caps.push(testK);
        blockProbs.push(testP * 100);
    }

    Plotly.newPlot('qf-chart', [{
        x: caps,
        y: blockProbs,
        type: 'scatter',
        mode: 'lines+markers',
        fill: 'tozeroy',
        fillcolor: 'rgba(231, 76, 60, 0.2)',
        line: { color: '#e74c3c', width: 2 },
        marker: { size: 4 }
    }], {
        shapes: [{
            type: 'line', x0: K, x1: K, y0: 0, y1: Math.max(...blockProbs),
            line: { color: '#4a9f6e', width: 2, dash: 'dash' }
        }],
        annotations: [{
            x: K, y: Pk * 100,
            text: `K=${K}: ${(Pk * 100).toFixed(1)}%`,
            showarrow: true, arrowhead: 2, arrowcolor: '#4a9f6e',
            font: { color: '#4a9f6e', size: 11 }, ax: 30, ay: -20
        }],
        margin: { t: 20, b: 50, l: 60, r: 20 },
        paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
        font: { color: '#9aaa9a' },
        xaxis: { title: 'System Capacity (K)', gridcolor: 'rgba(255,255,255,0.1)' },
        yaxis: { title: 'Blocking Probability (%)', gridcolor: 'rgba(255,255,255,0.1)' }
    }, { responsive: true, displayModeBar: false });
}

function calcBlockingProb(lambda, mu, c, K) {
    const r = lambda / mu;
    const P = new Array(K + 1).fill(0);
    P[0] = 1;
    for (let n = 1; n <= K; n++) {
        if (n < c) P[n] = P[n-1] * r / n;
        else P[n] = P[n-1] * r / c;
    }
    const sumP = P.reduce((a, b) => a + b, 0);
    return P[K] / sumP;
}

function toggleQFMonteCarlo(btn) {
    btn.classList.toggle('active');
    document.getElementById('qf-monte-results').classList.toggle('visible');
    if (btn.classList.contains('active')) runQFMonteCarlo();
}

function runQFMonteCarlo() {
    const lambda = parseFloat(document.getElementById('qf-lambda').value) || 0;
    const mu = parseFloat(document.getElementById('qf-mu').value) || 1;
    const c = parseInt(document.getElementById('qf-c').value) || 1;
    const K = parseInt(document.getElementById('qf-k').value) || 10;

    const calcBlocking = (lam, serv) => calcBlockingProb(lam, serv, c, K) * 100;
    const inputs = [
        { value: lambda, cv: 0.15 },
        { value: mu, cv: 0.15 }
    ];
    const sim = MonteCarlo.simulate(calcBlocking, inputs, 2000);

    document.getElementById('qf-monte-mean').textContent = sim.mean.toFixed(1) + '%';
    document.getElementById('qf-monte-p95').textContent = sim.p95.toFixed(1) + '%';
    document.getElementById('qf-monte-max').textContent = sim.max.toFixed(1) + '%';
    MonteCarlo.renderHistogram('qf-monte-chart', sim, 'Blocking % Distribution', '%');
}

// ============================================================================
// Priority Queue
// ============================================================================

let priorityClasses = [
    { name: 'High (Code Red)', lambda: 2, color: '#e74c3c' },
    { name: 'Medium', lambda: 5, color: '#f39c12' },
    { name: 'Low (Routine)', lambda: 8, color: '#27ae60' }
];

function renderPriorityClasses() {
    const container = document.getElementById('qp-classes');
    container.innerHTML = priorityClasses.map((pc, i) => `
        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid ${pc.color};">
            <input type="text" value="${pc.name}" style="flex: 1; padding: 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary);" onchange="updatePriorityClass(${i}, 'name', this.value)">
            <div style="display: flex; align-items: center; gap: 4px;">
                <span style="font-size: 12px; color: var(--text-dim);">λ:</span>
                <input type="number" value="${pc.lambda}" style="width: 60px; padding: 8px; text-align: center; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary);" oninput="updatePriorityClass(${i}, 'lambda', this.value)">
                <span style="font-size: 11px; color: var(--text-dim);">/hr</span>
            </div>
            <input type="color" value="${pc.color}" style="width: 32px; height: 32px; border: none; cursor: pointer;" onchange="updatePriorityClass(${i}, 'color', this.value)">
            ${priorityClasses.length > 2 ? `<button onclick="removePriorityClass(${i})" style="padding: 4px 8px; background: transparent; border: none; color: var(--text-dim); cursor: pointer;">&times;</button>` : ''}
        </div>
    `).join('');
    calcQueuePriority();
}

function addPriorityClass() {
    priorityClasses.push({ name: `Class ${priorityClasses.length + 1}`, lambda: 3, color: '#3498db' });
    renderPriorityClasses();
}

function removePriorityClass(i) {
    priorityClasses.splice(i, 1);
    renderPriorityClasses();
}

function updatePriorityClass(i, field, value) {
    if (field === 'lambda') value = parseFloat(value) || 0;
    priorityClasses[i][field] = value;
    calcQueuePriority();
}

function calcQueuePriority() {
    const c = parseInt(document.getElementById('qp-c').value) || 1;
    const mu = parseFloat(document.getElementById('qp-mu').value) || 1;

    const totalLambda = priorityClasses.reduce((a, pc) => a + pc.lambda, 0);
    const rho = totalLambda / (c * mu);

    if (rho >= 1) {
        document.getElementById('qp-results').innerHTML = '<p style="color: #e74c3c;">System unstable (total λ ≥ cμ)</p>';
        return;
    }

    // Calculate wait times for each priority class (non-preemptive)
    const results = [];
    let cumulativeRho = 0;

    for (let k = 0; k < priorityClasses.length; k++) {
        const pc = priorityClasses[k];
        const rhoK = pc.lambda / (c * mu);
        const prevCumulativeRho = cumulativeRho;
        cumulativeRho += rhoK;

        // Wait time for priority class k (non-preemptive priority)
        // Wq_k = W0 / ((1 - sum_j<k rho_j)(1 - sum_j<=k rho_j))
        // where W0 is base wait for M/M/c
        const baseWq = calcMMcWait(totalLambda, mu, c);
        const denom = (1 - prevCumulativeRho) * (1 - cumulativeRho);
        const Wq = denom > 0 ? baseWq / denom * rhoK / (rho) : 999;

        results.push({
            name: pc.name,
            color: pc.color,
            lambda: pc.lambda,
            Wq: Wq * 60, // minutes
            share: (pc.lambda / totalLambda * 100)
        });
    }

    // Render results table
    document.getElementById('qp-results').innerHTML = `
        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
            <tr style="border-bottom: 1px solid var(--border);">
                <th style="padding: 10px; text-align: left;">Priority Class</th>
                <th style="padding: 10px; text-align: right;">Arrival Rate</th>
                <th style="padding: 10px; text-align: right;">% of Traffic</th>
                <th style="padding: 10px; text-align: right;">Avg Wait</th>
            </tr>
            ${results.map(r => `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 10px;"><span style="display: inline-block; width: 12px; height: 12px; background: ${r.color}; border-radius: 2px; margin-right: 8px;"></span>${r.name}</td>
                    <td style="padding: 10px; text-align: right;">${r.lambda}/hr</td>
                    <td style="padding: 10px; text-align: right;">${r.share.toFixed(0)}%</td>
                    <td style="padding: 10px; text-align: right; font-weight: 600; color: ${r.Wq > 30 ? '#e74c3c' : r.Wq > 10 ? '#f39c12' : '#27ae60'};">${r.Wq.toFixed(1)} min</td>
                </tr>
            `).join('')}
        </table>
    `;

    // Chart
    Plotly.newPlot('qp-chart', [{
        x: results.map(r => r.name),
        y: results.map(r => r.Wq),
        type: 'bar',
        marker: { color: results.map(r => r.color) },
        text: results.map(r => r.Wq.toFixed(1) + ' min'),
        textposition: 'outside',
        textfont: { size: 11, color: '#a0a0a0' }
    }], {
        margin: { t: 20, b: 80, l: 60, r: 20 },
        paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
        font: { color: '#9aaa9a' },
        xaxis: { tickangle: -20, gridcolor: 'rgba(255,255,255,0.1)' },
        yaxis: { title: 'Average Wait (min)', gridcolor: 'rgba(255,255,255,0.1)' }
    }, { responsive: true, displayModeBar: false });

    // Update derivation
    const prioritySteps = results.map((r, i) => `
        <div class="step">
            <div class="step-num">Class ${i + 1}: ${r.name}</div>
            λ = ${r.lambda}/hr (${r.share.toFixed(0)}% of traffic)<br>
            Average wait: <strong>${r.Wq.toFixed(1)} min</strong>
        </div>`).join('');
    document.getElementById('queue-priority-derivation-body').innerHTML = `
        <div class="step">
            <div class="step-num">System Parameters</div>
            Total λ = ${totalLambda}/hr, μ = ${mu}/hr, c = ${c} server(s)<br>
            <span class="formula">ρ = λ/(cμ) = ${totalLambda}/(${c}×${mu}) = ${(rho * 100).toFixed(1)}%</span>
        </div>
        <div class="step">
            <div class="step-num">Priority Queue Model</div>
            Non-preemptive priority: higher-priority classes get shorter waits at the expense of lower-priority classes.<br>
            <span class="formula">Wq_k = W₀ × ρ_k / (ρ × (1−σ_{k-1})(1−σ_k))</span>
        </div>
        ${prioritySteps}
    `;
}

function calcMMcWait(lambda, mu, c) {
    const rho = lambda / (c * mu);
    if (rho >= 1) return 999;
    const r = lambda / mu;
    let sum = 0;
    for (let n = 0; n < c; n++) sum += Math.pow(r, n) / factorial(n);
    sum += (Math.pow(r, c) / factorial(c)) * (1 / (1 - rho));
    const P0 = 1 / sum;
    const Pc = (Math.pow(r, c) / factorial(c)) * (1 / (1 - rho)) * P0;
    const Lq = Pc * rho / (1 - rho);
    return Lq / lambda;
}

// ============================================================================
// Staffing Optimizer
// ============================================================================

function calcOptimizer() {
    const lambda = parseFloat(document.getElementById('qo-lambda').value) || 0;
    const mu = parseFloat(document.getElementById('qo-mu').value) || 1;
    const serverCost = parseFloat(document.getElementById('qo-server-cost').value) || 0;
    const waitCost = parseFloat(document.getElementById('qo-wait-cost').value) || 0;
    const targetWait = parseFloat(document.getElementById('qo-target-wait').value) || null;

    const minServers = Math.ceil(lambda / mu);
    const maxServers = minServers + 10;

    const data = [];
    let optimalC = minServers;
    let minTotalCost = Infinity;

    for (let c = minServers; c <= maxServers; c++) {
        const rho = lambda / (c * mu);
        if (rho >= 1) continue;

        const Wq = calcMMcWait(lambda, mu, c);
        const WqMin = Wq * 60;
        const staffCostHr = c * serverCost;
        const waitCostHr = lambda * Wq * waitCost;
        const totalCost = staffCostHr + waitCostHr;

        const meetsTarget = targetWait ? WqMin <= targetWait : true;

        data.push({ c, rho: rho * 100, WqMin, staffCostHr, waitCostHr, totalCost, meetsTarget });

        if (totalCost < minTotalCost && meetsTarget) {
            minTotalCost = totalCost;
            optimalC = c;
        }
    }

    const optimal = data.find(d => d.c === optimalC);
    document.getElementById('qo-optimal').textContent = optimalC;
    document.getElementById('qo-total-cost').textContent = '$' + Math.round(optimal?.totalCost || 0);
    document.getElementById('qo-wait').innerHTML = `${(optimal?.WqMin || 0).toFixed(1)}<span class="calc-result-unit">min</span>`;
    document.getElementById('qo-util').innerHTML = `${(optimal?.rho || 0).toFixed(0)}<span class="calc-result-unit">%</span>`;

    // Update derivation
    document.getElementById('queue-optimizer-derivation-body').innerHTML = `
        <div class="step">
            <div class="step-num">Step 1: Minimum Servers Required</div>
            <span class="formula">c_min = ⌈λ/μ⌉ = ⌈${lambda}/${mu}⌉ = ${minServers}</span><br>
            System requires at least ${minServers} server(s) for stability.
        </div>
        <div class="step">
            <div class="step-num">Step 2: Cost Model</div>
            <span class="formula">Total Cost = (c × Server Cost) + (λ × Wq × Wait Cost)</span><br>
            Server cost = $${serverCost}/hr per server, Wait cost = $${waitCost}/hr per waiting customer
        </div>
        <div class="step">
            <div class="step-num">Step 3: Optimal Staffing</div>
            Tested c = ${minServers} to ${maxServers} servers<br>
            Optimal: <strong>c = ${optimalC}</strong> at $${Math.round(optimal?.totalCost || 0)}/hr total<br>
            (Staff: $${Math.round(optimal?.staffCostHr || 0)}/hr + Wait: $${Math.round(optimal?.waitCostHr || 0)}/hr)
        </div>
        <div class="step">
            <div class="step-num">Performance at Optimal</div>
            Utilization: <strong>${(optimal?.rho || 0).toFixed(0)}%</strong>,
            Avg Wait: <strong>${(optimal?.WqMin || 0).toFixed(1)} min</strong>
        </div>
    `;

    // Chart
    Plotly.newPlot('qo-chart', [
        {
            x: data.map(d => d.c),
            y: data.map(d => d.staffCostHr),
            type: 'bar',
            name: 'Server Cost',
            marker: { color: '#3a7f8f' }
        },
        {
            x: data.map(d => d.c),
            y: data.map(d => d.waitCostHr),
            type: 'bar',
            name: 'Wait Cost',
            marker: { color: '#e89547' }
        },
        {
            x: data.map(d => d.c),
            y: data.map(d => d.totalCost),
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Total Cost',
            yaxis: 'y2',
            line: { color: '#4a9f6e', width: 3 },
            marker: { size: 8 }
        }
    ], {
        barmode: 'stack',
        shapes: [{
            type: 'line', x0: optimalC, x1: optimalC, y0: 0, y1: Math.max(...data.map(d => d.totalCost)) * 1.1,
            line: { color: '#e8c547', width: 3, dash: 'dash' }
        }],
        annotations: [{
            x: optimalC, y: optimal?.totalCost,
            text: `Optimal: ${optimalC} servers`,
            showarrow: true, arrowhead: 2, arrowcolor: '#e8c547',
            font: { color: '#e8c547', size: 12 }, ax: 40, ay: -30
        }],
        margin: { t: 30, b: 50, l: 60, r: 60 },
        paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
        font: { color: '#9aaa9a' },
        xaxis: { title: 'Number of Servers', dtick: 1, gridcolor: 'rgba(255,255,255,0.1)' },
        yaxis: { title: 'Cost Component ($/hr)', gridcolor: 'rgba(255,255,255,0.1)' },
        yaxis2: { title: 'Total Cost ($/hr)', overlaying: 'y', side: 'right', gridcolor: 'rgba(255,255,255,0.0)' },
        legend: { orientation: 'h', y: -0.2, x: 0.5, xanchor: 'center' }
    }, { responsive: true, displayModeBar: false });

    // Table
    document.getElementById('qo-table').innerHTML = `
        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
            <tr style="border-bottom: 2px solid var(--border); background: var(--bg-secondary);">
                <th style="padding: 10px; text-align: center;">Servers</th>
                <th style="padding: 10px; text-align: right;">Utilization</th>
                <th style="padding: 10px; text-align: right;">Avg Wait</th>
                <th style="padding: 10px; text-align: right;">Server Cost</th>
                <th style="padding: 10px; text-align: right;">Wait Cost</th>
                <th style="padding: 10px; text-align: right;">Total</th>
            </tr>
            ${data.map(d => `
                <tr style="border-bottom: 1px solid var(--border); ${d.c === optimalC ? 'background: rgba(232, 197, 71, 0.1);' : ''}">
                    <td style="padding: 10px; text-align: center; font-weight: ${d.c === optimalC ? '700' : '400'};">${d.c === optimalC ? '★ ' : ''}${d.c}</td>
                    <td style="padding: 10px; text-align: right; color: ${d.rho > 90 ? '#e74c3c' : d.rho > 80 ? '#f39c12' : '#27ae60'};">${d.rho.toFixed(0)}%</td>
                    <td style="padding: 10px; text-align: right; ${!d.meetsTarget ? 'color: #e74c3c;' : ''}">${d.WqMin.toFixed(1)} min${!d.meetsTarget ? ' ⚠️' : ''}</td>
                    <td style="padding: 10px; text-align: right;">$${d.staffCostHr.toFixed(0)}</td>
                    <td style="padding: 10px; text-align: right;">$${d.waitCostHr.toFixed(0)}</td>
                    <td style="padding: 10px; text-align: right; font-weight: 600;">$${d.totalCost.toFixed(0)}</td>
                </tr>
            `).join('')}
        </table>
    `;
}

// ============================================================================
// Live Queue Simulator
// ============================================================================

let simState = {
    running: false,
    interval: null,
    queue: [],
    servers: [],
    stats: { served: 0, totalWait: 0, maxQueue: 0 },
    history: { time: [], queueLength: [] },
    simTime: 0
};

function updateSimParams() {
    const cov = parseInt(document.getElementById('qs-cov').value);
    const labels = ['0% — No variability', '15% — Low', '30% — Moderate', '50% — High', '75% — Very High', '100% — Extreme'];
    const idx = Math.min(5, Math.floor(cov / 20));
    document.getElementById('qs-cov-label').textContent = cov + '% — ' + ['No variability', 'Low', 'Moderate', 'High', 'Very High', 'Extreme'][idx];

    if (!simState.running) initSimVisual();
}

function initSimVisual() {
    const c = parseInt(document.getElementById('qs-c').value) || 3;
    simState.servers = new Array(c).fill(null);

    document.getElementById('qs-servers').innerHTML = simState.servers.map((_, i) => `
        <div id="server-${i}" style="width: 60px; height: 60px; border-radius: 50%; background: var(--bg-tertiary); border: 3px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 20px; transition: all 0.3s;">
            🧑‍💼
        </div>
    `).join('');

    document.getElementById('qs-queue-visual').innerHTML = '';
    document.getElementById('qs-served').textContent = '0';
    document.getElementById('qs-current-queue').textContent = '0';
    document.getElementById('qs-avg-wait').innerHTML = '0<span class="calc-result-unit">min</span>';
    document.getElementById('qs-max-queue').textContent = '0';
}

function startSimulation() {
    if (simState.running) {
        simState.running = false;
        clearInterval(simState.interval);
        document.getElementById('qs-start').textContent = '▶ Start Simulation';
        document.getElementById('qs-start').style.background = 'var(--accent)';
        return;
    }

    simState.running = true;
    simState.queue = [];
    simState.stats = { served: 0, totalWait: 0, maxQueue: 0 };
    simState.history = { time: [], queueLength: [] };
    simState.simTime = 0;

    const c = parseInt(document.getElementById('qs-c').value) || 3;
    simState.servers = new Array(c).fill(null);

    document.getElementById('qs-start').textContent = '⏸ Pause';
    document.getElementById('qs-start').style.background = '#e74c3c';

    initSimVisual();
    simState.interval = setInterval(simStep, 100);
}

function resetSimulation() {
    simState.running = false;
    clearInterval(simState.interval);
    document.getElementById('qs-start').textContent = '▶ Start Simulation';
    document.getElementById('qs-start').style.background = 'var(--accent)';
    simState.queue = [];
    simState.stats = { served: 0, totalWait: 0, maxQueue: 0 };
    simState.history = { time: [], queueLength: [] };
    initSimVisual();
    Plotly.purge('qs-chart');
}

function simStep() {
    const speed = parseInt(document.getElementById('qs-speed').value) || 5;
    const lambda = parseFloat(document.getElementById('qs-lambda').value) || 8;
    const mu = parseFloat(document.getElementById('qs-mu').value) || 3;
    const cov = parseInt(document.getElementById('qs-cov').value) / 100;

    const dt = speed * 0.01; // hours per tick
    simState.simTime += dt;

    // Arrivals (Poisson with variability)
    const arrivalProb = lambda * dt * (1 + (Math.random() - 0.5) * 2 * cov);
    if (Math.random() < arrivalProb) {
        simState.queue.push({ arrived: simState.simTime });
    }

    // Service completions
    for (let i = 0; i < simState.servers.length; i++) {
        if (simState.servers[i]) {
            const serviceProb = mu * dt * (1 + (Math.random() - 0.5) * 2 * cov);
            if (Math.random() < serviceProb) {
                simState.stats.served++;
                simState.stats.totalWait += (simState.simTime - simState.servers[i].arrived);
                simState.servers[i] = null;
            }
        }
    }

    // Move from queue to available servers
    for (let i = 0; i < simState.servers.length; i++) {
        if (!simState.servers[i] && simState.queue.length > 0) {
            simState.servers[i] = simState.queue.shift();
        }
    }

    // Update stats
    simState.stats.maxQueue = Math.max(simState.stats.maxQueue, simState.queue.length);

    // Record history
    if (simState.history.time.length === 0 || simState.simTime - simState.history.time[simState.history.time.length - 1] > 0.01) {
        simState.history.time.push(simState.simTime);
        simState.history.queueLength.push(simState.queue.length);
        if (simState.history.time.length > 500) {
            simState.history.time.shift();
            simState.history.queueLength.shift();
        }
    }

    // Update visuals
    updateSimVisuals();
}

function updateSimVisuals() {
    // Servers
    simState.servers.forEach((s, i) => {
        const el = document.getElementById(`server-${i}`);
        if (el) {
            el.style.background = s ? 'rgba(231, 76, 60, 0.2)' : 'var(--bg-tertiary)';
            el.style.borderColor = s ? '#e74c3c' : 'var(--border)';
        }
    });

    // Queue
    const queueEl = document.getElementById('qs-queue-visual');
    const dots = simState.queue.slice(0, 30).map(() =>
        `<div style="width: 16px; height: 16px; border-radius: 50%; background: #3498db; animation: pulse 1s infinite;"></div>`
    ).join('');
    queueEl.innerHTML = dots + (simState.queue.length > 30 ? `<span style="color: var(--text-dim); font-size: 12px;">+${simState.queue.length - 30} more</span>` : '');

    // Stats
    document.getElementById('qs-served').textContent = simState.stats.served;
    document.getElementById('qs-current-queue').textContent = simState.queue.length;
    document.getElementById('qs-max-queue').textContent = simState.stats.maxQueue;
    const avgWait = simState.stats.served > 0 ? (simState.stats.totalWait / simState.stats.served * 60) : 0;
    document.getElementById('qs-avg-wait').innerHTML = `${avgWait.toFixed(1)}<span class="calc-result-unit">min</span>`;

    // Chart (update every 10 ticks)
    if (simState.history.time.length % 10 === 0) {
        Plotly.react('qs-chart', [{
            x: simState.history.time.map(t => (t * 60).toFixed(1)),
            y: simState.history.queueLength,
            type: 'scatter',
            mode: 'lines',
            fill: 'tozeroy',
            fillcolor: 'rgba(52, 152, 219, 0.2)',
            line: { color: '#3498db', width: 2 }
        }], {
            margin: { t: 10, b: 40, l: 40, r: 10 },
            paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
            font: { color: '#9aaa9a' },
            xaxis: { title: 'Time (min)', gridcolor: 'rgba(255,255,255,0.1)' },
            yaxis: { title: 'Queue', gridcolor: 'rgba(255,255,255,0.1)' }
        }, { responsive: true, displayModeBar: false });

        // Update burst analysis
        updateBurstAnalysis();
    }
}

// Update burst analysis in live simulator
function updateBurstAnalysis() {
    if (!simState.running || simState.stats.served < 10) return;

    const history = simState.history;
    if (history.queueLength.length < 20) return;

    // Find the peak queue moment
    const maxIdx = history.queueLength.indexOf(Math.max(...history.queueLength));
    const peakTime = history.time[maxIdx] * 60; // minutes
    const peakQueue = history.queueLength[maxIdx];

    // Calculate what a "normal" queue would be
    const avgQueue = history.queueLength.reduce((a, b) => a + b, 0) / history.queueLength.length;

    const el = document.getElementById('qs-burst-analysis');
    if (peakQueue > avgQueue * 2 && peakQueue > 3) {
        el.innerHTML = `
            <div style="color: #e74c3c; font-weight: 600; margin-bottom: 8px;">⚠️ Burst Detected</div>
            <div>Peak queue of <strong>${peakQueue}</strong> at ~${peakTime.toFixed(0)} min into simulation.</div>
            <div style="margin-top: 8px; color: var(--text-dim);">
                Average queue: ${avgQueue.toFixed(1)} | Peak was ${(peakQueue / avgQueue).toFixed(1)}x average.
                <br>This is typical arrival clustering — even with stable λ, arrivals bunch up randomly.
            </div>
        `;
    } else {
        el.innerHTML = `
            <div style="color: #27ae60;">✓ No major bursts detected</div>
            <div style="margin-top: 8px; color: var(--text-dim);">
                Max queue: ${peakQueue} | Average: ${avgQueue.toFixed(1)} — system is handling variability well.
            </div>
        `;
    }
}

// ============================================================================
// A/B Scenario Compare
// ============================================================================

let compareState = {
    running: false,
    interval: null,
    a: { queue: [], servers: [], stats: { served: 0, totalWait: 0 }, history: { time: [], queueLength: [] } },
    b: { queue: [], servers: [], stats: { served: 0, totalWait: 0 }, history: { time: [], queueLength: [] } },
    simTime: 0
};

function updateCompareParams() {
    if (!compareState.running) initCompareVisuals();
}

function initCompareVisuals() {
    const cA = parseInt(document.getElementById('qc-a-c').value) || 3;
    const cB = parseInt(document.getElementById('qc-b-c').value) || 4;

    compareState.a.servers = new Array(cA).fill(null);
    compareState.b.servers = new Array(cB).fill(null);

    document.getElementById('qc-a-servers').innerHTML = compareState.a.servers.map((_, i) =>
        `<div style="width: 40px; height: 40px; border-radius: 50%; background: var(--bg-tertiary); border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 14px;">🧑‍💼</div>`
    ).join('');
    document.getElementById('qc-b-servers').innerHTML = compareState.b.servers.map((_, i) =>
        `<div style="width: 40px; height: 40px; border-radius: 50%; background: var(--bg-tertiary); border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 14px;">🧑‍💼</div>`
    ).join('');

    document.getElementById('qc-a-queue').innerHTML = '';
    document.getElementById('qc-b-queue').innerHTML = '';
}

function startCompare() {
    if (compareState.running) {
        compareState.running = false;
        clearInterval(compareState.interval);
        document.getElementById('qc-start').textContent = '▶ Run Both Scenarios';
        return;
    }

    compareState.running = true;
    compareState.simTime = 0;
    compareState.a = { queue: [], servers: new Array(parseInt(document.getElementById('qc-a-c').value) || 3).fill(null), stats: { served: 0, totalWait: 0 }, history: { time: [], queueLength: [] } };
    compareState.b = { queue: [], servers: new Array(parseInt(document.getElementById('qc-b-c').value) || 4).fill(null), stats: { served: 0, totalWait: 0 }, history: { time: [], queueLength: [] } };

    document.getElementById('qc-start').textContent = '⏸ Pause';
    initCompareVisuals();
    compareState.interval = setInterval(compareStep, 80);
}

function resetCompare() {
    compareState.running = false;
    clearInterval(compareState.interval);
    document.getElementById('qc-start').textContent = '▶ Run Both Scenarios';
    document.getElementById('qc-verdict').textContent = 'Run to compare...';
    document.getElementById('qc-verdict').style.background = 'var(--bg-card)';
    initCompareVisuals();
    Plotly.purge('qc-chart');
}

function compareStep() {
    const dt = 0.05;
    compareState.simTime += dt;

    // Same random seed for both (fair comparison)
    const arrivalRoll = Math.random();
    const serviceRolls = Array(10).fill(0).map(() => Math.random());

    // Process both scenarios with same randomness
    processScenario('a', arrivalRoll, serviceRolls, dt);
    processScenario('b', arrivalRoll, serviceRolls, dt);

    updateCompareVisuals();

    // Update chart every 10 steps
    if (compareState.a.history.time.length % 10 === 0) {
        updateCompareChart();
    }
}

function processScenario(key, arrivalRoll, serviceRolls, dt) {
    const s = compareState[key];
    const lambda = parseFloat(document.getElementById(`qc-${key}-lambda`).value) || 10;
    const mu = parseFloat(document.getElementById(`qc-${key}-mu`).value) || 4;

    // Arrival
    if (arrivalRoll < lambda * dt) {
        s.queue.push({ arrived: compareState.simTime });
    }

    // Service
    for (let i = 0; i < s.servers.length; i++) {
        if (s.servers[i] && serviceRolls[i] < mu * dt) {
            s.stats.served++;
            s.stats.totalWait += (compareState.simTime - s.servers[i].arrived);
            s.servers[i] = null;
        }
    }

    // Queue to server
    for (let i = 0; i < s.servers.length; i++) {
        if (!s.servers[i] && s.queue.length > 0) {
            s.servers[i] = s.queue.shift();
        }
    }

    // History
    s.history.time.push(compareState.simTime);
    s.history.queueLength.push(s.queue.length);
    if (s.history.time.length > 300) {
        s.history.time.shift();
        s.history.queueLength.shift();
    }
}

function updateCompareVisuals() {
    ['a', 'b'].forEach(key => {
        const s = compareState[key];
        const color = key === 'a' ? '#e74c3c' : '#27ae60';

        // Servers
        const serversEl = document.getElementById(`qc-${key}-servers`);
        serversEl.innerHTML = s.servers.map(srv =>
            `<div style="width: 40px; height: 40px; border-radius: 50%; background: ${srv ? 'rgba(231,76,60,0.2)' : 'var(--bg-tertiary)'}; border: 2px solid ${srv ? '#e74c3c' : 'var(--border)'}; display: flex; align-items: center; justify-content: center; font-size: 14px;">🧑‍💼</div>`
        ).join('');

        // Queue dots
        const queueEl = document.getElementById(`qc-${key}-queue`);
        queueEl.innerHTML = s.queue.slice(0, 20).map(() =>
            `<div style="width: 12px; height: 12px; border-radius: 50%; background: #3498db;"></div>`
        ).join('') + (s.queue.length > 20 ? `<span style="font-size: 10px; color: var(--text-dim);">+${s.queue.length - 20}</span>` : '');

        // Stats
        document.getElementById(`qc-${key}-served`).textContent = s.stats.served;
        const avgWait = s.stats.served > 0 ? (s.stats.totalWait / s.stats.served * 60) : 0;
        document.getElementById(`qc-${key}-wait`).textContent = avgWait.toFixed(1) + 'm';
    });

    // Verdict
    const aWait = compareState.a.stats.served > 0 ? compareState.a.stats.totalWait / compareState.a.stats.served * 60 : 0;
    const bWait = compareState.b.stats.served > 0 ? compareState.b.stats.totalWait / compareState.b.stats.served * 60 : 0;
    const verdict = document.getElementById('qc-verdict');

    if (compareState.a.stats.served > 20 && compareState.b.stats.served > 20) {
        const improvement = ((aWait - bWait) / aWait * 100);
        if (improvement > 10) {
            verdict.innerHTML = `✅ Scenario B reduces wait by <strong>${improvement.toFixed(0)}%</strong>`;
            verdict.style.background = 'rgba(39, 174, 96, 0.2)';
            verdict.style.color = '#27ae60';
        } else if (improvement < -10) {
            verdict.innerHTML = `⚠️ Scenario B increases wait by <strong>${Math.abs(improvement).toFixed(0)}%</strong>`;
            verdict.style.background = 'rgba(231, 76, 60, 0.2)';
            verdict.style.color = '#e74c3c';
        } else {
            verdict.innerHTML = `➡️ Similar performance (${Math.abs(improvement).toFixed(0)}% difference)`;
            verdict.style.background = 'rgba(241, 196, 15, 0.2)';
            verdict.style.color = '#f39c12';
        }
    }
}

function updateCompareChart() {
    Plotly.react('qc-chart', [
        {
            x: compareState.a.history.time.map(t => (t * 60).toFixed(1)),
            y: compareState.a.history.queueLength,
            type: 'scatter',
            mode: 'lines',
            name: 'Scenario A (Current)',
            line: { color: '#e74c3c', width: 2 }
        },
        {
            x: compareState.b.history.time.map(t => (t * 60).toFixed(1)),
            y: compareState.b.history.queueLength,
            type: 'scatter',
            mode: 'lines',
            name: 'Scenario B (Proposed)',
            line: { color: '#27ae60', width: 2 }
        }
    ], {
        margin: { t: 20, b: 50, l: 50, r: 20 },
        paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
        font: { color: '#9aaa9a' },
        xaxis: { title: 'Time (min)', gridcolor: 'rgba(255,255,255,0.1)' },
        yaxis: { title: 'Queue Length', gridcolor: 'rgba(255,255,255,0.1)' },
        legend: { orientation: 'h', y: -0.2, x: 0.5, xanchor: 'center' }
    }, { responsive: true, displayModeBar: false });
}

// ============================================================================
// Multi-Stage (Tandem) Queue
// ============================================================================

let tandemStages = [
    { name: 'Triage', mu: 20, c: 1, color: '#e74c3c' },
    { name: 'Doctor', mu: 3, c: 2, color: '#3498db' },
    { name: 'Checkout', mu: 12, c: 1, color: '#27ae60' }
];

function renderTandemStages() {
    const container = document.getElementById('qt-stages');
    container.innerHTML = tandemStages.map((stage, i) => `
        <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid ${stage.color};">
            <div style="flex: 1;">
                <input type="text" value="${stage.name}" style="font-size: 14px; font-weight: 600; padding: 6px 10px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); width: 120px;" onchange="updateTandemStage(${i}, 'name', this.value)">
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 11px; color: var(--text-dim);">μ:</span>
                <input type="number" value="${stage.mu}" style="width: 50px; padding: 6px; text-align: center; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary);" oninput="updateTandemStage(${i}, 'mu', this.value)">
                <span style="font-size: 10px; color: var(--text-dim);">/hr/server</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 11px; color: var(--text-dim);">Servers:</span>
                <input type="number" value="${stage.c}" min="1" style="width: 50px; padding: 6px; text-align: center; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary);" oninput="updateTandemStage(${i}, 'c', this.value)">
            </div>
            <input type="color" value="${stage.color}" style="width: 32px; height: 32px; border: none; cursor: pointer; border-radius: 4px;" onchange="updateTandemStage(${i}, 'color', this.value)">
            ${tandemStages.length > 2 ? `<button onclick="removeTandemStage(${i})" style="padding: 4px 8px; background: transparent; border: none; color: var(--text-dim); cursor: pointer; font-size: 18px;">&times;</button>` : ''}
            ${i < tandemStages.length - 1 ? '<span style="font-size: 20px; color: var(--text-dim);">→</span>' : ''}
        </div>
    `).join('');
    calcTandem();
}

function addTandemStage() {
    tandemStages.push({ name: `Stage ${tandemStages.length + 1}`, mu: 6, c: 1, color: '#9b59b6' });
    renderTandemStages();
}

function removeTandemStage(i) {
    tandemStages.splice(i, 1);
    renderTandemStages();
}

function updateTandemStage(i, field, value) {
    if (field === 'mu' || field === 'c') value = parseFloat(value) || 1;
    tandemStages[i][field] = value;
    calcTandem();
}

function calcTandem() {
    const lambda = parseFloat(document.getElementById('qt-lambda').value) || 10;

    // Calculate metrics for each stage
    const results = tandemStages.map(stage => {
        const rho = lambda / (stage.c * stage.mu);
        if (rho >= 1) return { ...stage, rho, Wq: 999, W: 999, stable: false };

        const Wq = calcMMcWait(lambda, stage.mu, stage.c);
        const W = Wq + (1 / stage.mu);

        return { ...stage, rho, Wq: Wq * 60, W: W * 60, stable: true };
    });

    // Find bottleneck (highest utilization)
    const bottleneck = results.reduce((max, r) => r.rho > max.rho ? r : max, results[0]);

    // Total times
    const totalWait = results.reduce((sum, r) => sum + r.Wq, 0);
    const totalTime = results.reduce((sum, r) => sum + r.W, 0);

    document.getElementById('qt-total-time').innerHTML = `${totalTime.toFixed(0)}<span class="calc-result-unit">min</span>`;
    document.getElementById('qt-total-wait').innerHTML = `${totalWait.toFixed(0)}<span class="calc-result-unit">min</span>`;
    document.getElementById('qt-bottleneck').innerHTML = `<span style="color: ${bottleneck.color};">${bottleneck.name}</span>`;

    // Breakdown table
    document.getElementById('qt-breakdown').innerHTML = `
        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
            <tr style="border-bottom: 2px solid var(--border); background: var(--bg-secondary);">
                <th style="padding: 10px; text-align: left;">Stage</th>
                <th style="padding: 10px; text-align: right;">Servers</th>
                <th style="padding: 10px; text-align: right;">Utilization</th>
                <th style="padding: 10px; text-align: right;">Wait Time</th>
                <th style="padding: 10px; text-align: right;">Service Time</th>
                <th style="padding: 10px; text-align: right;">Total at Stage</th>
            </tr>
            ${results.map(r => `
                <tr style="border-bottom: 1px solid var(--border); ${r.name === bottleneck.name ? 'background: rgba(231, 76, 60, 0.1);' : ''}">
                    <td style="padding: 10px;"><span style="display: inline-block; width: 12px; height: 12px; background: ${r.color}; border-radius: 2px; margin-right: 8px;"></span>${r.name}${r.name === bottleneck.name ? ' 🔥' : ''}</td>
                    <td style="padding: 10px; text-align: right;">${r.c}</td>
                    <td style="padding: 10px; text-align: right; color: ${r.rho > 0.9 ? '#e74c3c' : r.rho > 0.8 ? '#f39c12' : '#27ae60'}; font-weight: 600;">${r.stable ? (r.rho * 100).toFixed(0) + '%' : '⚠️ Unstable'}</td>
                    <td style="padding: 10px; text-align: right;">${r.Wq.toFixed(1)} min</td>
                    <td style="padding: 10px; text-align: right;">${(60 / r.mu).toFixed(1)} min</td>
                    <td style="padding: 10px; text-align: right; font-weight: 600;">${r.W.toFixed(1)} min</td>
                </tr>
            `).join('')}
            <tr style="background: var(--bg-secondary); font-weight: 600;">
                <td style="padding: 10px;" colspan="3">TOTAL END-TO-END</td>
                <td style="padding: 10px; text-align: right;">${totalWait.toFixed(0)} min</td>
                <td style="padding: 10px; text-align: right;">${results.reduce((s, r) => s + 60/r.mu, 0).toFixed(0)} min</td>
                <td style="padding: 10px; text-align: right; color: var(--accent);">${totalTime.toFixed(0)} min</td>
            </tr>
        </table>
    `;

    // Chart - stacked bar
    Plotly.newPlot('qt-chart', [
        {
            x: results.map(r => r.name),
            y: results.map(r => r.Wq),
            type: 'bar',
            name: 'Wait Time',
            marker: { color: 'rgba(231, 76, 60, 0.7)' }
        },
        {
            x: results.map(r => r.name),
            y: results.map(r => 60 / r.mu),
            type: 'bar',
            name: 'Service Time',
            marker: { color: results.map(r => r.color) }
        }
    ], {
        barmode: 'stack',
        margin: { t: 20, b: 60, l: 60, r: 20 },
        paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
        font: { color: '#9aaa9a' },
        xaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
        yaxis: { title: 'Time (min)', gridcolor: 'rgba(255,255,255,0.1)' },
        legend: { orientation: 'h', y: -0.2, x: 0.5, xanchor: 'center' }
    }, { responsive: true, displayModeBar: false });

    // Update derivation
    const tandemSteps = results.map(r => `
        <div class="step">
            <div class="step-num">${r.name} (c=${r.c}, μ=${r.mu}/hr)</div>
            ρ = ${lambda}/(${r.c}×${r.mu}) = <strong>${(r.rho * 100).toFixed(0)}%</strong>${r.name === bottleneck.name ? ' ← Bottleneck' : ''}<br>
            Wait: ${r.Wq.toFixed(1)} min + Service: ${(60/r.mu).toFixed(1)} min = <strong>${r.W.toFixed(1)} min</strong>
        </div>`).join('');
    document.getElementById('queue-tandem-derivation-body').innerHTML = `
        <div class="step">
            <div class="step-num">Tandem Queue Model</div>
            Jackson's theorem: each stage analyzed independently as M/M/c with arrival rate λ = ${lambda}/hr.
        </div>
        ${tandemSteps}
        <div class="step">
            <div class="step-num">End-to-End</div>
            <span class="formula">Total Time = Σ (Wait + Service) across all stages</span><br>
            = <strong>${totalTime.toFixed(0)} min</strong> (${totalWait.toFixed(0)} min waiting + ${results.reduce((s, r) => s + 60/r.mu, 0).toFixed(0)} min service)
        </div>
    `;
}

function toggleTandemMonteCarlo(btn) {
    btn.classList.toggle('active');
    document.getElementById('qt-monte-results').classList.toggle('visible');
    if (btn.classList.contains('active')) runTandemMonteCarlo();
}

function runTandemMonteCarlo() {
    const lambda = parseFloat(document.getElementById('qt-lambda').value) || 10;

    const calcTotalTime = (...mus) => {
        let total = 0;
        tandemStages.forEach((stage, i) => {
            const mu = mus[i] || stage.mu;
            const rho = lambda / (stage.c * mu);
            if (rho >= 1) return 999;
            const Wq = calcMMcWait(lambda, mu, stage.c);
            const W = Wq + (1 / mu);
            total += W * 60;
        });
        return total;
    };

    const inputs = tandemStages.map(s => ({ value: s.mu, cv: 0.15 }));
    const sim = MonteCarlo.simulate(calcTotalTime, inputs, 2000);

    document.getElementById('qt-monte-mean').textContent = sim.mean.toFixed(0) + ' min';
    document.getElementById('qt-monte-p5').textContent = sim.p5.toFixed(0) + ' min';
    document.getElementById('qt-monte-p95').textContent = sim.p95.toFixed(0) + ' min';
    MonteCarlo.renderHistogram('qt-monte-chart', sim, 'Total Time Distribution', 'min');
}

// ============================================================================
// Pitch
// ============================================================================

function calcPitch() {
    const takt = parseFloat(document.getElementById('pitch-takt').value) || 0;
    const pack = parseFloat(document.getElementById('pitch-pack').value) || 1;

    const pitchSec = takt * pack;
    const pitchMin = pitchSec / 60;
    const perHour = 60 / pitchMin;
    const perShift = perHour * 8;

    document.getElementById('pitch-result').innerHTML = `${pitchMin.toFixed(1)}<span class="calc-result-unit">min</span>`;
    document.getElementById('pitch-per-hour').textContent = perHour.toFixed(1);
    document.getElementById('pitch-per-shift').textContent = Math.round(perShift);

    // Update derivation
    document.getElementById('pitch-derivation-body').innerHTML = `
        <div class="step">
            <div class="step-num">Step 1: Calculate Pitch</div>
            <span class="formula">Pitch = Takt Time × Pack-out Quantity</span><br>
            Pitch = ${takt} sec × ${pack} units = ${pitchSec} sec = <strong>${pitchMin.toFixed(1)} min</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 2: Pickups per Hour</div>
            <span class="formula">Per Hour = 60 ÷ Pitch (min)</span><br>
            = 60 ÷ ${pitchMin.toFixed(1)} = <strong>${perHour.toFixed(1)} pickups/hr</strong>
        </div>
        <div class="step">
            <div class="step-num">Interpretation</div>
            The water spider visits every <strong>${pitchMin.toFixed(1)} minutes</strong> to collect a container of ${pack} units, making <strong>${Math.round(perShift)} pickups per 8-hour shift</strong>.
        </div>
    `;

    SvendOps.publish('pitch', parseFloat(pitchMin.toFixed(1)), 'min', 'Pitch');
}

// ============================================================================
// RTY (Rolled Throughput Yield)
// ============================================================================

let rtyData = [
    { name: 'Step 1', fpy: 98 },
    { name: 'Step 2', fpy: 95 },
    { name: 'Step 3', fpy: 92 },
];

function renderRTYInputs() {
    const container = document.getElementById('rty-steps');
    container.innerHTML = rtyData.map((s, i) => `
        <div class="yamazumi-station">
            <span class="yamazumi-station-name">${s.name}</span>
            <input type="number" value="${s.fpy}" step="0.1" max="100" oninput="updateRTY(${i}, this.value)">
            <span style="color: var(--text-dim);">% FPY</span>
            <button class="yamazumi-station-remove" onclick="removeRTYStep(${i})">&times;</button>
        </div>
    `).join('');
    calcRTY();
}

function addRTYStep() {
    rtyData.push({ name: `Step ${rtyData.length + 1}`, fpy: 95 });
    renderRTYInputs();
}

function removeRTYStep(idx) {
    rtyData.splice(idx, 1);
    renderRTYInputs();
}

function updateRTY(idx, value) {
    rtyData[idx].fpy = parseFloat(value) || 0;
    calcRTY();
}

function calcRTY() {
    if (rtyData.length === 0) return;

    const rty = rtyData.reduce((acc, s) => acc * (s.fpy / 100), 1) * 100;
    const defects = 100 - rty;

    document.getElementById('rty-result').innerHTML = `${rty.toFixed(1)}<span class="calc-result-unit">%</span>`;
    document.getElementById('rty-defects').innerHTML = `${defects.toFixed(1)}<span class="calc-result-unit">%</span>`;
    document.getElementById('rty-hidden').textContent = `${defects.toFixed(1)}% rework/scrap hidden in process`;

    // Update derivation
    const rtySteps = rtyData.map((s, i) => {
        const cumYield = rtyData.slice(0, i + 1).reduce((acc, x) => acc * (x.fpy / 100), 1) * 100;
        return `<div class="step">
            <div class="step-num">${s.name}: FPY = ${s.fpy}%</div>
            Cumulative yield after this step: ${i === 0 ? s.fpy : `${rtyData.slice(0, i).reduce((acc, x) => acc * (x.fpy / 100), 1) * 100 > 0 ? (rtyData.slice(0, i).reduce((acc, x) => acc * (x.fpy / 100), 1) * 100).toFixed(1) : '0'}% × ${s.fpy}%`} = <strong>${cumYield.toFixed(1)}%</strong>
        </div>`;
    }).join('');
    document.getElementById('rty-derivation-body').innerHTML = `
        <div class="step">
            <div class="step-num">Formula</div>
            <span class="formula">RTY = FPY₁ × FPY₂ × ... × FPYₙ</span><br>
            = ${rtyData.map(s => (s.fpy / 100).toFixed(4)).join(' × ')} = <strong>${(rty / 100).toFixed(4)} = ${rty.toFixed(1)}%</strong>
        </div>
        ${rtySteps}
        <div class="step">
            <div class="step-num">Hidden Factory</div>
            ${defects.toFixed(1)}% of units require rework or become scrap — this waste is often invisible in traditional yield reporting.
        </div>
    `;

    // Waterfall chart
    const names = ['Start', ...rtyData.map(s => s.name), 'RTY'];
    const yields = [100];
    let cumulative = 100;
    rtyData.forEach(s => {
        cumulative *= s.fpy / 100;
        yields.push(cumulative);
    });

    Plotly.newPlot('rty-chart', [{
        x: names,
        y: yields,
        type: 'bar',
        marker: {
            color: yields.map((y, i) => i === yields.length - 1 ? '#4a9f6e' : '#3a7f8f')
        },
        text: yields.map(y => `${y.toFixed(1)}%`),
        textposition: 'outside'
    }], {
        margin: { t: 20, b: 60, l: 50, r: 20 },
        paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
        font: { color: '#9aaa9a' },
        yaxis: { title: 'Cumulative Yield (%)', range: [0, 110], gridcolor: 'rgba(255,255,255,0.1)' },
        xaxis: { gridcolor: 'rgba(255,255,255,0.1)' }
    }, { responsive: true, displayModeBar: false });

    renderNextSteps('rty-next-steps', [
        { title: 'Cycle Time Analysis', desc: 'Find where rework adds hidden cycle time', calcId: 'cycletime' },
        { title: 'Run FMEA', desc: 'Prioritize failure modes in low-yield steps', calcId: 'fmea' },
        { title: 'Check DPMO', desc: 'Convert yield to sigma level', calcId: 'dpmo' },
    ]);

    SvendOps.publish('rty', parseFloat(rty.toFixed(1)), '%', 'RTY');
}

// ============================================================================
// DPMO / Sigma Level
// ============================================================================

function updateDPMOMode() {
    const mode = document.getElementById('dpmo-mode').value;
    document.getElementById('dpmo-defects-group').style.display = mode === 'defects' ? 'flex' : 'none';
    document.getElementById('dpmo-units-group').style.display = mode === 'defects' ? 'flex' : 'none';
    document.getElementById('dpmo-opp-group').style.display = mode === 'defects' ? 'flex' : 'none';
    document.getElementById('dpmo-direct-group').style.display = mode === 'dpmo' ? 'flex' : 'none';
    document.getElementById('dpmo-yield-group').style.display = mode === 'yield' ? 'flex' : 'none';
    calcDPMO();
}

function dpmoToSigma(dpmo) {
    // Approximate conversion using normal distribution
    const yield_ = 1 - dpmo / 1000000;
    if (yield_ >= 1) return 6;
    if (yield_ <= 0) return 0;
    // Using approximation: sigma ≈ 0.8406 + sqrt(29.37 - 2.221 * ln(DPMO))
    if (dpmo <= 0) return 6;
    const sigma = 0.8406 + Math.sqrt(29.37 - 2.221 * Math.log(dpmo));
    return Math.max(0, Math.min(6, sigma));
}

function calcDPMO() {
    const mode = document.getElementById('dpmo-mode').value;
    let dpmo, yield_;

    if (mode === 'defects') {
        const defects = parseFloat(document.getElementById('dpmo-defects').value) || 0;
        const units = parseFloat(document.getElementById('dpmo-units').value) || 1;
        const opp = parseFloat(document.getElementById('dpmo-opp').value) || 1;
        dpmo = (defects / (units * opp)) * 1000000;
        yield_ = (1 - dpmo / 1000000) * 100;
    } else if (mode === 'dpmo') {
        dpmo = parseFloat(document.getElementById('dpmo-direct').value) || 0;
        yield_ = (1 - dpmo / 1000000) * 100;
    } else {
        yield_ = parseFloat(document.getElementById('dpmo-yield').value) || 0;
        dpmo = (1 - yield_ / 100) * 1000000;
    }

    const sigma = dpmoToSigma(dpmo);

    document.getElementById('dpmo-result').textContent = dpmo.toLocaleString(undefined, { maximumFractionDigits: 0 });
    document.getElementById('dpmo-sigma').innerHTML = `${sigma.toFixed(2)}<span class="calc-result-unit">σ</span>`;
    document.getElementById('dpmo-yield-result').innerHTML = `${yield_.toFixed(4)}<span class="calc-result-unit">%</span>`;
    document.getElementById('dpmo-rate').textContent = `${(100 - yield_).toFixed(4)}%`;

    // Update derivation
    let dpmoDerivation = '';
    if (mode === 'defects') {
        const defects = parseFloat(document.getElementById('dpmo-defects').value) || 0;
        const units = parseFloat(document.getElementById('dpmo-units').value) || 1;
        const opp = parseFloat(document.getElementById('dpmo-opp').value) || 1;
        dpmoDerivation = `
            <div class="step">
                <div class="step-num">Step 1: Calculate DPMO</div>
                <span class="formula">DPMO = (Defects ÷ (Units × Opportunities)) × 1,000,000</span><br>
                = (${defects} ÷ (${units} × ${opp})) × 1,000,000<br>
                = (${defects} ÷ ${units * opp}) × 1,000,000 = <strong>${Math.round(dpmo).toLocaleString()} DPMO</strong>
            </div>`;
    } else if (mode === 'dpmo') {
        dpmoDerivation = `
            <div class="step">
                <div class="step-num">Step 1: Direct DPMO Input</div>
                DPMO = <strong>${Math.round(dpmo).toLocaleString()}</strong>
            </div>`;
    } else {
        dpmoDerivation = `
            <div class="step">
                <div class="step-num">Step 1: Convert Yield to DPMO</div>
                <span class="formula">DPMO = (1 − Yield/100) × 1,000,000</span><br>
                = (1 − ${yield_.toFixed(2)}/100) × 1,000,000 = <strong>${Math.round(dpmo).toLocaleString()} DPMO</strong>
            </div>`;
    }
    dpmoDerivation += `
        <div class="step">
            <div class="step-num">Step 2: Calculate Sigma Level</div>
            <span class="formula">σ ≈ 0.8406 + √(29.37 − 2.221 × ln(DPMO))</span><br>
            Sigma Level = <strong>${sigma.toFixed(2)}σ</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 3: Process Yield</div>
            <span class="formula">Yield = (1 − DPMO/1,000,000) × 100</span><br>
            = <strong>${yield_.toFixed(4)}%</strong>
        </div>`;
    document.getElementById('dpmo-derivation-body').innerHTML = dpmoDerivation;

    // Publish to shared state
    SvendOps.publish('sigma', parseFloat(sigma.toFixed(2)), 'σ', 'DPMO/Sigma');
    SvendOps.publish('dpmo', Math.round(dpmo), 'DPMO', 'DPMO/Sigma');

    // Sigma gauge chart
    Plotly.newPlot('dpmo-chart', [{
        type: 'indicator', mode: 'gauge+number',
        value: sigma,
        number: { suffix: 'σ', font: { size: 28, color: '#e0e0e0' } },
        gauge: {
            axis: { range: [0, 6], dtick: 1, tickfont: { color: '#9aaa9a' } },
            bar: { color: sigma >= 4.5 ? '#27ae60' : sigma >= 3 ? '#f39c12' : '#e74c3c' },
            bgcolor: 'rgba(255,255,255,0.05)',
            steps: [
                { range: [0, 2], color: 'rgba(231,76,60,0.25)' },
                { range: [2, 3], color: 'rgba(243,156,18,0.2)' },
                { range: [3, 4.5], color: 'rgba(243,156,18,0.15)' },
                { range: [4.5, 6], color: 'rgba(39,174,96,0.25)' }
            ],
            threshold: { line: { color: '#27ae60', width: 3 }, value: 4.5 }
        }
    }], {
        margin: { t: 30, b: 10, l: 30, r: 30 },
        paper_bgcolor: 'transparent',
        font: { color: '#9aaa9a' },
        annotations: [
            { x: 0.25, y: -0.05, text: 'Typical: 3σ', showarrow: false, font: { size: 10, color: '#f39c12' } },
            { x: 0.75, y: -0.05, text: 'World Class: 6σ', showarrow: false, font: { size: 10, color: '#27ae60' } }
        ]
    }, { responsive: true, displayModeBar: false });

    renderNextSteps('dpmo-next-steps', [
        { title: 'RTY Analysis', desc: 'Calculate rolled throughput yield', calcId: 'rty' },
        { title: 'Cpk Check', desc: 'Evaluate process capability index', calcId: 'cpk' },
        { title: 'Cost of Quality', desc: 'Estimate cost impact of defects', calcId: 'coq' },
    ]);
}

// ============================================================================
// Inventory Turns
// ============================================================================

function calcTurns() {
    const cogs = parseFloat(document.getElementById('turns-cogs').value) || 0;
    const inv = parseFloat(document.getElementById('turns-inv').value) || 1;

    const turns = cogs / inv;
    const doh = 365 / turns;
    const woh = 52 / turns;

    document.getElementById('turns-result').innerHTML = `${turns.toFixed(1)}<span class="calc-result-unit">/yr</span>`;
    document.getElementById('turns-doh').innerHTML = `${doh.toFixed(1)}<span class="calc-result-unit">days</span>`;
    document.getElementById('turns-woh').innerHTML = `${woh.toFixed(1)}<span class="calc-result-unit">weeks</span>`;

    // Update derivation
    document.getElementById('turns-derivation-body').innerHTML = `
        <div class="step">
            <div class="step-num">Step 1: Inventory Turns</div>
            <span class="formula">Turns = COGS ÷ Average Inventory</span><br>
            = $${cogs.toLocaleString()} ÷ $${inv.toLocaleString()} = <strong>${turns.toFixed(1)} turns/year</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 2: Days on Hand</div>
            <span class="formula">DOH = 365 ÷ Turns</span><br>
            = 365 ÷ ${turns.toFixed(1)} = <strong>${doh.toFixed(1)} days</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 3: Weeks on Hand</div>
            <span class="formula">WOH = 52 ÷ Turns</span><br>
            = 52 ÷ ${turns.toFixed(1)} = <strong>${woh.toFixed(1)} weeks</strong>
        </div>
    `;

    // Turns gauge chart
    const turnsMax = Math.max(turns * 2, 24);
    Plotly.newPlot('turns-chart', [{
        type: 'indicator', mode: 'gauge+number',
        value: turns,
        number: { suffix: '/yr', font: { size: 28, color: '#e0e0e0' } },
        gauge: {
            axis: { range: [0, turnsMax], tickfont: { color: '#9aaa9a' } },
            bar: { color: turns >= 12 ? '#27ae60' : turns >= 6 ? '#f39c12' : '#e74c3c' },
            bgcolor: 'rgba(255,255,255,0.05)',
            steps: [
                { range: [0, 4], color: 'rgba(231,76,60,0.25)' },
                { range: [4, 8], color: 'rgba(243,156,18,0.2)' },
                { range: [8, 12], color: 'rgba(243,156,18,0.15)' },
                { range: [12, turnsMax], color: 'rgba(39,174,96,0.25)' }
            ]
        }
    }], {
        margin: { t: 30, b: 10, l: 30, r: 30 },
        paper_bgcolor: 'transparent',
        font: { color: '#9aaa9a' },
        annotations: [
            { x: 0.5, y: -0.05, text: 'Mfg avg: 6-8 | Retail: 8-12 | World class: 20+', showarrow: false, font: { size: 10, color: '#9aaa9a' } }
        ]
    }, { responsive: true, displayModeBar: false });

    SvendOps.publish('turns', parseFloat(turns.toFixed(1)), '/yr', 'Inv Turns');
    SvendOps.publish('daysOnHand', parseFloat(doh.toFixed(1)), 'days', 'Inv Turns');
}

// ============================================================================
// Cost of Quality
// ============================================================================

function calcCOQ() {
    const training = parseFloat(document.getElementById('coq-training').value) || 0;
    const planning = parseFloat(document.getElementById('coq-planning').value) || 0;
    const systems = parseFloat(document.getElementById('coq-systems').value) || 0;
    const inspection = parseFloat(document.getElementById('coq-inspection').value) || 0;
    const testing = parseFloat(document.getElementById('coq-testing').value) || 0;
    const audits = parseFloat(document.getElementById('coq-audits').value) || 0;
    const internal = parseFloat(document.getElementById('coq-internal').value) || 0;
    const external = parseFloat(document.getElementById('coq-external').value) || 0;

    const prevention = training + planning + systems;
    const appraisal = inspection + testing + audits;
    const failure = internal + external;
    const total = prevention + appraisal + failure;

    const fmt = (n) => n >= 1000000 ? `$${(n/1000000).toFixed(1)}M` : `$${(n/1000).toFixed(0)}K`;

    document.getElementById('coq-prev-total').textContent = fmt(prevention);
    document.getElementById('coq-appr-total').textContent = fmt(appraisal);
    document.getElementById('coq-fail-total').textContent = fmt(failure);
    document.getElementById('coq-total').textContent = fmt(total);

    // Update derivation
    const prevPct = total > 0 ? ((prevention / total) * 100).toFixed(0) : 0;
    const apprPct = total > 0 ? ((appraisal / total) * 100).toFixed(0) : 0;
    const failPct = total > 0 ? ((failure / total) * 100).toFixed(0) : 0;
    document.getElementById('coq-derivation-body').innerHTML = `
        <div class="step">
            <div class="step-num">Step 1: Prevention Costs</div>
            <span class="formula">Prevention = Training + Planning + Systems</span><br>
            = ${fmt(training)} + ${fmt(planning)} + ${fmt(systems)} = <strong>${fmt(prevention)}</strong> (${prevPct}%)
        </div>
        <div class="step">
            <div class="step-num">Step 2: Appraisal Costs</div>
            <span class="formula">Appraisal = Inspection + Testing + Audits</span><br>
            = ${fmt(inspection)} + ${fmt(testing)} + ${fmt(audits)} = <strong>${fmt(appraisal)}</strong> (${apprPct}%)
        </div>
        <div class="step">
            <div class="step-num">Step 3: Failure Costs</div>
            <span class="formula">Failure = Internal + External</span><br>
            = ${fmt(internal)} + ${fmt(external)} = <strong>${fmt(failure)}</strong> (${failPct}%)
        </div>
        <div class="step">
            <div class="step-num">Step 4: Total Cost of Quality</div>
            <span class="formula">CoQ = Prevention + Appraisal + Failure</span><br>
            = ${fmt(prevention)} + ${fmt(appraisal)} + ${fmt(failure)} = <strong>${fmt(total)}</strong>
        </div>
        <div class="step">
            <div class="step-num">Interpretation</div>
            ${failure > prevention + appraisal ? 'Failure costs dominate — invest more in prevention to reduce total CoQ.' : 'Good balance — prevention spending is keeping failure costs in check.'}
        </div>
    `;

    // Pie chart
    Plotly.newPlot('coq-chart', [{
        values: [prevention, appraisal, internal, external],
        labels: ['Prevention', 'Appraisal', 'Internal Failure', 'External Failure'],
        type: 'pie',
        marker: {
            colors: ['#4a9f6e', '#3a7f8f', '#e89547', '#e74c3c']
        },
        textinfo: 'label+percent',
        textposition: 'outside',
        textfont: { size: 11, color: '#9aaa9a' },
        hovertemplate: '%{label}: $%{value:,.0f}<extra></extra>'
    }], {
        margin: { t: 20, b: 20, l: 20, r: 20 },
        paper_bgcolor: 'transparent',
        showlegend: false
    }, { responsive: true, displayModeBar: false });

    SvendOps.publish('coqTotal', total, '$', 'COQ');
    SvendOps.publish('coqFailure', failure, '$', 'COQ');
}

// ============================================================================
// SMED Analysis
// ============================================================================

let smedData = [
    { name: 'Get tools', time: 5, type: 'external' },
    { name: 'Remove old die', time: 8, type: 'internal' },
    { name: 'Install new die', time: 10, type: 'internal' },
    { name: 'Adjust settings', time: 7, type: 'internal' },
    { name: 'First piece check', time: 5, type: 'internal' },
    { name: 'Cleanup', time: 10, type: 'external' },
];

let smedBaseline = null; // Stores baseline snapshot for before/after comparison

function renderSMEDInputs() {
    const container = document.getElementById('smed-elements');
    container.innerHTML = smedData.map((s, i) => `
        <div class="yamazumi-station" style="gap: 8px;">
            <input type="text" value="${s.name}" style="flex:1; padding: 8px;" oninput="updateSMED(${i}, 'name', this.value)">
            <input type="number" value="${s.time}" style="width:70px; text-align:right;" oninput="updateSMED(${i}, 'time', this.value)">
            <span style="color: var(--text-dim); font-size: 12px;">min</span>
            <select style="width: 100px; padding: 8px;" onchange="updateSMED(${i}, 'type', this.value)">
                <option value="internal" ${s.type === 'internal' ? 'selected' : ''}>Internal</option>
                <option value="external" ${s.type === 'external' ? 'selected' : ''}>External</option>
            </select>
            <button class="yamazumi-station-remove" onclick="removeSMED(${i})">&times;</button>
        </div>
    `).join('');
    calcSMED();
}

function addSMEDElement() {
    smedData.push({ name: 'New element', time: 5, type: 'internal' });
    renderSMEDInputs();
}

function removeSMED(idx) {
    smedData.splice(idx, 1);
    renderSMEDInputs();
}

function updateSMED(idx, field, value) {
    if (field === 'time') value = parseFloat(value) || 0;
    smedData[idx][field] = value;
    calcSMED();
}

function calcSMED() {
    const internal = smedData.filter(s => s.type === 'internal').reduce((a, s) => a + s.time, 0);
    const external = smedData.filter(s => s.type === 'external').reduce((a, s) => a + s.time, 0);
    const total = internal + external;
    const reduction = total > 0 ? ((external / total) * 100) : 0;

    document.getElementById('smed-current').innerHTML = `${total}<span class="calc-result-unit">min</span>`;
    document.getElementById('smed-internal').innerHTML = `${internal}<span class="calc-result-unit">min</span>`;
    document.getElementById('smed-external').innerHTML = `${external}<span class="calc-result-unit">min</span>`;
    document.getElementById('smed-target').innerHTML = `${internal}<span class="calc-result-unit">min</span>`;
    document.getElementById('smed-reduction').textContent = `${reduction.toFixed(0)}% (${external} min saved)`;

    // Update derivation
    const intElements = smedData.filter(s => s.type === 'internal');
    const extElements = smedData.filter(s => s.type === 'external');
    document.getElementById('smed-derivation-body').innerHTML = `
        <div class="step">
            <div class="step-num">Step 1: Classify Elements</div>
            <strong>Internal</strong> (machine stopped): ${intElements.length} elements = ${internal} min<br>
            <strong>External</strong> (machine running): ${extElements.length} elements = ${external} min
        </div>
        <div class="step">
            <div class="step-num">Step 2: Current Total Changeover</div>
            <span class="formula">Current = Internal + External</span><br>
            = ${internal} + ${external} = <strong>${total} min</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 3: SMED Target</div>
            <span class="formula">Target = Internal Only (externalize the rest)</span><br>
            Target changeover = <strong>${internal} min</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 4: Potential Reduction</div>
            <span class="formula">Savings = External time moved outside changeover</span><br>
            = ${external} min saved = <strong>${reduction.toFixed(0)}% reduction</strong>
        </div>
    `;

    // Update internal seconds display for Line Sim link
    document.getElementById('smed-internal-seconds').textContent = `${internal * 60}s`;

    // Update baseline comparison if exists
    if (smedBaseline) {
        const baselineInternal = smedBaseline.internal;
        const improvement = baselineInternal - internal;
        const pctImprove = baselineInternal > 0 ? ((improvement / baselineInternal) * 100) : 0;

        document.getElementById('smed-baseline-compare').style.display = 'block';
        document.getElementById('smed-baseline-total').textContent = baselineInternal;
        document.getElementById('smed-after-total').textContent = internal;

        if (improvement > 0) {
            document.getElementById('smed-improvement').innerHTML =
                `<span style="color: #4a9f6e;">${pctImprove.toFixed(0)}% reduction (${improvement} min saved)</span>`;
        } else if (improvement < 0) {
            document.getElementById('smed-improvement').innerHTML =
                `<span style="color: #e74c3c;">${Math.abs(improvement)} min added</span>`;
        } else {
            document.getElementById('smed-improvement').innerHTML =
                `<span style="color: var(--text-dim);">No change yet</span>`;
        }
    }

    // Update impact calculations
    calcSMEDImpact();

    // Waterfall chart - each step cascades (using bar with base for full color control)
    const names = smedData.map(s => s.name);
    names.push('Total');

    // Calculate cumulative bases for waterfall effect
    let cumulative = 0;
    const bases = [];
    const heights = [];
    const colors = [];

    smedData.forEach(s => {
        bases.push(cumulative);
        heights.push(s.time);
        colors.push(s.type === 'internal' ? '#e74c3c' : '#4a9f6e');
        cumulative += s.time;
    });

    // Total bar starts at 0
    bases.push(0);
    heights.push(total);
    colors.push('#e8c547'); // Svend Gold

    // Create connector lines as shapes
    const shapes = [];
    for (let i = 0; i < smedData.length; i++) {
        const nextBase = i < smedData.length - 1 ? bases[i + 1] : 0;
        const currentTop = bases[i] + heights[i];
        shapes.push({
            type: 'line',
            x0: i + 0.4, x1: i + 0.6,
            y0: currentTop, y1: currentTop,
            line: { color: 'rgba(150,150,150,0.5)', width: 1, dash: 'dot' }
        });
    }

    Plotly.newPlot('smed-chart', [{
        type: 'bar',
        x: names,
        y: heights,
        base: bases,
        text: heights.map(h => `${h} min`),
        textposition: 'outside',
        textfont: { size: 11, color: '#a0a0a0' },
        marker: { color: colors },
        hovertemplate: '%{x}: %{y} min<extra></extra>'
    }], {
        margin: { t: 40, b: 100, l: 50, r: 20 },
        paper_bgcolor: 'transparent',
        plot_bgcolor: 'transparent',
        shapes: shapes,
        xaxis: {
            tickangle: -30,
            tickfont: { size: 11, color: '#a0a0a0' },
            gridcolor: 'rgba(150,150,150,0.1)'
        },
        yaxis: {
            title: 'Minutes',
            titlefont: { size: 12, color: '#a0a0a0' },
            tickfont: { size: 11, color: '#a0a0a0' },
            gridcolor: 'rgba(150,150,150,0.1)',
            zeroline: true,
            zerolinecolor: 'rgba(150,150,150,0.3)'
        },
        showlegend: false
    }, { responsive: true, displayModeBar: false });

    // Publish to shared state
    SvendOps.publish('changeoverInternal', internal, 'min', 'SMED');

    renderNextSteps('smed-next-steps', [
        { title: 'Update EPEI', desc: 'Recalculate schedule interval with new C/O', calcId: 'epei', pullKey: 'changeoverInternal', pullTarget: 'epei-changeover' },
        { title: 'Simulate Impact', desc: 'Model the changeover reduction in line sim', calcId: 'linesim' },
    ]);
}

// SMED Baseline capture for before/after comparison
function captureBaseline() {
    const internal = smedData.filter(s => s.type === 'internal').reduce((a, s) => a + s.time, 0);
    const external = smedData.filter(s => s.type === 'external').reduce((a, s) => a + s.time, 0);

    smedBaseline = {
        internal: internal,
        external: external,
        total: internal + external,
        elements: JSON.parse(JSON.stringify(smedData)), // Deep copy
        capturedAt: new Date().toISOString()
    };

    // Show clear button
    document.getElementById('smed-clear-baseline').style.display = 'inline-block';

    // Recalculate to show comparison
    calcSMED();
}

function clearBaseline() {
    smedBaseline = null;
    document.getElementById('smed-baseline-compare').style.display = 'none';
    document.getElementById('smed-clear-baseline').style.display = 'none';
}

// Suggest conversions from internal to external
function suggestConversions() {
    const suggestions = [];
    const container = document.getElementById('smed-suggestions');
    const list = document.getElementById('smed-suggestions-list');

    // Analyze each internal element for conversion opportunities
    smedData.forEach((element, idx) => {
        if (element.type !== 'internal') return;

        const name = element.name.toLowerCase();

        // Pattern-based suggestions (Shingo's methodology)
        if (name.includes('get') || name.includes('fetch') || name.includes('find') || name.includes('search')) {
            suggestions.push({
                element: element.name,
                suggestion: 'Pre-stage: Have materials/tools ready at point of use before stopping',
                impact: 'high'
            });
        }
        else if (name.includes('clean') || name.includes('wipe') || name.includes('clear')) {
            suggestions.push({
                element: element.name,
                suggestion: 'Parallel clean: Assign dedicated person or run cleaning while next job starts',
                impact: 'medium'
            });
        }
        else if (name.includes('adjust') || name.includes('align') || name.includes('set') || name.includes('calibrat')) {
            suggestions.push({
                element: element.name,
                suggestion: 'Pre-set: Use intermediate jigs, standard settings, or quick-adjust mechanisms',
                impact: 'high'
            });
        }
        else if (name.includes('heat') || name.includes('warm') || name.includes('preheat') || name.includes('cool')) {
            suggestions.push({
                element: element.name,
                suggestion: 'Pre-condition: Use external heating/cooling before the switch',
                impact: 'high'
            });
        }
        else if (name.includes('check') || name.includes('inspect') || name.includes('verify') || name.includes('test')) {
            suggestions.push({
                element: element.name,
                suggestion: 'Parallel check: Run verification concurrently with first good parts',
                impact: 'medium'
            });
        }
        else if (name.includes('remove') || name.includes('install') || name.includes('mount') || name.includes('attach')) {
            suggestions.push({
                element: element.name,
                suggestion: 'Quick-change: Use functional clamps, one-turn fasteners, or cassette systems',
                impact: 'high'
            });
        }
        else if (name.includes('document') || name.includes('record') || name.includes('log') || name.includes('paper')) {
            suggestions.push({
                element: element.name,
                suggestion: 'Digitize/eliminate: Automate data capture or simplify records',
                impact: 'low'
            });
        }
        else if (name.includes('wait') || name.includes('queue') || name.includes('hold')) {
            suggestions.push({
                element: element.name,
                suggestion: 'Eliminate: This is pure waste — investigate root cause',
                impact: 'high'
            });
        }
        else {
            // Generic suggestion for unrecognized elements
            suggestions.push({
                element: element.name,
                suggestion: 'Analyze: Can this be done while machine is running? Can it be eliminated entirely?',
                impact: 'medium'
            });
        }
    });

    if (suggestions.length === 0) {
        list.innerHTML = '<div style="color: var(--text-dim); padding: 8px;">All elements are already external. Focus on reducing their duration.</div>';
    } else {
        const impactColors = { high: '#4a9f6e', medium: '#e8c547', low: '#a0a0a0' };
        list.innerHTML = suggestions.map(s => `
            <div style="padding: 10px 0; border-bottom: 1px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                    <span style="font-weight: 600; color: var(--text-primary);">${s.element}</span>
                    <span style="font-size: 10px; padding: 2px 6px; background: ${impactColors[s.impact]}22; color: ${impactColors[s.impact]}; border-radius: 4px; text-transform: uppercase;">${s.impact} impact</span>
                </div>
                <div style="color: var(--text-secondary);">${s.suggestion}</div>
            </div>
        `).join('');
    }

    container.style.display = 'block';
}

// Calculate annual impact of SMED improvements
function calcSMEDImpact() {
    const internal = smedData.filter(s => s.type === 'internal').reduce((a, s) => a + s.time, 0);
    const changoversPerDay = parseFloat(document.getElementById('smed-changeovers-day').value) || 0;
    const daysPerYear = parseFloat(document.getElementById('smed-days-year').value) || 0;
    const hourlyCost = parseFloat(document.getElementById('smed-hourly-cost').value) || 0;

    // If baseline exists, calculate savings from improvement
    let minutesSaved = 0;
    if (smedBaseline) {
        minutesSaved = smedBaseline.internal - internal;
    } else {
        // Without baseline, show potential if all internal converted to external
        // (This is theoretical maximum)
        minutesSaved = internal; // Assume target is getting to zero internal
    }

    if (minutesSaved < 0) minutesSaved = 0; // Don't show negative savings

    const hoursSavedPerYear = (minutesSaved * changoversPerDay * daysPerYear) / 60;
    const currentInternalHoursPerYear = (internal * changoversPerDay * daysPerYear) / 60;

    // Capacity gain = hours recovered as percentage of shift time
    const shiftHoursPerDay = 8;
    const totalShiftHoursPerYear = shiftHoursPerDay * daysPerYear;
    const capacityGainPct = totalShiftHoursPerYear > 0 ? (hoursSavedPerYear / totalShiftHoursPerYear) * 100 : 0;

    const annualValue = hoursSavedPerYear * hourlyCost;

    // Update display
    if (smedBaseline) {
        document.getElementById('smed-hours-saved').textContent = hoursSavedPerYear.toFixed(0) + 'h';
        document.getElementById('smed-capacity-gain').textContent = capacityGainPct.toFixed(1) + '%';
        document.getElementById('smed-annual-value').textContent = '$' + annualValue.toLocaleString(undefined, {maximumFractionDigits: 0});
    } else {
        // Without baseline, show current loss (opportunity)
        document.getElementById('smed-hours-saved').innerHTML = `<span style="color: var(--text-dim);">${currentInternalHoursPerYear.toFixed(0)}h lost</span>`;
        document.getElementById('smed-capacity-gain').innerHTML = `<span style="color: var(--text-dim);">—</span>`;
        document.getElementById('smed-annual-value').innerHTML = `<span style="color: var(--text-dim);">Capture baseline first</span>`;
    }
}

// Apply SMED internal time to Line Simulator
function applySMEDToLineSim() {
    const internal = smedData.filter(s => s.type === 'internal').reduce((a, s) => a + s.time, 0);
    const internalSeconds = internal * 60;

    // Set the Line Sim changeover time
    const input = document.getElementById('ls-changeover-time');
    if (input) {
        input.value = internalSeconds;
    }

    // Navigate to Line Simulator
    showCalc('linesim');

    // Show a brief toast/notification
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed; bottom: 20px; right: 20px; padding: 12px 20px;
        background: var(--accent); color: white; border-radius: 8px;
        font-size: 13px; font-weight: 500; z-index: 9999;
        animation: fadeInUp 0.3s ease;
    `;
    toast.textContent = `Changeover time set to ${internalSeconds}s (${internal} min internal)`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// ============================================================================
// Changeover Matrix
// ============================================================================

let changeoverMatrix = {};

function renderChangeoverMatrix() {
    const productsStr = document.getElementById('changeover-products').value;
    const products = productsStr.split(',').map(p => p.trim()).filter(p => p);

    if (products.length < 2) return;

    // Initialize matrix if needed
    products.forEach(from => {
        if (!changeoverMatrix[from]) changeoverMatrix[from] = {};
        products.forEach(to => {
            if (from !== to && changeoverMatrix[from][to] === undefined) {
                changeoverMatrix[from][to] = Math.floor(Math.random() * 25) + 5;
            }
        });
    });

    // Render table
    let html = `<table style="border-collapse: collapse; width: 100%;">
        <tr><th style="padding: 8px; border: 1px solid var(--border);">From \\ To</th>`;
    products.forEach(p => {
        html += `<th style="padding: 8px; border: 1px solid var(--border);">${p}</th>`;
    });
    html += '</tr>';

    products.forEach(from => {
        html += `<tr><th style="padding: 8px; border: 1px solid var(--border);">${from}</th>`;
        products.forEach(to => {
            if (from === to) {
                html += `<td style="padding: 8px; border: 1px solid var(--border); background: var(--bg-secondary); text-align: center;">-</td>`;
            } else {
                const val = changeoverMatrix[from]?.[to] || 10;
                html += `<td style="padding: 4px; border: 1px solid var(--border);">
                    <input type="number" value="${val}" style="width: 100%; text-align: center; padding: 4px;"
                           onchange="updateChangeover('${from}', '${to}', this.value)">
                </td>`;
            }
        });
        html += '</tr>';
    });
    html += '</table>';

    document.getElementById('changeover-matrix').innerHTML = html;
    calcChangeover(products);
}

function updateChangeover(from, to, value) {
    if (!changeoverMatrix[from]) changeoverMatrix[from] = {};
    changeoverMatrix[from][to] = parseFloat(value) || 0;
    const products = document.getElementById('changeover-products').value.split(',').map(p => p.trim()).filter(p => p);
    calcChangeover(products);
}

function calcChangeover(products) {
    const times = [];
    products.forEach(from => {
        products.forEach(to => {
            if (from !== to && changeoverMatrix[from]?.[to]) {
                times.push(changeoverMatrix[from][to]);
            }
        });
    });

    if (times.length === 0) return;

    const avg = times.reduce((a, b) => a + b, 0) / times.length;
    const min = Math.min(...times);
    const max = Math.max(...times);

    document.getElementById('changeover-avg').innerHTML = `${avg.toFixed(0)}<span class="calc-result-unit">min</span>`;
    document.getElementById('changeover-min').innerHTML = `${min}<span class="calc-result-unit">min</span>`;
    document.getElementById('changeover-max').innerHTML = `${max}<span class="calc-result-unit">min</span>`;

    // Simple greedy sequence (nearest neighbor)
    const sequence = [products[0]];
    const remaining = new Set(products.slice(1));
    while (remaining.size > 0) {
        const current = sequence[sequence.length - 1];
        let bestNext = null, bestTime = Infinity;
        remaining.forEach(next => {
            const time = changeoverMatrix[current]?.[next] || Infinity;
            if (time < bestTime) { bestTime = time; bestNext = next; }
        });
        if (bestNext) { sequence.push(bestNext); remaining.delete(bestNext); }
        else break;
    }
    document.getElementById('changeover-best').textContent = sequence.join('→');
}

// ============================================================================
// PFA — Product Flow Analysis (TIPS)
// ============================================================================

const PFA_CATEGORIES = {
    'T': { name: 'Transport', color: '#3498db', type: 'NVA' },
    'I': { name: 'Inspect', color: '#9b59b6', type: 'NVA' },
    'P': { name: 'Process', color: '#4a9f6e', type: 'VA' },
    'S-B': { name: 'Storage (Between)', color: '#e67e22', type: 'NVA' },
    'S-L': { name: 'Storage (Lot)', color: '#d35400', type: 'NVA' },
    'S-W': { name: 'Storage (Within)', color: '#e74c3c', type: 'NVA' }
};

let pfaSteps = [];
let pfaBaseline = null;

function renderPFASteps() {
    const container = document.getElementById('pfa-steps');
    if (!container) return;

    container.innerHTML = pfaSteps.map((step, i) => `
        <div style="display: grid; grid-template-columns: 40px 1fr 100px 80px 80px 30px; gap: 8px; align-items: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
            <span style="font-size: 12px; color: var(--text-dim); text-align: center;">${i + 1}</span>
            <input type="text" value="${step.desc}" placeholder="Step description"
                   style="padding: 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary);"
                   oninput="updatePFAStep(${i}, 'desc', this.value)">
            <select style="padding: 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary);"
                    onchange="updatePFAStep(${i}, 'cat', this.value)">
                ${Object.entries(PFA_CATEGORIES).map(([k, v]) =>
                    `<option value="${k}" ${step.cat === k ? 'selected' : ''} style="color: ${v.color};">${k} - ${v.name}</option>`
                ).join('')}
            </select>
            <div style="display: flex; align-items: center; gap: 4px;">
                <input type="number" value="${step.time}" min="0" step="0.1"
                       style="width: 50px; padding: 6px; text-align: right; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary);"
                       oninput="updatePFAStep(${i}, 'time', parseFloat(this.value) || 0)">
                <span style="font-size: 11px; color: var(--text-dim);">min</span>
            </div>
            <div style="display: flex; align-items: center; gap: 4px;">
                <input type="number" value="${step.dist || 0}" min="0"
                       style="width: 50px; padding: 6px; text-align: right; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary);"
                       oninput="updatePFAStep(${i}, 'dist', parseFloat(this.value) || 0)">
                <span style="font-size: 11px; color: var(--text-dim);">m</span>
            </div>
            <button onclick="removePFAStep(${i})" style="padding: 4px 8px; background: transparent; border: none; color: var(--text-dim); cursor: pointer; font-size: 16px;">&times;</button>
        </div>
    `).join('');

    calcPFA();
}

function addPFAStep() {
    pfaSteps.push({ desc: '', cat: 'P', time: 1, dist: 0 });
    renderPFASteps();
}

function removePFAStep(idx) {
    pfaSteps.splice(idx, 1);
    renderPFASteps();
}

function updatePFAStep(idx, field, value) {
    pfaSteps[idx][field] = value;
    calcPFA();
}

function loadPFAExample() {
    pfaSteps = [
        { desc: 'Retrieve from warehouse', cat: 'S-B', time: 0, dist: 0 },
        { desc: 'Transport to staging', cat: 'T', time: 5, dist: 50 },
        { desc: 'Wait for batch', cat: 'S-L', time: 15, dist: 0 },
        { desc: 'Move to machine', cat: 'T', time: 2, dist: 20 },
        { desc: 'Load and machine', cat: 'P', time: 8, dist: 0 },
        { desc: 'Inspect dimensions', cat: 'I', time: 3, dist: 0 },
        { desc: 'Queue for next op', cat: 'S-W', time: 10, dist: 0 },
        { desc: 'Transport to assembly', cat: 'T', time: 4, dist: 35 },
        { desc: 'Wait for kitting', cat: 'S-B', time: 12, dist: 0 },
        { desc: 'Assemble', cat: 'P', time: 15, dist: 0 },
        { desc: 'Final inspection', cat: 'I', time: 5, dist: 0 },
        { desc: 'Pack and label', cat: 'P', time: 3, dist: 0 },
        { desc: 'Transport to shipping', cat: 'T', time: 3, dist: 40 },
    ];
    renderPFASteps();
}

function capturePFABaseline() {
    pfaBaseline = {
        steps: JSON.parse(JSON.stringify(pfaSteps)),
        metrics: calcPFAMetrics(),
        capturedAt: new Date().toISOString()
    };
    document.getElementById('pfa-clear-baseline').style.display = 'inline-block';
    calcPFA();
}

function clearPFABaseline() {
    pfaBaseline = null;
    document.getElementById('pfa-clear-baseline').style.display = 'none';
    document.getElementById('pfa-baseline-compare').style.display = 'none';
    calcPFA();
}

function calcPFAMetrics() {
    const totals = { T: 0, I: 0, P: 0, 'S-B': 0, 'S-L': 0, 'S-W': 0 };
    let totalTime = 0, totalDist = 0;

    pfaSteps.forEach(s => {
        totals[s.cat] = (totals[s.cat] || 0) + s.time;
        totalTime += s.time;
        totalDist += (s.dist || 0);
    });

    const processTime = totals['P'] || 0;
    const storageTime = (totals['S-B'] || 0) + (totals['S-L'] || 0) + (totals['S-W'] || 0);
    const processRatio = totalTime > 0 ? (processTime / totalTime) * 100 : 0;

    return { totals, totalTime, totalDist, processTime, storageTime, processRatio, stepCount: pfaSteps.length };
}

function calcPFA() {
    const m = calcPFAMetrics();

    document.getElementById('pfa-process-ratio').innerHTML = `${m.processRatio.toFixed(0)}<span class="calc-result-unit">%</span>`;
    document.getElementById('pfa-total-time').innerHTML = `${m.totalTime.toFixed(0)}<span class="calc-result-unit">min</span>`;
    document.getElementById('pfa-total-dist').innerHTML = `${m.totalDist.toFixed(0)}<span class="calc-result-unit">m</span>`;
    document.getElementById('pfa-step-count').textContent = m.stepCount;

    // Breakdown
    const breakdown = document.getElementById('pfa-breakdown');
    breakdown.innerHTML = Object.entries(PFA_CATEGORIES).map(([k, v]) => {
        const time = m.totals[k] || 0;
        const pct = m.totalTime > 0 ? (time / m.totalTime) * 100 : 0;
        return `<div class="calc-breakdown-row">
            <span style="display: flex; align-items: center; gap: 8px;">
                <span style="width: 12px; height: 12px; background: ${v.color}; border-radius: 2px;"></span>
                ${k} - ${v.name}
            </span>
            <span>${time.toFixed(1)} min (${pct.toFixed(0)}%)</span>
        </div>`;
    }).join('');

    // Baseline comparison
    if (pfaBaseline) {
        const delta = document.getElementById('pfa-baseline-delta');
        const bm = pfaBaseline.metrics;
        const timeDiff = m.totalTime - bm.totalTime;
        const distDiff = m.totalDist - bm.totalDist;
        const ratioDiff = m.processRatio - bm.processRatio;

        delta.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; text-align: center;">
                <div>
                    <div style="font-size: 11px; color: var(--text-dim);">Time</div>
                    <div style="font-size: 18px; font-weight: 600; color: ${timeDiff <= 0 ? '#4a9f6e' : '#e74c3c'};">
                        ${timeDiff <= 0 ? '' : '+'}${timeDiff.toFixed(0)} min
                    </div>
                </div>
                <div>
                    <div style="font-size: 11px; color: var(--text-dim);">Distance</div>
                    <div style="font-size: 18px; font-weight: 600; color: ${distDiff <= 0 ? '#4a9f6e' : '#e74c3c'};">
                        ${distDiff <= 0 ? '' : '+'}${distDiff.toFixed(0)} m
                    </div>
                </div>
                <div>
                    <div style="font-size: 11px; color: var(--text-dim);">Process Ratio</div>
                    <div style="font-size: 18px; font-weight: 600; color: ${ratioDiff >= 0 ? '#4a9f6e' : '#e74c3c'};">
                        ${ratioDiff >= 0 ? '+' : ''}${ratioDiff.toFixed(0)}%
                    </div>
                </div>
            </div>
        `;
        document.getElementById('pfa-baseline-compare').style.display = 'block';
    }

    // Chart
    renderPFAChart(m);
    renderPFAFlow();
}

function renderPFAChart(m) {
    const cats = Object.keys(PFA_CATEGORIES);
    const colors = cats.map(k => PFA_CATEGORIES[k].color);
    const values = cats.map(k => m.totals[k] || 0);
    const labels = cats.map(k => PFA_CATEGORIES[k].name);

    Plotly.newPlot('pfa-chart', [{
        type: 'pie',
        values: values,
        labels: labels,
        marker: { colors: colors },
        textinfo: 'label+percent',
        hole: 0.4
    }], {
        margin: { t: 20, b: 20, l: 20, r: 20 },
        paper_bgcolor: 'transparent',
        showlegend: false
    }, { responsive: true, displayModeBar: false });
}

function renderPFAFlow() {
    const container = document.getElementById('pfa-flow');
    if (!container || pfaSteps.length === 0) {
        container.innerHTML = '<div style="color: var(--text-dim); text-align: center;">Add steps to see flow</div>';
        return;
    }

    container.innerHTML = '<div style="display: flex; align-items: center; gap: 4px; flex-wrap: wrap;">' +
        pfaSteps.map((s, i) => {
            const cat = PFA_CATEGORIES[s.cat];
            return `<div style="display: flex; flex-direction: column; align-items: center; min-width: 60px;">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: ${cat.color}; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 11px;">${s.cat}</div>
                <div style="font-size: 10px; color: var(--text-dim); margin-top: 4px; text-align: center; max-width: 70px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${s.desc || '—'}</div>
                <div style="font-size: 10px; color: var(--text-secondary);">${s.time}m</div>
            </div>` + (i < pfaSteps.length - 1 ? '<div style="color: var(--text-dim);">→</div>' : '');
        }).join('') + '</div>';
}

// ============================================================================
// WFA — Workflow Analysis (Therbligs)
// ============================================================================

const WFA_CATEGORIES = {
    'VA': { name: 'Value Added', color: '#4a9f6e', type: 'VA' },
    'RW': { name: 'Required Work', color: '#3498db', type: 'NVA/R' },
    'P': { name: 'Parts', color: '#9b59b6', type: 'NVA/R' },
    'T': { name: 'Tools/Tooling', color: '#e67e22', type: 'NVA/R' },
    'I': { name: 'Inspection', color: '#f39c12', type: 'NVA/R' },
    'MH': { name: 'Material Handling', color: '#1abc9c', type: 'NVA/R' },
    'UW': { name: 'Unnecessary Work', color: '#e74c3c', type: 'NVA/N' },
    'IT': { name: 'Idle Time', color: '#95a5a6', type: 'NVA/N' }
};

let wfaElements = [];
let wfaBaseline = null;

function renderWFAElements() {
    const container = document.getElementById('wfa-elements');
    if (!container) return;

    container.innerHTML = wfaElements.map((el, i) => `
        <div style="display: grid; grid-template-columns: 40px 1fr 120px 80px 30px; gap: 8px; align-items: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
            <span style="font-size: 12px; color: var(--text-dim); text-align: center;">${i + 1}</span>
            <input type="text" value="${el.desc}" placeholder="Element description"
                   style="padding: 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary);"
                   oninput="updateWFAElement(${i}, 'desc', this.value)">
            <select style="padding: 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary);"
                    onchange="updateWFAElement(${i}, 'cat', this.value)">
                ${Object.entries(WFA_CATEGORIES).map(([k, v]) =>
                    `<option value="${k}" ${el.cat === k ? 'selected' : ''}>${k} - ${v.name}</option>`
                ).join('')}
            </select>
            <div style="display: flex; align-items: center; gap: 4px;">
                <input type="number" value="${el.time}" min="0" step="1"
                       style="width: 50px; padding: 6px; text-align: right; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary);"
                       oninput="updateWFAElement(${i}, 'time', parseFloat(this.value) || 0)">
                <span style="font-size: 11px; color: var(--text-dim);">sec</span>
            </div>
            <button onclick="removeWFAElement(${i})" style="padding: 4px 8px; background: transparent; border: none; color: var(--text-dim); cursor: pointer; font-size: 16px;">&times;</button>
        </div>
    `).join('');

    calcWFA();
}

function addWFAElement() {
    wfaElements.push({ desc: '', cat: 'VA', time: 5 });
    renderWFAElements();
}

function removeWFAElement(idx) {
    wfaElements.splice(idx, 1);
    renderWFAElements();
}

function updateWFAElement(idx, field, value) {
    wfaElements[idx][field] = value;
    calcWFA();
}

function loadWFAExample() {
    wfaElements = [
        { desc: 'Reach for part', cat: 'P', time: 3 },
        { desc: 'Grasp part', cat: 'P', time: 2 },
        { desc: 'Position part', cat: 'RW', time: 4 },
        { desc: 'Secure part in fixture', cat: 'RW', time: 5 },
        { desc: 'Reach for tool', cat: 'T', time: 3 },
        { desc: 'Apply fastener', cat: 'VA', time: 8 },
        { desc: 'Apply fastener', cat: 'VA', time: 8 },
        { desc: 'Apply fastener', cat: 'VA', time: 8 },
        { desc: 'Apply fastener', cat: 'VA', time: 8 },
        { desc: 'Set down tool', cat: 'T', time: 2 },
        { desc: 'Visually inspect', cat: 'I', time: 5 },
        { desc: 'Remove from fixture', cat: 'RW', time: 4 },
        { desc: 'Place in tote', cat: 'MH', time: 3 },
        { desc: 'Wait for next part', cat: 'IT', time: 6 },
        { desc: 'Look for supervisor (question)', cat: 'UW', time: 12 },
    ];
    renderWFAElements();
}

function captureWFABaseline() {
    wfaBaseline = {
        elements: JSON.parse(JSON.stringify(wfaElements)),
        metrics: calcWFAMetrics(),
        capturedAt: new Date().toISOString()
    };
    document.getElementById('wfa-clear-baseline').style.display = 'inline-block';
    calcWFA();
}

function clearWFABaseline() {
    wfaBaseline = null;
    document.getElementById('wfa-clear-baseline').style.display = 'none';
    document.getElementById('wfa-baseline-compare').style.display = 'none';
    calcWFA();
}

function calcWFAMetrics() {
    const totals = {};
    Object.keys(WFA_CATEGORIES).forEach(k => totals[k] = 0);
    let totalTime = 0;

    wfaElements.forEach(el => {
        totals[el.cat] = (totals[el.cat] || 0) + el.time;
        totalTime += el.time;
    });

    const vaTime = totals['VA'] || 0;
    const nvarTime = (totals['RW'] || 0) + (totals['P'] || 0) + (totals['T'] || 0) + (totals['I'] || 0) + (totals['MH'] || 0);
    const nvanTime = (totals['UW'] || 0) + (totals['IT'] || 0);

    const vaRatio = totalTime > 0 ? (vaTime / totalTime) * 100 : 0;
    const nvarRatio = totalTime > 0 ? (nvarTime / totalTime) * 100 : 0;
    const nvanRatio = totalTime > 0 ? (nvanTime / totalTime) * 100 : 0;

    return { totals, totalTime, vaTime, nvarTime, nvanTime, vaRatio, nvarRatio, nvanRatio, elementCount: wfaElements.length };
}

function calcWFA() {
    const m = calcWFAMetrics();

    document.getElementById('wfa-va-ratio').innerHTML = `${m.vaRatio.toFixed(0)}<span class="calc-result-unit">%</span>`;
    document.getElementById('wfa-total-time').innerHTML = `${m.totalTime.toFixed(0)}<span class="calc-result-unit">sec</span>`;
    document.getElementById('wfa-nvar').innerHTML = `${m.nvarRatio.toFixed(0)}<span class="calc-result-unit">%</span>`;
    document.getElementById('wfa-nvan').innerHTML = `${m.nvanRatio.toFixed(0)}<span class="calc-result-unit">%</span>`;

    // Breakdown
    const breakdown = document.getElementById('wfa-breakdown');
    breakdown.innerHTML = Object.entries(WFA_CATEGORIES).map(([k, v]) => {
        const time = m.totals[k] || 0;
        const pct = m.totalTime > 0 ? (time / m.totalTime) * 100 : 0;
        return `<div class="calc-breakdown-row">
            <span style="display: flex; align-items: center; gap: 8px;">
                <span style="width: 12px; height: 12px; background: ${v.color}; border-radius: 2px;"></span>
                ${k} - ${v.name} <span style="font-size: 10px; color: var(--text-dim);">(${v.type})</span>
            </span>
            <span>${time} sec (${pct.toFixed(0)}%)</span>
        </div>`;
    }).join('');

    // NVA/R and NVA/N lists
    const nvarList = wfaElements.filter(el => ['RW', 'P', 'T', 'I', 'MH'].includes(el.cat));
    const nvanList = wfaElements.filter(el => ['UW', 'IT'].includes(el.cat));

    document.getElementById('wfa-nvar-list').innerHTML = nvarList.length > 0
        ? nvarList.map(el => `<div style="padding: 4px 0; border-bottom: 1px solid var(--border);">${el.desc || '(no description)'} — ${el.time}s</div>`).join('')
        : '<div style="color: var(--text-dim);">No required NVA elements</div>';

    document.getElementById('wfa-nvan-list').innerHTML = nvanList.length > 0
        ? nvanList.map(el => `<div style="padding: 4px 0; border-bottom: 1px solid var(--border);">${el.desc || '(no description)'} — ${el.time}s</div>`).join('')
        : '<div style="color: var(--text-dim);">No unnecessary waste — nice!</div>';

    // Baseline comparison
    if (wfaBaseline) {
        const delta = document.getElementById('wfa-baseline-delta');
        const bm = wfaBaseline.metrics;
        const timeDiff = m.totalTime - bm.totalTime;
        const vaDiff = m.vaRatio - bm.vaRatio;
        const nvanDiff = m.nvanTime - bm.nvanTime;

        delta.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; text-align: center;">
                <div>
                    <div style="font-size: 11px; color: var(--text-dim);">Total Time</div>
                    <div style="font-size: 18px; font-weight: 600; color: ${timeDiff <= 0 ? '#4a9f6e' : '#e74c3c'};">
                        ${timeDiff <= 0 ? '' : '+'}${timeDiff} sec
                    </div>
                </div>
                <div>
                    <div style="font-size: 11px; color: var(--text-dim);">VA Ratio</div>
                    <div style="font-size: 18px; font-weight: 600; color: ${vaDiff >= 0 ? '#4a9f6e' : '#e74c3c'};">
                        ${vaDiff >= 0 ? '+' : ''}${vaDiff.toFixed(0)}%
                    </div>
                </div>
                <div>
                    <div style="font-size: 11px; color: var(--text-dim);">Waste (NVA/N)</div>
                    <div style="font-size: 18px; font-weight: 600; color: ${nvanDiff <= 0 ? '#4a9f6e' : '#e74c3c'};">
                        ${nvanDiff <= 0 ? '' : '+'}${nvanDiff} sec
                    </div>
                </div>
            </div>
        `;
        document.getElementById('wfa-baseline-compare').style.display = 'block';
    }

    // Chart
    renderWFAChart(m);
}

function renderWFAChart(m) {
    const cats = Object.keys(WFA_CATEGORIES);
    const colors = cats.map(k => WFA_CATEGORIES[k].color);
    const values = cats.map(k => m.totals[k] || 0);
    const labels = cats.map(k => WFA_CATEGORIES[k].name);

    Plotly.newPlot('wfa-chart', [{
        type: 'bar',
        x: labels,
        y: values,
        marker: { color: colors }
    }], {
        margin: { t: 20, b: 60, l: 40, r: 20 },
        paper_bgcolor: 'transparent',
        plot_bgcolor: 'transparent',
        xaxis: { tickangle: -45, color: '#a0a0a0' },
        yaxis: { title: 'Seconds', color: '#a0a0a0', gridcolor: 'rgba(160, 160, 160, 0.2)' }
    }, { responsive: true, displayModeBar: false });
}

// ============================================================================
// FMEA / RPN
// ============================================================================

let fmeaData = [
    { mode: 'Seal failure', severity: 8, occurrence: 4, detection: 5 },
    { mode: 'Wrong label', severity: 5, occurrence: 3, detection: 2 },
    { mode: 'Underfill', severity: 7, occurrence: 2, detection: 3 },
];

function renderFMEAInputs() {
    const container = document.getElementById('fmea-items');
    container.innerHTML = fmeaData.map((f, i) => `
        <div style="display: grid; grid-template-columns: 1fr repeat(3, 80px) 30px; gap: 8px; align-items: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
            <input type="text" value="${f.mode}" placeholder="Failure Mode" style="padding: 8px;" oninput="updateFMEA(${i}, 'mode', this.value)">
            <div>
                <label style="font-size: 10px; margin-bottom: 2px;">S</label>
                <input type="number" value="${f.severity}" min="1" max="10" style="width: 100%; text-align: center;" oninput="updateFMEA(${i}, 'severity', this.value)">
            </div>
            <div>
                <label style="font-size: 10px; margin-bottom: 2px;">O</label>
                <input type="number" value="${f.occurrence}" min="1" max="10" style="width: 100%; text-align: center;" oninput="updateFMEA(${i}, 'occurrence', this.value)">
            </div>
            <div>
                <label style="font-size: 10px; margin-bottom: 2px;">D</label>
                <input type="number" value="${f.detection}" min="1" max="10" style="width: 100%; text-align: center;" oninput="updateFMEA(${i}, 'detection', this.value)">
            </div>
            <button class="yamazumi-station-remove" onclick="removeFMEA(${i})">&times;</button>
        </div>
    `).join('');
    calcFMEA();
}

function addFMEAItem() {
    fmeaData.push({ mode: 'New failure mode', severity: 5, occurrence: 5, detection: 5 });
    renderFMEAInputs();
}

function removeFMEA(idx) {
    fmeaData.splice(idx, 1);
    renderFMEAInputs();
}

function updateFMEA(idx, field, value) {
    if (field !== 'mode') value = Math.min(10, Math.max(1, parseInt(value) || 1));
    fmeaData[idx][field] = value;
    calcFMEA();
}

function calcFMEA() {
    const rpns = fmeaData.map(f => ({ ...f, rpn: f.severity * f.occurrence * f.detection }));
    rpns.sort((a, b) => b.rpn - a.rpn);

    // Update derivation
    const fmeaSteps = rpns.map(f => `
        <div class="step">
            <div class="step-num">${f.mode}</div>
            <span class="formula">RPN = S × O × D</span> = ${f.severity} × ${f.occurrence} × ${f.detection} = <strong>${f.rpn}</strong>
            ${f.rpn > 100 ? ' <span style="color:#e74c3c;">⚠ Action required</span>' : f.rpn > 50 ? ' <span style="color:#f39c12;">Monitor</span>' : ' <span style="color:#4a9f6e;">Acceptable</span>'}
        </div>`).join('');
    document.getElementById('fmea-derivation-body').innerHTML = `
        <div class="step">
            <div class="step-num">Formula</div>
            <span class="formula">Risk Priority Number = Severity × Occurrence × Detection</span><br>
            Each factor: 1 (best) to 10 (worst). RPN range: 1–1,000.
        </div>
        ${fmeaSteps}
    `;

    Plotly.newPlot('fmea-chart', [{
        y: rpns.map(f => f.mode),
        x: rpns.map(f => f.rpn),
        type: 'bar',
        orientation: 'h',
        marker: { color: rpns.map(f => f.rpn > 100 ? '#e74c3c' : f.rpn > 50 ? '#f39c12' : '#4a9f6e') },
        text: rpns.map(f => `RPN: ${f.rpn}`),
        textposition: 'outside'
    }], {
        shapes: [{
            type: 'line', x0: 100, x1: 100, y0: -0.5, y1: rpns.length - 0.5,
            line: { color: '#e74c3c', width: 2, dash: 'dash' }
        }],
        margin: { t: 20, b: 40, l: 120, r: 60 },
        paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
        font: { color: '#9aaa9a' },
        xaxis: { title: 'Risk Priority Number (RPN)', gridcolor: 'rgba(255,255,255,0.1)' },
        yaxis: { gridcolor: 'rgba(255,255,255,0.1)' }
    }, { responsive: true, displayModeBar: false });
}

// ============================================================================
// Cp / Cpk
// ============================================================================

function calcCpk() {
    const usl = parseFloat(document.getElementById('cpk-usl').value);
    const lsl = parseFloat(document.getElementById('cpk-lsl').value);
    const mean = parseFloat(document.getElementById('cpk-mean').value);
    const std = parseFloat(document.getElementById('cpk-std').value) || 0.001;

    const cp = (usl - lsl) / (6 * std);
    const cpu = (usl - mean) / (3 * std);
    const cpl = (mean - lsl) / (3 * std);
    const cpk = Math.min(cpu, cpl);

    // Estimate defect rate from Cpk
    const z = cpk * 3;
    const defectRate = 2 * (1 - normalCDF(z)) * 100;

    document.getElementById('cpk-cp').textContent = cp.toFixed(2);
    document.getElementById('cpk-cpk').textContent = cpk.toFixed(2);
    document.getElementById('cpk-cpu').textContent = cpu.toFixed(2);
    document.getElementById('cpk-cpl').textContent = cpl.toFixed(2);
    document.getElementById('cpk-defects').textContent = defectRate < 0.01 ? '<0.01%' : `${defectRate.toFixed(2)}%`;

    // Update derivation
    document.getElementById('cpk-derivation-body').innerHTML = `
        <div class="step">
            <div class="step-num">Step 1: Process Capability (Cp)</div>
            <span class="formula">Cp = (USL − LSL) ÷ (6σ)</span><br>
            = (${usl} − ${lsl}) ÷ (6 × ${std}) = ${(usl - lsl).toFixed(3)} ÷ ${(6 * std).toFixed(3)} = <strong>${cp.toFixed(2)}</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 2: Upper Capability Index (Cpu)</div>
            <span class="formula">Cpu = (USL − X̄) ÷ (3σ)</span><br>
            = (${usl} − ${mean}) ÷ (3 × ${std}) = ${(usl - mean).toFixed(3)} ÷ ${(3 * std).toFixed(3)} = <strong>${cpu.toFixed(2)}</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 3: Lower Capability Index (Cpl)</div>
            <span class="formula">Cpl = (X̄ − LSL) ÷ (3σ)</span><br>
            = (${mean} − ${lsl}) ÷ (3 × ${std}) = ${(mean - lsl).toFixed(3)} ÷ ${(3 * std).toFixed(3)} = <strong>${cpl.toFixed(2)}</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 4: Process Capability Index (Cpk)</div>
            <span class="formula">Cpk = min(Cpu, Cpl)</span><br>
            = min(${cpu.toFixed(2)}, ${cpl.toFixed(2)}) = <strong>${cpk.toFixed(2)}</strong>
            ${cpk >= 1.33 ? ' — Excellent' : cpk >= 1.0 ? ' — Acceptable' : cpk >= 0.67 ? ' — Poor' : ' — Incapable'}
        </div>
    `;

    let assessment = '';
    if (cpk >= 1.33) assessment = 'Excellent - process is capable';
    else if (cpk >= 1.0) assessment = 'Acceptable - monitor closely';
    else if (cpk >= 0.67) assessment = 'Poor - improvement needed';
    else assessment = 'Incapable - immediate action required';

    if (Math.abs(cpu - cpl) > 0.3) {
        assessment += (cpu < cpl) ? ', shift process down' : ', shift process up';
    }
    document.getElementById('cpk-assessment').textContent = assessment;

    // Distribution chart
    const xMin = lsl - 2 * std;
    const xMax = usl + 2 * std;
    const step = (xMax - xMin) / 100;
    const xVals = [], yVals = [];

    for (let x = xMin; x <= xMax; x += step) {
        xVals.push(x);
        yVals.push(Math.exp(-0.5 * Math.pow((x - mean) / std, 2)) / (std * Math.sqrt(2 * Math.PI)));
    }

    Plotly.newPlot('cpk-chart', [{
        x: xVals, y: yVals, type: 'scatter', mode: 'lines',
        fill: 'tozeroy', fillcolor: 'rgba(74, 159, 110, 0.3)',
        line: { color: '#4a9f6e', width: 2 }
    }], {
        shapes: [
            { type: 'line', x0: lsl, x1: lsl, y0: 0, y1: Math.max(...yVals) * 1.1, line: { color: '#e74c3c', width: 2 } },
            { type: 'line', x0: usl, x1: usl, y0: 0, y1: Math.max(...yVals) * 1.1, line: { color: '#e74c3c', width: 2 } },
            { type: 'line', x0: mean, x1: mean, y0: 0, y1: Math.max(...yVals) * 1.1, line: { color: '#3a7f8f', width: 2, dash: 'dash' } }
        ],
        annotations: [
            { x: lsl, y: Math.max(...yVals) * 1.05, text: 'LSL', showarrow: false, font: { color: '#e74c3c' } },
            { x: usl, y: Math.max(...yVals) * 1.05, text: 'USL', showarrow: false, font: { color: '#e74c3c' } },
            { x: mean, y: Math.max(...yVals) * 0.9, text: 'X̄', showarrow: false, font: { color: '#3a7f8f' } }
        ],
        margin: { t: 20, b: 40, l: 50, r: 20 },
        paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
        font: { color: '#9aaa9a' },
        xaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
        yaxis: { showticklabels: false, gridcolor: 'rgba(255,255,255,0.1)' }
    }, { responsive: true, displayModeBar: false });

    // Publish to shared state
    SvendOps.publish('cpk', parseFloat(cpk.toFixed(2)), '', 'Cpk');
    SvendOps.publish('cp', parseFloat(cp.toFixed(2)), '', 'Cpk');

    renderNextSteps('cpk-next-steps', [
        { title: 'Sigma Level', desc: 'Convert capability to sigma score', calcId: 'dpmo' },
        { title: 'FMEA', desc: 'Assess failure risk for this process', calcId: 'fmea' },
        { title: 'Sample Size', desc: 'Plan the sample needed to confirm capability', calcId: 'samplesize' },
    ]);
}

function normalCDF(z) {
    const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741, a4 = -1.453152027, a5 = 1.061405429, p = 0.3275911;
    const sign = z < 0 ? -1 : 1;
    z = Math.abs(z) / Math.sqrt(2);
    const t = 1.0 / (1.0 + p * z);
    const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-z * z);
    return 0.5 * (1.0 + sign * y);
}

function toggleCpkMonteCarlo(btn) {
    btn.classList.toggle('active');
    const results = document.getElementById('cpk-monte-results');
    results.classList.toggle('visible');
    if (btn.classList.contains('active')) { runCpkMonteCarlo(); }
}

function runCpkMonteCarlo() {
    const mean = parseFloat(document.getElementById('cpk-mean').value) || 0;
    const std = parseFloat(document.getElementById('cpk-std').value) || 0.01;
    const usl = parseFloat(document.getElementById('cpk-usl').value) || 0;
    const lsl = parseFloat(document.getElementById('cpk-lsl').value) || 0;

    const calcCpkValue = (m, s) => {
        const cpu = (usl - m) / (3 * s);
        const cpl = (m - lsl) / (3 * s);
        return Math.min(cpu, cpl);
    };

    const inputs = [
        { value: mean, cv: 0.05 },
        { value: std, cv: 0.10 }
    ];

    const sim = MonteCarlo.simulate(calcCpkValue, inputs, 2000);

    document.getElementById('cpk-monte-mean').textContent = sim.mean.toFixed(2);
    document.getElementById('cpk-monte-p5').textContent = sim.p5.toFixed(2);
    document.getElementById('cpk-monte-p95').textContent = sim.p95.toFixed(2);
    document.getElementById('cpk-monte-std').textContent = `±${sim.std.toFixed(2)}`;

    MonteCarlo.renderHistogram('cpk-monte-chart', sim, 'Cpk Distribution (2000 runs)', '');
}

// ============================================================================
// Sample Size
// ============================================================================

function updateSampleForm() {
    const type = document.getElementById('sample-type').value;
    document.getElementById('sample-std-group').style.display = type === 'mean' || type === 'comparison' ? 'flex' : 'none';
    document.getElementById('sample-prop-group').style.display = type === 'proportion' ? 'flex' : 'none';
    document.getElementById('sample-power-group').style.display = type === 'comparison' ? 'flex' : 'none';
    document.getElementById('sample-effect-group').style.display = type === 'comparison' ? 'flex' : 'none';
    document.getElementById('sample-margin-group').style.display = type !== 'comparison' ? 'flex' : 'none';
    calcSampleSize();
}

function calcSampleSize() {
    const type = document.getElementById('sample-type').value;
    const z = parseFloat(document.getElementById('sample-conf').value);
    let n, formula;

    if (type === 'mean') {
        const margin = parseFloat(document.getElementById('sample-margin').value) || 1;
        const std = parseFloat(document.getElementById('sample-std').value) || 1;
        n = Math.pow((z * std) / margin, 2);
        formula = 'n = (Zσ/E)²';
    } else if (type === 'proportion') {
        const margin = parseFloat(document.getElementById('sample-margin').value) / 100 || 0.05;
        const p = parseFloat(document.getElementById('sample-prop').value) / 100 || 0.5;
        n = Math.pow(z, 2) * p * (1 - p) / Math.pow(margin, 2);
        formula = 'n = Z²p(1-p)/E²';
    } else {
        const std = parseFloat(document.getElementById('sample-std').value) || 1;
        const zb = parseFloat(document.getElementById('sample-power').value);
        const effect = parseFloat(document.getElementById('sample-effect').value) || 1;
        n = 2 * Math.pow((z + zb) * std / effect, 2);
        formula = 'n = 2((Zα+Zβ)σ/δ)² per group';
    }

    document.getElementById('sample-result').innerHTML = `${Math.ceil(n)}<span class="calc-result-unit">${type === 'comparison' ? 'per group' : 'samples'}</span>`;
    document.getElementById('sample-formula').textContent = formula;

    // Update derivation
    let sampleDerivation = '';
    if (type === 'mean') {
        const margin = parseFloat(document.getElementById('sample-margin').value) || 1;
        const std = parseFloat(document.getElementById('sample-std').value) || 1;
        sampleDerivation = `
            <div class="step">
                <div class="step-num">Estimating a Mean</div>
                <span class="formula">n = (Zσ / E)²</span><br>
                Where Z = ${z} (confidence), σ = ${std} (std dev), E = ${margin} (margin of error)<br>
                n = (${z} × ${std} / ${margin})² = (${(z * std / margin).toFixed(2)})² = <strong>${Math.ceil(n)} samples</strong>
            </div>`;
    } else if (type === 'proportion') {
        const margin = parseFloat(document.getElementById('sample-margin').value) / 100 || 0.05;
        const p = parseFloat(document.getElementById('sample-prop').value) / 100 || 0.5;
        sampleDerivation = `
            <div class="step">
                <div class="step-num">Estimating a Proportion</div>
                <span class="formula">n = Z²p(1−p) / E²</span><br>
                Where Z = ${z}, p = ${p.toFixed(2)}, E = ${margin.toFixed(4)}<br>
                n = ${z}² × ${p.toFixed(2)} × ${(1 - p).toFixed(2)} / ${margin.toFixed(4)}² = <strong>${Math.ceil(n)} samples</strong>
            </div>`;
    } else {
        const std = parseFloat(document.getElementById('sample-std').value) || 1;
        const zb = parseFloat(document.getElementById('sample-power').value);
        const effect = parseFloat(document.getElementById('sample-effect').value) || 1;
        sampleDerivation = `
            <div class="step">
                <div class="step-num">Two-Sample Comparison</div>
                <span class="formula">n = 2((Z_α + Z_β)σ / δ)² per group</span><br>
                Where Z_α = ${z}, Z_β = ${zb}, σ = ${std}, δ = ${effect}<br>
                n = 2 × ((${z} + ${zb}) × ${std} / ${effect})² = <strong>${Math.ceil(n)} per group</strong>
            </div>`;
    }
    document.getElementById('samplesize-derivation-body').innerHTML = sampleDerivation;
}

// ============================================================================
// Line Efficiency
// ============================================================================

function calcLineEff() {
    const theoretical = parseFloat(document.getElementById('lineeff-theoretical').value) || 1;
    const scheduled = parseFloat(document.getElementById('lineeff-scheduled').value) || 1;
    const actual = parseFloat(document.getElementById('lineeff-actual').value) || 0;
    const planned = parseFloat(document.getElementById('lineeff-planned').value) || 0;
    const unplanned = parseFloat(document.getElementById('lineeff-unplanned').value) || 0;
    const changeover = parseFloat(document.getElementById('lineeff-changeover').value) || 0;
    const minor = parseFloat(document.getElementById('lineeff-minor').value) || 0;

    const theoreticalOutput = theoretical * (scheduled / 60);
    const efficiency = (actual / theoreticalOutput) * 100;
    const actualRate = actual / (scheduled / 60);
    const lost = theoreticalOutput - actual;

    document.getElementById('lineeff-result').innerHTML = `${efficiency.toFixed(1)}<span class="calc-result-unit">%</span>`;
    document.getElementById('lineeff-rate').innerHTML = `${actualRate.toFixed(0)}<span class="calc-result-unit">/hr</span>`;
    document.getElementById('lineeff-lost').textContent = Math.round(lost);

    // Update derivation
    const running = scheduled - planned - unplanned - changeover - minor;
    document.getElementById('lineeff-derivation-body').innerHTML = `
        <div class="step">
            <div class="step-num">Step 1: Theoretical Output</div>
            <span class="formula">Theoretical = Rate × (Scheduled ÷ 60)</span><br>
            = ${theoretical} × (${scheduled} ÷ 60) = <strong>${theoreticalOutput.toFixed(0)} units</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 2: Running Time</div>
            <span class="formula">Running = Scheduled − Planned − Unplanned − Changeover − Minor</span><br>
            = ${scheduled} − ${planned} − ${unplanned} − ${changeover} − ${minor} = <strong>${running} min</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 3: Line Efficiency</div>
            <span class="formula">Efficiency = (Actual Output ÷ Theoretical) × 100</span><br>
            = (${actual} ÷ ${theoreticalOutput.toFixed(0)}) × 100 = <strong>${efficiency.toFixed(1)}%</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 4: Lost Units</div>
            <span class="formula">Lost = Theoretical − Actual</span><br>
            = ${theoreticalOutput.toFixed(0)} − ${actual} = <strong>${Math.round(lost)} units</strong>
        </div>
    `;

    // Waterfall chart
    const categories = ['Scheduled', 'Planned', 'Unplanned', 'Changeover', 'Minor Stops', 'Running'];
    const values = [scheduled, -planned, -unplanned, -changeover, -minor, 0];

    let cumulative = scheduled;
    const measures = ['absolute', 'relative', 'relative', 'relative', 'relative', 'total'];

    Plotly.newPlot('lineeff-chart', [{
        type: 'waterfall',
        orientation: 'v',
        x: categories,
        y: values.map((v, i) => i === 5 ? running : v),
        measure: measures,
        connector: { line: { color: 'rgba(255,255,255,0.2)' } },
        decreasing: { marker: { color: '#e74c3c' } },
        increasing: { marker: { color: '#4a9f6e' } },
        totals: { marker: { color: '#3a7f8f' } },
        text: values.map((v, i) => i === 0 ? `${scheduled}` : i === 5 ? `${running}` : `${Math.abs(v)}`),
        textposition: 'outside'
    }], {
        margin: { t: 20, b: 60, l: 50, r: 20 },
        paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
        font: { color: '#9aaa9a' },
        yaxis: { title: 'Minutes', gridcolor: 'rgba(255,255,255,0.1)' },
        xaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
        showlegend: false
    }, { responsive: true, displayModeBar: false });

    SvendOps.publish('lineEffCalc', parseFloat(efficiency.toFixed(1)), '%', 'Line Eff');
    SvendOps.publish('lineEffActualRate', parseFloat(actualRate.toFixed(0)), '/hr', 'Line Eff');
}

// ============================================================================
// OLE (Overall Labor Effectiveness)
// ============================================================================

function calcOLE() {
    const scheduled = parseFloat(document.getElementById('ole-scheduled').value) || 1;
    const absent = parseFloat(document.getElementById('ole-absent').value) || 0;
    const breaks = parseFloat(document.getElementById('ole-breaks').value) || 0;
    const standard = parseFloat(document.getElementById('ole-standard').value) || 1;
    const actual = parseFloat(document.getElementById('ole-actual').value) || 0;
    const good = parseFloat(document.getElementById('ole-good').value) || 0;

    const available = scheduled - absent - breaks;
    const availability = available / scheduled;
    const expectedOutput = available * standard;
    const performance = Math.min(1, actual / expectedOutput);
    const quality = actual > 0 ? good / actual : 0;
    const ole = availability * performance * quality * 100;

    const oleEl = document.getElementById('ole-result');
    oleEl.textContent = `${ole.toFixed(1)}%`;
    oleEl.className = 'oee-value ' + (ole >= 85 ? 'oee-world-class' : ole >= 65 ? 'oee-good' : 'oee-poor');

    document.getElementById('ole-availability').textContent = `${(availability * 100).toFixed(1)}%`;
    document.getElementById('ole-performance').textContent = `${(performance * 100).toFixed(1)}%`;
    document.getElementById('ole-quality').textContent = `${(quality * 100).toFixed(1)}%`;

    // Breakdown stats
    document.getElementById('ole-avail-hours').textContent = `${available.toFixed(1)} hrs`;
    document.getElementById('ole-good-display').textContent = `${good} units`;

    // Update derivation
    document.getElementById('ole-derivation-body').innerHTML = `
        <div class="step">
            <div class="step-num">Step 1: Availability</div>
            <span class="formula">Availability = (Scheduled − Absent − Breaks) ÷ Scheduled</span><br>
            = (${scheduled} − ${absent} − ${breaks}) ÷ ${scheduled} = ${available.toFixed(1)} ÷ ${scheduled} = <strong>${(availability * 100).toFixed(1)}%</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 2: Performance</div>
            <span class="formula">Performance = Actual Output ÷ (Available × Standard Rate)</span><br>
            = ${actual} ÷ (${available.toFixed(1)} × ${standard}) = ${actual} ÷ ${expectedOutput.toFixed(0)} = <strong>${(performance * 100).toFixed(1)}%</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 3: Quality</div>
            <span class="formula">Quality = Good Units ÷ Actual Output</span><br>
            = ${good} ÷ ${actual} = <strong>${(quality * 100).toFixed(1)}%</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 4: OLE</div>
            <span class="formula">OLE = Availability × Performance × Quality</span><br>
            = ${(availability * 100).toFixed(1)}% × ${(performance * 100).toFixed(1)}% × ${(quality * 100).toFixed(1)}% = <strong>${ole.toFixed(1)}%</strong>
        </div>
    `;

    // Donut chart
    const availLoss = (1 - availability) * 100;
    const perfLoss = availability * (1 - performance) * 100;
    const qualLoss = availability * performance * (1 - quality) * 100;

    Plotly.newPlot('ole-chart', [{
        values: [ole, availLoss, perfLoss, qualLoss],
        labels: ['OLE', 'Availability Loss', 'Performance Loss', 'Quality Loss'],
        type: 'pie', hole: 0.6,
        marker: { colors: [ole >= 85 ? '#27ae60' : ole >= 65 ? '#f39c12' : '#e74c3c', '#e74c3c', '#f39c12', '#9b59b6'] },
        textinfo: 'percent', textposition: 'outside',
        textfont: { size: 10, color: '#9aaa9a' }, sort: false
    }], {
        margin: { t: 20, b: 20, l: 20, r: 20 },
        paper_bgcolor: 'transparent', showlegend: false,
        annotations: [{ text: `<b>${ole.toFixed(0)}%</b>`, showarrow: false,
            font: { size: 24, color: ole >= 85 ? '#27ae60' : ole >= 65 ? '#f39c12' : '#e74c3c' } }]
    }, { responsive: true, displayModeBar: false });

    SvendOps.publish('ole', parseFloat(ole.toFixed(1)), '%', 'OLE');
}

// ============================================================================
// Cycle Time Study
// ============================================================================

let cycleData = [
    { name: 'Pick up part', time: 5, type: 'nva' },
    { name: 'Position in fixture', time: 8, type: 'nva' },
    { name: 'Machine cycle', time: 45, type: 'va' },
    { name: 'Wait for next part', time: 12, type: 'wait' },
    { name: 'Inspect', time: 10, type: 'va' },
    { name: 'Set aside', time: 5, type: 'nva' },
];

function renderCycleInputs() {
    const container = document.getElementById('cycletime-elements');
    container.innerHTML = cycleData.map((c, i) => `
        <div class="yamazumi-station" style="gap: 8px;">
            <input type="text" value="${c.name}" style="flex:1; padding: 8px;" oninput="updateCycle(${i}, 'name', this.value)">
            <input type="number" value="${c.time}" style="width:70px; text-align:right;" oninput="updateCycle(${i}, 'time', this.value)">
            <span style="color: var(--text-dim); font-size: 12px;">sec</span>
            <select style="width: 80px; padding: 8px;" onchange="updateCycle(${i}, 'type', this.value)">
                <option value="va" ${c.type === 'va' ? 'selected' : ''}>VA</option>
                <option value="nva" ${c.type === 'nva' ? 'selected' : ''}>NVA</option>
                <option value="wait" ${c.type === 'wait' ? 'selected' : ''}>Wait</option>
            </select>
            <button class="yamazumi-station-remove" onclick="removeCycle(${i})">&times;</button>
        </div>
    `).join('');
    calcCycle();
}

function addCycleElement() {
    cycleData.push({ name: 'New element', time: 10, type: 'nva' });
    renderCycleInputs();
}

function removeCycle(idx) {
    cycleData.splice(idx, 1);
    renderCycleInputs();
}

function updateCycle(idx, field, value) {
    if (field === 'time') value = parseFloat(value) || 0;
    cycleData[idx][field] = value;
    calcCycle();
}

function calcCycle() {
    const va = cycleData.filter(c => c.type === 'va').reduce((a, c) => a + c.time, 0);
    const nva = cycleData.filter(c => c.type === 'nva').reduce((a, c) => a + c.time, 0);
    const wait = cycleData.filter(c => c.type === 'wait').reduce((a, c) => a + c.time, 0);
    const total = va + nva + wait;

    document.getElementById('cycle-total').innerHTML = `${total}<span class="calc-result-unit">sec</span>`;
    document.getElementById('cycle-va').innerHTML = `${va}<span class="calc-result-unit">sec</span>`;
    document.getElementById('cycle-nva').innerHTML = `${nva}<span class="calc-result-unit">sec</span>`;
    document.getElementById('cycle-wait').innerHTML = `${wait}<span class="calc-result-unit">sec</span>`;
    document.getElementById('cycle-va-pct').textContent = total > 0 ? `${((va / total) * 100).toFixed(0)}%` : '0%';
    document.getElementById('cycle-waste-pct').textContent = total > 0 ? `${(((nva + wait) / total) * 100).toFixed(0)}%` : '0%';

    // Update derivation
    const vaPct = total > 0 ? ((va / total) * 100).toFixed(0) : 0;
    const nvaPct = total > 0 ? ((nva / total) * 100).toFixed(0) : 0;
    const waitPct = total > 0 ? ((wait / total) * 100).toFixed(0) : 0;
    document.getElementById('cycletime-derivation-body').innerHTML = `
        <div class="step">
            <div class="step-num">Step 1: Value-Add Time</div>
            VA = ${cycleData.filter(c => c.type === 'va').map(c => c.time).join(' + ') || '0'} = <strong>${va} sec</strong> (${vaPct}%)
        </div>
        <div class="step">
            <div class="step-num">Step 2: Non Value-Add Time</div>
            NVA = ${cycleData.filter(c => c.type === 'nva').map(c => c.time).join(' + ') || '0'} = <strong>${nva} sec</strong> (${nvaPct}%)
        </div>
        <div class="step">
            <div class="step-num">Step 3: Wait Time</div>
            Wait = ${cycleData.filter(c => c.type === 'wait').map(c => c.time).join(' + ') || '0'} = <strong>${wait} sec</strong> (${waitPct}%)
        </div>
        <div class="step">
            <div class="step-num">Step 4: Total Cycle Time</div>
            <span class="formula">Total = VA + NVA + Wait</span><br>
            = ${va} + ${nva} + ${wait} = <strong>${total} sec</strong>
        </div>
    `;

    Plotly.newPlot('cycletime-chart', [{
        values: [va, nva, wait],
        labels: ['Value-Add', 'Non Value-Add', 'Wait'],
        type: 'pie',
        marker: { colors: ['#4a9f6e', '#f39c12', '#e74c3c'] },
        textinfo: 'label+percent',
        textposition: 'inside',
        textfont: { size: 12, color: '#fff' }
    }], {
        margin: { t: 20, b: 20, l: 20, r: 20 },
        paper_bgcolor: 'transparent', showlegend: false
    }, { responsive: true, displayModeBar: false });

    SvendOps.publish('cycleTimeTotal', total, 'sec', 'Cycle Time');
    SvendOps.publish('cycleTimeVA', va, 'sec', 'Cycle Time');
}

// ============================================================================
// Before / After
// ============================================================================

let baData = [
    { metric: 'Cycle Time', before: 120, after: 85, unit: 'sec', lowerBetter: true },
    { metric: 'Defect Rate', before: 3.5, after: 1.2, unit: '%', lowerBetter: true },
    { metric: 'OEE', before: 65, after: 82, unit: '%', lowerBetter: false },
];

function renderBAInputs() {
    const container = document.getElementById('beforeafter-metrics');
    container.innerHTML = baData.map((m, i) => `
        <div style="display: grid; grid-template-columns: 1fr 100px 100px 60px 80px 30px; gap: 8px; align-items: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
            <input type="text" value="${m.metric}" placeholder="Metric" style="padding: 8px;" oninput="updateBA(${i}, 'metric', this.value)">
            <input type="number" value="${m.before}" placeholder="Before" style="text-align: right; padding: 8px;" oninput="updateBA(${i}, 'before', this.value)">
            <input type="number" value="${m.after}" placeholder="After" style="text-align: right; padding: 8px;" oninput="updateBA(${i}, 'after', this.value)">
            <input type="text" value="${m.unit}" placeholder="Unit" style="padding: 8px;" oninput="updateBA(${i}, 'unit', this.value)">
            <select style="padding: 8px;" onchange="updateBA(${i}, 'lowerBetter', this.value === 'true')">
                <option value="true" ${m.lowerBetter ? 'selected' : ''}>↓ Better</option>
                <option value="false" ${!m.lowerBetter ? 'selected' : ''}>↑ Better</option>
            </select>
            <button class="yamazumi-station-remove" onclick="removeBA(${i})">&times;</button>
        </div>
    `).join('');
    calcBA();
}

function addBAMetric() {
    baData.push({ metric: 'New Metric', before: 100, after: 80, unit: '', lowerBetter: true });
    renderBAInputs();
}

function removeBA(idx) {
    baData.splice(idx, 1);
    renderBAInputs();
}

function updateBA(idx, field, value) {
    if (field === 'before' || field === 'after') value = parseFloat(value) || 0;
    baData[idx][field] = value;
    calcBA();
}

function calcBA() {
    if (baData.length === 0) return;

    const improvements = baData.map(m => {
        const change = m.after - m.before;
        const pctChange = m.before !== 0 ? (change / m.before) * 100 : 0;
        const improved = m.lowerBetter ? change < 0 : change > 0;
        return { ...m, change, pctChange, improved };
    });

    Plotly.newPlot('beforeafter-chart', [
        {
            x: improvements.map(m => m.metric),
            y: improvements.map(m => m.before),
            type: 'bar', name: 'Before',
            marker: { color: '#666' }
        },
        {
            x: improvements.map(m => m.metric),
            y: improvements.map(m => m.after),
            type: 'bar', name: 'After',
            marker: { color: improvements.map(m => m.improved ? '#4a9f6e' : '#e74c3c') },
            text: improvements.map(m => `${m.pctChange >= 0 ? '+' : ''}${m.pctChange.toFixed(1)}%`),
            textposition: 'outside'
        }
    ], {
        barmode: 'group',
        margin: { t: 20, b: 80, l: 50, r: 20 },
        paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
        font: { color: '#9aaa9a' },
        yaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
        xaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
        legend: { orientation: 'h', y: -0.2, x: 0.5, xanchor: 'center' }
    }, { responsive: true, displayModeBar: false });
}

// ============================================================================
// Heijunka
// ============================================================================

let heijunkaData = [
    { product: 'A', demand: 100 },
    { product: 'B', demand: 60 },
    { product: 'C', demand: 40 },
];

function renderHeijunkaInputs() {
    const container = document.getElementById('heijunka-products');
    container.innerHTML = heijunkaData.map((p, i) => `
        <div class="yamazumi-station" style="gap: 8px;">
            <input type="text" value="${p.product}" style="width: 80px; padding: 8px;" oninput="updateHeijunka(${i}, 'product', this.value)">
            <span style="color: var(--text-dim);">Daily demand:</span>
            <input type="number" value="${p.demand}" style="width: 100px; text-align: right; padding: 8px;" oninput="updateHeijunka(${i}, 'demand', this.value)">
            <button class="yamazumi-station-remove" onclick="removeHeijunka(${i})">&times;</button>
        </div>
    `).join('');
    calcHeijunka();
}

function addHeijunkaProduct() {
    heijunkaData.push({ product: String.fromCharCode(65 + heijunkaData.length), demand: 50 });
    renderHeijunkaInputs();
}

function removeHeijunka(idx) {
    heijunkaData.splice(idx, 1);
    renderHeijunkaInputs();
}

function updateHeijunka(idx, field, value) {
    if (field === 'demand') value = parseInt(value) || 0;
    heijunkaData[idx][field] = value;
    calcHeijunka();
}

function calcHeijunka() {
    const time = parseFloat(document.getElementById('heijunka-time').value) || 480;
    const pitch = parseFloat(document.getElementById('heijunka-pitch').value) || 20;

    const intervals = Math.floor(time / pitch);
    const totalDemand = heijunkaData.reduce((a, p) => a + p.demand, 0);
    const perPitch = totalDemand / intervals;

    document.getElementById('heijunka-intervals').textContent = intervals;
    document.getElementById('heijunka-total').textContent = totalDemand;
    document.getElementById('heijunka-per-pitch').textContent = perPitch.toFixed(1);

    // Update derivation
    const productBreakdown = heijunkaData.map(p =>
        `${p.product}: ${p.demand} units (${totalDemand > 0 ? ((p.demand / totalDemand) * 100).toFixed(0) : 0}% of mix)`
    ).join('<br>');
    document.getElementById('heijunka-derivation-body').innerHTML = `
        <div class="step">
            <div class="step-num">Step 1: Calculate Intervals</div>
            <span class="formula">Intervals = Available Time ÷ Pitch</span><br>
            = ${time} ÷ ${pitch} = <strong>${intervals} intervals</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 2: Total Demand</div>
            ${productBreakdown}<br>
            Total = <strong>${totalDemand} units</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 3: Units per Pitch Interval</div>
            <span class="formula">Per Pitch = Total Demand ÷ Intervals</span><br>
            = ${totalDemand} ÷ ${intervals} = <strong>${perPitch.toFixed(1)} units/interval</strong>
        </div>
    `;

    // Calculate pattern
    const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
    const demands = heijunkaData.map(p => p.demand);
    const patternGcd = demands.reduce((a, b) => gcd(a, b));
    const pattern = heijunkaData.map(p => p.product.repeat(p.demand / patternGcd)).join('');
    document.getElementById('heijunka-pattern').textContent = pattern.length > 20
        ? `${pattern.substring(0, 20)}... (repeats ${intervals / (totalDemand / patternGcd)}×)`
        : `${pattern} (repeats ${Math.floor(intervals / (pattern.length || 1))}×)`;

    // Heijunka box visualization (first 10 intervals)
    const boxData = [];
    let patternIdx = 0;
    for (let i = 0; i < Math.min(10, intervals); i++) {
        const slot = [];
        for (let j = 0; j < Math.ceil(perPitch); j++) {
            if (patternIdx < pattern.length) {
                slot.push(pattern[patternIdx % pattern.length]);
                patternIdx++;
            }
        }
        boxData.push(slot);
    }

    // Create heatmap-style visualization
    const colors = {};
    heijunkaData.forEach((p, i) => {
        const hue = (i * 137) % 360;
        colors[p.product] = `hsl(${hue}, 60%, 50%)`;
    });

    const traces = heijunkaData.map(p => ({
        x: Array.from({ length: Math.min(10, intervals) }, (_, i) => `Pitch ${i + 1}`),
        y: boxData.map(slot => slot.filter(s => s === p.product).length),
        type: 'bar',
        name: p.product,
        marker: { color: colors[p.product] }
    }));

    Plotly.newPlot('heijunka-chart', traces, {
        barmode: 'stack',
        margin: { t: 20, b: 60, l: 40, r: 20 },
        paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
        font: { color: '#9aaa9a' },
        yaxis: { title: 'Units', gridcolor: 'rgba(255,255,255,0.1)' },
        xaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
        legend: { orientation: 'h', y: -0.25, x: 0.5, xanchor: 'center' }
    }, { responsive: true, displayModeBar: false });
}

// ============================================================================
// SCHEDULING TOOLS
// ============================================================================

// ============================================================================
// Job Sequencer
// ============================================================================

let sequencerJobs = [
    { id: 1, name: 'Job A', processTime: 45, dueDate: 120, setupGroup: 'Type1' },
    { id: 2, name: 'Job B', processTime: 30, dueDate: 90, setupGroup: 'Type2' },
    { id: 3, name: 'Job C', processTime: 60, dueDate: 200, setupGroup: 'Type1' },
    { id: 4, name: 'Job D', processTime: 25, dueDate: 150, setupGroup: 'Type3' },
];

let sequencerOrder = [0, 1, 2, 3]; // Indices into sequencerJobs
let draggedJobIdx = null;

function renderSequencerJobs() {
    const container = document.getElementById('sequencer-jobs');
    if (!container) return;

    container.innerHTML = sequencerJobs.map((job, i) => `
        <div class="yamazumi-station" style="gap: 8px;">
            <input type="text" value="${job.name}" style="flex: 1; padding: 8px;"
                   oninput="updateSequencerJob(${i}, 'name', this.value)" placeholder="Job name">
            <input type="number" value="${job.processTime}" style="width: 60px; text-align: right;"
                   oninput="updateSequencerJob(${i}, 'processTime', this.value)" title="Process time">
            <span style="color: var(--text-dim); font-size: 11px;">min</span>
            <input type="number" value="${job.dueDate}" style="width: 70px; text-align: right;"
                   oninput="updateSequencerJob(${i}, 'dueDate', this.value)" title="Due date">
            <span style="color: var(--text-dim); font-size: 11px;">due</span>
            <input type="text" value="${job.setupGroup}" style="width: 60px; text-align: center;"
                   oninput="updateSequencerJob(${i}, 'setupGroup', this.value)" title="Setup group">
            <button class="yamazumi-station-remove" onclick="removeSequencerJob(${i})">&times;</button>
        </div>
    `).join('');

    renderSequencerGantt();
}

function addSequencerJob() {
    const id = sequencerJobs.length > 0 ? Math.max(...sequencerJobs.map(j => j.id)) + 1 : 1;
    sequencerJobs.push({ id, name: `Job ${String.fromCharCode(65 + sequencerJobs.length)}`, processTime: 30, dueDate: 180, setupGroup: 'Type1' });
    sequencerOrder.push(sequencerJobs.length - 1);
    renderSequencerJobs();
}

function removeSequencerJob(idx) {
    sequencerJobs.splice(idx, 1);
    // Update order indices
    sequencerOrder = sequencerOrder.filter(i => i !== idx).map(i => i > idx ? i - 1 : i);
    renderSequencerJobs();
}

function updateSequencerJob(idx, field, value) {
    if (field === 'processTime' || field === 'dueDate') value = parseFloat(value) || 0;
    sequencerJobs[idx][field] = value;
    renderSequencerGantt();
}

function loadSampleJobs() {
    sequencerJobs = [
        { id: 1, name: 'Order 101', processTime: 45, dueDate: 120, setupGroup: 'A' },
        { id: 2, name: 'Order 102', processTime: 30, dueDate: 90, setupGroup: 'B' },
        { id: 3, name: 'Order 103', processTime: 60, dueDate: 200, setupGroup: 'A' },
        { id: 4, name: 'Order 104', processTime: 25, dueDate: 150, setupGroup: 'C' },
        { id: 5, name: 'Order 105', processTime: 50, dueDate: 250, setupGroup: 'B' },
        { id: 6, name: 'Order 106', processTime: 35, dueDate: 180, setupGroup: 'A' },
    ];
    sequencerOrder = [0, 1, 2, 3, 4, 5];
    renderSequencerJobs();
}

function getSetupTime(fromGroup, toGroup) {
    if (fromGroup === toGroup) return 0;
    // Try to get from changeover matrix if available
    if (typeof changeoverMatrix !== 'undefined' && changeoverMatrix[fromGroup]?.[toGroup]) {
        return changeoverMatrix[fromGroup][toGroup];
    }
    // Default: 10 min for different groups
    return 10;
}

function calcSequencerMetrics() {
    if (sequencerJobs.length === 0) return { makespan: 0, flowTime: 0, setup: 0, tardiness: 0, lateCount: 0 };

    let currentTime = 0;
    let totalFlowTime = 0;
    let totalSetup = 0;
    let totalTardiness = 0;
    let lateCount = 0;
    let prevGroup = null;

    const schedule = [];

    sequencerOrder.forEach(idx => {
        const job = sequencerJobs[idx];
        if (!job) return;

        // Setup time
        const setup = prevGroup ? getSetupTime(prevGroup, job.setupGroup) : 0;
        totalSetup += setup;

        const startTime = currentTime + setup;
        const endTime = startTime + job.processTime;

        schedule.push({ job, startTime, endTime, setup });

        totalFlowTime += endTime;

        if (endTime > job.dueDate) {
            totalTardiness += (endTime - job.dueDate);
            lateCount++;
        }

        currentTime = endTime;
        prevGroup = job.setupGroup;
    });

    return {
        makespan: currentTime,
        flowTime: totalFlowTime,
        avgFlowTime: sequencerJobs.length > 0 ? totalFlowTime / sequencerJobs.length : 0,
        setup: totalSetup,
        tardiness: totalTardiness,
        lateCount,
        schedule
    };
}

function renderSequencerGantt() {
    const container = document.getElementById('sequencer-gantt');
    if (!container) return;

    const metrics = calcSequencerMetrics();

    // Update metrics display
    document.getElementById('seq-makespan').innerHTML = `${metrics.makespan}<span class="calc-result-unit">min</span>`;
    document.getElementById('seq-flowtime').innerHTML = `${metrics.flowTime}<span class="calc-result-unit">min</span>`;
    document.getElementById('seq-setup').innerHTML = `${metrics.setup}<span class="calc-result-unit">min</span>`;
    document.getElementById('seq-late').textContent = metrics.lateCount;
    document.getElementById('seq-tardiness').textContent = `${metrics.tardiness} min (${metrics.lateCount} jobs late)`;
    document.getElementById('seq-avg-flow').textContent = `${metrics.avgFlowTime.toFixed(0)} min`;

    if (sequencerJobs.length === 0) {
        container.innerHTML = '<div style="color: var(--text-dim); text-align: center; padding: 40px;">Add jobs to see Gantt chart</div>';
        return;
    }

    // Generate colors for setup groups
    const groups = [...new Set(sequencerJobs.map(j => j.setupGroup))];
    const groupColors = {};
    groups.forEach((g, i) => {
        const hue = (i * 137) % 360;
        groupColors[g] = `hsl(${hue}, 60%, 45%)`;
    });

    // Render Gantt
    const scale = Math.max(metrics.makespan, Math.max(...sequencerJobs.map(j => j.dueDate)));
    const barHeight = 32;

    let html = `<div style="position: relative; min-width: ${Math.max(600, scale * 2)}px;">`;

    // Time axis
    html += `<div style="height: 24px; border-bottom: 1px solid var(--border); margin-bottom: 8px; position: relative;">`;
    for (let t = 0; t <= scale; t += Math.ceil(scale / 10)) {
        const left = (t / scale) * 100;
        html += `<span style="position: absolute; left: ${left}%; font-size: 10px; color: var(--text-dim);">${t}</span>`;
    }
    html += `</div>`;

    // Bars
    metrics.schedule.forEach((item, i) => {
        const leftPct = (item.startTime / scale) * 100;
        const widthPct = (item.job.processTime / scale) * 100;
        const setupWidthPct = (item.setup / scale) * 100;
        const duePct = (item.job.dueDate / scale) * 100;
        const isLate = item.endTime > item.job.dueDate;

        html += `
            <div style="height: ${barHeight}px; margin-bottom: 4px; position: relative; display: flex; align-items: center;"
                 draggable="true" data-idx="${i}"
                 ondragstart="handleJobDragStart(event, ${i})"
                 ondragover="handleJobDragOver(event)"
                 ondrop="handleJobDrop(event, ${i})"
                 ondragend="handleJobDragEnd()">
                <!-- Setup bar -->
                ${item.setup > 0 ? `<div style="position: absolute; left: ${leftPct - setupWidthPct}%; width: ${setupWidthPct}%; height: 60%; background: repeating-linear-gradient(45deg, #666, #666 2px, transparent 2px, transparent 6px); border-radius: 2px;" title="Setup: ${item.setup} min"></div>` : ''}
                <!-- Job bar -->
                <div style="position: absolute; left: ${leftPct}%; width: ${widthPct}%; height: 80%; background: ${groupColors[item.job.setupGroup]}; border-radius: 4px; display: flex; align-items: center; padding: 0 8px; color: white; font-size: 11px; cursor: grab; box-shadow: ${isLate ? '0 0 0 2px #e74c3c' : 'none'};" title="${item.job.name}: ${item.startTime}-${item.endTime} min${isLate ? ' (LATE)' : ''}">
                    ${item.job.name}
                </div>
                <!-- Due date marker -->
                <div style="position: absolute; left: ${duePct}%; width: 2px; height: 100%; background: ${isLate ? '#e74c3c' : '#4a9f6e'};" title="Due: ${item.job.dueDate}"></div>
            </div>
        `;
    });

    html += `</div>`;

    // Legend
    html += `<div style="display: flex; gap: 16px; margin-top: 16px; font-size: 11px; flex-wrap: wrap;">`;
    groups.forEach(g => {
        html += `<span style="display: flex; align-items: center; gap: 4px;"><span style="width: 12px; height: 12px; background: ${groupColors[g]}; border-radius: 2px;"></span>${g}</span>`;
    });
    html += `<span style="display: flex; align-items: center; gap: 4px;"><span style="width: 12px; height: 12px; background: repeating-linear-gradient(45deg, #666, #666 2px, transparent 2px, transparent 4px);"></span>Setup</span>`;
    html += `</div>`;

    container.innerHTML = html;
}

function handleJobDragStart(event, idx) {
    draggedJobIdx = idx;
    event.dataTransfer.effectAllowed = 'move';
}

function handleJobDragOver(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
}

function handleJobDrop(event, targetIdx) {
    event.preventDefault();
    if (draggedJobIdx === null || draggedJobIdx === targetIdx) return;

    // Reorder
    const item = sequencerOrder.splice(draggedJobIdx, 1)[0];
    sequencerOrder.splice(targetIdx, 0, item);
    renderSequencerGantt();
}

function handleJobDragEnd() {
    draggedJobIdx = null;
}

function pullJobsFromLineSim() {
    if (typeof lineOrders !== 'undefined' && lineOrders.length > 0) {
        sequencerJobs = lineOrders.map((o, i) => ({
            id: i + 1,
            name: `Order ${o.id || i + 1}`,
            processTime: o.quantity * 5, // Rough estimate
            dueDate: o.dueTime || 300,
            setupGroup: o.product || 'A'
        }));
        sequencerOrder = sequencerJobs.map((_, i) => i);
        renderSequencerJobs();
        showToast('Pulled orders from Line Simulator');
    } else {
        showToast('No orders in Line Simulator');
    }
}

function pushSequenceToLineSim() {
    // Convert sequencer jobs to line sim orders
    const products = [...new Set(sequencerJobs.map(j => j.setupGroup))];
    // Ensure products exist
    if (typeof lineProducts !== 'undefined') {
        products.forEach((p, i) => {
            if (!lineProducts.find(lp => lp.id === p)) {
                lineProducts.push({ id: p, name: `Product ${p}`, color: `hsl(${i * 137 % 360}, 60%, 50%)`, ctMultiplier: 1.0 });
            }
        });
    }

    // Create orders
    if (typeof lineOrders !== 'undefined') {
        lineOrders = sequencerOrder.map((idx, i) => {
            const job = sequencerJobs[idx];
            return {
                id: i + 1,
                product: job.setupGroup,
                quantity: Math.ceil(job.processTime / 5), // Convert back
                dueTime: job.dueDate
            };
        });
    }

    showCalc('line-sim');
    setTimeout(() => {
        if (typeof renderProducts === 'function') renderProducts();
        if (typeof renderOrders === 'function') renderOrders();
        if (typeof initLineSim === 'function') initLineSim();
    }, 100);
    showToast('Pushed sequence to Line Simulator');
}

// ============================================================================
// Sequence Optimizer
// ============================================================================

let optimizerJobs = [];
let optimizedOrder = [];

function pullFromSequencer() {
    optimizerJobs = JSON.parse(JSON.stringify(sequencerJobs));
    optimizedOrder = [...sequencerOrder];
    runSequenceOptimizer();
    showToast('Pulled from Job Sequencer');
}

function calcOrderMetrics(jobs, order) {
    if (jobs.length === 0) return { makespan: 0, flowTime: 0, setup: 0, tardiness: 0 };

    let currentTime = 0;
    let totalFlowTime = 0;
    let totalSetup = 0;
    let totalTardiness = 0;
    let prevGroup = null;

    order.forEach(idx => {
        const job = jobs[idx];
        if (!job) return;

        const setup = prevGroup ? getSetupTime(prevGroup, job.setupGroup) : 0;
        totalSetup += setup;

        currentTime += setup + job.processTime;
        totalFlowTime += currentTime;

        if (currentTime > job.dueDate) {
            totalTardiness += (currentTime - job.dueDate);
        }

        prevGroup = job.setupGroup;
    });

    return {
        makespan: currentTime,
        flowTime: totalFlowTime,
        avgFlowTime: jobs.length > 0 ? totalFlowTime / jobs.length : 0,
        setup: totalSetup,
        tardiness: totalTardiness
    };
}

function runSequenceOptimizer() {
    if (optimizerJobs.length === 0) {
        optimizerJobs = JSON.parse(JSON.stringify(sequencerJobs));
        optimizedOrder = [...sequencerOrder];
    }

    const objective = document.getElementById('opt-objective')?.value || 'setup';
    const algorithm = document.getElementById('opt-algorithm')?.value || 'nearest';

    // Calculate current metrics
    const currentMetrics = calcOrderMetrics(optimizerJobs, optimizedOrder);

    // Run optimization
    let newOrder;
    switch (algorithm) {
        case 'edd':
            newOrder = [...optimizedOrder].sort((a, b) => optimizerJobs[a].dueDate - optimizerJobs[b].dueDate);
            break;
        case 'spt':
            newOrder = [...optimizedOrder].sort((a, b) => optimizerJobs[a].processTime - optimizerJobs[b].processTime);
            break;
        case 'nearest':
            newOrder = nearestNeighborSequence(optimizerJobs, objective);
            break;
        case '2opt':
            newOrder = twoOptImprove(optimizerJobs, nearestNeighborSequence(optimizerJobs, objective), objective);
            break;
        default:
            newOrder = [...optimizedOrder];
    }

    const newMetrics = calcOrderMetrics(optimizerJobs, newOrder);

    // Update display
    document.getElementById('opt-current-seq').textContent = optimizedOrder.map(i => optimizerJobs[i]?.name || '?').join(' → ');
    document.getElementById('opt-current-setup').textContent = currentMetrics.setup + ' min';
    document.getElementById('opt-current-tard').textContent = currentMetrics.tardiness + ' min';
    document.getElementById('opt-current-make').textContent = currentMetrics.makespan + ' min';
    document.getElementById('opt-current-flow').textContent = currentMetrics.avgFlowTime.toFixed(0) + ' min';

    document.getElementById('opt-new-seq').textContent = newOrder.map(i => optimizerJobs[i]?.name || '?').join(' → ');
    document.getElementById('opt-new-setup').textContent = newMetrics.setup + ' min';
    document.getElementById('opt-new-tard').textContent = newMetrics.tardiness + ' min';
    document.getElementById('opt-new-make').textContent = newMetrics.makespan + ' min';
    document.getElementById('opt-new-flow').textContent = newMetrics.avgFlowTime.toFixed(0) + ' min';

    // Improvement summary
    let improvement = '';
    switch (objective) {
        case 'setup':
            const setupSaved = currentMetrics.setup - newMetrics.setup;
            improvement = setupSaved > 0 ? `<span style="color: #4a9f6e;">${setupSaved} min setup saved (${((setupSaved/currentMetrics.setup)*100).toFixed(0)}% reduction)</span>` : 'Already optimal for setup';
            break;
        case 'tardiness':
            const tardSaved = currentMetrics.tardiness - newMetrics.tardiness;
            improvement = tardSaved > 0 ? `<span style="color: #4a9f6e;">${tardSaved} min tardiness reduced</span>` : 'Already optimal for tardiness';
            break;
        case 'makespan':
            const makeSaved = currentMetrics.makespan - newMetrics.makespan;
            improvement = makeSaved > 0 ? `<span style="color: #4a9f6e;">${makeSaved} min makespan reduced</span>` : 'Already optimal for makespan';
            break;
        case 'flowtime':
            const flowSaved = currentMetrics.avgFlowTime - newMetrics.avgFlowTime;
            improvement = flowSaved > 0 ? `<span style="color: #4a9f6e;">${flowSaved.toFixed(0)} min avg flow time reduced</span>` : 'Already optimal for flow time';
            break;
    }
    document.getElementById('opt-improvement').innerHTML = improvement;

    optimizedOrder = newOrder;
}

function nearestNeighborSequence(jobs, objective) {
    if (jobs.length === 0) return [];

    const remaining = jobs.map((_, i) => i);
    const result = [];
    let prevGroup = null;

    while (remaining.length > 0) {
        let bestIdx = 0;
        let bestScore = Infinity;

        remaining.forEach((jobIdx, i) => {
            const job = jobs[jobIdx];
            let score;
            switch (objective) {
                case 'setup':
                    score = prevGroup ? getSetupTime(prevGroup, job.setupGroup) : 0;
                    break;
                case 'tardiness':
                case 'edd':
                    score = job.dueDate;
                    break;
                case 'spt':
                case 'flowtime':
                    score = job.processTime;
                    break;
                default:
                    score = prevGroup ? getSetupTime(prevGroup, job.setupGroup) : 0;
            }
            if (score < bestScore) {
                bestScore = score;
                bestIdx = i;
            }
        });

        const chosen = remaining.splice(bestIdx, 1)[0];
        result.push(chosen);
        prevGroup = jobs[chosen].setupGroup;
    }

    return result;
}

function twoOptImprove(jobs, order, objective) {
    let improved = true;
    let best = [...order];
    let bestScore = getObjectiveScore(jobs, best, objective);

    while (improved) {
        improved = false;
        for (let i = 0; i < best.length - 1; i++) {
            for (let j = i + 1; j < best.length; j++) {
                const newOrder = [...best];
                // Reverse segment between i and j
                const segment = newOrder.splice(i, j - i + 1).reverse();
                newOrder.splice(i, 0, ...segment);

                const score = getObjectiveScore(jobs, newOrder, objective);
                if (score < bestScore) {
                    best = newOrder;
                    bestScore = score;
                    improved = true;
                }
            }
        }
    }
    return best;
}

function getObjectiveScore(jobs, order, objective) {
    const m = calcOrderMetrics(jobs, order);
    switch (objective) {
        case 'setup': return m.setup;
        case 'tardiness': return m.tardiness;
        case 'makespan': return m.makespan;
        case 'flowtime': return m.avgFlowTime;
        default: return m.setup;
    }
}

function applyOptimizedSequence() {
    sequencerJobs = JSON.parse(JSON.stringify(optimizerJobs));
    sequencerOrder = [...optimizedOrder];
    showCalc('sequencer');
    setTimeout(() => renderSequencerJobs(), 100);
    showToast('Applied optimized sequence');
}

// ============================================================================
// Capacity Load Chart
// ============================================================================

let capacityOrders = [
    { id: 1, name: 'WO-001', hours: 6, startDay: 1 },
    { id: 2, name: 'WO-002', hours: 8, startDay: 1 },
    { id: 3, name: 'WO-003', hours: 4, startDay: 2 },
    { id: 4, name: 'WO-004', hours: 10, startDay: 3 },
    { id: 5, name: 'WO-005', hours: 5, startDay: 4 },
];

function renderCapacityOrders() {
    const container = document.getElementById('capacity-orders');
    if (!container) return;

    container.innerHTML = capacityOrders.map((order, i) => `
        <div class="yamazumi-station" style="gap: 8px;">
            <input type="text" value="${order.name}" style="flex: 1; padding: 8px;"
                   oninput="updateCapacityOrder(${i}, 'name', this.value)" placeholder="Work Order">
            <input type="number" value="${order.hours}" style="width: 60px; text-align: right;"
                   oninput="updateCapacityOrder(${i}, 'hours', this.value)" title="Hours required">
            <span style="color: var(--text-dim); font-size: 11px;">hrs</span>
            <input type="number" value="${order.startDay}" style="width: 50px; text-align: right;"
                   oninput="updateCapacityOrder(${i}, 'startDay', this.value)" title="Start day" min="1">
            <span style="color: var(--text-dim); font-size: 11px;">day</span>
            <button class="yamazumi-station-remove" onclick="removeCapacityOrder(${i})">&times;</button>
        </div>
    `).join('');

    calcCapacityLoad();
}

function addCapacityOrder() {
    const id = capacityOrders.length > 0 ? Math.max(...capacityOrders.map(o => o.id)) + 1 : 1;
    capacityOrders.push({ id, name: `WO-${String(id).padStart(3, '0')}`, hours: 4, startDay: 1 });
    renderCapacityOrders();
}

function removeCapacityOrder(idx) {
    capacityOrders.splice(idx, 1);
    renderCapacityOrders();
}

function updateCapacityOrder(idx, field, value) {
    if (field === 'hours' || field === 'startDay') value = parseFloat(value) || 1;
    capacityOrders[idx][field] = value;
    calcCapacityLoad();
}

function loadSampleWorkOrders() {
    capacityOrders = [
        { id: 1, name: 'WO-101', hours: 6, startDay: 1 },
        { id: 2, name: 'WO-102', hours: 8, startDay: 1 },
        { id: 3, name: 'WO-103', hours: 7, startDay: 2 },
        { id: 4, name: 'WO-104', hours: 10, startDay: 2 },
        { id: 5, name: 'WO-105', hours: 5, startDay: 3 },
        { id: 6, name: 'WO-106', hours: 6, startDay: 4 },
        { id: 7, name: 'WO-107', hours: 9, startDay: 5 },
        { id: 8, name: 'WO-108', hours: 4, startDay: 6 },
    ];
    renderCapacityOrders();
}

function pullFromSequencerToCapacity() {
    capacityOrders = sequencerJobs.map((job, i) => ({
        id: i + 1,
        name: job.name,
        hours: job.processTime / 60, // Convert minutes to hours
        startDay: Math.ceil((job.dueDate / 60) / 8) // Rough estimate
    }));
    renderCapacityOrders();
    showToast('Pulled from Job Sequencer');
}

function calcCapacityLoad() {
    const hoursPerDay = parseFloat(document.getElementById('cap-hours-day')?.value) || 8;
    const daysToShow = parseInt(document.getElementById('cap-days')?.value) || 10;
    const efficiency = (parseFloat(document.getElementById('cap-efficiency')?.value) || 85) / 100;

    const effectiveHours = hoursPerDay * efficiency;

    // Calculate load per day
    const loadByDay = {};
    for (let d = 1; d <= daysToShow; d++) {
        loadByDay[d] = { orders: [], total: 0 };
    }

    capacityOrders.forEach(order => {
        let remaining = order.hours;
        let day = order.startDay;

        while (remaining > 0 && day <= daysToShow) {
            if (!loadByDay[day]) loadByDay[day] = { orders: [], total: 0 };

            const available = effectiveHours - loadByDay[day].total;
            const allocated = Math.min(remaining, available > 0 ? available : remaining);

            loadByDay[day].orders.push({ name: order.name, hours: allocated });
            loadByDay[day].total += allocated;
            remaining -= allocated;
            day++;
        }
    });

    // Calculate totals
    const totalLoad = capacityOrders.reduce((sum, o) => sum + o.hours, 0);
    const totalCapacity = daysToShow * effectiveHours;
    const utilization = totalCapacity > 0 ? (totalLoad / totalCapacity) * 100 : 0;
    const overloadDays = Object.values(loadByDay).filter(d => d.total > effectiveHours).length;

    document.getElementById('cap-total-load').innerHTML = `${totalLoad.toFixed(1)}<span class="calc-result-unit">hrs</span>`;
    document.getElementById('cap-available').innerHTML = `${totalCapacity.toFixed(1)}<span class="calc-result-unit">hrs</span>`;
    document.getElementById('cap-utilization').innerHTML = `${utilization.toFixed(0)}<span class="calc-result-unit">%</span>`;
    document.getElementById('cap-overload-days').textContent = overloadDays;

    // Update derivation
    document.getElementById('capacity-load-derivation-body').innerHTML = `
        <div class="step">
            <div class="step-num">Step 1: Effective Daily Capacity</div>
            <span class="formula">Effective = Hours/Day × Efficiency %</span><br>
            = ${hoursPerDay} × ${(efficiency * 100).toFixed(0)}% = <strong>${effectiveHours.toFixed(1)} hrs/day</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 2: Total Available Capacity</div>
            <span class="formula">Total Capacity = Effective Hours × Days</span><br>
            = ${effectiveHours.toFixed(1)} × ${daysToShow} = <strong>${totalCapacity.toFixed(1)} hrs</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 3: Total Load</div>
            Total from ${capacityOrders.length} work orders = <strong>${totalLoad.toFixed(1)} hrs</strong>
        </div>
        <div class="step">
            <div class="step-num">Step 4: Utilization</div>
            <span class="formula">Utilization = Total Load ÷ Total Capacity × 100</span><br>
            = ${totalLoad.toFixed(1)} ÷ ${totalCapacity.toFixed(1)} × 100 = <strong>${utilization.toFixed(0)}%</strong>
            ${overloadDays > 0 ? '<br><span style="color:#e74c3c;">⚠ ' + overloadDays + ' day(s) exceed capacity</span>' : ''}
        </div>
    `;

    // Chart
    const days = [];
    const loads = [];
    const colors = [];

    for (let d = 1; d <= daysToShow; d++) {
        days.push(`Day ${d}`);
        loads.push(loadByDay[d]?.total || 0);
        colors.push((loadByDay[d]?.total || 0) > effectiveHours ? '#e74c3c' : '#4a9f6e');
    }

    Plotly.newPlot('capacity-chart', [
        {
            x: days,
            y: loads,
            type: 'bar',
            marker: { color: colors },
            text: loads.map(l => l.toFixed(1) + 'h'),
            textposition: 'outside',
            hovertemplate: '%{x}: %{y:.1f}h<extra></extra>'
        },
        {
            x: days,
            y: Array(daysToShow).fill(effectiveHours),
            type: 'scatter',
            mode: 'lines',
            name: 'Capacity',
            line: { color: '#e8c547', dash: 'dash', width: 2 }
        }
    ], {
        margin: { t: 40, b: 60, l: 50, r: 20 },
        paper_bgcolor: 'transparent',
        plot_bgcolor: 'transparent',
        xaxis: { tickfont: { size: 11, color: '#a0a0a0' }, gridcolor: 'rgba(150,150,150,0.1)' },
        yaxis: { title: 'Hours', titlefont: { size: 12, color: '#a0a0a0' }, tickfont: { size: 11, color: '#a0a0a0' }, gridcolor: 'rgba(150,150,150,0.1)' },
        showlegend: false
    }, { responsive: true, displayModeBar: false });
}

// ============================================================================
// Mixed-Model Sequencer
// ============================================================================

let mixedProducts = [
    { id: 'A', name: 'Product A', quantity: 10, color: '#4a9f6e' },
    { id: 'B', name: 'Product B', quantity: 6, color: '#3498db' },
    { id: 'C', name: 'Product C', quantity: 4, color: '#e8c547' },
];

function renderMixedProducts() {
    const container = document.getElementById('mixed-products');
    if (!container) return;

    container.innerHTML = mixedProducts.map((p, i) => `
        <div class="yamazumi-station" style="gap: 8px;">
            <input type="text" value="${p.id}" style="width: 40px; text-align: center; padding: 8px;"
                   oninput="updateMixedProduct(${i}, 'id', this.value)" placeholder="ID">
            <input type="text" value="${p.name}" style="flex: 1; padding: 8px;"
                   oninput="updateMixedProduct(${i}, 'name', this.value)" placeholder="Name">
            <input type="number" value="${p.quantity}" style="width: 60px; text-align: right;"
                   oninput="updateMixedProduct(${i}, 'quantity', this.value)" title="Quantity" min="1">
            <span style="color: var(--text-dim); font-size: 11px;">units</span>
            <input type="color" value="${p.color}" style="width: 30px; height: 30px; border: none; cursor: pointer;"
                   oninput="updateMixedProduct(${i}, 'color', this.value)">
            <button class="yamazumi-station-remove" onclick="removeMixedProduct(${i})">&times;</button>
        </div>
    `).join('');

    calcMixedModel();
}

function addMixedProduct() {
    const id = String.fromCharCode(65 + mixedProducts.length);
    const hue = (mixedProducts.length * 137) % 360;
    mixedProducts.push({ id, name: `Product ${id}`, quantity: 5, color: `hsl(${hue}, 60%, 50%)` });
    renderMixedProducts();
}

function removeMixedProduct(idx) {
    mixedProducts.splice(idx, 1);
    renderMixedProducts();
}

function updateMixedProduct(idx, field, value) {
    if (field === 'quantity') value = parseInt(value) || 1;
    mixedProducts[idx][field] = value;
    calcMixedModel();
}

function pullFromHeijunka() {
    if (typeof heijunkaData !== 'undefined' && heijunkaData.length > 0) {
        mixedProducts = heijunkaData.map((h, i) => ({
            id: h.product,
            name: h.product,
            quantity: h.daily,
            color: `hsl(${i * 137 % 360}, 60%, 50%)`
        }));
        renderMixedProducts();
        showToast('Pulled from Heijunka');
    }
}

function calcMixedModel() {
    const method = document.querySelector('input[name="mix-method"]:checked')?.value || 'ratio';
    const container = document.getElementById('mixed-sequence');

    const totalQty = mixedProducts.reduce((sum, p) => sum + p.quantity, 0);

    let sequence = [];

    if (method === 'batch') {
        // Simple batched sequence
        mixedProducts.forEach(p => {
            for (let i = 0; i < p.quantity; i++) {
                sequence.push(p);
            }
        });
    } else if (method === 'ratio' || method === 'smooth') {
        // Goal chasing / ratio-based leveling
        const targets = mixedProducts.map(p => ({ ...p, target: 0, actual: 0 }));

        for (let i = 0; i < totalQty; i++) {
            // Update targets
            const progress = (i + 1) / totalQty;
            targets.forEach(t => {
                t.target = progress * t.quantity;
            });

            // Find product most behind target
            let bestIdx = 0;
            let maxDiff = -Infinity;
            targets.forEach((t, idx) => {
                const diff = t.target - t.actual;
                if (diff > maxDiff) {
                    maxDiff = diff;
                    bestIdx = idx;
                }
            });

            sequence.push(mixedProducts[bestIdx]);
            targets[bestIdx].actual++;
        }
    }

    // Render sequence
    if (container) {
        container.innerHTML = sequence.map(p => `
            <div style="width: 24px; height: 24px; background: ${p.color}; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; color: white;" title="${p.name}">${p.id}</div>
        `).join('');
    }

    // Calculate metrics
    let maxConsec = 1;
    let currentConsec = 1;
    for (let i = 1; i < sequence.length; i++) {
        if (sequence[i].id === sequence[i-1].id) {
            currentConsec++;
            maxConsec = Math.max(maxConsec, currentConsec);
        } else {
            currentConsec = 1;
        }
    }

    // Smoothness index (lower is better)
    let smoothness = 0;
    mixedProducts.forEach(p => {
        const idealGap = totalQty / p.quantity;
        const positions = sequence.map((s, i) => s.id === p.id ? i : -1).filter(i => i >= 0);
        for (let i = 1; i < positions.length; i++) {
            const gap = positions[i] - positions[i-1];
            smoothness += Math.abs(gap - idealGap);
        }
    });

    document.getElementById('mixed-length').textContent = `${totalQty} units`;
    document.getElementById('mixed-max-consec').textContent = maxConsec;
    document.getElementById('mixed-smoothness').textContent = smoothness.toFixed(1) + (method === 'batch' ? ' (batched)' : '');

    // Comparison chart
    const batchSeq = [];
    mixedProducts.forEach(p => {
        for (let i = 0; i < p.quantity; i++) batchSeq.push(p);
    });

    const leveledCumulative = {};
    const batchedCumulative = {};
    mixedProducts.forEach(p => {
        leveledCumulative[p.id] = [];
        batchedCumulative[p.id] = [];
    });

    let leveledCounts = {};
    let batchedCounts = {};
    mixedProducts.forEach(p => { leveledCounts[p.id] = 0; batchedCounts[p.id] = 0; });

    for (let i = 0; i < totalQty; i++) {
        leveledCounts[sequence[i].id]++;
        batchedCounts[batchSeq[i].id]++;
        mixedProducts.forEach(p => {
            leveledCumulative[p.id].push(leveledCounts[p.id]);
            batchedCumulative[p.id].push(batchedCounts[p.id]);
        });
    }

    const traces = [];
    mixedProducts.forEach(p => {
        traces.push({
            x: Array.from({ length: totalQty }, (_, i) => i + 1),
            y: leveledCumulative[p.id],
            type: 'scatter',
            mode: 'lines',
            name: `${p.id} (leveled)`,
            line: { color: p.color, width: 2 }
        });
        traces.push({
            x: Array.from({ length: totalQty }, (_, i) => i + 1),
            y: batchedCumulative[p.id],
            type: 'scatter',
            mode: 'lines',
            name: `${p.id} (batched)`,
            line: { color: p.color, width: 1, dash: 'dot' }
        });
    });

    Plotly.newPlot('mixed-chart', traces, {
        margin: { t: 20, b: 50, l: 50, r: 20 },
        paper_bgcolor: 'transparent',
        plot_bgcolor: 'transparent',
        xaxis: { title: 'Sequence Position', titlefont: { size: 11, color: '#a0a0a0' }, tickfont: { size: 10, color: '#a0a0a0' }, gridcolor: 'rgba(150,150,150,0.1)' },
        yaxis: { title: 'Cumulative Count', titlefont: { size: 11, color: '#a0a0a0' }, tickfont: { size: 10, color: '#a0a0a0' }, gridcolor: 'rgba(150,150,150,0.1)' },
        legend: { orientation: 'h', y: -0.2, font: { size: 10, color: '#a0a0a0' } }
    }, { responsive: true, displayModeBar: false });
}

function pushMixedToLineSim() {
    const method = document.querySelector('input[name="mix-method"]:checked')?.value || 'ratio';

    // Generate sequence
    const totalQty = mixedProducts.reduce((sum, p) => sum + p.quantity, 0);
    const sequence = [];
    const targets = mixedProducts.map(p => ({ ...p, target: 0, actual: 0 }));

    for (let i = 0; i < totalQty; i++) {
        const progress = (i + 1) / totalQty;
        targets.forEach(t => { t.target = progress * t.quantity; });

        let bestIdx = 0;
        let maxDiff = -Infinity;
        targets.forEach((t, idx) => {
            const diff = t.target - t.actual;
            if (diff > maxDiff) { maxDiff = diff; bestIdx = idx; }
        });

        sequence.push(mixedProducts[bestIdx]);
        targets[bestIdx].actual++;
    }

    // Create products and orders in Line Sim
    if (typeof lineProducts !== 'undefined') {
        lineProducts = mixedProducts.map(p => ({
            id: p.id,
            name: p.name,
            color: p.color,
            ctMultiplier: 1.0
        }));
    }

    // Group consecutive same products into orders
    if (typeof lineOrders !== 'undefined') {
        lineOrders = [];
        let current = null;
        let count = 0;
        let orderId = 1;

        sequence.forEach((p, i) => {
            if (current === p.id) {
                count++;
            } else {
                if (current !== null) {
                    lineOrders.push({ id: orderId++, product: current, quantity: count, dueTime: 600 });
                }
                current = p.id;
                count = 1;
            }
        });
        if (current !== null) {
            lineOrders.push({ id: orderId, product: current, quantity: count, dueTime: 600 });
        }
    }

    showCalc('line-sim');
    setTimeout(() => {
        if (typeof renderProducts === 'function') renderProducts();
        if (typeof renderOrders === 'function') renderOrders();
        if (typeof updateSimMode === 'function') {
            document.getElementById('ls-sim-mode').value = 'orders';
            updateSimMode();
        }
        if (typeof initLineSim === 'function') initLineSim();
    }, 100);
    showToast('Pushed leveled sequence to Line Simulator');
}

// ============================================================================
// Due Date Risk Simulator
// ============================================================================

let ddsOrders = [
    { id: 1, name: 'Order A', processTime: 120, dueDate: 480 },
    { id: 2, name: 'Order B', processTime: 90, dueDate: 360 },
    { id: 3, name: 'Order C', processTime: 150, dueDate: 600 },
];

function renderDDSOrders() {
    const container = document.getElementById('dds-orders');
    if (!container) return;

    container.innerHTML = ddsOrders.map((order, i) => `
        <div class="yamazumi-station" style="gap: 8px;">
            <input type="text" value="${order.name}" style="flex: 1; padding: 8px;"
                   oninput="updateDDSOrder(${i}, 'name', this.value)" placeholder="Order name">
            <input type="number" value="${order.processTime}" style="width: 70px; text-align: right;"
                   oninput="updateDDSOrder(${i}, 'processTime', this.value)" title="Process time (min)">
            <span style="color: var(--text-dim); font-size: 11px;">min</span>
            <input type="number" value="${order.dueDate}" style="width: 80px; text-align: right;"
                   oninput="updateDDSOrder(${i}, 'dueDate', this.value)" title="Due date (min from now)">
            <span style="color: var(--text-dim); font-size: 11px;">due</span>
            <button class="yamazumi-station-remove" onclick="removeDDSOrder(${i})">&times;</button>
        </div>
    `).join('');
}

function addDDSOrder() {
    const id = ddsOrders.length > 0 ? Math.max(...ddsOrders.map(o => o.id)) + 1 : 1;
    ddsOrders.push({ id, name: `Order ${String.fromCharCode(64 + id)}`, processTime: 60, dueDate: 480 });
    renderDDSOrders();
}

function removeDDSOrder(idx) {
    ddsOrders.splice(idx, 1);
    renderDDSOrders();
}

function updateDDSOrder(idx, field, value) {
    if (field === 'processTime' || field === 'dueDate') value = parseFloat(value) || 0;
    ddsOrders[idx][field] = value;
}

function loadSampleDDSOrders() {
    ddsOrders = [
        { id: 1, name: 'Rush Order', processTime: 60, dueDate: 180 },
        { id: 2, name: 'Standard A', processTime: 120, dueDate: 480 },
        { id: 3, name: 'Standard B', processTime: 90, dueDate: 400 },
        { id: 4, name: 'Large Job', processTime: 200, dueDate: 720 },
        { id: 5, name: 'Quick Turn', processTime: 45, dueDate: 300 },
    ];
    renderDDSOrders();
}

function pullFromSequencerToDDS() {
    ddsOrders = sequencerJobs.map((job, i) => ({
        id: i + 1,
        name: job.name,
        processTime: job.processTime,
        dueDate: job.dueDate
    }));
    renderDDSOrders();
    showToast('Pulled from Job Sequencer');
}

function runDueDateSim() {
    if (ddsOrders.length === 0) return;

    const cv = parseFloat(document.getElementById('dds-cv')?.value) || 0.15;
    const breakdownProb = (parseFloat(document.getElementById('dds-breakdown')?.value) || 5) / 100;
    const breakdownDur = parseFloat(document.getElementById('dds-breakdown-dur')?.value) || 60;
    const runs = parseInt(document.getElementById('dds-runs')?.value) || 500;

    // Results storage
    const completionTimes = ddsOrders.map(() => []);
    let totalOnTime = 0;

    // Monte Carlo simulation
    for (let run = 0; run < runs; run++) {
        let currentTime = 0;
        let runOnTime = true;

        ddsOrders.forEach((order, i) => {
            // Process time with variation
            const stdDev = order.processTime * cv;
            const actualProcess = Math.max(1, order.processTime + gaussianRandom() * stdDev);

            // Random breakdown
            const hasBreakdown = Math.random() < breakdownProb;
            const breakdownTime = hasBreakdown ? breakdownDur * (0.5 + Math.random()) : 0;

            currentTime += actualProcess + breakdownTime;
            completionTimes[i].push(currentTime);

            if (currentTime > order.dueDate) {
                runOnTime = false;
            }
        });

        if (runOnTime) totalOnTime++;
    }

    // Calculate statistics
    const overallOTD = (totalOnTime / runs) * 100;

    const orderResults = ddsOrders.map((order, i) => {
        const times = completionTimes[i].sort((a, b) => a - b);
        const mean = times.reduce((a, b) => a + b, 0) / times.length;
        const p50 = times[Math.floor(times.length * 0.5)];
        const p95 = times[Math.floor(times.length * 0.95)];
        const onTimeCount = times.filter(t => t <= order.dueDate).length;
        const onTimePct = (onTimeCount / runs) * 100;
        const avgDelta = mean - order.dueDate;

        return {
            name: order.name,
            dueDate: order.dueDate,
            mean,
            p50,
            p95,
            onTimePct,
            avgDelta
        };
    });

    // Update display
    const otdColor = overallOTD >= 95 ? '#4a9f6e' : overallOTD >= 80 ? '#e8c547' : '#e74c3c';
    document.getElementById('dds-otd').innerHTML = `<span style="color: ${otdColor}">${overallOTD.toFixed(1)}</span><span class="calc-result-unit">%</span>`;

    const avgDeltaAll = orderResults.reduce((sum, r) => sum + r.avgDelta, 0) / orderResults.length;
    document.getElementById('dds-avg-delta').innerHTML = avgDeltaAll > 0 ?
        `<span style="color: #e74c3c;">${avgDeltaAll.toFixed(0)} min late</span>` :
        `<span style="color: #4a9f6e;">${Math.abs(avgDeltaAll).toFixed(0)} min early</span>`;

    const worstP95 = Math.max(...orderResults.map(r => r.p95 - r.dueDate));
    document.getElementById('dds-worst').innerHTML = worstP95 > 0 ?
        `<span style="color: #e74c3c;">${worstP95.toFixed(0)} min late</span>` :
        `<span style="color: #4a9f6e;">All on time</span>`;

    // Per-order results
    const resultsContainer = document.getElementById('dds-order-results');
    resultsContainer.innerHTML = orderResults.map(r => {
        const riskColor = r.onTimePct >= 95 ? '#4a9f6e' : r.onTimePct >= 80 ? '#e8c547' : '#e74c3c';
        return `
            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid ${riskColor};">
                <div style="flex: 1;">
                    <div style="font-weight: 500;">${r.name}</div>
                    <div style="font-size: 11px; color: var(--text-dim);">Due: ${r.dueDate} min | Avg: ${r.mean.toFixed(0)} min</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 18px; font-weight: 600; color: ${riskColor};">${r.onTimePct.toFixed(0)}%</div>
                    <div style="font-size: 10px; color: var(--text-dim);">on-time</div>
                </div>
            </div>
        `;
    }).join('');

    // Histogram of final order completion
    const finalTimes = completionTimes[completionTimes.length - 1];
    const minT = Math.min(...finalTimes);
    const maxT = Math.max(...finalTimes);
    const binCount = 20;
    const binWidth = (maxT - minT) / binCount;
    const bins = Array(binCount).fill(0);
    const binLabels = [];

    for (let i = 0; i < binCount; i++) {
        binLabels.push(Math.round(minT + i * binWidth));
    }

    finalTimes.forEach(t => {
        const bin = Math.min(binCount - 1, Math.floor((t - minT) / binWidth));
        bins[bin]++;
    });

    const lastDue = ddsOrders[ddsOrders.length - 1].dueDate;

    Plotly.newPlot('dds-chart', [
        {
            x: binLabels,
            y: bins,
            type: 'bar',
            marker: {
                color: binLabels.map(t => t <= lastDue ? '#4a9f6e' : '#e74c3c')
            },
            hovertemplate: '%{x} min: %{y} runs<extra></extra>'
        }
    ], {
        margin: { t: 20, b: 50, l: 50, r: 20 },
        paper_bgcolor: 'transparent',
        plot_bgcolor: 'transparent',
        xaxis: { title: 'Completion Time (min)', titlefont: { size: 11, color: '#a0a0a0' }, tickfont: { size: 10, color: '#a0a0a0' }, gridcolor: 'rgba(150,150,150,0.1)' },
        yaxis: { title: 'Frequency', titlefont: { size: 11, color: '#a0a0a0' }, tickfont: { size: 10, color: '#a0a0a0' }, gridcolor: 'rgba(150,150,150,0.1)' },
        shapes: [{
            type: 'line',
            x0: lastDue, x1: lastDue,
            y0: 0, y1: Math.max(...bins),
            line: { color: '#e8c547', width: 2, dash: 'dash' }
        }],
        annotations: [{
            x: lastDue, y: Math.max(...bins),
            text: 'Due',
            showarrow: false,
            font: { size: 10, color: '#e8c547' },
            yshift: 10
        }]
    }, { responsive: true, displayModeBar: false });
}

// Gaussian random using Box-Muller
function gaussianRandom() {
    let u = 0, v = 0;
    while (u === 0) u = Math.random();
    while (v === 0) v = Math.random();
    return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
}

// ============================================================================
// House of Quality (QFD)
// ============================================================================

let qfdCurrentPhase = 1;

// Phase 1 data
let qfdWhats = [
    { name: 'Easy to use', importance: 5 },
    { name: 'Durable', importance: 4 },
    { name: 'Lightweight', importance: 3 },
];

let qfdHows = [
    { name: 'Material strength', unit: 'MPa', target: '' },
    { name: 'Weight', unit: 'kg', target: '' },
    { name: 'Ergonomic score', unit: '1-10', target: '' },
];

let qfdRelationships = {}; // { 'what_idx-how_idx': strength (0,1,3,9) }
let qfdCorrelations = {}; // { 'how1_idx-how2_idx': correlation (++,+,0,-,--) }
let qfdWhatCorrelations = {}; // { 'what1_idx-what2_idx': '0', '?', '!' }

// Phase 2-4 data
let qfdParts = [];
let qfdProcesses = [];
let qfdControls = [];
let qfdMatrix2 = {};
let qfdMatrix3 = {};
let qfdMatrix4 = {};

function setQFDPhase(phase) {
    qfdCurrentPhase = phase;

    // Update tabs
    for (let i = 1; i <= 4; i++) {
        const tab = document.getElementById(`qfd-tab-${i}`);
        const panel = document.getElementById(`qfd-phase-${i}`);
        if (tab && panel) {
            if (i === phase) {
                tab.style.borderBottomColor = 'var(--accent)';
                tab.style.color = 'var(--accent)';
                tab.style.fontWeight = '600';
                panel.style.display = 'block';
            } else {
                tab.style.borderBottomColor = 'transparent';
                tab.style.color = 'var(--text-dim)';
                tab.style.fontWeight = 'normal';
                panel.style.display = 'none';
            }
        }
    }

    // Render appropriate matrix
    if (phase === 1) renderQFDMatrix();
    else if (phase === 2) renderQFDMatrix2();
    else if (phase === 3) renderQFDMatrix3();
    else if (phase === 4) renderQFDMatrix4();
}

function renderQFDWhats() {
    const container = document.getElementById('qfd-whats');
    if (!container) return;

    container.innerHTML = qfdWhats.map((w, i) => `
        <div class="yamazumi-station" style="gap: 8px;">
            <input type="text" value="${w.name}" style="flex: 1; padding: 8px;"
                   oninput="updateQFDWhat(${i}, 'name', this.value)" placeholder="Customer requirement">
            <input type="number" value="${w.importance}" min="1" max="5" style="width: 50px; text-align: center;"
                   oninput="updateQFDWhat(${i}, 'importance', this.value)" title="Importance (1-5)">
            <span style="color: var(--text-dim); font-size: 11px;">imp</span>
            <button class="yamazumi-station-remove" onclick="removeQFDWhat(${i})">&times;</button>
        </div>
    `).join('');

    renderQFDMatrix();
}

function renderQFDHows() {
    const container = document.getElementById('qfd-hows');
    if (!container) return;

    container.innerHTML = qfdHows.map((h, i) => `
        <div class="yamazumi-station" style="gap: 8px;">
            <input type="text" value="${h.name}" style="flex: 1; padding: 8px;"
                   oninput="updateQFDHow(${i}, 'name', this.value)" placeholder="Engineering characteristic">
            <input type="text" value="${h.unit}" style="width: 60px; text-align: center;"
                   oninput="updateQFDHow(${i}, 'unit', this.value)" placeholder="unit">
            <input type="text" value="${h.target}" style="width: 70px; text-align: center;"
                   oninput="updateQFDHow(${i}, 'target', this.value)" placeholder="target">
            <button class="yamazumi-station-remove" onclick="removeQFDHow(${i})">&times;</button>
        </div>
    `).join('');

    renderQFDMatrix();
}

function addQFDWhat() {
    qfdWhats.push({ name: 'New requirement', importance: 3 });
    renderQFDWhats();
}

function removeQFDWhat(idx) {
    qfdWhats.splice(idx, 1);
    // Clean up relationships
    Object.keys(qfdRelationships).forEach(key => {
        if (key.startsWith(`${idx}-`)) delete qfdRelationships[key];
    });
    renderQFDWhats();
}

function updateQFDWhat(idx, field, value) {
    if (field === 'importance') value = parseInt(value) || 3;
    qfdWhats[idx][field] = value;
    renderQFDMatrix();
}

function addQFDHow() {
    qfdHows.push({ name: 'New characteristic', unit: '', target: '' });
    renderQFDHows();
}

function removeQFDHow(idx) {
    qfdHows.splice(idx, 1);
    // Clean up relationships and correlations
    Object.keys(qfdRelationships).forEach(key => {
        if (key.endsWith(`-${idx}`)) delete qfdRelationships[key];
    });
    Object.keys(qfdCorrelations).forEach(key => {
        if (key.includes(`${idx}`)) delete qfdCorrelations[key];
    });
    renderQFDHows();
}

function updateQFDHow(idx, field, value) {
    qfdHows[idx][field] = value;
    renderQFDMatrix();
}

function updateQFDRelationship(whatIdx, howIdx, value) {
    const key = `${whatIdx}-${howIdx}`;
    qfdRelationships[key] = parseInt(value) || 0;
    renderQFDMatrix();
}

function updateQFDCorrelation(how1Idx, how2Idx, value) {
    const key = `${Math.min(how1Idx, how2Idx)}-${Math.max(how1Idx, how2Idx)}`;
    qfdCorrelations[key] = value;
    renderQFDMatrix();
}

function renderQFDMatrix() {
    const container = document.getElementById('qfd-matrix');
    if (!container) return;

    if (qfdWhats.length === 0 || qfdHows.length === 0) {
        container.innerHTML = '<div style="padding: 20px; color: var(--text-dim); text-align: center;">Add customer requirements and engineering characteristics to build the matrix</div>';
        return;
    }

    const howCount = qfdHows.length;
    const symbols = { 9: '●', 3: '○', 1: '△', 0: '' };
    const corrSymbols = { '++': '++', '+': '+', '0': '', '-': '−', '--': '−−' };
    const corrColors = { '++': '#4a9f6e', '+': '#7bc47f', '0': '#666', '-': '#e8a87c', '--': '#e74c3c' };

    let html = '<div style="position: relative;">';


    // Main matrix table
    html += '<table style="border-collapse: collapse; width: 100%;">';

    // Header row (HOWs)
    html += '<tr><th style="width: 150px; padding: 8px; background: var(--bg-card); border: 1px solid var(--border);"></th>';
    qfdHows.forEach((h, i) => {
        html += `<th style="padding: 8px; background: var(--bg-secondary); border: 1px solid var(--border); min-width: 50px; writing-mode: vertical-lr; text-orientation: mixed; height: 100px; font-size: 11px; font-weight: 500;">${h.name}</th>`;
    });
    html += '<th style="width: 60px; padding: 8px; background: var(--bg-card); border: 1px solid var(--border); font-size: 10px;">Weight</th></tr>';

    // Data rows (WHATs)
    qfdWhats.forEach((w, wi) => {
        html += '<tr>';
        html += `<td style="padding: 8px; background: var(--bg-secondary); border: 1px solid var(--border); font-size: 12px;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="color: var(--text-dim); font-size: 10px;">${w.importance}</span>
                ${w.name}
            </div>
        </td>`;

        let rowWeight = 0;
        qfdHows.forEach((h, hi) => {
            const key = `${wi}-${hi}`;
            const rel = qfdRelationships[key] || 0;
            rowWeight += rel * w.importance;

            html += `<td style="padding: 4px; border: 1px solid var(--border); text-align: center; cursor: pointer; background: ${rel === 9 ? 'rgba(74, 159, 110, 0.2)' : rel === 3 ? 'rgba(74, 159, 110, 0.1)' : 'transparent'};" onclick="cycleRelationship(${wi}, ${hi})">
                <span style="font-size: 16px;">${symbols[rel]}</span>
            </td>`;
        });

        html += `<td style="padding: 8px; border: 1px solid var(--border); text-align: center; font-size: 11px; color: var(--text-dim);">${rowWeight}</td>`;
        html += '</tr>';
    });

    // Column totals
    html += '<tr><td style="padding: 8px; background: var(--bg-card); border: 1px solid var(--border); font-size: 11px; font-weight: 600;">Priority Score</td>';
    const priorities = [];
    qfdHows.forEach((h, hi) => {
        let score = 0;
        qfdWhats.forEach((w, wi) => {
            const key = `${wi}-${hi}`;
            score += (qfdRelationships[key] || 0) * w.importance;
        });
        priorities.push({ name: h.name, score });
        html += `<td style="padding: 8px; background: var(--accent); color: white; border: 1px solid var(--border); text-align: center; font-weight: 600;">${score}</td>`;
    });
    html += '<td style="border: 1px solid var(--border);"></td></tr>';

    // Target row
    html += '<tr><td style="padding: 8px; background: var(--bg-card); border: 1px solid var(--border); font-size: 11px;">Target</td>';
    qfdHows.forEach((h, hi) => {
        html += `<td style="padding: 4px; border: 1px solid var(--border); text-align: center; font-size: 10px; color: var(--text-dim);">${h.target || '—'}</td>`;
    });
    html += '<td style="border: 1px solid var(--border);"></td></tr>';

    html += '</table></div>';

    // Legend
    html += `
        <div style="display: flex; gap: 20px; margin-top: 16px; font-size: 11px; color: var(--text-dim); flex-wrap: wrap;">
            <span>Relationships: <strong>●</strong>=Strong(9) <strong>○</strong>=Medium(3) <strong>△</strong>=Weak(1)</span>
            <span style="color: var(--text-secondary);">Click cells to cycle values</span>
        </div>
    `;

    // Correlation Matrices side by side
    const whatCount = qfdWhats.length;
    html += '<div style="display: flex; gap: 24px; margin-top: 24px; flex-wrap: wrap; align-items: flex-start;">';

    // WHAT × WHAT Correlation Matrix (requirement conflicts)
    if (whatCount > 1) {
        html += `
            <div style="flex: 1; min-width: 280px;">
                <div style="font-size: 13px; font-weight: 600; margin-bottom: 12px; color: var(--text-secondary);">WHAT × WHAT Conflicts</div>
                <table style="border-collapse: collapse;">
                    <tr><th style="padding: 6px; background: var(--bg-card); border: 1px solid var(--border);"></th>`;

        qfdWhats.forEach((w, i) => {
            html += '<th style="padding: 6px 8px; background: var(--bg-secondary); border: 1px solid var(--border); font-size: 10px; max-width: 80px; overflow: hidden; text-overflow: ellipsis;">' + w.name + '</th>';
        });
        html += '</tr>';

        qfdWhats.forEach((w1, i) => {
            html += '<tr><td style="padding: 6px 8px; background: var(--bg-secondary); border: 1px solid var(--border); font-size: 10px; white-space: nowrap;">' + w1.name + '</td>';
            qfdWhats.forEach((w2, j) => {
                if (i === j) {
                    html += '<td style="padding: 6px; border: 1px solid var(--border); background: var(--bg-card); text-align: center;">—</td>';
                } else if (i > j) {
                    // Mirror the upper triangle
                    const key = j + '-' + i;
                    const corr = qfdWhatCorrelations[key] || '0';
                    const bgColor = corr === '!' ? 'rgba(231, 76, 60, 0.3)' :
                                   corr === '?' ? 'rgba(232, 197, 71, 0.2)' : 'transparent';
                    html += '<td style="padding: 6px; border: 1px solid var(--border); text-align: center; background: ' + bgColor + '; color: var(--text-dim);">' + (corr === '0' ? '·' : corr) + '</td>';
                } else {
                    const key = i + '-' + j;
                    const corr = qfdWhatCorrelations[key] || '0';
                    const bgColor = corr === '!' ? 'rgba(231, 76, 60, 0.3)' :
                                   corr === '?' ? 'rgba(232, 197, 71, 0.2)' : 'transparent';
                    html += '<td style="padding: 6px; border: 1px solid var(--border); text-align: center; cursor: pointer; background: ' + bgColor + '; font-weight: bold; color: ' + (corr === '!' ? '#e74c3c' : corr === '?' ? '#e8c547' : 'var(--text-dim)') + ';" onclick="cycleWhatCorrelation(' + i + ', ' + j + ')">' + (corr === '0' ? '·' : corr) + '</td>';
                }
            });
            html += '</tr>';
        });

        html += '</table>';

        // Count conflicts
        let conflictCount = 0;
        let tensionCount = 0;
        Object.values(qfdWhatCorrelations).forEach(v => {
            if (v === '!') conflictCount++;
            if (v === '?') tensionCount++;
        });

        if (conflictCount > 0) {
            html += '<div style="margin-top: 8px; padding: 8px 12px; background: rgba(231, 76, 60, 0.1); border-left: 3px solid #e74c3c; border-radius: 4px; font-size: 12px; color: #e74c3c;"><strong>' + conflictCount + ' conflict(s)</strong> — requirements may be mutually exclusive. Discuss with stakeholders.</div>';
        } else if (tensionCount > 0) {
            html += '<div style="margin-top: 8px; padding: 8px 12px; background: rgba(232, 197, 71, 0.1); border-left: 3px solid #e8c547; border-radius: 4px; font-size: 12px; color: #b8860b;">' + tensionCount + ' tension(s) — requirements may trade off. Document assumptions.</div>';
        }

        html += '<div style="margin-top: 8px; font-size: 10px; color: var(--text-dim);"><strong style="color:#e74c3c">!</strong> Conflict (mutually exclusive) &nbsp; <strong style="color:#e8c547">?</strong> Tension (tradeoff likely)</div></div>';
    }

    // HOW × HOW Correlation Matrix
    if (howCount > 1) {
        html += `
            <div style="flex: 1; min-width: 280px;">
                <div style="font-size: 13px; font-weight: 600; margin-bottom: 12px; color: var(--text-secondary);">HOW × HOW Correlations</div>
                <table style="border-collapse: collapse;">
                    <tr><th style="padding: 6px; background: var(--bg-card); border: 1px solid var(--border);"></th>`;

        qfdHows.forEach((h, i) => {
            html += `<th style="padding: 6px 8px; background: var(--bg-secondary); border: 1px solid var(--border); font-size: 10px; max-width: 80px; overflow: hidden; text-overflow: ellipsis;">${h.name}</th>`;
        });
        html += '</tr>';

        qfdHows.forEach((h1, i) => {
            html += '<tr><td style="padding: 6px 8px; background: var(--bg-secondary); border: 1px solid var(--border); font-size: 10px; white-space: nowrap;">' + h1.name + '</td>';
            qfdHows.forEach((h2, j) => {
                if (i === j) {
                    html += '<td style="padding: 6px; border: 1px solid var(--border); background: var(--bg-card); text-align: center;">—</td>';
                } else {
                    const key = i < j ? (i + '-' + j) : (j + '-' + i);
                    const corr = qfdCorrelations[key] || '0';
                    const bgColor = corr === '++' ? 'rgba(74, 159, 110, 0.3)' :
                                   corr === '+' ? 'rgba(74, 159, 110, 0.15)' :
                                   corr === '--' ? 'rgba(231, 76, 60, 0.3)' :
                                   corr === '-' ? 'rgba(231, 76, 60, 0.15)' : 'transparent';
                    html += '<td style="padding: 6px; border: 1px solid var(--border); text-align: center; cursor: pointer; background: ' + bgColor + '; font-weight: bold; color: ' + (corrColors[corr] || 'var(--text-dim)') + ';" onclick="cycleCorrelation(' + Math.min(i,j) + ', ' + Math.max(i,j) + ')">' + (corrSymbols[corr] || '·') + '</td>';
                }
            });
            html += '</tr>';
        });

        html += `</table>
            <div style="margin-top: 8px; font-size: 10px; color: var(--text-dim);">
                <strong style="color:#4a9f6e">++</strong> Strong synergy &nbsp;
                <strong style="color:#7bc47f">+</strong> Synergy &nbsp;
                <strong style="color:#e74c3c">−−</strong> Strong tradeoff &nbsp;
                <strong style="color:#e8a87c">−</strong> Tradeoff
            </div>
        </div>`;
    }

    html += '</div>'; // Close flex container for correlation matrices

    container.innerHTML = html;

    // Update priority analysis
    updateQFDPriorities(priorities);
}

function cycleRelationship(whatIdx, howIdx) {
    const key = `${whatIdx}-${howIdx}`;
    const current = qfdRelationships[key] || 0;
    const cycle = [0, 1, 3, 9];
    const nextIdx = (cycle.indexOf(current) + 1) % cycle.length;
    qfdRelationships[key] = cycle[nextIdx];
    renderQFDMatrix();
}

function cycleCorrelation(how1Idx, how2Idx) {
    const key = `${Math.min(how1Idx, how2Idx)}-${Math.max(how1Idx, how2Idx)}`;
    const current = qfdCorrelations[key] || '0';
    const cycle = ['0', '+', '++', '-', '--'];
    const nextIdx = (cycle.indexOf(current) + 1) % cycle.length;
    qfdCorrelations[key] = cycle[nextIdx];
    renderQFDMatrix();
}

function cycleWhatCorrelation(what1Idx, what2Idx) {
    const key = `${what1Idx}-${what2Idx}`;
    const current = qfdWhatCorrelations[key] || '0';
    const cycle = ['0', '?', '!'];  // none, tension, conflict
    const nextIdx = (cycle.indexOf(current) + 1) % cycle.length;
    qfdWhatCorrelations[key] = cycle[nextIdx];
    renderQFDMatrix();
}

function updateQFDPriorities(priorities) {
    const sorted = [...priorities].sort((a, b) => b.score - a.score);

    document.getElementById('qfd-top-how').textContent = sorted[0]?.name || '—';

    // Coverage: what % of WHATs have at least one strong relationship?
    let coveredWhats = 0;
    qfdWhats.forEach((w, wi) => {
        const hasRelation = qfdHows.some((h, hi) => (qfdRelationships[`${wi}-${hi}`] || 0) >= 3);
        if (hasRelation) coveredWhats++;
    });
    const coverage = qfdWhats.length > 0 ? (coveredWhats / qfdWhats.length * 100) : 0;
    document.getElementById('qfd-coverage').innerHTML = `${coverage.toFixed(0)}<span class="calc-result-unit">%</span>`;

    // Count negative correlations between high-priority HOWs
    let conflicts = 0;
    Object.entries(qfdCorrelations).forEach(([key, val]) => {
        if (val === '-' || val === '--') conflicts++;
    });
    document.getElementById('qfd-conflicts').textContent = conflicts;

    // Priority bar chart
    Plotly.newPlot('qfd-priority-chart', [{
        x: priorities.map(p => p.name),
        y: priorities.map(p => p.score),
        type: 'bar',
        marker: { color: '#4a9f6e' },
        text: priorities.map(p => p.score),
        textposition: 'outside'
    }], {
        margin: { t: 20, b: 80, l: 40, r: 20 },
        paper_bgcolor: 'transparent',
        plot_bgcolor: 'transparent',
        xaxis: { tickangle: -30, tickfont: { size: 10, color: '#a0a0a0' } },
        yaxis: { tickfont: { size: 10, color: '#a0a0a0' }, gridcolor: 'rgba(150,150,150,0.1)' }
    }, { responsive: true, displayModeBar: false });
}

function loadSampleQFD() {
    qfdWhats = [
        { name: 'Easy to hold', importance: 5 },
        { name: 'Long battery life', importance: 5 },
        { name: 'Fast response', importance: 4 },
        { name: 'Durable', importance: 3 },
        { name: 'Affordable', importance: 4 },
    ];

    qfdHows = [
        { name: 'Grip diameter', unit: 'mm', target: '45' },
        { name: 'Battery capacity', unit: 'mAh', target: '5000' },
        { name: 'Processor speed', unit: 'GHz', target: '2.5' },
        { name: 'Drop resistance', unit: 'm', target: '1.5' },
        { name: 'Material cost', unit: '$', target: '<15' },
    ];

    qfdRelationships = {
        '0-0': 9, '0-4': 1,
        '1-1': 9, '1-4': 3,
        '2-2': 9, '2-1': 1,
        '3-3': 9, '3-0': 1, '3-4': 3,
        '4-4': 9, '4-1': 3, '4-2': 3
    };

    qfdCorrelations = {
        '1-2': '-',  // Battery vs processor (tradeoff)
        '1-4': '--', // Battery vs cost (strong tradeoff)
        '2-4': '-',  // Processor vs cost
        '0-3': '+',  // Grip vs drop resistance
    };

    renderQFDWhats();
    renderQFDHows();
}

// Phase 2: Part Deployment
function cascadeToPhase2() {
    // Carry over HOWs as inputs to Phase 2
    const container = document.getElementById('qfd-phase2-inputs');
    container.innerHTML = qfdHows.map(h => `
        <span style="padding: 6px 12px; background: var(--accent); color: white; border-radius: 4px; font-size: 12px;">${h.name}</span>
    `).join('');

    // Initialize parts if empty
    if (qfdParts.length === 0) {
        qfdParts = [
            { name: 'Housing material' },
            { name: 'Battery cell type' },
            { name: 'Processor chip' },
        ];
    }

    setQFDPhase(2);
    renderQFDParts();
}

function renderQFDParts() {
    const container = document.getElementById('qfd-parts');
    if (!container) return;

    container.innerHTML = qfdParts.map((p, i) => `
        <div class="yamazumi-station" style="gap: 8px;">
            <input type="text" value="${p.name}" style="flex: 1; padding: 8px;"
                   oninput="qfdParts[${i}].name = this.value; renderQFDMatrix2()">
            <button class="yamazumi-station-remove" onclick="qfdParts.splice(${i}, 1); renderQFDParts()">&times;</button>
        </div>
    `).join('');

    renderQFDMatrix2();
}

function addQFDPart() {
    qfdParts.push({ name: 'New part characteristic' });
    renderQFDParts();
}

function renderQFDMatrix2() {
    const container = document.getElementById('qfd-matrix-2');
    if (!container || qfdHows.length === 0 || qfdParts.length === 0) {
        if (container) container.innerHTML = '<div style="padding: 20px; color: var(--text-dim); text-align: center;">Add part characteristics to build the matrix</div>';
        return;
    }

    const symbols = { 9: '●', 3: '○', 1: '△', 0: '' };

    let html = '<table style="border-collapse: collapse; width: 100%;">';
    html += '<tr><th style="width: 150px; padding: 8px; background: var(--bg-card); border: 1px solid var(--border);"></th>';
    qfdParts.forEach(p => {
        html += `<th style="padding: 8px; background: var(--bg-secondary); border: 1px solid var(--border); font-size: 11px;">${p.name}</th>`;
    });
    html += '</tr>';

    qfdHows.forEach((h, hi) => {
        html += `<tr><td style="padding: 8px; background: var(--bg-secondary); border: 1px solid var(--border); font-size: 12px;">${h.name}</td>`;
        qfdParts.forEach((p, pi) => {
            const key = `${hi}-${pi}`;
            const rel = qfdMatrix2[key] || 0;
            html += `<td style="padding: 4px; border: 1px solid var(--border); text-align: center; cursor: pointer; background: ${rel === 9 ? 'rgba(74, 159, 110, 0.2)' : 'transparent'};" onclick="cycleMatrix2(${hi}, ${pi})">
                <span style="font-size: 16px;">${symbols[rel]}</span>
            </td>`;
        });
        html += '</tr>';
    });

    html += '</table>';
    container.innerHTML = html;
}

function cycleMatrix2(howIdx, partIdx) {
    const key = `${howIdx}-${partIdx}`;
    const current = qfdMatrix2[key] || 0;
    const cycle = [0, 1, 3, 9];
    qfdMatrix2[key] = cycle[(cycle.indexOf(current) + 1) % cycle.length];
    renderQFDMatrix2();
}

// Phase 3: Process Planning
function cascadeToPhase3() {
    const container = document.getElementById('qfd-phase3-inputs');
    container.innerHTML = qfdParts.map(p => `
        <span style="padding: 6px 12px; background: var(--accent); color: white; border-radius: 4px; font-size: 12px;">${p.name}</span>
    `).join('');

    if (qfdProcesses.length === 0) {
        qfdProcesses = [
            { name: 'Injection pressure' },
            { name: 'Cure temperature' },
            { name: 'Assembly torque' },
        ];
    }

    setQFDPhase(3);
    renderQFDProcesses();
}

function renderQFDProcesses() {
    const container = document.getElementById('qfd-processes');
    if (!container) return;

    container.innerHTML = qfdProcesses.map((p, i) => `
        <div class="yamazumi-station" style="gap: 8px;">
            <input type="text" value="${p.name}" style="flex: 1; padding: 8px;"
                   oninput="qfdProcesses[${i}].name = this.value; renderQFDMatrix3()">
            <button class="yamazumi-station-remove" onclick="qfdProcesses.splice(${i}, 1); renderQFDProcesses()">&times;</button>
        </div>
    `).join('');

    renderQFDMatrix3();
}

function addQFDProcess() {
    qfdProcesses.push({ name: 'New process parameter' });
    renderQFDProcesses();
}

function renderQFDMatrix3() {
    const container = document.getElementById('qfd-matrix-3');
    if (!container || qfdParts.length === 0 || qfdProcesses.length === 0) {
        if (container) container.innerHTML = '<div style="padding: 20px; color: var(--text-dim); text-align: center;">Add process parameters to build the matrix</div>';
        return;
    }

    const symbols = { 9: '●', 3: '○', 1: '△', 0: '' };

    let html = '<table style="border-collapse: collapse; width: 100%;">';
    html += '<tr><th style="width: 150px; padding: 8px; background: var(--bg-card); border: 1px solid var(--border);"></th>';
    qfdProcesses.forEach(p => {
        html += `<th style="padding: 8px; background: var(--bg-secondary); border: 1px solid var(--border); font-size: 11px;">${p.name}</th>`;
    });
    html += '</tr>';

    qfdParts.forEach((part, pi) => {
        html += `<tr><td style="padding: 8px; background: var(--bg-secondary); border: 1px solid var(--border); font-size: 12px;">${part.name}</td>`;
        qfdProcesses.forEach((proc, proci) => {
            const key = `${pi}-${proci}`;
            const rel = qfdMatrix3[key] || 0;
            html += `<td style="padding: 4px; border: 1px solid var(--border); text-align: center; cursor: pointer; background: ${rel === 9 ? 'rgba(74, 159, 110, 0.2)' : 'transparent'};" onclick="cycleMatrix3(${pi}, ${proci})">
                <span style="font-size: 16px;">${symbols[rel]}</span>
            </td>`;
        });
        html += '</tr>';
    });

    html += '</table>';
    container.innerHTML = html;
}

function cycleMatrix3(partIdx, procIdx) {
    const key = `${partIdx}-${procIdx}`;
    const current = qfdMatrix3[key] || 0;
    const cycle = [0, 1, 3, 9];
    qfdMatrix3[key] = cycle[(cycle.indexOf(current) + 1) % cycle.length];
    renderQFDMatrix3();
}

// Phase 4: Production Control
function cascadeToPhase4() {
    const container = document.getElementById('qfd-phase4-inputs');
    container.innerHTML = qfdProcesses.map(p => `
        <span style="padding: 6px 12px; background: var(--accent); color: white; border-radius: 4px; font-size: 12px;">${p.name}</span>
    `).join('');

    if (qfdControls.length === 0) {
        qfdControls = [
            { name: 'Pressure gauge check' },
            { name: 'Temperature log' },
            { name: 'Torque verification' },
        ];
    }

    setQFDPhase(4);
    renderQFDControls();
}

function renderQFDControls() {
    const container = document.getElementById('qfd-controls');
    if (!container) return;

    container.innerHTML = qfdControls.map((c, i) => `
        <div class="yamazumi-station" style="gap: 8px;">
            <input type="text" value="${c.name}" style="flex: 1; padding: 8px;"
                   oninput="qfdControls[${i}].name = this.value; renderQFDMatrix4()">
            <button class="yamazumi-station-remove" onclick="qfdControls.splice(${i}, 1); renderQFDControls()">&times;</button>
        </div>
    `).join('');

    renderQFDMatrix4();
}

function addQFDControl() {
    qfdControls.push({ name: 'New control point' });
    renderQFDControls();
}

function renderQFDMatrix4() {
    const container = document.getElementById('qfd-matrix-4');
    if (!container || qfdProcesses.length === 0 || qfdControls.length === 0) {
        if (container) container.innerHTML = '<div style="padding: 20px; color: var(--text-dim); text-align: center;">Add control points to build the matrix</div>';
        return;
    }

    const symbols = { 9: '●', 3: '○', 1: '△', 0: '' };

    let html = '<table style="border-collapse: collapse; width: 100%;">';
    html += '<tr><th style="width: 150px; padding: 8px; background: var(--bg-card); border: 1px solid var(--border);"></th>';
    qfdControls.forEach(c => {
        html += `<th style="padding: 8px; background: var(--bg-secondary); border: 1px solid var(--border); font-size: 11px;">${c.name}</th>`;
    });
    html += '</tr>';

    qfdProcesses.forEach((proc, proci) => {
        html += `<tr><td style="padding: 8px; background: var(--bg-secondary); border: 1px solid var(--border); font-size: 12px;">${proc.name}</td>`;
        qfdControls.forEach((ctrl, ctrli) => {
            const key = `${proci}-${ctrli}`;
            const rel = qfdMatrix4[key] || 0;
            html += `<td style="padding: 4px; border: 1px solid var(--border); text-align: center; cursor: pointer; background: ${rel === 9 ? 'rgba(74, 159, 110, 0.2)' : 'transparent'};" onclick="cycleMatrix4(${proci}, ${ctrli})">
                <span style="font-size: 16px;">${symbols[rel]}</span>
            </td>`;
        });
        html += '</tr>';
    });

    html += '</table>';
    container.innerHTML = html;
}

function cycleMatrix4(procIdx, ctrlIdx) {
    const key = `${procIdx}-${ctrlIdx}`;
    const current = qfdMatrix4[key] || 0;
    const cycle = [0, 1, 3, 9];
    qfdMatrix4[key] = cycle[(cycle.indexOf(current) + 1) % cycle.length];
    renderQFDMatrix4();
}

function exportQFDTrace() {
    // Build traceability from controls back to customer requirements
    let trace = 'QFD Traceability Matrix\n';
    trace += '========================\n\n';

    qfdControls.forEach((ctrl, ci) => {
        trace += `Control: ${ctrl.name}\n`;

        // Find linked processes
        const linkedProcs = [];
        qfdProcesses.forEach((proc, pi) => {
            if (qfdMatrix4[`${pi}-${ci}`]) linkedProcs.push(proc.name);
        });
        trace += `  → Processes: ${linkedProcs.join(', ') || 'none'}\n`;

        // Could continue tracing back through parts to HOWs to WHATs
        trace += '\n';
    });

    // Download as text file
    const blob = new Blob([trace], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'qfd-traceability.txt';
    a.click();
    URL.revokeObjectURL(url);
}

// ============================================================================
// DSW Integration (Stub)
// ============================================================================

function pullDSWStats(type) {
    alert('DSW integration coming soon!\n\nThis will let you pull statistics directly from time studies and descriptive analyses.');
}

// ============================================================================
// Scenario Persistence (LocalStorage)
// ============================================================================

const STORAGE_KEY = 'svend_ops_scenarios';
const AUTO_SAVE_KEY = 'svend_ops_autosave';
let currentScenarioId = null;

// Collect all calculator state into one object
function collectState() {
    return {
        // Line Simulator
        lineStations: lineStations,
        lineProducts: lineProducts,
        lineOrders: lineOrders,
        lineSimSettings: {
            cov: parseFloat(document.getElementById('ls-cov')?.value) || 0.1,
            maxWip: parseInt(document.getElementById('ls-max-wip')?.value) || 3,
            batchSize: parseInt(document.getElementById('ls-batch-size')?.value) || 1,
            changeoverTime: parseFloat(document.getElementById('ls-changeover-time')?.value) || 120,
            simMode: document.getElementById('ls-sim-mode')?.value || 'infinite'
        },

        // SMED
        smedData: smedData,
        smedBaseline: smedBaseline,
        smedImpact: {
            changoversDay: parseFloat(document.getElementById('smed-changeovers-day')?.value) || 4,
            daysYear: parseFloat(document.getElementById('smed-days-year')?.value) || 250,
            hourlyCost: parseFloat(document.getElementById('smed-hourly-cost')?.value) || 150
        },

        // Yamazumi
        yamazumiData: typeof yamazumiData !== 'undefined' ? yamazumiData : [],
        yamazumiTakt: parseFloat(document.getElementById('yamazumi-takt')?.value) || 60,

        // Changeover Matrix
        changeoverMatrix: changeoverMatrix,
        changeoverProducts: document.getElementById('changeover-products')?.value || 'A, B, C, D',

        // Bottleneck
        bottleneckData: typeof bottleneckData !== 'undefined' ? bottleneckData : [],

        // FMEA
        fmeaData: typeof fmeaData !== 'undefined' ? fmeaData : [],

        // RTY
        rtyData: typeof rtyData !== 'undefined' ? rtyData : [],

        // Cycle Time Study
        cycleData: typeof cycleData !== 'undefined' ? cycleData : [],

        // Before/After
        baData: typeof baData !== 'undefined' ? baData : [],

        // Heijunka
        heijunkaData: typeof heijunkaData !== 'undefined' ? heijunkaData : [],

        // Multi-Stage Queue
        tandemStages: typeof tandemStages !== 'undefined' ? tandemStages : [],

        // Priority Queue
        priorityClasses: typeof priorityClasses !== 'undefined' ? priorityClasses : [],

        // Scheduling Tools
        sequencerJobs: typeof sequencerJobs !== 'undefined' ? sequencerJobs : [],
        sequencerOrder: typeof sequencerOrder !== 'undefined' ? sequencerOrder : [],
        capacityOrders: typeof capacityOrders !== 'undefined' ? capacityOrders : [],
        mixedProducts: typeof mixedProducts !== 'undefined' ? mixedProducts : [],
        ddsOrders: typeof ddsOrders !== 'undefined' ? ddsOrders : [],

        // QFD
        qfdWhats: typeof qfdWhats !== 'undefined' ? qfdWhats : [],
        qfdHows: typeof qfdHows !== 'undefined' ? qfdHows : [],
        qfdRelationships: typeof qfdRelationships !== 'undefined' ? qfdRelationships : {},
        qfdCorrelations: typeof qfdCorrelations !== 'undefined' ? qfdCorrelations : {},
        qfdWhatCorrelations: typeof qfdWhatCorrelations !== 'undefined' ? qfdWhatCorrelations : {},
        qfdParts: typeof qfdParts !== 'undefined' ? qfdParts : [],
        qfdProcesses: typeof qfdProcesses !== 'undefined' ? qfdProcesses : [],
        qfdControls: typeof qfdControls !== 'undefined' ? qfdControls : [],
        qfdMatrix2: typeof qfdMatrix2 !== 'undefined' ? qfdMatrix2 : {},
        qfdMatrix3: typeof qfdMatrix3 !== 'undefined' ? qfdMatrix3 : {},
        qfdMatrix4: typeof qfdMatrix4 !== 'undefined' ? qfdMatrix4 : {},

        // PFA — Product Flow Analysis
        pfaSteps: typeof pfaSteps !== 'undefined' ? pfaSteps : [],
        pfaBaseline: typeof pfaBaseline !== 'undefined' ? pfaBaseline : null,

        // WFA — Workflow Analysis
        wfaElements: typeof wfaElements !== 'undefined' ? wfaElements : [],
        wfaBaseline: typeof wfaBaseline !== 'undefined' ? wfaBaseline : null,

        // Timestamp
        savedAt: new Date().toISOString()
    };
}

// Restore state from saved object
function restoreState(state) {
    if (!state) return;

    // Line Simulator
    if (state.lineStations) lineStations = state.lineStations;
    if (state.lineProducts) lineProducts = state.lineProducts;
    if (state.lineOrders) lineOrders = state.lineOrders;
    if (state.lineSimSettings) {
        const s = state.lineSimSettings;
        if (document.getElementById('ls-cov')) document.getElementById('ls-cov').value = s.cov;
        if (document.getElementById('ls-max-wip')) document.getElementById('ls-max-wip').value = s.maxWip;
        if (document.getElementById('ls-batch-size')) document.getElementById('ls-batch-size').value = s.batchSize;
        if (document.getElementById('ls-changeover-time')) document.getElementById('ls-changeover-time').value = s.changeoverTime;
        if (document.getElementById('ls-sim-mode')) document.getElementById('ls-sim-mode').value = s.simMode;
    }

    // SMED
    if (state.smedData) smedData = state.smedData;
    if (state.smedBaseline) {
        smedBaseline = state.smedBaseline;
        document.getElementById('smed-clear-baseline').style.display = 'inline-block';
    }
    if (state.smedImpact) {
        if (document.getElementById('smed-changeovers-day')) document.getElementById('smed-changeovers-day').value = state.smedImpact.changoversDay;
        if (document.getElementById('smed-days-year')) document.getElementById('smed-days-year').value = state.smedImpact.daysYear;
        if (document.getElementById('smed-hourly-cost')) document.getElementById('smed-hourly-cost').value = state.smedImpact.hourlyCost;
    }

    // Yamazumi
    if (state.yamazumiData && typeof yamazumiData !== 'undefined') yamazumiData = state.yamazumiData;
    if (state.yamazumiTakt && document.getElementById('yamazumi-takt')) {
        document.getElementById('yamazumi-takt').value = state.yamazumiTakt;
    }

    // Changeover Matrix
    if (state.changeoverMatrix) changeoverMatrix = state.changeoverMatrix;
    if (state.changeoverProducts && document.getElementById('changeover-products')) {
        document.getElementById('changeover-products').value = state.changeoverProducts;
    }

    // Bottleneck
    if (state.bottleneckData && typeof bottleneckData !== 'undefined') bottleneckData = state.bottleneckData;

    // FMEA
    if (state.fmeaData && typeof fmeaData !== 'undefined') fmeaData = state.fmeaData;

    // RTY
    if (state.rtyData && typeof rtyData !== 'undefined') rtyData = state.rtyData;

    // Cycle Time Study
    if (state.cycleData && typeof cycleData !== 'undefined') cycleData = state.cycleData;

    // Before/After
    if (state.baData && typeof baData !== 'undefined') baData = state.baData;

    // Heijunka
    if (state.heijunkaData && typeof heijunkaData !== 'undefined') heijunkaData = state.heijunkaData;

    // Multi-Stage Queue
    if (state.tandemStages && typeof tandemStages !== 'undefined') tandemStages = state.tandemStages;

    // Priority Queue
    if (state.priorityClasses && typeof priorityClasses !== 'undefined') priorityClasses = state.priorityClasses;

    // Scheduling Tools
    if (state.sequencerJobs && typeof sequencerJobs !== 'undefined') sequencerJobs = state.sequencerJobs;
    if (state.sequencerOrder && typeof sequencerOrder !== 'undefined') sequencerOrder = state.sequencerOrder;
    if (state.capacityOrders && typeof capacityOrders !== 'undefined') capacityOrders = state.capacityOrders;
    if (state.mixedProducts && typeof mixedProducts !== 'undefined') mixedProducts = state.mixedProducts;
    if (state.ddsOrders && typeof ddsOrders !== 'undefined') ddsOrders = state.ddsOrders;

    // QFD
    if (state.qfdWhats && typeof qfdWhats !== 'undefined') qfdWhats = state.qfdWhats;
    if (state.qfdHows && typeof qfdHows !== 'undefined') qfdHows = state.qfdHows;
    if (state.qfdRelationships && typeof qfdRelationships !== 'undefined') qfdRelationships = state.qfdRelationships;
    if (state.qfdCorrelations && typeof qfdCorrelations !== 'undefined') qfdCorrelations = state.qfdCorrelations;
    if (state.qfdWhatCorrelations && typeof qfdWhatCorrelations !== 'undefined') qfdWhatCorrelations = state.qfdWhatCorrelations;
    if (state.qfdParts && typeof qfdParts !== 'undefined') qfdParts = state.qfdParts;
    if (state.qfdProcesses && typeof qfdProcesses !== 'undefined') qfdProcesses = state.qfdProcesses;
    if (state.qfdControls && typeof qfdControls !== 'undefined') qfdControls = state.qfdControls;
    if (state.qfdMatrix2 && typeof qfdMatrix2 !== 'undefined') qfdMatrix2 = state.qfdMatrix2;
    if (state.qfdMatrix3 && typeof qfdMatrix3 !== 'undefined') qfdMatrix3 = state.qfdMatrix3;
    if (state.qfdMatrix4 && typeof qfdMatrix4 !== 'undefined') qfdMatrix4 = state.qfdMatrix4;

    // PFA — Product Flow Analysis
    if (state.pfaSteps && typeof pfaSteps !== 'undefined') pfaSteps = state.pfaSteps;
    if (state.pfaBaseline && typeof pfaBaseline !== 'undefined') {
        pfaBaseline = state.pfaBaseline;
        const btn = document.getElementById('pfa-clear-baseline');
        if (btn) btn.style.display = 'inline-block';
    }

    // WFA — Workflow Analysis
    if (state.wfaElements && typeof wfaElements !== 'undefined') wfaElements = state.wfaElements;
    if (state.wfaBaseline && typeof wfaBaseline !== 'undefined') {
        wfaBaseline = state.wfaBaseline;
        const btn = document.getElementById('wfa-clear-baseline');
        if (btn) btn.style.display = 'inline-block';
    }
}

// Auto-save current state (debounced)
let autoSaveTimeout = null;
function autoSave() {
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(() => {
        const state = collectState();
        localStorage.setItem(AUTO_SAVE_KEY, JSON.stringify(state));
    }, 1000); // 1 second debounce
}

// Get all saved scenarios
function getScenarios() {
    const data = localStorage.getItem(STORAGE_KEY);
    return data ? JSON.parse(data) : {};
}

// Save scenarios to localStorage
function setScenarios(scenarios) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(scenarios));
}

// Update scenario dropdown
function updateScenarioDropdown() {
    const select = document.getElementById('scenario-select');
    if (!select) return;

    const scenarios = getScenarios();
    const scenarioList = Object.entries(scenarios).sort((a, b) =>
        new Date(b[1].savedAt) - new Date(a[1].savedAt)
    );

    select.innerHTML = '<option value="">Current Session</option>';
    scenarioList.forEach(([id, scenario]) => {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = scenario.name || `Scenario ${id.slice(0, 6)}`;
        if (id === currentScenarioId) opt.selected = true;
        select.appendChild(opt);
    });

    // Handle selection change
    select.onchange = () => {
        const id = select.value;
        if (id) {
            loadScenario(id);
        } else {
            currentScenarioId = null;
        }
    };
}

// Save current state as scenario
function saveScenario() {
    const state = collectState();

    if (currentScenarioId) {
        // Update existing scenario
        const scenarios = getScenarios();
        if (scenarios[currentScenarioId]) {
            state.name = scenarios[currentScenarioId].name;
            scenarios[currentScenarioId] = state;
            setScenarios(scenarios);
            showToast(`Saved "${state.name}"`);
            return;
        }
    }

    // No current scenario - prompt to save as new
    saveScenarioAs();
}

// Save as new scenario with name
function saveScenarioAs() {
    const name = prompt('Scenario name:', `Scenario ${new Date().toLocaleDateString()}`);
    if (!name) return;

    const state = collectState();
    state.name = name;

    const id = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    const scenarios = getScenarios();
    scenarios[id] = state;
    setScenarios(scenarios);

    currentScenarioId = id;
    updateScenarioDropdown();
    toggleScenarioMenu();
    showToast(`Saved "${name}"`);
}

// Load a scenario by ID
function loadScenario(id) {
    const scenarios = getScenarios();
    const scenario = scenarios[id];
    if (!scenario) return;

    restoreState(scenario);
    currentScenarioId = id;

    // Refresh all displays
    refreshAllDisplays();
    showToast(`Loaded "${scenario.name}"`);
}

// Rename current scenario
function renameScenario() {
    if (!currentScenarioId) {
        alert('No scenario selected. Save first.');
        return;
    }

    const scenarios = getScenarios();
    const current = scenarios[currentScenarioId];
    if (!current) return;

    const name = prompt('New name:', current.name);
    if (!name) return;

    current.name = name;
    setScenarios(scenarios);
    updateScenarioDropdown();
    toggleScenarioMenu();
    showToast(`Renamed to "${name}"`);
}

// Delete current scenario
function deleteScenario() {
    if (!currentScenarioId) {
        alert('No scenario selected.');
        return;
    }

    const scenarios = getScenarios();
    const name = scenarios[currentScenarioId]?.name || 'this scenario';

    if (!confirm(`Delete "${name}"? This cannot be undone.`)) return;

    delete scenarios[currentScenarioId];
    setScenarios(scenarios);
    currentScenarioId = null;
    updateScenarioDropdown();
    toggleScenarioMenu();
    showToast('Scenario deleted');
}

// Export all scenarios to JSON file
function exportScenarios() {
    const scenarios = getScenarios();
    const autoSave = localStorage.getItem(AUTO_SAVE_KEY);

    const exportData = {
        scenarios: scenarios,
        currentSession: autoSave ? JSON.parse(autoSave) : collectState(),
        exportedAt: new Date().toISOString(),
        version: 1
    };

    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `svend-ops-scenarios-${new Date().toISOString().slice(0, 10)}.json`;
    a.click();
    URL.revokeObjectURL(url);

    toggleScenarioMenu();
    showToast('Exported all scenarios');
}

// Import scenarios from JSON file
function importScenarios(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);

            if (data.scenarios) {
                const existing = getScenarios();
                const merged = { ...existing, ...data.scenarios };
                setScenarios(merged);
                updateScenarioDropdown();

                const count = Object.keys(data.scenarios).length;
                showToast(`Imported ${count} scenario${count !== 1 ? 's' : ''}`);
            }

            // Optionally restore current session
            if (data.currentSession) {
                if (confirm('Also restore the session state from this export?')) {
                    restoreState(data.currentSession);
                    refreshAllDisplays();
                }
            }
        } catch (err) {
            alert('Invalid file format: ' + err.message);
        }
    };
    reader.readAsText(file);
    event.target.value = ''; // Reset file input
    toggleScenarioMenu();
}

// Toggle scenario menu dropdown
function toggleScenarioMenu() {
    const menu = document.getElementById('scenario-menu');
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

// Close menu when clicking outside
document.addEventListener('click', (e) => {
    const menu = document.getElementById('scenario-menu');
    const toggle = e.target.closest('[onclick*="toggleScenarioMenu"]');
    if (menu && !menu.contains(e.target) && !toggle) {
        menu.style.display = 'none';
    }
});

// Refresh all calculator displays after state restore
function refreshAllDisplays() {
    // Line Simulator
    if (typeof renderLineSimInputs === 'function') renderLineSimInputs();
    if (typeof updateSimMode === 'function') updateSimMode();
    if (typeof renderProducts === 'function') renderProducts();
    if (typeof renderOrders === 'function') renderOrders();
    if (typeof initLineSim === 'function') initLineSim();

    // SMED
    if (typeof renderSMEDInputs === 'function') renderSMEDInputs();

    // Yamazumi
    if (typeof renderYamazumiInputs === 'function') renderYamazumiInputs();

    // Changeover Matrix
    if (typeof renderChangeoverMatrix === 'function') renderChangeoverMatrix();

    // Bottleneck
    if (typeof renderBottleneckInputs === 'function') renderBottleneckInputs();

    // FMEA
    if (typeof renderFMEAInputs === 'function') renderFMEAInputs();

    // RTY
    if (typeof renderRTYInputs === 'function') renderRTYInputs();

    // Cycle Time
    if (typeof renderCycleInputs === 'function') renderCycleInputs();

    // Before/After
    if (typeof renderBAInputs === 'function') renderBAInputs();

    // Heijunka
    if (typeof renderHeijunkaInputs === 'function') renderHeijunkaInputs();

    // Multi-Stage Queue
    if (typeof renderTandemStages === 'function') renderTandemStages();

    // Priority Queue
    if (typeof renderPriorityClasses === 'function') renderPriorityClasses();

    // Scheduling Tools
    if (typeof renderSequencerJobs === 'function') renderSequencerJobs();
    if (typeof renderCapacityOrders === 'function') renderCapacityOrders();
    if (typeof renderMixedProducts === 'function') renderMixedProducts();
    if (typeof renderDDSOrders === 'function') renderDDSOrders();

    // QFD
    if (typeof renderQFDWhats === 'function') renderQFDWhats();
    if (typeof renderQFDHows === 'function') renderQFDHows();

    // PFA — Product Flow Analysis
    if (typeof renderPFASteps === 'function') renderPFASteps();

    // WFA — Workflow Analysis
    if (typeof renderWFAElements === 'function') renderWFAElements();
}

// Toast notification helper
function showToast(message) {
    const existing = document.querySelector('.ops-toast');
    if (existing) existing.remove();

    const toast = document.createElement('div');
    toast.className = 'ops-toast';
    toast.style.cssText = `
        position: fixed; bottom: 20px; right: 20px; padding: 12px 20px;
        background: var(--accent); color: white; border-radius: 8px;
        font-size: 13px; font-weight: 500; z-index: 9999;
        animation: fadeInUp 0.3s ease;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// Hook auto-save into state-changing functions
function hookAutoSave() {
    // Override update functions to trigger auto-save
    const originalFunctions = [
        'updateSMED', 'addSMEDElement', 'removeSMED',
        'addYamazumiStation', 'removeYamazumiStation', 'updateYamazumiStation',
        'updateMatrixValue',
        'updateBottleneck', 'addBottleneckStation',
        'updateFMEA', 'addFMEARow',
        'updateRTY', 'addRTYStep',
        'updateCycle', 'addCycleMeasurement',
        'updateBA', 'addBAMetric',
        'updateHeijunka', 'addHeijunkaProduct',
        'updateTandemStage', 'addTandemStage',
        'updatePriorityClass', 'addPriorityClass',
        'addLineStation', 'removeLineStation', 'updateLineStation',
        'addProduct', 'removeProduct',
        'addOrder', 'removeOrder',
        // Scheduling
        'addSequencerJob', 'removeSequencerJob', 'updateSequencerJob',
        'addCapacityOrder', 'removeCapacityOrder', 'updateCapacityOrder',
        'addMixedProduct', 'removeMixedProduct', 'updateMixedProduct',
        'addDDSOrder', 'removeDDSOrder', 'updateDDSOrder',
        // PFA & WFA
        'addPFAStep', 'removePFAStep', 'updatePFAStep', 'capturePFABaseline', 'clearPFABaseline',
        'addWFAElement', 'removeWFAElement', 'updateWFAElement', 'captureWFABaseline', 'clearWFABaseline'
    ];

    originalFunctions.forEach(fnName => {
        if (typeof window[fnName] === 'function') {
            const original = window[fnName];
            window[fnName] = function(...args) {
                const result = original.apply(this, args);
                autoSave();
                return result;
            };
        }
    });
}

// ============================================================================
// Init
// ============================================================================

document.addEventListener('DOMContentLoaded', () => {
    // ========================================
    // Restore auto-saved state FIRST
    // ========================================
    const autoSaved = localStorage.getItem(AUTO_SAVE_KEY);
    if (autoSaved) {
        try {
            restoreState(JSON.parse(autoSaved));
        } catch (e) {
            console.warn('Failed to restore auto-save:', e);
        }
    }

    // ========================================
    // Initialize custom steppers
    // ========================================
    initializeSteppers();

    // ========================================
    // Initialize all calculators
    // ========================================
    calcTakt();
    calcRTO();
    calcKanban();
    calcEPEI();
    calcSafety();
    calcEOQ();
    calcOEE();
    renderYamazumiInputs();
    renderBottleneckInputs();
    calcLittles();
    calcQueue();
    calcPitch();
    renderRTYInputs();
    calcDPMO();
    calcTurns();
    calcCOQ();
    renderSMEDInputs();
    renderChangeoverMatrix();
    renderFMEAInputs();
    calcCpk();
    calcSampleSize();
    calcLineEff();
    calcOLE();
    renderCycleInputs();
    renderBAInputs();
    renderHeijunkaInputs();
    // Queuing Lab
    calcQueueFinite();
    renderPriorityClasses();
    calcOptimizer();
    initSimVisual();
    initCompareVisuals();
    renderTandemStages();
    // Line Simulator
    initLineSim();
    // Scheduling Tools
    renderSequencerJobs();
    renderCapacityOrders();
    renderMixedProducts();
    renderDDSOrders();
    // Method Tools
    renderQFDWhats();
    renderQFDHows();
    // Flow Analysis
    renderPFASteps();
    renderWFAElements();

    // ========================================
    // Persistence: scenarios & auto-save
    // ========================================
    updateScenarioDropdown();
    hookAutoSave();
});

// ============================================================================
// Kanban Pull System Simulator
// ============================================================================

const kanbanStations = [
    { name: 'Stamping', cycleTime: 45 },
    { name: 'Welding', cycleTime: 55 },
    { name: 'Assembly', cycleTime: 50 },
    { name: 'Packing', cycleTime: 40 },
];

const kanbanState = {
    running: false,
    interval: null,
    mode: 'pull',
    time: 0,
    completed: 0,
    stockouts: 0,
    totalLeadTime: 0,
    stations: [],
    supermarkets: [],
    history: { time: [], wip: [] },
    customerTimer: 0,
};

function renderKanbanStations() {
    const el = document.getElementById('ks-stations');
    if (!el) return;
    el.innerHTML = kanbanStations.map((s, i) => `
        <div style="display:flex; align-items:center; gap:8px;">
            <input type="text" value="${s.name}" style="flex:1; padding:8px; background:var(--bg-secondary); border:1px solid var(--border); border-radius:6px; color:var(--text-primary);" oninput="kanbanStations[${i}].name=this.value">
            <input type="number" value="${s.cycleTime}" style="width:70px; text-align:right; padding:8px; background:var(--bg-secondary); border:1px solid var(--border); border-radius:6px; color:var(--text-primary);" oninput="kanbanStations[${i}].cycleTime=parseFloat(this.value)||30">
            <span style="color:var(--text-dim); font-size:12px; min-width:24px;">sec</span>
        </div>
    `).join('');
}

function setKanbanMode(mode) {
    kanbanState.mode = mode;
    const pushBtn = document.getElementById('ks-mode-push');
    const pullBtn = document.getElementById('ks-mode-pull');
    if (mode === 'push') {
        pushBtn.style.background = 'rgba(231,76,60,0.2)';
        pushBtn.style.color = '#e74c3c';
        pullBtn.style.background = 'var(--bg-secondary)';
        pullBtn.style.color = 'var(--text-dim)';
    } else {
        pullBtn.style.background = 'rgba(74,159,110,0.2)';
        pullBtn.style.color = 'var(--accent)';
        pushBtn.style.background = 'var(--bg-secondary)';
        pushBtn.style.color = 'var(--text-dim)';
    }
}

function updateKanbanParams() {}

function boxNormalRandom() {
    let u = 0, v = 0;
    while (u === 0) u = Math.random();
    while (v === 0) v = Math.random();
    return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
}

function startKanbanSim() {
    if (kanbanState.running) {
        kanbanState.running = false;
        clearInterval(kanbanState.interval);
        document.getElementById('ks-start').innerHTML = '&#9654; Resume';
        return;
    }

    kanbanState.running = true;
    document.getElementById('ks-start').innerHTML = '&#9208; Pause';

    const nStations = kanbanStations.length;
    const kanbanCards = parseInt(document.getElementById('ks-kanban-cards').value) || 3;

    // Initialize on first run
    if (kanbanState.time === 0) {
        kanbanState.stations = kanbanStations.map(() => ({
            state: 'starved',   // working, blocked, starved
            timeRemaining: 0,
            processed: 0,
            workingTime: 0,
            blockedTime: 0,
            starvedTime: 0,
        }));
        // Supermarkets between stations (and one before station 0)
        kanbanState.supermarkets = [];
        for (let i = 0; i <= nStations; i++) {
            kanbanState.supermarkets.push({
                inventory: i === 0 ? 999 : Math.floor(kanbanCards / 2), // supplier has infinite
                kanbanCapacity: kanbanCards,
            });
        }
        kanbanState.completed = 0;
        kanbanState.stockouts = 0;
        kanbanState.totalLeadTime = 0;
        kanbanState.customerTimer = 0;
        kanbanState.history = { time: [], wip: [] };
    }

    const tickMs = 100;
    kanbanState.interval = setInterval(() => {
        const speed = parseInt(document.getElementById('ks-speed').value) || 5;
        const cov = parseInt(document.getElementById('ks-cov').value) / 100;
        const demandInterval = parseFloat(document.getElementById('ks-demand-interval').value) || 50;
        const dt = speed * 0.5; // sim seconds per tick
        const mode = kanbanState.mode;
        const kCards = parseInt(document.getElementById('ks-kanban-cards').value) || 3;

        kanbanState.time += dt;

        // Customer demand: pull from last supermarket
        kanbanState.customerTimer += dt;
        if (kanbanState.customerTimer >= demandInterval) {
            kanbanState.customerTimer -= demandInterval;
            const lastSM = kanbanState.supermarkets[nStations];
            if (lastSM.inventory > 0) {
                lastSM.inventory--;
                kanbanState.completed++;
                kanbanState.totalLeadTime += demandInterval * nStations; // simplified
            } else {
                kanbanState.stockouts++;
            }
        }

        // Process stations (forward pass)
        for (let i = 0; i < nStations; i++) {
            const stn = kanbanState.stations[i];
            const upstreamSM = kanbanState.supermarkets[i];
            const downstreamSM = kanbanState.supermarkets[i + 1];
            const baseCT = kanbanStations[i].cycleTime;

            if (stn.state === 'working') {
                stn.timeRemaining -= dt;
                stn.workingTime += dt;
                if (stn.timeRemaining <= 0) {
                    // Finished: try to place in downstream supermarket
                    if (mode === 'pull') {
                        if (downstreamSM.inventory < kCards) {
                            downstreamSM.inventory++;
                            stn.processed++;
                            stn.state = 'starved'; // need to pull new unit
                        } else {
                            stn.state = 'blocked';
                            stn.timeRemaining = 0;
                        }
                    } else {
                        // Push: always place downstream (unlimited)
                        downstreamSM.inventory++;
                        stn.processed++;
                        stn.state = 'starved';
                    }
                }
            }

            if (stn.state === 'starved') {
                // Try to pull from upstream supermarket
                if (upstreamSM.inventory > 0 || (i === 0 && mode === 'push')) {
                    if (i > 0 || mode === 'pull') upstreamSM.inventory--;
                    const actualCT = Math.max(baseCT * 0.3, baseCT * (1 + boxNormalRandom() * cov));
                    stn.timeRemaining = actualCT;
                    stn.state = 'working';
                } else {
                    stn.starvedTime += dt;
                }
            }

            if (stn.state === 'blocked') {
                stn.blockedTime += dt;
                // Retry
                if (mode === 'pull') {
                    if (downstreamSM.inventory < kCards) {
                        downstreamSM.inventory++;
                        stn.processed++;
                        stn.state = 'starved';
                    }
                } else {
                    downstreamSM.inventory++;
                    stn.processed++;
                    stn.state = 'starved';
                }
            }
        }

        // In push mode, supplier supermarket is infinite
        if (mode === 'push') {
            kanbanState.supermarkets[0].inventory = 999;
        } else {
            // Supplier replenishes when kanban returns (simplified: keep at kanban capacity)
            kanbanState.supermarkets[0].inventory = Math.min(kCards, kanbanState.supermarkets[0].inventory + 1);
        }

        // Record history
        const totalWIP = kanbanState.supermarkets.slice(1).reduce((sum, sm) => sum + sm.inventory, 0);
        if (kanbanState.history.time.length === 0 || kanbanState.time - kanbanState.history.time[kanbanState.history.time.length - 1] > 1) {
            kanbanState.history.time.push(kanbanState.time);
            kanbanState.history.wip.push(totalWIP);
            if (kanbanState.history.time.length > 500) {
                kanbanState.history.time.shift();
                kanbanState.history.wip.shift();
            }
        }

        // Update visuals
        renderKanbanVisual();
        updateKanbanMetrics();
        if (kanbanState.time > 30) updateKanbanInsights();

    }, tickMs);
}

function resetKanbanSim() {
    kanbanState.running = false;
    if (kanbanState.interval) clearInterval(kanbanState.interval);
    kanbanState.time = 0;
    kanbanState.completed = 0;
    kanbanState.stockouts = 0;
    kanbanState.totalLeadTime = 0;
    kanbanState.customerTimer = 0;
    kanbanState.stations = [];
    kanbanState.supermarkets = [];
    kanbanState.history = { time: [], wip: [] };
    document.getElementById('ks-start').innerHTML = '&#9654; Start';
    document.getElementById('ks-wip').textContent = '0';
    document.getElementById('ks-throughput').innerHTML = '0<span class="calc-result-unit">/hr</span>';
    document.getElementById('ks-leadtime').innerHTML = '0<span class="calc-result-unit">sec</span>';
    document.getElementById('ks-stockouts').textContent = '0';
    document.getElementById('ks-line').innerHTML = '<div style="color:var(--text-dim);font-size:13px;">Press Start to begin simulation</div>';
    document.getElementById('ks-insights').innerHTML = '<em>Start simulation to generate insights...</em>';
    Plotly.purge('ks-chart');
}

function renderKanbanVisual() {
    const container = document.getElementById('ks-line');
    const mode = kanbanState.mode;
    const kCards = parseInt(document.getElementById('ks-kanban-cards').value) || 3;
    let html = '';

    // Supplier
    html += '<div style="text-align:center; min-width:60px;"><div style="font-size:18px;">&#x1F69A;</div><div style="font-size:10px; color:var(--text-dim);">Supplier</div></div>';

    for (let i = 0; i < kanbanStations.length; i++) {
        const sm = kanbanState.supermarkets[i];
        const stn = kanbanState.stations[i];
        if (!stn) continue;

        // Supermarket / WIP buffer
        if (i === 0 && mode === 'push') {
            html += '<div style="text-align:center; min-width:30px; font-size:10px; color:var(--text-dim);">&#x2192;</div>';
        } else {
            const fill = mode === 'pull' ? Math.min(100, (sm.inventory / kCards) * 100) : Math.min(100, sm.inventory * 10);
            const invDisplay = mode === 'pull' ? `${sm.inventory}/${kCards}` : sm.inventory;
            html += `<div style="text-align:center; min-width:50px;">
                <div style="width:40px; height:30px; margin:0 auto; border-left:2px solid var(--border); border-right:2px solid var(--border); border-bottom:2px solid var(--border); position:relative; clip-path:polygon(20% 0%, 80% 0%, 100% 100%, 0% 100%);">
                    <div style="position:absolute; bottom:0; left:0; right:0; height:${fill}%; background:${mode === 'pull' ? 'rgba(74,159,110,0.4)' : 'rgba(231,76,60,0.4)'}; transition:height 0.2s;"></div>
                </div>
                <div style="font-size:10px; color:var(--text-dim); margin-top:2px;">${invDisplay}</div>
            </div>`;
        }

        // Station
        const stateColor = stn.state === 'working' ? '#27ae60' : stn.state === 'blocked' ? '#f39c12' : '#666';
        const stateBg = stn.state === 'working' ? 'rgba(39,174,96,0.15)' : stn.state === 'blocked' ? 'rgba(243,156,18,0.15)' : 'rgba(100,100,100,0.1)';
        html += `<div style="text-align:center; min-width:80px;">
            <div style="padding:10px 8px; border:2px solid ${stateColor}; border-radius:8px; background:${stateBg}; transition:all 0.2s;">
                <div style="font-size:12px; font-weight:600; color:var(--text-primary);">${kanbanStations[i].name}</div>
                <div style="font-size:10px; color:${stateColor}; margin-top:2px; text-transform:uppercase;">${stn.state}</div>
            </div>
        </div>`;
    }

    // Last supermarket (finished goods)
    const lastSM = kanbanState.supermarkets[kanbanStations.length];
    if (lastSM) {
        const fill = mode === 'pull' ? Math.min(100, (lastSM.inventory / kCards) * 100) : Math.min(100, lastSM.inventory * 10);
        const invDisplay = mode === 'pull' ? `${lastSM.inventory}/${kCards}` : lastSM.inventory;
        html += `<div style="text-align:center; min-width:50px;">
            <div style="width:40px; height:30px; margin:0 auto; border-left:2px solid var(--border); border-right:2px solid var(--border); border-bottom:2px solid var(--border); position:relative; clip-path:polygon(20% 0%, 80% 0%, 100% 100%, 0% 100%);">
                <div style="position:absolute; bottom:0; left:0; right:0; height:${fill}%; background:${mode === 'pull' ? 'rgba(74,159,110,0.4)' : 'rgba(231,76,60,0.4)'}; transition:height 0.2s;"></div>
            </div>
            <div style="font-size:10px; color:var(--text-dim); margin-top:2px;">${invDisplay}</div>
        </div>`;
    }

    // Customer
    html += '<div style="text-align:center; min-width:60px;"><div style="font-size:18px;">&#x1F464;</div><div style="font-size:10px; color:var(--text-dim);">Customer</div></div>';

    // Kanban return path (pull mode)
    if (mode === 'pull') {
        html += '<div style="position:absolute; bottom:-18px; left:80px; right:80px; border-bottom:1px dashed var(--accent); height:1px;"></div>';
    }

    container.style.position = 'relative';
    container.innerHTML = html;
}

function updateKanbanMetrics() {
    const totalWIP = kanbanState.supermarkets.slice(1).reduce((sum, sm) => sum + sm.inventory, 0);
    const elapsed = kanbanState.time / 3600; // hours
    const throughput = elapsed > 0 ? (kanbanState.completed / elapsed) : 0;

    document.getElementById('ks-wip').textContent = totalWIP;
    document.getElementById('ks-throughput').innerHTML = `${throughput.toFixed(1)}<span class="calc-result-unit">/hr</span>`;
    const avgLT = kanbanState.completed > 0 ? (kanbanState.totalLeadTime / kanbanState.completed) : 0;
    document.getElementById('ks-leadtime').innerHTML = `${avgLT.toFixed(0)}<span class="calc-result-unit">sec</span>`;
    document.getElementById('ks-stockouts').textContent = kanbanState.stockouts;

    // Update chart every 10 data points
    if (kanbanState.history.time.length % 5 === 0 && kanbanState.history.time.length > 0) {
        Plotly.react('ks-chart', [{
            x: kanbanState.history.time.map(t => (t / 60).toFixed(1)),
            y: kanbanState.history.wip,
            type: 'scatter', mode: 'lines', fill: 'tozeroy',
            fillcolor: kanbanState.mode === 'pull' ? 'rgba(74,159,110,0.2)' : 'rgba(231,76,60,0.2)',
            line: { color: kanbanState.mode === 'pull' ? '#4a9f6e' : '#e74c3c', width: 2 },
            name: 'WIP'
        }], {
            margin: { t: 10, b: 40, l: 40, r: 10 },
            paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
            font: { color: '#9aaa9a' },
            xaxis: { title: 'Time (min)', gridcolor: 'rgba(255,255,255,0.1)' },
            yaxis: { title: 'WIP (units)', gridcolor: 'rgba(255,255,255,0.1)' },
            showlegend: false
        }, { responsive: true, displayModeBar: false });
    }
}

function updateKanbanInsights() {
    const container = document.getElementById('ks-insights');
    if (!container) return;

    const mode = kanbanState.mode;
    const kCards = parseInt(document.getElementById('ks-kanban-cards').value) || 3;
    const nStations = kanbanStations.length;
    const totalWIP = kanbanState.supermarkets.slice(1).reduce((sum, sm) => sum + sm.inventory, 0);
    const elapsedHrs = kanbanState.time / 3600;
    const throughput = elapsedHrs > 0 ? (kanbanState.completed / elapsedHrs) : 0;

    // Station analysis
    let mostBlocked = { idx: -1, time: 0 };
    let mostStarved = { idx: -1, time: 0 };
    kanbanState.stations.forEach((stn, i) => {
        if (stn.blockedTime > mostBlocked.time) { mostBlocked = { idx: i, time: stn.blockedTime }; }
        if (stn.starvedTime > mostStarved.time) { mostStarved = { idx: i, time: stn.starvedTime }; }
    });

    // Find actual bottleneck (slowest station by cycle time)
    let slowestIdx = 0, slowestCT = 0;
    kanbanStations.forEach((s, i) => { if (s.cycleTime > slowestCT) { slowestCT = s.cycleTime; slowestIdx = i; } });
    const theoreticalThroughput = 3600 / slowestCT;

    // Analysis column
    let analysisHtml = '';
    analysisHtml += `<div style="margin-bottom:4px;"><strong>Mode:</strong> ${mode === 'pull' ? 'PULL (kanban-controlled)' : 'PUSH (unlimited WIP)'}</div>`;
    analysisHtml += `<div style="margin-bottom:4px;"><strong>Total WIP:</strong> ${totalWIP} units</div>`;
    analysisHtml += `<div style="margin-bottom:4px;"><strong>Throughput:</strong> ${throughput.toFixed(1)}/hr (theoretical max: ${theoreticalThroughput.toFixed(1)}/hr)</div>`;
    analysisHtml += `<div style="margin-bottom:4px;"><strong>Constraint:</strong> ${kanbanStations[slowestIdx].name} (CT: ${slowestCT}s)</div>`;
    if (kanbanState.stockouts > 0) {
        analysisHtml += `<div style="margin-bottom:4px; color:#e74c3c;"><strong>Stockouts:</strong> ${kanbanState.stockouts} — customer waited for product</div>`;
    }

    // Improvement column
    let improvHtml = '';
    if (mode === 'push') {
        improvHtml += `<div style="color:#e74c3c; margin-bottom:4px;">&#x26A0; PUSH mode: WIP is ${totalWIP} units and growing</div>`;
        improvHtml += `<div style="margin-bottom:4px;">&#x1F4A1; Switch to PULL to cap WIP at ~${kCards * nStations} units (${kCards} cards × ${nStations} loops)</div>`;
        if (totalWIP > kCards * nStations * 3) {
            improvHtml += `<div style="margin-bottom:4px;">&#x1F4C9; WIP is ${(totalWIP / (kCards * nStations)).toFixed(0)}x higher than pull-mode equivalent</div>`;
        }
    } else {
        const wipTarget = kCards * nStations;
        if (totalWIP <= wipTarget) {
            improvHtml += `<div style="color:#27ae60; margin-bottom:4px;">&#x2705; WIP controlled at ${totalWIP}/${wipTarget} max capacity</div>`;
        }
        if (kanbanState.stockouts > 0 && kanbanState.stockouts > kanbanState.completed * 0.05) {
            improvHtml += `<div style="color:#f39c12; margin-bottom:4px;">&#x26A0; Stockout rate ${((kanbanState.stockouts / (kanbanState.completed + kanbanState.stockouts)) * 100).toFixed(1)}% — consider adding kanban cards or reducing cycle times</div>`;
        } else if (kanbanState.stockouts === 0 && kanbanState.time > 120) {
            improvHtml += `<div style="color:#27ae60; margin-bottom:4px;">&#x2705; Zero stockouts — pull system is meeting demand</div>`;
        }
        if (mostBlocked.time > kanbanState.time * 0.1) {
            improvHtml += `<div style="margin-bottom:4px;">&#x1F6AB; ${kanbanStations[mostBlocked.idx].name} blocked ${((mostBlocked.time / kanbanState.time) * 100).toFixed(0)}% of the time — downstream can't keep up</div>`;
        }
        if (mostStarved.time > kanbanState.time * 0.15) {
            improvHtml += `<div style="margin-bottom:4px;">&#x23F3; ${kanbanStations[mostStarved.idx].name} starved ${((mostStarved.time / kanbanState.time) * 100).toFixed(0)}% — upstream supermarket emptying faster than replenished</div>`;
        }
    }

    // General insights
    const covVal = parseInt(document.getElementById('ks-cov').value);
    if (covVal > 30) {
        const lostPct = ((1 - throughput / theoreticalThroughput) * 100);
        if (lostPct > 10) {
            improvHtml += `<div style="margin-bottom:4px;">&#x1F4C9; High variability (${covVal}%) costing ~${lostPct.toFixed(0)}% throughput — standardize work to reduce CoV</div>`;
        }
    }

    if (!improvHtml) {
        improvHtml = `<div>&#x1F4A1; System running well. Try increasing variability or reducing kanban cards to stress-test.</div>`;
    }

    container.innerHTML = `
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
            <div>
                <div style="font-weight:600; color:var(--text-primary); margin-bottom:8px;">System Analysis</div>
                ${analysisHtml}
            </div>
            <div>
                <div style="font-weight:600; color:var(--text-primary); margin-bottom:8px;">Improvement Opportunities</div>
                ${improvHtml}
            </div>
        </div>
    `;
}

// Init kanban station inputs
if (document.getElementById('ks-stations')) renderKanbanStations();

// ============================================================================
// Beer Game — Bullwhip Effect Simulator
// ============================================================================

const beerTiers = ['Factory', 'Distributor', 'Wholesaler', 'Retailer'];
const beerIcons = ['&#x1F3ED;', '&#x1F4E6;', '&#x1F3EA;', '&#x1F6D2;'];

const beerState = {
    running: false,
    interval: null,
    week: 0,
    tiers: [],
    history: { week: [], demand: [] },
    totalCost: 0,
};

function initBeerTiers() {
    const target = parseInt(document.getElementById('bg-target').value) || 12;
    beerState.tiers = beerTiers.map((name, i) => ({
        name,
        inventory: target,
        backlog: 0,
        pipeline: [],          // [{qty, weeksLeft}]
        lastOrder: 0,
        orderHistory: [],
        inventoryHistory: [],
    }));
    beerState.history = { week: [], demand: [] };
    beerState.totalCost = 0;
    beerState.week = 0;
}

function getBeerDemand(week) {
    const pattern = document.getElementById('bg-demand').value;
    switch (pattern) {
        case 'constant': return 4;
        case 'step': return week < 5 ? 4 : 8;
        case 'seasonal': return Math.max(1, Math.round(4 + 3 * Math.sin(week * Math.PI / 12)));
        case 'random': return Math.floor(Math.random() * 5) + 2;
        default: return 4;
    }
}

function startBeerGame() {
    if (beerState.running) {
        beerState.running = false;
        clearInterval(beerState.interval);
        document.getElementById('bg-start').innerHTML = '&#9654; Resume';
        return;
    }

    beerState.running = true;
    document.getElementById('bg-start').innerHTML = '&#9208; Pause';

    if (beerState.week === 0) initBeerTiers();

    const tickMs = 100;
    beerState.interval = setInterval(() => {
        const speed = parseInt(document.getElementById('bg-speed').value) || 4;
        // Slow down: only advance a week every N ticks
        const ticksPerWeek = Math.max(1, Math.round(10 / speed));
        if (!beerState._tickCount) beerState._tickCount = 0;
        beerState._tickCount++;
        if (beerState._tickCount < ticksPerWeek) {
            return;
        }
        beerState._tickCount = 0;

        beerState.week++;
        const leadTime = parseInt(document.getElementById('bg-leadtime').value) || 2;
        const policy = document.getElementById('bg-policy').value;
        const target = parseInt(document.getElementById('bg-target').value) || 12;
        const demand = getBeerDemand(beerState.week);

        // Record demand
        beerState.history.week.push(beerState.week);
        beerState.history.demand.push(demand);

        // Process each tier from downstream (retailer) to upstream (factory)
        for (let i = beerTiers.length - 1; i >= 0; i--) {
            const tier = beerState.tiers[i];

            // 1. Receive incoming shipments
            const arrived = [];
            const pending = [];
            for (const p of tier.pipeline) {
                p.weeksLeft--;
                if (p.weeksLeft <= 0) arrived.push(p);
                else pending.push(p);
            }
            tier.pipeline = pending;
            const received = arrived.reduce((sum, p) => sum + p.qty, 0);
            tier.inventory += received;

            // 2. Determine incoming demand
            let incomingDemand;
            if (i === beerTiers.length - 1) {
                incomingDemand = demand; // retailer faces customer demand
            } else {
                incomingDemand = beerState.tiers[i + 1].lastOrder;
            }

            // 3. Fill orders (demand + backlog)
            const totalDemand = incomingDemand + tier.backlog;
            const shipped = Math.min(tier.inventory, totalDemand);
            tier.inventory -= shipped;
            tier.backlog = totalDemand - shipped;

            // Ship downstream (into downstream tier's pipeline)
            if (i < beerTiers.length - 1) {
                // This represents what we actually ship to the tier that ordered from us
            }

            // 4. Place upstream order
            let orderQty;
            if (policy === 'match-demand') {
                orderQty = incomingDemand;
            } else {
                // Order-up-to: order enough to bring inventory position back to target
                const inventoryPosition = tier.inventory - tier.backlog + tier.pipeline.reduce((s, p) => s + p.qty, 0);
                orderQty = Math.max(0, target + incomingDemand - inventoryPosition);
            }
            tier.lastOrder = orderQty;
            tier.orderHistory.push(orderQty);
            tier.inventoryHistory.push(tier.inventory - tier.backlog);

            // Place order into upstream pipeline
            if (i > 0) {
                // Order goes to upstream tier — they'll see it as incomingDemand next week
                beerState.tiers[i - 1].pipeline.push({ qty: Math.min(orderQty, beerState.tiers[i - 1].inventory + 10), weeksLeft: leadTime });
            } else {
                // Factory: production has lead time but unlimited raw material
                tier.pipeline.push({ qty: orderQty, weeksLeft: leadTime });
            }

            // 5. Costs
            beerState.totalCost += tier.inventory * 0.5; // holding
            beerState.totalCost += tier.backlog * 1.0;   // backlog
        }

        // Update visuals
        renderBeerVisual();
        updateBeerMetrics();
        updateBeerChart();
        if (beerState.week > 3) updateBeerInsights();

    }, tickMs);
}

function resetBeerGame() {
    beerState.running = false;
    if (beerState.interval) clearInterval(beerState.interval);
    beerState.week = 0;
    beerState._tickCount = 0;
    beerState.tiers = [];
    beerState.history = { week: [], demand: [] };
    beerState.totalCost = 0;
    document.getElementById('bg-start').innerHTML = '&#9654; Start';
    document.getElementById('bg-week').textContent = '0';
    document.getElementById('bg-bullwhip').textContent = '—';
    document.getElementById('bg-cost').textContent = '$0';
    document.getElementById('bg-backlog').textContent = '0';
    document.getElementById('bg-avg-inv').textContent = '0';
    document.getElementById('bg-chain').innerHTML = '<div style="color:var(--text-dim);font-size:13px;width:100%;text-align:center;">Press Start to begin simulation</div>';
    document.getElementById('bg-insights').innerHTML = '<em>Start simulation to generate insights...</em>';
    Plotly.purge('bg-chart');
}

function updateBeerParams() {}

function renderBeerVisual() {
    const container = document.getElementById('bg-chain');
    const target = parseInt(document.getElementById('bg-target').value) || 12;
    let html = '';

    for (let i = 0; i < beerTiers.length; i++) {
        const tier = beerState.tiers[i];
        if (!tier) continue;

        const netInv = tier.inventory - tier.backlog;
        const fillPct = Math.min(100, Math.max(0, (tier.inventory / (target * 2)) * 100));
        const invColor = netInv >= 0 ? '#27ae60' : '#e74c3c';
        const invBg = netInv >= 0 ? 'rgba(39,174,96,0.15)' : 'rgba(231,76,60,0.15)';

        html += `<div style="text-align:center; flex:1; min-width:120px;">
            <div style="font-size:28px; margin-bottom:4px;">${beerIcons[i]}</div>
            <div style="font-size:12px; font-weight:600; color:var(--text-primary); margin-bottom:8px;">${tier.name}</div>
            <div style="width:60px; height:50px; margin:0 auto; background:var(--bg-tertiary); border-radius:4px; position:relative; overflow:hidden; border:1px solid var(--border);">
                <div style="position:absolute; bottom:0; left:0; right:0; height:${fillPct}%; background:${invBg}; border-top:2px solid ${invColor}; transition:height 0.3s;"></div>
            </div>
            <div style="font-size:13px; font-weight:600; color:${invColor}; margin-top:4px;">${netInv >= 0 ? netInv : netInv}</div>
            <div style="font-size:9px; color:var(--text-dim);">${netInv >= 0 ? 'inventory' : 'BACKLOG'}</div>
            <div style="font-size:10px; color:var(--text-dim); margin-top:6px; padding:3px 6px; background:var(--bg-tertiary); border-radius:4px; display:inline-block;">Order: ${tier.lastOrder}</div>
        </div>`;

        // Arrow between tiers
        if (i < beerTiers.length - 1) {
            const arrowWidth = Math.min(6, Math.max(1, tier.lastOrder / 3));
            html += `<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-width:30px; gap:4px;">
                <div style="font-size:9px; color:var(--text-dim);">ship</div>
                <div style="width:${20 + arrowWidth * 2}px; height:${arrowWidth}px; background:var(--accent); border-radius:2px; opacity:0.6;"></div>
                <div style="width:${20 + arrowWidth * 2}px; height:${Math.max(1, arrowWidth * 0.7)}px; background:#f39c12; border-radius:2px; opacity:0.4;"></div>
                <div style="font-size:9px; color:var(--text-dim);">order</div>
            </div>`;
        }
    }

    // Customer
    const demand = beerState.history.demand.length > 0 ? beerState.history.demand[beerState.history.demand.length - 1] : 0;
    html += `<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-width:30px;">
        <div style="font-size:9px; color:var(--text-dim);">demand</div>
        <div style="width:20px; height:2px; background:#3498db; border-radius:2px;"></div>
    </div>`;
    html += `<div style="text-align:center; min-width:60px;">
        <div style="font-size:28px;">&#x1F464;</div>
        <div style="font-size:12px; font-weight:600; color:var(--text-primary);">Customer</div>
        <div style="font-size:13px; color:#3498db; font-weight:600; margin-top:4px;">${demand}/wk</div>
    </div>`;

    container.innerHTML = html;
    document.getElementById('bg-week').textContent = beerState.week;
}

function updateBeerMetrics() {
    const totalBacklog = beerState.tiers.reduce((s, t) => s + t.backlog, 0);
    const totalInv = beerState.tiers.reduce((s, t) => s + t.inventory, 0);
    const avgInv = beerState.week > 0 ? (totalInv / beerTiers.length) : 0;

    document.getElementById('bg-cost').textContent = `$${beerState.totalCost.toFixed(0)}`;
    document.getElementById('bg-backlog').textContent = totalBacklog;
    document.getElementById('bg-avg-inv').textContent = avgInv.toFixed(0);

    // Bullwhip ratio: variance of factory orders / variance of customer demand
    if (beerState.history.demand.length > 5) {
        const demandArr = beerState.history.demand;
        const factoryOrders = beerState.tiers[0].orderHistory;
        const variance = (arr) => {
            const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
            return arr.reduce((s, v) => s + (v - mean) ** 2, 0) / arr.length;
        };
        const dVar = variance(demandArr);
        const fVar = variance(factoryOrders);
        const ratio = dVar > 0 ? (fVar / dVar) : 1;
        document.getElementById('bg-bullwhip').textContent = ratio.toFixed(1) + 'x';
    }
}

function updateBeerChart() {
    if (beerState.history.week.length < 2) return;
    const traces = [];
    const colors = ['#e74c3c', '#f39c12', '#9b59b6', '#27ae60'];

    for (let i = 0; i < beerTiers.length; i++) {
        if (beerState.tiers[i]) {
            traces.push({
                x: beerState.history.week,
                y: beerState.tiers[i].orderHistory,
                type: 'scatter', mode: 'lines',
                name: beerTiers[i],
                line: { color: colors[i], width: 2 },
            });
        }
    }

    // Customer demand baseline
    traces.push({
        x: beerState.history.week,
        y: beerState.history.demand,
        type: 'scatter', mode: 'lines',
        name: 'Customer Demand',
        line: { color: '#3498db', width: 2, dash: 'dot' },
    });

    Plotly.react('bg-chart', traces, {
        margin: { t: 10, b: 40, l: 40, r: 10 },
        paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
        font: { color: '#9aaa9a', size: 10 },
        xaxis: { title: 'Week', gridcolor: 'rgba(255,255,255,0.1)' },
        yaxis: { title: 'Units Ordered', gridcolor: 'rgba(255,255,255,0.1)' },
        legend: { orientation: 'h', y: -0.25, font: { size: 10 } },
        showlegend: true,
    }, { responsive: true, displayModeBar: false });
}

function updateBeerInsights() {
    const container = document.getElementById('bg-insights');
    if (!container || beerState.tiers.length === 0) return;

    const policy = document.getElementById('bg-policy').value;
    const leadTime = parseInt(document.getElementById('bg-leadtime').value) || 2;
    const demandPattern = document.getElementById('bg-demand').value;
    const target = parseInt(document.getElementById('bg-target').value) || 12;

    const variance = (arr) => {
        if (arr.length < 2) return 0;
        const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
        return arr.reduce((s, v) => s + (v - mean) ** 2, 0) / arr.length;
    };

    const demandVar = variance(beerState.history.demand);
    const tierVars = beerState.tiers.map(t => variance(t.orderHistory));
    const tierBullwhip = tierVars.map(v => demandVar > 0 ? v / demandVar : 1);

    // Find worst amplifier
    let worstTier = 0, worstRatio = 0;
    tierBullwhip.forEach((r, i) => { if (r > worstRatio) { worstRatio = r; worstTier = i; } });

    const totalBacklog = beerState.tiers.reduce((s, t) => s + t.backlog, 0);
    const totalInv = beerState.tiers.reduce((s, t) => s + t.inventory, 0);
    const holdingCostPct = totalInv > 0 ? (totalInv * 0.5 / (totalInv * 0.5 + totalBacklog * 1.0) * 100) : 50;

    // Analysis
    let analysisHtml = '';
    analysisHtml += `<div style="margin-bottom:4px;"><strong>Week:</strong> ${beerState.week} &nbsp; <strong>Pattern:</strong> ${demandPattern} &nbsp; <strong>Policy:</strong> ${policy === 'match-demand' ? 'match demand' : 'order-up-to'}</div>`;
    analysisHtml += `<div style="margin-bottom:4px;"><strong>Lead time:</strong> ${leadTime} weeks per tier (${leadTime * 4} weeks end-to-end round-trip)</div>`;
    analysisHtml += `<div style="margin-bottom:4px;"><strong>Demand variance:</strong> ${demandVar.toFixed(1)}</div>`;
    for (let i = 0; i < beerTiers.length; i++) {
        const ratio = tierBullwhip[i];
        const color = ratio > 3 ? '#e74c3c' : ratio > 1.5 ? '#f39c12' : '#27ae60';
        analysisHtml += `<div style="margin-bottom:2px;"><strong>${beerTiers[i]}:</strong> order variance ${tierVars[i].toFixed(1)} → <span style="color:${color}; font-weight:600;">${ratio.toFixed(1)}x amplification</span></div>`;
    }
    analysisHtml += `<div style="margin-bottom:4px; margin-top:4px;"><strong>Total SC cost:</strong> $${beerState.totalCost.toFixed(0)} (${holdingCostPct.toFixed(0)}% holding / ${(100 - holdingCostPct).toFixed(0)}% backlog)</div>`;

    // Improvements
    let improvHtml = '';

    if (worstRatio > 3) {
        improvHtml += `<div style="color:#e74c3c; margin-bottom:4px;">&#x26A0; ${beerTiers[worstTier]} amplifying demand ${worstRatio.toFixed(1)}x — classic bullwhip</div>`;
    }

    if (policy === 'match-demand' && worstRatio > 2) {
        improvHtml += `<div style="margin-bottom:4px;">&#x1F4A1; "Match demand" policy amplifies signals — try "Order-up-to" for smoothing</div>`;
    }

    if (leadTime >= 3) {
        improvHtml += `<div style="margin-bottom:4px;">&#x1F4A1; ${leadTime}-week lead time amplifies bullwhip — reducing to ${leadTime - 1} weeks would help significantly</div>`;
    }

    if (demandPattern === 'step' && beerState.week > 8 && beerState.week < 20) {
        improvHtml += `<div style="margin-bottom:4px;">&#x1F4CA; Step change at week 5 still rippling through the chain — the system won't stabilize for ~${leadTime * 4 + 5} weeks</div>`;
    }

    if (totalBacklog > target * 2) {
        improvHtml += `<div style="color:#e74c3c; margin-bottom:4px;">&#x1F6A8; Total backlog (${totalBacklog}) exceeds ${(totalBacklog / target * 100 / beerTiers.length).toFixed(0)}% of target — service level degraded</div>`;
    }

    // Check if factory is over-ordering
    const factoryOrders = beerState.tiers[0].orderHistory;
    const recentDemand = beerState.history.demand.slice(-5);
    if (factoryOrders.length >= 5) {
        const recentOrders = factoryOrders.slice(-5);
        const avgOrder = recentOrders.reduce((a, b) => a + b, 0) / recentOrders.length;
        const avgDemand = recentDemand.reduce((a, b) => a + b, 0) / recentDemand.length;
        if (avgOrder > avgDemand * 1.8) {
            improvHtml += `<div style="margin-bottom:4px;">&#x1F3ED; Factory ordering ${avgOrder.toFixed(0)}/wk vs ${avgDemand.toFixed(0)}/wk customer demand — over-reaction building excess inventory</div>`;
        }
    }

    if (policy === 'order-up-to' && worstRatio < 1.5 && beerState.week > 15) {
        improvHtml += `<div style="color:#27ae60; margin-bottom:4px;">&#x2705; Order-up-to policy keeping bullwhip under control — ratio ${worstRatio.toFixed(1)}x</div>`;
    }

    // Countermeasures
    improvHtml += `<div style="margin-top:8px; padding-top:8px; border-top:1px solid var(--border);">`;
    improvHtml += `<div style="font-weight:600; margin-bottom:4px;">Countermeasures to try:</div>`;
    improvHtml += `<div style="margin-bottom:2px;">&#x2022; Share POS data upstream (information visibility)</div>`;
    improvHtml += `<div style="margin-bottom:2px;">&#x2022; Reduce lead time (compress the chain)</div>`;
    improvHtml += `<div style="margin-bottom:2px;">&#x2022; Smaller, more frequent orders (EPEI reduction)</div>`;
    improvHtml += `</div>`;

    container.innerHTML = `
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
            <div>
                <div style="font-weight:600; color:var(--text-primary); margin-bottom:8px;">Bullwhip Analysis</div>
                ${analysisHtml}
            </div>
            <div>
                <div style="font-weight:600; color:var(--text-primary); margin-bottom:8px;">Improvement Opportunities</div>
                ${improvHtml}
            </div>
        </div>
    `;
}

// ============================================================================
// TOC / Drum-Buffer-Rope Simulator
// ============================================================================

const tocStationsData = [
    { name: 'Station 1', capacity: 10 },
    { name: 'Station 2', capacity: 12 },
    { name: 'Station 3', capacity: 7 },
    { name: 'Station 4', capacity: 11 },
    { name: 'Station 5', capacity: 9 },
];

const tocState = {
    running: false,
    interval: null,
    mode: 'dbr',
    time: 0,
    completed: 0,
    stations: [],
    buffers: [],       // WIP between stations
    constraintIdx: -1,
    drumBuffer: 0,     // WIP in the buffer before constraint
    gateOpen: true,
    history: { time: [], wip: [], throughput: [] },
    constraintWorkingTime: 0,
};

function findConstraint() {
    let minCap = Infinity, minIdx = 0;
    for (let i = 0; i < tocStationsData.length; i++) {
        if (tocStationsData[i].capacity < minCap) {
            minCap = tocStationsData[i].capacity;
            minIdx = i;
        }
    }
    return minIdx;
}

function renderTocStations() {
    const el = document.getElementById('toc-stations');
    if (!el) return;
    const constraintIdx = findConstraint();
    el.innerHTML = tocStationsData.map((s, i) => `
        <div style="display:flex; align-items:center; gap:8px;">
            <input type="text" value="${s.name}" style="flex:1; padding:8px; background:var(--bg-secondary); border:1px solid var(--border); border-radius:6px; color:var(--text-primary);" oninput="tocStationsData[${i}].name=this.value">
            <input type="number" value="${s.capacity}" style="width:70px; text-align:right; padding:8px; background:var(--bg-secondary); border:1px solid ${i === constraintIdx ? '#e74c3c' : 'var(--border)'}; border-radius:6px; color:var(--text-primary);" oninput="tocStationsData[${i}].capacity=parseFloat(this.value)||1; renderTocStations()">
            <span style="color:var(--text-dim); font-size:12px; min-width:40px;">/hr${i === constraintIdx ? ' &#x1F941;' : ''}</span>
        </div>
    `).join('');
}

function setTocMode(mode) {
    tocState.mode = mode;
    const unBtn = document.getElementById('toc-mode-uncontrolled');
    const dbrBtn = document.getElementById('toc-mode-dbr');
    if (mode === 'uncontrolled') {
        unBtn.style.background = 'rgba(231,76,60,0.2)';
        unBtn.style.color = '#e74c3c';
        dbrBtn.style.background = 'var(--bg-secondary)';
        dbrBtn.style.color = 'var(--text-dim)';
    } else {
        dbrBtn.style.background = 'rgba(74,159,110,0.2)';
        dbrBtn.style.color = 'var(--accent)';
        unBtn.style.background = 'var(--bg-secondary)';
        unBtn.style.color = 'var(--text-dim)';
    }
}

function updateTocParams() {}

function startTocSim() {
    if (tocState.running) {
        tocState.running = false;
        clearInterval(tocState.interval);
        document.getElementById('toc-start').innerHTML = '&#9654; Resume';
        return;
    }

    tocState.running = true;
    document.getElementById('toc-start').innerHTML = '&#9208; Pause';

    const n = tocStationsData.length;
    tocState.constraintIdx = findConstraint();

    // Initialize on first run
    if (tocState.time === 0) {
        tocState.stations = tocStationsData.map((s) => ({
            state: 'starved',
            timeRemaining: 0,
            processed: 0,
            workingTime: 0,
            starvedTime: 0,
            blockedTime: 0,
        }));
        tocState.buffers = new Array(n + 1).fill(0); // buffer[0] = raw material, buffer[i] = between station i-1 and i
        tocState.buffers[0] = 50; // raw material
        tocState.drumBuffer = 0;
        tocState.completed = 0;
        tocState.constraintWorkingTime = 0;
        tocState.history = { time: [], wip: [], throughput: [] };
    }

    const tickMs = 100;
    tocState.interval = setInterval(() => {
        const speed = parseInt(document.getElementById('toc-speed').value) || 5;
        const cov = parseInt(document.getElementById('toc-cov').value) / 100;
        const bufferTarget = parseInt(document.getElementById('toc-buffer-size').value) || 5;
        const dt = speed * 0.5; // sim seconds per tick
        const mode = tocState.mode;
        const ci = tocState.constraintIdx;

        tocState.time += dt;

        // Convert capacity from units/hr to seconds/unit for cycle time
        // Process each station
        for (let i = 0; i < n; i++) {
            const stn = tocState.stations[i];
            const cap = tocStationsData[i].capacity;
            const baseCT = 3600 / cap; // seconds per unit

            if (stn.state === 'working') {
                stn.timeRemaining -= dt;
                stn.workingTime += dt;
                if (i === ci) tocState.constraintWorkingTime += dt;
                if (stn.timeRemaining <= 0) {
                    // Finished: try to place in downstream buffer
                    tocState.buffers[i + 1]++;
                    stn.processed++;
                    stn.state = 'starved'; // look for next unit
                }
            }

            if (stn.state === 'starved') {
                // Can we get material?
                let canStart = false;

                if (i === 0) {
                    // First station: check release gate
                    if (mode === 'dbr') {
                        // Rope: only release if buffer before constraint is below target
                        const bufBeforeConstraint = tocState.buffers[ci];
                        tocState.gateOpen = bufBeforeConstraint < bufferTarget;
                        if (tocState.gateOpen && tocState.buffers[0] > 0) {
                            tocState.buffers[0]--;
                            canStart = true;
                        }
                    } else {
                        // Uncontrolled: always release
                        tocState.gateOpen = true;
                        tocState.buffers[0] = 50; // infinite raw material
                        canStart = true;
                    }
                } else {
                    // Other stations: pull from upstream buffer
                    if (tocState.buffers[i] > 0) {
                        tocState.buffers[i]--;
                        canStart = true;
                    }
                }

                if (canStart) {
                    const actualCT = Math.max(baseCT * 0.3, baseCT * (1 + boxNormalRandom() * cov));
                    stn.timeRemaining = actualCT;
                    stn.state = 'working';
                } else {
                    stn.starvedTime += dt;
                }
            }
        }

        // Count output (last buffer)
        const outputBuffer = tocState.buffers[n];
        if (outputBuffer > 0) {
            tocState.completed += outputBuffer;
            tocState.buffers[n] = 0;
        }

        // In uncontrolled mode, keep raw material available
        if (mode === 'uncontrolled') {
            tocState.buffers[0] = 50;
        }

        // Record history
        const totalWIP = tocState.buffers.slice(1, n).reduce((s, v) => s + v, 0);
        const elapsedHrs = tocState.time / 3600;
        const throughput = elapsedHrs > 0 ? tocState.completed / elapsedHrs : 0;

        if (tocState.history.time.length === 0 || tocState.time - tocState.history.time[tocState.history.time.length - 1] > 1) {
            tocState.history.time.push(tocState.time);
            tocState.history.wip.push(totalWIP);
            tocState.history.throughput.push(throughput);
            if (tocState.history.time.length > 500) {
                tocState.history.time.shift();
                tocState.history.wip.shift();
                tocState.history.throughput.shift();
            }
        }

        renderTocVisual();
        updateTocMetrics();
        if (tocState.time > 30) updateTocInsights();

    }, tickMs);
}

function resetTocSim() {
    tocState.running = false;
    if (tocState.interval) clearInterval(tocState.interval);
    tocState.time = 0;
    tocState.completed = 0;
    tocState.constraintWorkingTime = 0;
    tocState.stations = [];
    tocState.buffers = [];
    tocState.history = { time: [], wip: [], throughput: [] };
    document.getElementById('toc-start').innerHTML = '&#9654; Start';
    document.getElementById('toc-throughput').innerHTML = '0<span class="calc-result-unit">/hr</span>';
    document.getElementById('toc-wip').textContent = '0';
    document.getElementById('toc-util').innerHTML = '0<span class="calc-result-unit">%</span>';
    document.getElementById('toc-leadtime').innerHTML = '0<span class="calc-result-unit">sec</span>';
    document.getElementById('toc-line').innerHTML = '<div style="color:var(--text-dim);font-size:13px;">Press Start to begin simulation</div>';
    document.getElementById('toc-insights').innerHTML = '<em>Start simulation to generate insights...</em>';
    Plotly.purge('toc-chart');
}

function renderTocVisual() {
    const container = document.getElementById('toc-line');
    const n = tocStationsData.length;
    const ci = tocState.constraintIdx;
    const mode = tocState.mode;
    const bufferTarget = parseInt(document.getElementById('toc-buffer-size').value) || 5;
    let html = '';

    // Release Gate
    const gateColor = tocState.gateOpen ? '#27ae60' : '#e74c3c';
    if (mode === 'dbr') {
        html += `<div style="text-align:center; min-width:50px;">
            <div style="width:30px; height:30px; margin:0 auto; border:2px solid ${gateColor}; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:14px; background:${tocState.gateOpen ? 'rgba(39,174,96,0.15)' : 'rgba(231,76,60,0.15)'};">
                ${tocState.gateOpen ? '&#x1F7E2;' : '&#x1F534;'}
            </div>
            <div style="font-size:9px; color:var(--text-dim); margin-top:2px;">GATE</div>
        </div>`;
    } else {
        html += `<div style="text-align:center; min-width:40px;">
            <div style="font-size:14px;">&#x27A1;</div>
            <div style="font-size:9px; color:var(--text-dim);">IN</div>
        </div>`;
    }

    for (let i = 0; i < n; i++) {
        const stn = tocState.stations[i];
        if (!stn) continue;

        // Buffer before this station (skip buffer[0] which is raw material)
        if (i > 0) {
            const bufCount = tocState.buffers[i];
            const isConstraintBuffer = (i === ci && mode === 'dbr');
            const dotCount = Math.min(10, bufCount);
            const dots = Array(dotCount).fill(0).map(() =>
                `<div style="width:8px;height:8px;border-radius:50%;background:${isConstraintBuffer ? '#f39c12' : '#3498db'};display:inline-block;margin:1px;"></div>`
            ).join('');

            html += `<div style="text-align:center; min-width:40px; max-width:60px;">
                <div style="min-height:24px; display:flex; flex-wrap:wrap; justify-content:center; align-items:center; gap:0;">${dots}</div>
                <div style="font-size:10px; color:var(--text-dim);">${bufCount}${isConstraintBuffer ? '/' + bufferTarget : ''}</div>
                ${isConstraintBuffer ? '<div style="font-size:8px; color:#f39c12; font-weight:600;">BUFFER</div>' : ''}
            </div>`;
        }

        // Station
        const isConstraint = (i === ci);
        const cap = tocStationsData[i].capacity;
        const utilPct = tocState.time > 0 ? (stn.workingTime / tocState.time * 100) : 0;
        const utilColor = utilPct > 95 ? '#e74c3c' : utilPct > 80 ? '#f39c12' : '#27ae60';
        const stateColor = stn.state === 'working' ? '#27ae60' : stn.state === 'starved' ? '#888' : '#f39c12';
        const borderColor = isConstraint ? '#e74c3c' : stateColor;
        const borderWidth = isConstraint ? '3px' : '2px';

        html += `<div style="text-align:center; min-width:80px;">
            <div style="padding:8px 6px; border:${borderWidth} solid ${borderColor}; border-radius:8px; background:${stn.state === 'working' ? 'rgba(39,174,96,0.1)' : 'rgba(100,100,100,0.05)'}; transition:all 0.2s; ${isConstraint ? 'box-shadow:0 0 8px rgba(231,76,60,0.3);' : ''}">
                ${isConstraint ? '<div style="font-size:10px; font-weight:700; color:#e74c3c; margin-bottom:2px;">&#x1F941; DRUM</div>' : ''}
                <div style="font-size:11px; font-weight:600; color:var(--text-primary);">${tocStationsData[i].name}</div>
                <div style="font-size:10px; color:var(--text-dim);">${cap}/hr</div>
                <div style="font-size:9px; color:${stateColor}; text-transform:uppercase; margin-top:2px;">${stn.state}</div>
            </div>
        </div>`;
    }

    // Output
    html += `<div style="text-align:center; min-width:50px;">
        <div style="font-size:14px;">&#x2705;</div>
        <div style="font-size:10px; color:var(--text-dim);">OUT: ${tocState.completed}</div>
    </div>`;

    // Rope visualization (DBR mode)
    if (mode === 'dbr') {
        html += `<div style="position:absolute; bottom:-20px; left:50px; right:100px; border-bottom:2px dashed var(--accent); opacity:0.4;"></div>
        <div style="position:absolute; bottom:-28px; left:50%; transform:translateX(-50%); font-size:9px; color:var(--accent); font-weight:600; letter-spacing:1px;">ROPE</div>`;
    }

    container.style.position = 'relative';
    container.innerHTML = html;
}

function updateTocMetrics() {
    const n = tocStationsData.length;
    const totalWIP = tocState.buffers.slice(1, n).reduce((s, v) => s + v, 0);
    const elapsedHrs = tocState.time / 3600;
    const throughput = elapsedHrs > 0 ? tocState.completed / elapsedHrs : 0;
    const constraintUtil = tocState.time > 0 ? (tocState.constraintWorkingTime / tocState.time * 100) : 0;

    document.getElementById('toc-wip').textContent = totalWIP;
    document.getElementById('toc-throughput').innerHTML = `${throughput.toFixed(1)}<span class="calc-result-unit">/hr</span>`;
    document.getElementById('toc-util').innerHTML = `${constraintUtil.toFixed(0)}<span class="calc-result-unit">%</span>`;

    // Simplified lead time: WIP / throughput (Little's Law)
    const lt = throughput > 0 ? (totalWIP / throughput * 3600) : 0;
    document.getElementById('toc-leadtime').innerHTML = `${lt.toFixed(0)}<span class="calc-result-unit">sec</span>`;

    // Chart
    if (tocState.history.time.length % 5 === 0 && tocState.history.time.length > 0) {
        Plotly.react('toc-chart', [{
            x: tocState.history.time.map(t => (t / 60).toFixed(1)),
            y: tocState.history.wip,
            type: 'scatter', mode: 'lines', fill: 'tozeroy',
            fillcolor: tocState.mode === 'dbr' ? 'rgba(74,159,110,0.15)' : 'rgba(231,76,60,0.15)',
            line: { color: tocState.mode === 'dbr' ? '#4a9f6e' : '#e74c3c', width: 2 },
            name: 'WIP', yaxis: 'y'
        }, {
            x: tocState.history.time.map(t => (t / 60).toFixed(1)),
            y: tocState.history.throughput,
            type: 'scatter', mode: 'lines',
            line: { color: '#3498db', width: 2 },
            name: 'Throughput', yaxis: 'y2'
        }], {
            margin: { t: 10, b: 40, l: 45, r: 45 },
            paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
            font: { color: '#9aaa9a', size: 10 },
            xaxis: { title: 'Time (min)', gridcolor: 'rgba(255,255,255,0.1)' },
            yaxis: { title: 'WIP', gridcolor: 'rgba(255,255,255,0.1)', side: 'left' },
            yaxis2: { title: 'Throughput/hr', overlaying: 'y', side: 'right', gridcolor: 'transparent' },
            legend: { orientation: 'h', y: -0.25, font: { size: 10 } },
            showlegend: true,
        }, { responsive: true, displayModeBar: false });
    }
}

function updateTocInsights() {
    const container = document.getElementById('toc-insights');
    if (!container) return;

    const n = tocStationsData.length;
    const ci = tocState.constraintIdx;
    const mode = tocState.mode;
    const bufferTarget = parseInt(document.getElementById('toc-buffer-size').value) || 5;
    const cov = parseInt(document.getElementById('toc-cov').value);

    const totalWIP = tocState.buffers.slice(1, n).reduce((s, v) => s + v, 0);
    const elapsedHrs = tocState.time / 3600;
    const throughput = elapsedHrs > 0 ? tocState.completed / elapsedHrs : 0;
    const constraintUtil = tocState.time > 0 ? (tocState.constraintWorkingTime / tocState.time * 100) : 0;
    const constraintCap = tocStationsData[ci].capacity;
    const theoreticalMax = constraintCap; // system can never exceed constraint capacity

    // Station utilizations
    const stationUtils = tocState.stations.map((stn, i) => ({
        name: tocStationsData[i].name,
        cap: tocStationsData[i].capacity,
        util: tocState.time > 0 ? (stn.workingTime / tocState.time * 100) : 0,
        starved: tocState.time > 0 ? (stn.starvedTime / tocState.time * 100) : 0,
        isConstraint: i === ci,
    }));

    // WIP distribution
    const wipBeforeConstraint = tocState.buffers.slice(1, ci + 1).reduce((s, v) => s + v, 0);
    const wipAfterConstraint = tocState.buffers.slice(ci + 1, n).reduce((s, v) => s + v, 0);

    // Analysis
    let analysisHtml = '';
    analysisHtml += `<div style="margin-bottom:4px;"><strong>Mode:</strong> ${mode === 'dbr' ? 'Drum-Buffer-Rope' : 'Uncontrolled'}</div>`;
    analysisHtml += `<div style="margin-bottom:4px;"><strong>Constraint:</strong> ${tocStationsData[ci].name} at ${constraintCap}/hr (${mode === 'dbr' ? '&#x1F941; drum' : 'bottleneck'})</div>`;
    analysisHtml += `<div style="margin-bottom:4px;"><strong>Constraint utilization:</strong> <span style="color:${constraintUtil > 90 ? '#27ae60' : constraintUtil > 75 ? '#f39c12' : '#e74c3c'};">${constraintUtil.toFixed(0)}%</span></div>`;
    analysisHtml += `<div style="margin-bottom:4px;"><strong>System throughput:</strong> ${throughput.toFixed(1)}/hr (theoretical max: ${theoreticalMax}/hr → ${(throughput / theoreticalMax * 100).toFixed(0)}%)</div>`;
    analysisHtml += `<div style="margin-bottom:4px;"><strong>Total WIP:</strong> ${totalWIP} (${wipBeforeConstraint} before constraint, ${wipAfterConstraint} after)</div>`;

    if (mode === 'dbr') {
        const drumBuf = tocState.buffers[ci];
        analysisHtml += `<div style="margin-bottom:4px;"><strong>Drum buffer:</strong> ${drumBuf}/${bufferTarget} units</div>`;
    }

    // Station utilization breakdown
    analysisHtml += `<div style="margin-top:8px; font-weight:600; margin-bottom:4px;">Station Utilization:</div>`;
    stationUtils.forEach(s => {
        const barWidth = Math.min(100, s.util);
        const color = s.isConstraint ? '#e74c3c' : s.util > 90 ? '#f39c12' : '#27ae60';
        analysisHtml += `<div style="display:flex; align-items:center; gap:6px; margin-bottom:2px;">
            <span style="min-width:70px; font-size:11px;">${s.name}${s.isConstraint ? ' &#x1F941;' : ''}</span>
            <div style="flex:1; height:8px; background:var(--bg-tertiary); border-radius:4px; overflow:hidden;">
                <div style="width:${barWidth}%; height:100%; background:${color}; border-radius:4px; transition:width 0.3s;"></div>
            </div>
            <span style="min-width:35px; font-size:11px; text-align:right;">${s.util.toFixed(0)}%</span>
        </div>`;
    });

    // Improvements
    let improvHtml = '';

    if (mode === 'uncontrolled') {
        improvHtml += `<div style="color:#e74c3c; margin-bottom:4px;">&#x26A0; No WIP control — inventory piling up before ${tocStationsData[ci].name}</div>`;
        if (wipBeforeConstraint > 15) {
            improvHtml += `<div style="margin-bottom:4px;">&#x1F4A1; ${wipBeforeConstraint} units queued before constraint — this is pure waste (carrying cost, floor space, lead time)</div>`;
        }
        improvHtml += `<div style="margin-bottom:4px;">&#x1F4A1; Switch to DBR to cap WIP and reduce lead time by controlling material release</div>`;

        // Check if non-constraints are being utilized when they shouldn't be
        const nonConstraintOverwork = stationUtils.filter(s => !s.isConstraint && s.util > 95);
        if (nonConstraintOverwork.length > 0) {
            improvHtml += `<div style="margin-bottom:4px;">&#x1F4CA; ${nonConstraintOverwork.map(s => s.name).join(', ')} running at >95% — producing WIP nobody downstream needs</div>`;
        }
    } else {
        // DBR mode insights
        if (constraintUtil > 92) {
            improvHtml += `<div style="color:#27ae60; margin-bottom:4px;">&#x2705; Constraint at ${constraintUtil.toFixed(0)}% utilization — buffer is protecting the drum</div>`;
        } else if (constraintUtil < 75) {
            improvHtml += `<div style="color:#f39c12; margin-bottom:4px;">&#x26A0; Constraint only at ${constraintUtil.toFixed(0)}% — buffer may be too small or upstream variability too high</div>`;
            if (bufferTarget < 5) {
                improvHtml += `<div style="margin-bottom:4px;">&#x1F4A1; Try increasing buffer from ${bufferTarget} to ${bufferTarget + 3} to better protect the drum</div>`;
            }
        }

        const drumBuf = tocState.buffers[ci];
        if (drumBuf === 0 && constraintUtil < 90) {
            improvHtml += `<div style="color:#e74c3c; margin-bottom:4px;">&#x1F6A8; Buffer empty! Constraint is starving — increase buffer size or reduce upstream variability</div>`;
        } else if (drumBuf >= bufferTarget && bufferTarget > 2) {
            improvHtml += `<div style="margin-bottom:4px;">&#x1F4A1; Buffer consistently full — you could reduce it to ${Math.max(1, bufferTarget - 2)} without starving the drum</div>`;
        }

        if (totalWIP < 10) {
            improvHtml += `<div style="color:#27ae60; margin-bottom:4px;">&#x2705; WIP controlled at ${totalWIP} units — lean flow achieved</div>`;
        }
    }

    // General Goldratt wisdom
    if (cov > 30) {
        const lostPct = ((1 - throughput / theoreticalMax) * 100);
        if (lostPct > 15) {
            improvHtml += `<div style="margin-bottom:4px;">&#x1F4C9; High variability (${cov}%) reducing throughput by ~${lostPct.toFixed(0)}%</div>`;
        }
    }

    // 5 Focusing Steps
    improvHtml += `<div style="margin-top:8px; padding-top:8px; border-top:1px solid var(--border);">`;
    improvHtml += `<div style="font-weight:600; margin-bottom:4px;">Goldratt's 5 Focusing Steps:</div>`;
    improvHtml += `<div style="margin-bottom:2px;">1. <strong>Identify</strong> the constraint → ${tocStationsData[ci].name} (${constraintCap}/hr)</div>`;
    improvHtml += `<div style="margin-bottom:2px;">2. <strong>Exploit</strong> it → maximize constraint utilization (currently ${constraintUtil.toFixed(0)}%)</div>`;
    improvHtml += `<div style="margin-bottom:2px;">3. <strong>Subordinate</strong> everything else → DBR controls non-constraint pace</div>`;
    improvHtml += `<div style="margin-bottom:2px;">4. <strong>Elevate</strong> → add capacity at constraint (increase from ${constraintCap}/hr)</div>`;
    improvHtml += `<div style="margin-bottom:2px;">5. <strong>Repeat</strong> → if constraint shifts, re-identify</div>`;
    improvHtml += `</div>`;

    container.innerHTML = `
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
            <div>
                <div style="font-weight:600; color:var(--text-primary); margin-bottom:8px;">Constraint Analysis</div>
                ${analysisHtml}
            </div>
            <div>
                <div style="font-weight:600; color:var(--text-primary); margin-bottom:8px;">Improvement Opportunities</div>
                ${improvHtml}
            </div>
        </div>
    `;
}

// Init TOC station inputs
if (document.getElementById('toc-stations')) renderTocStations();

// ============================================================================
// MULTI-RESPONSE DESIRABILITY OPTIMIZER
// ============================================================================

const desirState = {
    responses: [],  // {name, goal, lower, target, upper, weight, importance, coeffs:[b0,b1,b2,...]}
    factors: [],    // {name, low, high}
};

function desirAddResponse(name='', goal='maximize', lower=0, target=100, upper=100, weight=1, importance=1) {
    const idx = desirState.responses.length;
    desirState.responses.push({name: name || `Y${idx+1}`, goal, lower, target, upper, weight, importance, coeffs:[]});
    desirRenderResponses();
    desirRenderModels();
}

function desirRemoveResponse(idx) {
    desirState.responses.splice(idx, 1);
    desirRenderResponses();
    desirRenderModels();
}

function desirAddFactor(name='', low=0, high=100) {
    const idx = desirState.factors.length;
    desirState.factors.push({name: name || `X${idx+1}`, low, high});
    desirRenderFactors();
    desirRenderModels();
}

function desirRemoveFactor(idx) {
    desirState.factors.splice(idx, 1);
    desirRenderFactors();
    desirRenderModels();
}

function desirRenderResponses() {
    const el = document.getElementById('desir-responses');
    if (!el) return;
    el.innerHTML = desirState.responses.map((r, i) => `
        <div style="display:grid;grid-template-columns:120px 110px 80px 80px 80px 1fr 1fr 30px;gap:8px;align-items:end;margin-bottom:8px;font-size:13px;">
            <div class="calc-input"><label>Name</label><input type="text" value="${r.name}" onchange="desirState.responses[${i}].name=this.value" style="padding:6px 8px;"></div>
            <div class="calc-input"><label>Goal</label><select onchange="desirState.responses[${i}].goal=this.value;desirGoalChanged(${i})">
                <option value="maximize" ${r.goal==='maximize'?'selected':''}>Maximize</option>
                <option value="minimize" ${r.goal==='minimize'?'selected':''}>Minimize</option>
                <option value="target" ${r.goal==='target'?'selected':''}>Target</option>
            </select></div>
            <div class="calc-input"><label>Lower</label><input type="number" value="${r.lower}" onchange="desirState.responses[${i}].lower=+this.value" style="padding:6px 8px;"></div>
            <div class="calc-input"><label>${r.goal==='target'?'Target':'Target'}</label><input type="number" value="${r.target}" onchange="desirState.responses[${i}].target=+this.value" style="padding:6px 8px;"></div>
            <div class="calc-input"><label>Upper</label><input type="number" value="${r.upper}" onchange="desirState.responses[${i}].upper=+this.value" style="padding:6px 8px;"></div>
            <div class="calc-input"><label>Weight <span style="color:var(--text-dim);font-weight:400;">${r.weight.toFixed(1)}</span></label><input type="range" min="0.1" max="10" step="0.1" value="${r.weight}" oninput="desirState.responses[${i}].weight=+this.value;this.previousElementSibling?.querySelector('span')&&(this.parentElement.querySelector('span').textContent=parseFloat(this.value).toFixed(1))"></div>
            <div class="calc-input"><label>Importance <span style="color:var(--text-dim);font-weight:400;">${r.importance}</span></label><input type="range" min="1" max="10" step="1" value="${r.importance}" oninput="desirState.responses[${i}].importance=+this.value;this.parentElement.querySelector('span').textContent=this.value"></div>
            <button onclick="desirRemoveResponse(${i})" style="padding:4px 8px;background:none;border:1px solid var(--border);border-radius:4px;color:var(--text-dim);cursor:pointer;font-size:16px;margin-bottom:2px;">&times;</button>
        </div>
    `).join('');
}

function desirGoalChanged(idx) { desirRenderResponses(); }

function desirRenderFactors() {
    const el = document.getElementById('desir-factors');
    if (!el) return;
    el.innerHTML = desirState.factors.map((f, i) => `
        <div style="display:grid;grid-template-columns:140px 100px 100px 30px;gap:8px;align-items:end;margin-bottom:8px;font-size:13px;">
            <div class="calc-input"><label>Factor Name</label><input type="text" value="${f.name}" onchange="desirState.factors[${i}].name=this.value" style="padding:6px 8px;"></div>
            <div class="calc-input"><label>Low</label><input type="number" value="${f.low}" onchange="desirState.factors[${i}].low=+this.value" style="padding:6px 8px;"></div>
            <div class="calc-input"><label>High</label><input type="number" value="${f.high}" onchange="desirState.factors[${i}].high=+this.value" style="padding:6px 8px;"></div>
            <button onclick="desirRemoveFactor(${i})" style="padding:4px 8px;background:none;border:1px solid var(--border);border-radius:4px;color:var(--text-dim);cursor:pointer;font-size:16px;margin-bottom:2px;">&times;</button>
        </div>
    `).join('');
}

function desirRenderModels() {
    const el = document.getElementById('desir-models');
    if (!el) return;
    if (desirState.responses.length === 0 || desirState.factors.length === 0) {
        el.innerHTML = '<div style="color:var(--text-dim);font-size:13px;">Add responses and factors first.</div>';
        return;
    }
    el.innerHTML = desirState.responses.map((r, ri) => {
        // Ensure coeffs array is right size: b0 + one per factor
        while (r.coeffs.length < desirState.factors.length + 1) r.coeffs.push(0);
        r.coeffs.length = desirState.factors.length + 1;
        const coeffInputs = [`<span style="font-size:12px;color:var(--text-dim);">b0=</span><input type="number" value="${r.coeffs[0]}" onchange="desirState.responses[${ri}].coeffs[0]=+this.value" style="width:60px;padding:4px 6px;font-size:12px;">`];
        desirState.factors.forEach((f, fi) => {
            coeffInputs.push(`<span style="font-size:12px;color:var(--text-dim);">+ b${fi+1}(${f.name})=</span><input type="number" value="${r.coeffs[fi+1]}" onchange="desirState.responses[${ri}].coeffs[${fi+1}]=+this.value" style="width:60px;padding:4px 6px;font-size:12px;">`);
        });
        return `<div style="background:var(--bg-secondary);padding:10px 14px;border-radius:8px;"><strong style="font-size:13px;">${r.name}:</strong> <span style="display:inline-flex;align-items:center;gap:4px;flex-wrap:wrap;">${coeffInputs.join(' ')}</span></div>`;
    }).join('');
}

function desirCalcD(value, r) {
    const {goal, lower, target, upper, weight} = r;
    if (goal === 'maximize') {
        if (value <= lower) return 0;
        if (value >= target) return 1;
        return Math.pow((value - lower) / (target - lower), weight);
    } else if (goal === 'minimize') {
        if (value >= upper) return 0;
        if (value <= target) return 1;
        return Math.pow((upper - value) / (upper - target), weight);
    } else {
        if (value < lower || value > upper) return 0;
        if (value <= target) return Math.pow((value - lower) / (target - lower), weight);
        return Math.pow((upper - value) / (upper - target), weight);
    }
}

function desirPredictResponse(r, factorValues) {
    let y = r.coeffs[0] || 0;
    for (let fi = 0; fi < factorValues.length; fi++) {
        y += (r.coeffs[fi + 1] || 0) * factorValues[fi];
    }
    return y;
}

function runDesirability() {
    const responses = desirState.responses;
    const factors = desirState.factors;
    if (responses.length < 2) { alert('Add at least 2 responses.'); return; }
    if (factors.length < 1) { alert('Add at least 1 factor.'); return; }

    const gridN = factors.length <= 2 ? 31 : (factors.length === 3 ? 15 : 11);
    const totalImportance = responses.reduce((s, r) => s + r.importance, 0);

    // Grid search
    let bestD = -1, bestSettings = null, bestPredictions = null, bestIndividual = null;
    const gridSteps = factors.map(f => {
        const steps = [];
        for (let i = 0; i <= gridN; i++) steps.push(f.low + (f.high - f.low) * i / gridN);
        return steps;
    });

    // For contour: store D values for first two factors
    const contourX = gridSteps[0] || [];
    const contourY = gridSteps[1] || [];
    const contourZ = factors.length >= 2 ? contourY.map(() => contourX.map(() => 0)) : null;

    function evalPoint(fv) {
        let compositeD = 1;
        const predictions = [], individuals = [];
        for (const r of responses) {
            const yHat = desirPredictResponse(r, fv);
            const di = desirCalcD(yHat, r);
            predictions.push(yHat);
            individuals.push(di);
            compositeD *= Math.pow(di, r.importance / totalImportance);
        }
        return {compositeD, predictions, individuals};
    }

    // Recursive grid enumeration
    function enumerate(depth, fv) {
        if (depth === factors.length) {
            const {compositeD, predictions, individuals} = evalPoint(fv);
            if (compositeD > bestD) {
                bestD = compositeD;
                bestSettings = [...fv];
                bestPredictions = predictions;
                bestIndividual = individuals;
            }
            // Store contour for first 2 factors (hold others at midpoint)
            if (contourZ && depth >= 2) {
                const xi = gridSteps[0].indexOf(fv[0]);
                const yi = gridSteps[1].indexOf(fv[1]);
                if (xi >= 0 && yi >= 0) {
                    let allMid = true;
                    for (let k = 2; k < factors.length; k++) {
                        const mid = (factors[k].low + factors[k].high) / 2;
                        if (Math.abs(fv[k] - mid) > 0.001) { allMid = false; break; }
                    }
                    if (allMid) contourZ[yi][xi] = compositeD;
                }
            }
            return;
        }
        const steps = gridSteps[depth];
        // For factors beyond the first 2 in contour mode, only use midpoint for contour but search all for optimum
        for (const v of steps) {
            fv[depth] = v;
            enumerate(depth + 1, fv);
        }
    }

    // For contour: if >2 factors, run a separate 2D sweep with others at midpoint
    if (factors.length > 2) {
        const midFV = factors.map(f => (f.low + f.high) / 2);
        for (let yi = 0; yi < contourY.length; yi++) {
            for (let xi = 0; xi < contourX.length; xi++) {
                const fv = [...midFV];
                fv[0] = contourX[xi];
                fv[1] = contourY[yi];
                const {compositeD} = evalPoint(fv);
                contourZ[yi][xi] = compositeD;
            }
        }
    }

    enumerate(0, new Array(factors.length).fill(0));

    // Render desirability profiles
    const profilesEl = document.getElementById('desir-profiles');
    profilesEl.innerHTML = '';
    responses.forEach((r, i) => {
        const div = document.createElement('div');
        div.id = `desir-profile-${i}`;
        div.style.height = '220px';
        profilesEl.appendChild(div);

        const yRange = r.upper - r.lower;
        const yMin = r.lower - yRange * 0.1;
        const yMax = r.upper + yRange * 0.1;
        const nPts = 100;
        const yVals = [], dVals = [];
        for (let j = 0; j <= nPts; j++) {
            const y = yMin + (yMax - yMin) * j / nPts;
            yVals.push(y);
            dVals.push(desirCalcD(y, r));
        }

        const traces = [
            {x: yVals, y: dVals, type: 'scatter', mode: 'lines', line: {color: '#4a9f6e', width: 2.5}, name: 'd(y)'},
        ];
        if (bestPredictions) {
            traces.push({x: [bestPredictions[i]], y: [bestIndividual[i]], type: 'scatter', mode: 'markers', marker: {size: 10, color: '#e74c3c', symbol: 'star'}, name: `Optimal: ${bestPredictions[i].toFixed(2)}`});
        }
        Plotly.react(div.id, traces, {
            height: 220, margin: {t: 30, b: 40, l: 50, r: 20},
            paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
            font: {color: '#9aaa9a', size: 10},
            title: {text: `${r.name} (${r.goal}) — d = ${bestIndividual ? bestIndividual[i].toFixed(3) : '?'}`, font: {size: 13, color: '#c0c0c0'}},
            xaxis: {title: r.name, range: [yMin, yMax], gridcolor: 'rgba(255,255,255,0.07)', tickfont: {color: '#9aaa9a'}},
            yaxis: {title: 'd(y)', range: [-0.05, 1.05], gridcolor: 'rgba(255,255,255,0.07)', tickfont: {color: '#9aaa9a'}},
            showlegend: false,
        }, {responsive: true, displayModeBar: false});
    });

    // Render contour
    if (contourZ && factors.length >= 2) {
        const contourTraces = [
            {x: contourX, y: contourY, z: contourZ, type: 'contour', colorscale: [[0,'#1a1a2e'],[0.5,'#f39c12'],[1,'#27ae60']], contours: {coloring: 'heatmap'}, colorbar: {title: 'D', len: 0.8}},
        ];
        if (bestSettings) {
            contourTraces.push({x: [bestSettings[0]], y: [bestSettings[1]], type: 'scatter', mode: 'markers', marker: {size: 14, color: '#e74c3c', symbol: 'star', line: {color: 'white', width: 2}}, name: 'Optimal'});
        }
        Plotly.react('desir-contour', contourTraces, {
            height: 400, margin: {t: 30, b: 50, l: 60, r: 20},
            paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
            font: {color: '#9aaa9a', size: 10},
            xaxis: {title: factors[0].name, gridcolor: 'rgba(255,255,255,0.07)', tickfont: {color: '#9aaa9a'}},
            yaxis: {title: factors[1].name, gridcolor: 'rgba(255,255,255,0.07)', tickfont: {color: '#9aaa9a'}},
            showlegend: false,
        }, {responsive: true, displayModeBar: false});
    } else if (factors.length === 1) {
        // 1D: line plot of composite D vs factor
        const xVals = contourX, dLine = [];
        for (const x of xVals) {
            const {compositeD} = evalPoint([x]);
            dLine.push(compositeD);
        }
        Plotly.react('desir-contour', [
            {x: xVals, y: dLine, type: 'scatter', mode: 'lines', line: {color: '#4a9f6e', width: 2.5}},
            bestSettings ? {x: [bestSettings[0]], y: [bestD], type: 'scatter', mode: 'markers', marker: {size: 12, color: '#e74c3c', symbol: 'star'}, name: 'Optimal'} : null,
        ].filter(Boolean), {
            height: 400, margin: {t: 30, b: 50, l: 60, r: 20},
            paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
            font: {color: '#9aaa9a', size: 10},
            xaxis: {title: factors[0].name, gridcolor: 'rgba(255,255,255,0.07)', tickfont: {color: '#9aaa9a'}},
            yaxis: {title: 'Composite D', range: [-0.05, 1.05], gridcolor: 'rgba(255,255,255,0.07)', tickfont: {color: '#9aaa9a'}},
            showlegend: false,
        }, {responsive: true, displayModeBar: false});
    }

    // Results cards
    const resultsEl = document.getElementById('desir-results');
    let cardsHtml = `<div class="calc-result-card primary"><div class="calc-result-label">Composite D</div><div class="calc-result-value" style="color:${bestD > 0.8 ? '#27ae60' : bestD > 0.5 ? '#f39c12' : '#e74c3c'}">${bestD.toFixed(4)}</div></div>`;
    if (bestSettings) {
        factors.forEach((f, i) => {
            cardsHtml += `<div class="calc-result-card"><div class="calc-result-label">Optimal ${f.name}</div><div class="calc-result-value">${bestSettings[i].toFixed(2)}</div></div>`;
        });
        responses.forEach((r, i) => {
            cardsHtml += `<div class="calc-result-card"><div class="calc-result-label">${r.name} (predicted)</div><div class="calc-result-value">${bestPredictions[i].toFixed(2)}</div></div>`;
        });
    }
    resultsEl.innerHTML = cardsHtml;
    document.getElementById('desir-D').textContent = bestD.toFixed(4);

    // Insight panel
    const insightEl = document.getElementById('desir-insights');
    const insightSection = document.getElementById('desir-insight-section');
    insightSection.style.display = 'block';

    // Sensitivity: perturb each factor ±5% and measure D change
    let analysisHtml = '<div><strong style="color:var(--text-primary);">Sensitivity Analysis</strong><br>';
    const sensitivities = [];
    if (bestSettings) {
        factors.forEach((f, i) => {
            const delta = (f.high - f.low) * 0.05;
            const up = [...bestSettings]; up[i] += delta;
            const dn = [...bestSettings]; dn[i] -= delta;
            const dUp = evalPoint(up).compositeD;
            const dDn = evalPoint(dn).compositeD;
            const sens = Math.abs(dUp - dDn) / (2 * delta);
            sensitivities.push({name: f.name, sens, dUp, dDn});
            const color = sens > 0.005 ? '#e74c3c' : sens > 0.001 ? '#f39c12' : '#27ae60';
            analysisHtml += `<div style="margin:4px 0;"><span style="color:${color};">&#9679;</span> <strong>${f.name}:</strong> &Delta;D/&Delta;X = ${sens.toFixed(5)} ${sens > 0.005 ? '(sensitive)' : '(robust)'}</div>`;
        });
    }
    // Binding responses
    analysisHtml += '<br><strong style="color:var(--text-primary);">Response Status</strong><br>';
    responses.forEach((r, i) => {
        const di = bestIndividual ? bestIndividual[i] : 0;
        const status = di < 0.3 ? '&#x274C; Constraining' : di < 0.7 ? '&#x26A0; Moderate' : '&#x2705; Satisfied';
        analysisHtml += `<div style="margin:4px 0;">${status} <strong>${r.name}:</strong> d = ${di.toFixed(3)}</div>`;
    });
    analysisHtml += '</div>';

    let improvHtml = '<div><strong style="color:var(--text-primary);">Improvement Suggestions</strong><br>';
    responses.forEach((r, i) => {
        const di = bestIndividual ? bestIndividual[i] : 0;
        if (di < 0.5) {
            if (r.goal === 'maximize') improvHtml += `<div style="margin:4px 0;color:#f39c12;">&#x1F4A1; ${r.name} (d=${di.toFixed(2)}): Consider raising the lower bound from ${r.lower} — currently very restrictive.</div>`;
            else if (r.goal === 'minimize') improvHtml += `<div style="margin:4px 0;color:#f39c12;">&#x1F4A1; ${r.name} (d=${di.toFixed(2)}): Consider relaxing the upper bound from ${r.upper}.</div>`;
            else improvHtml += `<div style="margin:4px 0;color:#f39c12;">&#x1F4A1; ${r.name} (d=${di.toFixed(2)}): Widen the acceptable range [${r.lower}, ${r.upper}].</div>`;
        }
    });
    if (sensitivities.length > 0) {
        const mostSens = sensitivities.sort((a,b) => b.sens - a.sens)[0];
        improvHtml += `<div style="margin:8px 0;">&#x1F50D; <strong>${mostSens.name}</strong> is the most influential factor — a confirmation experiment varying this factor would be most informative.</div>`;
    }
    if (bestD >= 0.8) improvHtml += '<div style="margin:8px 0;color:#27ae60;">&#x2705; Composite D &ge; 0.8 — optimization is in a good region. Verify with confirmation runs.</div>';
    else if (bestD < 0.3) improvHtml += '<div style="margin:8px 0;color:#e74c3c;">&#x26A0; Composite D &lt; 0.3 — responses may be fundamentally conflicting. Consider relaxing constraints or adjusting factor ranges.</div>';
    improvHtml += '</div>';
    insightEl.innerHTML = analysisHtml + improvHtml;
}

function desirLoadExample() {
    desirState.responses = [];
    desirState.factors = [];

    desirState.factors.push({name: 'Temperature', low: 60, high: 100});
    desirState.factors.push({name: 'Pressure', low: 1, high: 5});

    // Yield: maximize 60-95, Y = 30 + 0.5*T + 5*P
    desirState.responses.push({name: 'Yield %', goal: 'maximize', lower: 60, target: 95, upper: 95, weight: 1, importance: 3, coeffs: [30, 0.5, 5]});
    // Purity: target 99.5, range 98-100, Y = 102 - 0.03*T + 0.1*P
    desirState.responses.push({name: 'Purity %', goal: 'target', lower: 98, target: 99.5, upper: 100, weight: 1, importance: 5, coeffs: [102, -0.03, 0.1]});
    // Cost: minimize $10-$50, Y = -20 + 0.4*T + 3*P
    desirState.responses.push({name: 'Cost $', goal: 'minimize', lower: 10, target: 10, upper: 50, weight: 1, importance: 2, coeffs: [-20, 0.4, 3]});

    desirRenderResponses();
    desirRenderFactors();
    desirRenderModels();
    runDesirability();
}

// ============================================================================
// SPC RARE EVENTS LAB (G Chart + T Chart)
// ============================================================================

const reState = {
    data: [],
    running: false,
    interval: null,
    currentIdx: 0,
};

function reUpdateConfig() {
    const type = document.getElementById('re-type').value;
    const rateLabel = type === 'G' ? 'probability per opportunity' : 'events per time unit';
    document.querySelector('#re-rate + .input-hint').textContent = rateLabel;
}

function reGenerateData() {
    const type = document.getElementById('re-type').value;
    const rate = parseFloat(document.getElementById('re-rate').value);
    const n = parseInt(document.getElementById('re-n').value);
    const shiftAt = parseInt(document.getElementById('re-shift-at').value);
    const shiftMag = parseFloat(document.getElementById('re-shift-mag').value);

    const data = [];
    for (let i = 0; i < n; i++) {
        const currentRate = (shiftAt > 0 && i >= shiftAt) ? rate * shiftMag : rate;
        if (type === 'G') {
            // Geometric: count of opportunities between events
            // E[G] = (1-p)/p
            const p = Math.min(currentRate, 0.99);
            data.push(Math.floor(Math.log(Math.random()) / Math.log(1 - p)));
        } else {
            // Exponential: time between events
            // E[T] = 1/lambda
            data.push(-Math.log(Math.random()) / currentRate);
        }
    }
    return data;
}

function reCalcLimits(data, type) {
    const n = data.length;
    const mean = data.reduce((a, b) => a + b, 0) / n;

    if (type === 'G') {
        // G chart: based on geometric distribution
        // CL = mean, UCL/LCL from 3-sigma on geometric
        const pHat = 1 / (mean + 1);  // estimated p from mean = (1-p)/p
        const sigma = Math.sqrt((1 - pHat) / (pHat * pHat));
        return {
            cl: mean,
            ucl: mean + 3 * sigma,
            lcl: Math.max(0, mean - 3 * sigma),
            pHat, sigma, mean
        };
    } else {
        // T chart: transform T^(1/3.6) to approximate normality, then I-MR limits
        // Or simpler: use raw data with exponential-based limits
        const lambdaHat = 1 / mean;
        // For exponential: Var(T) = 1/lambda^2, so sigma = 1/lambda = mean
        return {
            cl: mean,
            ucl: mean + 3 * mean,  // = 4*mean (conservative)
            lcl: Math.max(0, mean - 3 * mean),  // 0 in practice
            lambdaHat, sigma: mean, mean
        };
    }
}

function reRenderChart(data, limits, type, highlightIdx) {
    const ooc = [];
    data.forEach((v, i) => {
        if (v > limits.ucl || v < limits.lcl) ooc.push(i);
    });

    const traces = [
        {y: data, type: 'scatter', mode: 'lines+markers', marker: {size: 5, color: '#4a9f6e'}, line: {color: '#4a9f6e'}, name: type === 'G' ? 'Count Between Events' : 'Time Between Events'},
        {y: Array(data.length).fill(limits.cl), type: 'scatter', mode: 'lines', name: 'CL', line: {color: '#00b894', dash: 'dash'}},
        {y: Array(data.length).fill(limits.ucl), type: 'scatter', mode: 'lines', name: 'UCL', line: {color: '#d63031', dash: 'dash'}},
        {y: Array(data.length).fill(limits.lcl), type: 'scatter', mode: 'lines', name: 'LCL', line: {color: '#d63031', dash: 'dash'}},
    ];
    if (ooc.length > 0) {
        traces.push({x: ooc, y: ooc.map(i => data[i]), type: 'scatter', mode: 'markers', marker: {size: 10, color: '#e74c3c', symbol: 'diamond'}, name: 'OOC'});
    }

    const shiftAt = parseInt(document.getElementById('re-shift-at').value);
    const shapes = [];
    if (shiftAt > 0 && shiftAt < data.length) {
        shapes.push({type: 'line', x0: shiftAt, x1: shiftAt, y0: 0, y1: 1, yref: 'paper', line: {color: '#f39c12', width: 2, dash: 'dot'}});
    }

    Plotly.react('re-chart', traces, {
        height: 350, showlegend: true,
        paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
        font: {color: '#9aaa9a', size: 10},
        xaxis: {title: 'Sample #', gridcolor: 'rgba(255,255,255,0.07)', tickfont: {color: '#9aaa9a'}},
        yaxis: {title: type === 'G' ? 'Count' : 'Time', gridcolor: 'rgba(255,255,255,0.07)', tickfont: {color: '#9aaa9a'}},
        legend: {orientation: 'h', y: -0.2, font: {size: 10, color: '#9aaa9a'}},
        shapes,
        annotations: shiftAt > 0 && shiftAt < data.length ? [{x: shiftAt, y: 1, yref: 'paper', text: 'Shift', showarrow: false, font: {color: '#f39c12', size: 11}, yanchor: 'bottom'}] : [],
    }, {responsive: true, displayModeBar: false});

    // Update metrics
    const estRate = type === 'G' ? limits.pHat : limits.lambdaHat;
    document.getElementById('re-est-rate').textContent = estRate ? estRate.toFixed(4) : '—';
    document.getElementById('re-mean').textContent = limits.mean ? limits.mean.toFixed(2) : '—';
    document.getElementById('re-ooc').textContent = ooc.length;

    // Detection delay
    const shiftAtVal = parseInt(document.getElementById('re-shift-at').value);
    if (shiftAtVal > 0) {
        const firstOOCAfterShift = ooc.find(i => i >= shiftAtVal);
        if (firstOOCAfterShift !== undefined) {
            document.getElementById('re-delay').textContent = `${firstOOCAfterShift - shiftAtVal} samples`;
        } else {
            document.getElementById('re-delay').textContent = 'Not detected';
        }
    } else {
        document.getElementById('re-delay').textContent = 'N/A';
    }

    return ooc;
}

function reRenderDistribution(data, type) {
    // Histogram + fitted distribution
    const mean = data.reduce((a, b) => a + b, 0) / data.length;
    const maxVal = Math.max(...data);
    const nBins = 20;

    const fitted_x = [], fitted_y = [];
    for (let i = 0; i <= 100; i++) {
        const x = maxVal * i / 100;
        fitted_x.push(x);
        if (type === 'G') {
            const p = 1 / (mean + 1);
            fitted_y.push(p * Math.pow(1 - p, x));  // Geometric PMF approx
        } else {
            const lambda = 1 / mean;
            fitted_y.push(lambda * Math.exp(-lambda * x));  // Exponential PDF
        }
    }

    // Scale fitted curve to match histogram
    const binWidth = maxVal / nBins;
    const scaleFactor = data.length * binWidth;

    Plotly.react('re-dist-chart', [
        {x: data, type: 'histogram', nbinsx: nBins, marker: {color: 'rgba(74,159,110,0.4)', line: {color: '#4a9f6e', width: 1}}, name: 'Observed'},
        {x: fitted_x, y: fitted_y.map(v => v * scaleFactor), type: 'scatter', mode: 'lines', line: {color: '#e74c3c', width: 2}, name: type === 'G' ? 'Geometric Fit' : 'Exponential Fit'},
    ], {
        paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
        font: {color: '#9aaa9a', size: 10}, height: 280, showlegend: true,
        xaxis: {title: type === 'G' ? 'Count Between Events' : 'Time Between Events', gridcolor: 'rgba(255,255,255,0.07)'},
        yaxis: {title: 'Frequency', gridcolor: 'rgba(255,255,255,0.07)'},
    }, {responsive: true, displayModeBar: false});
}

function reUpdateInsights(data, ooc, type) {
    const insightSection = document.getElementById('re-insight-section');
    const insightEl = document.getElementById('re-insights');
    insightSection.style.display = 'block';

    const shiftAt = parseInt(document.getElementById('re-shift-at').value);
    const shiftMag = parseFloat(document.getElementById('re-shift-mag').value);
    const rate = parseFloat(document.getElementById('re-rate').value);
    const n = data.length;
    const mean = data.reduce((a, b) => a + b, 0) / n;

    let analysisHtml = '<div><strong style="color:var(--text-primary);">Chart Analysis</strong><br>';
    analysisHtml += `<div style="margin:4px 0;">Type: <strong>${type === 'G' ? 'G Chart (Geometric)' : 'T Chart (Exponential)'}</strong></div>`;
    analysisHtml += `<div style="margin:4px 0;">Samples: ${n}</div>`;
    analysisHtml += `<div style="margin:4px 0;">Mean between events: <strong>${mean.toFixed(2)}</strong></div>`;
    analysisHtml += `<div style="margin:4px 0;">OOC points: <strong style="color:${ooc.length > 0 ? '#e74c3c' : '#27ae60'}">${ooc.length}</strong></div>`;

    if (shiftAt > 0) {
        analysisHtml += `<br><strong>Shift Injection</strong><br>`;
        analysisHtml += `<div style="margin:4px 0;">Shift at sample ${shiftAt}: rate ${shiftMag}x (${rate} &rarr; ${(rate * shiftMag).toFixed(4)})</div>`;
        const preData = data.slice(0, shiftAt);
        const postData = data.slice(shiftAt);
        const preMean = preData.length > 0 ? preData.reduce((a, b) => a + b, 0) / preData.length : 0;
        const postMean = postData.length > 0 ? postData.reduce((a, b) => a + b, 0) / postData.length : 0;
        analysisHtml += `<div style="margin:4px 0;">Pre-shift mean: ${preMean.toFixed(2)}</div>`;
        analysisHtml += `<div style="margin:4px 0;">Post-shift mean: ${postMean.toFixed(2)} (${((postMean / preMean - 1) * 100).toFixed(0)}% change)</div>`;
        const firstOOC = ooc.find(i => i >= shiftAt);
        if (firstOOC !== undefined) {
            const delay = firstOOC - shiftAt;
            const delayColor = delay <= 3 ? '#27ae60' : delay <= 10 ? '#f39c12' : '#e74c3c';
            analysisHtml += `<div style="margin:4px 0;">Detection delay: <strong style="color:${delayColor}">${delay} samples</strong> (ARL &asymp; ${delay})</div>`;
        } else {
            analysisHtml += `<div style="margin:4px 0;color:#e74c3c;">Shift NOT detected by the chart.</div>`;
        }
    }
    analysisHtml += '</div>';

    let improvHtml = '<div><strong style="color:var(--text-primary);">Guidance</strong><br>';
    if (type === 'G') {
        improvHtml += '<div style="margin:4px 0;">The <strong>G chart</strong> monitors the number of opportunities between events. Best for rare events with constant probability (defects, adverse events, safety incidents).</div>';
        improvHtml += `<div style="margin:4px 0;">Estimated event probability: <strong>${(1/(mean+1)).toFixed(4)}</strong> (${(100/(mean+1)).toFixed(2)}%)</div>`;
        if (rate > 0.1) improvHtml += '<div style="margin:8px 0;color:#f39c12;">Event rate > 10% — consider a standard p-chart instead of G chart.</div>';
    } else {
        improvHtml += '<div style="margin:4px 0;">The <strong>T chart</strong> monitors time between events. Best for rare events measured on a time scale (equipment failures, customer complaints).</div>';
        improvHtml += `<div style="margin:4px 0;">Estimated event rate: <strong>${(1/mean).toFixed(4)}</strong> per time unit</div>`;
    }
    if (ooc.length === 0 && shiftAt > 0) {
        improvHtml += '<div style="margin:8px 0;color:#f39c12;">The shift was not detected. Try a larger shift magnitude, more samples, or supplement with CUSUM/EWMA for small shifts.</div>';
    }
    if (ooc.length > 0 && shiftAt === 0) {
        improvHtml += `<div style="margin:8px 0;color:#e74c3c;">${ooc.length} OOC point(s) detected with no injected shift — this represents false alarms at the 3-sigma level (expected ~0.27% per point).</div>`;
    }
    improvHtml += '</div>';
    insightEl.innerHTML = analysisHtml + improvHtml;
}

function reStart() {
    const mode = document.getElementById('re-mode').value;
    reState.data = reGenerateData();

    if (mode === 'instant') {
        const type = document.getElementById('re-type').value;
        const limits = reCalcLimits(reState.data, type);
        const ooc = reRenderChart(reState.data, limits, type);
        reRenderDistribution(reState.data, type);
        reUpdateInsights(reState.data, ooc, type);
    } else {
        // Simulate mode: show points one at a time
        if (reState.interval) clearInterval(reState.interval);
        reState.currentIdx = 0;
        reState.running = true;
        document.getElementById('re-speed-box').style.display = 'flex';
        document.getElementById('re-start').textContent = '⏸ Pause';
        document.getElementById('re-start').onclick = rePause;

        reState.interval = setInterval(() => {
            if (!reState.running) return;
            const speed = parseInt(document.getElementById('re-speed').value);
            for (let s = 0; s < speed; s++) {
                if (reState.currentIdx >= reState.data.length) {
                    clearInterval(reState.interval);
                    reState.running = false;
                    document.getElementById('re-start').textContent = '▶ Generate';
                    document.getElementById('re-start').onclick = reStart;
                    // Final full analysis
                    const type = document.getElementById('re-type').value;
                    const limits = reCalcLimits(reState.data, type);
                    const ooc = reRenderChart(reState.data, limits, type);
                    reRenderDistribution(reState.data, type);
                    reUpdateInsights(reState.data, ooc, type);
                    return;
                }
                reState.currentIdx++;
            }
            const shown = reState.data.slice(0, reState.currentIdx);
            const type = document.getElementById('re-type').value;
            const limits = reCalcLimits(shown, type);
            const ooc = reRenderChart(shown, limits, type);
            document.getElementById('re-progress').textContent = `Sample ${reState.currentIdx} / ${reState.data.length}`;
            if (reState.currentIdx > 10) {
                reRenderDistribution(shown, type);
                reUpdateInsights(shown, ooc, type);
            }
        }, 150);
    }
}

function rePause() {
    reState.running = !reState.running;
    document.getElementById('re-start').textContent = reState.running ? '⏸ Pause' : '▶ Resume';
}

function reReset() {
    if (reState.interval) clearInterval(reState.interval);
    reState.data = [];
    reState.running = false;
    reState.currentIdx = 0;
    document.getElementById('re-start').textContent = '▶ Generate';
    document.getElementById('re-start').onclick = reStart;
    document.getElementById('re-speed-box').style.display = 'none';
    document.getElementById('re-progress').textContent = '';
    ['re-est-rate','re-mean','re-ooc','re-delay'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = '—'; });
    const chartEl = document.getElementById('re-chart');
    if (chartEl) Plotly.purge(chartEl);
    const distEl = document.getElementById('re-dist-chart');
    if (distEl) Plotly.purge(distEl);
    document.getElementById('re-insight-section').style.display = 'none';
}

// ============================================================================
// PROBIT / DOSE-RESPONSE EXPLORER
// ============================================================================

let probitData = [];  // [{dose, n, r}]

function probitAddRow(dose='', n='', r='') {
    probitData.push({dose: +dose || 0, n: +n || 0, r: +r || 0});
    probitRenderTable();
}

function probitRemoveRow(idx) {
    probitData.splice(idx, 1);
    probitRenderTable();
}

function probitRenderTable() {
    const tbody = document.getElementById('probit-tbody');
    if (!tbody) return;
    tbody.innerHTML = probitData.map((row, i) => `
        <tr style="border-bottom:1px solid var(--border);">
            <td style="padding:6px 8px;"><input type="number" value="${row.dose}" onchange="probitData[${i}].dose=+this.value" style="width:80px;padding:4px 6px;font-size:13px;" step="any"></td>
            <td style="padding:6px 8px;"><input type="number" value="${row.n}" onchange="probitData[${i}].n=+this.value" style="width:80px;padding:4px 6px;font-size:13px;" min="1"></td>
            <td style="padding:6px 8px;"><input type="number" value="${row.r}" onchange="probitData[${i}].r=+this.value" style="width:80px;padding:4px 6px;font-size:13px;" min="0"></td>
            <td><button onclick="probitRemoveRow(${i})" style="padding:2px 8px;background:none;border:1px solid var(--border);border-radius:4px;color:var(--text-dim);cursor:pointer;">&times;</button></td>
        </tr>
    `).join('');
}

// Normal distribution helpers
function probitPhi(x) {
    // Standard normal CDF (Abramowitz & Stegun approximation)
    const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741, a4 = -1.453152027, a5 = 1.061405429, p = 0.3275911;
    const sign = x < 0 ? -1 : 1;
    x = Math.abs(x) / Math.sqrt(2);
    const t = 1.0 / (1.0 + p * x);
    const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
    return 0.5 * (1.0 + sign * y);
}

function probitPhiPDF(x) {
    return Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);
}

function probitPhiInv(p) {
    // Rational approximation for inverse normal CDF
    if (p <= 0) return -8;
    if (p >= 1) return 8;
    if (p < 0.5) return -probitPhiInv(1 - p);
    const t = Math.sqrt(-2 * Math.log(1 - p));
    const c0 = 2.515517, c1 = 0.802853, c2 = 0.010328;
    const d1 = 1.432788, d2 = 0.189269, d3 = 0.001308;
    return t - (c0 + c1 * t + c2 * t * t) / (1 + d1 * t + d2 * t * t + d3 * t * t * t);
}

function probitLink(eta, model) {
    return model === 'probit' ? probitPhi(eta) : 1 / (1 + Math.exp(-eta));
}

function probitLinkDeriv(eta, model) {
    if (model === 'probit') return probitPhiPDF(eta);
    const e = Math.exp(-Math.min(eta, 500));
    return e / ((1 + e) * (1 + e));
}

function probitFit(data, model) {
    // IRLS: fit P(response) = link(a + b * log(dose))
    // Filter valid data
    const valid = data.filter(d => d.dose > 0 && d.n > 0);
    if (valid.length < 3) return null;

    const logDose = valid.map(d => Math.log(d.dose));
    const y = valid.map(d => d.r / d.n);
    const n = valid.map(d => d.n);

    // Smart initial beta via OLS on transformed proportions
    const yTrans = valid.map(d => {
        const pObs = Math.max(0.01, Math.min(0.99, d.r / d.n));
        return model === 'probit' ? probitPhiInv(pObs) : Math.log(pObs / (1 - pObs));
    });
    const xBar = logDose.reduce((a, b) => a + b, 0) / logDose.length;
    const yBar = yTrans.reduce((a, b) => a + b, 0) / yTrans.length;
    let sxy = 0, sxx = 0;
    for (let i = 0; i < logDose.length; i++) {
        sxy += (logDose[i] - xBar) * (yTrans[i] - yBar);
        sxx += (logDose[i] - xBar) * (logDose[i] - xBar);
    }
    let beta = sxx > 1e-12 ? [yBar - (sxy / sxx) * xBar, sxy / sxx] : [0, 1];
    if (beta[1] <= 0) beta = [yBar, 0.5]; // fallback: ensure positive slope
    const maxIter = 50;

    for (let iter = 0; iter < maxIter; iter++) {
        const eta = logDose.map((ld, i) => beta[0] + beta[1] * ld);
        const p = eta.map(e => probitLink(e, model));

        // Clamp p to avoid numerical issues
        const pClamped = p.map(pi => Math.max(0.001, Math.min(0.999, pi)));

        // Weights and working response for IRLS
        const deriv = eta.map(e => {
            if (model === 'probit') return probitPhiPDF(e);
            const ex = Math.exp(-Math.min(e, 500));
            return ex / ((1 + ex) * (1 + ex));
        });
        const W = pClamped.map((pi, i) => n[i] * deriv[i] * deriv[i] / (pi * (1 - pi)));
        // Clamp working response to prevent extreme values when derivative is small
        const z = eta.map((e, i) => {
            const raw = e + (y[i] - pClamped[i]) / Math.max(deriv[i], 1e-6);
            return Math.max(-20, Math.min(20, raw));
        });

        // WLS: solve (X'WX)beta = X'Wz where X = [1, logDose]
        let XtWX00 = 0, XtWX01 = 0, XtWX11 = 0, XtWz0 = 0, XtWz1 = 0;
        for (let i = 0; i < valid.length; i++) {
            const w = Math.max(W[i], 0.0001);
            XtWX00 += w;
            XtWX01 += w * logDose[i];
            XtWX11 += w * logDose[i] * logDose[i];
            XtWz0 += w * z[i];
            XtWz1 += w * logDose[i] * z[i];
        }

        const det = XtWX00 * XtWX11 - XtWX01 * XtWX01;
        if (Math.abs(det) < 1e-12) break;

        const newBeta = [
            (XtWX11 * XtWz0 - XtWX01 * XtWz1) / det,
            (-XtWX01 * XtWz0 + XtWX00 * XtWz1) / det,
        ];

        // Guard against NaN
        if (isNaN(newBeta[0]) || isNaN(newBeta[1])) break;

        const change = Math.abs(newBeta[0] - beta[0]) + Math.abs(newBeta[1] - beta[1]);
        beta = newBeta;
        if (change < 1e-8) break;
    }

    // Variance-covariance matrix (inverse of Fisher information)
    const eta = logDose.map((ld, i) => beta[0] + beta[1] * ld);
    const p = eta.map(e => probitLink(e, model));
    const pClamped = p.map(pi => Math.max(0.001, Math.min(0.999, pi)));
    const deriv = eta.map(e => {
        if (model === 'probit') return probitPhiPDF(e);
        const ex = Math.exp(-Math.min(e, 500));
        return ex / ((1 + ex) * (1 + ex));
    });
    const W = pClamped.map((pi, i) => n[i] * deriv[i] * deriv[i] / (pi * (1 - pi)));

    let I00 = 0, I01 = 0, I11 = 0;
    for (let i = 0; i < valid.length; i++) {
        const w = Math.max(W[i], 0.0001);
        I00 += w;
        I01 += w * logDose[i];
        I11 += w * logDose[i] * logDose[i];
    }
    const detI = I00 * I11 - I01 * I01;
    const vcov = detI > 1e-12 ? [
        [I11 / detI, -I01 / detI],
        [-I01 / detI, I00 / detI],
    ] : [[1,0],[0,1]];

    // Goodness of fit: Pearson chi-squared
    let chi2 = 0;
    for (let i = 0; i < valid.length; i++) {
        const expected = n[i] * pClamped[i];
        chi2 += Math.pow(valid[i].r - expected, 2) / (expected * (1 - pClamped[i]));
    }
    const df = valid.length - 2;
    // p-value from chi-squared (simple approximation)
    const chi2p = df > 0 ? 1 - probitGammaCDF(chi2 / 2, df / 2) : 1;

    return {beta, vcov, chi2, df, chi2p, valid, logDose, p: pClamped};
}

// Incomplete gamma function (for chi-squared p-value)
function probitGammaCDF(x, a) {
    if (x <= 0) return 0;
    if (a <= 0) return 1;
    // Series expansion for lower incomplete gamma
    let sum = 0, term = 1 / a;
    for (let n = 1; n < 200; n++) {
        sum += term;
        term *= x / (a + n);
        if (Math.abs(term) < 1e-12) break;
    }
    return sum * Math.exp(-x + a * Math.log(x) - lnGamma(a));
}

function lnGamma(x) {
    // Stirling's approximation
    const c = [76.18009172947146, -86.50532032941677, 24.01409824083091, -1.231739572450155, 0.001208650973866179, -0.000005395239384953];
    let y = x, tmp = x + 5.5;
    tmp -= (x + 0.5) * Math.log(tmp);
    let ser = 1.000000000190015;
    for (let j = 0; j < 6; j++) ser += c[j] / ++y;
    return -tmp + Math.log(2.5066282746310005 * ser / x);
}

function probitCalcED(beta, pTarget, model) {
    // ED_p: find dose where P(response) = pTarget
    // link(a + b*log(dose)) = pTarget
    // a + b*log(dose) = link_inv(pTarget)
    if (!beta[1] || Math.abs(beta[1]) < 1e-12) return NaN;
    let etaTarget;
    if (model === 'probit') {
        etaTarget = probitPhiInv(pTarget);
    } else {
        etaTarget = Math.log(pTarget / (1 - pTarget));
    }
    const logDose = (etaTarget - beta[0]) / beta[1];
    if (logDose > 700 || logDose < -700) return NaN;
    return Math.exp(logDose);
}

function probitUpdate() {
    const valid = probitData.filter(d => d.dose > 0 && d.n > 0);
    if (valid.length < 3) return;

    const model = document.getElementById('probit-model').value;
    const confLevel = parseFloat(document.getElementById('probit-conf').value);
    const fit = probitFit(probitData, model);
    if (!fit) return;

    const {beta, vcov} = fit;

    // Calculate EDs
    const ed50 = probitCalcED(beta, 0.5, model);
    const ed10 = probitCalcED(beta, 0.1, model);
    const ed90 = probitCalcED(beta, 0.9, model);

    // ED50 CI via delta method (Fieller's theorem)
    const logED50 = (probitPhiInv(0.5) - beta[0]) / beta[1];
    // If logit, use log(0.5/0.5) = 0, so logED50 = -beta[0]/beta[1]
    const dg_da = -1 / beta[1];
    const dg_db = -(logED50) / beta[1]; // = beta[0] / beta[1]^2
    const varLogED50 = dg_da * dg_da * vcov[0][0] + 2 * dg_da * dg_db * vcov[0][1] + dg_db * dg_db * vcov[1][1];
    const zAlpha = probitPhiInv(1 - (1 - confLevel) / 2);
    const ciLow = Math.exp(logED50 - zAlpha * Math.sqrt(Math.max(0, varLogED50)));
    const ciHigh = Math.exp(logED50 + zAlpha * Math.sqrt(Math.max(0, varLogED50)));

    // Slope at ED50
    const etaAtED50 = model === 'probit' ? 0 : 0;
    const slopeAtED50 = beta[1] * (model === 'probit' ? probitPhiPDF(etaAtED50) : 0.25) / ed50;

    // Update metric cards (NaN-safe)
    const fmt = (v, d) => isNaN(v) || !isFinite(v) ? '—' : v.toFixed(d);
    document.getElementById('probit-ed50').textContent = fmt(ed50, 3);
    document.getElementById('probit-ed50-ci').textContent = `[${fmt(ciLow, 3)}, ${fmt(ciHigh, 3)}]`;
    document.getElementById('probit-ed10').textContent = fmt(ed10, 3);
    document.getElementById('probit-ed90').textContent = fmt(ed90, 3);
    document.getElementById('probit-slope').textContent = fmt(slopeAtED50, 4);
    document.getElementById('probit-gof').textContent = fmt(fit.chi2p, 4) + (fit.chi2p > 0.05 ? ' (good fit)' : ' (poor fit)');

    // Plot S-curve
    const minDose = Math.min(...valid.map(d => d.dose)) * 0.5;
    const maxDose = Math.max(...valid.map(d => d.dose)) * 1.5;
    const useLog = maxDose / minDose > 10;
    const nPts = 200;
    const curveX = [], curveY = [], curveLow = [], curveHigh = [];

    for (let i = 0; i <= nPts; i++) {
        const x = useLog
            ? Math.exp(Math.log(minDose) + (Math.log(maxDose) - Math.log(minDose)) * i / nPts)
            : minDose + (maxDose - minDose) * i / nPts;
        const eta = beta[0] + beta[1] * Math.log(x);
        const pHat = probitLink(eta, model);
        curveX.push(x);
        curveY.push(pHat);

        // Confidence band: variance of eta at this point
        const varEta = vcov[0][0] + 2 * Math.log(x) * vcov[0][1] + Math.log(x) * Math.log(x) * vcov[1][1];
        const seEta = Math.sqrt(Math.max(0, varEta));
        curveLow.push(probitLink(eta - zAlpha * seEta, model));
        curveHigh.push(probitLink(eta + zAlpha * seEta, model));
    }

    const traces = [
        // Confidence band
        {x: [...curveX, ...curveX.slice().reverse()], y: [...curveHigh, ...curveLow.slice().reverse()], type: 'scatter', fill: 'toself', fillcolor: 'rgba(74,159,110,0.15)', line: {color: 'transparent'}, name: `${(confLevel*100).toFixed(0)}% CI`, showlegend: true},
        // Fitted curve
        {x: curveX, y: curveY, type: 'scatter', mode: 'lines', line: {color: '#4a9f6e', width: 2.5}, name: model === 'probit' ? 'Probit Fit' : 'Logit Fit'},
        // Data points
        {x: valid.map(d => d.dose), y: valid.map(d => d.r / d.n), type: 'scatter', mode: 'markers', marker: {size: valid.map(d => Math.max(6, Math.min(20, Math.sqrt(d.n) * 3))), color: '#e17055', line: {color: 'white', width: 1}}, name: 'Observed', text: valid.map(d => `${d.r}/${d.n} (${(d.r/d.n*100).toFixed(1)}%)`), hoverinfo: 'text+x'},
    ];

    // ED markers
    [{ed: ed10, label: 'ED10', pct: 0.1}, {ed: ed50, label: 'ED50', pct: 0.5}, {ed: ed90, label: 'ED90', pct: 0.9}].forEach(({ed, label, pct}) => {
        if (ed > 0 && ed < maxDose * 2) {
            traces.push({x: [ed, ed], y: [0, pct], type: 'scatter', mode: 'lines', line: {color: '#fdcb6e', width: 1.5, dash: 'dot'}, showlegend: false});
            traces.push({x: [minDose * 0.8, ed], y: [pct, pct], type: 'scatter', mode: 'lines', line: {color: '#fdcb6e', width: 1.5, dash: 'dot'}, showlegend: false});
        }
    });

    Plotly.react('probit-chart', traces, {
        paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
        font: {color: '#9aaa9a', size: 10}, height: 400, showlegend: true,
        xaxis: {title: 'Dose', type: useLog ? 'log' : 'linear', gridcolor: 'rgba(255,255,255,0.07)'},
        yaxis: {title: 'Response Probability', range: [-0.05, 1.05], gridcolor: 'rgba(255,255,255,0.07)'},
        annotations: [
            {x: useLog ? Math.log10(ed50) : ed50, y: 0.5, text: `ED50 = ${ed50.toFixed(2)}`, showarrow: true, arrowhead: 2, ax: 40, ay: -30, font: {color: '#fdcb6e', size: 12}},
        ],
    }, {responsive: true, displayModeBar: false});

    // Insights
    const insightSection = document.getElementById('probit-insight-section');
    const insightEl = document.getElementById('probit-insights');
    insightSection.style.display = 'block';

    let analysisHtml = '<div><strong style="color:var(--text-primary);">Model Summary</strong><br>';
    analysisHtml += `<div style="margin:4px 0;">Model: <strong>${model === 'probit' ? 'Probit' : 'Logit'}</strong></div>`;
    analysisHtml += `<div style="margin:4px 0;">Equation: P = ${model === 'probit' ? '&Phi;' : 'logistic'}(${beta[0].toFixed(3)} + ${beta[1].toFixed(3)} &times; ln(dose))</div>`;
    analysisHtml += `<div style="margin:4px 0;">Intercept (a): ${beta[0].toFixed(4)} &plusmn; ${Math.sqrt(vcov[0][0]).toFixed(4)}</div>`;
    analysisHtml += `<div style="margin:4px 0;">Slope (b): ${beta[1].toFixed(4)} &plusmn; ${Math.sqrt(vcov[1][1]).toFixed(4)}</div>`;
    analysisHtml += `<div style="margin:4px 0;">Pearson &chi;&sup2;: ${fit.chi2.toFixed(2)} (df=${fit.df}, p=${fit.chi2p.toFixed(4)})</div>`;
    const fitOk = fit.chi2p > 0.05;
    analysisHtml += `<div style="margin:4px 0;color:${fitOk ? '#27ae60' : '#e74c3c'};">${fitOk ? '&#x2705; Good fit (p > 0.05)' : '&#x274C; Poor fit (p &le; 0.05) — consider a different model or check data'}</div>`;
    analysisHtml += '</div>';

    let improvHtml = '<div><strong style="color:var(--text-primary);">Interpretation</strong><br>';
    const ratio9010 = ed90 / ed10;
    improvHtml += `<div style="margin:4px 0;">ED90/ED10 ratio: <strong>${ratio9010.toFixed(2)}</strong> — ${ratio9010 < 5 ? 'steep curve (narrow effective range)' : ratio9010 < 20 ? 'moderate slope' : 'shallow curve (wide effective range)'}</div>`;
    improvHtml += `<div style="margin:4px 0;">ED50 = ${ed50.toFixed(3)} [${ciLow.toFixed(3)}, ${ciHigh.toFixed(3)}]</div>`;
    const ciWidth = (ciHigh - ciLow) / ed50;
    if (ciWidth > 1) improvHtml += '<div style="margin:4px 0;color:#f39c12;">Wide CI on ED50 — consider adding more dose levels near the ED50 region.</div>';
    if (beta[1] < 0) improvHtml += '<div style="margin:4px 0;color:#e74c3c;">Negative slope — response DECREASES with dose. Verify data coding.</div>';
    improvHtml += '</div>';
    insightEl.innerHTML = analysisHtml + improvHtml;
}

function probitLoadExample() {
    // Classic LD50 toxicology data
    probitData = [
        {dose: 1.0, n: 50, r: 2},
        {dose: 2.0, n: 50, r: 5},
        {dose: 4.0, n: 50, r: 12},
        {dose: 8.0, n: 50, r: 25},
        {dose: 16.0, n: 50, r: 38},
        {dose: 32.0, n: 50, r: 45},
        {dose: 64.0, n: 50, r: 49},
    ];
    probitRenderTable();
    probitUpdate();
}
</script>
{% endblock %}
