{% extends "base_app.html" %}
{% block title %}Analysis Workbench - SVEND{% endblock %}

{% block extra_head %}
<style>
/* ============================================================================
   ANALYSIS WORKBENCH - Minitab/RStudio Style
   ============================================================================ */

/* Override base template for full-width IDE */
body > main { padding: 0 !important; }
body > main > .container { max-width: none !important; padding: 0 !important; }

/* Icon SVG sizing - exclude Plotly charts */
.aw-container svg:not(.main-svg) { width: 16px; height: 16px; flex-shrink: 0; }

/* Variables - SVEND Dark Forest Theme */
.aw-container {
    --aw-bg: #0d120d;
    --aw-bg-dark: #0a0f0a;
    --aw-panel-bg: #121a12;
    --aw-panel-header: #1a261a;
    --aw-border: rgba(74, 159, 110, 0.25);
    --aw-border-dark: rgba(74, 159, 110, 0.4);
    --aw-text: #e8efe8;
    --aw-text-dim: #9aaa9a;
    --aw-text-muted: #7a8f7a;
    --aw-accent: #4a9f6e;
    --aw-accent-dim: rgba(74, 159, 110, 0.15);
    --aw-accent-light: rgba(74, 159, 110, 0.25);
    --aw-success: #4a9f6e;
    --aw-warning: #e89547;
    --aw-danger: #d06060;
    --aw-toolbar-height: 28px;
    --aw-menubar-height: 22px;
    --aw-statusbar-height: 20px;
    --aw-sidebar-width: 180px;
}

.aw-container {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 60px);
    background: var(--aw-bg);
    color: var(--aw-text);
    font-family: 'Inter', -apple-system, sans-serif;
    font-size: 11px;
    line-height: 1.3;
}

/* Menu Bar */
.aw-menubar {
    display: flex;
    align-items: center;
    height: var(--aw-menubar-height);
    background: var(--aw-bg-dark);
    border-bottom: 1px solid var(--aw-border);
    padding: 0 4px;
    gap: 0;
}

.aw-menu-item {
    padding: 3px 10px;
    color: var(--aw-text-dim);
    cursor: pointer;
    font-size: 11px;
}

.aw-menu-item:hover {
    background: var(--aw-accent-light);
    color: var(--aw-accent);
}

/* Toolbar */
.aw-toolbar {
    display: flex;
    align-items: center;
    height: var(--aw-toolbar-height);
    background: var(--aw-panel-header);
    border-bottom: 1px solid var(--aw-border);
    padding: 0 4px;
    gap: 2px;
}

.aw-toolbar-group {
    display: flex;
    align-items: center;
    gap: 1px;
    padding: 0 4px;
}

.aw-toolbar-sep {
    width: 1px;
    height: 18px;
    background: var(--aw-border);
    margin: 0 4px;
}

.aw-toolbar-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 3px;
    padding: 3px 6px;
    background: transparent;
    border: 1px solid transparent;
    color: var(--aw-text-dim);
    font-size: 10px;
    cursor: pointer;
    border-radius: 3px;
    min-width: 22px;
    height: 22px;
}

.aw-toolbar-btn:hover {
    background: var(--aw-accent-dim);
    border-color: var(--aw-border);
    color: var(--aw-text);
}

.aw-toolbar-btn:active {
    background: var(--aw-accent-light);
}

.aw-toolbar-btn.primary {
    background: var(--aw-accent-dim);
    color: var(--aw-accent);
    border-color: var(--aw-border-dark);
}

.aw-toolbar-btn.primary:hover {
    background: var(--aw-accent-light);
}

.aw-toolbar-btn svg { width: 14px; height: 14px; }

.aw-toolbar-label {
    font-size: 10px;
    color: var(--aw-text-muted);
}

/* Main Layout */
.aw-main {
    display: flex;
    flex: 1;
    overflow: hidden;
}

/* Sidebar / Navigator */
.aw-sidebar {
    width: var(--aw-sidebar-width);
    background: var(--aw-panel-bg);
    border-right: 1px solid var(--aw-border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.aw-sidebar-section {
    border-bottom: 1px solid var(--aw-border);
}

.aw-sidebar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 5px 8px;
    background: var(--aw-panel-header);
    font-size: 10px;
    font-weight: 500;
    color: var(--aw-text-dim);
    cursor: pointer;
    user-select: none;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.aw-sidebar-header:hover {
    background: var(--aw-accent-dim);
    color: var(--aw-text);
}

.aw-sidebar-header svg { width: 10px; height: 10px; }

.aw-sidebar-content {
    max-height: 150px;
    overflow-y: auto;
    background: var(--aw-bg-dark);
}

.aw-sidebar-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px 4px 12px;
    font-size: 11px;
    color: var(--aw-text-dim);
    cursor: pointer;
    border-left: 2px solid transparent;
}

.aw-sidebar-item:hover {
    background: var(--aw-accent-dim);
    color: var(--aw-text);
}

.aw-sidebar-item.active {
    background: var(--aw-accent-dim);
    border-left-color: var(--aw-accent);
    color: var(--aw-text);
}

.aw-sidebar-item svg { width: 12px; height: 12px; opacity: 0.6; }

.aw-var-badge {
    margin-left: auto;
    font-size: 9px;
    padding: 1px 4px;
    border-radius: 2px;
    background: var(--aw-accent-dim);
    color: var(--aw-text-dim);
    font-weight: 500;
}

.aw-var-badge.num { background: rgba(74, 159, 110, 0.2); color: #4a9f6e; }
.aw-var-badge.cat { background: rgba(232, 197, 71, 0.2); color: #e8c547; }
.aw-var-badge.date { background: rgba(58, 127, 143, 0.2); color: #3a7f8f; }

/* Workspace (panes area) */
.aw-workspace {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: var(--aw-bg);
}

.aw-pane-row {
    display: flex;
    flex: 1;
    min-height: 0;
}

/* Panes */
.aw-pane {
    display: flex;
    flex-direction: column;
    flex: 1;
    min-width: 0;
    background: var(--aw-panel-bg);
    border: 1px solid var(--aw-border);
    margin: 2px;
    border-radius: 3px;
}

.aw-pane-header {
    display: flex;
    align-items: center;
    height: 22px;
    padding: 0 8px;
    background: var(--aw-panel-header);
    border-bottom: 1px solid var(--aw-border);
    font-size: 11px;
    font-weight: 500;
    gap: 6px;
    color: var(--aw-text-dim);
}

.aw-pane-header svg { width: 12px; height: 12px; opacity: 0.7; }

.aw-pane-title {
    display: flex;
    align-items: center;
    gap: 4px;
}

.aw-pane-tabs {
    display: flex;
    margin-left: auto;
    gap: 0;
}

.aw-pane-tab {
    padding: 2px 8px;
    font-size: 10px;
    background: transparent;
    border: none;
    color: var(--aw-text-muted);
    cursor: pointer;
}

.aw-pane-tab:hover {
    color: var(--aw-text-dim);
}

.aw-pane-tab.active {
    background: var(--aw-accent-dim);
    color: var(--aw-accent);
    border-radius: 2px;
}

.aw-pane-content {
    flex: 1;
    min-height: 0;
    overflow: auto;
    padding: 0;
    background: #0a0f0a;
    min-height: 0;
}

/* Data Table (Worksheet style) */
.aw-worksheet {
    width: 100%;
    border-collapse: collapse;
    font-family: 'JetBrains Mono', 'Consolas', monospace;
    font-size: 11px;
}

.aw-worksheet th {
    position: sticky;
    top: 0;
    background: var(--aw-panel-header);
    padding: 4px 8px;
    text-align: left;
    font-weight: 500;
    color: var(--aw-text-dim);
    border: 1px solid var(--aw-border);
    white-space: nowrap;
    font-size: 10px;
}

.aw-worksheet th.row-num {
    background: var(--aw-bg-dark);
    text-align: center;
    width: 40px;
    color: var(--aw-text-muted);
}

.aw-worksheet td {
    padding: 3px 8px;
    border-right: 1px solid var(--aw-border);
    border-bottom: 1px solid var(--aw-border);
    white-space: nowrap;
    color: var(--aw-text);
}

.aw-worksheet td.row-num {
    background: var(--aw-bg-dark);
    text-align: center;
    color: var(--aw-text-muted);
    font-size: 10px;
    border-right: 1px solid var(--aw-border);
}

.aw-worksheet tr:hover td {
    background: var(--aw-accent-dim);
}

.aw-worksheet tr:hover td.row-num {
    background: var(--aw-accent-dim);
}

/* Session Window (output) */
.aw-session {
    font-family: 'JetBrains Mono', 'Consolas', monospace;
    font-size: 11px;
    padding: 8px;
    background: var(--aw-bg-dark);
    line-height: 1.4;
    white-space: pre-wrap;
    color: var(--aw-text);
}

.aw-session .cmd {
    color: var(--aw-accent);
    font-weight: 500;
}

.aw-session .result {
    color: var(--aw-text);
}

.aw-session .error {
    color: var(--aw-danger);
}

.aw-session .note {
    color: var(--aw-text-muted);
}

.session-separator {
    margin: 16px 0;
    padding: 0;
}

.session-separator .separator-line {
    height: 1px;
    background: linear-gradient(90deg, transparent 0%, #3a7f8f 20%, #3a7f8f 80%, transparent 100%);
}

/* Thinking indicator animation */
.thinking-indicator {
    display: inline-flex;
    gap: 4px;
    align-items: center;
}

.thinking-dot {
    width: 6px;
    height: 6px;
    background: #3a7f8f;
    border-radius: 50%;
    animation: thinking-pulse 1.4s infinite ease-in-out both;
}

.thinking-dot:nth-child(1) { animation-delay: -0.32s; }
.thinking-dot:nth-child(2) { animation-delay: -0.16s; }
.thinking-dot:nth-child(3) { animation-delay: 0s; }

@keyframes thinking-pulse {
    0%, 80%, 100% {
        transform: scale(0.6);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}

/* Loading Spinner */
.loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid rgba(74, 159, 110, 0.2);
    border-top-color: var(--aw-accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Graph Window */
.aw-graph-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 8px;
    padding: 8px;
    background: var(--aw-bg-dark);
}

.aw-graph-card {
    background: var(--aw-panel-bg);
    border: 1px solid var(--aw-border);
    border-radius: 3px;
}

.aw-graph-title {
    padding: 4px 8px;
    background: var(--aw-panel-header);
    border-bottom: 1px solid var(--aw-border);
    font-size: 10px;
    font-weight: 500;
    color: var(--aw-text-dim);
}

.aw-graph-body {
    padding: 8px;
    height: 220px;
    background: #0a0f0a;
}

/* Data Tabs */
.aw-data-tabs {
    display: flex;
    align-items: center;
    background: var(--aw-bg-dark);
    border-bottom: 1px solid var(--aw-border);
    padding: 0 4px;
    gap: 2px;
    min-height: 24px;
    overflow-x: auto;
}

.aw-data-tab {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 3px 10px;
    background: transparent;
    border: 1px solid transparent;
    border-bottom: none;
    border-radius: 3px 3px 0 0;
    font-size: 10px;
    color: var(--aw-text-muted);
    cursor: pointer;
    white-space: nowrap;
    max-width: 150px;
}

.aw-data-tab:hover {
    background: var(--aw-accent-dim);
    color: var(--aw-text-dim);
}

.aw-data-tab.active {
    background: var(--aw-panel-bg);
    border-color: var(--aw-border);
    color: var(--aw-accent);
}

.aw-data-tab .tab-name {
    overflow: hidden;
    text-overflow: ellipsis;
}

.aw-data-tab .tab-close {
    width: 12px;
    height: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 2px;
    opacity: 0.5;
}

.aw-data-tab .tab-close:hover {
    opacity: 1;
    background: var(--aw-danger);
    color: white;
}

.aw-data-tab-add {
    padding: 3px 8px;
    background: transparent;
    border: none;
    color: var(--aw-text-muted);
    cursor: pointer;
    font-size: 14px;
}

.aw-data-tab-add:hover {
    color: var(--aw-accent);
}

/* Chart Tabs */
.aw-chart-tabs {
    display: flex;
    align-items: flex-end;
    padding: 4px 8px 0 8px;
    border-bottom: 1px solid var(--aw-border);
    background: var(--aw-bg);
    min-height: 24px;
}

.aw-chart-tab {
    padding: 4px 12px;
    margin-right: -1px;
    background: transparent;
    border: 1px solid rgba(74, 159, 110, 0.3);
    border-bottom: 1px solid rgba(74, 159, 110, 0.3);
    border-radius: 4px 4px 0 0;
    color: var(--aw-text-muted);
    cursor: pointer;
    font-size: 10px;
    position: relative;
    bottom: -1px;
}

.aw-chart-tab:hover {
    color: var(--aw-text);
    background: rgba(74, 159, 110, 0.1);
}

.aw-chart-tab.active {
    background: var(--aw-panel-header);
    border-color: var(--aw-accent);
    border-bottom-color: var(--aw-panel-header);
    color: var(--aw-text);
}

.aw-chart-label {
    font-size: 10px;
    color: var(--aw-text-muted);
    padding: 4px 0 6px 0;
}

.aw-chart-count {
    font-size: 9px;
    color: #6a7a6a;
    padding-bottom: 6px;
}

/* Command Line */
.aw-cmdline {
    display: flex;
    align-items: center;
    padding: 4px 8px;
    background: var(--aw-panel-header);
    border-top: 1px solid var(--aw-border);
    gap: 8px;
}

.aw-cmdline-label {
    font-size: 11px;
    font-weight: 500;
    color: var(--aw-accent);
    font-family: 'JetBrains Mono', monospace;
}

.aw-cmdline input {
    flex: 1;
    padding: 4px 8px;
    font-family: 'JetBrains Mono', 'Consolas', monospace;
    font-size: 11px;
    border: 1px solid var(--aw-border);
    background: var(--aw-bg-dark);
    color: var(--aw-text);
    border-radius: 3px;
}

.aw-cmdline input:focus {
    outline: none;
    border-color: var(--aw-accent);
    background: var(--aw-bg);
}

.aw-cmdline button {
    padding: 4px 12px;
    background: var(--aw-accent-dim);
    border: 1px solid var(--aw-border-dark);
    color: var(--aw-accent);
    font-size: 10px;
    cursor: pointer;
    border-radius: 3px;
    font-weight: 500;
}

.aw-cmdline button:hover {
    background: var(--aw-accent-light);
}

/* Status Bar */
.aw-statusbar {
    display: flex;
    align-items: center;
    height: var(--aw-statusbar-height);
    padding: 0 8px;
    background: var(--aw-bg-dark);
    border-top: 1px solid var(--aw-border);
    font-size: 10px;
    color: var(--aw-text-muted);
    gap: 16px;
}

.aw-status-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

.aw-status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--aw-success);
}

/* Analysis Dialog */
.aw-dialog {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.aw-dialog.active {
    display: flex;
}

.aw-dialog-box {
    background: #121a12;
    border: 1px solid rgba(74, 159, 110, 0.4);
    box-shadow: 0 8px 32px rgba(0,0,0,0.7);
    min-width: 400px;
    max-width: 600px;
    border-radius: 4px;
}

.aw-dialog-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 14px;
    background: #1a261a;
    border-bottom: 1px solid rgba(74, 159, 110, 0.25);
    color: #e8efe8;
    font-size: 13px;
    font-weight: 500;
}

.aw-dialog-close {
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
    color: #9aaa9a;
    line-height: 1;
}

.aw-dialog-close:hover {
    color: #e8efe8;
}

.aw-dialog-body {
    padding: 16px;
    max-height: 450px;
    overflow-y: auto;
    background: #0d120d;
    color: #e8efe8;
}

.aw-dialog-footer {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    padding: 10px 14px;
    background: #1a261a;
    border-top: 1px solid rgba(74, 159, 110, 0.25);
}

/* Form Controls */
.aw-form-group {
    margin-bottom: 12px;
}

.aw-form-group label {
    display: block;
    margin-bottom: 4px;
    font-size: 11px;
    font-weight: 500;
    color: #9aaa9a;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.aw-form-group input,
.aw-form-group select,
.aw-form-group textarea {
    width: 100%;
    padding: 8px 10px;
    font-size: 11px;
    border: 1px solid rgba(74, 159, 110, 0.25);
    background: #0a0f0a;
    color: #e8efe8;
    border-radius: 3px;
}

.aw-form-group input:focus,
.aw-form-group select:focus {
    outline: none;
    border-color: #4a9f6e;
}

.aw-form-group select[multiple] {
    height: 100px;
}

.aw-form-group select option {
    padding: 4px 8px;
    background: #0a0f0a;
    color: #e8efe8;
}

.aw-form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.aw-btn {
    padding: 8px 18px;
    font-size: 11px;
    border: 1px solid rgba(74, 159, 110, 0.25);
    background: #1a261a;
    color: #9aaa9a;
    cursor: pointer;
    border-radius: 3px;
}

.aw-btn:hover {
    background: rgba(74, 159, 110, 0.15);
    color: #e8efe8;
}

.aw-btn-primary {
    background: rgba(74, 159, 110, 0.15);
    border-color: rgba(74, 159, 110, 0.4);
    color: #4a9f6e;
}

.aw-btn-primary:hover {
    background: rgba(74, 159, 110, 0.25);
}

.aw-btn-small {
    padding: 4px 10px;
    font-size: 10px;
    border: 1px solid rgba(74, 159, 110, 0.25);
    background: #1a261a;
    color: #7a8a7a;
    cursor: pointer;
    border-radius: 3px;
    margin-right: 4px;
}

.aw-btn-small:hover {
    background: rgba(74, 159, 110, 0.15);
    color: #e8efe8;
}

/* Checkbox List */
.aw-checkbox-list {
    max-height: 150px;
    overflow-y: auto;
    background: #0a0f0a;
    border: 1px solid rgba(74, 159, 110, 0.25);
    border-radius: 3px;
    padding: 6px;
}

.aw-checkbox-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 4px 6px;
    cursor: pointer;
    border-radius: 2px;
    font-size: 11px;
    color: #9aaa9a;
}

.aw-checkbox-item:hover {
    background: rgba(74, 159, 110, 0.1);
}

.aw-checkbox-item input[type="checkbox"] {
    width: 14px;
    height: 14px;
    margin: 0;
    accent-color: #4a9f6e;
}

.aw-checkbox-item input[type="checkbox"]:checked + span {
    color: #4a9f6e;
}

/* Empty State */
.aw-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--aw-text-muted);
    font-size: 11px;
    text-align: center;
    padding: 20px;
}

.aw-empty svg {
    width: 32px;
    height: 32px;
    margin-bottom: 8px;
    opacity: 0.3;
}

/* Analysis Menu Grid */
.aw-analysis-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 8px;
}

.aw-analysis-item {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 2px;
    padding: 10px 12px;
    background: #121a12;
    border: 1px solid rgba(74, 159, 110, 0.25);
    cursor: pointer;
    text-align: left;
    border-radius: 3px;
}

.aw-analysis-item:hover {
    background: rgba(74, 159, 110, 0.15);
    border-color: #4a9f6e;
}

.aw-analysis-item .name {
    font-size: 11px;
    font-weight: 500;
    color: #e8efe8;
}

.aw-analysis-item .desc {
    font-size: 10px;
    color: var(--aw-text-muted);
}

/* Resizer */
.aw-resizer {
    background: var(--aw-border);
    cursor: col-resize;
    width: 4px;
}

.aw-resizer:hover {
    background: var(--aw-accent);
}

.aw-resizer-h {
    cursor: row-resize;
    height: 4px;
    width: 100%;
}
</style>
{% endblock %}

{% block content %}
<div class="aw-container">
    <!-- Menu Bar -->
    <div class="aw-menubar">
        <span class="aw-menu-item" onclick="showAnalysisMenu('stats')">Stat</span>
        <span class="aw-menu-item" onclick="showAnalysisMenu('bayesian')" style="color:#4a9f6e;font-weight:600;">Bayesian</span>
        <span class="aw-menu-item" onclick="showAnalysisMenu('ml')">ML</span>
        <span class="aw-menu-item" onclick="showAnalysisMenu('spc')">SPC</span>
        <span class="aw-menu-item" onclick="showAnalysisMenu('timeseries')">Time Series</span>
        <span class="aw-menu-item" onclick="showAnalysisMenu('reliability')">Reliability</span>
        <span class="aw-menu-item" onclick="showAnalysisMenu('msa')">MSA</span>
        <span class="aw-menu-item" onclick="showAnalysisMenu('viz')">Graph</span>
        <span class="aw-menu-item" onclick="showAnalysisMenu('tools')">Tools</span>
        <span class="aw-menu-item" onclick="showAnalysisMenu('simulate')">Simulate</span>
    </div>

    <!-- Toolbar -->
    <div class="aw-toolbar">
        <div class="aw-toolbar-group">
            <button class="aw-toolbar-btn" onclick="openFile()" title="Open (Ctrl+O)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                </svg>
            </button>
            <button class="aw-toolbar-btn" onclick="saveProject()" title="Save (Ctrl+S)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                    <polyline points="17 21 17 13 7 13 7 21"/>
                </svg>
            </button>
            <button class="aw-toolbar-btn" title="Print">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 6 2 18 2 18 9"/>
                    <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                    <rect x="6" y="14" width="12" height="8"/>
                </svg>
            </button>
            <button class="aw-toolbar-btn" onclick="openTriageScan()" title="Triage - Scan & Clean Data">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                </svg>
            </button>
            <button class="aw-toolbar-btn" onclick="downloadCurrentData()" title="Download Data">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
            </button>
        </div>

        <div class="aw-toolbar-sep"></div>

        <div class="aw-toolbar-group">
            <button class="aw-toolbar-btn" title="Undo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="1 4 1 10 7 10"/>
                    <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                </svg>
            </button>
            <button class="aw-toolbar-btn" title="Redo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"/>
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                </svg>
            </button>
        </div>

        <div class="aw-toolbar-sep"></div>

        <div class="aw-toolbar-group">
            <button class="aw-toolbar-btn primary" onclick="runCode()" title="Run (Ctrl+Enter)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5 3 19 12 5 21 5 3"/>
                </svg>
            </button>
            <button class="aw-toolbar-btn" title="Stop">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="6" y="6" width="12" height="12"/>
                </svg>
            </button>
        </div>

        <div class="aw-toolbar-sep"></div>

        <div class="aw-toolbar-group">
            <button class="aw-toolbar-btn" onclick="showAnalysisMenu('stats')" title="Basic Statistics">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="20" x2="18" y2="10"/>
                    <line x1="12" y1="20" x2="12" y2="4"/>
                    <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
            </button>
            <button class="aw-toolbar-btn" onclick="configureAnalysis('stats','regression')" title="Regression">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="21" x2="21" y2="3"/>
                    <circle cx="6" cy="18" r="2"/>
                    <circle cx="12" cy="12" r="2"/>
                    <circle cx="18" cy="6" r="2"/>
                </svg>
            </button>
            <button class="aw-toolbar-btn" onclick="configureAnalysis('stats','anova')" title="ANOVA">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="14" width="4" height="8"/>
                    <rect x="10" y="8" width="4" height="14"/>
                    <rect x="18" y="4" width="4" height="18"/>
                </svg>
            </button>
        </div>

        <div class="aw-toolbar-sep"></div>

        <div class="aw-toolbar-group">
            <button class="aw-toolbar-btn" onclick="showAnalysisMenu('spc')" title="Control Charts">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                </svg>
            </button>
            <button class="aw-toolbar-btn" onclick="configureAnalysis('spc','capability')" title="Capability">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
            </button>
        </div>

        <div class="aw-toolbar-sep"></div>

        <div class="aw-toolbar-group">
            <button class="aw-toolbar-btn" onclick="showAnalysisMenu('viz')" title="Graphs">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                    <path d="M3 15l5-5 4 4 8-8"/>
                </svg>
            </button>
            <button class="aw-toolbar-btn" onclick="configureAnalysis('viz','histogram')" title="Histogram">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="4" y="12" width="3" height="8"/>
                    <rect x="9" y="6" width="3" height="14"/>
                    <rect x="14" y="10" width="3" height="10"/>
                    <rect x="19" y="14" width="3" height="6"/>
                </svg>
            </button>
            <button class="aw-toolbar-btn" onclick="configureAnalysis('viz','scatter')" title="Scatter">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="7" cy="17" r="2"/>
                    <circle cx="12" cy="12" r="2"/>
                    <circle cx="17" cy="7" r="2"/>
                    <circle cx="9" cy="9" r="2"/>
                    <circle cx="15" cy="15" r="2"/>
                </svg>
            </button>
            <button class="aw-toolbar-btn" onclick="configureAnalysis('viz','boxplot')" title="Boxplot">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="8" y="6" width="8" height="12"/>
                    <line x1="12" y1="2" x2="12" y2="6"/>
                    <line x1="12" y1="18" x2="12" y2="22"/>
                    <line x1="8" y1="12" x2="16" y2="12"/>
                </svg>
            </button>
        </div>

        <div class="aw-toolbar-sep"></div>

        <div class="aw-toolbar-group">
            <button class="aw-toolbar-btn" onclick="showAnalysisMenu('ml')" title="Machine Learning">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4"/>
                </svg>
            </button>
        </div>

        <div class="aw-toolbar-sep"></div>

        <!-- Bayesian Inference - feeds Synara -->
        <div class="aw-toolbar-group">
            <button class="aw-toolbar-btn" onclick="showAnalysisMenu('bayesian')" title="Bayesian Inference (feeds Synara)" style="color:#4a9f6e;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
            </button>
        </div>

        <div style="margin-left:auto;display:flex;align-items:center;gap:8px;">
            <!-- Chart Settings -->
            <div class="aw-toolbar-dropdown" style="position:relative;">
                <button class="aw-toolbar-btn" onclick="toggleChartSettings()" title="Chart Settings">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                </button>
                <div id="chart-settings-dropdown" class="aw-dropdown-menu" style="display:none;position:absolute;right:0;top:100%;background:#121a12;border:1px solid rgba(74,159,110,0.4);border-radius:6px;padding:12px;min-width:220px;z-index:1000;margin-top:4px;box-shadow:0 8px 32px rgba(0,0,0,0.7);">
                    <div style="font-size:11px;font-weight:600;color:var(--aw-accent);margin-bottom:10px;">Chart Appearance</div>

                    <div style="margin-bottom:10px;">
                        <label style="font-size:10px;color:var(--aw-text-muted);display:block;margin-bottom:4px;">Fill Opacity</label>
                        <input type="range" id="chart-alpha" min="10" max="100" value="50" style="width:100%;" oninput="updateChartSettings()">
                        <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--aw-text-muted);">
                            <span>Light</span><span id="alpha-value">50%</span><span>Solid</span>
                        </div>
                    </div>

                    <div style="margin-bottom:10px;">
                        <label style="font-size:10px;color:var(--aw-text-muted);display:block;margin-bottom:4px;">Marker Size</label>
                        <input type="range" id="chart-marker-size" min="3" max="12" value="6" style="width:100%;" oninput="updateChartSettings()">
                        <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--aw-text-muted);">
                            <span>Small</span><span id="size-value">6</span><span>Large</span>
                        </div>
                    </div>

                    <div style="margin-bottom:10px;">
                        <label style="font-size:10px;color:var(--aw-text-muted);display:block;margin-bottom:4px;">Border Width</label>
                        <input type="range" id="chart-border-width" min="0" max="3" value="1.5" step="0.5" style="width:100%;" oninput="updateChartSettings()">
                        <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--aw-text-muted);">
                            <span>None</span><span id="border-value">1.5</span><span>Thick</span>
                        </div>
                    </div>

                    <div style="margin-bottom:8px;">
                        <label style="font-size:10px;color:var(--aw-text-muted);display:block;margin-bottom:4px;">Color Theme</label>
                        <select id="chart-theme" style="width:100%;padding:4px;font-size:10px;background:var(--aw-bg-tertiary);border:1px solid var(--aw-border);color:var(--aw-text);border-radius:4px;" onchange="updateChartSettings()">
                            <option value="green">SVEND Green</option>
                            <option value="blue">Ocean Blue</option>
                            <option value="purple">Royal Purple</option>
                            <option value="orange">Sunset Orange</option>
                        </select>
                    </div>

                    <button onclick="replotAllCharts()" class="aw-btn" style="width:100%;font-size:10px;padding:6px;">
                        Apply to All Charts
                    </button>
                </div>
            </div>

            <div class="aw-toolbar-sep"></div>

            <span class="aw-toolbar-label">Study:</span>
            <select id="project-selector" style="padding:1px 4px;font-size:9px;border:1px solid var(--aw-border);background:var(--aw-bg-dark);color:var(--aw-text);max-width:120px;">
                <option value="">None</option>
            </select>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="aw-main">
        <!-- Navigator (Sidebar) -->
        <div class="aw-sidebar">
            <!-- Data Section -->
            <div class="aw-sidebar-section">
                <div class="aw-sidebar-header" onclick="toggleSection(this)">
                    <span>Data</span>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
                <div class="aw-sidebar-content" id="data-files-list">
                    <div class="aw-empty" style="padding:12px;">
                        <span>No data loaded</span>
                    </div>
                </div>
            </div>

            <!-- Variables Section -->
            <div class="aw-sidebar-section">
                <div class="aw-sidebar-header" onclick="toggleSection(this)">
                    <span>Columns</span>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
                <div class="aw-sidebar-content" id="columns-list">
                    <div class="aw-empty" style="padding:12px;">
                        <span>Load data to see columns</span>
                    </div>
                </div>
            </div>

            <!-- Models Section -->
            <div class="aw-sidebar-section">
                <div class="aw-sidebar-header" onclick="toggleSection(this)">
                    <span>Models</span>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
                <div class="aw-sidebar-content" id="models-list">
                    <div class="aw-empty" style="padding:12px;">
                        <span>No models</span>
                    </div>
                </div>
            </div>

            <!-- History Section -->
            <div class="aw-sidebar-section" style="flex:1;">
                <div class="aw-sidebar-header" onclick="toggleSection(this)">
                    <span>History</span>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
                <div class="aw-sidebar-content" id="history-list" style="max-height:none;">
                </div>
            </div>
        </div>

        <!-- Workspace -->
        <div class="aw-workspace">
            <!-- Top Row: Worksheet + Graphs -->
            <div class="aw-pane-row" style="flex:1.5;">
                <!-- Worksheet Pane -->
                <div class="aw-pane" style="flex:1;">
                    <div class="aw-pane-header">
                        <span class="aw-pane-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <line x1="3" y1="9" x2="21" y2="9"/>
                                <line x1="9" y1="21" x2="9" y2="9"/>
                            </svg>
                            Worksheet
                        </span>
                        <div class="aw-pane-tabs">
                            <button class="aw-pane-tab active">Data</button>
                            <button class="aw-pane-tab">Info</button>
                            <button class="aw-pane-tab" onclick="downloadCurrentData()" title="Download current data">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:10px;height:10px;">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <!-- Data Tabs -->
                    <div class="aw-data-tabs" id="data-tabs">
                        <span style="color:var(--aw-text-muted);font-size:10px;padding:0 8px;">No data loaded</span>
                    </div>
                    <div class="aw-pane-content" id="worksheet-pane">
                        <div class="aw-empty">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                            </svg>
                            <span>Open a CSV or Excel file to view data</span>
                        </div>
                    </div>
                </div>

                <!-- Graph Pane -->
                <div class="aw-pane" style="flex:1.2;">
                    <div class="aw-pane-header">
                        <span class="aw-pane-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="20" x2="18" y2="10"/>
                                <line x1="12" y1="20" x2="12" y2="4"/>
                                <line x1="6" y1="20" x2="6" y2="14"/>
                            </svg>
                            Graph
                        </span>
                        <div class="aw-pane-tabs">
                            <button class="aw-pane-tab active">Plots</button>
                            <button class="aw-pane-tab">Diagnostics</button>
                        </div>
                    </div>
                    <div class="aw-pane-content" id="graph-pane">
                        <div class="aw-empty">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="20" x2="18" y2="10"/>
                                <line x1="12" y1="20" x2="12" y2="4"/>
                                <line x1="6" y1="20" x2="6" y2="14"/>
                            </svg>
                            <span>Run an analysis to see graphs</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Row: Session + Assistant -->
            <div class="aw-pane-row" style="flex:0.7;">
                <!-- Session Pane -->
                <div class="aw-pane">
                    <div class="aw-pane-header">
                        <span class="aw-pane-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="4 17 10 11 4 5"/>
                                <line x1="12" y1="19" x2="20" y2="19"/>
                            </svg>
                            Session
                        </span>
                    </div>
                    <div class="aw-pane-content" style="display:flex;flex-direction:column;">
                        <div class="aw-session" id="session-output" style="flex:1;overflow-y:auto;">
<span class="note"># Welcome to Analysis Workbench</span>
<span class="note"># Type commands or use the menus above</span>

</div>
                        <div class="aw-cmdline">
                            <span class="aw-cmdline-label">MTB &gt;</span>
                            <input type="text" id="cmd-input" placeholder="Enter command...">
                            <button onclick="runCommand()">Submit</button>
                        </div>
                    </div>
                </div>

                <!-- Assistant Pane -->
                <div class="aw-pane">
                    <div class="aw-pane-header">
                        <span class="aw-pane-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                                <line x1="12" y1="17" x2="12.01" y2="17"/>
                            </svg>
                            Assistant
                        </span>
                        <div class="aw-pane-tabs">
                            <button class="aw-pane-tab active">Chat</button>
                            <button class="aw-pane-tab">Guide</button>
                        </div>
                    </div>
                    <div class="aw-pane-content" style="display:flex;flex-direction:column;">
                        <div id="assistant-messages" style="flex:1;overflow-y:auto;padding:8px;">
                            <div style="padding:8px;background:var(--aw-accent-dim);border-left:2px solid var(--aw-accent);margin-bottom:8px;font-size:11px;border-radius:3px;">
                                <strong style="color:var(--aw-accent);">Assistant:</strong> <span style="color:var(--aw-text-dim);">Load data to begin. I can help with statistical analysis, visualizations, and interpreting results.</span>
                            </div>
                        </div>
                        <div class="aw-cmdline" style="gap:4px;">
                            <select id="agent-type" style="width:90px;font-size:10px;padding:4px;background:#1a261a;border:1px solid rgba(74,159,110,0.3);color:var(--aw-text);border-radius:3px;">
                                <option value="analyst">Analyst</option>
                                <option value="researcher">Researcher</option>
                                <option value="writer">Writer</option>
                            </select>
                            <select id="dsw-model-selector" style="width:80px;font-size:10px;padding:4px;background:#1a261a;border:1px solid rgba(74,159,110,0.3);color:var(--aw-text);border-radius:3px;">
                                <option value="default">Default</option>
                                <option value="haiku">Haiku</option>
                                <option value="sonnet">Sonnet</option>
                                <option value="opus">Opus</option>
                            </select>
                            <input type="text" id="assistant-input" placeholder="Ask a question..." style="flex:1;">
                            <button onclick="askAssistant()">Ask</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="aw-statusbar">
        <div class="aw-status-item">
            <span class="aw-status-dot"></span>
            <span>Ready</span>
        </div>
        <div class="aw-status-item" id="status-data">
            No data loaded
        </div>
        <div class="aw-status-item" style="margin-left:auto;">
            <span id="status-rows">Rows: 0</span>
        </div>
        <div class="aw-status-item">
            <span id="status-cols">Cols: 0</span>
        </div>
    </div>
</div>

<!-- Analysis Menu Dialog -->
<div class="aw-dialog" id="analysis-dialog">
    <div class="aw-dialog-box" style="max-width:650px;">
        <div class="aw-dialog-header">
            <span id="analysis-dialog-title">Analysis</span>
            <button class="aw-dialog-close" onclick="closeDialog('analysis-dialog')">&times;</button>
        </div>
        <div class="aw-dialog-body" id="analysis-dialog-body">
        </div>
    </div>
</div>

<!-- Config Dialog -->
<div class="aw-dialog" id="config-dialog">
    <div class="aw-dialog-box">
        <div class="aw-dialog-header">
            <span id="config-dialog-title">Configure</span>
            <button class="aw-dialog-close" onclick="closeDialog('config-dialog')">&times;</button>
        </div>
        <div class="aw-dialog-body" id="config-dialog-body">
        </div>
        <div class="aw-dialog-footer">
            <button class="aw-btn" onclick="closeDialog('config-dialog')">Cancel</button>
            <button class="aw-btn aw-btn-primary" onclick="executeAnalysis()">OK</button>
        </div>
    </div>
</div>

<!-- Data Selection Dialog -->
<div class="aw-dialog" id="data-dialog">
    <div class="aw-dialog-box" style="max-width:500px;">
        <div class="aw-dialog-header">
            <span>Load Data</span>
            <button class="aw-dialog-close" onclick="closeDialog('data-dialog')">&times;</button>
        </div>
        <div class="aw-dialog-body" id="data-dialog-body">
            <p style="color:#9aaa9a;margin-bottom:12px;">Select a cleaned dataset from Triage or upload a new file:</p>
            <div id="triage-datasets-list" style="margin-bottom:16px;">
                <div class="aw-empty" style="padding:20px;color:#7a8f7a;"><span>Loading datasets...</span></div>
            </div>
            <div style="border-top:1px solid rgba(74,159,110,0.25);padding-top:12px;">
                <p style="color:#9aaa9a;margin-bottom:8px;">Or upload a new file:</p>
                <input type="file" id="file-upload-input" accept=".csv,.xlsx,.xls" style="display:none;" onchange="handleFileUpload(event)">
                <button class="aw-btn" onclick="document.getElementById('file-upload-input').click()">Upload CSV/Excel</button>
            </div>
            <div style="border-top:1px solid rgba(74,159,110,0.25);padding-top:12px;margin-top:12px;">
                <p style="color:#9aaa9a;margin-bottom:8px;">New to SVEND? Try our sample dataset:</p>
                <button class="aw-btn aw-btn-primary" onclick="loadSampleData()">Load Sample Data</button>
                <span style="font-size:10px;color:#7a8f7a;margin-left:8px;">Manufacturing quality data (30 batches)</span>
            </div>
        </div>
    </div>
</div>

<!-- Onboarding Modal -->
<div id="onboarding-modal" class="aw-dialog-overlay" style="display:none;">
    <div class="aw-dialog" style="max-width:500px;">
        <div class="aw-dialog-header">
            <span>Welcome to SVEND DSW</span>
            <button class="aw-dialog-close" onclick="closeOnboarding()">&times;</button>
        </div>
        <div class="aw-dialog-body" style="text-align:center;padding:24px;">
            <div style="font-size:48px;margin-bottom:16px;">ðŸ“Š</div>
            <h3 style="color:var(--aw-text);margin-bottom:12px;">Decision Science Workbench</h3>
            <p style="color:#9aaa9a;margin-bottom:24px;line-height:1.6;">
                Analyze data, run statistical tests, and get AI-powered insights.<br>
                SPC charts, hypothesis testing, DOE, and more.
            </p>
            <div style="text-align:left;background:#0d120d;border-radius:6px;padding:16px;margin-bottom:24px;">
                <div style="color:var(--aw-text);font-weight:500;margin-bottom:12px;">Quick Start:</div>
                <div style="color:#9aaa9a;font-size:13px;line-height:1.8;">
                    1. Load data (your own CSV or try our sample)<br>
                    2. Use the ribbon to run analyses<br>
                    3. Ask the AI Analyst questions about your data
                </div>
            </div>
            <button class="aw-btn aw-btn-primary" onclick="loadSampleAndClose()" style="margin-right:8px;">Try Sample Data</button>
            <button class="aw-btn" onclick="closeOnboarding()">I'll upload my own</button>
        </div>
    </div>
</div>

<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script>
// ============================================================================
// STATE
// ============================================================================
let currentData = null;
let columns = [];
let history = [];
let sessionHistory = [];  // Detailed history for LLM context
let currentAnalysis = null;

// Multi-dataset tab support
let dataTabs = [];  // [{id, name, data_id, columns, preview, rows}]
let activeTabIndex = -1;

// ============================================================================
// DATA TAB MANAGEMENT
// ============================================================================
function addDataTab(dataResult, name = null) {
    const tabId = 'tab_' + Date.now();
    const tabName = name || dataResult.filename || 'Untitled';

    const tab = {
        id: tabId,
        name: tabName,
        data_id: dataResult.id,
        columns: dataResult.columns || [],
        preview: dataResult.preview || [],
        rows: dataResult.rows || 0
    };

    dataTabs.push(tab);
    renderDataTabs();
    switchToTab(dataTabs.length - 1);

    return tabId;
}

function switchToTab(index) {
    if (index < 0 || index >= dataTabs.length) return;

    activeTabIndex = index;
    const tab = dataTabs[index];

    // Update currentData
    currentData = {
        id: tab.data_id,
        filename: tab.name,
        columns: tab.columns,
        preview: tab.preview,
        rows: tab.rows
    };

    // Update UI
    columns = tab.columns;
    updateColumnsPanel(tab.columns);
    renderWorksheet(tab.preview);
    updateStatus(tab.rows, tab.columns?.length || 0);
    renderDataTabs();
}

function closeTab(index, event) {
    if (event) event.stopPropagation();
    if (dataTabs.length <= 1) return; // Keep at least one tab

    dataTabs.splice(index, 1);

    if (activeTabIndex >= dataTabs.length) {
        activeTabIndex = dataTabs.length - 1;
    }

    if (dataTabs.length > 0) {
        switchToTab(activeTabIndex);
    } else {
        currentData = null;
        columns = [];
        activeTabIndex = -1;
        renderDataTabs();
        document.getElementById('worksheet-pane').innerHTML = '<div class="aw-empty"><span>No data loaded</span></div>';
    }
}

function renameTab(index) {
    const newName = prompt('Enter new name:', dataTabs[index].name);
    if (newName && newName.trim()) {
        dataTabs[index].name = newName.trim();
        renderDataTabs();
    }
}

function renderDataTabs() {
    const container = document.getElementById('data-tabs');

    if (dataTabs.length === 0) {
        container.innerHTML = '<span style="color:var(--aw-text-muted);font-size:10px;padding:0 8px;">No data loaded</span>';
        return;
    }

    container.innerHTML = dataTabs.map((tab, i) => `
        <div class="aw-data-tab ${i === activeTabIndex ? 'active' : ''}" onclick="switchToTab(${i})" ondblclick="renameTab(${i})">
            <span class="tab-name">${tab.name}</span>
            ${dataTabs.length > 1 ? `<span class="tab-close" onclick="closeTab(${i}, event)">Ã—</span>` : ''}
        </div>
    `).join('') + `
        <button class="aw-data-tab-add" onclick="openFile()" title="Add data">+</button>
    `;
}

// ============================================================================
// DATA LOADING - Connect to Triage
// ============================================================================
async function openFile() {
    // Show data selection dialog
    document.getElementById('data-dialog').classList.add('active');
    await loadTriageDatasets();
}

async function loadTriageDatasets() {
    const container = document.getElementById('triage-datasets-list');
    container.innerHTML = '<div style="padding:20px;text-align:center;color:#9aaa9a;"><span>Loading...</span></div>';

    try {
        const response = await fetch('/api/triage/datasets/', {
            headers: { 'X-CSRFToken': getCSRFToken() }
        });

        if (!response.ok) throw new Error('Failed to load datasets');

        const result = await response.json();
        const datasets = result.datasets || [];

        if (datasets.length === 0) {
            container.innerHTML = `
                <div class="aw-empty" style="padding:20px;color:#7a8f7a;">
                    <span>No cleaned datasets found.</span>
                    <span style="margin-top:8px;display:block;">Use Triage to clean data first, or upload a file below.</span>
                </div>
            `;
            return;
        }

        container.innerHTML = datasets.map(ds => `
            <div onclick="loadTriageData('${ds.id}')" style="display:flex;align-items:center;gap:8px;padding:10px 12px;margin-bottom:6px;background:#121a12;border:1px solid rgba(74,159,110,0.25);border-radius:4px;cursor:pointer;color:#9aaa9a;" onmouseover="this.style.background='rgba(74,159,110,0.15)';this.style.borderColor='#4a9f6e'" onmouseout="this.style.background='#121a12';this.style.borderColor='rgba(74,159,110,0.25)'">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;flex-shrink:0;">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                </svg>
                <div style="flex:1;min-width:0;">
                    <div style="font-weight:500;color:#e8efe8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${ds.filename}</div>
                    <div style="font-size:9px;color:#7a8f7a;">${new Date(ds.created_at).toLocaleString()}</div>
                </div>
            </div>
        `).join('');

    } catch (err) {
        console.error('Load datasets error:', err);
        container.innerHTML = `<div class="aw-empty" style="padding:20px;color:#d06060;"><span>Error loading datasets</span></div>`;
    }
}

// Sample data loading
async function loadSampleData() {
    closeDialog('data-dialog');
    appendSession('cmd', 'Loading sample data...');

    try {
        const response = await fetch('/static/sample_data/manufacturing_quality.csv');
        const csvText = await response.text();

        // Parse CSV
        const lines = csvText.trim().split('\n');
        const headers = lines[0].split(',');
        const preview = lines.slice(1).map(line => {
            const values = line.split(',');
            const row = {};
            headers.forEach((h, i) => row[h] = values[i]);
            return row;
        });

        // Determine column types
        const cols = headers.map(name => {
            const values = preview.map(r => r[name]);
            const isNumeric = values.every(v => !isNaN(parseFloat(v)) && v.trim() !== '');
            return { name, type: isNumeric ? 'numeric' : 'text' };
        });

        // Create a data object
        const sampleData = {
            id: 'sample_manufacturing',
            filename: 'Manufacturing Quality (Sample)',
            rows: preview.length,
            columns: cols,
            preview: preview
        };

        startNewSession(sampleData);
        appendSession('result', `Loaded sample data: ${preview.length} rows, ${cols.length} columns.
This is manufacturing quality data with temperature, pressure, defect rates, and more.
Try: "describe" or ask the Analyst about correlations.`);

    } catch (err) {
        console.error('Failed to load sample data:', err);
        appendSession('error', 'Failed to load sample data: ' + err.message);
    }
}

function loadSampleAndClose() {
    closeOnboarding();
    loadSampleData();
}

// Onboarding
function showOnboarding() {
    document.getElementById('onboarding-modal').style.display = 'flex';
}

function closeOnboarding() {
    document.getElementById('onboarding-modal').style.display = 'none';
    localStorage.setItem('svend_dsw_onboarded', 'true');
}

function checkOnboarding() {
    if (!localStorage.getItem('svend_dsw_onboarded')) {
        showOnboarding();
    }
}

// Check onboarding on page load
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(checkOnboarding, 500);
});

async function loadTriageData(datasetId) {
    closeDialog('data-dialog');
    appendSession('cmd', `Loading dataset ${datasetId}...`);

    try {
        const response = await fetch(`/api/triage/${datasetId}/load/`, {
            headers: { 'X-CSRFToken': getCSRFToken() }
        });

        if (!response.ok) throw new Error('Failed to load dataset');

        const result = await response.json();
        startNewSession(result);

    } catch (err) {
        console.error('Load error:', err);
        appendSession('error', `Error: ${err.message}`);
    }
}

// ============================================================================
// MODELS SIDEBAR - Load and display saved models
// ============================================================================
async function loadModels() {
    const container = document.getElementById('models-list');
    if (!container) return;

    try {
        const response = await fetch('/api/dsw/models/', {
            headers: { 'X-CSRFToken': getCSRFToken() }
        });

        if (!response.ok) throw new Error('Failed to load models');

        const result = await response.json();
        const models = result.models || [];

        if (models.length === 0) {
            container.innerHTML = '<div class="aw-empty" style="padding:12px;"><span>No models saved</span></div>';
            return;
        }

        container.innerHTML = models.map(m => `
            <div class="aw-sidebar-item model-item" data-model-id="${m.id}"
                 onclick="showModelDetails('${m.id}')"
                 title="${m.model_type}\n${m.features?.join(', ') || ''}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${m.name}</span>
                <span style="font-size:9px;color:var(--aw-text-muted);">${formatRelativeTime(m.created_at)}</span>
            </div>
        `).join('');

    } catch (err) {
        container.innerHTML = '<div class="aw-empty" style="padding:12px;color:#e85747;"><span>Error loading models</span></div>';
    }
}

function formatRelativeTime(isoDate) {
    const date = new Date(isoDate);
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);

    if (minutes < 1) return 'now';
    if (minutes < 60) return `${minutes}m`;
    if (hours < 24) return `${hours}h`;
    if (days < 7) return `${days}d`;
    return date.toLocaleDateString();
}

function showModelDetails(modelId) {
    // Find model in sidebar and show details/actions
    fetch(`/api/dsw/models/`, {
        headers: { 'X-CSRFToken': getCSRFToken() }
    })
    .then(r => r.json())
    .then(result => {
        const model = result.models?.find(m => m.id === modelId);
        if (!model) return;

        // Show model details dialog
        const dialog = document.getElementById('config-dialog');
        const title = document.getElementById('config-dialog-title');
        const body = document.getElementById('config-dialog-body');
        const runBtn = document.getElementById('run-analysis-btn');

        title.textContent = model.name;
        body.innerHTML = `
            <div style="padding:8px 0;">
                <div style="margin-bottom:12px;">
                    <strong style="color:var(--aw-text-muted);">Type:</strong>
                    <span style="color:var(--aw-text);">${model.model_type}</span>
                </div>
                <div style="margin-bottom:12px;">
                    <strong style="color:var(--aw-text-muted);">Target:</strong>
                    <span style="color:var(--aw-accent);">${model.target || 'N/A'}</span>
                </div>
                <div style="margin-bottom:12px;">
                    <strong style="color:var(--aw-text-muted);">Features:</strong>
                    <div style="color:var(--aw-text);font-size:11px;margin-top:4px;max-height:80px;overflow-y:auto;">
                        ${model.features?.join(', ') || 'N/A'}
                    </div>
                </div>
                ${model.metrics ? `
                <div style="margin-bottom:12px;">
                    <strong style="color:var(--aw-text-muted);">Metrics:</strong>
                    <div style="color:var(--aw-text);font-size:11px;margin-top:4px;">
                        ${Object.entries(model.metrics).map(([k,v]) => `${k}: ${v?.toFixed?.(4) || v}`).join(', ')}
                    </div>
                </div>
                ` : ''}
                <div style="margin-bottom:12px;">
                    <strong style="color:var(--aw-text-muted);">Created:</strong>
                    <span style="color:var(--aw-text);">${new Date(model.created_at).toLocaleString()}</span>
                </div>
            </div>
            <div style="display:flex;gap:8px;padding-top:12px;border-top:1px solid var(--aw-border);">
                <button onclick="runSavedModel('${model.id}')" class="aw-btn" style="flex:1;">
                    Run on Current Data
                </button>
                <button onclick="downloadModel('${model.id}')" class="aw-btn" style="background:transparent;border:1px solid var(--aw-border);">
                    Download
                </button>
                <button onclick="deleteModel('${model.id}')" class="aw-btn" style="background:#e85747;">
                    Delete
                </button>
            </div>
        `;
        runBtn.style.display = 'none';
        dialog.classList.add('active');
    });
}

async function runSavedModel(modelId) {
    if (!currentData?.id) {
        alert('Please load data first');
        return;
    }

    closeDialog('config-dialog');
    appendSession('cmd', 'Running saved model...');

    try {
        const response = await fetch(`/api/dsw/models/${modelId}/run/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ data_id: currentData.id })
        });

        const result = await response.json();

        if (!response.ok) throw new Error(result.error || 'Failed to run model');

        if (result.summary) {
            appendSession('result', result.summary);
        }
        if (result.predictions) {
            appendSession('result', `Predictions generated: ${result.predictions.length} values`);
        }

    } catch (err) {
        appendSession('error', `Error: ${err.message}`);
    }
}

async function downloadModel(modelId) {
    window.open(`/api/dsw/models/${modelId}/`, '_blank');
}

async function deleteModel(modelId) {
    if (!confirm('Delete this model permanently?')) return;

    try {
        const response = await fetch(`/api/dsw/models/${modelId}/delete/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCSRFToken() }
        });

        if (!response.ok) throw new Error('Failed to delete');

        closeDialog('config-dialog');
        loadModels();
        appendSession('info', 'Model deleted');

    } catch (err) {
        appendSession('error', `Error: ${err.message}`);
    }
}

// Load models on page load
setTimeout(loadModels, 100);

// ============================================================================
// PROJECT/INQUIRY INTEGRATION
// ============================================================================
let currentProject = null;
let projectHypotheses = [];

async function loadProjects() {
    const selector = document.getElementById('project-selector');
    if (!selector) return;

    try {
        const response = await fetch('/api/core/projects/', {
            credentials: 'include',
            headers: { 'X-CSRFToken': getCSRFToken() }
        });

        if (!response.ok) return;

        const projects = await response.json();

        selector.innerHTML = '<option value="">None</option>' +
            projects.map(p => `<option value="${p.id}">${p.title}</option>`).join('');

        // Restore selection if any
        if (currentProject) {
            selector.value = currentProject;
        }

    } catch (err) {
        console.error('Failed to load projects:', err);
    }
}

// Load projects on page load, then check for URL param
setTimeout(async () => {
    await loadProjects();

    // Auto-select project from URL param
    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('project');
    if (projectId) {
        const selector = document.getElementById('project-selector');
        if (selector) {
            selector.value = projectId;
            // Load hypotheses for this project
            await onProjectChange(projectId);
        }
    }
}, 150);

// Check if enterprise user and show model selector
document.addEventListener('DOMContentLoaded', async () => {
    try {
        const res = await fetch('/api/auth/me/', { credentials: 'include' });
        if (res.ok) {
            const data = await res.json();
            if (data.tier === 'enterprise') {
                document.getElementById('dsw-model-selector').style.display = 'block';
            }
        }
    } catch (e) {}
});

// Handle project selection change
async function onProjectChange(projectId) {
    currentProject = projectId || null;
    projectHypotheses = [];

    if (currentProject) {
        // Load hypotheses for this project from core API
        try {
            const response = await fetch(`/api/core/projects/${currentProject}/hypotheses/`, {
                credentials: 'include',
                headers: { 'X-CSRFToken': getCSRFToken() }
            });
            if (response.ok) {
                projectHypotheses = await response.json();
                console.log(`Loaded ${projectHypotheses.length} hypotheses for project`);
            }
        } catch (err) {
            console.error('Failed to load hypotheses:', err);
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const selector = document.getElementById('project-selector');
    if (selector) {
        selector.addEventListener('change', (e) => onProjectChange(e.target.value));
    }
});

// Show Synara integration UI for Bayesian weights
function showSynaraIntegration(coefficients, features, target) {
    if (!currentProject) return; // Fail quietly if no project selected

    if (projectHypotheses.length === 0) {
        // No hypotheses to map to
        return;
    }

    const session = document.getElementById('session-output');
    const div = document.createElement('div');
    div.className = 'synara-integration';
    div.style.cssText = 'margin:12px 0;padding:16px;background:rgba(74,159,110,0.08);border:1px solid var(--aw-accent);border-radius:8px;';

    // Build mapping UI - filter to active hypotheses
    const hypothesisOptions = projectHypotheses
        .filter(h => h.status === 'investigating' || h.status === 'proposed')
        .map(h => `<option value="${h.id}">${h.statement.substring(0, 80)}${h.statement.length > 80 ? '...' : ''}</option>`)
        .join('');

    const mappingRows = features.map((feat, i) => {
        const coef = coefficients[i];
        const significant = coef.ci_low > 0 || coef.ci_high < 0;
        const sigClass = significant ? 'color:var(--aw-accent);font-weight:600;' : 'color:var(--aw-text-muted);';

        return `
            <tr style="border-bottom:1px solid rgba(74,159,110,0.2);">
                <td style="padding:8px;${sigClass}">${feat}</td>
                <td style="padding:8px;text-align:right;font-family:monospace;${sigClass}">
                    ${coef.mean.toFixed(4)}
                    <span style="font-size:10px;opacity:0.7;">[${coef.ci_low.toFixed(3)}, ${coef.ci_high.toFixed(3)}]</span>
                </td>
                <td style="padding:8px;">
                    <select class="synara-map" data-feature="${feat}" data-coef="${coef.mean}" style="width:100%;padding:4px;font-size:11px;background:var(--aw-bg-tertiary);border:1px solid var(--aw-border);color:var(--aw-text);border-radius:4px;">
                        <option value="">-- Skip --</option>
                        ${hypothesisOptions}
                    </select>
                </td>
            </tr>
        `;
    }).join('');

    div.innerHTML = `
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="var(--aw-accent)" stroke-width="2" style="width:20px;height:20px;">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
            </svg>
            <strong style="color:var(--aw-accent);font-size:13px;">Feed Weights to Synara</strong>
            <span style="font-size:11px;color:var(--aw-text-muted);margin-left:auto;">
                Project: ${document.getElementById('project-selector')?.selectedOptions[0]?.text || 'Unknown'}
            </span>
        </div>
        <p style="font-size:11px;color:var(--aw-text-muted);margin-bottom:12px;">
            Map data variables to hypotheses. Coefficients become edge weights (cause â†’ ${target}).
        </p>
        <table style="width:100%;border-collapse:collapse;font-size:11px;">
            <thead>
                <tr style="background:rgba(74,159,110,0.1);">
                    <th style="padding:8px;text-align:left;">Variable</th>
                    <th style="padding:8px;text-align:right;">Coefficient [95% CI]</th>
                    <th style="padding:8px;text-align:left;">Maps to Hypothesis</th>
                </tr>
            </thead>
            <tbody>
                ${mappingRows}
            </tbody>
        </table>
        <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
            <button onclick="this.closest('.synara-integration').remove()" class="aw-btn" style="background:transparent;border:1px solid var(--aw-border);">
                Cancel
            </button>
            <button onclick="applySynaraWeights('${target}')" class="aw-btn">
                Apply to Synara
            </button>
        </div>
    `;

    session.appendChild(div);
    session.scrollTop = session.scrollHeight;
}

async function applySynaraWeights(target) {
    if (!currentProject) return;

    const mappings = [];
    document.querySelectorAll('.synara-map').forEach(select => {
        if (select.value) {
            mappings.push({
                feature: select.dataset.feature,
                coefficient: parseFloat(select.dataset.coef),
                hypothesis_id: select.value
            });
        }
    });

    if (mappings.length === 0) {
        appendSession('info', 'No mappings selected');
        return;
    }

    try {
        // Group mappings by hypothesis for batch processing
        const hypothesisIds = [...new Set(mappings.map(m => m.hypothesis_id))];
        const likelihoodRatios = {};
        const coefficientsSummary = [];

        for (const mapping of mappings) {
            // Convert coefficient to likelihood ratio
            // Positive coefficient = supports (LR > 1), negative = weakens (LR < 1)
            // Scale: |coef| of 0.5 â†’ LR of ~3, |coef| of 1.0 â†’ LR of ~10
            const absCoef = Math.abs(mapping.coefficient);
            const baseLR = 1 + absCoef * 9; // Maps 0â†’1, 1â†’10
            const lr = mapping.coefficient >= 0 ? baseLR : 1 / baseLR;

            // Accumulate if same hypothesis mapped multiple times
            if (likelihoodRatios[mapping.hypothesis_id]) {
                likelihoodRatios[mapping.hypothesis_id] *= lr;
            } else {
                likelihoodRatios[mapping.hypothesis_id] = lr;
            }

            coefficientsSummary.push(`${mapping.feature}=${mapping.coefficient.toFixed(4)}`);
        }

        // Create evidence via core API
        const response = await fetch('/api/core/evidence/from-analysis/', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                project_id: currentProject,
                hypothesis_ids: hypothesisIds,
                summary: `Bayesian regression analysis: ${coefficientsSummary.join(', ')} â†’ ${target}`,
                analysis_type: 'bayesian_regression',
                results: {
                    target: target,
                    coefficients: mappings.map(m => ({
                        feature: m.feature,
                        value: m.coefficient
                    }))
                },
                metrics: {
                    coefficient_count: mappings.length
                },
                likelihood_ratios: likelihoodRatios,
                confidence: 0.85
            })
        });

        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error || 'Failed to save evidence');
        }

        // Remove the integration UI
        document.querySelector('.synara-integration')?.remove();

        appendSession('result', `âœ“ Applied ${mappings.length} weight(s) as evidence to project`);

    } catch (err) {
        appendSession('error', `Failed to apply weights: ${err.message}`);
    }
}

// ============================================================================
// DATA STATISTICS â†’ HYPOTHESIS CONDITIONS
// ============================================================================

// Show UI to evaluate data statistics against hypothesis conditions
function showStatisticsEvidence(statistics) {
    if (!currentProject) return; // Fail quietly
    if (projectHypotheses.length === 0) return;

    const session = document.getElementById('session-output');
    const div = document.createElement('div');
    div.className = 'statistics-evidence';
    div.style.cssText = 'margin:12px 0;padding:16px;background:rgba(71,165,232,0.08);border:1px solid #47a5e8;border-radius:8px;';

    const hypothesisOptions = projectHypotheses
        .filter(h => h.status === 'investigating' || h.status === 'proposed')
        .map(h => `<option value="${h.id}">${h.statement.substring(0, 60)}${h.statement.length > 60 ? '...' : ''}</option>`)
        .join('');

    const statsRows = statistics.map((stat, i) => `
        <tr style="border-bottom:1px solid rgba(71,165,232,0.2);">
            <td style="padding:8px;color:var(--aw-text);">
                <strong>${stat.name}</strong>
                <span style="color:var(--aw-text-muted);font-size:10px;margin-left:4px;">${stat.variable || ''}</span>
            </td>
            <td style="padding:8px;font-family:monospace;color:#47a5e8;font-weight:600;">
                ${typeof stat.value === 'number' ? stat.value.toFixed(4) : stat.value}
            </td>
            <td style="padding:8px;">
                <select class="stat-hypothesis" data-stat-idx="${i}" style="width:100%;padding:4px;font-size:10px;background:var(--aw-bg-tertiary);border:1px solid var(--aw-border);color:var(--aw-text);border-radius:4px;">
                    <option value="">-- Skip --</option>
                    ${hypothesisOptions}
                </select>
            </td>
            <td style="padding:8px;">
                <select class="stat-direction" data-stat-idx="${i}" style="padding:4px;font-size:10px;background:var(--aw-bg-tertiary);border:1px solid var(--aw-border);color:var(--aw-text);border-radius:4px;">
                    <option value="supports">Supports âœ“</option>
                    <option value="weakens">Weakens âœ—</option>
                </select>
            </td>
        </tr>
    `).join('');

    div.innerHTML = `
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="#47a5e8" stroke-width="2" style="width:20px;height:20px;">
                <path d="M3 3v18h18"/>
                <path d="M18 9l-5 5-4-4-3 3"/>
            </svg>
            <strong style="color:#47a5e8;font-size:13px;">Use Statistics as Evidence</strong>
            <span style="font-size:11px;color:var(--aw-text-muted);margin-left:auto;">
                Project: ${document.getElementById('project-selector')?.selectedOptions[0]?.text || 'Unknown'}
            </span>
        </div>
        <p style="font-size:11px;color:var(--aw-text-muted);margin-bottom:12px;">
            Map computed statistics to hypotheses as supporting/weakening evidence.
            <br>Example: <code>mean(weight)=8.2</code> supports hypothesis <code>"if weight &lt; 10..."</code>
        </p>
        <table style="width:100%;border-collapse:collapse;font-size:11px;">
            <thead>
                <tr style="background:rgba(71,165,232,0.1);">
                    <th style="padding:8px;text-align:left;">Statistic</th>
                    <th style="padding:8px;text-align:left;">Value</th>
                    <th style="padding:8px;text-align:left;">Hypothesis</th>
                    <th style="padding:8px;text-align:left;">Effect</th>
                </tr>
            </thead>
            <tbody>
                ${statsRows}
            </tbody>
        </table>
        <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
            <button onclick="this.closest('.statistics-evidence').remove()" class="aw-btn" style="background:transparent;border:1px solid var(--aw-border);">
                Cancel
            </button>
            <button onclick="applyStatisticsEvidence()" class="aw-btn" style="background:#47a5e8;">
                Add Evidence
            </button>
        </div>
    `;

    // Store statistics data for later
    div.dataset.statistics = JSON.stringify(statistics);

    session.appendChild(div);
    session.scrollTop = session.scrollHeight;
}

async function applyStatisticsEvidence() {
    if (!currentProject) return;

    const container = document.querySelector('.statistics-evidence');
    const statistics = JSON.parse(container?.dataset.statistics || '[]');

    const evidenceItems = [];
    container.querySelectorAll('.stat-hypothesis').forEach((select, i) => {
        if (select.value) {
            const directionSelect = container.querySelector(`.stat-direction[data-stat-idx="${i}"]`);
            const stat = statistics[i];
            evidenceItems.push({
                stat: stat,
                hypothesis_id: select.value,
                direction: directionSelect?.value || 'supports'
            });
        }
    });

    if (evidenceItems.length === 0) {
        appendSession('info', 'No evidence mappings selected');
        return;
    }

    try {
        // Group by hypothesis and build likelihood ratios
        const hypothesisIds = [...new Set(evidenceItems.map(e => e.hypothesis_id))];
        const likelihoodRatios = {};
        const summaryParts = [];

        for (const item of evidenceItems) {
            const valueStr = typeof item.stat.value === 'number'
                ? item.stat.value.toFixed(4)
                : item.stat.value;
            const statDesc = `${item.stat.name}${item.stat.variable ? '(' + item.stat.variable + ')' : ''}=${valueStr}`;
            summaryParts.push(statDesc);

            // Convert direction to likelihood ratio
            // supports â†’ LR > 1, weakens â†’ LR < 1
            const baseLR = item.direction === 'supports' ? 2.0 : 0.5;

            if (likelihoodRatios[item.hypothesis_id]) {
                likelihoodRatios[item.hypothesis_id] *= baseLR;
            } else {
                likelihoodRatios[item.hypothesis_id] = baseLR;
            }
        }

        // Create evidence via core API
        const response = await fetch('/api/core/evidence/from-analysis/', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                project_id: currentProject,
                hypothesis_ids: hypothesisIds,
                summary: `Data statistics: ${summaryParts.join(', ')}`,
                analysis_type: 'descriptive_statistics',
                results: {
                    statistics: evidenceItems.map(e => ({
                        name: e.stat.name,
                        variable: e.stat.variable,
                        value: e.stat.value,
                        direction: e.direction
                    }))
                },
                metrics: {
                    statistic_count: evidenceItems.length
                },
                likelihood_ratios: likelihoodRatios,
                confidence: 0.7
            })
        });

        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error || 'Failed to save evidence');
        }

        container?.remove();
        appendSession('result', `âœ“ Added statistics as evidence to project`);

    } catch (err) {
        appendSession('error', `Failed to add evidence: ${err.message}`);
    }
}

// Extract statistics from analysis results
function extractStatistics(result, analysisType) {
    const stats = [];

    // From summary text - look for patterns like "Mean: 1.234" or "RÂ²: 0.95"
    if (result.summary) {
        const patterns = [
            /(?:Mean|Average|Avg)[:\s=]+([+-]?\d+\.?\d*)/gi,
            /(?:Median)[:\s=]+([+-]?\d+\.?\d*)/gi,
            /(?:Std\.?\s*Dev\.?|StdDev|SD)[:\s=]+([+-]?\d+\.?\d*)/gi,
            /(?:Min|Minimum)[:\s=]+([+-]?\d+\.?\d*)/gi,
            /(?:Max|Maximum)[:\s=]+([+-]?\d+\.?\d*)/gi,
            /(?:RÂ²|R-squared|R2)[:\s=]+([+-]?\d+\.?\d*)/gi,
            /(?:RMSE)[:\s=]+([+-]?\d+\.?\d*)/gi,
            /(?:Accuracy)[:\s=]+([+-]?\d+\.?\d*)/gi,
            /(?:Count|N|n)[:\s=]+(\d+)/gi,
        ];

        for (const pattern of patterns) {
            let match;
            while ((match = pattern.exec(result.summary)) !== null) {
                const name = match[0].split(/[:\s=]+/)[0].trim();
                const value = parseFloat(match[1]);
                if (!isNaN(value)) {
                    stats.push({ name, value, variable: '' });
                }
            }
        }
    }

    // From explicit statistics in result
    if (result.statistics) {
        for (const [key, value] of Object.entries(result.statistics)) {
            if (typeof value === 'number') {
                stats.push({ name: key, value, variable: '' });
            }
        }
    }

    // From descriptive stats results
    if (result.descriptive_stats) {
        for (const [variable, vstats] of Object.entries(result.descriptive_stats)) {
            for (const [statName, value] of Object.entries(vstats)) {
                if (typeof value === 'number') {
                    stats.push({ name: statName, value, variable });
                }
            }
        }
    }

    return stats;
}

async function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Update dialog to show upload progress
    const dialogBody = document.getElementById('data-dialog-body');
    dialogBody.innerHTML = `
        <div style="text-align:center;padding:20px;">
            <div class="loading-spinner" style="margin:0 auto 16px;"></div>
            <div style="color:var(--aw-text);margin-bottom:4px;">Uploading ${file.name}...</div>
            <div style="color:var(--aw-text-muted);font-size:11px;">Please wait</div>
        </div>
    `;

    const formData = new FormData();
    formData.append('file', file);

    try {
        // Step 1: Upload data
        const uploadResponse = await fetch('/api/dsw/upload-data/', {
            method: 'POST',
            headers: { 'X-CSRFToken': getCSRFToken() },
            body: formData
        });

        if (!uploadResponse.ok) throw new Error('Upload failed');
        const uploadResult = await uploadResponse.json();

        // Step 2: Scan for issues
        dialogBody.innerHTML = `
            <div style="text-align:center;padding:20px;">
                <div class="loading-spinner" style="margin:0 auto 16px;"></div>
                <div style="color:var(--aw-text);margin-bottom:4px;">Scanning for data issues...</div>
                <div style="color:var(--aw-text-muted);font-size:11px;">${uploadResult.rows} rows, ${uploadResult.columns?.length || 0} columns</div>
            </div>
        `;

        const scanResponse = await fetch('/api/dsw/triage/scan/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ data_id: uploadResult.id })
        });

        if (scanResponse.ok) {
            const scanResult = await scanResponse.json();

            if (scanResult.success && scanResult.has_issues) {
                // Show issues in the dialog
                showTriageInDialog(scanResult.issues, uploadResult);
                return;
            }
        }

        // No issues - close dialog and load data
        closeDialog('data-dialog');
        startNewSession(uploadResult);

    } catch (err) {
        dialogBody.innerHTML = `
            <div style="text-align:center;padding:20px;">
                <div style="color:#e85747;font-size:24px;margin-bottom:12px;">âœ•</div>
                <div style="color:#e85747;margin-bottom:12px;">${err.message}</div>
                <button class="aw-btn" onclick="resetDataDialog()">Try Again</button>
            </div>
        `;
    }
}

function showTriageInDialog(issues, uploadResult) {
    const dialogBody = document.getElementById('data-dialog-body');

    // Store for later use
    window.pendingUploadData = uploadResult;
    window.pendingIssues = issues;

    // Build issue options with user control
    let optionsHtml = '';

    if (issues.totals.excel_errors > 0) {
        const cols = Object.keys(issues.excel_errors).slice(0, 5).join(', ');
        optionsHtml += `
            <div class="triage-option">
                <label class="triage-option-header">
                    <input type="checkbox" id="fix-excel" checked>
                    <span class="triage-icon" style="color:#e85747;">âš </span>
                    <span>Excel Errors</span>
                    <span class="triage-count">${issues.totals.excel_errors}</span>
                </label>
                <div class="triage-detail">
                    <div class="triage-cols">${cols}</div>
                    <div class="triage-action">Action: Replace #NUM!, #DIV/0!, etc. with empty (NaN)</div>
                </div>
            </div>
        `;
    }

    if (issues.totals.missing > 0) {
        const missingList = Object.entries(issues.missing).sort((a,b) => b[1].count - a[1].count).slice(0,5);
        const cols = missingList.map(([c,d]) => `${c} (${d.percent}%)`).join(', ');
        optionsHtml += `
            <div class="triage-option">
                <label class="triage-option-header">
                    <input type="checkbox" id="fix-missing" checked>
                    <span class="triage-icon" style="color:#e89547;">â—‹</span>
                    <span>Missing Values</span>
                    <span class="triage-count">${issues.totals.missing}</span>
                </label>
                <div class="triage-detail">
                    <div class="triage-cols">${cols}</div>
                    <div class="triage-action">
                        Action:
                        <select id="missing-action" style="font-size:10px;padding:2px 4px;background:#1a261a;border:1px solid rgba(74,159,110,0.3);color:var(--aw-text);border-radius:3px;">
                            <option value="impute_mean">Impute with mean (numeric) / mode (text)</option>
                            <option value="impute_median">Impute with median (numeric)</option>
                            <option value="drop_rows">Drop rows with missing values</option>
                            <option value="leave">Leave as-is (keep NaN)</option>
                        </select>
                    </div>
                </div>
            </div>
        `;
    }

    if (issues.totals.outliers > 0) {
        const outlierList = Object.entries(issues.outliers).sort((a,b) => b[1].count - a[1].count).slice(0,5);
        const cols = outlierList.map(([c,d]) => `${c} (${d.count})`).join(', ');
        optionsHtml += `
            <div class="triage-option">
                <label class="triage-option-header">
                    <input type="checkbox" id="fix-outliers">
                    <span class="triage-icon" style="color:#e8c547;">â—†</span>
                    <span>Outliers (IQR)</span>
                    <span class="triage-count">${issues.totals.outliers}</span>
                </label>
                <div class="triage-detail">
                    <div class="triage-cols">${cols}</div>
                    <div class="triage-action">
                        Action:
                        <select id="outlier-action" style="font-size:10px;padding:2px 4px;background:#1a261a;border:1px solid rgba(74,159,110,0.3);color:var(--aw-text);border-radius:3px;">
                            <option value="flag">Flag only (add _outlier column)</option>
                            <option value="remove">Remove outlier rows</option>
                            <option value="clip">Clip to IQR bounds</option>
                        </select>
                    </div>
                </div>
            </div>
        `;
    }

    if (issues.totals.type_issues > 0) {
        const cols = issues.type_issues.slice(0,5).map(t => t.column).join(', ');
        optionsHtml += `
            <div class="triage-option">
                <label class="triage-option-header">
                    <input type="checkbox" id="fix-types" checked>
                    <span class="triage-icon" style="color:#47a5e8;">T</span>
                    <span>Type Conversion</span>
                    <span class="triage-count">${issues.totals.type_issues}</span>
                </label>
                <div class="triage-detail">
                    <div class="triage-cols">${cols}</div>
                    <div class="triage-action">Action: Convert text columns to numeric where possible</div>
                </div>
            </div>
        `;
    }

    const totalIssues = issues.totals.excel_errors + issues.totals.missing + issues.totals.outliers + issues.totals.type_issues;

    dialogBody.innerHTML = `
        <style>
            .triage-option { border:1px solid rgba(74,159,110,0.2); border-radius:4px; margin-bottom:8px; background:rgba(0,0,0,0.2); }
            .triage-option-header { display:flex; align-items:center; gap:8px; padding:8px 10px; cursor:pointer; font-size:11px; }
            .triage-option-header input { width:auto; margin:0; }
            .triage-icon { font-size:14px; }
            .triage-count { margin-left:auto; color:var(--aw-accent); font-weight:600; }
            .triage-detail { padding:0 10px 10px 32px; font-size:10px; }
            .triage-cols { color:var(--aw-text-muted); margin-bottom:4px; }
            .triage-action { color:var(--aw-text-dim); }
        </style>
        <div style="background:rgba(74,159,110,0.1);padding:12px;margin:-16px -16px 16px;border-bottom:1px solid rgba(74,159,110,0.2);">
            <div style="font-weight:500;color:var(--aw-text);margin-bottom:4px;">"${uploadResult.filename}"</div>
            <div style="font-size:11px;color:var(--aw-text-muted);">${uploadResult.rows} rows Ã— ${uploadResult.columns?.length || 0} columns â€” ${totalIssues} potential issues found</div>
        </div>
        <div style="margin-bottom:12px;font-size:11px;color:var(--aw-text-muted);">
            Select which issues to fix:
        </div>
        <div style="max-height:250px;overflow-y:auto;margin-bottom:12px;">
            ${optionsHtml || '<div style="color:var(--aw-text-muted);padding:12px;text-align:center;">No issues detected</div>'}
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;border-top:1px solid rgba(74,159,110,0.2);padding-top:12px;">
            <button class="aw-btn" onclick="loadWithoutCleaning()">Use Original</button>
            <button class="aw-btn aw-btn-primary" onclick="cleanAndLoad()">Apply & Load</button>
        </div>
    `;
}

function loadWithoutCleaning() {
    closeDialog('data-dialog');
    if (window.pendingUploadData) {
        // New upload - start new session
        if (window.pendingUploadData.id !== currentData?.id) {
            startNewSession(window.pendingUploadData);
        }
        window.pendingUploadData = null;
        window.pendingIssues = null;
    }
}

async function cleanAndLoad() {
    const dialogBody = document.getElementById('data-dialog-body');
    const data = window.pendingUploadData;
    const isNewUpload = data && data.id !== currentData?.id;

    if (!data) return;

    // Collect user options
    const options = {
        fix_excel: document.getElementById('fix-excel')?.checked ?? false,
        fix_missing: document.getElementById('fix-missing')?.checked ?? false,
        missing_action: document.getElementById('missing-action')?.value || 'impute_mean',
        fix_outliers: document.getElementById('fix-outliers')?.checked ?? false,
        outlier_action: document.getElementById('outlier-action')?.value || 'flag',
        fix_types: document.getElementById('fix-types')?.checked ?? false,
    };

    // If nothing selected, just load original
    if (!options.fix_excel && !options.fix_missing && !options.fix_outliers && !options.fix_types) {
        loadWithoutCleaning();
        return;
    }

    dialogBody.innerHTML = `
        <div style="text-align:center;padding:20px;">
            <div class="loading-spinner" style="margin:0 auto 16px;"></div>
            <div style="color:var(--aw-text);">Applying changes...</div>
        </div>
    `;

    try {
        const response = await fetch('/api/dsw/triage/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                data_id: data.id,
                options: options
            })
        });

        if (!response.ok) {
            const errData = await response.json().catch(() => ({}));
            throw new Error(errData.error || 'Cleaning failed');
        }

        const result = await response.json();

        if (result.success) {
            result.data.filename = (data.filename || 'Data') + ' (Cleaned)';
            closeDialog('data-dialog');

            if (isNewUpload) {
                // New upload - start fresh session with cleaned data
                startNewSession(result.data);
            } else {
                // Existing data - add as new tab
                addDataTab(result.data, result.data.filename);
            }

            // Show detailed summary
            let summary = '**Data Cleaned**\n';
            if (result.changes) {
                if (result.changes.excel_errors > 0) summary += `- Replaced ${result.changes.excel_errors} Excel errors with NaN\n`;
                if (result.changes.missing_filled > 0) summary += `- Filled ${result.changes.missing_filled} missing values\n`;
                if (result.changes.missing_dropped > 0) summary += `- Dropped ${result.changes.missing_dropped} rows with missing values\n`;
                if (result.changes.outliers_flagged > 0) summary += `- Flagged ${result.changes.outliers_flagged} outliers\n`;
                if (result.changes.outliers_removed > 0) summary += `- Removed ${result.changes.outliers_removed} outlier rows\n`;
                if (result.changes.outliers_clipped > 0) summary += `- Clipped ${result.changes.outliers_clipped} outlier values\n`;
                if (result.changes.types_converted > 0) summary += `- Converted ${result.changes.types_converted} columns to numeric\n`;
            }
            summary += `\nResult: ${result.data.rows} rows Ã— ${result.data.columns?.length || 0} columns`;
            appendSession('result', summary);
        } else {
            throw new Error(result.error || 'Cleaning failed');
        }

        window.pendingUploadData = null;
        window.pendingIssues = null;

    } catch (err) {
        // Show error prominently in dialog
        console.error('Triage error:', err);
        dialogBody.innerHTML = `
            <div style="padding:16px;">
                <div style="background:rgba(232,87,71,0.15);border:1px solid rgba(232,87,71,0.4);border-radius:4px;padding:12px;margin-bottom:16px;">
                    <div style="color:#e85747;font-weight:500;margin-bottom:4px;">Cleaning Failed</div>
                    <div style="color:var(--aw-text-muted);font-size:11px;">${err.message}</div>
                </div>
                <div style="display:flex;gap:8px;justify-content:flex-end;">
                    <button class="aw-btn" onclick="showTriageInDialog(window.pendingIssues, window.pendingUploadData)">Try Again</button>
                    <button class="aw-btn aw-btn-primary" onclick="loadWithoutCleaning()">Use Original Data</button>
                </div>
            </div>
        `;
    }
}

function resetDataDialog() {
    // Reset to original state
    const dialogBody = document.getElementById('data-dialog-body');
    dialogBody.innerHTML = `
        <p style="color:#9aaa9a;margin-bottom:12px;">Select a cleaned dataset from Triage or upload a new file:</p>
        <div id="triage-datasets-list" style="margin-bottom:16px;">
            <div class="aw-empty" style="padding:20px;color:#7a8f7a;"><span>Loading datasets...</span></div>
        </div>
        <div style="border-top:1px solid rgba(74,159,110,0.25);padding-top:12px;">
            <p style="color:#9aaa9a;margin-bottom:8px;">Or upload a new file:</p>
            <input type="file" id="file-upload-input" accept=".csv,.xlsx,.xls" style="display:none;" onchange="handleFileUpload(event)">
            <button class="aw-btn" onclick="document.getElementById('file-upload-input').click()">Upload CSV/Excel</button>
        </div>
    `;
    loadTriageDatasets();
}

function startNewSession(dataResult) {
    // Clear session state
    sessionHistory = [];
    history = [];

    // Clear history sidebar
    document.getElementById('history-list').innerHTML = '';

    // Clear graphs pane
    document.getElementById('graph-pane').innerHTML = '<div style="padding:20px;color:#7a8f7a;text-align:center;">Run an analysis to see graphs</div>';

    // Reset assistant messages
    document.getElementById('assistant-messages').innerHTML = `
        <div style="padding:8px;background:var(--aw-accent-dim);border-left:2px solid var(--aw-accent);margin-bottom:8px;font-size:11px;border-radius:3px;">
            <strong style="color:var(--aw-accent);">Assistant:</strong> <span style="color:var(--aw-text-dim);">New session started with "${dataResult.filename}". I can help with statistical analysis, visualizations, and interpreting results.</span>
        </div>
    `;

    // Add session separator to output
    const session = document.getElementById('session-output');
    session.innerHTML += `
        <div style="border-top:1px solid var(--aw-border);margin:12px 0;padding-top:8px;color:var(--aw-text-muted);font-size:10px;">
            â”â”â” New Session: ${new Date().toLocaleString()} â”â”â”
        </div>
    `;

    // Add as new tab (or first tab)
    addDataTab(dataResult);

    // Update data panel (sidebar)
    updateDataPanel(dataResult.filename);

    appendSession('result', `Loaded "${dataResult.filename}": ${dataResult.rows} rows, ${dataResult.columns?.length || 0} columns.`);
}

// Add transformed data as new tab
function addTransformedData(dataResult, operation) {
    const baseName = dataTabs[activeTabIndex]?.name || 'Data';
    const newName = `${baseName} (${operation})`;
    addDataTab(dataResult, newName);
    appendSession('result', `Created "${newName}": ${dataResult.rows} rows, ${dataResult.columns?.length || 0} columns.`);
}

// Download current data
async function downloadCurrentData() {
    if (!currentData?.id) {
        alert('No data loaded');
        return;
    }

    try {
        const response = await fetch('/api/dsw/download/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ data_id: currentData.id })
        });

        if (!response.ok) throw new Error('Download failed');

        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = (currentData.filename || 'data') + '.csv';
        a.click();
        URL.revokeObjectURL(url);

        appendSession('result', `Downloaded "${currentData.filename}"`);
    } catch (err) {
        appendSession('error', `Download failed: ${err.message}`);
    }
}

function updateDataPanel(filename) {
    document.getElementById('data-files-list').innerHTML = `
        <div class="aw-sidebar-item active">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            </svg>
            <span>${filename}</span>
        </div>
    `;
}

function updateColumnsPanel(cols) {
    columns = cols;
    const list = document.getElementById('columns-list');

    if (!cols || cols.length === 0) {
        list.innerHTML = '<div class="aw-empty" style="padding:12px;"><span>No columns</span></div>';
        return;
    }

    list.innerHTML = cols.map((col, i) => `
        <div class="aw-sidebar-item" onclick="insertColumn('${col.name}')">
            <span>C${i+1}: ${col.name}</span>
            <span class="aw-var-badge ${col.dtype === 'numeric' ? 'num' : col.dtype === 'datetime' ? 'date' : 'cat'}">${col.dtype === 'numeric' ? 'N' : col.dtype === 'datetime' ? 'D' : 'T'}</span>
        </div>
    `).join('');
}

function insertColumn(name) {
    const input = document.getElementById('cmd-input');
    input.value += `'${name}' `;
    input.focus();
}

// ============================================================================
// TRIAGE - Toolbar button to scan and clean current data
// ============================================================================
async function openTriageScan() {
    if (!currentData?.id) {
        appendSession('error', 'No data loaded. Upload data first.');
        return;
    }

    // Show the data dialog with scan results
    document.getElementById('data-dialog').classList.add('active');
    const dialogBody = document.getElementById('data-dialog-body');

    dialogBody.innerHTML = `
        <div style="text-align:center;padding:20px;">
            <div class="loading-spinner" style="margin:0 auto 16px;"></div>
            <div style="color:var(--aw-text);">Scanning current data for issues...</div>
        </div>
    `;

    try {
        const response = await fetch('/api/dsw/triage/scan/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ data_id: currentData.id })
        });

        if (!response.ok) throw new Error('Scan failed');

        const result = await response.json();

        if (result.success && result.has_issues) {
            showTriageInDialog(result.issues, currentData);
        } else {
            dialogBody.innerHTML = `
                <div style="text-align:center;padding:20px;">
                    <div style="color:var(--aw-accent);font-size:24px;margin-bottom:12px;">âœ“</div>
                    <div style="color:var(--aw-text);margin-bottom:8px;">No issues detected</div>
                    <div style="color:var(--aw-text-muted);font-size:11px;margin-bottom:16px;">Data appears clean.</div>
                    <button class="aw-btn" onclick="closeDialog('data-dialog')">Close</button>
                </div>
            `;
        }
    } catch (err) {
        dialogBody.innerHTML = `
            <div style="text-align:center;padding:20px;">
                <div style="color:#e85747;margin-bottom:12px;">${err.message}</div>
                <button class="aw-btn" onclick="closeDialog('data-dialog')">Close</button>
            </div>
        `;
    }
}

// ============================================================================
// WORKSHEET
// ============================================================================
function renderWorksheet(data) {
    const pane = document.getElementById('worksheet-pane');

    if (!data || data.length === 0) {
        pane.innerHTML = '<div class="aw-empty"><span>No data</span></div>';
        return;
    }

    const headers = Object.keys(data[0]);

    pane.innerHTML = `
        <table class="aw-worksheet">
            <thead>
                <tr>
                    <th class="row-num"></th>
                    ${headers.map((h, i) => `<th>C${i+1}<br><span style="font-weight:normal;font-size:10px;">${h}</span></th>`).join('')}
                </tr>
            </thead>
            <tbody>
                ${data.slice(0, 100).map((row, i) => `
                    <tr>
                        <td class="row-num">${i + 1}</td>
                        ${headers.map(h => `<td>${row[h] ?? ''}</td>`).join('')}
                    </tr>
                `).join('')}
            </tbody>
        </table>
        ${data.length > 100 ? `<div style="padding:8px;color:var(--aw-text-muted);font-size:10px;background:var(--aw-panel-header);border-top:1px solid var(--aw-border);">Showing 100 of ${data.length} rows</div>` : ''}
    `;
}

function updateStatus(rows, cols) {
    document.getElementById('status-data').textContent = currentData ? 'Data loaded' : 'No data';
    document.getElementById('status-rows').textContent = `Rows: ${rows}`;
    document.getElementById('status-cols').textContent = `Cols: ${cols}`;
}

// ============================================================================
// SESSION OUTPUT
// ============================================================================
function appendSession(type, text, useHtml = false) {
    const session = document.getElementById('session-output');

    // Handle separator type
    if (type === 'separator') {
        const sep = document.createElement('div');
        sep.className = 'session-separator';
        sep.innerHTML = '<div class="separator-line"></div>';
        session.appendChild(sep);
        session.scrollTop = session.scrollHeight;
        return;
    }

    const line = document.createElement('div');
    line.className = type;

    if (useHtml) {
        line.innerHTML = text;
    } else {
        line.textContent = text;
    }

    session.appendChild(line);
    session.scrollTop = session.scrollHeight;
}

function formatColoredOutput(text) {
    // Color map for regression output
    const colors = {
        'accent': '#4a9f6e',
        'text': '#e8efe8',
        'dim': '#7a8a7a',
        'success': '#4a9f6e',
        'warning': '#e89547',
        'danger': '#d06060'
    };

    // First escape HTML entities
    let html = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

    // Replace color tags (now escaped as &lt;&lt;COLOR:...)
    html = html.replace(/&lt;&lt;COLOR:(\w+)&gt;&gt;(.*?)&lt;&lt;\/COLOR&gt;&gt;/g, (match, color, content) => {
        const hexColor = colors[color] || colors.text;
        return `<span style="color:${hexColor}">${content}</span>`;
    });

    return html;
}

// ============================================================================
// ANALYSIS MENUS
// ============================================================================
const analysisMenus = {
    stats: {
        title: 'Statistical Analysis',
        items: [
            { id: 'descriptive', name: 'Descriptive Statistics', desc: 'Mean, StDev, N, etc.' },
            { id: 'ttest', name: '1-Sample t', desc: 'One sample t-test' },
            { id: 'ttest2', name: '2-Sample t', desc: 'Two sample t-test' },
            { id: 'paired_t', name: 'Paired t', desc: 'Paired t-test' },
            { id: 'anova', name: 'One-Way ANOVA', desc: 'Analysis of variance' },
            { id: 'anova2', name: 'Two-Way ANOVA', desc: 'Factorial ANOVA' },
            { id: 'tukey_hsd', name: 'Tukey HSD', desc: 'Post-hoc pairwise comparisons' },
            { id: 'games_howell', name: 'Games-Howell', desc: 'Post-hoc (unequal variances)' },
            { id: 'dunnett', name: "Dunnett's Test", desc: 'Compare treatments to control' },
            { id: 'dunn', name: "Dunn's Test", desc: 'Non-parametric post-hoc' },
            { id: 'hotelling_t2', name: "Hotelling's TÂ²", desc: 'Multivariate two-sample test' },
            { id: 'manova', name: 'MANOVA', desc: 'Multivariate analysis of variance' },
            { id: 'nested_anova', name: 'Nested ANOVA', desc: 'Mixed-effects / hierarchical' },
            { id: 'kaplan_meier', name: 'Kaplan-Meier', desc: 'Survival curves with log-rank test' },
            { id: 'cox_ph', name: 'Cox Proportional Hazards', desc: 'Survival regression with hazard ratios' },
            { id: 'acceptance_sampling', name: 'Acceptance Sampling', desc: 'OC curves, AQL/LTPD, producer/consumer risk' },
            { id: 'prop_1sample', name: '1-Proportion Z', desc: 'Test observed proportion vs hypothesized' },
            { id: 'prop_2sample', name: '2-Proportion Z', desc: 'Compare proportions between groups' },
            { id: 'fisher_exact', name: "Fisher's Exact", desc: 'Exact test for 2Ã—2 tables' },
            { id: 'poisson_1sample', name: 'Poisson Rate', desc: 'Test event rate vs hypothesized' },
            { id: 'regression', name: 'Regression', desc: 'OLS with full diagnostics' },
            { id: 'logistic', name: 'Logistic Regression', desc: 'Binary outcomes, odds ratios' },
            { id: 'correlation', name: 'Correlation', desc: 'Pearson, Spearman' },
            { id: 'normality', name: 'Normality Test', desc: 'Anderson-Darling' },
            { id: 'chi2', name: 'Chi-Square', desc: 'Test for association' },
            { id: 'f_test', name: 'F-Test (Variance)', desc: 'Equality of variances' },
            { id: 'equivalence', name: 'Equivalence Test', desc: 'TOST for equivalence' },
            { id: 'runs_test', name: 'Runs Test', desc: 'Test for randomness' },
            { id: 'granger', name: 'Granger Causality', desc: 'Does X cause Y over time?' },
            { id: 'changepoint', name: 'Change Point Detection', desc: 'When did the shift occur?' },
            { id: 'mann_whitney', name: 'Mann-Whitney U', desc: 'Non-parametric 2-sample' },
            { id: 'kruskal', name: 'Kruskal-Wallis', desc: 'Non-parametric ANOVA' },
            { id: 'wilcoxon', name: 'Wilcoxon Signed-Rank', desc: 'Non-parametric paired' },
            { id: 'friedman', name: 'Friedman Test', desc: 'Non-parametric repeated measures' },
            { id: 'spearman', name: 'Spearman Correlation', desc: 'Rank correlation with p-value' },
            { id: 'main_effects', name: 'Main Effects Plot', desc: 'DOE factor effects' },
            { id: 'interaction', name: 'Interaction Plot', desc: 'Factor interactions' },
            { id: 'multi_vari', name: 'Multi-Vari Chart', desc: 'Variation sources' },
            { id: 'power_z', name: '1-Sample Z Power', desc: 'Sample size for Z-test' },
            { id: 'power_1prop', name: '1-Proportion Power', desc: 'Sample size for proportion test' },
            { id: 'power_2prop', name: '2-Proportion Power', desc: 'Sample size for comparing proportions' },
            { id: 'power_1variance', name: '1-Variance Power', desc: 'Sample size for variance test' },
            { id: 'power_2variance', name: '2-Variance Power', desc: 'Sample size for F-test' },
            { id: 'power_equivalence', name: 'Equivalence Power', desc: 'Sample size for TOST' },
            { id: 'power_doe', name: 'DOE Factorial Power', desc: 'Replicates for 2^k design' },
            { id: 'sample_size_ci', name: 'Sample Size (CI)', desc: 'n for target CI width' },
            { id: 'sample_size_tolerance', name: 'Sample Size (Tolerance)', desc: 'n for tolerance interval' },
        ]
    },
    timeseries: {
        title: 'Time Series',
        items: [
            { id: 'arima', name: 'ARIMA', desc: 'Forecasting model' },
            { id: 'sarima', name: 'SARIMA', desc: 'Seasonal forecasting' },
            { id: 'decomposition', name: 'Decomposition', desc: 'Trend, seasonal, residual' },
            { id: 'acf_pacf', name: 'ACF/PACF', desc: 'Autocorrelation plots' },
        ]
    },
    reliability: {
        title: 'Reliability',
        items: [
            { id: 'weibull', name: 'Weibull Analysis', desc: 'Life data, failure rates' },
            { id: 'kaplan_meier', name: 'Kaplan-Meier', desc: 'Survival curves' },
        ]
    },
    msa: {
        title: 'Measurement Systems',
        items: [
            { id: 'gage_rr', name: 'Gage R&R (Crossed)', desc: 'Repeatability & Reproducibility' },
            { id: 'gage_rr_nested', name: 'Gage R&R (Nested)', desc: 'Destructive / non-crossed study' },
            { id: 'gage_linearity_bias', name: 'Linearity & Bias', desc: 'Bias across measurement range' },
            { id: 'gage_type1', name: 'Type 1 Gage Study', desc: 'Single part, Cg/Cgk indices' },
            { id: 'attribute_gage', name: 'Attribute Gage', desc: 'Pass/Fail agreement vs reference' },
            { id: 'attribute_agreement', name: 'Attribute Agreement', desc: 'Kappa / Fleiss Kappa' },
        ]
    },
    ml: {
        title: 'Machine Learning',
        items: [
            { id: 'classification', name: 'Classification', desc: 'RF, XGBoost, SVM' },
            { id: 'clustering', name: 'Clustering', desc: 'K-Means, DBSCAN' },
            { id: 'pca', name: 'Principal Components', desc: 'Dimensionality reduction' },
            { id: 'feature', name: 'Feature Importance', desc: 'Variable ranking' },
            { id: 'bayesian_regression', name: 'Bayesian Regression', desc: 'Uncertainty + credible intervals' },
            { id: 'gam', name: 'GAM', desc: 'Smooth effect curves per feature' },
            { id: 'isolation_forest', name: 'Isolation Forest', desc: 'Anomaly detection' },
            { id: 'gaussian_process', name: 'Gaussian Process', desc: 'Nonlinear + uncertainty bands' },
            { id: 'pls', name: 'PLS Regression', desc: 'Handles collinearity' },
            { id: 'sem', name: 'SEM / Path Analysis', desc: 'Causal paths + mediation' },
            { id: 'regularized_regression', name: 'Ridge/LASSO/Elastic Net', desc: 'Regularized regression' },
            { id: 'discriminant_analysis', name: 'Discriminant Analysis', desc: 'LDA/QDA classification' },
        ]
    },
    spc: {
        title: 'Control Charts',
        items: [
            { id: 'imr', name: 'I-MR Chart', desc: 'Individuals & Moving Range' },
            { id: 'xbar_r', name: 'Xbar-R Chart', desc: 'Subgroup mean & range' },
            { id: 'xbar_s', name: 'Xbar-S Chart', desc: 'Subgroup mean & StDev' },
            { id: 'p_chart', name: 'P Chart', desc: 'Proportion defective' },
            { id: 'np_chart', name: 'NP Chart', desc: 'Number defective' },
            { id: 'c_chart', name: 'C Chart', desc: 'Defects per unit' },
            { id: 'u_chart', name: 'U Chart', desc: 'Defects rate (variable n)' },
            { id: 'cusum', name: 'CUSUM', desc: 'Cumulative sum' },
            { id: 'ewma', name: 'EWMA', desc: 'Exponentially weighted MA' },
            { id: 'capability', name: 'Capability Analysis', desc: 'Cp, Cpk, Pp, Ppk' },
        ]
    },
    viz: {
        title: 'Graphs',
        items: [
            { id: 'histogram', name: 'Histogram', desc: 'Distribution' },
            { id: 'boxplot', name: 'Boxplot', desc: 'Quartiles & outliers' },
            { id: 'scatter', name: 'Scatterplot', desc: 'X vs Y' },
            { id: 'matrix', name: 'Matrix Plot', desc: 'Multiple scatters' },
            { id: 'timeseries', name: 'Time Series Plot', desc: 'Trend over time' },
            { id: 'probability', name: 'Probability Plot', desc: 'Distribution fit' },
            { id: 'pareto', name: 'Pareto Chart', desc: '80/20 analysis' },
            { id: 'heatmap', name: 'Heatmap', desc: 'Correlation matrix' },
        ]
    },
    tools: {
        title: 'Tools',
        items: [
            { id: 'calculator', name: 'Calculator', desc: 'Create new columns' },
            { id: 'subset', name: 'Subset Data', desc: 'Filter rows' },
            { id: 'stack', name: 'Stack/Unstack', desc: 'Reshape data' },
            { id: 'sort', name: 'Sort', desc: 'Order data' },
            { id: 'transpose', name: 'Transpose', desc: 'Flip rows/columns' },
        ]
    },
    simulate: {
        title: 'Simulation',
        items: [
            { id: 'monte_carlo', name: 'Monte Carlo', desc: 'Probability simulation' },
            { id: 'what_if', name: 'What-If Analysis', desc: 'Scenario testing' },
            { id: 'sensitivity', name: 'Sensitivity Analysis', desc: 'Parameter impact' },
            { id: 'custom_code', name: 'Custom Analysis', desc: 'AI generates Python code' },
        ]
    },
    bayesian: {
        title: 'Bayesian Inference',
        items: [
            { id: 'bayes_regression', name: 'Bayesian Regression', desc: 'Coefficients with credible intervals' },
            { id: 'bayes_ttest', name: 'Bayesian t-Test', desc: 'Compare groups with posterior' },
            { id: 'bayes_ab', name: 'Bayesian A/B Test', desc: 'Proportion comparison' },
            { id: 'bayes_correlation', name: 'Bayesian Correlation', desc: 'Correlation with uncertainty' },
            { id: 'bayes_anova', name: 'Bayesian ANOVA', desc: 'Group differences with posteriors' },
            { id: 'bayes_changepoint', name: 'Bayesian Change Point', desc: 'When did the shift occur?' },
            { id: 'bayes_proportion', name: 'Bayesian Proportion', desc: 'Estimate rate with credible interval' },
        ]
    }
};

function showAnalysisMenu(type) {
    const menu = analysisMenus[type];
    if (!menu) return;

    document.getElementById('analysis-dialog-title').textContent = menu.title;
    document.getElementById('analysis-dialog-body').innerHTML = `
        <div class="aw-analysis-grid">
            ${menu.items.map(item => `
                <div class="aw-analysis-item" onclick="configureAnalysis('${type}', '${item.id}')">
                    <span class="name">${item.name}</span>
                    <span class="desc">${item.desc}</span>
                </div>
            `).join('')}
        </div>
    `;

    document.getElementById('analysis-dialog').classList.add('active');
}

function configureAnalysis(type, id) {
    closeDialog('analysis-dialog');
    currentAnalysis = { type, id };

    const menu = analysisMenus[type];
    const item = menu?.items.find(i => i.id === id);

    document.getElementById('config-dialog-title').textContent = item?.name || id;
    document.getElementById('config-dialog-body').innerHTML = generateConfigForm(type, id);
    document.getElementById('config-dialog').classList.add('active');
}

function generateConfigForm(type, id) {
    const colOptions = columns.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
    const numCols = columns.filter(c => c.dtype === 'numeric').map(c => `<option value="${c.name}">${c.name}</option>`).join('');

    if (type === 'stats') {
        if (id === 'descriptive') {
            const numericCols = columns.filter(c => c.dtype === 'numeric');
            const checkboxes = numericCols.map(c => `
                <label class="aw-checkbox-item">
                    <input type="checkbox" name="vars" value="${c.name}" checked>
                    <span>${c.name}</span>
                </label>
            `).join('');

            return `
                <div class="aw-form-group">
                    <label>Variables:</label>
                    <div class="aw-checkbox-list" style="max-height:200px;overflow-y:auto;">
                        ${checkboxes || '<span style="color:#7a8f7a;">No numeric columns</span>'}
                    </div>
                    <div style="margin-top:6px;">
                        <button type="button" class="aw-btn-small" onclick="toggleAllCheckboxes('vars', true)">Select All</button>
                        <button type="button" class="aw-btn-small" onclick="toggleAllCheckboxes('vars', false)">Clear</button>
                    </div>
                </div>
            `;
        }
        if (id === 'ttest' || id === 'ttest2') {
            return `
                <div class="aw-form-group">
                    <label>Sample:</label>
                    <select id="cfg-var1">${numCols}</select>
                </div>
                ${id === 'ttest2' ? `
                <div class="aw-form-group">
                    <label>Sample 2:</label>
                    <select id="cfg-var2">${numCols}</select>
                </div>
                ` : `
                <div class="aw-form-group">
                    <label>Test mean:</label>
                    <input type="number" id="cfg-mu" value="0" step="any">
                </div>
                `}
                <div class="aw-form-group">
                    <label>Confidence level:</label>
                    <select id="cfg-conf">
                        <option value="95">95%</option>
                        <option value="99">99%</option>
                        <option value="90">90%</option>
                    </select>
                </div>
            `;
        }
        if (id === 'paired_t') {
            return `
                <div class="aw-form-group">
                    <label>Sample 1 (Before):</label>
                    <select id="cfg-var1">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Sample 2 (After):</label>
                    <select id="cfg-var2">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Confidence level:</label>
                    <select id="cfg-conf">
                        <option value="95">95%</option>
                        <option value="99">99%</option>
                        <option value="90">90%</option>
                    </select>
                </div>
            `;
        }
        if (id === 'anova') {
            const catCols = columns.filter(c => c.dtype === 'text').map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            return `
                <div class="aw-form-group">
                    <label>Response (measurement):</label>
                    <select id="cfg-response">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Factor (groups):</label>
                    <select id="cfg-factor">${catCols || colOptions}</select>
                </div>
                <div class="aw-form-group">
                    <label>Confidence level:</label>
                    <select id="cfg-conf">
                        <option value="95">95%</option>
                        <option value="99">99%</option>
                        <option value="90">90%</option>
                    </select>
                </div>
            `;
        }
        if (['tukey_hsd', 'games_howell', 'dunn'].includes(id)) {
            const catCols = columns.filter(c => c.dtype === 'text').map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            return `
                <div class="aw-form-group">
                    <label>Response (measurement):</label>
                    <select id="cfg-response">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Factor (groups):</label>
                    <select id="cfg-factor">${catCols || colOptions}</select>
                </div>
                <div class="aw-form-group">
                    <label>Confidence level:</label>
                    <select id="cfg-conf">
                        <option value="95">95%</option>
                        <option value="99">99%</option>
                        <option value="90">90%</option>
                    </select>
                </div>
            `;
        }
        if (id === 'dunnett') {
            const catCols = columns.filter(c => c.dtype === 'text').map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            return `
                <div class="aw-form-group">
                    <label>Response (measurement):</label>
                    <select id="cfg-response">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Factor (groups):</label>
                    <select id="cfg-factor">${catCols || colOptions}</select>
                </div>
                <div class="aw-form-group">
                    <label>Control group:</label>
                    <select id="cfg-control">${catCols || colOptions}</select>
                    <small style="color:#7a8f7a;">Select factor first, then pick the control level</small>
                </div>
                <div class="aw-form-group">
                    <label>Confidence level:</label>
                    <select id="cfg-conf">
                        <option value="95">95%</option>
                        <option value="99">99%</option>
                        <option value="90">90%</option>
                    </select>
                </div>
            `;
        }
        if (['hotelling_t2', 'manova'].includes(id)) {
            const catCols = columns.filter(c => c.dtype === 'text').map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            const numericCols = columns.filter(c => c.dtype === 'numeric');
            const checkboxes = numericCols.map(c => `
                <label class="aw-checkbox-item">
                    <input type="checkbox" name="responses" value="${c.name}">
                    <span>${c.name}</span>
                </label>
            `).join('');
            return `
                <div class="aw-form-group">
                    <label>Response variables (select 2+):</label>
                    <div class="aw-checkbox-list" style="max-height:150px;overflow-y:auto;">
                        ${checkboxes || '<span style="color:#7a8f7a;">No numeric columns</span>'}
                    </div>
                    <div style="margin-top:6px;">
                        <button type="button" class="aw-btn-small" onclick="toggleAllCheckboxes('responses', true)">Select All</button>
                        <button type="button" class="aw-btn-small" onclick="toggleAllCheckboxes('responses', false)">Clear</button>
                    </div>
                </div>
                <div class="aw-form-group">
                    <label>Factor (groups):</label>
                    <select id="cfg-factor">${catCols || colOptions}</select>
                </div>
                <div class="aw-form-group">
                    <label>Confidence level:</label>
                    <select id="cfg-conf">
                        <option value="95">95%</option>
                        <option value="99">99%</option>
                        <option value="90">90%</option>
                    </select>
                </div>
            `;
        }
        if (id === 'anova2') {
            const catCols = columns.filter(c => c.dtype === 'text').map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            return `
                <div class="aw-form-group">
                    <label>Response (measurement):</label>
                    <select id="cfg-response">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Factor A:</label>
                    <select id="cfg-factor_a">${catCols || colOptions}</select>
                </div>
                <div class="aw-form-group">
                    <label>Factor B:</label>
                    <select id="cfg-factor_b">${catCols || colOptions}</select>
                </div>
                <div class="aw-form-group">
                    <label>Confidence level:</label>
                    <select id="cfg-conf">
                        <option value="95">95%</option>
                        <option value="99">99%</option>
                        <option value="90">90%</option>
                    </select>
                </div>
            `;
        }
        if (id === 'nested_anova') {
            const catCols = columns.filter(c => c.dtype === 'text').map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            return `
                <div class="aw-form-group">
                    <label>Response (measurement):</label>
                    <select id="cfg-response">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Fixed factor (treatment):</label>
                    <select id="cfg-fixed_factor">${catCols || colOptions}</select>
                </div>
                <div class="aw-form-group">
                    <label>Random factor (nesting):</label>
                    <select id="cfg-random_factor">${catCols || colOptions}</select>
                    <small style="color:#7a8f7a;">E.g., operators within machines, batches within suppliers</small>
                </div>
                <div class="aw-form-group">
                    <label>Confidence level:</label>
                    <select id="cfg-conf">
                        <option value="95">95%</option>
                        <option value="99">99%</option>
                        <option value="90">90%</option>
                    </select>
                </div>
            `;
        }
        if (id === 'correlation') {
            const numericCols = columns.filter(c => c.dtype === 'numeric');
            const checkboxes = numericCols.map(c => `
                <label class="aw-checkbox-item">
                    <input type="checkbox" name="vars" value="${c.name}" checked>
                    <span>${c.name}</span>
                </label>
            `).join('');

            return `
                <div class="aw-form-group">
                    <label>Variables:</label>
                    <div class="aw-checkbox-list" style="max-height:150px;overflow-y:auto;">
                        ${checkboxes || '<span style="color:#7a8f7a;">No numeric columns</span>'}
                    </div>
                    <div style="margin-top:6px;">
                        <button type="button" class="aw-btn-small" onclick="toggleAllCheckboxes('vars', true)">Select All</button>
                        <button type="button" class="aw-btn-small" onclick="toggleAllCheckboxes('vars', false)">Clear</button>
                    </div>
                </div>
                <div class="aw-form-group">
                    <label>Method:</label>
                    <select id="cfg-method">
                        <option value="pearson">Pearson (linear)</option>
                        <option value="spearman">Spearman (rank)</option>
                        <option value="kendall">Kendall (concordance)</option>
                    </select>
                </div>
            `;
        }
        if (id === 'normality') {
            return `
                <div class="aw-form-group">
                    <label>Variable:</label>
                    <select id="cfg-var">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Test:</label>
                    <select id="cfg-test">
                        <option value="anderson">Anderson-Darling</option>
                        <option value="shapiro">Shapiro-Wilk</option>
                        <option value="ks">Kolmogorov-Smirnov</option>
                    </select>
                </div>
            `;
        }
        if (id === 'chi2') {
            const catCols = columns.filter(c => c.dtype === 'text').map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            return `
                <div class="aw-form-group">
                    <label>Row variable:</label>
                    <select id="cfg-row_var">${catCols || colOptions}</select>
                </div>
                <div class="aw-form-group">
                    <label>Column variable:</label>
                    <select id="cfg-col_var">${catCols || colOptions}</select>
                </div>
            `;
        }
        if (id === 'granger') {
            return `
                <div class="aw-form-row">
                    <div class="aw-form-group">
                        <label>Potential Cause (X):</label>
                        <select id="cfg-var_x">${numCols}</select>
                    </div>
                    <div class="aw-form-group">
                        <label>Effect (Y):</label>
                        <select id="cfg-var_y">${numCols}</select>
                    </div>
                </div>
                <div class="aw-form-group">
                    <label>Maximum Lags:</label>
                    <select id="cfg-max_lag">
                        <option value="2">2</option>
                        <option value="4" selected>4</option>
                        <option value="6">6</option>
                        <option value="8">8</option>
                        <option value="12">12</option>
                    </select>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">Causal Inference:</strong> Tests if past values of X improve prediction of Y. Significant results suggest X temporally precedes and helps predict Y.
                </div>
            `;
        }
        if (id === 'changepoint') {
            return `
                <div class="aw-form-group">
                    <label>Variable:</label>
                    <select id="cfg-var">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Penalty (sensitivity):</label>
                    <select id="cfg-penalty">
                        <option value="bic" selected>BIC (balanced)</option>
                        <option value="aic">AIC (more sensitive)</option>
                    </select>
                </div>
                <div class="aw-form-group">
                    <label>Minimum segment size:</label>
                    <select id="cfg-min_size">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="30">30</option>
                    </select>
                </div>
                <div style="background:rgba(232,87,71,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:#e85747;">When Did It Change?</strong> Detects points where the process behavior shifted. Useful for identifying when a cause started affecting the system.
                </div>
            `;
        }
        if (id === 'mann_whitney') {
            return `
                <div class="aw-form-group">
                    <label>Test variable:</label>
                    <select id="cfg-var">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Grouping variable (2 groups):</label>
                    <select id="cfg-group_var">${colOptions}</select>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">Non-parametric:</strong> Use when data isn't normally distributed. Tests if the two groups have different medians/distributions.
                </div>
            `;
        }
        if (id === 'kruskal') {
            return `
                <div class="aw-form-group">
                    <label>Test variable:</label>
                    <select id="cfg-var">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Grouping variable:</label>
                    <select id="cfg-group_var">${colOptions}</select>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">Non-parametric ANOVA:</strong> Tests if 3+ groups have different distributions without assuming normality.
                </div>
            `;
        }
        if (id === 'wilcoxon') {
            return `
                <div class="aw-form-group">
                    <label>Before / Sample 1:</label>
                    <select id="cfg-var1">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>After / Sample 2:</label>
                    <select id="cfg-var2">${numCols}</select>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">Non-parametric paired test:</strong> Use when paired differences aren't normally distributed. Tests if the median difference is zero.
                </div>
            `;
        }
        if (id === 'friedman') {
            const numColCheckboxes = columns.filter(c => c.dtype === 'number').map(c => `
                <label class="aw-checkbox-item">
                    <input type="checkbox" name="vars" value="${c.name}">
                    <span>${c.name}</span>
                </label>
            `).join('') || '<span style="color:var(--aw-text-muted)">No numeric columns found</span>';

            return `
                <div class="aw-form-group">
                    <label>Repeated measures (select 3+):</label>
                    <div class="aw-checkbox-list" id="cfg-vars-list">
                        ${numColCheckboxes}
                    </div>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">Non-parametric repeated measures:</strong> Select 3+ measurement columns (e.g., Time1, Time2, Time3). Each row is one subject measured under all conditions.
                </div>
            `;
        }
        if (id === 'spearman') {
            return `
                <div class="aw-form-group">
                    <label>Variable X:</label>
                    <select id="cfg-var1">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Variable Y:</label>
                    <select id="cfg-var2">${numCols}</select>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">Rank correlation:</strong> Measures monotonic association without assuming linearity. Returns rho, p-value, and confidence interval.
                </div>
            `;
        }
        if (id === 'main_effects') {
            const catCols = columns.filter(c => c.dtype === 'text').map(c => c.name);
            const factorCheckboxes = catCols.map(c => `
                <label class="aw-checkbox-item">
                    <input type="checkbox" name="factors" value="${c}">
                    <span>${c}</span>
                </label>
            `).join('') || '<span style="color:var(--aw-text-muted)">No categorical columns found</span>';

            return `
                <div class="aw-form-group">
                    <label>Response (Y):</label>
                    <select id="cfg-response">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Factors:</label>
                    <div class="aw-checkbox-list" id="cfg-factors-list">
                        ${factorCheckboxes}
                    </div>
                </div>
                <div style="background:rgba(232,149,71,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:#e89547;">DOE Main Effects:</strong> Shows the average effect of each factor level on the response. Parallel lines suggest no interaction; non-parallel lines hint at interactions.
                </div>
            `;
        }
        if (id === 'interaction') {
            const catCols = columns.filter(c => c.dtype === 'text').map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            const catOptions = catCols || colOptions;

            return `
                <div class="aw-form-group">
                    <label>Response (Y):</label>
                    <select id="cfg-response">${numCols}</select>
                </div>
                <div class="aw-form-row">
                    <div class="aw-form-group">
                        <label>Factor 1 (X axis):</label>
                        <select id="cfg-factor1">${catOptions}</select>
                    </div>
                    <div class="aw-form-group">
                        <label>Factor 2 (Lines):</label>
                        <select id="cfg-factor2">${catOptions}</select>
                    </div>
                </div>
                <div style="background:rgba(232,149,71,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:#e89547;">Interaction Plot:</strong> If lines are parallel, no interaction exists. Crossing or diverging lines indicate the effect of Factor 1 depends on Factor 2.
                </div>
            `;
        }
        if (id === 'logistic') {
            const numericCols = columns.filter(c => c.dtype === 'numeric');
            const checkboxes = numericCols.map(c => `
                <label class="aw-checkbox-item">
                    <input type="checkbox" name="predictors" value="${c.name}">
                    <span>${c.name}</span>
                </label>
            `).join('');

            return `
                <div class="aw-form-group">
                    <label>Response (binary Y):</label>
                    <select id="cfg-response">${colOptions}</select>
                </div>
                <div class="aw-form-group">
                    <label>Predictors:</label>
                    <div class="aw-checkbox-list" id="cfg-predictors-list">
                        ${checkboxes}
                    </div>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">Logistic Regression:</strong> For binary outcomes. Returns odds ratios (OR > 1 increases probability) and ROC curve.
                </div>
            `;
        }
        if (id === 'f_test') {
            return `
                <div class="aw-form-group">
                    <label>Test variable:</label>
                    <select id="cfg-var">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Grouping variable (2 groups):</label>
                    <select id="cfg-group_var">${colOptions}</select>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">F-Test:</strong> Tests if two groups have equal variances. Use before t-tests to check homogeneity assumption.
                </div>
            `;
        }
        if (id === 'equivalence') {
            return `
                <div class="aw-form-group">
                    <label>Test variable:</label>
                    <select id="cfg-var">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Grouping variable (2 groups):</label>
                    <select id="cfg-group_var">${colOptions}</select>
                </div>
                <div class="aw-form-group">
                    <label>Equivalence margin (Â±):</label>
                    <input type="number" id="cfg-margin" value="0.5" step="0.1" min="0">
                </div>
                <div style="background:rgba(232,149,71,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:#e89547;">TOST:</strong> Tests if groups are equivalent within margin. Different from t-test (absence of difference â‰  equivalence).
                </div>
            `;
        }
        if (id === 'runs_test') {
            return `
                <div class="aw-form-group">
                    <label>Variable:</label>
                    <select id="cfg-var">${numCols}</select>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">Runs Test:</strong> Tests if sequence is random. Too few runs = clustering/trends. Too many = oscillation.
                </div>
            `;
        }
        if (id === 'multi_vari') {
            const catCols = columns.filter(c => c.dtype === 'text').map(c => c.name);
            const factorCheckboxes = catCols.map(c => `
                <label class="aw-checkbox-item">
                    <input type="checkbox" name="factors" value="${c}">
                    <span>${c}</span>
                </label>
            `).join('') || '<span style="color:var(--aw-text-muted)">No categorical columns found</span>';

            return `
                <div class="aw-form-group">
                    <label>Response (Y):</label>
                    <select id="cfg-response">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Factors (select 1-3):</label>
                    <div class="aw-checkbox-list" id="cfg-factors-list">
                        ${factorCheckboxes}
                    </div>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">Multi-Vari:</strong> Shows within-group vs between-group variation. Compare spreads to identify dominant sources.
                </div>
            `;
        }
        if (id === 'regression') {
            const numericCols = columns.filter(c => c.dtype === 'numeric');
            const checkboxes = numericCols.map(c => `
                <label class="aw-checkbox-item">
                    <input type="checkbox" name="predictors" value="${c.name}">
                    <span>${c.name}</span>
                </label>
            `).join('');

            return `
                <div class="aw-form-group">
                    <label>Response (Y):</label>
                    <select id="cfg-response">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Predictors (X):</label>
                    <div class="aw-checkbox-list" id="cfg-predictors-list">
                        ${checkboxes}
                    </div>
                    <div style="margin-top:6px;">
                        <button type="button" class="aw-btn-small" onclick="selectAllPredictors(true)">Select All</button>
                        <button type="button" class="aw-btn-small" onclick="selectAllPredictors(false)">Clear</button>
                    </div>
                </div>
                <div class="aw-form-row" style="display:flex;gap:12px;">
                    <div class="aw-form-group" style="flex:1;">
                        <label>Model type:</label>
                        <select id="cfg-degree">
                            <option value="1">Linear</option>
                            <option value="2">Quadratic (XÂ²)</option>
                            <option value="3">Cubic (XÂ³)</option>
                        </select>
                    </div>
                    <div class="aw-form-group" style="flex:1;">
                        <label>Interactions:</label>
                        <select id="cfg-interactions">
                            <option value="none">None</option>
                            <option value="all">All pairs (Xâ‚Â·Xâ‚‚)</option>
                        </select>
                    </div>
                </div>
            `;
        }
    }

    if (type === 'spc') {
        if (id === 'imr') {
            return `
                <div class="aw-form-group">
                    <label>Measurement column:</label>
                    <select id="cfg-measurement">${numCols}</select>
                </div>
            `;
        }
        if (id === 'xbar_r' || id === 'xbar_s') {
            return `
                <div class="aw-form-group">
                    <label>Measurement column:</label>
                    <select id="cfg-measurement">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Subgroup column:</label>
                    <select id="cfg-subgroup">${colOptions}</select>
                </div>
                <div class="aw-form-group">
                    <label>Subgroup size:</label>
                    <input type="number" id="cfg-subgroup_size" value="5" min="2" max="25">
                </div>
            `;
        }
        if (id === 'p_chart') {
            return `
                <div class="aw-form-group">
                    <label>Defectives column:</label>
                    <select id="cfg-defectives">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Sample size column:</label>
                    <select id="cfg-sample_size">${numCols}</select>
                </div>
            `;
        }
        if (id === 'capability') {
            return `
                <div class="aw-form-group">
                    <label>Measurement column:</label>
                    <select id="cfg-measurement">${numCols}</select>
                </div>
                <div class="aw-form-row">
                    <div class="aw-form-group">
                        <label>Lower spec (LSL):</label>
                        <input type="number" id="cfg-lsl" step="any">
                    </div>
                    <div class="aw-form-group">
                        <label>Upper spec (USL):</label>
                        <input type="number" id="cfg-usl" step="any">
                    </div>
                </div>
                <div class="aw-form-group">
                    <label>Target (optional):</label>
                    <input type="number" id="cfg-target" step="any">
                </div>
            `;
        }
        if (id === 'np_chart') {
            return `
                <div class="aw-form-group">
                    <label>Defectives column:</label>
                    <select id="cfg-defectives">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Sample size (constant):</label>
                    <input type="number" id="cfg-sample_size" value="50" min="1">
                </div>
            `;
        }
        if (id === 'c_chart') {
            return `
                <div class="aw-form-group">
                    <label>Defects column:</label>
                    <select id="cfg-defects">${numCols}</select>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">C Chart:</strong> For count of defects per unit when inspection unit is constant.
                </div>
            `;
        }
        if (id === 'u_chart') {
            return `
                <div class="aw-form-group">
                    <label>Defects column:</label>
                    <select id="cfg-defects">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Units inspected column:</label>
                    <select id="cfg-units">${numCols}</select>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">U Chart:</strong> Defects per unit when sample size varies.
                </div>
            `;
        }
        if (id === 'cusum') {
            return `
                <div class="aw-form-group">
                    <label>Measurement column:</label>
                    <select id="cfg-measurement">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Target value (0 = use mean):</label>
                    <input type="number" id="cfg-target" value="0" step="any">
                </div>
                <div class="aw-form-row">
                    <div class="aw-form-group">
                        <label>k (slack):</label>
                        <input type="number" id="cfg-k" value="0.5" step="0.1" min="0">
                    </div>
                    <div class="aw-form-group">
                        <label>h (decision):</label>
                        <input type="number" id="cfg-h" value="5" step="0.5" min="1">
                    </div>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">CUSUM:</strong> Detects small sustained shifts. More sensitive than Shewhart charts.
                </div>
            `;
        }
        if (id === 'ewma') {
            return `
                <div class="aw-form-group">
                    <label>Measurement column:</label>
                    <select id="cfg-measurement">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Target value (0 = use mean):</label>
                    <input type="number" id="cfg-target" value="0" step="any">
                </div>
                <div class="aw-form-row">
                    <div class="aw-form-group">
                        <label>Î» (smoothing 0-1):</label>
                        <input type="number" id="cfg-lambda" value="0.2" step="0.05" min="0.05" max="1">
                    </div>
                    <div class="aw-form-group">
                        <label>L (sigma width):</label>
                        <input type="number" id="cfg-L" value="3" step="0.5" min="1">
                    </div>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">EWMA:</strong> Good for detecting small shifts. Lower Î» = more smoothing.
                </div>
            `;
        }
        return `<p style="color:#9aaa9a;font-size:11px;">Select SPC chart type.</p>`;
    }

    if (type === 'timeseries') {
        if (id === 'arima') {
            return `
                <div class="aw-form-group">
                    <label>Variable:</label>
                    <select id="cfg-var">${numCols}</select>
                </div>
                <div class="aw-form-row">
                    <div class="aw-form-group">
                        <label>p (AR order):</label>
                        <select id="cfg-p">
                            <option value="0">0</option>
                            <option value="1" selected>1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                    <div class="aw-form-group">
                        <label>d (differencing):</label>
                        <select id="cfg-d">
                            <option value="0">0</option>
                            <option value="1" selected>1</option>
                            <option value="2">2</option>
                        </select>
                    </div>
                    <div class="aw-form-group">
                        <label>q (MA order):</label>
                        <select id="cfg-q">
                            <option value="0">0</option>
                            <option value="1" selected>1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                </div>
                <div class="aw-form-group">
                    <label>Forecast periods:</label>
                    <input type="number" id="cfg-forecast" value="10" min="1" max="100">
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">ARIMA:</strong> Use ACF/PACF to determine orders. d=1 for trending data.
                </div>
            `;
        }
        if (id === 'sarima') {
            return `
                <div class="aw-form-group">
                    <label>Variable:</label>
                    <select id="cfg-var">${numCols}</select>
                </div>
                <div class="aw-form-row">
                    <div class="aw-form-group"><label>p (AR):</label>
                        <select id="cfg-p"><option value="0">0</option><option value="1" selected>1</option><option value="2">2</option><option value="3">3</option></select></div>
                    <div class="aw-form-group"><label>d (diff):</label>
                        <select id="cfg-d"><option value="0">0</option><option value="1" selected>1</option><option value="2">2</option></select></div>
                    <div class="aw-form-group"><label>q (MA):</label>
                        <select id="cfg-q"><option value="0">0</option><option value="1" selected>1</option><option value="2">2</option><option value="3">3</option></select></div>
                </div>
                <div class="aw-form-row">
                    <div class="aw-form-group"><label>P (Seasonal AR):</label>
                        <select id="cfg-P"><option value="0">0</option><option value="1" selected>1</option><option value="2">2</option></select></div>
                    <div class="aw-form-group"><label>D (Seasonal diff):</label>
                        <select id="cfg-D"><option value="0">0</option><option value="1" selected>1</option></select></div>
                    <div class="aw-form-group"><label>Q (Seasonal MA):</label>
                        <select id="cfg-Q"><option value="0">0</option><option value="1" selected>1</option><option value="2">2</option></select></div>
                </div>
                <div class="aw-form-group">
                    <label>Seasonal period (m):</label>
                    <select id="cfg-m">
                        <option value="4">4 (Quarterly)</option>
                        <option value="7">7 (Weekly)</option>
                        <option value="12" selected>12 (Monthly)</option>
                        <option value="24">24 (Bi-monthly)</option>
                        <option value="52">52 (Weekly/Yearly)</option>
                    </select>
                </div>
                <div class="aw-form-group">
                    <label>Forecast periods:</label>
                    <input type="number" id="cfg-forecast" value="24" min="1" max="200">
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">SARIMA:</strong> (p,d,q) = non-seasonal, (P,D,Q)[m] = seasonal. Use Decomposition to identify seasonal period.
                </div>
            `;
        }
        if (id === 'decomposition') {
            return `
                <div class="aw-form-group">
                    <label>Variable:</label>
                    <select id="cfg-var">${numCols}</select>
                </div>
                <div class="aw-form-row">
                    <div class="aw-form-group">
                        <label>Seasonal period:</label>
                        <select id="cfg-period">
                            <option value="4">4 (Quarterly)</option>
                            <option value="7">7 (Weekly)</option>
                            <option value="12" selected>12 (Monthly)</option>
                            <option value="24">24 (Hourly)</option>
                            <option value="52">52 (Yearly weeks)</option>
                        </select>
                    </div>
                    <div class="aw-form-group">
                        <label>Model:</label>
                        <select id="cfg-model">
                            <option value="additive" selected>Additive</option>
                            <option value="multiplicative">Multiplicative</option>
                        </select>
                    </div>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">Decomposition:</strong> Separates trend, seasonal, and residual components.
                </div>
            `;
        }
        if (id === 'acf_pacf') {
            return `
                <div class="aw-form-group">
                    <label>Variable:</label>
                    <select id="cfg-var">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Maximum lags:</label>
                    <input type="number" id="cfg-lags" value="20" min="5" max="100">
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">ACF/PACF:</strong> Use to identify ARIMA orders. PACF cuts off â†’ AR(p), ACF cuts off â†’ MA(q).
                </div>
            `;
        }
        return `<p style="color:#9aaa9a;font-size:11px;">Select time series analysis.</p>`;
    }

    if (type === 'reliability') {
        if (id === 'weibull') {
            return `
                <div class="aw-form-group">
                    <label>Time to failure:</label>
                    <select id="cfg-var">${numCols}</select>
                </div>
                <div style="background:rgba(232,149,71,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:#e89547;">Weibull:</strong> Î²<1 = infant mortality, Î²=1 = random, Î²>1 = wear-out failures.
                </div>
            `;
        }
        if (id === 'kaplan_meier') {
            return `
                <div class="aw-form-group">
                    <label>Time variable:</label>
                    <select id="cfg-time">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Event indicator (1=event, 0=censored):</label>
                    <select id="cfg-event">
                        <option value="">All events (no censoring)</option>
                        ${numCols}
                    </select>
                </div>
                <div class="aw-form-group">
                    <label>Group by (optional):</label>
                    <select id="cfg-group">
                        <option value="">No grouping</option>
                        ${colOptions}
                    </select>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">Kaplan-Meier:</strong> Survival curves. Compare groups to see if survival differs.
                </div>
            `;
        }
        return `<p style="color:#9aaa9a;font-size:11px;">Select reliability analysis.</p>`;
    }

    if (type === 'msa') {
        if (id === 'gage_rr') {
            return `
                <div class="aw-form-group">
                    <label>Measurement column:</label>
                    <select id="cfg-measurement">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Part ID column:</label>
                    <select id="cfg-part">${colOptions}</select>
                </div>
                <div class="aw-form-group">
                    <label>Operator column:</label>
                    <select id="cfg-operator">${colOptions}</select>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">Gage R&R (Crossed):</strong> &lt;10% excellent, 10-30% marginal, &gt;30% unacceptable.
                </div>
            `;
        }
        if (id === 'gage_rr_nested') {
            return `
                <div class="aw-form-group"><label>Measurement column:</label><select id="cfg-measurement">${numCols}</select></div>
                <div class="aw-form-group"><label>Part ID column:</label><select id="cfg-part">${colOptions}</select></div>
                <div class="aw-form-group"><label>Operator column:</label><select id="cfg-operator">${colOptions}</select></div>
                <div style="background:rgba(74,144,217,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:#4a90d9;">Nested Gage R&R:</strong> For destructive testing where operators measure different parts.
                </div>
            `;
        }
        if (id === 'gage_linearity_bias') {
            return `
                <div class="aw-form-group"><label>Measurement column:</label><select id="cfg-measurement">${numCols}</select></div>
                <div class="aw-form-group"><label>Reference column:</label><select id="cfg-reference">${numCols}</select></div>
                <div style="background:rgba(232,149,71,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:#e89547;">Linearity & Bias:</strong> Tests if bias changes across the measurement range. Slope â‰  0 indicates linearity problem.
                </div>
            `;
        }
        if (id === 'gage_type1') {
            return `
                <div class="aw-form-group"><label>Measurement column:</label><select id="cfg-measurement">${numCols}</select></div>
                <div class="aw-form-row">
                    <div class="aw-form-group"><label>Reference value:</label><input type="number" id="cfg-reference" value="0" step="any"></div>
                    <div class="aw-form-group"><label>Tolerance (USL âˆ’ LSL):</label><input type="number" id="cfg-tolerance" value="1.0" step="any" min="0.001"></div>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">Type 1 Gage Study:</strong> One part, one operator, repeated measurements. Cg â‰¥ 1.33 and Cgk â‰¥ 1.33 required.
                </div>
            `;
        }
        if (id === 'attribute_gage') {
            return `
                <div class="aw-form-group"><label>Appraiser result column (pass/fail):</label><select id="cfg-result">${colOptions}</select></div>
                <div class="aw-form-group"><label>Reference (truth) column:</label><select id="cfg-reference">${colOptions}</select></div>
                <div class="aw-form-group"><label>Appraiser column (optional):</label><select id="cfg-appraiser"><option value="">(none)</option>${colOptions}</select></div>
                <div style="background:rgba(217,74,74,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:#d94a4a;">Attribute Gage:</strong> Compares pass/fail calls against known reference. â‰¥90% agreement required.
                </div>
            `;
        }
        if (id === 'attribute_agreement') {
            return `
                <div class="aw-form-group"><label>Appraiser column:</label><select id="cfg-appraiser">${colOptions}</select></div>
                <div class="aw-form-group"><label>Part/Item column:</label><select id="cfg-part">${colOptions}</select></div>
                <div class="aw-form-group"><label>Rating column:</label><select id="cfg-rating">${colOptions}</select></div>
                <div style="background:rgba(74,144,217,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:#4a90d9;">Attribute Agreement:</strong> Cohen's Îº (2 raters) or Fleiss' Îº (3+). Îº > 0.6 = substantial agreement.
                </div>
            `;
        }
        return `<p style="color:#9aaa9a;font-size:11px;">Select MSA analysis.</p>`;
    }

    if (type === 'ml') {
        const catCols = columns.filter(c => c.dtype === 'text').map(c => `<option value="${c.name}">${c.name}</option>`).join('');
        const numericCols = columns.filter(c => c.dtype === 'numeric');
        const featureCheckboxes = columns.map(c => `
            <label class="aw-checkbox-item">
                <input type="checkbox" name="features" value="${c.name}" ${c.dtype === 'numeric' ? 'checked' : ''}>
                <span>${c.name}</span>
                <span class="aw-var-badge">${c.dtype === 'numeric' ? 'num' : 'cat'}</span>
            </label>
        `).join('');
        const numericFeatureCheckboxes = numericCols.map(c => `
            <label class="aw-checkbox-item">
                <input type="checkbox" name="features" value="${c.name}" checked>
                <span>${c.name}</span>
            </label>
        `).join('');

        if (id === 'classification') {
            return `
                <div class="aw-form-group">
                    <label>Target (class to predict):</label>
                    <select id="cfg-target">${catCols || colOptions}</select>
                </div>
                <div class="aw-form-group">
                    <label style="display:flex;justify-content:space-between;align-items:center;">
                        Features:
                        <span style="font-size:9px;font-weight:normal;">
                            <a href="#" onclick="toggleAllCheckboxes('features', true);return false;" style="color:var(--aw-accent);">All</a> |
                            <a href="#" onclick="toggleAllCheckboxes('features', false);return false;" style="color:var(--aw-accent);">None</a>
                        </span>
                    </label>
                    <div class="aw-checkbox-list" style="max-height:120px;overflow-y:auto;">
                        ${featureCheckboxes}
                    </div>
                </div>
                <div class="aw-form-group">
                    <label>Algorithm:</label>
                    <select id="cfg-algorithm">
                        <option value="random_forest">Random Forest</option>
                        <option value="xgboost">XGBoost</option>
                        <option value="logistic">Logistic Regression</option>
                        <option value="svm">SVM</option>
                    </select>
                </div>
                <div class="aw-form-group">
                    <label>Test split:</label>
                    <select id="cfg-split">
                        <option value="0.2">20%</option>
                        <option value="0.3">30%</option>
                        <option value="0.25">25%</option>
                    </select>
                </div>
            `;
        }
        if (id === 'clustering') {
            return `
                <div class="aw-form-group">
                    <label style="display:flex;justify-content:space-between;align-items:center;">
                        Features:
                        <span style="font-size:9px;font-weight:normal;">
                            <a href="#" onclick="toggleAllCheckboxes('features', true);return false;" style="color:var(--aw-accent);">All</a> |
                            <a href="#" onclick="toggleAllCheckboxes('features', false);return false;" style="color:var(--aw-accent);">None</a>
                        </span>
                    </label>
                    <div class="aw-checkbox-list" style="max-height:120px;overflow-y:auto;">
                        ${numericFeatureCheckboxes}
                    </div>
                </div>
                <div class="aw-form-group">
                    <label>Algorithm:</label>
                    <select id="cfg-algorithm">
                        <option value="kmeans">K-Means</option>
                        <option value="dbscan">DBSCAN</option>
                        <option value="hierarchical">Hierarchical</option>
                    </select>
                </div>
                <div class="aw-form-group">
                    <label>Number of clusters (K-Means):</label>
                    <input type="number" id="cfg-n_clusters" value="3" min="2" max="20">
                </div>
            `;
        }
        if (id === 'pca') {
            return `
                <div class="aw-form-group">
                    <label style="display:flex;justify-content:space-between;align-items:center;">
                        Features:
                        <span style="font-size:9px;font-weight:normal;">
                            <a href="#" onclick="toggleAllCheckboxes('features', true);return false;" style="color:var(--aw-accent);">All</a> |
                            <a href="#" onclick="toggleAllCheckboxes('features', false);return false;" style="color:var(--aw-accent);">None</a>
                        </span>
                    </label>
                    <div class="aw-checkbox-list" style="max-height:120px;overflow-y:auto;">
                        ${numericFeatureCheckboxes}
                    </div>
                </div>
                <div class="aw-form-group">
                    <label>Number of components:</label>
                    <input type="number" id="cfg-n_components" value="2" min="1" max="10">
                </div>
                <div class="aw-form-group">
                    <label>Color by (optional):</label>
                    <select id="cfg-color"><option value="">None</option>${colOptions}</select>
                </div>
            `;
        }
        if (id === 'feature') {
            return `
                <div class="aw-form-group">
                    <label>Target:</label>
                    <select id="cfg-target">${colOptions}</select>
                </div>
                <div class="aw-form-group">
                    <label style="display:flex;justify-content:space-between;align-items:center;">
                        Features:
                        <span style="font-size:9px;font-weight:normal;">
                            <a href="#" onclick="toggleAllCheckboxes('features', true);return false;" style="color:var(--aw-accent);">All</a> |
                            <a href="#" onclick="toggleAllCheckboxes('features', false);return false;" style="color:var(--aw-accent);">None</a>
                        </span>
                    </label>
                    <div class="aw-checkbox-list" style="max-height:120px;overflow-y:auto;">
                        ${featureCheckboxes}
                    </div>
                </div>
            `;
        }
        // Phase 1: Causal Lens Toolkit
        if (id === 'bayesian_regression') {
            return `
                <div class="aw-form-group">
                    <label>Target (response):</label>
                    <select id="cfg-target">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label style="display:flex;justify-content:space-between;align-items:center;">
                        Features (predictors):
                        <span style="font-size:9px;font-weight:normal;">
                            <a href="#" onclick="toggleAllCheckboxes('features', true);return false;" style="color:var(--aw-accent);">All</a> |
                            <a href="#" onclick="toggleAllCheckboxes('features', false);return false;" style="color:var(--aw-accent);">None</a>
                        </span>
                    </label>
                    <div class="aw-checkbox-list" style="max-height:120px;overflow-y:auto;">
                        ${numericFeatureCheckboxes}
                    </div>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">Synara Integration:</strong> Produces coefficient posteriors with 95% credible intervals that feed directly into edge weights.
                </div>
            `;
        }
        if (id === 'gam') {
            return `
                <div class="aw-form-group">
                    <label>Target (response):</label>
                    <select id="cfg-target">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label style="display:flex;justify-content:space-between;align-items:center;">
                        Features:
                        <span style="font-size:9px;font-weight:normal;">
                            <a href="#" onclick="toggleAllCheckboxes('features', true);return false;" style="color:var(--aw-accent);">All</a> |
                            <a href="#" onclick="toggleAllCheckboxes('features', false);return false;" style="color:var(--aw-accent);">None</a>
                        </span>
                    </label>
                    <div class="aw-checkbox-list" style="max-height:120px;overflow-y:auto;">
                        ${numericFeatureCheckboxes}
                    </div>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">Interpretable Nonlinearity:</strong> Shows smooth spline curves revealing HOW each feature affects the response.
                </div>
            `;
        }
        if (id === 'isolation_forest') {
            return `
                <div class="aw-form-group">
                    <label style="display:flex;justify-content:space-between;align-items:center;">
                        Features:
                        <span style="font-size:9px;font-weight:normal;">
                            <a href="#" onclick="toggleAllCheckboxes('features', true);return false;" style="color:var(--aw-accent);">All</a> |
                            <a href="#" onclick="toggleAllCheckboxes('features', false);return false;" style="color:var(--aw-accent);">None</a>
                        </span>
                    </label>
                    <div class="aw-checkbox-list" style="max-height:120px;overflow-y:auto;">
                        ${numericFeatureCheckboxes}
                    </div>
                </div>
                <div class="aw-form-group">
                    <label>Expected contamination (anomaly %):</label>
                    <select id="cfg-contamination">
                        <option value="0.01">1%</option>
                        <option value="0.05" selected>5%</option>
                        <option value="0.10">10%</option>
                        <option value="0.15">15%</option>
                    </select>
                </div>
                <div style="background:rgba(232,87,71,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:#e85747;">Missing Cause Signal:</strong> Anomalies are observations that don't fit the modelâ€”triggers causal expansion in Synara.
                </div>
            `;
        }
        if (id === 'gaussian_process') {
            return `
                <div class="aw-form-group">
                    <label>Target (Y):</label>
                    <select id="cfg-target">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label style="display:flex;justify-content:space-between;align-items:center;">
                        Predictors:
                        <span style="font-size:9px;font-weight:normal;">
                            <a href="#" onclick="toggleAllCheckboxes('features', true);return false;" style="color:var(--aw-accent);">All</a> |
                            <a href="#" onclick="toggleAllCheckboxes('features', false);return false;" style="color:var(--aw-accent);">None</a>
                        </span>
                    </label>
                    <div class="aw-checkbox-list" style="max-height:120px;overflow-y:auto;">
                        ${numericFeatureCheckboxes}
                    </div>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">Full Uncertainty:</strong> GP provides confidence bands showing where predictions are reliable vs uncertain.
                </div>
            `;
        }
        if (id === 'pls') {
            return `
                <div class="aw-form-group">
                    <label>Target (Y):</label>
                    <select id="cfg-target">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label style="display:flex;justify-content:space-between;align-items:center;">
                        Predictors:
                        <span style="font-size:9px;font-weight:normal;">
                            <a href="#" onclick="toggleAllCheckboxes('features', true);return false;" style="color:var(--aw-accent);">All</a> |
                            <a href="#" onclick="toggleAllCheckboxes('features', false);return false;" style="color:var(--aw-accent);">None</a>
                        </span>
                    </label>
                    <div class="aw-checkbox-list" style="max-height:120px;overflow-y:auto;">
                        ${numericFeatureCheckboxes}
                    </div>
                </div>
                <div class="aw-form-group">
                    <label>Components:</label>
                    <select id="cfg-n_components">
                        <option value="2">2</option>
                        <option value="3" selected>3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">Collinearity Handler:</strong> PLS projects to latent space, avoiding multicollinearity issues common in process data.
                </div>
            `;
        }
        if (id === 'regularized_regression') {
            const predChecks = columns.filter(c => c.dtype === 'numeric').map(c => `
                <label class="aw-checkbox-item"><input type="checkbox" name="predictors" value="${c.name}"><span>${c.name}</span></label>
            `).join('');
            return `
                <div class="aw-form-group">
                    <label>Response:</label>
                    <select id="cfg-response">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Predictors:</label>
                    <div class="aw-checkbox-list" style="max-height:150px;overflow-y:auto;">
                        ${predChecks || '<span style="color:#7a8f7a;">No numeric columns</span>'}
                    </div>
                    <div style="margin-top:6px;">
                        <button type="button" class="aw-btn-small" onclick="toggleAllCheckboxes('predictors', true)">All</button>
                        <button type="button" class="aw-btn-small" onclick="toggleAllCheckboxes('predictors', false)">Clear</button>
                    </div>
                </div>
                <div class="aw-form-group">
                    <label>Method:</label>
                    <select id="cfg-method">
                        <option value="elastic_net">Elastic Net (Ridge + LASSO)</option>
                        <option value="lasso">LASSO (feature selection)</option>
                        <option value="ridge">Ridge (shrinkage only)</option>
                    </select>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">Regularized Regression:</strong> Ridge shrinks coefficients, LASSO drops them to zero (feature selection), Elastic Net does both. Alpha selected by cross-validation.
                </div>
            `;
        }
        if (id === 'kaplan_meier') {
            const catCols = columns.filter(c => c.dtype === 'text').map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            return `
                <div class="aw-form-group">
                    <label>Time variable (time to event):</label>
                    <select id="cfg-time_col">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Event indicator (1=event, 0=censored):</label>
                    <select id="cfg-event_col">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Group variable (optional):</label>
                    <select id="cfg-group_col"><option value="">None (single curve)</option>${catCols || colOptions}</select>
                </div>
                <div class="aw-form-group">
                    <label>Confidence level:</label>
                    <select id="cfg-conf">
                        <option value="95">95%</option>
                        <option value="99">99%</option>
                        <option value="90">90%</option>
                    </select>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">Kaplan-Meier:</strong> Non-parametric survival curve. Event indicator: 1 = failure/death, 0 = censored/survived. Group variable enables log-rank test.
                </div>
            `;
        }
        if (id === 'cox_ph') {
            const predChecks = columns.filter(c => c.dtype === 'numeric' || c.dtype === 'text').map(c => `
                <label class="aw-checkbox-item"><input type="checkbox" name="covariates" value="${c.name}"><span>${c.name}</span></label>
            `).join('');
            return `
                <div class="aw-form-group">
                    <label>Time variable (time to event):</label>
                    <select id="cfg-time_col">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Event indicator (1=event, 0=censored):</label>
                    <select id="cfg-event_col">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Covariates:</label>
                    <div class="aw-checkbox-list" style="max-height:150px;overflow-y:auto;">
                        ${predChecks || '<span style="color:#7a8f7a;">No columns available</span>'}
                    </div>
                    <div style="margin-top:6px;">
                        <button type="button" class="aw-btn-small" onclick="toggleAllCheckboxes('covariates', true)">All</button>
                        <button type="button" class="aw-btn-small" onclick="toggleAllCheckboxes('covariates', false)">Clear</button>
                    </div>
                </div>
                <div class="aw-form-group">
                    <label>Confidence level:</label>
                    <select id="cfg-conf">
                        <option value="95">95%</option>
                        <option value="99">99%</option>
                        <option value="90">90%</option>
                    </select>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">Cox PH:</strong> Semi-parametric survival regression. Estimates hazard ratios (HR &gt; 1 = higher risk). Categorical covariates are automatically dummy-coded.
                </div>
            `;
        }
        if (id === 'discriminant_analysis') {
            const predChecks = columns.filter(c => c.dtype === 'numeric').map(c => `
                <label class="aw-checkbox-item"><input type="checkbox" name="predictors" value="${c.name}"><span>${c.name}</span></label>
            `).join('');
            const catCols = columns.filter(c => c.dtype === 'text').map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            return `
                <div class="aw-form-group">
                    <label>Group variable (target):</label>
                    <select id="cfg-response">${catCols || colOptions}</select>
                </div>
                <div class="aw-form-group">
                    <label>Predictors:</label>
                    <div class="aw-checkbox-list" style="max-height:150px;overflow-y:auto;">
                        ${predChecks || '<span style="color:#7a8f7a;">No numeric columns</span>'}
                    </div>
                    <div style="margin-top:6px;">
                        <button type="button" class="aw-btn-small" onclick="toggleAllCheckboxes('predictors', true)">All</button>
                        <button type="button" class="aw-btn-small" onclick="toggleAllCheckboxes('predictors', false)">Clear</button>
                    </div>
                </div>
                <div class="aw-form-group">
                    <label>Method:</label>
                    <select id="cfg-method">
                        <option value="lda">LDA (Linear Discriminant Analysis)</option>
                        <option value="qda">QDA (Quadratic Discriminant Analysis)</option>
                    </select>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">Discriminant Analysis:</strong> LDA assumes equal covariances (linear boundary), QDA allows class-specific covariances (curved boundary). Use LDA when groups have similar spread.
                </div>
            `;
        }
        if (id === 'acceptance_sampling') {
            return `
                <div class="aw-form-group">
                    <label>Plan type:</label>
                    <select id="cfg-plan_type">
                        <option value="single">Single Sampling</option>
                        <option value="double">Double Sampling</option>
                    </select>
                </div>
                <div class="aw-form-row">
                    <div class="aw-form-group">
                        <label>Sample size (n):</label>
                        <input type="number" id="cfg-sample_size" value="50" min="1" max="10000">
                    </div>
                    <div class="aw-form-group">
                        <label>Accept number (Ac):</label>
                        <input type="number" id="cfg-accept_number" value="2" min="0" max="100">
                    </div>
                </div>
                <div class="aw-form-row">
                    <div class="aw-form-group">
                        <label>Lot size (N):</label>
                        <input type="number" id="cfg-lot_size" value="1000" min="1" max="1000000">
                    </div>
                </div>
                <div class="aw-form-row">
                    <div class="aw-form-group">
                        <label>AQL (%):</label>
                        <input type="number" id="cfg-aql" value="1" min="0.01" max="10" step="0.1">
                    </div>
                    <div class="aw-form-group">
                        <label>LTPD (%):</label>
                        <input type="number" id="cfg-ltpd" value="5" min="0.1" max="50" step="0.1">
                    </div>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">Acceptance Sampling:</strong>
                    AQL = max acceptable defect rate (producer's quality target).
                    LTPD = worst tolerable defect rate (consumer's protection).
                    OC curve shows P(accept) at each defect rate. No dataset required.
                </div>
            `;
        }
        if (id === 'prop_1sample') {
            return `
                <div class="aw-form-group">
                    <label>Variable (binary / categorical):</label>
                    <select id="cfg-var">${allCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Event value (count as success):</label>
                    <input type="text" id="cfg-event" placeholder="e.g. 1, Yes, Pass (blank = 1 for binary)">
                </div>
                <div class="aw-form-group">
                    <label>Hypothesized proportion (pâ‚€):</label>
                    <input type="number" id="cfg-p0" value="0.5" min="0" max="1" step="0.01">
                </div>
                <div class="aw-form-group">
                    <label>Alternative:</label>
                    <select id="cfg-alternative">
                        <option value="two-sided">Two-sided (p â‰  pâ‚€)</option>
                        <option value="greater">Greater (p > pâ‚€)</option>
                        <option value="less">Less (p < pâ‚€)</option>
                    </select>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">1-Proportion Z-Test:</strong>
                    Tests whether an observed proportion differs from a target. Uses normal approximation with Wilson confidence interval.
                </div>
            `;
        }
        if (id === 'prop_2sample') {
            return `
                <div class="aw-form-group">
                    <label>Variable (binary / categorical):</label>
                    <select id="cfg-var">${allCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Group variable:</label>
                    <select id="cfg-group_var">${allCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Event value (count as success):</label>
                    <input type="text" id="cfg-event" placeholder="e.g. 1, Yes, Pass (blank = 1 for binary)">
                </div>
                <div class="aw-form-group">
                    <label>Alternative:</label>
                    <select id="cfg-alternative">
                        <option value="two-sided">Two-sided (pâ‚ â‰  pâ‚‚)</option>
                        <option value="greater">Greater (pâ‚ > pâ‚‚)</option>
                        <option value="less">Less (pâ‚ < pâ‚‚)</option>
                    </select>
                </div>
                <div style="background:rgba(74,144,217,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:#4a90d9;">2-Proportion Z-Test:</strong>
                    Compares proportions between two groups using pooled Z-statistic. Group variable must have exactly 2 levels.
                </div>
            `;
        }
        if (id === 'fisher_exact') {
            return `
                <div class="aw-form-group">
                    <label>Row variable:</label>
                    <select id="cfg-var">${allCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Column variable:</label>
                    <select id="cfg-var2">${allCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Alternative:</label>
                    <select id="cfg-alternative">
                        <option value="two-sided">Two-sided</option>
                        <option value="greater">Greater</option>
                        <option value="less">Less</option>
                    </select>
                </div>
                <div style="background:rgba(232,149,71,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:#e89547;">Fisher's Exact Test:</strong>
                    Exact test for 2Ã—2 contingency tables. Preferred over chi-square when expected cell counts &lt; 5. Reports odds ratio with CI.
                </div>
            `;
        }
        if (id === 'poisson_1sample') {
            return `
                <div class="aw-form-group">
                    <label>Count variable:</label>
                    <select id="cfg-var">${numCols}</select>
                </div>
                <div class="aw-form-row">
                    <div class="aw-form-group">
                        <label>Hypothesized rate (Î»â‚€):</label>
                        <input type="number" id="cfg-rate0" value="1.0" min="0" step="0.1">
                    </div>
                    <div class="aw-form-group">
                        <label>Exposure (time/units):</label>
                        <input type="number" id="cfg-exposure" value="1.0" min="0.001" step="0.1">
                    </div>
                </div>
                <div class="aw-form-group">
                    <label>Alternative:</label>
                    <select id="cfg-alternative">
                        <option value="two-sided">Two-sided (Î» â‰  Î»â‚€)</option>
                        <option value="greater">Greater (Î» > Î»â‚€)</option>
                        <option value="less">Less (Î» < Î»â‚€)</option>
                    </select>
                </div>
                <div style="background:rgba(217,74,74,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:#d94a4a;">Poisson Rate Test:</strong>
                    Tests if an observed event count (summed over the variable) differs from a hypothesized rate Ã— exposure. Uses exact Poisson test.
                </div>
            `;
        }
        if (id === 'power_z') {
            return `
                <div class="aw-form-row">
                    <div class="aw-form-group"><label>Difference (Î´):</label><input type="number" id="cfg-delta" value="0.5" step="0.1"></div>
                    <div class="aw-form-group"><label>Std Dev (Ïƒ):</label><input type="number" id="cfg-sigma" value="1.0" step="0.1"></div>
                </div>
                <div class="aw-form-row">
                    <div class="aw-form-group"><label>Alpha:</label><input type="number" id="cfg-alpha" value="0.05" step="0.01" min="0.001" max="0.5"></div>
                    <div class="aw-form-group"><label>Power:</label><input type="number" id="cfg-power" value="0.80" step="0.05" min="0.1" max="0.99"></div>
                </div>
                <div style="background:rgba(74,144,217,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:#4a90d9;">1-Sample Z Power:</strong> Finds sample size to detect Î´ with given power. No dataset needed.
                </div>
            `;
        }
        if (id === 'power_1prop') {
            return `
                <div class="aw-form-row">
                    <div class="aw-form-group"><label>Null proportion (pâ‚€):</label><input type="number" id="cfg-p0" value="0.5" step="0.01" min="0" max="1"></div>
                    <div class="aw-form-group"><label>Alt proportion (pâ‚):</label><input type="number" id="cfg-pa" value="0.65" step="0.01" min="0" max="1"></div>
                </div>
                <div class="aw-form-row">
                    <div class="aw-form-group"><label>Alpha:</label><input type="number" id="cfg-alpha" value="0.05" step="0.01"></div>
                    <div class="aw-form-group"><label>Power:</label><input type="number" id="cfg-power" value="0.80" step="0.05"></div>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">1-Proportion Power:</strong> Sample size to detect p=pâ‚ vs pâ‚€. No dataset needed.
                </div>
            `;
        }
        if (id === 'power_2prop') {
            return `
                <div class="aw-form-row">
                    <div class="aw-form-group"><label>Proportion 1 (pâ‚):</label><input type="number" id="cfg-p1" value="0.5" step="0.01"></div>
                    <div class="aw-form-group"><label>Proportion 2 (pâ‚‚):</label><input type="number" id="cfg-p2" value="0.65" step="0.01"></div>
                </div>
                <div class="aw-form-row">
                    <div class="aw-form-group"><label>Alpha:</label><input type="number" id="cfg-alpha" value="0.05" step="0.01"></div>
                    <div class="aw-form-group"><label>Power:</label><input type="number" id="cfg-power" value="0.80" step="0.05"></div>
                </div>
                <div class="aw-form-group"><label>nâ‚‚/nâ‚ ratio:</label><input type="number" id="cfg-ratio" value="1.0" step="0.1" min="0.1"></div>
                <div style="background:rgba(74,144,217,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:#4a90d9;">2-Proportion Power:</strong> Sample size per group to detect difference. No dataset needed.
                </div>
            `;
        }
        if (id === 'power_1variance') {
            return `
                <div class="aw-form-row">
                    <div class="aw-form-group"><label>Null Ïƒâ‚€:</label><input type="number" id="cfg-sigma0" value="1.0" step="0.1"></div>
                    <div class="aw-form-group"><label>Alt Ïƒâ‚:</label><input type="number" id="cfg-sigma1" value="1.5" step="0.1"></div>
                </div>
                <div class="aw-form-row">
                    <div class="aw-form-group"><label>Alpha:</label><input type="number" id="cfg-alpha" value="0.05" step="0.01"></div>
                    <div class="aw-form-group"><label>Power:</label><input type="number" id="cfg-power" value="0.80" step="0.05"></div>
                </div>
                <div style="background:rgba(232,149,71,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:#e89547;">1-Variance Power:</strong> Sample size to detect Ïƒâ‚ vs Ïƒâ‚€ using chi-square test. No dataset needed.
                </div>
            `;
        }
        if (id === 'power_2variance') {
            return `
                <div class="aw-form-row">
                    <div class="aw-form-group"><label>Variance ratio (Ïƒâ‚Â²/Ïƒâ‚‚Â²):</label><input type="number" id="cfg-variance_ratio" value="2.0" step="0.1" min="0.1"></div>
                    <div class="aw-form-group"><label>nâ‚‚/nâ‚ ratio:</label><input type="number" id="cfg-ratio" value="1.0" step="0.1" min="0.1"></div>
                </div>
                <div class="aw-form-row">
                    <div class="aw-form-group"><label>Alpha:</label><input type="number" id="cfg-alpha" value="0.05" step="0.01"></div>
                    <div class="aw-form-group"><label>Power:</label><input type="number" id="cfg-power" value="0.80" step="0.05"></div>
                </div>
                <div style="background:rgba(232,149,71,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:#e89547;">2-Variance Power:</strong> Sample size per group to detect variance ratio using F-test. No dataset needed.
                </div>
            `;
        }
        if (id === 'power_equivalence') {
            return `
                <div class="aw-form-row">
                    <div class="aw-form-group"><label>True difference (Î´):</label><input type="number" id="cfg-delta" value="0.0" step="0.1"></div>
                    <div class="aw-form-group"><label>Equiv margin (Â±):</label><input type="number" id="cfg-margin" value="0.5" step="0.1"></div>
                </div>
                <div class="aw-form-group"><label>Std Dev (Ïƒ):</label><input type="number" id="cfg-sigma" value="1.0" step="0.1"></div>
                <div class="aw-form-row">
                    <div class="aw-form-group"><label>Alpha:</label><input type="number" id="cfg-alpha" value="0.05" step="0.01"></div>
                    <div class="aw-form-group"><label>Power:</label><input type="number" id="cfg-power" value="0.80" step="0.05"></div>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">Equivalence Power:</strong> Sample size for TOST to prove equivalence within Â±margin. No dataset needed.
                </div>
            `;
        }
        if (id === 'power_doe') {
            return `
                <div class="aw-form-row">
                    <div class="aw-form-group"><label>Number of factors (k):</label><input type="number" id="cfg-factors" value="3" step="1" min="2" max="8"></div>
                    <div class="aw-form-group"><label>Min effect (Î”):</label><input type="number" id="cfg-delta" value="1.0" step="0.1"></div>
                </div>
                <div class="aw-form-group"><label>Std Dev (Ïƒ):</label><input type="number" id="cfg-sigma" value="1.0" step="0.1"></div>
                <div class="aw-form-row">
                    <div class="aw-form-group"><label>Alpha:</label><input type="number" id="cfg-alpha" value="0.05" step="0.01"></div>
                    <div class="aw-form-group"><label>Power:</label><input type="number" id="cfg-power" value="0.80" step="0.05"></div>
                </div>
                <div style="background:rgba(74,144,217,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:#4a90d9;">DOE Factorial Power:</strong> Required replicates for 2^k full factorial design. No dataset needed.
                </div>
            `;
        }
        if (id === 'sample_size_ci') {
            return `
                <div class="aw-form-group">
                    <label>Estimate type:</label>
                    <select id="cfg-type">
                        <option value="mean">Mean</option>
                        <option value="proportion">Proportion</option>
                    </select>
                </div>
                <div class="aw-form-group"><label>Target half-width (margin of error):</label><input type="number" id="cfg-half_width" value="0.5" step="0.1" min="0.001"></div>
                <div class="aw-form-row">
                    <div class="aw-form-group"><label>Ïƒ (for mean):</label><input type="number" id="cfg-sigma" value="1.0" step="0.1"></div>
                    <div class="aw-form-group"><label>p est (for proportion):</label><input type="number" id="cfg-p_est" value="0.5" step="0.01" min="0" max="1"></div>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">Sample Size for CI:</strong> How many observations to achieve a target confidence interval width. No dataset needed.
                </div>
            `;
        }
        if (id === 'sample_size_tolerance') {
            return `
                <div class="aw-form-row">
                    <div class="aw-form-group"><label>Coverage (e.g. 0.99):</label><input type="number" id="cfg-coverage" value="0.99" step="0.01" min="0.5" max="0.999"></div>
                    <div class="aw-form-group"><label>Confidence (e.g. 0.95):</label><input type="number" id="cfg-confidence" value="0.95" step="0.01" min="0.5" max="0.999"></div>
                </div>
                <div class="aw-form-group">
                    <label>Interval type:</label>
                    <select id="cfg-type">
                        <option value="two-sided">Two-sided</option>
                        <option value="one-sided">One-sided</option>
                    </select>
                </div>
                <div style="background:rgba(217,74,74,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:#d94a4a;">Tolerance Interval Size:</strong> Sample size so the tolerance k-factor converges. E.g. 99%/95% = 99% of population covered with 95% confidence. No dataset needed.
                </div>
            `;
        }
        if (id === 'sem') {
            return `
                <div class="aw-form-group">
                    <label>Model type:</label>
                    <select id="cfg-model_type">
                        <option value="path">Path Analysis (direct effects)</option>
                        <option value="mediation">Mediation (X â†’ M â†’ Y)</option>
                    </select>
                </div>
                <div class="aw-form-group">
                    <label>Outcome (Y):</label>
                    <select id="cfg-outcome">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label style="display:flex;justify-content:space-between;align-items:center;">
                        Predictors (X):
                        <span style="font-size:9px;font-weight:normal;">
                            <a href="#" onclick="toggleAllCheckboxes('predictors', true);return false;" style="color:var(--aw-accent);">All</a> |
                            <a href="#" onclick="toggleAllCheckboxes('predictors', false);return false;" style="color:var(--aw-accent);">None</a>
                        </span>
                    </label>
                    <div class="aw-checkbox-list" style="max-height:100px;overflow-y:auto;">
                        ${numericCols.map(c => `<label><input type="checkbox" name="predictors" value="${c}"> ${c}</label>`).join('')}
                    </div>
                </div>
                <div class="aw-form-group">
                    <label>Mediator (M) - for mediation model:</label>
                    <select id="cfg-mediator"><option value="">None</option>${numCols}</select>
                </div>
                <div style="background:rgba(74,159,110,0.1);padding:8px;border-radius:4px;font-size:10px;color:var(--aw-text-muted);">
                    <strong style="color:var(--aw-accent);">Causal Paths:</strong> SEM tests hypothesized causal relationships. Mediation analysis decomposes effects into direct and indirect paths.
                </div>
            `;
        }
    }

    // Bayesian Inference section - feeds Synara
    if (type === 'bayesian') {
        const catCols = columns.filter(c => c.dtype === 'text').map(c => `<option value="${c.name}">${c.name}</option>`).join('');
        const numericCols = columns.filter(c => c.dtype === 'numeric');
        const numericFeatureCheckboxes = numericCols.map(c => `
            <label class="aw-checkbox-item">
                <input type="checkbox" name="features" value="${c.name}" checked>
                <span>${c.name}</span>
            </label>
        `).join('');

        const synaraNote = `
            <div style="background:rgba(74,159,110,0.15);padding:10px;border-radius:4px;font-size:10px;color:var(--aw-text);margin-top:8px;border-left:3px solid var(--aw-accent);">
                <strong style="color:var(--aw-accent);">Synara Integration:</strong> Results feed into hypothesis testing. Select a project above to link evidence.
            </div>
        `;

        if (id === 'bayes_regression') {
            return `
                <div class="aw-form-group">
                    <label>Target (response):</label>
                    <select id="cfg-target">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label style="display:flex;justify-content:space-between;align-items:center;">
                        Predictors:
                        <span style="font-size:9px;font-weight:normal;">
                            <a href="#" onclick="toggleAllCheckboxes('features', true);return false;" style="color:var(--aw-accent);">All</a> |
                            <a href="#" onclick="toggleAllCheckboxes('features', false);return false;" style="color:var(--aw-accent);">None</a>
                        </span>
                    </label>
                    <div class="aw-checkbox-list" style="max-height:120px;overflow-y:auto;">
                        ${numericFeatureCheckboxes}
                    </div>
                </div>
                <div class="aw-form-group">
                    <label>Credible interval:</label>
                    <select id="cfg-ci">
                        <option value="0.95">95%</option>
                        <option value="0.90">90%</option>
                        <option value="0.99">99%</option>
                    </select>
                </div>
                ${synaraNote}
            `;
        }
        if (id === 'bayes_ttest') {
            return `
                <div class="aw-form-group">
                    <label>Sample 1:</label>
                    <select id="cfg-var1">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Sample 2:</label>
                    <select id="cfg-var2">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Prior effect size (Cohen's d):</label>
                    <select id="cfg-prior_scale">
                        <option value="medium" selected>Medium (0.5)</option>
                        <option value="small">Small (0.2)</option>
                        <option value="large">Large (0.8)</option>
                        <option value="ultrawide">Ultrawide (1.0)</option>
                    </select>
                </div>
                <div class="aw-form-group">
                    <label>Credible interval:</label>
                    <select id="cfg-ci">
                        <option value="0.95">95%</option>
                        <option value="0.90">90%</option>
                    </select>
                </div>
                ${synaraNote}
            `;
        }
        if (id === 'bayes_ab') {
            return `
                <div class="aw-form-group">
                    <label>Group column:</label>
                    <select id="cfg-group">${catCols || colOptions}</select>
                </div>
                <div class="aw-form-group">
                    <label>Success column (binary 0/1):</label>
                    <select id="cfg-success">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Prior (Beta distribution):</label>
                    <select id="cfg-prior">
                        <option value="uniform">Uniform (1, 1)</option>
                        <option value="jeffreys">Jeffreys (0.5, 0.5)</option>
                        <option value="informed">Informed (5, 5)</option>
                    </select>
                </div>
                ${synaraNote}
            `;
        }
        if (id === 'bayes_correlation') {
            return `
                <div class="aw-form-group">
                    <label>Variable X:</label>
                    <select id="cfg-var1">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Variable Y:</label>
                    <select id="cfg-var2">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Prior:</label>
                    <select id="cfg-prior">
                        <option value="uniform">Uniform [-1, 1]</option>
                        <option value="stretched_beta">Stretched Beta (moderate)</option>
                    </select>
                </div>
                ${synaraNote}
            `;
        }
        if (id === 'bayes_anova') {
            return `
                <div class="aw-form-group">
                    <label>Response (measurement):</label>
                    <select id="cfg-response">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Factor (groups):</label>
                    <select id="cfg-factor">${catCols || colOptions}</select>
                </div>
                <div class="aw-form-group">
                    <label>Prior scale:</label>
                    <select id="cfg-prior_scale">
                        <option value="medium">Medium</option>
                        <option value="wide">Wide</option>
                        <option value="ultrawide">Ultrawide</option>
                    </select>
                </div>
                ${synaraNote}
            `;
        }
        if (id === 'bayes_changepoint') {
            return `
                <div class="aw-form-group">
                    <label>Variable to analyze:</label>
                    <select id="cfg-var">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Time/sequence column (optional):</label>
                    <select id="cfg-time"><option value="">Row index</option>${colOptions}</select>
                </div>
                <div class="aw-form-group">
                    <label>Max change points:</label>
                    <select id="cfg-max_cp">
                        <option value="1">1</option>
                        <option value="2" selected>2</option>
                        <option value="3">3</option>
                    </select>
                </div>
                ${synaraNote}
            `;
        }
        if (id === 'bayes_proportion') {
            return `
                <div class="aw-form-group">
                    <label>Success column (binary 0/1):</label>
                    <select id="cfg-success">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Prior belief (Beta distribution):</label>
                    <select id="cfg-prior">
                        <option value="uniform">No prior info (1, 1)</option>
                        <option value="jeffreys">Jeffreys (0.5, 0.5)</option>
                        <option value="optimistic">Optimistic (8, 2)</option>
                        <option value="pessimistic">Pessimistic (2, 8)</option>
                    </select>
                </div>
                <div class="aw-form-group">
                    <label>Credible interval:</label>
                    <select id="cfg-ci">
                        <option value="0.95">95%</option>
                        <option value="0.90">90%</option>
                    </select>
                </div>
                ${synaraNote}
            `;
        }
        return `<p style="color:#9aaa9a;font-size:11px;">Select a Bayesian analysis.</p>`;
    }

    if (type === 'viz') {
        if (id === 'histogram' || id === 'boxplot') {
            return `
                <div class="aw-form-group">
                    <label>Variable:</label>
                    <select id="cfg-var">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Group by (color):</label>
                    <select id="cfg-by"><option value="">None</option>${colOptions}</select>
                </div>
            `;
        }
        if (id === 'scatter') {
            return `
                <div class="aw-form-row">
                    <div class="aw-form-group">
                        <label>X variable:</label>
                        <select id="cfg-x">${numCols}</select>
                    </div>
                    <div class="aw-form-group">
                        <label>Y variable:</label>
                        <select id="cfg-y">${numCols}</select>
                    </div>
                </div>
                <div class="aw-form-group">
                    <label>Color by:</label>
                    <select id="cfg-color"><option value="">None</option>${colOptions}</select>
                </div>
                <div class="aw-form-group">
                    <label style="display:flex;align-items:center;gap:8px;text-transform:none;">
                        <input type="checkbox" id="cfg-trendline" style="width:auto;">
                        Show trendline
                    </label>
                </div>
            `;
        }
        if (id === 'matrix') {
            return `
                <div class="aw-form-group">
                    <label>Variables:</label>
                    <select id="cfg-vars" multiple style="height:120px;">${numCols}</select>
                    <small style="color:#7a8f7a;">Select 2-6 variables for matrix</small>
                </div>
                <div class="aw-form-group">
                    <label>Color by:</label>
                    <select id="cfg-color"><option value="">None</option>${colOptions}</select>
                </div>
            `;
        }
        if (id === 'timeseries') {
            return `
                <div class="aw-form-group">
                    <label>Time/Index column:</label>
                    <select id="cfg-x">${colOptions}</select>
                </div>
                <div class="aw-form-group">
                    <label>Value column(s):</label>
                    <select id="cfg-y" multiple style="height:100px;">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label style="display:flex;align-items:center;gap:8px;text-transform:none;">
                        <input type="checkbox" id="cfg-markers" style="width:auto;">
                        Show markers
                    </label>
                </div>
            `;
        }
        if (id === 'probability') {
            return `
                <div class="aw-form-group">
                    <label>Variable:</label>
                    <select id="cfg-var">${numCols}</select>
                </div>
                <div class="aw-form-group">
                    <label>Distribution:</label>
                    <select id="cfg-dist">
                        <option value="norm">Normal</option>
                        <option value="lognorm">Lognormal</option>
                        <option value="expon">Exponential</option>
                        <option value="weibull">Weibull</option>
                    </select>
                </div>
            `;
        }
        if (id === 'pareto') {
            const catCols = columns.filter(c => c.dtype === 'text').map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            return `
                <div class="aw-form-group">
                    <label>Category column:</label>
                    <select id="cfg-category">${catCols || colOptions}</select>
                </div>
                <div class="aw-form-group">
                    <label>Count/Value column (optional):</label>
                    <select id="cfg-value"><option value="">Count occurrences</option>${numCols}</select>
                </div>
            `;
        }
        if (id === 'heatmap') {
            return `
                <div class="aw-form-group">
                    <label>Variables:</label>
                    <select id="cfg-vars" multiple style="height:120px;">${numCols}</select>
                    <small style="color:#7a8f7a;">Select numeric columns for correlation heatmap</small>
                </div>
            `;
        }
    }

    // Data Tools
    if (type === 'tools') {
        if (id === 'calculator') {
            return `
                <div class="aw-form-group">
                    <label>New column name:</label>
                    <input type="text" id="cfg-new_col" placeholder="e.g., Total">
                </div>
                <div class="aw-form-group">
                    <label>Expression:</label>
                    <input type="text" id="cfg-expression" placeholder="e.g., Price * Quantity">
                    <small style="color:#7a8f7a;">Use column names, operators (+, -, *, /), and functions (log, sqrt, abs)</small>
                </div>
                <div class="aw-form-group">
                    <label>Available columns:</label>
                    <div style="max-height:100px;overflow-y:auto;background:#0a0f0a;padding:6px;border-radius:3px;font-size:10px;color:#9aaa9a;">
                        ${columns.map(c => c.name).join(', ')}
                    </div>
                </div>
            `;
        }
        if (id === 'subset') {
            return `
                <div class="aw-form-group">
                    <label>Filter column:</label>
                    <select id="cfg-filter_col">${colOptions}</select>
                </div>
                <div class="aw-form-group">
                    <label>Condition:</label>
                    <select id="cfg-condition">
                        <option value="eq">Equals (==)</option>
                        <option value="ne">Not equals (!=)</option>
                        <option value="gt">Greater than (>)</option>
                        <option value="gte">Greater or equal (>=)</option>
                        <option value="lt">Less than (<)</option>
                        <option value="lte">Less or equal (<=)</option>
                        <option value="contains">Contains</option>
                        <option value="notna">Not empty</option>
                        <option value="isna">Is empty</option>
                    </select>
                </div>
                <div class="aw-form-group" id="cfg-value-group">
                    <label>Value:</label>
                    <input type="text" id="cfg-filter_value" placeholder="Filter value">
                </div>
                <div class="aw-form-group">
                    <label style="display:flex;align-items:center;gap:8px;text-transform:none;">
                        <input type="checkbox" id="cfg-new_tab" checked style="width:auto;">
                        Create as new tab
                    </label>
                </div>
            `;
        }
        if (id === 'sort') {
            return `
                <div class="aw-form-group">
                    <label>Sort by:</label>
                    <select id="cfg-sort_col">${colOptions}</select>
                </div>
                <div class="aw-form-group">
                    <label>Order:</label>
                    <select id="cfg-order">
                        <option value="asc">Ascending (Aâ†’Z, 1â†’9)</option>
                        <option value="desc">Descending (Zâ†’A, 9â†’1)</option>
                    </select>
                </div>
                <div class="aw-form-group">
                    <label style="display:flex;align-items:center;gap:8px;text-transform:none;">
                        <input type="checkbox" id="cfg-new_tab" style="width:auto;">
                        Create as new tab
                    </label>
                </div>
            `;
        }
        if (id === 'transpose') {
            return `
                <div class="aw-form-group">
                    <p style="color:#9aaa9a;margin:0 0 12px 0;">Transpose rows and columns. The first column will become the header.</p>
                    <label style="display:flex;align-items:center;gap:8px;text-transform:none;">
                        <input type="checkbox" id="cfg-new_tab" checked style="width:auto;">
                        Create as new tab
                    </label>
                </div>
            `;
        }
        if (id === 'stack') {
            return `
                <div class="aw-form-group">
                    <label>Operation:</label>
                    <select id="cfg-operation">
                        <option value="melt">Unpivot (wide â†’ long)</option>
                        <option value="pivot">Pivot (long â†’ wide)</option>
                    </select>
                </div>
                <div class="aw-form-group" id="cfg-melt-options">
                    <label>ID columns (keep as-is):</label>
                    <select id="cfg-id_cols" multiple style="height:80px;">${colOptions}</select>
                    <small style="color:#7a8f7a;">Columns that identify each row</small>
                </div>
                <div class="aw-form-group" id="cfg-pivot-options" style="display:none;">
                    <label>Index column:</label>
                    <select id="cfg-index">${colOptions}</select>
                    <label style="margin-top:8px;">Columns from:</label>
                    <select id="cfg-pivot_col">${colOptions}</select>
                    <label style="margin-top:8px;">Values from:</label>
                    <select id="cfg-values">${colOptions}</select>
                </div>
                <div class="aw-form-group">
                    <label style="display:flex;align-items:center;gap:8px;text-transform:none;">
                        <input type="checkbox" id="cfg-new_tab" checked style="width:auto;">
                        Create as new tab
                    </label>
                </div>
            `;
        }
    }

    return '<p style="color:#9aaa9a;font-size:11px;">Configure analysis options.</p>';
}

async function executeAnalysis() {
    if (!currentAnalysis || !currentData) {
        alert('Please load data first');
        return;
    }

    closeDialog('config-dialog');

    const config = {};

    // Collect from inputs and selects with IDs
    document.querySelectorAll('#config-dialog-body input[id], #config-dialog-body select').forEach(el => {
        const key = el.id.replace('cfg-', '');
        if (el.multiple) {
            config[key] = Array.from(el.selectedOptions).map(o => o.value);
        } else if (el.type !== 'checkbox') {
            config[key] = el.value;
        }
    });

    // Collect checkboxes by name (for predictors, features, etc.)
    const checkboxGroups = {};
    document.querySelectorAll('#config-dialog-body input[type="checkbox"]:checked').forEach(cb => {
        const name = cb.name;
        if (!checkboxGroups[name]) checkboxGroups[name] = [];
        checkboxGroups[name].push(cb.value);
    });
    Object.assign(config, checkboxGroups);

    const menu = analysisMenus[currentAnalysis.type];
    const item = menu?.items.find(i => i.id === currentAnalysis.id);

    // Add separator before new analysis
    appendSession('separator');
    appendSession('cmd', item?.name || currentAnalysis.id);

    // Handle checkbox for new_tab
    const newTabCheckbox = document.getElementById('cfg-new_tab');
    config.new_tab = newTabCheckbox ? newTabCheckbox.checked : false;

    try {
        // Data tools use a different endpoint
        if (currentAnalysis.type === 'tools') {
            await executeDataTool(currentAnalysis.id, config, item?.name);
            return;
        }

        const response = await fetch('/api/dsw/analysis/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                type: currentAnalysis.type,
                analysis: currentAnalysis.id,
                config: config,
                data_id: currentData?.id
            })
        });

        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.error || 'Analysis failed');
        }

        if (result.summary) {
            // Check if summary has color tags
            if (result.summary.includes('<<COLOR:')) {
                const formatted = formatColoredOutput(result.summary);
                const session = document.getElementById('session-output');
                const div = document.createElement('div');
                div.className = 'result';
                div.style.fontFamily = "'JetBrains Mono', 'Consolas', monospace";
                div.style.whiteSpace = 'pre';
                div.style.lineHeight = '1.4';
                div.innerHTML = formatted;
                session.appendChild(div);
                session.scrollTop = session.scrollHeight;
            } else {
                appendSession('result', result.summary);
            }
        }

        if (result.plots && result.plots.length > 0) {
            displayGraphs(result.plots);
        }

        // Show save model button if model can be saved
        if (result.can_save && result.model_key) {
            showSaveModelButton(result.model_key, item?.name || currentAnalysis.id);
        }

        // Show Synara integration for Bayesian weights (only if project selected)
        if (result.synara_weights && currentProject) {
            const sw = result.synara_weights;
            showSynaraIntegration(sw.coefficients, sw.coefficients.map(c => c.feature), sw.target);
        }

        // Show statistics evidence UI (only if project selected)
        if (currentProject) {
            const stats = extractStatistics(result, currentAnalysis.id);
            // Also add explicit statistics from result
            if (result.statistics) {
                for (const [name, value] of Object.entries(result.statistics)) {
                    if (typeof value === 'number' && !stats.find(s => s.name === name)) {
                        stats.push({ name, value, variable: '' });
                    }
                }
            }
            if (stats.length > 0) {
                showStatisticsEvidence(stats);
            }
        }

        addToHistory(currentAnalysis, item?.name, result.summary || '', result.plots || []);

    } catch (err) {
        appendSession('error', `Error: ${err.message}`);
    }
}

// Show save model button in session output
function showSaveModelButton(modelKey, modelType) {
    const session = document.getElementById('session-output');
    const div = document.createElement('div');
    div.className = 'save-model-prompt';
    div.style.cssText = 'margin:12px 0;padding:12px;background:rgba(74,159,110,0.1);border:1px solid var(--aw-accent);border-radius:8px;display:flex;align-items:center;gap:12px;';
    div.innerHTML = `
        <span style="flex:1;color:var(--aw-text);">
            <strong style="color:var(--aw-accent);">Model Ready</strong> - Save this ${modelType} model for later use?
        </span>
        <input type="text" id="model-name-${modelKey}" placeholder="Model name"
               style="padding:6px 10px;border:1px solid var(--aw-border);border-radius:4px;background:var(--aw-bg-tertiary);color:var(--aw-text);width:180px;">
        <button onclick="saveModel('${modelKey}')"
                style="padding:6px 16px;background:var(--aw-accent);color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:500;">
            Save Model
        </button>
    `;
    session.appendChild(div);
    session.scrollTop = session.scrollHeight;
}

// Save model to permanent storage
async function saveModel(modelKey) {
    const nameInput = document.getElementById(`model-name-${modelKey}`);
    const name = nameInput?.value?.trim() || 'Untitled Model';

    try {
        const response = await fetch('/api/dsw/models/save/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                model_key: modelKey,
                name: name
            })
        });

        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.error || 'Failed to save model');
        }

        // Replace save prompt with success message
        const prompt = nameInput?.closest('.save-model-prompt');
        if (prompt) {
            prompt.innerHTML = `
                <span style="color:var(--aw-accent);">âœ“ Model "${result.name}" saved successfully</span>
                <a href="/app/models/" style="color:var(--aw-accent);margin-left:auto;">View Models â†’</a>
            `;
        }

        // Refresh models list if visible
        if (document.getElementById('models-panel')?.style.display !== 'none') {
            loadModels();
        }

    } catch (err) {
        appendSession('error', `Failed to save model: ${err.message}`);
    }
}

// Execute data transformation tools
async function executeDataTool(toolId, config, toolName) {
    try {
        const response = await fetch('/api/dsw/transform/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                tool: toolId,
                config: config,
                data_id: currentData?.id
            })
        });

        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.error || 'Transform failed');
        }

        // If new_tab, add as new tab
        if (config.new_tab && result.data_id) {
            addTransformedData({
                id: result.data_id,
                filename: result.filename,
                columns: result.columns,
                preview: result.preview,
                rows: result.rows
            }, toolName);
        } else if (result.data_id) {
            // Update current tab
            const currentTab = dataTabs[activeTabIndex];
            currentTab.data_id = result.data_id;
            currentTab.columns = result.columns;
            currentTab.preview = result.preview;
            currentTab.rows = result.rows;

            currentData.id = result.data_id;
            currentData.columns = result.columns;
            currentData.preview = result.preview;
            currentData.rows = result.rows;

            columns = result.columns;
            updateColumnsPanel(result.columns);
            renderWorksheet(result.preview);
            updateStatus(result.rows, result.columns?.length || 0);

            appendSession('result', `${toolName}: ${result.rows} rows, ${result.columns?.length || 0} columns`);
        }

        if (result.message) {
            appendSession('result', result.message);
        }

    } catch (err) {
        appendSession('error', `Error: ${err.message}`);
    }
}

// Store current plots for cycling (if more than 4)
let currentPlots = [];
let currentPageIndex = 0;
const PLOTS_PER_PAGE = 4;

function displayGraphs(plots) {
    const pane = document.getElementById('graph-pane');

    if (!plots || plots.length === 0) {
        pane.innerHTML = '<div style="padding:20px;color:#9aaa9a;">No plots generated</div>';
        return;
    }

    if (typeof Plotly === 'undefined') {
        pane.innerHTML = '<div style="padding:20px;color:#d06060;">Error: Plotly not loaded</div>';
        return;
    }

    currentPlots = plots;
    currentPageIndex = 0;

    // Always use tab display (shows tabs when more than 4 charts)
    displayPlotPageWithNav(0);
}

function displayPlotPage(plots) {
    const pane = document.getElementById('graph-pane');
    const paneWidth = pane.clientWidth;
    const paneHeight = pane.clientHeight;

    // Layout logic:
    // 1 chart: 1 column, 1 row (full pane)
    // 2 charts: 1 column, 2 rows (stacked vertically)
    // 3-4 charts: 2 columns, 2 rows (2x2 grid)
    let cols, rows;
    if (plots.length === 1) {
        cols = 1; rows = 1;
    } else if (plots.length === 2) {
        cols = 1; rows = 2;
    } else {
        cols = 2; rows = 2;
    }

    const chartWidth = Math.floor((paneWidth - 24 - (cols - 1) * 8) / cols);
    const chartHeight = Math.floor((paneHeight - 24 - (rows - 1) * 8) / rows) - 28;

    pane.innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(${cols}, 1fr);grid-template-rows:repeat(${rows}, 1fr);gap:8px;padding:8px;height:100%;box-sizing:border-box;">
            ${plots.slice(0, PLOTS_PER_PAGE).map((plot, i) => `
                <div style="background:#0d120d;border:1px solid #4a9f6e;border-radius:4px;display:flex;flex-direction:column;min-height:0;overflow:hidden;">
                    <div style="padding:4px 10px;background:#1a261a;border-bottom:1px solid rgba(74,159,110,0.3);font-size:10px;font-weight:500;color:#e8efe8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${plot.title || 'Graph ' + (i+1)}</div>
                    <div id="graph-${i}" style="flex:1;min-height:0;"></div>
                </div>
            `).join('')}
        </div>
    `;

    plots.slice(0, PLOTS_PER_PAGE).forEach((plot, i) => renderPlot(plot, `graph-${i}`, chartWidth, chartHeight));
}

function displayPlotPageWithNav(pageIndex) {
    const pane = document.getElementById('graph-pane');
    const paneWidth = pane.clientWidth;
    const paneHeight = pane.clientHeight;

    const totalPages = Math.ceil(currentPlots.length / PLOTS_PER_PAGE);
    const startIdx = pageIndex * PLOTS_PER_PAGE;
    const pagePlots = currentPlots.slice(startIdx, startIdx + PLOTS_PER_PAGE);

    // Layout for this page's plots
    let cols, rows;
    if (pagePlots.length === 1) {
        cols = 1; rows = 1;
    } else if (pagePlots.length === 2) {
        cols = 1; rows = 2;
    } else {
        cols = 2; rows = 2;
    }

    const tabHeight = 28;
    const padding = pagePlots.length === 1 ? 8 : 16;  // Less padding for single chart
    const gap = pagePlots.length === 1 ? 0 : 8;
    const titleHeight = 24;  // Chart title bar height

    const chartWidth = Math.floor((paneWidth - padding * 2 - (cols - 1) * gap) / cols);
    const chartHeight = Math.floor((paneHeight - tabHeight - padding * 2 - (rows - 1) * gap) / rows) - titleHeight;

    // Build tab bar (only show tabs if multiple pages)
    let tabsHtml = '';
    if (totalPages > 1) {
        for (let p = 0; p < totalPages; p++) {
            const start = p * PLOTS_PER_PAGE + 1;
            const end = Math.min((p + 1) * PLOTS_PER_PAGE, currentPlots.length);
            const isActive = p === pageIndex;
            tabsHtml += `<button onclick="switchPlotTab(${p})" class="aw-chart-tab${isActive ? ' active' : ''}">${start}-${end}</button>`;
        }
    }

    // Single chart: simple full-pane layout (no grid)
    if (pagePlots.length === 1) {
        const plot = pagePlots[0];

        pane.innerHTML = `
            <div style="display:flex;flex-direction:column;height:100%;box-sizing:border-box;">
                <div class="aw-chart-tabs">
                    ${totalPages > 1 ? tabsHtml : '<span class="aw-chart-label">Charts</span>'}
                    <span style="flex:1;"></span>
                    <span class="aw-chart-count">${currentPlots.length} chart${currentPlots.length !== 1 ? 's' : ''}</span>
                </div>
                <div style="flex:1;padding:4px;min-height:0;background:#1a261a;overflow:hidden;">
                    <div style="background:#0d120d;border:1px solid #4a9f6e;border-radius:4px;display:flex;flex-direction:column;height:100%;overflow:hidden;">
                        <div style="padding:4px 10px;background:#1a261a;border-bottom:1px solid rgba(74,159,110,0.3);font-size:10px;font-weight:500;color:#e8efe8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${plot.title || 'Graph 1'}</div>
                        <div id="graph-0" style="flex:1;min-height:0;overflow:hidden;"></div>
                    </div>
                </div>
            </div>
        `;

        // Measure actual container size after DOM renders (use setTimeout for layout completion)
        setTimeout(() => {
            const graphEl = document.getElementById('graph-0');
            if (graphEl) {
                const actualWidth = graphEl.clientWidth || paneWidth - 20;
                const actualHeight = graphEl.clientHeight || paneHeight - 60;
                console.log('Single chart size:', actualWidth, 'x', actualHeight, 'pane:', paneWidth, 'x', paneHeight);
                renderPlot(plot, 'graph-0', actualWidth, actualHeight);
            }
        }, 50);
        return;
    }

    // Multiple charts: use grid layout
    pane.innerHTML = `
        <div style="display:flex;flex-direction:column;height:100%;box-sizing:border-box;">
            <!-- Tab bar -->
            <div class="aw-chart-tabs">
                ${totalPages > 1 ? tabsHtml : '<span class="aw-chart-label">Charts</span>'}
                <span style="flex:1;"></span>
                <span class="aw-chart-count">${currentPlots.length} chart${currentPlots.length !== 1 ? 's' : ''}</span>
            </div>
            <!-- Charts grid -->
            <div style="flex:1;display:grid;grid-template-columns:repeat(${cols}, 1fr);grid-template-rows:repeat(${rows}, 1fr);gap:${gap}px;padding:${padding}px;min-height:0;background:#1a261a;">
                ${pagePlots.map((plot, i) => `
                    <div style="background:#0d120d;border:1px solid #4a9f6e;border-radius:4px;display:flex;flex-direction:column;min-height:0;overflow:hidden;">
                        <div style="padding:4px 10px;background:#1a261a;border-bottom:1px solid rgba(74,159,110,0.3);font-size:10px;font-weight:500;color:#e8efe8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${plot.title || 'Graph ' + (startIdx + i + 1)}</div>
                        <div id="graph-${i}" style="flex:1;min-height:0;"></div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;

    pagePlots.forEach((plot, i) => renderPlot(plot, `graph-${i}`, chartWidth, chartHeight));
}

function cyclePlotPage(direction) {
    const totalPages = Math.ceil(currentPlots.length / PLOTS_PER_PAGE);
    const newPage = currentPageIndex + direction;
    if (newPage >= 0 && newPage < totalPages) {
        currentPageIndex = newPage;
        displayPlotPageWithNav(newPage);
    }
}

function switchPlotTab(pageIndex) {
    currentPageIndex = pageIndex;
    displayPlotPageWithNav(pageIndex);
}

// ============================================================================
// CHART SETTINGS
// ============================================================================
const chartThemes = {
    green: { primary: '74, 159, 110', border: '#4a9f6e' },
    blue: { primary: '71, 165, 232', border: '#47a5e8' },
    purple: { primary: '108, 92, 231', border: '#6c5ce7' },
    orange: { primary: '232, 149, 71', border: '#e89547' }
};

let chartSettings = {
    alpha: 50,
    markerSize: 6,
    borderWidth: 1.5,
    theme: 'green'
};

// Load settings from localStorage
try {
    const saved = localStorage.getItem('awChartSettings');
    if (saved) chartSettings = { ...chartSettings, ...JSON.parse(saved) };
} catch (e) {}

function toggleChartSettings() {
    const dropdown = document.getElementById('chart-settings-dropdown');
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';

    // Update UI to reflect current settings
    document.getElementById('chart-alpha').value = chartSettings.alpha;
    document.getElementById('chart-marker-size').value = chartSettings.markerSize;
    document.getElementById('chart-border-width').value = chartSettings.borderWidth;
    document.getElementById('chart-theme').value = chartSettings.theme;
    updateChartSettings();
}

function updateChartSettings() {
    chartSettings.alpha = parseInt(document.getElementById('chart-alpha').value);
    chartSettings.markerSize = parseInt(document.getElementById('chart-marker-size').value);
    chartSettings.borderWidth = parseFloat(document.getElementById('chart-border-width').value);
    chartSettings.theme = document.getElementById('chart-theme').value;

    // Update display values
    document.getElementById('alpha-value').textContent = chartSettings.alpha + '%';
    document.getElementById('size-value').textContent = chartSettings.markerSize;
    document.getElementById('border-value').textContent = chartSettings.borderWidth;

    // Save to localStorage
    try {
        localStorage.setItem('awChartSettings', JSON.stringify(chartSettings));
    } catch (e) {}
}

function replotAllCharts() {
    // Close dropdown
    document.getElementById('chart-settings-dropdown').style.display = 'none';

    // Replot current charts
    if (currentPlots.length > 0) {
        displayPlotPageWithNav(currentPageIndex);
    }
}

// Close dropdown when clicking outside
document.addEventListener('click', (e) => {
    const dropdown = document.getElementById('chart-settings-dropdown');
    const btn = e.target.closest('.aw-toolbar-dropdown');
    if (dropdown && !btn) {
        dropdown.style.display = 'none';
    }
});

function getChartColors() {
    const theme = chartThemes[chartSettings.theme] || chartThemes.green;
    const alpha = chartSettings.alpha / 100;
    return {
        fill: `rgba(${theme.primary}, ${alpha})`,
        fillLight: `rgba(${theme.primary}, ${alpha * 0.6})`,
        border: theme.border,
        markerSize: chartSettings.markerSize,
        borderWidth: chartSettings.borderWidth
    };
}

function renderPlot(plot, elementId, chartWidth, chartHeight) {
    const el = document.getElementById(elementId);
    if (!el || !plot.data?.[0]) return;

    const plotData = JSON.parse(JSON.stringify(plot.data)); // Deep clone to avoid mutations
    const colors = getChartColors();

    // Apply chart settings to traces
    plotData.forEach((trace, i) => {
        // Skip traces with data-dependent coloring (arrays, colorscales)
        const hasDataColoring = trace.marker?.colorscale ||
                               trace.marker?.showscale ||
                               Array.isArray(trace.marker?.color);
        if (hasDataColoring) return;

        // Check if color is a "theme" color (green variants) that should be updated
        const isThemeColor = (c) => {
            if (!c || typeof c !== 'string') return true; // No color = apply theme
            c = c.toLowerCase();
            return c.includes('74, 159, 110') || c.includes('74,159,110') ||
                   c === '#4a9f6e' || c === '#3a7f8f' ||
                   c.includes('71, 165, 232') || c.includes('108, 92, 231') ||
                   c.includes('232, 149, 71');
        };

        if (trace.type === 'histogram' || trace.type === 'bar') {
            if (isThemeColor(trace.marker?.color)) {
                trace.marker = {
                    ...trace.marker,
                    color: colors.fill,
                    line: { color: colors.border, width: colors.borderWidth }
                };
            }
        } else if (trace.type === 'scatter' && trace.mode?.includes('markers')) {
            if (isThemeColor(trace.marker?.color)) {
                trace.marker = {
                    ...trace.marker,
                    color: colors.fill,
                    line: { color: colors.border, width: Math.max(1, colors.borderWidth - 0.5) },
                    size: trace.marker?.size || colors.markerSize
                };
            }
        } else if (trace.type === 'box') {
            trace.marker = { ...trace.marker, color: colors.border };
            trace.line = { color: colors.border };
            trace.fillcolor = colors.fillLight;
        }
    });

    // Use provided dimensions, with reasonable minimums
    const w = Math.max(chartWidth, 200);
    const h = Math.max(chartHeight, 150);
    const isLargeChart = chartWidth > 400;  // Single chart or large display

    const showLegend = plotData.length > 1 && plotData.some(t => t.name);

    // Extract plot.layout but exclude width/height (we control sizing)
    const { width: _w, height: _h, ...plotLayoutRest } = (plot.layout || {});

    Plotly.newPlot(el, plotData, {
        ...plotLayoutRest,  // Plot-specific layout FIRST (so we can override)
        width: w,
        height: h,
        paper_bgcolor: '#0d120d',
        plot_bgcolor: '#0a0f0a',
        font: { color: '#e8efe8', size: isLargeChart ? 12 : 10 },
        margin: { t: 15, r: showLegend ? 100 : 20, b: isLargeChart ? 50 : 35, l: isLargeChart ? 60 : 45 },
        xaxis: {
            color: '#9aaa9a',
            gridcolor: 'rgba(74,159,110,0.2)',
            linecolor: '#4a9f6e',
            tickfont: { size: isLargeChart ? 11 : 9 },
            ...(plotLayoutRest.xaxis || {})
        },
        yaxis: {
            color: '#9aaa9a',
            gridcolor: 'rgba(74,159,110,0.2)',
            linecolor: '#4a9f6e',
            tickfont: { size: isLargeChart ? 11 : 9 },
            ...(plotLayoutRest.yaxis || {})
        },
        showlegend: showLegend,
        legend: {
            bgcolor: 'rgba(13,18,13,0.8)',
            bordercolor: '#4a9f6e',
            borderwidth: 1,
            font: { color: '#9aaa9a', size: isLargeChart ? 11 : 9 }
        }
    }, {
        responsive: true,
        displayModeBar: false
    });
}

function addToHistory(analysis, name, summary = '', plots = []) {
    const historyIndex = history.length;

    // Store in history array
    history.push({
        analysis: analysis,
        name: name,
        summary: summary,
        plots: plots,
        timestamp: new Date().toISOString()
    });

    // Add to sidebar UI
    const list = document.getElementById('history-list');
    const item = document.createElement('div');
    item.className = 'aw-sidebar-item';

    const hasPlots = plots && plots.length > 0;
    item.innerHTML = `
        <span>${name}</span>
        ${hasPlots ? '<span style="color:var(--aw-accent);font-size:9px;margin-left:4px;">ðŸ“Š</span>' : ''}
        <span style="color:var(--aw-text-muted);font-size:9px;margin-left:auto;">${new Date().toLocaleTimeString()}</span>
    `;

    if (hasPlots) {
        item.style.cursor = 'pointer';
        item.onclick = () => restoreHistoryPlots(historyIndex);
        item.title = 'Click to restore charts';
    }

    list.insertBefore(item, list.firstChild);

    // Add to sessionHistory for LLM context (strip color tags)
    const cleanSummary = summary.replace(/<<COLOR:\w+>>/g, '').replace(/<<\/COLOR>>/g, '');
    sessionHistory.push({
        type: analysis?.type || 'unknown',
        id: analysis?.id || 'unknown',
        name: name,
        summary: cleanSummary.substring(0, 500),  // Limit length
        timestamp: new Date().toISOString()
    });
}

function restoreHistoryPlots(index) {
    const entry = history[index];
    if (entry && entry.plots && entry.plots.length > 0) {
        displayGraphs(entry.plots);
    }
}

// ============================================================================
// COMMAND LINE
// ============================================================================

// Pearson correlation helper
function pearsonCorr(pairs) {
    const n = pairs.length;
    if (n < 2) return 0;
    const sumX = pairs.reduce((a, p) => a + p[0], 0);
    const sumY = pairs.reduce((a, p) => a + p[1], 0);
    const sumXY = pairs.reduce((a, p) => a + p[0] * p[1], 0);
    const sumX2 = pairs.reduce((a, p) => a + p[0] * p[0], 0);
    const sumY2 = pairs.reduce((a, p) => a + p[1] * p[1], 0);
    const num = n * sumXY - sumX * sumY;
    const den = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
    return den === 0 ? 0 : num / den;
}

function runCommand() {
    const input = document.getElementById('cmd-input');
    const cmd = input.value.trim();
    if (!cmd) return;

    input.value = '';
    appendSession('cmd', cmd);

    // Parse command
    const parts = cmd.toLowerCase().split(/\s+/);
    const command = parts[0];
    const args = parts.slice(1);

    switch (command) {
        case 'help':
            appendSession('result', `Available commands:
  help              - Show this help
  info              - Dataset info
  columns           - List all columns
  head [n]          - Show first n rows (default: 5)
  tail [n]          - Show last n rows (default: 5)
  describe          - Summary statistics
  corr [col1] [col2]- Correlation (all or between two columns)
  unique <col>      - Unique values in column
  count [col]       - Row count or value counts
  missing           - Show missing value counts
  hist <col>        - Histogram (opens chart)
  plot <x> <y>      - Scatter plot (opens chart)
  export            - Download current data
  clear             - Clear session history

Keyboard: Ctrl+K focus command, Ctrl+/ shortcuts, Esc close dialogs`);
            break;

        case 'info':
            if (!currentData) {
                appendSession('error', 'No data loaded. Load a dataset first.');
            } else {
                appendSession('result', `Dataset: ${currentData.filename || 'Untitled'}
Rows: ${currentData.rows?.toLocaleString() || '?'}
Columns: ${columns.length}
ID: ${currentData.id}`);
            }
            break;

        case 'columns':
        case 'cols':
            if (!columns.length) {
                appendSession('error', 'No data loaded.');
            } else {
                const colList = columns.map((c, i) => `  ${i + 1}. ${c.name} (${c.type || 'unknown'})`).join('\n');
                appendSession('result', `Columns (${columns.length}):\n${colList}`);
            }
            break;

        case 'head':
            if (!currentData?.preview) {
                appendSession('error', 'No data loaded.');
            } else {
                const n = parseInt(args[0]) || 5;
                const rows = currentData.preview.slice(0, n);
                const headers = columns.map(c => c.name).join('\t');
                const rowStrs = rows.map(r => columns.map(c => r[c.name] ?? '').join('\t')).join('\n');
                appendSession('result', `${headers}\n${rowStrs}`);
            }
            break;

        case 'describe':
        case 'summary':
            if (!currentData?.preview) {
                appendSession('error', 'No data loaded.');
            } else {
                const numericCols = columns.filter(c => c.type === 'numeric' || c.type === 'number');
                if (!numericCols.length) {
                    appendSession('result', 'No numeric columns found.');
                } else {
                    let stats = 'Column\t\tMin\tMax\tMean\n';
                    numericCols.slice(0, 8).forEach(col => {
                        const vals = currentData.preview.map(r => parseFloat(r[col.name])).filter(v => !isNaN(v));
                        if (vals.length) {
                            const min = Math.min(...vals).toFixed(2);
                            const max = Math.max(...vals).toFixed(2);
                            const mean = (vals.reduce((a, b) => a + b, 0) / vals.length).toFixed(2);
                            stats += `${col.name.substring(0, 12)}\t\t${min}\t${max}\t${mean}\n`;
                        }
                    });
                    appendSession('result', stats);
                }
            }
            break;

        case 'unique':
            if (!args[0]) {
                appendSession('error', 'Usage: unique <column_name>');
            } else if (!currentData?.preview) {
                appendSession('error', 'No data loaded.');
            } else {
                const colName = columns.find(c => c.name.toLowerCase() === args[0])?.name;
                if (!colName) {
                    appendSession('error', `Column "${args[0]}" not found.`);
                } else {
                    const vals = [...new Set(currentData.preview.map(r => r[colName]))].slice(0, 20);
                    appendSession('result', `Unique values in "${colName}" (first 20):\n${vals.join(', ')}`);
                }
            }
            break;

        case 'tail':
            if (!currentData?.preview) {
                appendSession('error', 'No data loaded.');
            } else {
                const n = parseInt(args[0]) || 5;
                const rows = currentData.preview.slice(-n);
                const headers = columns.map(c => c.name).join('\t');
                const rowStrs = rows.map(r => columns.map(c => r[c.name] ?? '').join('\t')).join('\n');
                appendSession('result', `${headers}\n${rowStrs}`);
            }
            break;

        case 'corr':
            if (!currentData?.preview) {
                appendSession('error', 'No data loaded.');
            } else {
                const numCols = columns.filter(c => c.type === 'numeric' || c.type === 'number');
                if (numCols.length < 2) {
                    appendSession('error', 'Need at least 2 numeric columns for correlation.');
                } else if (args.length >= 2) {
                    // Correlation between two specific columns
                    const col1 = columns.find(c => c.name.toLowerCase() === args[0])?.name;
                    const col2 = columns.find(c => c.name.toLowerCase() === args[1])?.name;
                    if (!col1 || !col2) {
                        appendSession('error', 'Column not found.');
                    } else {
                        const pairs = currentData.preview.map(r => [parseFloat(r[col1]), parseFloat(r[col2])]).filter(p => !isNaN(p[0]) && !isNaN(p[1]));
                        const r = pearsonCorr(pairs);
                        appendSession('result', `Correlation(${col1}, ${col2}) = ${r.toFixed(4)}`);
                    }
                } else {
                    // Full correlation matrix
                    let matrix = 'Correlation Matrix:\n\t\t' + numCols.slice(0,6).map(c => c.name.substring(0,8)).join('\t') + '\n';
                    numCols.slice(0,6).forEach(c1 => {
                        matrix += c1.name.substring(0,8) + '\t';
                        numCols.slice(0,6).forEach(c2 => {
                            const pairs = currentData.preview.map(r => [parseFloat(r[c1.name]), parseFloat(r[c2.name])]).filter(p => !isNaN(p[0]) && !isNaN(p[1]));
                            const r = pearsonCorr(pairs);
                            matrix += r.toFixed(2) + '\t';
                        });
                        matrix += '\n';
                    });
                    appendSession('result', matrix);
                }
            }
            break;

        case 'count':
            if (!currentData?.preview) {
                appendSession('error', 'No data loaded.');
            } else if (args[0]) {
                const colName = columns.find(c => c.name.toLowerCase() === args[0])?.name;
                if (!colName) {
                    appendSession('error', `Column "${args[0]}" not found.`);
                } else {
                    const counts = {};
                    currentData.preview.forEach(r => {
                        const v = r[colName] || '(empty)';
                        counts[v] = (counts[v] || 0) + 1;
                    });
                    const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 15);
                    appendSession('result', `Value counts for "${colName}":\n` + sorted.map(([v, c]) => `  ${v}: ${c}`).join('\n'));
                }
            } else {
                appendSession('result', `Total rows: ${currentData.preview.length}`);
            }
            break;

        case 'missing':
            if (!currentData?.preview) {
                appendSession('error', 'No data loaded.');
            } else {
                let missing = 'Missing values:\n';
                columns.forEach(col => {
                    const nullCount = currentData.preview.filter(r => r[col.name] === null || r[col.name] === '' || r[col.name] === undefined).length;
                    if (nullCount > 0) {
                        missing += `  ${col.name}: ${nullCount} (${(nullCount/currentData.preview.length*100).toFixed(1)}%)\n`;
                    }
                });
                appendSession('result', missing || 'No missing values found.');
            }
            break;

        case 'hist':
            if (!args[0]) {
                appendSession('error', 'Usage: hist <column_name>');
            } else if (!currentData?.preview) {
                appendSession('error', 'No data loaded.');
            } else {
                const colName = columns.find(c => c.name.toLowerCase() === args[0])?.name;
                if (!colName) {
                    appendSession('error', `Column "${args[0]}" not found.`);
                } else {
                    const vals = currentData.preview.map(r => parseFloat(r[colName])).filter(v => !isNaN(v));
                    Plotly.newPlot('graph-output', [{x: vals, type: 'histogram', marker: {color: '#4a9f6e'}}],
                        {title: `Histogram: ${colName}`, paper_bgcolor: '#0a0f0a', plot_bgcolor: '#0d120d', font: {color: '#9aaa9a'}},
                        {responsive: true});
                    appendSession('result', `Histogram for "${colName}" displayed.`);
                }
            }
            break;

        case 'plot':
        case 'scatter':
            if (args.length < 2) {
                appendSession('error', 'Usage: plot <x_column> <y_column>');
            } else if (!currentData?.preview) {
                appendSession('error', 'No data loaded.');
            } else {
                const xCol = columns.find(c => c.name.toLowerCase() === args[0])?.name;
                const yCol = columns.find(c => c.name.toLowerCase() === args[1])?.name;
                if (!xCol || !yCol) {
                    appendSession('error', 'Column not found.');
                } else {
                    const x = currentData.preview.map(r => parseFloat(r[xCol]));
                    const y = currentData.preview.map(r => parseFloat(r[yCol]));
                    Plotly.newPlot('graph-output', [{x, y, mode: 'markers', type: 'scatter', marker: {color: '#4a9f6e'}}],
                        {title: `${xCol} vs ${yCol}`, xaxis: {title: xCol}, yaxis: {title: yCol}, paper_bgcolor: '#0a0f0a', plot_bgcolor: '#0d120d', font: {color: '#9aaa9a'}},
                        {responsive: true});
                    appendSession('result', `Scatter plot displayed.`);
                }
            }
            break;

        case 'export':
        case 'download':
            downloadCurrentData();
            break;

        case 'clear':
            sessionHistory = [];
            document.getElementById('session-history').innerHTML = '';
            appendSession('note', 'Session cleared.');
            break;

        default:
            appendSession('error', `Unknown command: ${command}. Type "help" for available commands.`);
    }
}

function runCode() {
    runCommand();
}

// ============================================================================
// ASSISTANT
// ============================================================================
async function askAssistant() {
    const input = document.getElementById('assistant-input');
    const agentType = document.getElementById('agent-type').value;
    const question = input.value.trim();
    if (!question) return;

    input.value = '';
    input.disabled = true;

    const agentLabels = {
        'analyst': 'Analyst',
        'researcher': 'Researcher',
        'writer': 'Writer'
    };
    const agentColors = {
        'analyst': '#4a9f6e',
        'researcher': '#47a5e8',
        'writer': '#e89547'
    };
    const agentColor = agentColors[agentType] || '#4a9f6e';

    const container = document.getElementById('assistant-messages');
    container.innerHTML += `
        <div style="padding:8px;background:var(--aw-panel-header);margin-bottom:8px;font-size:11px;border-radius:3px;">
            <strong style="color:var(--aw-text);">You</strong> <span style="font-size:9px;color:${agentColor};">(to ${agentLabels[agentType]})</span><strong style="color:var(--aw-text);">:</strong> <span style="color:var(--aw-text-dim);">${question}</span>
        </div>
    `;

    // Add thinking indicator with agent-specific color
    const thinkingId = 'thinking-' + Date.now();
    const thinkingText = agentType === 'researcher' ? 'Researching...' : (agentType === 'writer' ? 'Writing...' : 'Thinking...');
    container.innerHTML += `
        <div id="${thinkingId}" style="padding:10px;background:${agentColor}15;border-left:2px solid ${agentColor};margin-bottom:8px;font-size:11px;border-radius:3px;">
            <span class="thinking-indicator">
                <span class="thinking-dot"></span>
                <span class="thinking-dot"></span>
                <span class="thinking-dot"></span>
            </span>
            <span style="color:${agentColor};margin-left:8px;">${thinkingText}</span>
        </div>
    `;
    container.scrollTop = container.scrollHeight;

    try {
        // Get model selection for enterprise users
        const modelSelector = document.getElementById('dsw-model-selector');
        const selectedModel = (modelSelector && modelSelector.style.display !== 'none') ? modelSelector.value : 'default';

        const response = await fetch('/api/dsw/analyst/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                message: question,
                agent_type: agentType,
                model: selectedModel,
                context: {
                    data_id: currentData?.id,
                    columns: columns.map(c => c.name),
                    session_history: sessionHistory,
                    data_preview: currentData?.preview?.slice(0, 10)  // Send some data for researcher context
                }
            })
        });

        // Check if response is OK
        if (!response.ok) {
            const text = await response.text();
            console.error('Server error:', response.status, text.substring(0, 500));
            throw new Error(`Server error ${response.status}: ${text.substring(0, 100)}`);
        }

        const result = await response.json();

        // Remove thinking indicator
        document.getElementById(thinkingId)?.remove();

        // Simple markdown-like formatting
        let formatted = (result.response || 'I encountered an issue.')
            .replace(/\*\*(.+?)\*\*/g, '<strong style="color:#e8efe8;">$1</strong>')
            .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color:' + agentColor + ';">$1</a>')
            .replace(/\n/g, '<br>');

        // Check if writer returned a downloadable document
        let downloadHtml = '';
        if (result.document) {
            downloadHtml = `
                <div style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(232,149,71,0.3);">
                    <a href="data:text/markdown;charset=utf-8,${encodeURIComponent(result.document)}"
                       download="${result.filename || 'document.md'}"
                       style="color:#e89547;font-size:10px;">
                       ðŸ“„ Download ${result.filename || 'document.md'}
                    </a>
                </div>
            `;
        }

        container.innerHTML += `
            <div style="padding:10px;background:${agentColor}15;border-left:2px solid ${agentColor};margin-bottom:8px;font-size:11px;border-radius:3px;line-height:1.5;">
                <strong style="color:${agentColor};">${agentLabels[agentType]}:</strong><br>
                <span style="color:#9aaa9a;">${formatted}</span>
                ${downloadHtml}
            </div>
        `;

    } catch (err) {
        // Remove thinking indicator
        document.getElementById(thinkingId)?.remove();

        container.innerHTML += `
            <div style="padding:8px;background:rgba(208,96,96,0.15);border-left:2px solid var(--aw-danger);margin-bottom:8px;font-size:11px;border-radius:3px;">
                <strong>Error:</strong> ${err.message}
            </div>
        `;
    }

    input.disabled = false;
    input.focus();
    container.scrollTop = container.scrollHeight;
}

// ============================================================================
// UI HELPERS
// ============================================================================
function toggleSection(header) {
    const content = header.nextElementSibling;
    content.style.display = content.style.display === 'none' ? 'block' : 'none';
}

function selectAllPredictors(select) {
    const checkboxes = document.querySelectorAll('#cfg-predictors-list input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = select);
}

function toggleAllCheckboxes(name, select) {
    const checkboxes = document.querySelectorAll(`input[type="checkbox"][name="${name}"]`);
    checkboxes.forEach(cb => cb.checked = select);
}

function closeDialog(id) {
    document.getElementById(id).classList.remove('active');
}

function getCSRFToken() {
    return document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='))?.split('=')[1] || '';
}

// ============================================================================
// KEYBOARD SHORTCUTS
// ============================================================================
document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + Enter: Run code
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        runCode();
    }

    // Ctrl/Cmd + K: Focus command input
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        document.getElementById('cmd-input').focus();
    }

    // Ctrl/Cmd + /: Show keyboard shortcuts help
    if ((e.ctrlKey || e.metaKey) && e.key === '/') {
        e.preventDefault();
        showKeyboardShortcuts();
    }

    // Escape: Close dialogs
    if (e.key === 'Escape') {
        document.querySelectorAll('.aw-dialog.active').forEach(d => d.classList.remove('active'));
    }
});

function showKeyboardShortcuts() {
    const shortcuts = [
        ['Ctrl + Enter', 'Run code'],
        ['Ctrl + K', 'Focus console'],
        ['Ctrl + /', 'Show shortcuts'],
        ['Escape', 'Close dialogs'],
    ];
    const container = document.getElementById('cmd-output');
    container.innerHTML += `
        <div style="color:#6aaa8a;font-size:10px;margin-top:4px;">
            <strong>Keyboard Shortcuts:</strong><br>
            ${shortcuts.map(([k, d]) => `<span style="color:#e8efe8;">${k}</span> - ${d}`).join('<br>')}
        </div>
    `;
    container.scrollTop = container.scrollHeight;
}

document.getElementById('cmd-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        runCommand();
    }
});

document.getElementById('assistant-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        askAssistant();
    }
});

// ============================================================================
// DRAG & DROP
// ============================================================================
const worksheetPane = document.getElementById('worksheet-pane');
worksheetPane.addEventListener('dragover', (e) => {
    e.preventDefault();
    worksheetPane.style.background = 'rgba(74, 159, 110, 0.15)';
});
worksheetPane.addEventListener('dragleave', () => {
    worksheetPane.style.background = '';
});
worksheetPane.addEventListener('drop', async (e) => {
    e.preventDefault();
    worksheetPane.style.background = '';
    const file = e.dataTransfer.files[0];
    if (file) await loadFile(file);
});
</script>
{% endblock %}
