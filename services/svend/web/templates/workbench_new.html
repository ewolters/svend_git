{% extends "base_app.html" %}
{% block title %}SVEND - Decision Science Workbench{% endblock %}

{% block content %}
</div><!-- Close container from base -->
<div class="workbench-app" id="workbench-app">
    <!-- Workbench Header -->
    <div class="wb-header">
        <div class="wb-header-left">
            <button class="wb-btn wb-btn-icon" onclick="showWorkbenchList()" title="All Workbenches">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                </svg>
            </button>
            <div class="wb-project-selector">
                <select class="wb-project-select" id="project-select" title="Link to study">
                    <option value="">No study</option>
                </select>
                <a href="#" class="wb-project-link" id="project-link" style="display:none" title="Open study">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                        <polyline points="15 3 21 3 21 9"/>
                        <line x1="10" y1="14" x2="21" y2="3"/>
                    </svg>
                </a>
            </div>
            <div class="wb-title-group">
                <input type="text" class="wb-title-input" id="workbench-title" placeholder="Untitled Inquiry" value="">
                <select class="wb-template-select" id="workbench-template">
                    <option value="blank">Blank</option>
                    <option value="dmaic">DMAIC</option>
                    <option value="kaizen">Kaizen Event</option>
                    <option value="8d">8D Report</option>
                    <option value="a3">A3 Problem Solving</option>
                </select>
            </div>
        </div>
        <div class="wb-header-right">
            <span class="wb-status" id="workbench-status">Active</span>
            <button class="wb-btn" onclick="exportWorkbench()">Export</button>
            <button class="wb-btn wb-btn-primary" onclick="saveWorkbench()">Save</button>
        </div>
    </div>

    <!-- Ribbon Toolbar -->
    <div class="wb-ribbon">
        <div class="ribbon-tabs">
            <button class="ribbon-tab active" data-tab="data">Data</button>
            <button class="ribbon-tab" data-tab="prepare">Prepare</button>
            <button class="ribbon-tab" data-tab="analysis">Analysis</button>
            <button class="ribbon-tab" data-tab="experiment">Experiment</button>
            <button class="ribbon-tab" data-tab="ml">ML</button>
        </div>

        <!-- Data Tab -->
        <div class="ribbon-content active" id="ribbon-data">
            <div class="ribbon-group">
                <div class="ribbon-group-label">Import</div>
                <div class="ribbon-buttons">
                    <button class="ribbon-btn ribbon-btn-lg" onclick="importFile('.csv')">
                        <svg class="ribbon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="12" y1="18" x2="12" y2="12"/>
                            <line x1="9" y1="15" x2="15" y2="15"/>
                        </svg>
                        <span>Import CSV</span>
                    </button>
                    <button class="ribbon-btn ribbon-btn-lg" onclick="importFile('.xlsx,.xls')">
                        <svg class="ribbon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <rect x="8" y="12" width="8" height="6" rx="1"/>
                        </svg>
                        <span>Import Excel</span>
                    </button>
                </div>
            </div>
            <div class="ribbon-divider"></div>
            <div class="ribbon-group">
                <div class="ribbon-group-label">Graph</div>
                <div class="ribbon-buttons">
                    <button class="ribbon-btn" onclick="openGraphDialog('histogram')">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="12" width="4" height="8"/><rect x="10" y="6" width="4" height="14"/><rect x="17" y="9" width="4" height="11"/>
                        </svg>
                        <span>Histogram</span>
                    </button>
                    <button class="ribbon-btn" onclick="openGraphDialog('scatter')">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="7" cy="17" r="1.5"/><circle cx="10" cy="12" r="1.5"/><circle cx="14" cy="8" r="1.5"/><circle cx="18" cy="6" r="1.5"/><circle cx="12" cy="15" r="1.5"/>
                        </svg>
                        <span>Scatter</span>
                    </button>
                    <button class="ribbon-btn" onclick="openGraphDialog('boxplot')">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="6" y="8" width="12" height="8" rx="1"/><line x1="12" y1="4" x2="12" y2="8"/><line x1="12" y1="16" x2="12" y2="20"/><line x1="6" y1="12" x2="18" y2="12"/>
                        </svg>
                        <span>Boxplot</span>
                    </button>
                    <button class="ribbon-btn" onclick="openGraphDialog('density')">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M2 20 Q6 20 8 16 Q10 8 12 6 Q14 4 16 8 Q18 14 20 18 Q21 20 22 20"/>
                        </svg>
                        <span>Density</span>
                    </button>
                    <button class="ribbon-btn" onclick="openGraphDialog('timeseries')">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <polyline points="2 17 7 12 12 15 17 8 22 12"/>
                        </svg>
                        <span>Time Series</span>
                    </button>
                    <button class="ribbon-btn" onclick="openGraphDialog('violin')">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M12 3 Q8 8 8 12 Q8 16 12 21 Q16 16 16 12 Q16 8 12 3Z"/>
                            <line x1="8" y1="12" x2="16" y2="12"/>
                        </svg>
                        <span>Violin</span>
                    </button>
                    <button class="ribbon-btn" onclick="openGraphDialog('bar')">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="14" width="4" height="6"/><rect x="10" y="8" width="4" height="12"/><rect x="17" y="4" width="4" height="16"/>
                        </svg>
                        <span>Bar</span>
                    </button>
                    <button class="ribbon-btn" onclick="openGraphDialog('heatmap')">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="3" width="6" height="6" rx="1"/><rect x="9" y="3" width="6" height="6" rx="1"/><rect x="15" y="3" width="6" height="6" rx="1"/>
                            <rect x="3" y="9" width="6" height="6" rx="1"/><rect x="9" y="9" width="6" height="6" rx="1"/><rect x="15" y="9" width="6" height="6" rx="1"/>
                            <rect x="3" y="15" width="6" height="6" rx="1"/><rect x="9" y="15" width="6" height="6" rx="1"/><rect x="15" y="15" width="6" height="6" rx="1"/>
                        </svg>
                        <span>Heatmap</span>
                    </button>
                    <button class="ribbon-btn" onclick="openGraphDialog('bubble')">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="7" cy="16" r="3"/><circle cx="14" cy="9" r="4.5"/><circle cx="19" cy="17" r="2"/>
                        </svg>
                        <span>Bubble</span>
                    </button>
                </div>
            </div>
            <div class="ribbon-divider"></div>
            <div class="ribbon-group">
                <div class="ribbon-group-label">View</div>
                <div class="ribbon-buttons">
                    <button class="ribbon-btn" onclick="viewDataTable()">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <line x1="3" y1="9" x2="21" y2="9"/>
                            <line x1="3" y1="15" x2="21" y2="15"/>
                            <line x1="9" y1="3" x2="9" y2="21"/>
                        </svg>
                        <span>Table</span>
                    </button>
                    <button class="ribbon-btn" onclick="runSummary()">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <line x1="18" y1="20" x2="18" y2="10"/>
                            <line x1="12" y1="20" x2="12" y2="4"/>
                            <line x1="6" y1="20" x2="6" y2="14"/>
                        </svg>
                        <span>Summary</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Prepare Tab -->
        <div class="ribbon-content" id="ribbon-prepare" style="flex-wrap:nowrap; overflow-x:auto;">
            <div class="ribbon-group">
                <div class="ribbon-group-label">Clean</div>
                <div class="ribbon-buttons" style="gap:0.15rem;">
                    <button class="ribbon-btn" onclick="openTriagePanel()" title="Auto-scan & fix data issues">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                        <span>Triage</span>
                    </button>
                    <button class="ribbon-btn" onclick="openProfileDialog()" title="Comprehensive dataset overview">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="3" x2="9" y2="21"/>
                            <circle cx="15" cy="15" r="3" opacity="0.5"/>
                        </svg>
                        <span>Profile</span>
                    </button>
                    <button class="ribbon-btn" onclick="openMissingDialog()" title="Missing data patterns & MCAR test">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <line x1="8" y1="8" x2="16" y2="16" stroke-dasharray="3,3"/>
                            <line x1="16" y1="8" x2="8" y2="16" stroke-dasharray="3,3"/>
                        </svg>
                        <span>Missing</span>
                    </button>
                    <button class="ribbon-btn" onclick="openDuplicateDialog()" title="Find duplicate rows">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="9" y="9" width="13" height="13" rx="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                        <span>Duplicates</span>
                    </button>
                </div>
            </div>
            <div class="ribbon-divider"></div>
            <div class="ribbon-group">
                <div class="ribbon-group-label">Detect</div>
                <div class="ribbon-buttons" style="gap:0.15rem;">
                    <button class="ribbon-btn" onclick="openOutlierDialog()" title="Multi-method outlier detection (IQR, Z-score, MAD, Mahalanobis)">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="6" cy="16" r="1.5"/><circle cx="10" cy="13" r="1.5"/><circle cx="14" cy="15" r="1.5"/><circle cx="18" cy="14" r="1.5"/>
                            <circle cx="16" cy="5" r="2.5" fill="rgba(232,71,71,0.3)" stroke="#e84747"/>
                            <line x1="3" y1="20" x2="21" y2="20" opacity="0.3"/>
                        </svg>
                        <span>Outliers</span>
                    </button>
                </div>
            </div>
            <div class="ribbon-divider"></div>
            <div class="ribbon-group">
                <div class="ribbon-group-label">Transform</div>
                <div class="ribbon-buttons" style="gap:0.15rem;">
                    <button class="ribbon-btn" onclick="openEncodeDialog()" title="One-hot or label encoding for categorical variables">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M4 6h4m-4 6h4m-4 6h4"/><path d="M12 4v16" opacity="0.3"/>
                            <rect x="16" y="5" width="2" height="2" fill="currentColor"/><rect x="19" y="5" width="2" height="2" opacity="0.3"/>
                            <rect x="16" y="11" width="2" height="2" opacity="0.3"/><rect x="19" y="11" width="2" height="2" fill="currentColor"/>
                            <rect x="16" y="17" width="2" height="2" fill="currentColor"/><rect x="19" y="17" width="2" height="2" opacity="0.3"/>
                        </svg>
                        <span>Encode</span>
                    </button>
                    <button class="ribbon-btn" onclick="openScaleDialog()" title="Z-score, Min-Max, or Robust scaling">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <line x1="3" y1="20" x2="21" y2="20" opacity="0.3"/><line x1="3" y1="4" x2="3" y2="20"/>
                            <path d="M5 16 Q9 14 12 12 Q15 10 19 8"/>
                            <path d="M5 18 Q9 6 12 12 Q15 4 19 10" opacity="0.3" stroke-dasharray="2,2"/>
                        </svg>
                        <span>Scale</span>
                    </button>
                    <button class="ribbon-btn" onclick="openBinDialog()" title="Equal-width, equal-frequency, or custom binning">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="14" width="5" height="6" fill="rgba(74,159,110,0.3)"/>
                            <rect x="9.5" y="8" width="5" height="12" fill="rgba(74,144,217,0.3)"/>
                            <rect x="16" y="11" width="5" height="9" fill="rgba(232,149,71,0.3)"/>
                            <line x1="3" y1="20" x2="21" y2="20" opacity="0.3"/>
                        </svg>
                        <span>Bin</span>
                    </button>
                </div>
            </div>
            <div class="ribbon-divider"></div>
            <div class="ribbon-group">
                <div class="ribbon-group-label">Meta-Analysis</div>
                <div class="ribbon-buttons" style="gap:0.15rem;">
                    <button class="ribbon-btn" onclick="openMetaDialog()" title="Fixed/Random effects meta-analysis with forest & funnel plots">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <line x1="12" y1="3" x2="12" y2="21" opacity="0.3"/>
                            <line x1="6" y1="6" x2="18" y2="6"/><circle cx="13" cy="6" r="1.5" fill="currentColor"/>
                            <line x1="4" y1="10" x2="16" y2="10"/><circle cx="10" cy="10" r="1.5" fill="currentColor"/>
                            <line x1="8" y1="14" x2="20" y2="14"/><circle cx="15" cy="14" r="1.5" fill="currentColor"/>
                            <path d="M10 18l2 2 2-2 -2-2z" fill="currentColor"/>
                        </svg>
                        <span>Meta</span>
                    </button>
                    <button class="ribbon-btn" onclick="openEffectSizeDialog()" title="Cohen's d, Hedges' g, Odds Ratio, Risk Ratio calculator">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="8" cy="12" r="4" fill="rgba(74,144,217,0.2)"/>
                            <circle cx="16" cy="12" r="4" fill="rgba(232,149,71,0.2)"/>
                            <line x1="12" y1="6" x2="12" y2="18" stroke-dasharray="2,2" opacity="0.5"/>
                            <path d="M4 20h16" opacity="0.3"/>
                        </svg>
                        <span>Effect Size</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Analysis Tab -->
        <div class="ribbon-content" id="ribbon-analysis" style="flex-wrap:nowrap; overflow-x:auto;">
            <div class="ribbon-group">
                <div class="ribbon-group-label">Control Charts</div>
                <div style="display:flex; flex-direction:column; gap:0;">
                    <div class="ribbon-buttons" style="gap:0.15rem;">
                        <button class="ribbon-btn" onclick="openSPCDialog('I-MR')" title="Individuals & Moving Range">
                            <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="2 17 7 12 12 15 17 8 22 12"/><line x1="2" y1="6" x2="22" y2="6" stroke-dasharray="2,2" opacity="0.5"/><line x1="2" y1="18" x2="22" y2="18" stroke-dasharray="2,2" opacity="0.5"/></svg>
                            <span>I-MR</span>
                        </button>
                        <button class="ribbon-btn" onclick="openSPCDialog('X-bar R')" title="X-bar & Range">
                            <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/><line x1="2" y1="6" x2="22" y2="6" stroke-dasharray="2,2" opacity="0.5"/><line x1="2" y1="18" x2="22" y2="18" stroke-dasharray="2,2" opacity="0.5"/></svg>
                            <span>X&#x304;R</span>
                        </button>
                        <button class="ribbon-btn" onclick="openSPCExtDialog('xbar_s')" title="X-bar & Std Dev">
                            <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="2 16 7 11 12 14 17 7 22 11"/><line x1="2" y1="5" x2="22" y2="5" stroke-dasharray="2,2" opacity="0.4"/><line x1="2" y1="19" x2="22" y2="19" stroke-dasharray="2,2" opacity="0.4"/></svg>
                            <span>X&#x304;S</span>
                        </button>
                        <button class="ribbon-btn" onclick="openSPCExtDialog('ewma')" title="Exponentially Weighted Moving Average">
                            <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 16 Q7 14 9 12 Q11 10 14 10 Q17 10 19 8 Q21 6 22 6"/><line x1="2" y1="6" x2="22" y2="6" stroke-dasharray="2,2" opacity="0.4"/><line x1="2" y1="18" x2="22" y2="18" stroke-dasharray="2,2" opacity="0.4"/></svg>
                            <span>EWMA</span>
                        </button>
                        <button class="ribbon-btn" onclick="openSPCExtDialog('cusum')" title="Cumulative Sum">
                            <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="2 12 6 11 10 9 14 6 18 8 22 12"/><polyline points="2 12 6 13 10 15 14 18 18 16 22 12" opacity="0.5"/></svg>
                            <span>CUSUM</span>
                        </button>
                        <button class="ribbon-btn" onclick="openSPCExtDialog('moving_average')" title="Moving Average Chart">
                            <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="2 16 5 14 8 15 11 12 14 13 17 10 20 11 22 9" opacity="0.3" stroke-dasharray="2,2"/><path d="M2 15 Q7 13 12 12 Q17 11 22 10" stroke-width="2.5"/></svg>
                            <span>MA</span>
                        </button>
                        <button class="ribbon-btn" onclick="openSPCExtDialog('zone_chart')" title="Zone Chart (Western Electric zones)">
                            <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="9" width="20" height="6" fill="rgba(74,159,110,0.2)" stroke="none"/><rect x="2" y="5" width="20" height="4" fill="rgba(243,156,18,0.2)" stroke="none"/><rect x="2" y="15" width="20" height="4" fill="rgba(243,156,18,0.2)" stroke="none"/><polyline points="3 14 7 10 11 13 15 8 19 11"/></svg>
                            <span>Zone</span>
                        </button>
                        <button class="ribbon-btn" onclick="openSPCExtDialog('mewma')" title="Multivariate EWMA">
                            <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 16 Q7 14 12 10 Q17 6 22 4"/><line x1="2" y1="6" x2="22" y2="6" stroke-dasharray="2,2" opacity="0.4"/><circle cx="15" cy="5" r="2" fill="#e74c3c" opacity="0.6"/></svg>
                            <span>MEWMA</span>
                        </button>
                    </div>
                    <div class="ribbon-buttons" style="gap:0.15rem;">
                        <button class="ribbon-btn" onclick="openSPCDialog('p')" title="P Chart (proportion defective)"><svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="5" cy="10" r="1.5"/><circle cx="9" cy="14" r="1.5"/><circle cx="13" cy="11" r="1.5"/><circle cx="17" cy="15" r="1.5"/><line x1="2" y1="12" x2="22" y2="12" opacity="0.3"/></svg><span>P</span></button>
                        <button class="ribbon-btn" onclick="openSPCExtDialog('np_chart')" title="NP Chart (count defective)"><svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="4" y="11" width="3" height="7" rx="0.5"/><rect x="9" y="8" width="3" height="10" rx="0.5"/><rect x="14" y="13" width="3" height="5" rx="0.5"/><line x1="2" y1="12" x2="22" y2="12" opacity="0.3"/></svg><span>NP</span></button>
                        <button class="ribbon-btn" onclick="openSPCDialog('c')" title="C Chart (count defects)"><svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="10" width="3" height="8" rx="0.5" opacity="0.6"/><rect x="8" y="13" width="3" height="5" rx="0.5" opacity="0.6"/><rect x="13" y="8" width="3" height="10" rx="0.5" opacity="0.6"/><line x1="2" y1="12" x2="22" y2="12" opacity="0.3"/></svg><span>C</span></button>
                        <button class="ribbon-btn" onclick="openSPCExtDialog('u_chart')" title="U Chart (rate defects)"><svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="5" cy="14" r="1.5"/><circle cx="9" cy="10" r="1.5"/><circle cx="13" cy="16" r="1.5"/><circle cx="17" cy="11" r="1.5"/><line x1="2" y1="8" x2="22" y2="8" stroke-dasharray="2,2" opacity="0.4"/></svg><span>U</span></button>
                        <button class="ribbon-btn" onclick="openSPCExtDialog('laney_p')" title="Laney P' (overdispersion-corrected)"><svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="3 18 7 14 11 16 15 10 19 13"/><line x1="3" y1="6" x2="19" y2="6" stroke-dasharray="2,2" opacity="0.4"/></svg><span>P'</span></button>
                        <button class="ribbon-btn" onclick="openSPCExtDialog('laney_u')" title="Laney U' (overdispersion-corrected)"><svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="3 16 7 12 11 15 15 9 19 11"/><line x1="3" y1="5" x2="19" y2="5" stroke-dasharray="2,2" opacity="0.4"/></svg><span>U'</span></button>
                    </div>
                </div>
            </div>
            <div class="ribbon-divider"></div>
            <div class="ribbon-group">
                <div class="ribbon-group-label">Quality</div>
                <div style="display:flex; flex-direction:column; gap:0;">
                    <div class="ribbon-buttons" style="gap:0.15rem;">
                        <button class="ribbon-btn" onclick="openCapabilityDialog()" title="Process Capability (Cp/Cpk/Pp/Ppk)"><svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/><ellipse cx="12" cy="6" rx="4" ry="2"/></svg><span>Cp/Cpk</span></button>
                        <button class="ribbon-btn" onclick="openSPCExtDialog('between_within')" title="Between/Within Capability"><svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="14" width="4" height="6" fill="rgba(74,159,110,0.4)"/><rect x="10" y="10" width="4" height="10" fill="rgba(74,144,217,0.4)"/><rect x="17" y="6" width="4" height="14" fill="rgba(232,149,71,0.4)"/></svg><span>B/W</span></button>
                        <button class="ribbon-btn" onclick="openNonNormalCapDialog()" title="Non-Normal Capability"><svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 20 Q6 18 9 12 Q11 6 14 4 Q18 3 21 8"/><line x1="3" y1="20" x2="21" y2="20" opacity="0.3"/></svg><span>NN Cap</span></button>
                    </div>
                    <div class="ribbon-buttons" style="gap:0.15rem;">
                        <button class="ribbon-btn" onclick="openGageRRDialog()" title="Gage Repeatability & Reproducibility"><svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="8"/><path d="M12 8v4l3 1.5"/></svg><span>Gage R&R</span></button>
                        <button class="ribbon-btn" onclick="openStatsDialog('acceptance')" title="Acceptance Sampling Plans"><svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 12l2 2 4-4"/></svg><span>Sampling</span></button>
                    </div>
                </div>
            </div>
            <div class="ribbon-divider"></div>
            <div class="ribbon-group">
                <div class="ribbon-group-label">Reliability</div>
                <div style="display:flex; flex-direction:column; gap:0;">
                    <div class="ribbon-buttons" style="gap:0.15rem;">
                        <button class="ribbon-btn" onclick="openReliabilityDialog('weibull')" title="Weibull Analysis"><svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 20 Q8 18 12 10 Q16 2 21 2"/><line x1="3" y1="20" x2="21" y2="20" opacity="0.3"/></svg><span>Weibull</span></button>
                        <button class="ribbon-btn" onclick="openReliabilityDialog('distribution_id')" title="Distribution Identification (6 distributions)"><svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 20 Q7 18 10 10 Q13 3 16 3 Q19 3 21 8" opacity="0.5"/><path d="M3 20 Q8 16 12 8 Q15 2 21 2"/><circle cx="10" cy="10" r="1.5"/><circle cx="15" cy="4" r="1.5"/></svg><span>Dist ID</span></button>
                        <button class="ribbon-btn" onclick="openReliabilityDialog('kaplan_meier')" title="Kaplan-Meier Survival Curve"><svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="3 4 3 8 8 8 8 12 13 12 13 16 18 16 18 20 21 20"/></svg><span>K-M</span></button>
                        <button class="ribbon-btn" onclick="openReliabilityDialog('competing_risks')" title="Competing Risks (CIF)"><svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 20 Q8 16 12 8 Q14 4 17 3" stroke="#4a90d9"/><path d="M3 20 Q10 18 14 14 Q18 10 21 8" stroke="#d94a4a"/></svg><span>CIF</span></button>
                    </div>
                    <div class="ribbon-buttons" style="gap:0.15rem;">
                        <button class="ribbon-btn" onclick="openReliabilityDialog('accelerated_life')" title="Accelerated Life Testing"><svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 18 L10 12 L16 8 L20 4"/><circle cx="20" cy="4" r="2"/></svg><span>ALT</span></button>
                        <button class="ribbon-btn" onclick="openReliabilityDialog('repairable_systems')" title="Repairable Systems (Crow-AMSAA)"><svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="3 18 6 16 9 14 12 11 15 10 18 7 21 5"/><path d="M17 3l4 2-2 4" opacity="0.6"/></svg><span>Repair</span></button>
                        <button class="ribbon-btn" onclick="openReliabilityDialog('warranty')" title="Warranty Prediction"><svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 3l8 4v5c0 5-3 9-8 11C7 21 4 17 4 12V7l8-4z" fill="rgba(74,159,110,0.2)"/><path d="M9 12l2 2 4-4"/></svg><span>Warranty</span></button>
                        <button class="ribbon-btn" onclick="openReliabilityDialog('reliability_test_plan')" title="Reliability Test Planning (sample size)"><svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 10h8M8 14h5"/><path d="M16 17l1 1 2-2"/></svg><span>Plan</span></button>
                    </div>
                </div>
            </div>
            <div class="ribbon-divider"></div>
            <div class="ribbon-group">
                <div class="ribbon-group-label">Modeling</div>
                <div class="ribbon-buttons" style="gap:0.15rem;">
                    <button class="ribbon-btn" onclick="openGLMDialog()" title="General Linear Model (ANOVA/ANCOVA/Mixed)">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="8" width="4" height="12"/><rect x="10" y="4" width="4" height="16"/><rect x="17" y="6" width="4" height="14"/><line x1="2" y1="4" x2="22" y2="4" opacity="0.3" stroke-dasharray="2,2"/></svg>
                        <span>GLM</span>
                    </button>
                    <button class="ribbon-btn" onclick="openStatsDialog('regression')" title="Linear/Polynomial Regression">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="6" cy="18" r="2"/><circle cx="10" cy="14" r="2"/><circle cx="14" cy="10" r="2"/><circle cx="18" cy="6" r="2"/><line x1="4" y1="20" x2="20" y2="4" opacity="0.5"/></svg>
                        <span>Regression</span>
                    </button>
                    <button class="ribbon-btn" onclick="openStatsDialog('anova')" title="One-Way / Two-Way ANOVA">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="14" width="4" height="6"/><rect x="10" y="8" width="4" height="12"/><rect x="17" y="4" width="4" height="16"/></svg>
                        <span>ANOVA</span>
                    </button>
                    <button class="ribbon-btn" onclick="openStatsDialog('ttest')" title="1-Sample, 2-Sample, Paired t-Test">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 3h6v2H9zM12 5v14M7 19h10"/><circle cx="12" cy="12" r="3"/></svg>
                        <span>t-Test</span>
                    </button>
                </div>
            </div>
            <div class="ribbon-divider"></div>
            <div class="ribbon-group">
                <div class="ribbon-group-label">Advanced</div>
                <div class="ribbon-buttons" style="gap:0.15rem;">
                    <button class="ribbon-btn" onclick="openStatsDialog('more_nonparam')" title="Mann-Whitney, Kruskal-Wallis, Sign Test, Mood's...">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 20l4-8 4 5 4-10 4 6"/><circle cx="4" cy="20" r="1.5"/><circle cx="8" cy="12" r="1.5"/><circle cx="12" cy="17" r="1.5"/><circle cx="16" cy="7" r="1.5"/><circle cx="20" cy="13" r="1.5"/></svg>
                        <span>Non-Param</span>
                    </button>
                    <button class="ribbon-btn" onclick="openStatsDialog('more_posthoc')" title="Tukey HSD, Games-Howell, Dunnett, Dunn">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="14" width="3" height="6"/><rect x="7" y="10" width="3" height="10"/><rect x="12" y="6" width="3" height="14"/><rect x="17" y="14" width="3" height="6"/><line x1="2" y1="12" x2="22" y2="12" stroke-dasharray="1,2" opacity="0.4"/></svg>
                        <span>Post-Hoc</span>
                    </button>
                    <button class="ribbon-btn" onclick="openStatsDialog('more_multivar')" title="MANOVA, Hotelling's TÂ², Nested ANOVA, Ordinal Logistic...">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="12" rx="9" ry="5" transform="rotate(-30 12 12)" opacity="0.4"/><ellipse cx="12" cy="12" rx="9" ry="5" transform="rotate(30 12 12)" opacity="0.4"/><circle cx="8" cy="10" r="1.5"/><circle cx="14" cy="8" r="1.5"/><circle cx="16" cy="14" r="1.5"/><circle cx="10" cy="15" r="1.5"/></svg>
                        <span>Multivar</span>
                    </button>
                    <button class="ribbon-btn" onclick="openStatsDialog('more_survival')" title="Kaplan-Meier, Cox Proportional Hazards">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 4h4v4H3zM7 8h5v4H7zM12 12h4v4h-4zM16 16h5v5h-5z" opacity="0.3"/><polyline points="3 4 7 4 7 8 12 8 12 12 16 12 16 16 21 16 21 21"/></svg>
                        <span>Survival</span>
                    </button>
                    <button class="ribbon-btn" onclick="openStatsDialog('more_diag')" title="Normality, Runs Test, Bootstrap CI, Tolerance Interval, Box-Cox">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 12c0-5 4-9 9-9s9 4 9 9"/><path d="M12 12l-3-6" stroke-width="2"/><circle cx="12" cy="12" r="1.5"/><path d="M5 19h14" opacity="0.4"/></svg>
                        <span>Diagnostics</span>
                    </button>
                    <button class="ribbon-btn" onclick="openFactorAnalysisDialog()" title="Exploratory Factor Analysis (varimax rotation)">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="6" cy="8" r="2"/><circle cx="6" cy="16" r="2"/><circle cx="18" cy="8" r="2"/><circle cx="18" cy="16" r="2"/><line x1="8" y1="8" x2="16" y2="8" opacity="0.4"/><line x1="8" y1="16" x2="16" y2="16" opacity="0.4"/><line x1="8" y1="8" x2="16" y2="16" opacity="0.2"/></svg>
                        <span>Factor</span>
                    </button>
                </div>
            </div>
            <div class="ribbon-divider"></div>
            <div class="ribbon-group">
                <div class="ribbon-group-label">&nbsp;</div>
                <div class="ribbon-buttons">
                    <button class="ribbon-btn ribbon-btn-lg" onclick="openStatsDialog('more')" title="Browse all 120+ statistical tests" style="min-height:3.2rem;">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/>
                            <rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/>
                        </svg>
                        <span>All Tests</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Experiment Tab -->
        <div class="ribbon-content" id="ribbon-experiment">
            <div class="ribbon-group">
                <div class="ribbon-group-label">Create Design</div>
                <div class="ribbon-buttons">
                    <button class="ribbon-btn ribbon-btn-lg" onclick="openDOEDialog('full_factorial')">
                        <svg class="ribbon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                            <rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/>
                        </svg>
                        <span>Full Factorial</span>
                    </button>
                    <button class="ribbon-btn ribbon-btn-lg" onclick="openDOEDialog('fractional_factorial')">
                        <svg class="ribbon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/>
                            <rect x="3" y="14" width="7" height="7" opacity="0.3"/><rect x="14" y="3" width="7" height="7" opacity="0.3"/>
                        </svg>
                        <span>Fractional</span>
                    </button>
                    <button class="ribbon-btn ribbon-btn-lg" onclick="openDOEDialog('plackett_burman')">
                        <svg class="ribbon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="3" width="18" height="4" rx="1"/><rect x="3" y="10" width="12" height="4" rx="1" opacity="0.6"/>
                            <rect x="3" y="17" width="6" height="4" rx="1" opacity="0.3"/>
                        </svg>
                        <span>Screening</span>
                    </button>
                    <button class="ribbon-btn ribbon-btn-lg" onclick="openDOEDialog('ccd')">
                        <svg class="ribbon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <ellipse cx="12" cy="12" rx="9" ry="4"/><ellipse cx="12" cy="12" rx="6" ry="2.5"/><ellipse cx="12" cy="12" rx="3" ry="1"/>
                        </svg>
                        <span>Response Surface</span>
                    </button>
                    <button class="ribbon-btn" onclick="openDOEDialog('all')">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/>
                        </svg>
                        <span>More...</span>
                    </button>
                </div>
            </div>
            <div class="ribbon-divider"></div>
            <div class="ribbon-group">
                <div class="ribbon-group-label">Analyze DOE</div>
                <div class="ribbon-buttons">
                    <button class="ribbon-btn" onclick="openDOEAnalysisDialog('main_effects')">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <polyline points="4,18 8,10 12,14 16,6 20,12"/>
                        </svg>
                        <span>Main Effects</span>
                    </button>
                    <button class="ribbon-btn" onclick="openDOEAnalysisDialog('interaction')">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <polyline points="4,16 12,6 20,16"/><polyline points="4,8 12,18 20,8" opacity="0.5"/>
                        </svg>
                        <span>Interaction</span>
                    </button>
                    <button class="ribbon-btn" onclick="openDOEContourDialog()">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <ellipse cx="12" cy="12" rx="8" ry="8"/><ellipse cx="11" cy="11" rx="5" ry="5"/><ellipse cx="10" cy="10" rx="2" ry="2"/>
                        </svg>
                        <span>Contour</span>
                    </button>
                    <button class="ribbon-btn" onclick="openDOEOptimizeDialog()">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5" opacity="0.5"/><path d="M2 12l10 5 10-5" opacity="0.3"/>
                        </svg>
                        <span>Optimize</span>
                    </button>
                </div>
            </div>
            <div class="ribbon-divider"></div>
            <div class="ribbon-group">
                <div class="ribbon-group-label">Power</div>
                <div class="ribbon-buttons">
                    <button class="ribbon-btn ribbon-btn-lg" onclick="openPowerDialog()">
                        <svg class="ribbon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        <span>Sample Size</span>
                    </button>
                </div>
            </div>
            <div class="ribbon-divider"></div>
            <div class="ribbon-group">
                <div class="ribbon-group-label">Assistant</div>
                <div class="ribbon-buttons">
                    <button class="ribbon-btn" onclick="openDOEChatDialog()">
                        <svg class="ribbon-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                        <span>DOE Guide</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- ML Tab -->
        <div class="ribbon-content" id="ribbon-ml">
            <div class="ribbon-group">
                <div class="ribbon-group-label">Predict</div>
                <div class="ribbon-buttons">
                    <button class="ribbon-btn ribbon-btn-lg" onclick="openMLStatsDialog('classification')">
                        <svg class="ribbon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="12" cy="4" r="2"/><circle cx="6" cy="12" r="2"/><circle cx="18" cy="12" r="2"/>
                            <line x1="12" y1="6" x2="6" y2="10"/><line x1="12" y1="6" x2="18" y2="10"/>
                            <circle cx="3" cy="20" r="1.5" fill="currentColor" opacity="0.4"/><circle cx="9" cy="20" r="1.5" fill="currentColor" opacity="0.4"/>
                            <circle cx="15" cy="20" r="1.5" fill="currentColor" opacity="0.7"/><circle cx="21" cy="20" r="1.5" fill="currentColor" opacity="0.7"/>
                            <line x1="6" y1="14" x2="3" y2="18.5"/><line x1="6" y1="14" x2="9" y2="18.5"/>
                            <line x1="18" y1="14" x2="15" y2="18.5"/><line x1="18" y1="14" x2="21" y2="18.5"/>
                        </svg>
                        <span>Classify</span>
                    </button>
                    <button class="ribbon-btn ribbon-btn-lg" onclick="openMLStatsDialog('regression_ml')">
                        <svg class="ribbon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="4" cy="18" r="1.5" opacity="0.5"/><circle cx="7" cy="15" r="1.5" opacity="0.5"/>
                            <circle cx="10" cy="13" r="1.5" opacity="0.5"/><circle cx="14" cy="10" r="1.5" opacity="0.5"/>
                            <circle cx="17" cy="8" r="1.5" opacity="0.5"/><circle cx="20" cy="5" r="1.5" opacity="0.5"/>
                            <line x1="3" y1="19" x2="21" y2="4" opacity="0.8"/>
                        </svg>
                        <span>Regression</span>
                    </button>
                    <button class="ribbon-btn ribbon-btn-lg" onclick="openMLStatsDialog('gaussian_process')">
                        <svg class="ribbon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M2 16 Q7 6 12 12 Q17 18 22 8" stroke-width="2"/>
                            <path d="M2 14 Q7 2 12 12 Q17 22 22 6" stroke-dasharray="2,2" opacity="0.3"/>
                            <path d="M2 18 Q7 10 12 12 Q17 14 22 10" stroke-dasharray="2,2" opacity="0.3"/>
                        </svg>
                        <span>GP</span>
                    </button>
                </div>
            </div>
            <div class="ribbon-divider"></div>
            <div class="ribbon-group">
                <div class="ribbon-group-label">Explore</div>
                <div class="ribbon-buttons">
                    <button class="ribbon-btn ribbon-btn-lg" onclick="openMLStatsDialog('pca')">
                        <svg class="ribbon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <line x1="4" y1="20" x2="20" y2="4" stroke-width="2"/>
                            <line x1="4" y1="20" x2="20" y2="16" opacity="0.5"/>
                            <circle cx="8" cy="14" r="1" opacity="0.4"/><circle cx="10" cy="12" r="1" opacity="0.4"/>
                            <circle cx="12" cy="11" r="1" opacity="0.4"/><circle cx="14" cy="9" r="1" opacity="0.4"/>
                            <circle cx="16" cy="8" r="1" opacity="0.4"/><circle cx="11" cy="14" r="1" opacity="0.4"/>
                            <circle cx="13" cy="13" r="1" opacity="0.4"/>
                        </svg>
                        <span>PCA</span>
                    </button>
                    <button class="ribbon-btn ribbon-btn-lg" onclick="openMLStatsDialog('clustering')">
                        <svg class="ribbon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="6" cy="8" r="1.5" fill="currentColor" opacity="0.6"/><circle cx="8" cy="6" r="1.5" fill="currentColor" opacity="0.6"/>
                            <circle cx="5" cy="5" r="1.5" fill="currentColor" opacity="0.6"/>
                            <circle cx="17" cy="7" r="1.5" fill="currentColor" opacity="0.4"/><circle cx="19" cy="9" r="1.5" fill="currentColor" opacity="0.4"/>
                            <circle cx="20" cy="6" r="1.5" fill="currentColor" opacity="0.4"/>
                            <circle cx="10" cy="18" r="1.5" fill="currentColor" opacity="0.5"/><circle cx="13" cy="17" r="1.5" fill="currentColor" opacity="0.5"/>
                            <circle cx="11" cy="20" r="1.5" fill="currentColor" opacity="0.5"/>
                        </svg>
                        <span>Clustering</span>
                    </button>
                    <button class="ribbon-btn ribbon-btn-lg" onclick="openMLStatsDialog('isolation_forest')">
                        <svg class="ribbon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="10" cy="13" r="1.5" opacity="0.4"/><circle cx="12" cy="11" r="1.5" opacity="0.4"/>
                            <circle cx="14" cy="14" r="1.5" opacity="0.4"/><circle cx="11" cy="15" r="1.5" opacity="0.4"/>
                            <circle cx="13" cy="12" r="1.5" opacity="0.4"/>
                            <circle cx="20" cy="5" r="2" stroke-width="2"/><line x1="18.5" y1="3.5" x2="21.5" y2="6.5"/><line x1="21.5" y1="3.5" x2="18.5" y2="6.5"/>
                        </svg>
                        <span>Anomaly</span>
                    </button>
                    <button class="ribbon-btn ribbon-btn-lg" onclick="openMLStatsDialog('feature')">
                        <svg class="ribbon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="2" y="4" width="18" height="3" rx="1" fill="currentColor" opacity="0.7"/>
                            <rect x="2" y="10" width="13" height="3" rx="1" fill="currentColor" opacity="0.5"/>
                            <rect x="2" y="16" width="8" height="3" rx="1" fill="currentColor" opacity="0.3"/>
                        </svg>
                        <span>Importance</span>
                    </button>
                </div>
            </div>
            <div class="ribbon-divider"></div>
            <div class="ribbon-group">
                <div class="ribbon-group-label">Advanced</div>
                <div class="ribbon-buttons">
                    <button class="ribbon-btn ribbon-btn-lg" onclick="openMLStatsDialog('gam')">
                        <svg class="ribbon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M2 18 C6 18 6 6 10 6 S14 18 18 18 S22 6 22 6" stroke-width="2"/>
                        </svg>
                        <span>GAM</span>
                    </button>
                    <button class="ribbon-btn ribbon-btn-lg" onclick="openMLStatsDialog('bayesian_regression')">
                        <svg class="ribbon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M2 20 Q6 20 8 12 Q10 4 12 4 Q14 4 16 12 Q18 20 22 20" opacity="0.3" fill="currentColor"/>
                            <path d="M2 20 Q6 20 8 12 Q10 4 12 4 Q14 4 16 12 Q18 20 22 20"/>
                            <path d="M5 20 Q8 20 9.5 14 Q11 8 12 8 Q13 8 14.5 14 Q16 20 19 20" stroke-dasharray="3,2" opacity="0.6"/>
                        </svg>
                        <span>Bayesian</span>
                    </button>
                    <button class="ribbon-btn ribbon-btn-lg" onclick="openMLStatsDialog('pls')">
                        <svg class="ribbon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="2" y="6" width="6" height="12" rx="1"/><rect x="16" y="6" width="6" height="12" rx="1"/>
                            <path d="M8 10 L16 8" marker-end="none"/><path d="M8 14 L16 12"/>
                            <path d="M8 12 L16 16"/>
                        </svg>
                        <span>PLS</span>
                    </button>
                    <button class="ribbon-btn ribbon-btn-lg" onclick="openMLStatsDialog('sem')">
                        <svg class="ribbon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="6" cy="6" r="3"/><circle cx="18" cy="6" r="3"/><circle cx="12" cy="18" r="3"/>
                            <line x1="9" y1="6" x2="15" y2="6"/><line x1="7.5" y1="8.5" x2="10.5" y2="15.5"/>
                            <line x1="16.5" y1="8.5" x2="13.5" y2="15.5"/>
                        </svg>
                        <span>SEM</span>
                    </button>
                </div>
            </div>
            <div class="ribbon-divider"></div>
            <div class="ribbon-group">
                <div class="ribbon-group-label">Auto ML</div>
                <div class="ribbon-buttons">
                    <button class="ribbon-btn ribbon-btn-lg" onclick="openMLDialog('intent')">
                        <svg class="ribbon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 1 1 7.072 0l-.548.547A3.374 3.374 0 0 0 14 18.469V19a2 2 0 1 1-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                        </svg>
                        <span>From Intent</span>
                    </button>
                    <button class="ribbon-btn ribbon-btn-lg" onclick="openMLDialog('data')">
                        <svg class="ribbon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M4 16l4.586-4.586a2 2 0 0 1 2.828 0L16 16m-2-2l1.586-1.586a2 2 0 0 1 2.828 0L20 14"/>
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                        </svg>
                        <span>From Data</span>
                    </button>
                </div>
            </div>
            <div class="ribbon-divider"></div>
            <div class="ribbon-group">
                <div class="ribbon-group-label">Time Series</div>
                <div class="ribbon-buttons">
                    <button class="ribbon-btn ribbon-btn-lg" onclick="window.open('/app/forecast/','_blank')">
                        <svg class="ribbon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <polyline points="2 17 8 11 12 15 16 9"/>
                            <polyline points="16 9 22 5" stroke-dasharray="2,2"/>
                            <polyline points="16 9 16 4 M16 4 21 4" opacity="0.4"/>
                        </svg>
                        <span>Forecast</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Thinking and Process tabs removed â use Methods (A3, DMAIC, etc.) and Whiteboard instead -->
    </div>

    <!-- Template Phase Bar -->
    <div class="wb-phase-bar" id="phase-bar" style="display: none;">
        <div class="phase-pills" id="phase-pills"></div>
        <button class="wb-btn wb-btn-sm" onclick="advancePhase()">Advance Phase</button>
    </div>

    <!-- ============================================================ -->
    <!-- MAIN LAYOUT: Output on top, Data table below (Minitab-style) -->
    <!-- ============================================================ -->
    <div class="wb-main">
        <!-- Output Panel with Tabs -->
        <div class="wb-output" id="output-panel">
            <div class="output-tab-bar" id="output-tab-bar">
                <div class="output-tabs" id="output-tabs"></div>
                <div class="output-tab-actions">
                    <button class="wb-btn wb-btn-sm" onclick="clearOutput()" title="Close all tabs">Clear All</button>
                </div>
            </div>
            <div class="output-panes" id="output-panes">
                <div class="output-empty" id="output-empty">
                    <div class="empty-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" opacity="0.3">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                        </svg>
                    </div>
                    <div class="empty-text">Import data and run analyses from the ribbon</div>
                    <div class="empty-hint">Results, charts, and diagnostics appear here</div>
                </div>
            </div>
        </div>

        <!-- Resize Handle -->
        <div class="wb-resize-handle" id="resize-handle">
            <div class="resize-grip"></div>
        </div>

        <!-- Data Panel (spreadsheet) -->
        <div class="wb-data" id="data-panel">
            <div class="data-header">
                <div class="data-header-left">
                    <span class="data-title" id="data-title">Worksheet</span>
                    <span class="data-info" id="data-info"></span>
                </div>
                <div class="data-header-right">
                    <select id="column-selector" style="display:none;">
                        <option value="">All columns</option>
                    </select>
                </div>
            </div>
            <div class="data-table-wrapper" id="data-table-wrapper">
                <div class="data-empty" id="data-empty">
                    <span>No data loaded â use Import CSV or Import Excel above</span>
                </div>
                <table class="data-table" id="data-table" style="display:none;">
                    <thead id="data-thead"></thead>
                    <tbody id="data-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <p id="loading-text">Processing...</p>
    </div>

    <!-- AI Assistant Panel (collapsible sidebar) -->
    <div class="ai-assistant-panel" id="ai-panel">
        <div class="ai-panel-header">
            <span class="ai-panel-title">AI Assistant</span>
            <div class="ai-panel-actions">
                <span class="ai-rate-limit" id="ai-rate-limit" title="Requests remaining today">-</span>
                <button class="ai-panel-close" onclick="toggleAIPanel()">&times;</button>
            </div>
        </div>
        <div class="ai-panel-body">
            <div class="ai-messages" id="ai-messages">
                <div class="ai-message ai-message-assistant">
                    <div class="ai-message-content">
                        I can help you analyze your data. Ask me about:
                        <ul>
                            <li>Which statistical test to use</li>
                            <li>Interpreting your results</li>
                            <li>Next steps based on findings</li>
                            <li>Exporting to A3/reports</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="ai-panel-footer">
            <textarea id="ai-input" placeholder="Ask a question about your data or analysis..." rows="2"></textarea>
            <button class="ai-send-btn" onclick="sendAIMessage()" id="ai-send">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
    </div>

    <!-- AI Toggle Button (when panel is closed) -->
    <button class="ai-toggle-btn" id="ai-toggle" onclick="toggleAIPanel()" title="AI Assistant">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>
        </svg>
    </button>
</div>

<!-- Analysis Dialog (modal for configuring analyses) -->
<div class="modal" id="analysis-modal" style="display: none;">
    <div class="modal-backdrop" onclick="closeModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-title" id="modal-title">Analysis</span>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="modal-body"></div>
        <div class="modal-footer">
            <button class="wb-btn" onclick="closeModal()">Cancel</button>
            <button class="wb-btn wb-btn-primary" id="modal-submit" onclick="submitModal()">Run</button>
        </div>
    </div>
</div>

<!-- Workbench List Modal -->
<div class="modal" id="workbench-list-modal" style="display: none;">
    <div class="modal-backdrop" onclick="closeWorkbenchList()"></div>
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <span class="modal-title">Your Workbenches</span>
            <button class="modal-close" onclick="closeWorkbenchList()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="workbench-list" id="workbench-list"></div>
        </div>
        <div class="modal-footer">
            <button class="wb-btn wb-btn-primary" onclick="createNewWorkbench()">New Workbench</button>
        </div>
    </div>
</div>

<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

<style>
/* ================================================================ */
/* WORKBENCH APP LAYOUT                                             */
/* ================================================================ */
.workbench-app {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 60px);
    margin: 0;
    padding: 0;
    position: fixed;
    top: 60px;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg-primary);
}

/* Header */
.wb-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 1.5rem;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
}
.wb-header-left { display: flex; align-items: center; gap: 0.75rem; }
.wb-header-right { display: flex; align-items: center; gap: 0.5rem; }
.wb-project-selector { display: flex; align-items: center; gap: 0.35rem; }
.wb-project-select {
    background: var(--bg-tertiary); border: 1px solid var(--border);
    padding: 0.35rem 0.5rem; font-size: 0.8rem; color: var(--text);
    border-radius: 4px; max-width: 180px; cursor: pointer;
}
.wb-project-select:focus { border-color: var(--accent-primary); outline: none; }
.wb-project-link {
    display: flex; align-items: center; justify-content: center;
    width: 24px; height: 24px; color: var(--text-dim);
    border-radius: 4px; transition: all 0.15s;
}
.wb-project-link:hover { color: var(--accent-primary); background: var(--bg-tertiary); }
.wb-title-group { display: flex; align-items: center; gap: 0.5rem; }
.wb-title-input {
    background: transparent; border: 1px solid transparent;
    padding: 0.4rem 0.6rem; font-size: 1.1rem; font-weight: 500;
    color: var(--text); width: 350px; border-radius: 4px;
}
.wb-title-input:hover, .wb-title-input:focus { border-color: var(--border); background: var(--bg-tertiary); }
.wb-template-select {
    padding: 0.4rem 0.75rem; background: var(--bg-tertiary);
    border: 1px solid var(--border); border-radius: 4px;
    color: var(--text-dim); font-size: 0.8rem;
}
.wb-status {
    padding: 0.25rem 0.75rem; background: var(--accent-primary-dim);
    color: var(--accent); border-radius: 4px; font-size: 0.75rem; font-weight: 500;
}

/* Buttons */
.wb-btn {
    padding: 0.5rem 1rem; background: var(--bg-tertiary); border: 1px solid var(--border);
    border-radius: 4px; color: var(--text); font-size: 0.85rem; cursor: pointer; transition: all 0.15s;
}
.wb-btn:hover { border-color: var(--accent); background: var(--bg-hover); }
.wb-btn-primary { background: var(--accent-primary-dim); border-color: var(--accent); color: var(--accent); }
.wb-btn-primary:hover { background: var(--accent); color: var(--bg); }
.wb-btn-icon { padding: 0.5rem; display: flex; align-items: center; justify-content: center; }
.wb-btn-sm { padding: 0.25rem 0.75rem; font-size: 0.75rem; }

/* Ribbon */
.wb-ribbon { background: var(--bg-secondary); border-bottom: 1px solid var(--border); }
.ribbon-tabs {
    display: flex; gap: 0; border-bottom: 1px solid var(--border);
    padding: 0 1rem; background: var(--bg-tertiary);
}
.ribbon-tab {
    padding: 0.4rem 1rem; background: transparent; border: none;
    border-bottom: 2px solid transparent; color: var(--text-dim);
    font-size: 0.75rem; font-weight: 500; cursor: pointer;
}
.ribbon-tab:hover { color: var(--text); }
.ribbon-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
.ribbon-content { display: none; padding: 0.4rem 1.5rem 0.5rem; }
.ribbon-content.active { display: flex; gap: 0; flex-wrap: wrap; }
.ribbon-group { display: flex; flex-direction: column; padding: 0 0.75rem; }
.ribbon-group-label {
    font-size: 0.6rem; color: var(--text-dim); text-transform: uppercase;
    letter-spacing: 0.03em; text-align: center; padding-top: 0.25rem;
    border-top: 1px solid var(--border); margin-top: 0.25rem;
}
.ribbon-buttons { display: flex; gap: 0.2rem; align-items: flex-start; }
.ribbon-buttons-row { display: flex; gap: 0.2rem; margin-top: 0.2rem; }
.ribbon-buttons-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(44px, 1fr)); gap: 0.15rem; }
.ribbon-buttons-2row { display: flex; flex-wrap: wrap; gap: 0.15rem; max-height: 68px; align-content: flex-start; }
.ribbon-divider { width: 1px; background: var(--border); margin: 0 0.4rem; align-self: stretch; }
.ribbon-btn {
    display: flex; flex-direction: column; align-items: center; gap: 0.15rem;
    padding: 0.3rem 0.4rem; background: transparent; border: 1px solid transparent;
    border-radius: 3px; color: var(--text); font-size: 0.6rem; cursor: pointer; min-width: 44px;
}
.ribbon-btn:hover { background: var(--bg-hover); border-color: var(--border); }
.ribbon-btn-lg { padding: 0.4rem 0.5rem; min-width: 56px; }
.ribbon-btn-sm {
    padding: 0.2rem 0.4rem; font-size: 0.55rem; background: var(--bg-tertiary);
    border: 1px solid var(--border); border-radius: 3px; color: var(--text-dim); cursor: pointer;
}
.ribbon-btn-sm:hover { background: var(--bg-hover); color: var(--text); border-color: var(--accent); }
.ribbon-icon { width: 22px; height: 22px; stroke: var(--accent); }
.ribbon-icon-sm { width: 16px; height: 16px; stroke: var(--accent); }

/* Phase Bar */
.wb-phase-bar {
    display: flex; align-items: center; justify-content: space-between;
    padding: 0.5rem 1.5rem; background: rgba(99, 102, 241, 0.1);
    border-bottom: 1px solid rgba(99, 102, 241, 0.3);
}
.phase-pills { display: flex; gap: 0.5rem; }
.phase-pill {
    padding: 0.35rem 1rem; background: var(--bg-tertiary); border: 1px solid var(--border);
    border-radius: 16px; font-size: 0.75rem; color: var(--text-dim); cursor: pointer;
}
.phase-pill.active { background: var(--accent-primary-dim); border-color: var(--accent); color: var(--accent); }
.phase-pill.completed { background: rgba(74, 200, 110, 0.15); border-color: rgba(74, 200, 110, 0.5); color: #4ac86e; }

/* ================================================================ */
/* MAIN LAYOUT: Output top, Data bottom                             */
/* ================================================================ */
.wb-main {
    display: flex;
    flex-direction: column;
    flex: 1;
    overflow: hidden;
}

/* Output Panel â Tabbed */
.wb-output {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 200px;
    overflow: hidden;
}
.output-tab-bar {
    display: flex; align-items: center; justify-content: space-between;
    background: var(--bg-tertiary); border-bottom: 1px solid var(--border);
    flex-shrink: 0; min-height: 32px;
}
.output-tabs {
    display: flex; overflow-x: auto; flex: 1; gap: 0;
    scrollbar-width: none;
}
.output-tabs::-webkit-scrollbar { display: none; }
.output-tab {
    display: flex; align-items: center; gap: 0.4rem;
    padding: 0.35rem 0.75rem; background: transparent; border: none;
    border-bottom: 2px solid transparent; border-right: 1px solid var(--border);
    color: var(--text-dim); font-size: 0.7rem; cursor: pointer;
    white-space: nowrap; flex-shrink: 0;
}
.output-tab:hover { background: var(--bg-hover); color: var(--text); }
.output-tab.active { color: var(--accent); border-bottom-color: var(--accent); background: var(--bg-secondary); }
.output-tab .tab-close {
    display: inline-flex; align-items: center; justify-content: center;
    width: 14px; height: 14px; border-radius: 2px; font-size: 10px;
    opacity: 0.5; cursor: pointer; line-height: 1;
}
.output-tab .tab-close:hover { opacity: 1; background: var(--error-dim); }
.output-tab-actions { padding: 0 0.5rem; flex-shrink: 0; }
.output-panes { flex: 1; overflow: hidden; position: relative; }
.output-pane {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    overflow-y: auto; padding: 1rem 1.5rem;
    display: none;
}
.output-pane.active { display: block; }
.output-empty {
    display: flex; flex-direction: column; align-items: center;
    justify-content: center; height: 100%; color: var(--text-dim); text-align: center;
}
.output-empty .empty-text { font-size: 0.95rem; margin-top: 0.75rem; }
.output-empty .empty-hint { font-size: 0.8rem; opacity: 0.6; margin-top: 0.25rem; }

/* Output block (inside a tab pane) */
.output-block-body { padding: 0; }
.output-block-body canvas { max-height: 400px; }

/* Metric grid */
.metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem; margin-bottom: 0.75rem; }
.metric-card {
    padding: 0.75rem; background: var(--bg-tertiary); border: 1px solid var(--border);
    border-radius: 4px; text-align: center;
}
.metric-card.highlight { border-color: var(--accent); }
.metric-value { font-size: 1.4rem; font-weight: 600; color: var(--text); font-family: 'JetBrains Mono', monospace; }
.metric-label { font-size: 0.7rem; color: var(--text-dim); margin-top: 0.25rem; text-transform: uppercase; }

/* Status indicators */
.result-status {
    display: inline-block; padding: 0.35rem 0.75rem; border-radius: 4px;
    font-size: 0.8rem; font-weight: 600; margin-bottom: 0.75rem;
}
.result-status.in-control { background: rgba(74, 200, 110, 0.15); color: #4ac86e; }
.result-status.out-of-control { background: rgba(220, 80, 80, 0.15); color: #dc5050; }
.result-summary { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.5; white-space: pre-wrap; font-family: 'JetBrains Mono', monospace; }
.interpretation { padding: 0.75rem; border-radius: 4px; font-size: 0.85rem; margin-top: 0.75rem; }
.interpretation.good { background: rgba(74, 200, 110, 0.1); color: #4ac86e; }
.interpretation.marginal { background: rgba(232, 197, 71, 0.1); color: #e8c547; }
.interpretation.poor { background: rgba(220, 80, 80, 0.1); color: #dc5050; }

/* Stats output */
.stats-summary {
    font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; line-height: 1.6;
    background: var(--bg-tertiary); padding: 1rem; border-radius: 4px;
    overflow-x: auto; white-space: pre-wrap; color: var(--text-secondary);
}
.stats-plots { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1rem; margin-top: 0.75rem; }
.stats-plot { min-height: 300px; }
.color-accent { color: var(--accent); }
.color-title { color: var(--text); font-weight: 600; }
.color-highlight { color: #e8c547; }
.color-text { color: var(--text-secondary); }
.color-dim { color: var(--text-dim); }
.color-success { color: #4ac86e; }
.color-warning { color: #e8c547; }
.color-danger { color: #dc5050; }

/* DOE table */
.doe-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
.doe-table th, .doe-table td { padding: 0.4rem 0.75rem; border: 1px solid var(--border); text-align: left; }
.doe-table th { background: var(--bg-tertiary); font-weight: 500; }

/* Stats table (summary all columns) */
.stats-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; font-family: 'JetBrains Mono', monospace; }
.stats-table th, .stats-table td { padding: 0.5rem 0.75rem; border: 1px solid var(--border); text-align: right; }
.stats-table th { background: var(--bg-tertiary); font-weight: 500; color: var(--text-dim); text-align: center; }
.stats-table td:first-child { text-align: left; }
.stats-table tr:hover td { background: var(--bg-hover); }

/* Checkbox grid for column selection */
.checkbox-grid { display: flex; flex-direction: column; gap: 0.35rem; max-height: 200px; overflow-y: auto; padding: 0.5rem; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 4px; }
.checkbox-grid label { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--text-secondary); cursor: pointer; padding: 0.2rem 0.25rem; border-radius: 3px; }
.checkbox-grid label:hover { background: var(--bg-hover); color: var(--text); }
.checkbox-grid input[type="checkbox"] { accent-color: var(--accent); width: 15px; height: 15px; cursor: pointer; }
.checkbox-grid .select-actions { display: flex; gap: 0.5rem; padding-bottom: 0.35rem; border-bottom: 1px solid var(--border); margin-bottom: 0.25rem; }
.checkbox-grid .select-actions a { font-size: 0.75rem; color: var(--accent); cursor: pointer; text-decoration: none; }
.checkbox-grid .select-actions a:hover { text-decoration: underline; }

/* Resize Handle */
.wb-resize-handle {
    height: 6px; background: var(--bg-tertiary); cursor: row-resize;
    display: flex; align-items: center; justify-content: center;
    border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);
    flex-shrink: 0;
}
.wb-resize-handle:hover { background: var(--accent-primary-dim); }
.resize-grip { width: 40px; height: 2px; background: var(--text-dim); border-radius: 1px; opacity: 0.5; }

/* Data Panel */
.wb-data {
    height: 250px;
    min-height: 100px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    flex-shrink: 0;
}
.data-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 0.4rem 1.5rem; background: var(--bg-tertiary);
    border-bottom: 1px solid var(--border); flex-shrink: 0;
}
.data-header-left { display: flex; align-items: center; gap: 0.75rem; }
.data-title { font-size: 0.8rem; font-weight: 500; color: var(--text-dim); }
.data-info { font-size: 0.7rem; color: var(--text-dim); }
.data-table-wrapper { flex: 1; overflow: auto; }
.data-empty {
    display: flex; align-items: center; justify-content: center;
    height: 100%; color: var(--text-dim); font-size: 0.85rem;
}

/* Data Table */
.data-table {
    width: 100%; border-collapse: collapse; font-size: 0.8rem;
    font-family: 'JetBrains Mono', monospace;
}
.data-table th {
    padding: 0.35rem 0.75rem; background: var(--bg-secondary);
    border: 1px solid var(--border); font-weight: 500; color: var(--text-dim);
    position: sticky; top: 0; z-index: 1; text-align: left;
    font-size: 0.7rem; text-transform: uppercase;
}
.data-table td {
    padding: 0.3rem 0.75rem; border: 1px solid var(--border);
    color: var(--text-secondary);
}
.data-table tr:hover td { background: var(--bg-hover); }

/* Loading */
.loading-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7); display: flex; flex-direction: column;
    align-items: center; justify-content: center; z-index: 1000;
}
.spinner {
    width: 36px; height: 36px; border: 3px solid var(--bg-tertiary);
    border-top-color: var(--accent-primary); border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Modal */
.modal {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 1000;
    display: flex; align-items: center; justify-content: center;
}
.modal-backdrop { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.75); }
.modal-content {
    position: relative; background: var(--bg-secondary); border: 1px solid var(--border);
    border-radius: 8px; width: 90%; max-width: 560px; max-height: 85vh;
    overflow: hidden; display: flex; flex-direction: column;
}
.modal-lg { max-width: 900px; }
.modal-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 1rem 1.25rem; border-bottom: 1px solid var(--border);
}
.modal-title { font-weight: 500; font-size: 1.1rem; }
.modal-close { background: transparent; border: none; color: var(--text-dim); font-size: 1.5rem; cursor: pointer; padding: 0; line-height: 1; }
.modal-close:hover { color: var(--text); }
.modal-body { padding: 1.25rem; overflow-y: auto; flex: 1; }
.modal-footer {
    display: flex; justify-content: flex-end; gap: 0.5rem;
    padding: 1rem 1.25rem; border-top: 1px solid var(--border);
}

/* Form in modal */
.form-row { margin-bottom: 1rem; }
.form-row label { display: block; margin-bottom: 0.4rem; font-size: 0.8rem; color: var(--text-dim); font-weight: 500; }
.form-row input, .form-row textarea, .form-row select {
    width: 100%; padding: 0.6rem 0.75rem; background: var(--bg-tertiary);
    border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 0.9rem;
}
.form-row input:focus, .form-row textarea:focus, .form-row select:focus {
    outline: none; border-color: var(--accent); background: var(--bg-hover);
}
.form-row textarea { min-height: 80px; resize: vertical; line-height: 1.4; font-family: 'JetBrains Mono', monospace; }
.form-row-inline { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
.form-row small { font-size: 0.7rem; color: var(--text-dim); margin-top: 0.25rem; display: block; }

/* Workbench list */
.workbench-list { display: flex; flex-direction: column; gap: 0.5rem; }
.workbench-list-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 1rem 1.25rem; background: var(--bg-tertiary); border: 1px solid var(--border);
    border-radius: 6px; cursor: pointer;
}
.workbench-list-item:hover { border-color: var(--accent); background: var(--bg-hover); }
.workbench-list-info h4 { margin: 0 0 0.25rem 0; font-size: 1rem; font-weight: 500; }
.workbench-list-meta { font-size: 0.75rem; color: var(--text-dim); }
.workbench-list-badge { padding: 0.25rem 0.5rem; background: var(--bg-secondary); border-radius: 3px; font-size: 0.7rem; color: var(--text-dim); }

/* Toast */
.wb-toast {
    position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%) translateY(100%);
    background: var(--bg-tertiary); border: 1px solid var(--border);
    color: var(--text-secondary); padding: 0.6rem 1rem; border-radius: 4px;
    font-size: 0.8rem; opacity: 0; transition: all 0.3s ease; z-index: 1000; pointer-events: none;
}
.wb-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

@media (max-width: 900px) {
    .ribbon-content { padding: 0.4rem 0.5rem; overflow-x: auto; }
    .wb-header { padding: 0.5rem 1rem; }
    .wb-title-input { width: 200px; font-size: 1rem; }
}

/* AI Assistant Panel */
.ai-assistant-panel {
    position: fixed;
    right: 0;
    top: 0;
    width: 360px;
    height: 100vh;
    background: var(--bg-secondary);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    z-index: 1001;
}

.ai-assistant-panel.open {
    transform: translateX(0);
}

.ai-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid var(--border);
    background: var(--bg-tertiary);
}

.ai-panel-title {
    font-weight: 500;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.ai-panel-title::before {
    content: '';
    width: 8px;
    height: 8px;
    background: var(--accent);
    border-radius: 50%;
}

.ai-panel-actions {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.ai-rate-limit {
    font-size: 0.7rem;
    color: var(--text-dim);
    padding: 0.2rem 0.5rem;
    background: var(--bg-primary);
    border-radius: 10px;
}

.ai-panel-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 1.25rem;
    cursor: pointer;
    padding: 0.25rem;
    line-height: 1;
}

.ai-panel-close:hover {
    color: var(--text-primary);
}

.ai-panel-body {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
}

.ai-messages {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.ai-message {
    max-width: 90%;
}

.ai-message-user {
    align-self: flex-end;
}

.ai-message-assistant {
    align-self: flex-start;
}

.ai-message-content {
    padding: 0.75rem 1rem;
    border-radius: 12px;
    font-size: 0.85rem;
    line-height: 1.5;
}

.ai-message-user .ai-message-content {
    background: var(--accent);
    color: white;
    border-bottom-right-radius: 4px;
}

.ai-message-assistant .ai-message-content {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border-bottom-left-radius: 4px;
}

.ai-message-assistant .ai-message-content ul {
    margin: 0.5rem 0 0 0;
    padding-left: 1.25rem;
}

.ai-message-assistant .ai-message-content li {
    margin: 0.25rem 0;
}

.ai-message-loading {
    display: flex;
    gap: 0.3rem;
    padding: 0.75rem 1rem;
}

.ai-message-loading span {
    width: 8px;
    height: 8px;
    background: var(--text-dim);
    border-radius: 50%;
    animation: ai-typing 1s infinite;
}

.ai-message-loading span:nth-child(2) { animation-delay: 0.2s; }
.ai-message-loading span:nth-child(3) { animation-delay: 0.4s; }

@keyframes ai-typing {
    0%, 100% { opacity: 0.3; }
    50% { opacity: 1; }
}

.ai-panel-footer {
    padding: 1rem;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 0.5rem;
    align-items: flex-end;
}

.ai-panel-footer textarea {
    flex: 1;
    resize: none;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.6rem 0.75rem;
    font-size: 0.85rem;
    background: var(--bg-primary);
    color: var(--text-primary);
    font-family: inherit;
}

.ai-panel-footer textarea:focus {
    outline: none;
    border-color: var(--accent);
}

.ai-send-btn {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background: var(--accent);
    border: none;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s;
}

.ai-send-btn:hover {
    opacity: 0.9;
}

.ai-send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.ai-toggle-btn {
    position: fixed;
    right: 1rem;
    bottom: 1rem;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: var(--accent);
    border: none;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    transition: transform 0.2s, opacity 0.2s;
    z-index: 1000;
}

.ai-toggle-btn:hover {
    transform: scale(1.05);
}

.ai-toggle-btn.hidden {
    opacity: 0;
    pointer-events: none;
}
</style>

<script>
// =============================================================================
// State
// =============================================================================
let currentWorkbench = null;
let artifacts = [];
let uploadedData = null;
let cacheKey = null;       // SPC in-memory cache key (for control charts, capability)
let dswDataId = null;      // DSW on-disk data id (for regression, ANOVA, stats)
let chartInstances = {};
let outputCounter = 0;
let modalCallback = null;
let currentDoeDesign = null;  // Stored after DOE generation for analysis

// Safe number formatting â prevents crashes on null/undefined
function fmt(v, decimals = 4) { return v != null && !isNaN(v) ? Number(v).toFixed(decimals) : 'â'; }

// =============================================================================
// Init
// =============================================================================
let currentProjectId = null;
let currentProjectData = null;  // Full project data including hypotheses, evidence

document.addEventListener('DOMContentLoaded', () => {
    setupRibbonTabs();
    setupResizeHandle();
    setupDragDrop();
    setupTemplateChange();
    setupAIAssistant();
    setupProjectSelector();

    const urlParams = new URLSearchParams(window.location.search);
    const workbenchId = urlParams.get('id');
    if (workbenchId) {
        loadWorkbench(workbenchId);
    }

    // Check for project param in URL
    const projectId = urlParams.get('project');
    if (projectId) {
        currentProjectId = projectId;
    }
});

// =============================================================================
// Project Selector
// =============================================================================
async function setupProjectSelector() {
    const select = document.getElementById('project-select');
    const link = document.getElementById('project-link');

    try {
        const response = await fetch('/api/core/projects/', { credentials: 'include' });
        if (!response.ok) return;
        const projects = await response.json();

        // Populate dropdown
        projects.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.title;
            select.appendChild(opt);
        });

        // Set initial value from URL param
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('project');
        if (projectId) {
            select.value = projectId;
            currentProjectId = projectId;
            updateProjectLink(projectId);
            await loadProjectData(projectId);
        }
    } catch (err) {
        console.error('Failed to load projects:', err);
    }

    // Handle selection change
    select.addEventListener('change', async (e) => {
        currentProjectId = e.target.value || null;
        currentProjectData = null;
        updateProjectLink(currentProjectId);
        // Update URL without reload
        const url = new URL(window.location);
        if (currentProjectId) {
            url.searchParams.set('project', currentProjectId);
            await loadProjectData(currentProjectId);
        } else {
            url.searchParams.delete('project');
        }
        window.history.replaceState({}, '', url);
    });
}

async function loadProjectData(projectId) {
    try {
        const response = await fetch(`/api/core/projects/${projectId}/`, { credentials: 'include' });
        if (!response.ok) return;
        currentProjectData = await response.json();
    } catch (err) {
        console.error('Failed to load project data:', err);
        currentProjectData = null;
    }
}

function updateProjectLink(projectId) {
    const link = document.getElementById('project-link');
    if (projectId) {
        link.href = '/app/projects/#' + projectId;
        link.style.display = 'flex';
        link.onclick = (e) => {
            e.preventDefault();
            window.location.href = '/app/projects/';
        };
    } else {
        link.style.display = 'none';
    }
}

// =============================================================================
// Ribbon
// =============================================================================
function setupRibbonTabs() {
    document.querySelectorAll('.ribbon-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.ribbon-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            document.querySelectorAll('.ribbon-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`ribbon-${tab.dataset.tab}`).classList.add('active');
        });
    });
}

// =============================================================================
// AI Assistant
// =============================================================================
let aiPanelOpen = false;
let aiHistory = [];

function setupAIAssistant() {
    // Enter key to send
    const input = document.getElementById('ai-input');
    if (input) {
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAIMessage();
            }
        });
    }
    // Load rate limit status
    loadAIRateLimit();
}

function toggleAIPanel() {
    aiPanelOpen = !aiPanelOpen;
    const panel = document.getElementById('ai-panel');
    const toggle = document.getElementById('ai-toggle');

    if (aiPanelOpen) {
        panel.classList.add('open');
        toggle.classList.add('hidden');
        document.getElementById('ai-input').focus();
    } else {
        panel.classList.remove('open');
        toggle.classList.remove('hidden');
    }
}

async function loadAIRateLimit() {
    try {
        const resp = await fetch('/api/guide/rate-limit/', { credentials: 'include' });
        if (resp.ok) {
            const data = await resp.json();
            document.getElementById('ai-rate-limit').textContent = `${data.remaining}/${data.limit}`;
        }
    } catch (e) {
        console.warn('Could not load AI rate limit:', e);
    }
}

async function sendAIMessage() {
    const input = document.getElementById('ai-input');
    const message = input.value.trim();
    if (!message) return;

    // Clear input
    input.value = '';

    // Add user message to UI
    addAIMessage(message, 'user');

    // Build context from current data and recent outputs
    const context = buildAIContext();

    // Show loading indicator
    const loadingEl = addAILoading();

    try {
        const resp = await fetch('/api/guide/chat/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                message: message,
                context: 'dsw',
                data: context,
                history: aiHistory.slice(-6)  // Last 6 messages for context
            })
        });

        // Remove loading indicator
        loadingEl.remove();

        if (!resp.ok) {
            const err = await resp.json();
            if (err.rate_limited) {
                addAIMessage('Rate limit reached. Please try again tomorrow or upgrade your plan.', 'assistant');
            } else {
                addAIMessage('Sorry, I encountered an error. Please try again.', 'assistant');
            }
            return;
        }

        const data = await resp.json();
        addAIMessage(data.response, 'assistant');

        // Update rate limit display
        if (data.rate_limit) {
            document.getElementById('ai-rate-limit').textContent =
                `${data.rate_limit.remaining}/${data.rate_limit.limit}`;
        }

        // Update history
        aiHistory.push({ role: 'user', content: message });
        aiHistory.push({ role: 'assistant', content: data.response });

    } catch (e) {
        loadingEl.remove();
        addAIMessage('Connection error. Please check your network and try again.', 'assistant');
    }
}

function addAIMessage(content, role) {
    const container = document.getElementById('ai-messages');
    const div = document.createElement('div');
    div.className = `ai-message ai-message-${role}`;

    // Convert markdown-ish formatting
    let html = content
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code>$1</code>')
        .replace(/\n/g, '<br>');

    div.innerHTML = `<div class="ai-message-content">${html}</div>`;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
    return div;
}

function addAILoading() {
    const container = document.getElementById('ai-messages');
    const div = document.createElement('div');
    div.className = 'ai-message ai-message-assistant';
    div.innerHTML = `
        <div class="ai-message-loading">
            <span></span><span></span><span></span>
        </div>
    `;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
    return div;
}

function buildAIContext() {
    const context = { summary: '', project: null };
    const parts = [];

    // Add project context if available
    if (currentProjectData) {
        parts.push('=== PROJECT CONTEXT ===');
        parts.push(`Project: ${currentProjectData.title}`);
        if (currentProjectData.problem_statement) {
            parts.push(`Problem: ${currentProjectData.problem_statement}`);
        }
        if (currentProjectData.domain) {
            parts.push(`Domain: ${currentProjectData.domain}`);
        }
        if (currentProjectData.current_phase) {
            parts.push(`Phase: ${currentProjectData.current_phase}`);
        }

        // Add hypotheses
        const hypotheses = currentProjectData.hypotheses || [];
        if (hypotheses.length > 0) {
            parts.push('\nHypotheses being investigated:');
            hypotheses.forEach((h, i) => {
                const prob = Math.round((h.current_probability || 0.5) * 100);
                parts.push(`${i+1}. "${h.statement}" (${prob}% probability, ${h.status || 'investigating'})`);
                if (h.mechanism) {
                    parts.push(`   Mechanism: ${h.mechanism}`);
                }
            });
        }

        // Add evidence summary
        if (hypotheses.some(h => h.evidence_count > 0)) {
            parts.push('\nExisting evidence:');
            hypotheses.forEach(h => {
                if (h.evidence_count > 0) {
                    parts.push(`- ${h.evidence_count} evidence items for "${h.statement.slice(0, 50)}..."`);
                }
            });
        }

        // Pass structured project data for the API
        context.project = {
            id: currentProjectData.id,
            title: currentProjectData.title,
            problem_statement: currentProjectData.problem_statement,
            hypotheses: hypotheses.map(h => ({
                id: h.id,
                statement: h.statement,
                probability: h.current_probability,
                status: h.status
            }))
        };

        parts.push('\n=== SESSION DATA ===');
    }

    // Add data summary
    if (uploadedData && uploadedData.columns) {
        parts.push(`Data loaded: ${uploadedData.rows || 0} rows, ${uploadedData.columns.length} columns`);
        parts.push(`Columns: ${uploadedData.columns.slice(0, 10).join(', ')}${uploadedData.columns.length > 10 ? '...' : ''}`);
    }

    // Add recent analysis results from output tabs
    const tabs = document.querySelectorAll('.output-tab');
    if (tabs.length > 0) {
        parts.push(`\nRecent analyses (${tabs.length}):`);
        tabs.forEach((tab, i) => {
            if (i < 5) {  // Only include last 5
                parts.push(`- ${tab.textContent.replace('Ã', '').trim()}`);
            }
        });
    }

    context.summary = parts.join('\n');
    return context;
}

// =============================================================================
// Template Phase Bar
// =============================================================================
function setupTemplateChange() {
    document.getElementById('workbench-template').addEventListener('change', (e) => updatePhaseBar(e.target.value));
}

function updatePhaseBar(template) {
    const phaseBar = document.getElementById('phase-bar');
    const phasePills = document.getElementById('phase-pills');
    const templates = {
        dmaic: ['Define', 'Measure', 'Analyze', 'Improve', 'Control'],
        '8d': ['D1: Team', 'D2: Problem', 'D3: Contain', 'D4: Root Cause', 'D5: Corrective', 'D6: Implement', 'D7: Prevent', 'D8: Celebrate'],
        a3: ['Background', 'Current', 'Goal', 'Root Cause', 'Countermeasures', 'Implementation', 'Follow-up'],
        kaizen: ['Day 1: Current State', 'Day 2: Waste ID', 'Day 3: Future State', 'Day 4: Action Items', 'Day 5: Results']
    };
    if (templates[template]) {
        phaseBar.style.display = 'flex';
        phasePills.innerHTML = templates[template].map((phase, i) =>
            `<div class="phase-pill ${i === 0 ? 'active' : ''}" data-phase="${i}">${phase}</div>`
        ).join('');
    } else {
        phaseBar.style.display = 'none';
    }
}

// =============================================================================
// Resize Handle (drag to resize output/data panels)
// =============================================================================
function setupResizeHandle() {
    const handle = document.getElementById('resize-handle');
    const output = document.getElementById('output-panel');
    const data = document.getElementById('data-panel');
    let startY, startOutputH, startDataH;

    handle.addEventListener('mousedown', (e) => {
        e.preventDefault();
        startY = e.clientY;
        startOutputH = output.offsetHeight;
        startDataH = data.offsetHeight;
        document.addEventListener('mousemove', onResize);
        document.addEventListener('mouseup', stopResize);
        document.body.style.cursor = 'row-resize';
        document.body.style.userSelect = 'none';
    });

    function onResize(e) {
        const dy = e.clientY - startY;
        const newOutputH = Math.max(150, startOutputH + dy);
        const newDataH = Math.max(80, startDataH - dy);
        output.style.flex = 'none';
        output.style.height = newOutputH + 'px';
        data.style.height = newDataH + 'px';
    }

    function stopResize() {
        document.removeEventListener('mousemove', onResize);
        document.removeEventListener('mouseup', stopResize);
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
    }
}

// =============================================================================
// Drag & Drop
// =============================================================================
function setupDragDrop() {
    const app = document.getElementById('workbench-app');
    app.addEventListener('dragover', (e) => { e.preventDefault(); });
    app.addEventListener('drop', async (e) => {
        e.preventDefault();
        if (e.dataTransfer.files.length > 0) {
            await handleFileUpload(e.dataTransfer.files[0]);
        }
    });
}

// =============================================================================
// API Helpers
// =============================================================================
function getCSRFToken() {
    return document.cookie.split('; ').find(r => r.startsWith('csrftoken='))?.split('=')[1];
}

async function apiCall(endpoint, method = 'GET', data = null) {
    const opts = { method, credentials: 'include', headers: { 'X-CSRFToken': getCSRFToken() } };
    if (data) { opts.headers['Content-Type'] = 'application/json'; opts.body = JSON.stringify(data); }
    const r = await fetch(`/api/workbench/${endpoint}`, opts);
    if (r.status === 401 || r.redirected) {
        // @login_required redirects to HTML login page â don't try to parse
        return { error: 'auth', workbenches: [] };
    }
    const ct = r.headers.get('content-type') || '';
    if (!ct.includes('application/json')) return { error: 'bad_response', workbenches: [] };
    return r.json();
}

async function apiPost(url, data, isFormData = false) {
    const opts = { method: 'POST', credentials: 'include', headers: { 'X-CSRFToken': getCSRFToken() } };
    if (isFormData) {
        opts.body = data;
    } else {
        opts.headers['Content-Type'] = 'application/json';
        opts.body = JSON.stringify(data);
    }
    const r = await fetch(url, opts);
    if (r.status === 401) {
        window.location.href = '/login/?next=' + encodeURIComponent(window.location.pathname);
        return { response: r, data: { error: 'Please log in' } };
    }
    const contentType = r.headers.get('content-type') || '';
    if (!contentType.includes('application/json')) {
        return { response: r, data: { error: 'Unexpected response from server' } };
    }
    return { response: r, data: await r.json() };
}

function showLoading(show, text) {
    document.getElementById('loading').style.display = show ? 'flex' : 'none';
    if (text) document.getElementById('loading-text').textContent = text;
}

function showToast(msg) {
    let t = document.getElementById('wb-toast');
    if (!t) { t = document.createElement('div'); t.id = 'wb-toast'; t.className = 'wb-toast'; document.body.appendChild(t); }
    t.textContent = msg; t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
}

// =============================================================================
// OUTPUT PANEL â Tabbed results
// =============================================================================
function addOutput(title, contentHtml) {
    const empty = document.getElementById('output-empty');
    if (empty) empty.style.display = 'none';

    const id = 'output-' + (++outputCounter);
    const shortTitle = title.length > 18 ? title.slice(0, 16) + '...' : title;

    // Create tab
    const tab = document.createElement('button');
    tab.className = 'output-tab';
    tab.dataset.pane = id;
    tab.innerHTML = `<span>${shortTitle}</span><span class="tab-close" onclick="event.stopPropagation(); closeTab('${id}')">&times;</span>`;
    tab.onclick = () => switchTab(id);
    document.getElementById('output-tabs').appendChild(tab);

    // Create pane
    const pane = document.createElement('div');
    pane.className = 'output-pane';
    pane.id = id;
    pane.innerHTML = `<div class="output-block-body">${contentHtml}</div>`;
    document.getElementById('output-panes').appendChild(pane);

    // Switch to this tab
    switchTab(id);
    return id;
}

function switchTab(id) {
    document.querySelectorAll('.output-tab').forEach(t => t.classList.toggle('active', t.dataset.pane === id));
    document.querySelectorAll('.output-pane').forEach(p => p.classList.toggle('active', p.id === id));
}

function closeTab(id) {
    const tab = document.querySelector(`.output-tab[data-pane="${id}"]`);
    const pane = document.getElementById(id);
    const wasActive = tab && tab.classList.contains('active');
    if (tab) tab.remove();
    if (pane) pane.remove();

    // If we closed the active tab, switch to the last remaining tab
    if (wasActive) {
        const remaining = document.querySelectorAll('.output-tab');
        if (remaining.length > 0) {
            switchTab(remaining[remaining.length - 1].dataset.pane);
        } else {
            document.getElementById('output-empty').style.display = 'flex';
        }
    }
}

function clearOutput() {
    document.getElementById('output-tabs').innerHTML = '';
    const panes = document.getElementById('output-panes');
    // Remove all panes but keep the empty placeholder
    panes.querySelectorAll('.output-pane').forEach(p => p.remove());
    document.getElementById('output-empty').style.display = 'flex';
    outputCounter = 0;
}

// =============================================================================
// FILE UPLOAD
// =============================================================================
function importFile(accept) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = accept;
    input.onchange = async (e) => {
        if (e.target.files[0]) await handleFileUpload(e.target.files[0]);
    };
    input.click();
}

async function handleFileUpload(file) {
    const ext = '.' + file.name.split('.').pop().toLowerCase();
    if (!['.csv', '.xlsx', '.xls'].includes(ext)) { alert('Please upload CSV or Excel file'); return; }

    showLoading(true, 'Uploading ' + file.name + '...');

    try {
        // Upload to SPC endpoint (for control charts, capability)
        const spcForm = new FormData();
        spcForm.append('file', file);
        const { response: spcResp, data: spcData } = await apiPost('/api/spc/upload/', spcForm, true);

        if (spcResp.ok && spcData.success) {
            uploadedData = spcData;
            cacheKey = spcData.cache_key;
        }

        // Upload to DSW endpoint (for regression, ANOVA, stats analysis)
        const dswForm = new FormData();
        dswForm.append('file', file);
        const { response: dswResp, data: dswData } = await apiPost('/api/dsw/upload-data/', dswForm, true);

        if (dswResp.ok && dswData.id) {
            dswDataId = dswData.id;
            // If SPC upload failed, use DSW data for display
            if (!uploadedData) {
                uploadedData = {
                    filename: dswData.filename,
                    row_count: dswData.rows,
                    columns: dswData.columns,
                    preview: dswData.preview,
                };
            }
        }

        showLoading(false);

        if (uploadedData) {
            displayDataTable(uploadedData);
            showToast(`Loaded ${file.name} â ${uploadedData.row_count || dswData?.rows || ''} rows`);
            if (dswDataId) autoTriageScan(dswDataId);
        } else {
            alert(spcData?.error || dswData?.error || 'Upload failed');
        }
    } catch (err) {
        showLoading(false);
        alert('Upload error: ' + err.message);
    }
}

function displayDataTable(data) {
    document.getElementById('data-empty').style.display = 'none';
    const table = document.getElementById('data-table');
    table.style.display = 'table';

    document.getElementById('data-title').textContent = data.filename || 'Worksheet';
    document.getElementById('data-info').textContent = `${data.row_count} rows, ${data.columns.length} cols`;

    // Header
    const thead = document.getElementById('data-thead');
    thead.innerHTML = '<tr>' + data.columns.map(c => `<th>${c.name}</th>`).join('') + '</tr>';

    // Body (show up to 500 rows in table; full data available for graphs)
    const tbody = document.getElementById('data-tbody');
    if (data.preview) {
        const cols = data.columns.map(c => c.name);
        const totalRows = data.preview[cols[0]] ? data.preview[cols[0]].length : 0;
        const displayRows = Math.min(totalRows, 500);
        let html = '';
        for (let i = 0; i < displayRows; i++) {
            html += '<tr>' + cols.map(c => `<td>${data.preview[c] ? data.preview[c][i] : ''}</td>`).join('') + '</tr>';
        }
        if (totalRows > 500) html += `<tr><td colspan="${cols.length}" style="text-align:center;color:var(--text-dim);font-style:italic;">Showing 500 of ${totalRows} rows</td></tr>`;
        tbody.innerHTML = html;
    }

    // Column selector
    const sel = document.getElementById('column-selector');
    sel.style.display = 'inline-block';
    sel.innerHTML = '<option value="">All columns</option>' +
        data.columns.map(c => `<option value="${c.name}">${c.name} (${c.dtype})</option>`).join('');
}

function viewDataTable() {
    if (!uploadedData) { alert('Please import a data file first'); return; }
    // Scroll to data panel
    document.getElementById('data-panel').scrollIntoView({ behavior: 'smooth' });
}

function getNumericColumns() {
    if (!uploadedData) return [];
    return uploadedData.columns.filter(c => c.dtype === 'numeric').map(c => c.name);
}

function getAllColumns() {
    if (!uploadedData) return [];
    return uploadedData.columns.map(c => c.name);
}

// =============================================================================
// MODAL SYSTEM
// =============================================================================
function openModal(title, bodyHtml, submitLabel, callback) {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-body').innerHTML = bodyHtml;
    document.getElementById('modal-submit').textContent = submitLabel || 'Run';
    document.getElementById('analysis-modal').style.display = 'flex';
    modalCallback = callback;
}

function closeModal() {
    document.getElementById('analysis-modal').style.display = 'none';
    modalCallback = null;
}

function submitModal() {
    if (modalCallback) modalCallback();
}

// =============================================================================
// SPC: Control Charts
// =============================================================================
function openSPCDialog(chartType) {
    const numCols = getNumericColumns();
    const colOptions = numCols.map(c => `<option value="${c}">${c}</option>`).join('');
    const hasData = uploadedData != null;

    let html = '';
    if (hasData) {
        html += `<div class="form-row"><label>Value Column</label><select id="dlg-value-col">${colOptions}</select></div>`;
        html += `<div class="form-row"><label>Subgroup Column (optional)</label><select id="dlg-subgroup-col"><option value="">None</option>${getAllColumns().map(c => `<option value="${c}">${c}</option>`).join('')}</select></div>`;
    }
    html += `<div class="form-row"><label>Or enter data manually</label><textarea id="dlg-data" rows="5" placeholder="Values separated by commas or newlines. For subgroups: one row per subgroup."></textarea></div>`;
    html += `<div class="form-row-inline">
        <div class="form-row"><label>USL (optional)</label><input type="number" id="dlg-usl" step="any"></div>
        <div class="form-row"><label>LSL (optional)</label><input type="number" id="dlg-lsl" step="any"></div>
    </div>`;
    if (chartType === 'p') {
        html += `<div class="form-row"><label>Sample Sizes</label><textarea id="dlg-sample-sizes" rows="2" placeholder="50, 50, 48, 52..."></textarea></div>`;
    }
    html += `<input type="hidden" id="dlg-chart-type" value="${chartType}">`;

    openModal(`${chartType} Control Chart`, html, 'Create Chart', runControlChart);
}

async function runControlChart() {
    const chartType = document.getElementById('dlg-chart-type').value;
    const usl = document.getElementById('dlg-usl').value;
    const lsl = document.getElementById('dlg-lsl').value;

    let body = { chart_type: chartType };
    if (usl) body.usl = parseFloat(usl);
    if (lsl) body.lsl = parseFloat(lsl);

    // From file
    const valCol = document.getElementById('dlg-value-col');
    if (valCol && valCol.value && cacheKey) {
        body.cache_key = cacheKey;
        body.value_column = valCol.value;
        const sgCol = document.getElementById('dlg-subgroup-col');
        if (sgCol && sgCol.value) body.subgroup_column = sgCol.value;
        body.analysis_type = 'control_chart';

        closeModal();
        showLoading(true, 'Creating control chart...');
        try {
            const { response, data } = await apiPost('/api/spc/analyze/', body);
            showLoading(false);
            if (response.ok && data.success) {
                renderControlChartOutput(data.chart);
            } else { alert(data.error || 'Analysis failed'); }
        } catch (err) { showLoading(false); alert('Error: ' + err.message); }
        return;
    }

    // Manual data
    const dataText = document.getElementById('dlg-data').value.trim();
    if (!dataText) { alert('Enter data or select a column'); return; }

    const lines = dataText.split('\n');
    if (chartType === 'X-bar R') {
        body.data = lines.map(l => l.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v))).filter(sg => sg.length > 0);
    } else {
        body.data = [];
        for (const line of lines) for (const val of line.split(',')) { const n = parseFloat(val.trim()); if (!isNaN(n)) body.data.push(n); }
    }

    if (chartType === 'p') {
        const sizesEl = document.getElementById('dlg-sample-sizes');
        if (sizesEl) body.sample_sizes = sizesEl.value.split(',').map(v => parseInt(v.trim())).filter(v => !isNaN(v));
    }

    closeModal();
    showLoading(true, 'Creating control chart...');
    try {
        const { response, data } = await apiPost('/api/spc/chart/', body);
        showLoading(false);
        if (response.ok) { renderControlChartOutput(data.chart); }
        else { alert(data.error || 'Failed'); }
    } catch (err) { showLoading(false); alert('Error: ' + err.message); }
}

function renderControlChartOutput(chart) {
    const statusClass = chart.in_control ? 'in-control' : 'out-of-control';
    const statusText = chart.in_control ? 'IN CONTROL' : 'OUT OF CONTROL';
    const canvasId = 'chart-canvas-' + (++outputCounter);
    const secCanvasId = 'sec-chart-canvas-' + outputCounter;

    let html = `<div class="result-status ${statusClass}">${statusText}</div>`;
    html += `<div class="result-summary">${chart.summary || ''}</div>`;
    html += `<canvas id="${canvasId}" style="max-height:350px;"></canvas>`;
    if (chart.secondary_chart) {
        html += `<canvas id="${secCanvasId}" style="max-height:250px; margin-top:1rem;"></canvas>`;
    }

    addOutput(chart.chart_type + ' Chart', html);

    // Draw after DOM update
    setTimeout(() => {
        drawControlChart(canvasId, chart);
        if (chart.secondary_chart) drawControlChart(secCanvasId, chart.secondary_chart);
    }, 50);
}

function drawControlChart(canvasId, chart) {
    const ctx = document.getElementById(canvasId);
    if (!ctx || !chart.data_points || !chart.limits) return;
    const labels = chart.data_points.map((_, i) => i + 1);
    const datasets = [
        {
            label: 'Data', data: chart.data_points,
            borderColor: SvendTheme.colors.primary, backgroundColor: 'transparent', tension: 0, pointRadius: 4,
            pointBackgroundColor: chart.data_points.map((v, i) =>
                (chart.out_of_control || []).some(p => p.index === i) ? SvendTheme.colors.error : SvendTheme.colors.primary
            ),
        },
        { label: 'UCL', data: Array(chart.data_points.length).fill(chart.limits.ucl), borderColor: SvendTheme.colors.error, borderDash: [5, 5], pointRadius: 0 },
        { label: 'CL', data: Array(chart.data_points.length).fill(chart.limits.cl), borderColor: SvendTheme.colors.textDim, borderDash: [2, 2], pointRadius: 0 },
        { label: 'LCL', data: Array(chart.data_points.length).fill(chart.limits.lcl), borderColor: SvendTheme.colors.error, borderDash: [5, 5], pointRadius: 0 },
    ];
    if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
    chartInstances[canvasId] = new Chart(ctx, {
        type: 'line', data: { labels, datasets },
        options: {
            responsive: true,
            plugins: { title: { display: true, text: chart.chart_type + ' Chart', color: SvendTheme.colors.text } },
            scales: {
                x: { ticks: { color: SvendTheme.colors.textDim }, grid: { color: 'rgba(255,255,255,0.1)' } },
                y: { ticks: { color: SvendTheme.colors.textDim }, grid: { color: 'rgba(255,255,255,0.1)' } }
            }
        }
    });
}

// =============================================================================
// SPC: Extended Charts (EWMA, CUSUM, X-bar S, NP, U) â via DSW backend
// =============================================================================
function openSPCExtDialog(chartId) {
    if (!uploadedData) { alert('Please import a data file first'); return; }
    const numCols = getNumericColumns();
    const allCols = getAllColumns();
    const numOpts = numCols.map(c => `<option value="${c}">${c}</option>`).join('');
    const allOpts = allCols.map(c => `<option value="${c}">${c}</option>`).join('');

    let html = '', title = '', onRun;

    if (chartId === 'xbar_s') {
        title = 'X-bar S Chart';
        html = `<div class="form-row"><label>Measurement Column</label><select id="dlg-spc-meas">${numOpts}</select></div>
            <div class="form-row"><label>Subgroup Column (optional)</label><select id="dlg-spc-sg"><option value="">None (use size below)</option>${allOpts}</select></div>
            <div class="form-row"><label>Subgroup Size</label><input type="number" id="dlg-spc-sgsize" value="5" min="2" max="25"></div>`;
        onRun = () => {
            const config = { measurement: document.getElementById('dlg-spc-meas').value, subgroup_size: parseInt(document.getElementById('dlg-spc-sgsize').value) || 5 };
            const sg = document.getElementById('dlg-spc-sg').value;
            if (sg) config.subgroup = sg;
            closeModal();
            runStatsAnalysis('spc', 'xbar_s', config, 'X-bar S Chart');
        };
    } else if (chartId === 'np_chart') {
        title = 'NP Chart';
        html = `<div class="form-row"><label>Defectives Column</label><select id="dlg-spc-def">${numOpts}</select></div>
            <div class="form-row"><label>Constant Sample Size</label><input type="number" id="dlg-spc-n" value="50" min="1"></div>`;
        onRun = () => {
            closeModal();
            runStatsAnalysis('spc', 'np_chart', { defectives: document.getElementById('dlg-spc-def').value, sample_size: parseInt(document.getElementById('dlg-spc-n').value) || 50 }, 'NP Chart');
        };
    } else if (chartId === 'u_chart') {
        title = 'U Chart';
        html = `<div class="form-row"><label>Defects Column</label><select id="dlg-spc-def">${numOpts}</select></div>
            <div class="form-row"><label>Units/Opportunity Column</label><select id="dlg-spc-units">${numOpts}</select></div>`;
        onRun = () => {
            closeModal();
            runStatsAnalysis('spc', 'u_chart', { defects: document.getElementById('dlg-spc-def').value, units: document.getElementById('dlg-spc-units').value }, 'U Chart');
        };
    } else if (chartId === 'ewma') {
        title = 'EWMA Chart';
        html = `<div class="form-row"><label>Measurement Column</label><select id="dlg-spc-meas">${numOpts}</select></div>
            <div class="form-row"><label>Target (0 = auto mean)</label><input type="number" id="dlg-spc-target" value="0" step="any"></div>
            <div class="form-row"><label>Lambda (smoothing, 0.05-0.3)</label><input type="number" id="dlg-spc-lambda" value="0.2" step="0.05" min="0.05" max="1"></div>
            <div class="form-row"><label>L (sigma width)</label><input type="number" id="dlg-spc-L" value="3" step="0.5" min="1" max="5"></div>`;
        onRun = () => {
            closeModal();
            runStatsAnalysis('spc', 'ewma', {
                measurement: document.getElementById('dlg-spc-meas').value,
                target: parseFloat(document.getElementById('dlg-spc-target').value) || 0,
                lambda: parseFloat(document.getElementById('dlg-spc-lambda').value) || 0.2,
                L: parseFloat(document.getElementById('dlg-spc-L').value) || 3
            }, 'EWMA Chart');
        };
    } else if (chartId === 'cusum') {
        title = 'CUSUM Chart';
        html = `<div class="form-row"><label>Measurement Column</label><select id="dlg-spc-meas">${numOpts}</select></div>
            <div class="form-row"><label>Target (0 = auto mean)</label><input type="number" id="dlg-spc-target" value="0" step="any"></div>
            <div class="form-row"><label>k (slack value, 0.25-1)</label><input type="number" id="dlg-spc-k" value="0.5" step="0.25" min="0.25" max="2"></div>
            <div class="form-row"><label>h (decision interval)</label><input type="number" id="dlg-spc-h" value="5" step="1" min="1" max="10"></div>`;
        onRun = () => {
            closeModal();
            runStatsAnalysis('spc', 'cusum', {
                measurement: document.getElementById('dlg-spc-meas').value,
                target: parseFloat(document.getElementById('dlg-spc-target').value) || 0,
                k: parseFloat(document.getElementById('dlg-spc-k').value) || 0.5,
                h: parseFloat(document.getElementById('dlg-spc-h').value) || 5
            }, 'CUSUM Chart');
        };
    } else if (chartId === 'laney_p') {
        title = "Laney P' Chart";
        html = `<div class="form-row"><label>Defectives Column</label><select id="dlg-spc-def">${numOpts}</select></div>
            <div class="form-row"><label>Sample Size Column</label><select id="dlg-spc-n">${numOpts}</select></div>
            <p style="color:#aaa;font-size:0.85em;margin-top:8px">Adjusts limits for overdispersion â use when standard P chart gives too many false alarms.</p>`;
        onRun = () => {
            closeModal();
            runStatsAnalysis('spc', 'laney_p', { defectives: document.getElementById('dlg-spc-def').value, sample_size: document.getElementById('dlg-spc-n').value }, "Laney P' Chart");
        };
    } else if (chartId === 'laney_u') {
        title = "Laney U' Chart";
        html = `<div class="form-row"><label>Defects Column</label><select id="dlg-spc-def">${numOpts}</select></div>
            <div class="form-row"><label>Units/Opportunity Column</label><select id="dlg-spc-units">${numOpts}</select></div>
            <p style="color:#aaa;font-size:0.85em;margin-top:8px">Adjusts limits for overdispersion â use when standard U chart gives too many false alarms.</p>`;
        onRun = () => {
            closeModal();
            runStatsAnalysis('spc', 'laney_u', { defects: document.getElementById('dlg-spc-def').value, units: document.getElementById('dlg-spc-units').value }, "Laney U' Chart");
        };
    } else if (chartId === 'between_within') {
        title = 'Between/Within Capability';
        html = `<div class="form-row"><label>Measurement Column</label><select id="dlg-spc-meas">${numOpts}</select></div>
            <div class="form-row"><label>Subgroup Column (optional)</label><select id="dlg-spc-sg"><option value="">None (use size below)</option>${allOpts}</select></div>
            <div class="form-row"><label>Subgroup Size</label><input type="number" id="dlg-spc-sgsize" value="5" min="2" max="25"></div>
            <div class="form-row"><label>LSL (optional)</label><input type="number" id="dlg-spc-lsl" value="" step="any" placeholder="Lower spec"></div>
            <div class="form-row"><label>USL (optional)</label><input type="number" id="dlg-spc-usl" value="" step="any" placeholder="Upper spec"></div>`;
        onRun = () => {
            const config = { measurement: document.getElementById('dlg-spc-meas').value, subgroup_size: parseInt(document.getElementById('dlg-spc-sgsize').value) || 5 };
            const sg = document.getElementById('dlg-spc-sg').value;
            if (sg) config.subgroup = sg;
            const lsl = document.getElementById('dlg-spc-lsl').value;
            const usl = document.getElementById('dlg-spc-usl').value;
            if (lsl !== '') config.lsl = parseFloat(lsl);
            if (usl !== '') config.usl = parseFloat(usl);
            closeModal();
            runStatsAnalysis('spc', 'between_within', config, 'Between/Within Capability');
        };
    } else if (chartId === 'moving_average') {
        title = 'Moving Average Chart';
        html = `<div class="form-row"><label>Measurement Column</label><select id="dlg-spc-meas">${numOpts}</select></div>
            <div class="form-row"><label>Span (window size)</label><input type="number" id="dlg-spc-span" value="5" min="2" max="50"></div>
            <p style="color:#aaa;font-size:0.85em;margin-top:8px">Smooths short-term noise. Larger span = more smoothing, better at detecting sustained shifts.</p>`;
        onRun = () => {
            closeModal();
            runStatsAnalysis('spc', 'moving_average', {
                measurement: document.getElementById('dlg-spc-meas').value,
                span: parseInt(document.getElementById('dlg-spc-span').value) || 5
            }, 'Moving Average Chart');
        };
    } else if (chartId === 'zone_chart') {
        title = 'Zone Chart';
        html = `<div class="form-row"><label>Measurement Column</label><select id="dlg-spc-meas">${numOpts}</select></div>
            <p style="color:#aaa;font-size:0.85em;margin-top:8px">Color-coded A/B/C zones with cumulative scoring. Signals when zone score reaches 8 (equivalent to Western Electric rules).</p>`;
        onRun = () => {
            closeModal();
            runStatsAnalysis('spc', 'zone_chart', {
                measurement: document.getElementById('dlg-spc-meas').value
            }, 'Zone Chart');
        };
    } else if (chartId === 'mewma') {
        title = 'MEWMA (Multivariate EWMA)';
        const multiOpts = numCols.map(c => `<option value="${c}">${c}</option>`).join('');
        html = `<div class="form-row"><label>Variables (select 2+)</label><select id="dlg-spc-vars" multiple size="5" style="min-height:100px;">${multiOpts}</select></div>
            <div class="form-row"><label>Lambda (smoothing, 0.05-0.3)</label><input type="number" id="dlg-spc-lambda" value="0.1" step="0.05" min="0.05" max="1"></div>
            <p style="color:#aaa;font-size:0.85em;margin-top:8px">Multivariate extension of EWMA. Smaller Î» = more sensitive to small shifts. Select at least 2 numeric variables.</p>`;
        onRun = () => {
            const sel = document.getElementById('dlg-spc-vars');
            const vars = Array.from(sel.selectedOptions).map(o => o.value);
            if (vars.length < 2) { alert('Select at least 2 variables'); return; }
            closeModal();
            runStatsAnalysis('spc', 'mewma', {
                variables: vars,
                lambda: parseFloat(document.getElementById('dlg-spc-lambda').value) || 0.1
            }, 'MEWMA Chart');
        };
    }
    openModal(title, html, 'Create Chart', onRun);
}

// =============================================================================
function openNonNormalCapDialog() {
    if (!uploadedData) { alert('Please import a data file first'); return; }
    const numCols = getNumericColumns();
    const numOpts = numCols.map(c => `<option value="${c}">${c}</option>`).join('');
    const html = `<div class="form-row"><label>Measurement Column</label><select id="dlg-nnc-meas">${numOpts}</select></div>
        <div class="form-row"><label>LSL</label><input type="number" id="dlg-nnc-lsl" step="any" placeholder="Lower spec"></div>
        <div class="form-row"><label>USL</label><input type="number" id="dlg-nnc-usl" step="any" placeholder="Upper spec"></div>
        <p style="color:#aaa;font-size:0.85em;margin-top:8px">Fits Normal, Lognormal, Weibull, and Exponential. Auto-selects best fit and computes equivalent Pp/Ppk.</p>`;
    openModal('Non-Normal Capability', html, 'Run Analysis', () => {
        const config = { measurement: document.getElementById('dlg-nnc-meas').value };
        const lsl = document.getElementById('dlg-nnc-lsl').value;
        const usl = document.getElementById('dlg-nnc-usl').value;
        if (lsl !== '') config.lsl = parseFloat(lsl);
        if (usl !== '') config.usl = parseFloat(usl);
        closeModal();
        runStatsAnalysis('spc', 'nonnormal_capability', config, 'Non-Normal Capability');
    });
}

// Reliability Analysis Dialogs
// =============================================================================
function openReliabilityDialog(analysisId) {
    if (!uploadedData && analysisId !== 'reliability_test_plan') { alert('Please import a data file first'); return; }
    const numCols = getNumericColumns();
    const allCols = getAllColumns();
    const numOpts = numCols.map(c => `<option value="${c}">${c}</option>`).join('');

    let html = '', title = '', onRun;

    if (analysisId === 'weibull') {
        title = 'Weibull Analysis';
        html = `<div class="form-row"><label>Time/Life Column</label><select id="dlg-rel-time">${numOpts}</select></div>
            <div class="form-row"><label>Censor Column (optional, 1=failed 0=censored)</label><select id="dlg-rel-censor"><option value="">None (all failed)</option>${numOpts}</select></div>`;
        onRun = () => {
            const config = { time: document.getElementById('dlg-rel-time').value };
            const censor = document.getElementById('dlg-rel-censor').value;
            if (censor) config.censor = censor;
            closeModal();
            runStatsAnalysis('reliability', 'weibull', config, 'Weibull Analysis');
        };
    } else if (analysisId === 'lognormal') {
        title = 'Lognormal Analysis';
        html = `<div class="form-row"><label>Time/Life Column</label><select id="dlg-rel-time">${numOpts}</select></div>`;
        onRun = () => {
            closeModal();
            runStatsAnalysis('reliability', 'lognormal', { time: document.getElementById('dlg-rel-time').value }, 'Lognormal Analysis');
        };
    } else if (analysisId === 'exponential') {
        title = 'Exponential Analysis';
        html = `<div class="form-row"><label>Time/Life Column</label><select id="dlg-rel-time">${numOpts}</select></div>`;
        onRun = () => {
            closeModal();
            runStatsAnalysis('reliability', 'exponential', { time: document.getElementById('dlg-rel-time').value }, 'Exponential Analysis');
        };
    } else if (analysisId === 'kaplan_meier') {
        title = 'Kaplan-Meier Survival';
        html = `<div class="form-row"><label>Time Column</label><select id="dlg-rel-time">${numOpts}</select></div>
            <div class="form-row"><label>Event Column (1=event, 0=censored)</label><select id="dlg-rel-event"><option value="">None (all events)</option>${numOpts}</select></div>`;
        onRun = () => {
            const config = { time: document.getElementById('dlg-rel-time').value };
            const ev = document.getElementById('dlg-rel-event').value;
            if (ev) config.event = ev;
            closeModal();
            runStatsAnalysis('reliability', 'kaplan_meier', config, 'Kaplan-Meier Survival');
        };
    } else if (analysisId === 'reliability_test_plan') {
        title = 'Reliability Test Planning';
        html = `<div class="form-row"><label>Target Reliability (%)</label><input type="number" id="dlg-rel-target" value="90" min="50" max="99.99" step="0.1"></div>
            <div class="form-row"><label>Confidence Level (%)</label><input type="number" id="dlg-rel-conf" value="95" min="50" max="99.99" step="0.1"></div>
            <div class="form-row"><label>Test Duration (hours/cycles)</label><input type="number" id="dlg-rel-dur" value="1000" min="1" step="any"></div>
            <div class="form-row"><label>Distribution</label><select id="dlg-rel-dist"><option value="exponential">Exponential</option><option value="weibull">Weibull</option></select></div>
            <div id="dlg-rel-beta-row" class="form-row" style="display:none"><label>Weibull Î² (shape)</label><input type="number" id="dlg-rel-beta" value="2" min="0.1" step="0.1"></div>`;
        // Show/hide beta field
        setTimeout(() => {
            const distSel = document.getElementById('dlg-rel-dist');
            if (distSel) distSel.addEventListener('change', () => {
                document.getElementById('dlg-rel-beta-row').style.display = distSel.value === 'weibull' ? '' : 'none';
            });
        }, 100);
        onRun = () => {
            const config = {
                target_reliability: parseFloat(document.getElementById('dlg-rel-target').value) / 100,
                confidence: parseFloat(document.getElementById('dlg-rel-conf').value) / 100,
                test_duration: parseFloat(document.getElementById('dlg-rel-dur').value),
                distribution: document.getElementById('dlg-rel-dist').value
            };
            if (config.distribution === 'weibull') config.beta = parseFloat(document.getElementById('dlg-rel-beta').value) || 2;
            closeModal();
            runStatsAnalysis('reliability', 'reliability_test_plan', config, 'Reliability Test Plan');
        };
    } else if (analysisId === 'distribution_id') {
        title = 'Distribution Identification';
        html = `<div class="form-row"><label>Time/Life Column</label><select id="dlg-rel-time">${numOpts}</select></div>
            <p style="color:#aaa;font-size:0.85em;margin-top:8px">Fits Normal, Lognormal, Weibull, Exponential, Gamma, and Loglogistic. Ranks by goodness-of-fit.</p>`;
        onRun = () => {
            closeModal();
            runStatsAnalysis('reliability', 'distribution_id', { time: document.getElementById('dlg-rel-time').value }, 'Distribution Identification');
        };
    } else if (analysisId === 'accelerated_life') {
        title = 'Accelerated Life Testing';
        html = `<div class="form-row"><label>Time-to-Failure Column</label><select id="dlg-rel-time">${numOpts}</select></div>
            <div class="form-row"><label>Stress Level Column</label><select id="dlg-rel-stress">${numOpts}</select></div>
            <div class="form-row"><label>Use-Condition Stress</label><input type="number" id="dlg-rel-use" value="25" step="any"></div>
            <div class="form-row"><label>Model</label><select id="dlg-rel-model">
                <option value="arrhenius">Arrhenius (temperature)</option>
                <option value="inverse_power">Inverse Power Law (stress)</option>
            </select></div>`;
        onRun = () => {
            closeModal();
            runStatsAnalysis('reliability', 'accelerated_life', {
                time: document.getElementById('dlg-rel-time').value,
                stress: document.getElementById('dlg-rel-stress').value,
                use_stress: parseFloat(document.getElementById('dlg-rel-use').value) || 25,
                model: document.getElementById('dlg-rel-model').value
            }, 'Accelerated Life Test');
        };
    } else if (analysisId === 'repairable_systems') {
        title = 'Repairable Systems (Crow-AMSAA)';
        const allCols = getAllColumns();
        const allOpts = allCols.map(c => `<option value="${c}">${c}</option>`).join('');
        html = `<div class="form-row"><label>Event Time Column</label><select id="dlg-rel-time">${numOpts}</select></div>
            <div class="form-row"><label>System ID Column (optional)</label><select id="dlg-rel-sys"><option value="">Single system</option>${allOpts}</select></div>`;
        onRun = () => {
            const config = { time: document.getElementById('dlg-rel-time').value };
            const sys = document.getElementById('dlg-rel-sys').value;
            if (sys) config.system = sys;
            closeModal();
            runStatsAnalysis('reliability', 'repairable_systems', config, 'Repairable Systems');
        };
    } else if (analysisId === 'warranty') {
        title = 'Warranty Prediction';
        html = `<div class="form-row"><label>Time-to-Return Column (age at failure)</label><select id="dlg-rel-time">${numOpts}</select></div>
            <div class="form-row"><label>Warranty Period (days)</label><input type="number" id="dlg-rel-wp" value="365" min="1"></div>
            <div class="form-row"><label>Fleet Size (total units sold)</label><input type="number" id="dlg-rel-fleet" value="1000" min="1"></div>`;
        onRun = () => {
            closeModal();
            runStatsAnalysis('reliability', 'warranty', {
                time: document.getElementById('dlg-rel-time').value,
                warranty_period: parseFloat(document.getElementById('dlg-rel-wp').value) || 365,
                fleet_size: parseInt(document.getElementById('dlg-rel-fleet').value) || 1000
            }, 'Warranty Prediction');
        };
    } else if (analysisId === 'competing_risks') {
        title = 'Competing Risks Analysis';
        html = `<div class="form-row"><label>Time Column</label><select id="dlg-rel-time">${numOpts}</select></div>
            <div class="form-row"><label>Event/Failure Mode Column</label><select id="dlg-rel-event">${allOpts}</select></div>
            <p class="form-hint">Event column: 0 or "censored" = censored, other values = failure mode types.</p>`;
        onRun = () => {
            closeModal();
            runStatsAnalysis('reliability', 'competing_risks', {
                time: document.getElementById('dlg-rel-time').value,
                event: document.getElementById('dlg-rel-event').value
            }, 'Competing Risks');
        };
    }

    openModal(title, html, 'Run Analysis', onRun);
}

// =============================================================================
// GLM Dialog (multi-factor support)
// =============================================================================
function openGLMDialog() {
    if (!uploadedData) { alert('Please import a data file first'); return; }
    const numCols = getNumericColumns();
    const allCols = Object.keys(uploadedData[0] || {});
    const numOpts = numCols.map(c => `<option value="${c}">${c}</option>`).join('');
    const allOpts = allCols.map(c => `<option value="${c}">${c}</option>`).join('');
    const html = `
        <div class="form-row"><label>Response Variable</label><select id="dlg-glm-response">${numOpts}</select></div>
        <div class="form-row"><label>Fixed Factors (hold Ctrl to select multiple)</label><select id="dlg-glm-fixed" multiple size="4">${allOpts}</select></div>
        <div class="form-row"><label>Covariates (hold Ctrl to select multiple)</label><select id="dlg-glm-cov" multiple size="3"><option value="">None</option>${numOpts}</select></div>
        <div class="form-row"><label>Random Factor (optional)</label><select id="dlg-glm-random"><option value="">None</option>${allOpts}</select></div>
        <div class="form-row"><label style="display:flex;align-items:center;gap:0.5rem"><input type="checkbox" id="dlg-glm-fxcov" checked> Include Factor Ã Covariate interactions (homogeneity of slopes test)</label></div>
        <div class="form-row"><label>Confidence Level (%)</label><input type="number" id="dlg-glm-conf" value="95" min="80" max="99.9" step="0.1"></div>
        <p class="form-hint">ANOVA: factors only. ANCOVA: factors + covariates. Regression: covariates only.</p>`;
    openModal('General Linear Model (GLM)', html, 'Run GLM', () => {
        const fixedSel = document.getElementById('dlg-glm-fixed');
        const fixed = Array.from(fixedSel.selectedOptions).map(o => o.value);
        const covSel = document.getElementById('dlg-glm-cov');
        const covs = Array.from(covSel.selectedOptions).map(o => o.value).filter(v => v);
        const random = document.getElementById('dlg-glm-random').value;
        const config = {
            response: document.getElementById('dlg-glm-response').value,
            fixed_factors: fixed,
            random_factors: random ? [random] : [],
            covariates: covs,
            factor_covariate_interactions: document.getElementById('dlg-glm-fxcov').checked,
            conf: parseFloat(document.getElementById('dlg-glm-conf').value) || 95
        };
        closeModal();
        // Determine label
        const hasF = fixed.length > 0, hasC = covs.length > 0;
        const label = hasF && hasC ? 'ANCOVA' : hasF ? 'ANOVA (GLM)' : hasC ? 'Regression (GLM)' : 'GLM';
        runStatsAnalysis('stats', 'glm', config, label);
    });
}

// =============================================================================
// Factor Analysis Dialog
// =============================================================================
function openFactorAnalysisDialog() {
    if (!uploadedData) { alert('Please import a data file first'); return; }
    const numCols = getNumericColumns();
    const numOpts = numCols.map(c => `<option value="${c}">${c}</option>`).join('');
    const html = `
        <div class="form-row"><label>Variables (hold Ctrl to select multiple)</label><select id="dlg-fa-vars" multiple size="6">${numOpts}</select></div>
        <div class="form-row"><label>Number of Factors</label><select id="dlg-fa-nf"><option value="">Auto (Kaiser criterion)</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select></div>
        <div class="form-row"><label>Rotation</label><select id="dlg-fa-rot"><option value="varimax">Varimax (recommended)</option><option value="none">None</option></select></div>`;
    openModal('Factor Analysis', html, 'Run', () => {
        const varSel = document.getElementById('dlg-fa-vars');
        const vars = Array.from(varSel.selectedOptions).map(o => o.value);
        const nf = document.getElementById('dlg-fa-nf').value;
        const config = {
            variables: vars.length > 0 ? vars : numCols,
            rotation: document.getElementById('dlg-fa-rot').value,
        };
        if (nf) config.n_factors = parseInt(nf);
        closeModal();
        runStatsAnalysis('ml', 'factor_analysis', config, 'Factor Analysis');
    });
}

// =============================================================================
// Prepare Tab Dialogs
// =============================================================================
function openProfileDialog() {
    if (!dswDataId) { alert('Please import a data file first'); return; }
    runStatsAnalysis('stats', 'data_profile', {}, 'Data Profile');
}

function openMissingDialog() {
    if (!dswDataId) { alert('Please import a data file first'); return; }
    runStatsAnalysis('stats', 'missing_data_analysis', {}, 'Missing Data Analysis');
}

function openDuplicateDialog() {
    if (!dswDataId) { alert('Please import a data file first'); return; }
    const allCols = Object.keys((uploadedData && uploadedData[0]) || {});
    const colOpts = allCols.map(c => `<option value="${c}">${c}</option>`).join('');
    const html = `
        <div class="form-row"><label>Detection Mode</label>
            <select id="dlg-dup-mode" onchange="document.getElementById('dlg-dup-subset').style.display=this.value==='subset'?'block':'none'">
                <option value="exact">Exact (all columns)</option><option value="subset">Subset (selected columns)</option></select></div>
        <div class="form-row" id="dlg-dup-subset" style="display:none;">
            <label>Columns for Subset Mode (Ctrl+click)</label><select id="dlg-dup-cols" multiple size="6">${colOpts}</select></div>`;
    openModal('Duplicate Detection', html, 'Find Duplicates', () => {
        const mode = document.getElementById('dlg-dup-mode').value;
        const config = { mode };
        if (mode === 'subset') {
            config.subset_columns = Array.from(document.getElementById('dlg-dup-cols').selectedOptions).map(o => o.value);
            if (!config.subset_columns.length) { alert('Select at least one column'); return; }
        }
        closeModal();
        runStatsAnalysis('stats', 'duplicate_analysis', config, 'Duplicate Analysis');
    });
}

function openOutlierDialog() {
    if (!dswDataId) { alert('Please import a data file first'); return; }
    const numCols = getNumericColumns();
    if (!numCols.length) { alert('No numeric columns found'); return; }
    const colOpts = numCols.map(c => `<option value="${c}">${c}</option>`).join('');
    const html = `
        <div class="form-row"><label>Columns (Ctrl+click for multiple)</label><select id="dlg-out-cols" multiple size="5">${colOpts}</select></div>
        <div class="form-row"><label>Methods</label>
            <label style="display:block;margin:3px 0"><input type="checkbox" id="dlg-out-iqr" checked> IQR Method</label>
            <label style="display:block;margin:3px 0"><input type="checkbox" id="dlg-out-z" checked> Z-Score (|z| > threshold)</label>
            <label style="display:block;margin:3px 0"><input type="checkbox" id="dlg-out-mad" checked> Modified Z-Score (MAD)</label>
            <label style="display:block;margin:3px 0"><input type="checkbox" id="dlg-out-mahal"> Mahalanobis Distance (multivariate, needs 2+ cols)</label></div>
        <div class="form-row-inline">
            <div class="form-row"><label>IQR Multiplier</label><input type="number" id="dlg-out-iqr-m" value="1.5" step="0.1" min="0.5" max="5"></div>
            <div class="form-row"><label>Z-Score Threshold</label><input type="number" id="dlg-out-z-t" value="3" step="0.5" min="1" max="10"></div></div>`;
    openModal('Outlier Analysis', html, 'Detect Outliers', () => {
        const cols = Array.from(document.getElementById('dlg-out-cols').selectedOptions).map(o => o.value);
        if (!cols.length) { alert('Select at least one column'); return; }
        const methods = [];
        if (document.getElementById('dlg-out-iqr').checked) methods.push('iqr');
        if (document.getElementById('dlg-out-z').checked) methods.push('zscore');
        if (document.getElementById('dlg-out-mad').checked) methods.push('modified_zscore');
        if (document.getElementById('dlg-out-mahal').checked) methods.push('mahalanobis');
        if (!methods.length) { alert('Select at least one method'); return; }
        closeModal();
        runStatsAnalysis('stats', 'outlier_analysis', {
            columns: cols, methods,
            iqr_multiplier: parseFloat(document.getElementById('dlg-out-iqr-m').value),
            zscore_threshold: parseFloat(document.getElementById('dlg-out-z-t').value)
        }, 'Outlier Analysis');
    });
}

function openEncodeDialog() {
    if (!dswDataId) { alert('Please import a data file first'); return; }
    const allCols = Object.keys((uploadedData && uploadedData[0]) || {});
    const colOpts = allCols.map(c => `<option value="${c}">${c}</option>`).join('');
    const html = `
        <div class="form-row"><label>Columns (Ctrl+click for multiple)</label><select id="dlg-enc-cols" multiple size="5">${colOpts}</select></div>
        <div class="form-row"><label>Method</label><select id="dlg-enc-method"><option value="onehot">One-Hot Encoding</option><option value="label">Label Encoding (ordinal)</option></select></div>
        <div class="form-row"><label style="display:flex;align-items:center;gap:0.5rem"><input type="checkbox" id="dlg-enc-drop"> Drop first category (avoid multicollinearity)</label></div>`;
    openModal('Encode Categorical Variables', html, 'Transform', () => {
        const cols = Array.from(document.getElementById('dlg-enc-cols').selectedOptions).map(o => o.value);
        if (!cols.length) { alert('Select at least one column'); return; }
        closeModal();
        runPrepareTransform('encode', { columns: cols, method: document.getElementById('dlg-enc-method').value, drop_first: document.getElementById('dlg-enc-drop').checked });
    });
}

function openScaleDialog() {
    if (!dswDataId) { alert('Please import a data file first'); return; }
    const numCols = getNumericColumns();
    const colOpts = numCols.map(c => `<option value="${c}">${c}</option>`).join('');
    const html = `
        <div class="form-row"><label>Columns (Ctrl+click for multiple)</label><select id="dlg-scale-cols" multiple size="5">${colOpts}</select></div>
        <div class="form-row"><label>Method</label><select id="dlg-scale-method"><option value="zscore">Z-Score (mean=0, std=1)</option><option value="minmax">Min-Max [0, 1]</option><option value="robust">Robust (IQR-based)</option></select></div>`;
    openModal('Scale Features', html, 'Transform', () => {
        const cols = Array.from(document.getElementById('dlg-scale-cols').selectedOptions).map(o => o.value);
        if (!cols.length) { alert('Select at least one column'); return; }
        closeModal();
        runPrepareTransform('scale', { columns: cols, method: document.getElementById('dlg-scale-method').value });
    });
}

function openBinDialog() {
    if (!dswDataId) { alert('Please import a data file first'); return; }
    const numCols = getNumericColumns();
    const colOpts = numCols.map(c => `<option value="${c}">${c}</option>`).join('');
    const html = `
        <div class="form-row"><label>Column</label><select id="dlg-bin-col">${colOpts}</select></div>
        <div class="form-row"><label>Method</label>
            <select id="dlg-bin-method" onchange="document.getElementById('dlg-bin-nbins').style.display=this.value==='custom'?'none':'block';document.getElementById('dlg-bin-custom').style.display=this.value==='custom'?'block':'none'">
                <option value="equal_width">Equal Width</option><option value="equal_frequency">Equal Frequency (quantiles)</option><option value="custom">Custom Breakpoints</option></select></div>
        <div class="form-row" id="dlg-bin-nbins"><label>Number of Bins</label><input type="number" id="dlg-bin-n" value="5" min="2" max="20"></div>
        <div class="form-row" id="dlg-bin-custom" style="display:none"><label>Breakpoints (comma-separated)</label><input type="text" id="dlg-bin-breaks" placeholder="e.g., 0, 18, 35, 50, 65, 100"></div>
        <div class="form-row"><label>Labels (optional, comma-separated)</label><input type="text" id="dlg-bin-labels" placeholder="e.g., low, medium, high"></div>`;
    openModal('Bin Numeric Variable', html, 'Transform', () => {
        const col = document.getElementById('dlg-bin-col').value;
        const method = document.getElementById('dlg-bin-method').value;
        const config = { column: col, method };
        if (method === 'custom') {
            const breaks = document.getElementById('dlg-bin-breaks').value.split(',').map(b => parseFloat(b.trim())).filter(b => !isNaN(b));
            if (breaks.length < 2) { alert('Provide at least 2 breakpoints'); return; }
            config.bins = breaks;
        } else {
            config.n_bins = parseInt(document.getElementById('dlg-bin-n').value);
        }
        const labels = document.getElementById('dlg-bin-labels').value.trim();
        if (labels) config.labels = labels.split(',').map(l => l.trim());
        closeModal();
        runPrepareTransform('bin', config);
    });
}

function openMetaDialog() {
    if (!dswDataId) { alert('Please import a data file first'); return; }
    const numCols = getNumericColumns();
    const allCols = Object.keys((uploadedData && uploadedData[0]) || {});
    const numOpts = numCols.map(c => `<option value="${c}">${c}</option>`).join('');
    const allOpts = allCols.map(c => `<option value="${c}">${c}</option>`).join('');
    const html = `
        <div class="form-row"><label>Data Mode</label>
            <select id="dlg-meta-mode" onchange="document.getElementById('dlg-meta-pre').style.display=this.value==='precomputed'?'block':'none';document.getElementById('dlg-meta-raw').style.display=this.value==='raw'?'block':'none'">
                <option value="precomputed">Precomputed Effect Sizes</option><option value="raw">Raw Study Data (auto-compute Cohen's d)</option></select></div>
        <div id="dlg-meta-pre">
            <div class="form-row"><label>Effect Size Column</label><select id="dlg-meta-eff">${numOpts}</select></div>
            <div class="form-row"><label>Standard Error Column</label><select id="dlg-meta-se">${numOpts}</select></div>
            <div class="form-row"><label>Study Label Column</label><select id="dlg-meta-study">${allOpts}</select></div></div>
        <div id="dlg-meta-raw" style="display:none">
            <p class="form-hint">Mean, SD, n for two groups per study:</p>
            <div class="form-row-inline"><div class="form-row"><label>Grp 1 Mean</label><select id="dlg-meta-m1">${numOpts}</select></div><div class="form-row"><label>Grp 1 SD</label><select id="dlg-meta-s1">${numOpts}</select></div><div class="form-row"><label>Grp 1 n</label><select id="dlg-meta-n1">${numOpts}</select></div></div>
            <div class="form-row-inline"><div class="form-row"><label>Grp 2 Mean</label><select id="dlg-meta-m2">${numOpts}</select></div><div class="form-row"><label>Grp 2 SD</label><select id="dlg-meta-s2">${numOpts}</select></div><div class="form-row"><label>Grp 2 n</label><select id="dlg-meta-n2">${numOpts}</select></div></div>
            <div class="form-row"><label>Study Label Column</label><select id="dlg-meta-study2">${allOpts}</select></div></div>
        <div class="form-row"><label>Subgroup Column (optional)</label><select id="dlg-meta-sub"><option value="">None</option>${allOpts}</select></div>`;
    openModal('Meta-Analysis', html, 'Run Meta-Analysis', () => {
        const mode = document.getElementById('dlg-meta-mode').value;
        const config = { mode };
        if (mode === 'precomputed') {
            config.effect_col = document.getElementById('dlg-meta-eff').value;
            config.se_col = document.getElementById('dlg-meta-se').value;
            config.study_col = document.getElementById('dlg-meta-study').value;
        } else {
            config.mean1_col = document.getElementById('dlg-meta-m1').value;
            config.sd1_col = document.getElementById('dlg-meta-s1').value;
            config.n1_col = document.getElementById('dlg-meta-n1').value;
            config.mean2_col = document.getElementById('dlg-meta-m2').value;
            config.sd2_col = document.getElementById('dlg-meta-s2').value;
            config.n2_col = document.getElementById('dlg-meta-n2').value;
            config.study_col = document.getElementById('dlg-meta-study2').value;
        }
        const sub = document.getElementById('dlg-meta-sub').value;
        if (sub) config.subgroup_col = sub;
        closeModal();
        runStatsAnalysis('stats', 'meta_analysis', config, 'Meta-Analysis');
    });
}

function openEffectSizeDialog() {
    const html = `
        <div class="form-row"><label>Effect Size Type</label>
            <select id="dlg-es-type" onchange="const m=this.value;document.getElementById('dlg-es-means').style.display=['cohens_d','hedges_g','glass_delta'].includes(m)?'block':'none';document.getElementById('dlg-es-table').style.display=['odds_ratio','risk_ratio'].includes(m)?'block':'none'">
                <option value="cohens_d">Cohen's d</option><option value="hedges_g">Hedges' g</option><option value="glass_delta">Glass's delta</option>
                <option value="odds_ratio">Odds Ratio</option><option value="risk_ratio">Risk Ratio</option></select></div>
        <div id="dlg-es-means">
            <p class="form-hint">Two-group summary statistics:</p>
            <div class="form-row-inline"><div class="form-row"><label>Group 1 Mean</label><input type="number" id="dlg-es-m1" step="any"></div><div class="form-row"><label>SD</label><input type="number" id="dlg-es-s1" step="any" min="0"></div><div class="form-row"><label>n</label><input type="number" id="dlg-es-n1" min="1"></div></div>
            <div class="form-row-inline"><div class="form-row"><label>Group 2 Mean</label><input type="number" id="dlg-es-m2" step="any"></div><div class="form-row"><label>SD</label><input type="number" id="dlg-es-s2" step="any" min="0"></div><div class="form-row"><label>n</label><input type="number" id="dlg-es-n2" min="1"></div></div></div>
        <div id="dlg-es-table" style="display:none">
            <p class="form-hint">2x2 contingency table:</p>
            <table style="margin:auto;border-collapse:collapse"><tr><td></td><td style="padding:4px;font-weight:bold">Outcome+</td><td style="padding:4px;font-weight:bold">Outcome-</td></tr>
            <tr><td style="padding:4px;font-weight:bold">Exposed</td><td><input type="number" id="dlg-es-a" style="width:60px" min="0"></td><td><input type="number" id="dlg-es-b" style="width:60px" min="0"></td></tr>
            <tr><td style="padding:4px;font-weight:bold">Not Exposed</td><td><input type="number" id="dlg-es-c" style="width:60px" min="0"></td><td><input type="number" id="dlg-es-d" style="width:60px" min="0"></td></tr></table></div>`;
    openModal('Effect Size Calculator', html, 'Calculate', () => {
        const t = document.getElementById('dlg-es-type').value;
        const config = { effect_type: t };
        if (['cohens_d','hedges_g','glass_delta'].includes(t)) {
            config.mean1 = parseFloat(document.getElementById('dlg-es-m1').value);
            config.sd1 = parseFloat(document.getElementById('dlg-es-s1').value);
            config.n1 = parseInt(document.getElementById('dlg-es-n1').value);
            config.mean2 = parseFloat(document.getElementById('dlg-es-m2').value);
            config.sd2 = parseFloat(document.getElementById('dlg-es-s2').value);
            config.n2 = parseInt(document.getElementById('dlg-es-n2').value);
        } else {
            config.a = parseInt(document.getElementById('dlg-es-a').value);
            config.b = parseInt(document.getElementById('dlg-es-b').value);
            config.c = parseInt(document.getElementById('dlg-es-c').value);
            config.d = parseInt(document.getElementById('dlg-es-d').value);
        }
        closeModal();
        runStatsAnalysis('stats', 'effect_size_calculator', config, 'Effect Size');
    });
}

async function runPrepareTransform(tool, config) {
    showLoading(true, 'Transforming data...');
    try {
        const { response, data } = await apiPost('/api/dsw/transform/', { tool, config, data_id: dswDataId });
        showLoading(false);
        if (data.error) { alert(data.error); return; }
        dswDataId = data.data_id;
        if (data.preview) { uploadedData = data.preview; displayDataTable(uploadedData); }
        showToast(data.message || 'Transform applied');
    } catch (err) { showLoading(false); alert('Transform failed: ' + err.message); }
}

// =============================================================================
// SPC: Capability Study
// =============================================================================
function openCapabilityDialog() {
    const numCols = getNumericColumns();
    const colOptions = numCols.map(c => `<option value="${c}">${c}</option>`).join('');
    const hasData = uploadedData != null;

    let html = '';
    if (hasData) {
        html += `<div class="form-row"><label>Value Column</label><select id="dlg-cap-col">${colOptions}</select></div>`;
    }
    html += `<div class="form-row"><label>Or enter data manually</label><textarea id="dlg-cap-data" rows="4" placeholder="Measurements separated by commas or newlines"></textarea></div>`;
    html += `<div class="form-row-inline">
        <div class="form-row"><label>USL *</label><input type="number" id="dlg-cap-usl" step="any" required></div>
        <div class="form-row"><label>LSL *</label><input type="number" id="dlg-cap-lsl" step="any" required></div>
    </div>`;
    html += `<div class="form-row-inline">
        <div class="form-row"><label>Target</label><input type="number" id="dlg-cap-target" step="any" placeholder="Midpoint"></div>
        <div class="form-row"><label>Subgroup Size</label><input type="number" id="dlg-cap-sg" value="1" min="1"></div>
    </div>`;

    openModal('Process Capability Study', html, 'Analyze', runCapabilityStudy);
}

async function runCapabilityStudy() {
    const usl = document.getElementById('dlg-cap-usl').value;
    const lsl = document.getElementById('dlg-cap-lsl').value;
    if (!usl || !lsl) { alert('USL and LSL are required'); return; }

    let body = { usl: parseFloat(usl), lsl: parseFloat(lsl) };
    const target = document.getElementById('dlg-cap-target').value;
    if (target) body.target = parseFloat(target);

    const colEl = document.getElementById('dlg-cap-col');
    if (colEl && colEl.value && cacheKey) {
        body.cache_key = cacheKey;
        body.value_column = colEl.value;
        body.analysis_type = 'capability';
        closeModal();
        showLoading(true, 'Running capability study...');
        try {
            const { response, data } = await apiPost('/api/spc/analyze/', body);
            showLoading(false);
            if (response.ok && data.success) renderCapabilityOutput(data.capability);
            else alert(data.error || 'Failed');
        } catch (err) { showLoading(false); alert('Error: ' + err.message); }
        return;
    }

    const dataText = document.getElementById('dlg-cap-data').value.trim();
    if (!dataText) { alert('Enter data or select a column'); return; }
    body.data = dataText.split(/[,\n]/).map(v => parseFloat(v.trim())).filter(v => !isNaN(v));
    body.subgroup_size = parseInt(document.getElementById('dlg-cap-sg').value) || 1;

    closeModal();
    showLoading(true, 'Running capability study...');
    try {
        const { response, data } = await apiPost('/api/spc/capability/', body);
        showLoading(false);
        if (response.ok) renderCapabilityOutput(data.capability);
        else alert(data.error || 'Failed');
    } catch (err) { showLoading(false); alert('Error: ' + err.message); }
}

function renderCapabilityOutput(cap) {
    const cpk = cap.cpk != null ? cap.cpk : 0;
    const cpkClass = cpk >= 1.33 ? 'good' : (cpk >= 1.0 ? 'marginal' : 'poor');
    const html = `
        <div class="metric-grid">
            <div class="metric-card highlight"><div class="metric-value">${fmt(cap.cpk, 3)}</div><div class="metric-label">Cpk</div></div>
            <div class="metric-card"><div class="metric-value">${fmt(cap.cp, 3)}</div><div class="metric-label">Cp</div></div>
            <div class="metric-card"><div class="metric-value">${fmt(cap.ppk, 3)}</div><div class="metric-label">Ppk</div></div>
            <div class="metric-card"><div class="metric-value">${fmt(cap.pp, 3)}</div><div class="metric-label">Pp</div></div>
        </div>
        <div class="metric-grid">
            <div class="metric-card"><div class="metric-value">${fmt(cap.sigma_level, 2)}</div><div class="metric-label">Sigma Level</div></div>
            <div class="metric-card"><div class="metric-value">${fmt(cap.dpmo, 0)}</div><div class="metric-label">DPMO</div></div>
            <div class="metric-card"><div class="metric-value">${fmt(cap.yield_percent, 2)}%</div><div class="metric-label">Yield</div></div>
            <div class="metric-card"><div class="metric-value">${cap.n_samples || 'â'}</div><div class="metric-label">n</div></div>
        </div>
        <div class="interpretation ${cpkClass}">${cap.interpretation || ''}</div>`;
    addOutput('Capability Study', html);
}

// =============================================================================
// SPC: Gage R&R
// =============================================================================
function openGageRRDialog() {
    if (!uploadedData) { alert('Please import a data file first'); return; }
    const numCols = getNumericColumns();
    const allCols = getAllColumns();
    const numOpts = numCols.map(c => `<option value="${c}">${c}</option>`).join('');
    const allOpts = allCols.map(c => `<option value="${c}">${c}</option>`).join('');

    const html = `
        <div class="form-row"><label>Measurement Column</label>
            <select id="dlg-grr-meas">${numOpts}</select>
        </div>
        <div class="form-row"><label>Part Column</label>
            <select id="dlg-grr-part">${allOpts}</select>
        </div>
        <div class="form-row"><label>Operator Column</label>
            <select id="dlg-grr-op">${allOpts}</select>
        </div>
        <div class="form-row"><label>Process Tolerance (optional)</label>
            <input type="number" id="dlg-grr-tol" step="any" placeholder="USL - LSL">
            <small>For %Tolerance calculation</small>
        </div>
        <div class="form-row" style="margin-top:8px">
            <label>Study Type</label>
            <select id="dlg-grr-type">
                <option value="gage_rr">Crossed (standard)</option>
                <option value="gage_rr_nested">Nested (destructive)</option>
            </select>
        </div>`;
    openModal('Gage R&R Study', html, 'Run Study', () => {
        const config = {
            measurement: document.getElementById('dlg-grr-meas').value,
            part: document.getElementById('dlg-grr-part').value,
            operator: document.getElementById('dlg-grr-op').value
        };
        const tol = document.getElementById('dlg-grr-tol').value;
        if (tol) config.tolerance = parseFloat(tol);
        const studyType = document.getElementById('dlg-grr-type').value;
        closeModal();
        runStatsAnalysis('stats', studyType, config, studyType === 'gage_rr_nested' ? 'Nested Gage R&R' : 'Gage R&R Study');
    });
}

// =============================================================================
// SPC: Data Summary
// =============================================================================
async function runSummary() {
    if (!cacheKey) { alert('Please import a data file first'); return; }
    const numCols = getNumericColumns();
    if (numCols.length === 0) { alert('No numeric columns found'); return; }

    const checks = numCols.map(c => `<label><input type="checkbox" value="${c}" checked> ${c}</label>`).join('');
    const html = `
        <div class="form-row"><label>Select columns to summarize:</label>
            <div class="checkbox-grid" id="summary-checks">
                <div class="select-actions">
                    <a onclick="document.querySelectorAll('#summary-checks input').forEach(c=>c.checked=true)">Select All</a>
                    <a onclick="document.querySelectorAll('#summary-checks input').forEach(c=>c.checked=false)">Clear All</a>
                </div>
                ${checks}
            </div>
        </div>`;
    openModal('Descriptive Statistics', html, 'Calculate', () => {
        const selected = Array.from(document.querySelectorAll('#summary-checks input:checked')).map(c => c.value);
        if (selected.length === 0) { alert('Select at least one column'); return; }
        closeModal();
        if (selected.length === 1) {
            fetchAndRenderSummary(selected[0]);
        } else {
            runSummaryAll(selected);
        }
    });
}

async function fetchAndRenderSummary(colName) {
    showLoading(true, `Summarizing ${colName}...`);
    try {
        const { response, data } = await apiPost('/api/spc/analyze/', {
            cache_key: cacheKey, value_column: colName, analysis_type: 'summary'
        });
        showLoading(false);
        if (response.ok && data.success) renderSummaryOutput(colName, data.summary);
        else alert(data.error || 'Failed');
    } catch (err) { showLoading(false); alert('Error: ' + err.message); }
}

async function runSummaryAll(cols) {
    showLoading(true, 'Summarizing all columns...');
    let rows = [];
    for (const col of cols) {
        try {
            const { response, data } = await apiPost('/api/spc/analyze/', {
                cache_key: cacheKey, value_column: col, analysis_type: 'summary'
            });
            if (response.ok && data.success) rows.push({ col, s: data.summary });
        } catch (e) { /* skip failed columns */ }
    }
    showLoading(false);
    if (rows.length === 0) { alert('No summaries returned'); return; }

    let html = '<table class="stats-table"><thead><tr><th>Statistic</th>';
    rows.forEach(r => html += `<th>${r.col}</th>`);
    html += '</tr></thead><tbody>';
    const stats = [
        ['N', 'n', false], ['Mean', 'mean', true], ['Median', 'median', true],
        ['Std Dev', 'std_dev', true], ['Min', 'min_val', true], ['Max', 'max_val', true],
        ['Range', 'range_val', true], ['Q1', 'q1', true], ['Q3', 'q3', true],
        ['IQR', 'iqr', true], ['Skewness', 'skewness', true], ['Kurtosis', 'kurtosis', true]
    ];
    for (const [label, key, doFmt] of stats) {
        html += `<tr><td><strong>${label}</strong></td>`;
        rows.forEach(r => {
            const v = r.s[key];
            html += `<td>${doFmt && v != null ? Number(v).toFixed(4) : (v != null ? v : 'â')}</td>`;
        });
        html += '</tr>';
    }
    html += '</tbody></table>';
    addOutput('Summary: All Columns', html);
}

function renderSummaryOutput(colName, s) {
    const html = `<pre class="stats-summary">Variable: ${colName}
ââââââââââââââââââââââ
N        = ${s.n}
Mean     = ${fmt(s.mean)}
Median   = ${fmt(s.median)}
Std Dev  = ${fmt(s.std_dev)}
Min      = ${fmt(s.min_val)}
Max      = ${fmt(s.max_val)}
Range    = ${fmt(s.range_val)}
Q1       = ${fmt(s.q1)}
Q3       = ${fmt(s.q3)}
IQR      = ${fmt(s.iqr)}
Skewness = ${fmt(s.skewness)}
Kurtosis = ${fmt(s.kurtosis)}</pre>`;
    addOutput(`Summary: ${colName}`, html);
}

// =============================================================================
// GRAPHS: Histogram, Scatter, Boxplot, Time Series
// =============================================================================
function openGraphDialog(graphType) {
    if (!uploadedData) { alert('Please import a data file first'); return; }
    const numCols = getNumericColumns();
    const allCols = getAllColumns();
    const numOpts = numCols.map(c => `<option value="${c}">${c}</option>`).join('');
    const allOpts = allCols.map(c => `<option value="${c}">${c}</option>`).join('');

    let html = '';
    if (graphType === 'histogram') {
        html = `<div class="form-row"><label>Variable</label><select id="dlg-graph-var">${numOpts}</select></div>
            <div class="form-row"><label>Number of Bins</label><input type="number" id="dlg-graph-bins" value="0" min="0" placeholder="0 = auto"></div>
            <div class="form-row"><label><input type="checkbox" id="dlg-graph-density" checked style="width:auto;margin-right:0.5rem;">Overlay density curve</label></div>`;
        openModal('Histogram', html, 'Plot', () => {
            const col = document.getElementById('dlg-graph-var').value;
            const bins = parseInt(document.getElementById('dlg-graph-bins').value) || 0;
            const density = document.getElementById('dlg-graph-density').checked;
            closeModal();
            renderGraph('histogram', { col, bins, density });
        });
    } else if (graphType === 'density') {
        html = `<div class="form-row"><label>Variable</label><select id="dlg-graph-var">${numOpts}</select></div>
            <div class="form-row"><label>Group By (optional)</label><select id="dlg-graph-group"><option value="">None</option>${allOpts}</select></div>`;
        openModal('Density Plot', html, 'Plot', () => {
            const col = document.getElementById('dlg-graph-var').value;
            const group = document.getElementById('dlg-graph-group').value;
            closeModal();
            renderGraph('density', { col, group });
        });
    } else if (graphType === 'scatter') {
        html = `<div class="form-row"><label>X Variable</label><select id="dlg-graph-x">${numOpts}</select></div>
            <div class="form-row"><label>Y Variable</label><select id="dlg-graph-y">${numOpts.length > 1 ? numOpts : numOpts}</select></div>
            <div class="form-row"><label>Color By (optional)</label><select id="dlg-graph-color"><option value="">None</option>${allOpts}</select></div>`;
        openModal('Scatter Plot', html, 'Plot', () => {
            const x = document.getElementById('dlg-graph-x').value;
            const y = document.getElementById('dlg-graph-y').value;
            const color = document.getElementById('dlg-graph-color').value;
            closeModal();
            renderGraph('scatter', { x, y, color });
        });
    } else if (graphType === 'boxplot') {
        html = `<div class="form-row"><label>Value Variable</label><select id="dlg-graph-val">${numOpts}</select></div>
            <div class="form-row"><label>Group By (optional)</label><select id="dlg-graph-group"><option value="">None (single box)</option>${allOpts}</select></div>`;
        openModal('Box Plot', html, 'Plot', () => {
            const val = document.getElementById('dlg-graph-val').value;
            const group = document.getElementById('dlg-graph-group').value;
            closeModal();
            renderGraph('boxplot', { val, group });
        });
    } else if (graphType === 'timeseries') {
        html = `<div class="form-row"><label>Value Variable</label><select id="dlg-graph-ts-val">${numOpts}</select></div>
            <div class="form-row"><label>Time/Index Variable (optional)</label><select id="dlg-graph-ts-time"><option value="">Row index</option>${allOpts}</select></div>`;
        openModal('Time Series Plot', html, 'Plot', () => {
            const val = document.getElementById('dlg-graph-ts-val').value;
            const time = document.getElementById('dlg-graph-ts-time').value;
            closeModal();
            renderGraph('timeseries', { val, time });
        });
    } else if (graphType === 'violin') {
        html = `<div class="form-row"><label>Variable</label><select id="dlg-graph-var">${numOpts}</select></div>
            <div class="form-row"><label>Group By (optional)</label><select id="dlg-graph-group"><option value="">None</option>${allOpts}</select></div>`;
        openModal('Violin Plot', html, 'Plot', () => {
            const col = document.getElementById('dlg-graph-var').value;
            const group = document.getElementById('dlg-graph-group').value;
            closeModal();
            renderGraph('violin', { col, group });
        });
    } else if (graphType === 'bar') {
        html = `<div class="form-row"><label>Category (X)</label><select id="dlg-graph-cat">${allOpts}</select></div>
            <div class="form-row"><label>Value (Y)</label><select id="dlg-graph-val">${numOpts}</select></div>
            <div class="form-row"><label>Group By (optional)</label><select id="dlg-graph-group"><option value="">None</option>${allOpts}</select></div>`;
        openModal('Bar Chart', html, 'Plot', () => {
            const cat = document.getElementById('dlg-graph-cat').value;
            const val = document.getElementById('dlg-graph-val').value;
            const group = document.getElementById('dlg-graph-group').value;
            closeModal();
            renderGraph('bar', { cat, val, group });
        });
    } else if (graphType === 'heatmap') {
        const checkboxes = numCols.map(c => `<label style="display:block;margin:2px 0;"><input type="checkbox" value="${c}" checked style="width:auto;margin-right:0.5rem;">${c}</label>`).join('');
        html = `<div class="form-row"><label>Numeric Columns</label><div id="dlg-heatmap-cols" style="max-height:200px;overflow-y:auto;border:1px solid #333;padding:6px;border-radius:4px;">${checkboxes}</div></div>`;
        openModal('Correlation Heatmap', html, 'Plot', () => {
            const selected = Array.from(document.querySelectorAll('#dlg-heatmap-cols input:checked')).map(cb => cb.value);
            if (selected.length < 2) { alert('Select at least 2 columns'); return; }
            closeModal();
            renderGraph('heatmap', { cols: selected });
        });
    } else if (graphType === 'bubble') {
        html = `<div class="form-row"><label>X Variable</label><select id="dlg-graph-x">${numOpts}</select></div>
            <div class="form-row"><label>Y Variable</label><select id="dlg-graph-y">${numOpts}</select></div>
            <div class="form-row"><label>Size Variable</label><select id="dlg-graph-size">${numOpts}</select></div>
            <div class="form-row"><label>Color By (optional)</label><select id="dlg-graph-color"><option value="">None</option>${allOpts}</select></div>`;
        openModal('Bubble Chart', html, 'Plot', () => {
            const x = document.getElementById('dlg-graph-x').value;
            const y = document.getElementById('dlg-graph-y').value;
            const size = document.getElementById('dlg-graph-size').value;
            const color = document.getElementById('dlg-graph-color').value;
            closeModal();
            renderGraph('bubble', { x, y, size, color });
        });
    }
}

function renderGraph(type, opts) {
    const preview = uploadedData.preview;
    const cols = uploadedData.columns.map(c => c.name);
    // Build arrays from preview data
    function getCol(name) {
        if (!preview || !name) return [];
        if (Array.isArray(preview)) return preview.map(row => row[name]);
        return preview[name] || [];
    }

    const plotId = 'graph-' + (++outputCounter);
    const html = `<div id="${plotId}" style="width:100%;min-height:400px;"></div>`;
    let plotTitle = '';
    let traces = [];
    let layout = {};

    if (type === 'histogram') {
        const vals = getCol(opts.col).filter(v => v != null && !isNaN(v)).map(Number);
        const histTrace = { x: vals, type: 'histogram', marker: { color: 'rgba(74,159,110,0.7)', line: { color: 'rgba(74,159,110,1)', width: 1 } } };
        if (opts.bins > 0) histTrace.nbinsx = opts.bins;
        if (opts.density) {
            histTrace.histnorm = 'probability density';
            traces = [histTrace, { x: vals, type: 'violin', side: 'positive', line: { color: 'rgba(232,197,71,0.9)', width: 2 }, fillcolor: 'rgba(232,197,71,0.15)', points: false, name: 'Density', yaxis: 'y', spanmode: 'hard' }];
            // KDE as a separate smooth line â Plotly violin isn't ideal on shared axis, use a simple KDE approximation
            const sorted = [...vals].sort((a, b) => a - b);
            const n = sorted.length;
            const mean = sorted.reduce((s, v) => s + v, 0) / n;
            const std = Math.sqrt(sorted.reduce((s, v) => s + (v - mean) ** 2, 0) / n);
            const bw = 1.06 * std * Math.pow(n, -0.2); // Silverman's rule
            if (bw > 0) {
                const lo = sorted[0] - 3 * bw, hi = sorted[n - 1] + 3 * bw;
                const kdeX = [], kdeY = [];
                for (let i = 0; i <= 200; i++) {
                    const x = lo + (hi - lo) * i / 200;
                    let density = 0;
                    for (const v of sorted) density += Math.exp(-0.5 * ((x - v) / bw) ** 2);
                    density /= n * bw * Math.sqrt(2 * Math.PI);
                    kdeX.push(x);
                    kdeY.push(density);
                }
                traces = [histTrace, { x: kdeX, y: kdeY, type: 'scatter', mode: 'lines', line: { color: 'rgba(232,197,71,0.9)', width: 2.5 }, name: 'Density' }];
            } else {
                traces = [histTrace];
            }
            plotTitle = 'Histogram with Density â ' + opts.col;
            layout = { xaxis: { title: opts.col }, yaxis: { title: 'Density' }, barmode: 'overlay' };
        } else {
            traces = [histTrace];
            plotTitle = 'Histogram of ' + opts.col;
            layout = { xaxis: { title: opts.col }, yaxis: { title: 'Frequency' } };
        }
    } else if (type === 'density') {
        const vals = getCol(opts.col).filter(v => v != null && !isNaN(v)).map(Number);
        const sorted = [...vals].sort((a, b) => a - b);
        const n = sorted.length;
        if (opts.group) {
            const groups = {};
            const grpVals = getCol(opts.group);
            vals.forEach((v, i) => {
                const g = String(grpVals[i] || 'other');
                if (!groups[g]) groups[g] = [];
                groups[g].push(v);
            });
            const colors = ['rgba(74,159,110,0.9)', 'rgba(58,127,143,0.9)', 'rgba(232,197,71,0.9)', 'rgba(232,149,71,0.9)', 'rgba(90,79,127,0.9)', 'rgba(208,96,96,0.9)'];
            let ci = 0;
            for (const [name, gvals] of Object.entries(groups)) {
                const gs = [...gvals].sort((a, b) => a - b);
                const gn = gs.length;
                const gm = gs.reduce((s, v) => s + v, 0) / gn;
                const gstd = Math.sqrt(gs.reduce((s, v) => s + (v - gm) ** 2, 0) / gn);
                const gbw = 1.06 * gstd * Math.pow(gn, -0.2);
                if (gbw > 0) {
                    const lo = gs[0] - 3 * gbw, hi = gs[gn - 1] + 3 * gbw;
                    const kx = [], ky = [];
                    for (let i = 0; i <= 200; i++) {
                        const x = lo + (hi - lo) * i / 200;
                        let d = 0;
                        for (const v of gs) d += Math.exp(-0.5 * ((x - v) / gbw) ** 2);
                        d /= gn * gbw * Math.sqrt(2 * Math.PI);
                        kx.push(x); ky.push(d);
                    }
                    traces.push({ x: kx, y: ky, type: 'scatter', mode: 'lines', fill: 'tozeroy', fillcolor: colors[ci % colors.length].replace('0.9', '0.15'), line: { color: colors[ci % colors.length], width: 2 }, name });
                }
                ci++;
            }
        } else {
            const mean = sorted.reduce((s, v) => s + v, 0) / n;
            const std = Math.sqrt(sorted.reduce((s, v) => s + (v - mean) ** 2, 0) / n);
            const bw = 1.06 * std * Math.pow(n, -0.2);
            if (bw > 0) {
                const lo = sorted[0] - 3 * bw, hi = sorted[n - 1] + 3 * bw;
                const kx = [], ky = [];
                for (let i = 0; i <= 200; i++) {
                    const x = lo + (hi - lo) * i / 200;
                    let d = 0;
                    for (const v of sorted) d += Math.exp(-0.5 * ((x - v) / bw) ** 2);
                    d /= n * bw * Math.sqrt(2 * Math.PI);
                    kx.push(x); ky.push(d);
                }
                traces = [{ x: kx, y: ky, type: 'scatter', mode: 'lines', fill: 'tozeroy', fillcolor: 'rgba(74,159,110,0.15)', line: { color: 'rgba(74,159,110,0.9)', width: 2.5 }, name: opts.col }];
            }
        }
        plotTitle = 'Density Plot â ' + opts.col;
        layout = { xaxis: { title: opts.col }, yaxis: { title: 'Density' } };
    } else if (type === 'scatter') {
        const xVals = getCol(opts.x);
        const yVals = getCol(opts.y);
        if (opts.color) {
            const groups = {};
            const colorVals = getCol(opts.color);
            xVals.forEach((x, i) => {
                const g = String(colorVals[i] || 'other');
                if (!groups[g]) groups[g] = { x: [], y: [] };
                groups[g].x.push(x);
                groups[g].y.push(yVals[i]);
            });
            traces = Object.entries(groups).map(([name, d]) => ({ x: d.x, y: d.y, mode: 'markers', type: 'scatter', name }));
        } else {
            traces = [{ x: xVals, y: yVals, mode: 'markers', type: 'scatter', marker: { color: 'rgba(74,159,110,0.7)' } }];
        }
        plotTitle = opts.y + ' vs ' + opts.x;
        layout = { xaxis: { title: opts.x }, yaxis: { title: opts.y } };
    } else if (type === 'boxplot') {
        if (opts.group) {
            const groups = {};
            const vals = getCol(opts.val);
            const grps = getCol(opts.group);
            vals.forEach((v, i) => {
                const g = String(grps[i] || 'other');
                if (!groups[g]) groups[g] = [];
                groups[g].push(v);
            });
            traces = Object.entries(groups).map(([name, y]) => ({ y, type: 'box', name }));
        } else {
            traces = [{ y: getCol(opts.val), type: 'box', name: opts.val, marker: { color: 'rgba(74,159,110,0.7)' } }];
        }
        plotTitle = 'Box Plot of ' + opts.val;
        layout = { yaxis: { title: opts.val } };
    } else if (type === 'timeseries') {
        const vals = getCol(opts.val);
        const xVals = opts.time ? getCol(opts.time) : vals.map((_, i) => i + 1);
        traces = [{ x: xVals, y: vals, type: 'scatter', mode: 'lines+markers', line: { color: 'rgba(74,159,110,1)' }, marker: { size: 4 } }];
        plotTitle = opts.val + ' over ' + (opts.time || 'observation');
        layout = { xaxis: { title: opts.time || 'Observation' }, yaxis: { title: opts.val } };
    } else if (type === 'violin') {
        if (opts.group) {
            const groups = {};
            const vals = getCol(opts.col).filter(v => v != null && !isNaN(v)).map(Number);
            const grps = getCol(opts.group);
            vals.forEach((v, i) => {
                const g = String(grps[i] || 'other');
                if (!groups[g]) groups[g] = [];
                groups[g].push(v);
            });
            traces = Object.entries(groups).map(([name, y]) => ({
                y, type: 'violin', name, points: 'all', jitter: 0.3, pointpos: -1.5,
                meanline: { visible: true }, marker: { size: 3 }
            }));
        } else {
            const vals = getCol(opts.col).filter(v => v != null && !isNaN(v)).map(Number);
            traces = [{ y: vals, type: 'violin', name: opts.col, points: 'all', jitter: 0.3, pointpos: -1.5,
                meanline: { visible: true }, marker: { color: 'rgba(74,159,110,0.7)', size: 3 },
                line: { color: 'rgba(74,159,110,1)' }, fillcolor: 'rgba(74,159,110,0.2)' }];
        }
        plotTitle = 'Violin Plot of ' + opts.col;
        layout = { yaxis: { title: opts.col } };
    } else if (type === 'bar') {
        const catVals = getCol(opts.cat);
        const numVals = getCol(opts.val).map(Number);
        if (opts.group) {
            const groups = {};
            const grpVals = getCol(opts.group);
            catVals.forEach((c, i) => {
                const g = String(grpVals[i] || 'other');
                if (!groups[g]) groups[g] = { x: [], y: [] };
                groups[g].x.push(c);
                groups[g].y.push(numVals[i]);
            });
            traces = Object.entries(groups).map(([name, d]) => ({ x: d.x, y: d.y, type: 'bar', name }));
        } else {
            // Aggregate: mean per category
            const agg = {};
            catVals.forEach((c, i) => {
                const key = String(c);
                if (!agg[key]) agg[key] = [];
                if (!isNaN(numVals[i])) agg[key].push(numVals[i]);
            });
            const cats = Object.keys(agg);
            const means = cats.map(k => agg[k].reduce((s, v) => s + v, 0) / agg[k].length);
            traces = [{ x: cats, y: means, type: 'bar', marker: { color: 'rgba(74,159,110,0.7)', line: { color: 'rgba(74,159,110,1)', width: 1 } } }];
        }
        plotTitle = opts.val + ' by ' + opts.cat;
        layout = { xaxis: { title: opts.cat }, yaxis: { title: opts.val }, barmode: 'group' };
    } else if (type === 'heatmap') {
        // Compute correlation matrix from preview data
        const columns = opts.cols;
        const colData = columns.map(c => getCol(c).map(Number));
        const n = colData[0].length;
        // Compute means
        const means = colData.map(d => d.reduce((s, v) => s + (isNaN(v) ? 0 : v), 0) / d.filter(v => !isNaN(v)).length);
        // Compute correlation matrix
        const corrMatrix = [];
        for (let i = 0; i < columns.length; i++) {
            const row = [];
            for (let j = 0; j < columns.length; j++) {
                let sumXY = 0, sumX2 = 0, sumY2 = 0, count = 0;
                for (let k = 0; k < n; k++) {
                    const xi = colData[i][k], xj = colData[j][k];
                    if (isNaN(xi) || isNaN(xj)) continue;
                    const di = xi - means[i], dj = xj - means[j];
                    sumXY += di * dj; sumX2 += di * di; sumY2 += dj * dj; count++;
                }
                row.push(sumX2 > 0 && sumY2 > 0 ? Math.round(sumXY / Math.sqrt(sumX2 * sumY2) * 1000) / 1000 : i === j ? 1 : 0);
            }
            corrMatrix.push(row);
        }
        // Format annotations
        const annotations = [];
        for (let i = 0; i < columns.length; i++) {
            for (let j = 0; j < columns.length; j++) {
                annotations.push({ x: columns[j], y: columns[i], text: String(corrMatrix[i][j].toFixed(2)),
                    showarrow: false, font: { color: Math.abs(corrMatrix[i][j]) > 0.5 ? '#fff' : '#aaa', size: 11 } });
            }
        }
        traces = [{ z: corrMatrix, x: columns, y: columns, type: 'heatmap',
            colorscale: [[0, '#d94a4a'], [0.5, '#1a1a2e'], [1, '#4a9f6e']], zmin: -1, zmax: 1, showscale: true }];
        plotTitle = 'Correlation Heatmap';
        layout = { xaxis: { side: 'bottom' }, yaxis: { autorange: 'reversed' }, annotations };
    } else if (type === 'bubble') {
        const xVals = getCol(opts.x);
        const yVals = getCol(opts.y);
        const sizeVals = getCol(opts.size).map(Number);
        // Normalize sizes to 5-40 range
        const sMin = Math.min(...sizeVals.filter(v => !isNaN(v)));
        const sMax = Math.max(...sizeVals.filter(v => !isNaN(v)));
        const sRange = sMax - sMin || 1;
        const sizes = sizeVals.map(v => isNaN(v) ? 5 : 5 + (v - sMin) / sRange * 35);
        if (opts.color) {
            const groups = {};
            const colorVals = getCol(opts.color);
            xVals.forEach((x, i) => {
                const g = String(colorVals[i] || 'other');
                if (!groups[g]) groups[g] = { x: [], y: [], size: [] };
                groups[g].x.push(x); groups[g].y.push(yVals[i]); groups[g].size.push(sizes[i]);
            });
            traces = Object.entries(groups).map(([name, d]) => ({
                x: d.x, y: d.y, mode: 'markers', type: 'scatter', name,
                marker: { size: d.size, sizemode: 'diameter' }
            }));
        } else {
            traces = [{ x: xVals, y: yVals, mode: 'markers', type: 'scatter',
                marker: { size: sizes, sizemode: 'diameter', color: 'rgba(74,159,110,0.6)', line: { color: 'rgba(74,159,110,1)', width: 1 } } }];
        }
        plotTitle = `${opts.y} vs ${opts.x} (size: ${opts.size})`;
        layout = { xaxis: { title: opts.x }, yaxis: { title: opts.y } };
    }

    const blockId = addOutput(plotTitle, html);
    setTimeout(() => {
        Plotly.newPlot(plotId, traces, {
            ...layout,
            title: { text: plotTitle, font: { size: 14, color: '#b0b0b0' } },
            template: 'plotly_dark',
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            margin: { t: 40, r: 20, b: 50, l: 60 },
        }, { responsive: true, displayModeBar: true });
    }, 50);
}

// =============================================================================
// TRIAGE: Auto-scan and fix data issues
// =============================================================================
function openTriagePanel() {
    if (!dswDataId) { alert('Please import a data file first'); return; }
    autoTriageScan(dswDataId);
}

async function autoTriageScan(dataId) {
    try {
        const { data } = await apiPost('/api/dsw/triage/scan/', { data_id: dataId });
        if (!data.success) return;
        if (!data.has_issues) {
            showToast('Data looks clean â no issues detected');
            return;
        }

        const issues = data.issues;
        const t = issues.totals;

        // Build badge row
        let badges = '';
        if (t.missing > 0) badges += `<span style="display:inline-block;background:#d94a4a;color:#fff;padding:2px 10px;border-radius:10px;margin:0 4px;font-size:12px;">${t.missing} Missing</span>`;
        if (t.outliers > 0) badges += `<span style="display:inline-block;background:#e89547;color:#fff;padding:2px 10px;border-radius:10px;margin:0 4px;font-size:12px;">${t.outliers} Outliers</span>`;
        if (t.type_issues > 0) badges += `<span style="display:inline-block;background:#4a90d9;color:#fff;padding:2px 10px;border-radius:10px;margin:0 4px;font-size:12px;">${t.type_issues} Type Issues</span>`;
        if (t.excel_errors > 0) badges += `<span style="display:inline-block;background:#d94a4a;color:#fff;padding:2px 10px;border-radius:10px;margin:0 4px;font-size:12px;">${t.excel_errors} Excel Errors</span>`;

        // Build column breakdown table
        let tableRows = '';
        for (const [col, info] of Object.entries(issues.missing)) {
            tableRows += `<tr><td>${col}</td><td>Missing</td><td>${info.count}</td><td>${info.percent}%</td></tr>`;
        }
        for (const [col, info] of Object.entries(issues.outliers)) {
            const cnt = typeof info === 'object' ? info.count : info;
            const pct = typeof info === 'object' ? info.percent : '';
            tableRows += `<tr><td>${col}</td><td>Outlier</td><td>${cnt}</td><td>${pct ? pct + '%' : ''}</td></tr>`;
        }
        for (const [col, cnt] of Object.entries(issues.excel_errors)) {
            tableRows += `<tr><td>${col}</td><td>Excel Error</td><td>${cnt}</td><td></td></tr>`;
        }
        for (const ti of issues.type_issues) {
            tableRows += `<tr><td>${ti.column}</td><td>Type: ${ti.current} â ${ti.suggested}</td><td></td><td>${ti.confidence}%</td></tr>`;
        }

        const html = `
        <div style="padding:12px;font-family:inherit;color:#c8c8c8;">
            <div style="margin-bottom:12px;">${badges}</div>
            <table style="width:100%;border-collapse:collapse;font-size:12px;margin-bottom:16px;">
                <thead><tr style="border-bottom:1px solid #444;">
                    <th style="text-align:left;padding:4px 8px;">Column</th>
                    <th style="text-align:left;padding:4px 8px;">Issue</th>
                    <th style="text-align:right;padding:4px 8px;">Count</th>
                    <th style="text-align:right;padding:4px 8px;">%</th>
                </tr></thead>
                <tbody>${tableRows}</tbody>
            </table>
            <div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:12px;font-size:13px;">
                ${t.excel_errors > 0 ? '<label><input type="checkbox" id="triage-fix-excel" checked style="width:auto;margin-right:4px;">Fix Excel errors</label>' : ''}
                ${t.missing > 0 ? `<label><input type="checkbox" id="triage-fix-missing" checked style="width:auto;margin-right:4px;">Fix missing</label>
                    <select id="triage-missing-action" style="font-size:12px;padding:2px 6px;background:#1e1e2e;color:#c8c8c8;border:1px solid #444;border-radius:3px;">
                        <option value="impute_mean">Impute mean</option><option value="impute_median">Impute median</option><option value="drop_rows">Drop rows</option>
                    </select>` : ''}
                ${t.type_issues > 0 ? '<label><input type="checkbox" id="triage-fix-types" checked style="width:auto;margin-right:4px;">Fix types</label>' : ''}
                ${t.outliers > 0 ? `<label><input type="checkbox" id="triage-fix-outliers" style="width:auto;margin-right:4px;">Fix outliers</label>
                    <select id="triage-outlier-action" style="font-size:12px;padding:2px 6px;background:#1e1e2e;color:#c8c8c8;border:1px solid #444;border-radius:3px;">
                        <option value="flag">Flag</option><option value="clip">Clip</option><option value="remove">Remove</option>
                    </select>` : ''}
            </div>
            <div style="display:flex;gap:12px;align-items:center;">
                <button onclick="runTriageFixFromPanel('${dataId}')" style="background:#2c5f2d;color:#fff;border:none;padding:6px 18px;border-radius:4px;cursor:pointer;font-size:13px;">Auto-Fix</button>
                <a href="#" onclick="closeTab(this.closest('.output-pane').id);return false;" style="color:#888;font-size:12px;">Dismiss</a>
            </div>
        </div>`;

        addOutput('Data Triage', html);
    } catch (err) {
        console.error('Triage scan error:', err);
    }
}

async function runTriageFixFromPanel(dataId) {
    const options = {};
    const elExcel = document.getElementById('triage-fix-excel');
    const elMissing = document.getElementById('triage-fix-missing');
    const elTypes = document.getElementById('triage-fix-types');
    const elOutliers = document.getElementById('triage-fix-outliers');

    options.fix_excel = elExcel ? elExcel.checked : false;
    options.fix_missing = elMissing ? elMissing.checked : false;
    if (options.fix_missing) {
        const action = document.getElementById('triage-missing-action');
        options.missing_action = action ? action.value : 'impute_mean';
    }
    options.fix_types = elTypes ? elTypes.checked : false;
    options.fix_outliers = elOutliers ? elOutliers.checked : false;
    if (options.fix_outliers) {
        const action = document.getElementById('triage-outlier-action');
        options.outlier_action = action ? action.value : 'flag';
    }

    showLoading(true, 'Cleaning data...');
    try {
        const { data } = await apiPost('/api/dsw/triage/', { data_id: dataId, options });
        if (!data.success) { showLoading(false); alert(data.error || 'Triage failed'); return; }

        // Re-upload cleaned CSV
        const blob = new Blob([data.cleaned_csv], { type: 'text/csv' });
        const file = new File([blob], 'cleaned.csv', { type: 'text/csv' });

        const dswForm = new FormData();
        dswForm.append('file', file);
        const { data: dswData } = await apiPost('/api/dsw/upload-data/', dswForm, true);
        if (dswData.id) dswDataId = dswData.id;

        const spcForm = new FormData();
        spcForm.append('file', file);
        const { data: spcData } = await apiPost('/api/spc/upload/', spcForm, true);
        if (spcData.success) { uploadedData = spcData; cacheKey = spcData.cache_key; }

        showLoading(false);

        if (uploadedData) displayDataTable(uploadedData);

        // Build fix summary
        const c = data.changes || {};
        const parts = [];
        if (c.missing_filled) parts.push(`${c.missing_filled} missing filled`);
        if (c.missing_dropped) parts.push(`${c.missing_dropped} rows dropped`);
        if (c.types_converted) parts.push(`${c.types_converted} types fixed`);
        if (c.excel_errors) parts.push(`${c.excel_errors} Excel errors fixed`);
        if (c.outliers_flagged) parts.push(`${c.outliers_flagged} outliers flagged`);
        if (c.outliers_clipped) parts.push(`${c.outliers_clipped} outliers clipped`);
        if (c.outliers_removed) parts.push(`${c.outliers_removed} outliers removed`);
        showToast('Fixed: ' + (parts.length > 0 ? parts.join(', ') : 'no changes needed'));

        // Close triage tab
        const triagePane = document.querySelector('.output-pane.active');
        if (triagePane) closeTab(triagePane.id);
    } catch (err) {
        showLoading(false);
        alert('Triage fix error: ' + err.message);
    }
}

// =============================================================================
// STATS: Regression, Hypothesis Tests, Intervals, Transforms
// =============================================================================
function openStatsDialog(type) {
    if (!dswDataId) { alert('Please import a data file first'); return; }
    const numCols = getNumericColumns();
    const allCols = getAllColumns();
    const numOpts = numCols.map(c => `<option value="${c}">${c}</option>`).join('');
    const allOpts = allCols.map(c => `<option value="${c}">${c}</option>`).join('');

    let html = '';
    if (type === 'regression') {
        const predChecks = numCols.map(c => `<label><input type="checkbox" value="${c}"> ${c}</label>`).join('');
        html = `
            <div class="form-row"><label>Analysis Type</label><select id="dlg-reg-type">
                <option value="regression">Linear Regression</option>
                <option value="stepwise">Stepwise Regression</option>
                <option value="best_subsets">Best Subsets</option>
                <option value="robust_regression">Robust Regression</option>
                <option value="logistic">Logistic Regression</option>
            </select></div>
            <div class="form-row"><label>Response Variable</label><select id="dlg-reg-response">${numOpts}</select></div>
            <div class="form-row"><label>Predictors</label>
                <div class="checkbox-grid" id="dlg-reg-predictors">
                    <div class="select-actions">
                        <a onclick="document.querySelectorAll('#dlg-reg-predictors input').forEach(c=>c.checked=true)">Select All</a>
                        <a onclick="document.querySelectorAll('#dlg-reg-predictors input').forEach(c=>c.checked=false)">Clear All</a>
                    </div>
                    ${predChecks}
                </div>
            </div>`;
        openModal('Regression Analysis', html, 'Run', async () => {
            const regType = document.getElementById('dlg-reg-type').value;
            const response = document.getElementById('dlg-reg-response').value;
            const predictors = Array.from(document.querySelectorAll('#dlg-reg-predictors input:checked')).map(c => c.value);
            if (!response || predictors.length === 0) { alert('Select response and at least one predictor'); return; }
            closeModal();
            await runStatsAnalysis('stats', regType, { response, predictors }, 'Regression');
        });
    } else if (type === 'anova') {
        html = `
            <div class="form-row"><label>Response Variable</label><select id="dlg-anova-response">${numOpts}</select></div>
            <div class="form-row"><label>Factor Variable</label><select id="dlg-anova-factor">${allOpts}</select></div>`;
        openModal('ANOVA', html, 'Run', async () => {
            const response = document.getElementById('dlg-anova-response').value;
            const factor = document.getElementById('dlg-anova-factor').value;
            closeModal();
            await runStatsAnalysis('stats', 'anova', { response, factor, factors: [factor] }, 'ANOVA');
        });
    } else if (type === 'ttest') {
        html = `
            <div class="form-row"><label>Test Type</label><select id="dlg-test-type">
                <option value="ttest">One-Sample t-Test</option>
                <option value="ttest2">Two-Sample t-Test</option>
                <option value="paired_t">Paired t-Test</option>
            </select></div>
            <div class="form-row"><label>Variable 1</label><select id="dlg-test-var1">${numOpts}</select></div>
            <div class="form-row"><label>Variable 2 / Group</label><select id="dlg-test-var2"><option value="">N/A</option>${allOpts}</select></div>
            <div class="form-row"><label>Hypothesized Mean</label><input type="number" id="dlg-test-mu" value="0" step="any"></div>
            <div class="form-row"><label>Confidence</label><select id="dlg-test-conf"><option value="90">90%</option><option value="95" selected>95%</option><option value="99">99%</option></select></div>`;
        openModal('t-Test', html, 'Run', async () => {
            const testType = document.getElementById('dlg-test-type').value;
            const var1 = document.getElementById('dlg-test-var1').value;
            const var2 = document.getElementById('dlg-test-var2').value;
            const conf = parseInt(document.getElementById('dlg-test-conf').value);
            const config = { var1, conf };
            if (testType === 'ttest') config.mu = parseFloat(document.getElementById('dlg-test-mu').value) || 0;
            if (['ttest2', 'paired_t'].includes(testType)) config.var2 = var2;
            closeModal();
            await runStatsAnalysis('stats', testType, config, 't-Test');
        });
    } else if (['more_nonparam','more_posthoc','more_multivar','more_survival','acceptance','more_diag','more'].includes(type)) {
        const dialogConfigs = {
            'more_nonparam': { title: 'Non-Parametric Tests', options: `
                <option value="sign_test">Sign Test (1-sample median)</option>
                <option value="mood_median">Mood's Median Test (k-sample)</option>
                <option value="chi2">Chi-Square</option>
                <option value="fisher_exact">Fisher's Exact Test</option>
                <option value="mann_whitney">Mann-Whitney U</option>
                <option value="kruskal">Kruskal-Wallis H</option>
                <option value="wilcoxon">Wilcoxon Signed-Rank</option>
                <option value="friedman">Friedman Test</option>
                <option value="spearman">Spearman Correlation</option>
                <option value="f_test">F-Test for Variance</option>
                <option value="equivalence">Equivalence (TOST)</option>
                <option value="prop_1sample">1-Proportion Z-Test</option>
                <option value="prop_2sample">2-Proportion Z-Test</option>
                <option value="poisson_1sample">Poisson Rate Test</option>`,
                v1label: 'Variable 1', v2label: 'Variable 2 / Group', v1opts: allOpts },
            'more_posthoc': { title: 'Post-Hoc Comparisons', options: `
                <option value="tukey_hsd">Tukey HSD</option>
                <option value="games_howell">Games-Howell</option>
                <option value="dunnett">Dunnett's (vs Control)</option>
                <option value="dunn">Dunn's (Non-Parametric)</option>`,
                v1label: 'Response', v2label: 'Factor', v1opts: numOpts },
            'more_multivar': { title: 'Multivariate & Advanced', options: `
                <option value="hotelling_t2">Hotelling's TÂ²</option>
                <option value="manova">MANOVA</option>
                <option value="nested_anova">Nested ANOVA (Mixed-Effects)</option>
                <option value="glm">General Linear Model (GLM)</option>
                <option value="ordinal_logistic">Ordinal Logistic Regression</option>
                <option value="variance_components">Variance Components</option>
                <option value="discriminant_analysis">Discriminant Analysis (LDA/QDA)</option>
                <option value="regularized_regression">Ridge / LASSO / Elastic Net</option>`,
                v1label: 'Variable 1', v2label: 'Variable 2 / Factor', v1opts: allOpts },
            'more_survival': { title: 'Survival Analysis', options: `
                <option value="kaplan_meier">Kaplan-Meier Survival Curve</option>
                <option value="cox_ph">Cox Proportional Hazards</option>`,
                v1label: 'Time Variable', v2label: 'Event (1=event, 0=censored)', v1opts: numOpts },
            'acceptance': { title: 'Acceptance Sampling', options: `
                <option value="acceptance_sampling">Acceptance Sampling Plan</option>`,
                v1label: 'Variable 1', v2label: 'Variable 2', v1opts: allOpts },
            'more_diag': { title: 'Diagnostics & Transforms', options: `
                <option value="normality">Normality Test</option>
                <option value="runs_test">Runs Test</option>
                <option value="bootstrap_ci">Bootstrap CI</option>
                <option value="tolerance_interval">Tolerance Interval</option>
                <option value="box_cox">Box-Cox Transform</option>`,
                v1label: 'Variable', v2label: 'Variable 2 (if needed)', v1opts: numOpts },
            'more': { title: 'All Statistical Tests', options: `
                <optgroup label="Proportion Tests">
                    <option value="prop_1sample">1-Proportion Z-Test</option>
                    <option value="prop_2sample">2-Proportion Z-Test</option>
                    <option value="fisher_exact">Fisher's Exact Test</option>
                    <option value="poisson_1sample">Poisson Rate Test</option>
                </optgroup>
                <optgroup label="Non-Parametric">
                    <option value="sign_test">Sign Test (1-sample median)</option>
                    <option value="mood_median">Mood's Median Test</option>
                    <option value="chi2">Chi-Square</option>
                    <option value="mann_whitney">Mann-Whitney U</option>
                    <option value="kruskal">Kruskal-Wallis H</option>
                    <option value="wilcoxon">Wilcoxon Signed-Rank</option>
                    <option value="friedman">Friedman Test</option>
                    <option value="spearman">Spearman Correlation</option>
                    <option value="f_test">F-Test for Variance</option>
                    <option value="equivalence">Equivalence (TOST)</option>
                </optgroup>
                <optgroup label="Post-Hoc">
                    <option value="tukey_hsd">Tukey HSD</option>
                    <option value="games_howell">Games-Howell</option>
                    <option value="dunnett">Dunnett's (vs Control)</option>
                    <option value="dunn">Dunn's (Non-Parametric)</option>
                </optgroup>
                <optgroup label="Multivariate">
                    <option value="hotelling_t2">Hotelling's TÂ²</option>
                    <option value="manova">MANOVA</option>
                    <option value="nested_anova">Nested ANOVA (Mixed-Effects)</option>
                    <option value="glm">General Linear Model (GLM)</option>
                    <option value="ordinal_logistic">Ordinal Logistic Regression</option>
                    <option value="variance_components">Variance Components</option>
                    <option value="factor_analysis">Factor Analysis</option>
                </optgroup>
                <optgroup label="Survival">
                    <option value="kaplan_meier">Kaplan-Meier</option>
                    <option value="cox_ph">Cox Proportional Hazards</option>
                </optgroup>
                <optgroup label="Regression & ML">
                    <option value="regularized_regression">Ridge / LASSO / Elastic Net</option>
                    <option value="discriminant_analysis">Discriminant Analysis (LDA/QDA)</option>
                    <option value="sarima">SARIMA (Seasonal Forecasting)</option>
                </optgroup>
                <optgroup label="Quality / MSA">
                    <option value="acceptance_sampling">Acceptance Sampling</option>
                    <option value="gage_rr">Gage R&R (Crossed)</option>
                    <option value="gage_rr_nested">Gage R&R (Nested)</option>
                    <option value="gage_linearity_bias">Gage Linearity & Bias</option>
                    <option value="gage_type1">Type 1 Gage Study</option>
                    <option value="attribute_gage">Attribute Gage (Pass/Fail)</option>
                    <option value="attribute_agreement">Attribute Agreement (Kappa)</option>
                </optgroup>
                <optgroup label="Power & Sample Size">
                    <option value="power_z">1-Sample Z Power</option>
                    <option value="power_1prop">1-Proportion Power</option>
                    <option value="power_2prop">2-Proportion Power</option>
                    <option value="power_1variance">1-Variance Power</option>
                    <option value="power_2variance">2-Variance Power</option>
                    <option value="power_equivalence">Equivalence (TOST) Power</option>
                    <option value="power_doe">DOE Factorial Power</option>
                    <option value="sample_size_ci">Sample Size for CI</option>
                    <option value="sample_size_tolerance">Sample Size for Tolerance</option>
                </optgroup>
                <optgroup label="Diagnostics">
                    <option value="normality">Normality Test</option>
                    <option value="runs_test">Runs Test</option>
                    <option value="bootstrap_ci">Bootstrap CI</option>
                    <option value="tolerance_interval">Tolerance Interval</option>
                    <option value="box_cox">Box-Cox Transform</option>
                </optgroup>`,
                v1label: 'Variable 1', v2label: 'Variable 2 (if needed)', v1opts: allOpts },
        };
        const cfg = dialogConfigs[type];
        html = `<div class="form-row"><label>Test</label><select id="dlg-more-type">${cfg.options}</select></div>
        <div class="form-row"><label>${cfg.v1label}</label><select id="dlg-more-var1">${cfg.v1opts}</select></div>
        <div class="form-row"><label>${cfg.v2label}</label><select id="dlg-more-var2"><option value="">N/A</option>${allOpts}</select></div>`;
        openModal(cfg.title, html, 'Run', async () => {
            const testType = document.getElementById('dlg-more-type').value;
            const var1 = document.getElementById('dlg-more-var1').value;
            const var2 = document.getElementById('dlg-more-var2').value;
            const config = { var: var1, var1: var1, row_var: var1, response: var1 };
            if (var2) { config.var2 = var2; config.group_var = var2; config.col_var = var2; config.factor = var2; config.predictor = var2; config.predictors = [var2]; }
            closeModal();
            // Route to correct analysis type
            const mlTests = ['factor_analysis','discriminant_analysis','regularized_regression'];
            const aType = mlTests.includes(testType) ? 'ml' : 'stats';
            await runStatsAnalysis(aType, testType, config, testType.replace('_', ' '));
        });
    }
}

async function runStatsAnalysis(analysisType, analysisId, config, outputTitle) {
    showLoading(true, 'Running ' + outputTitle + '...');
    try {
        const payload = {
            type: analysisType, analysis: analysisId, config, data_id: dswDataId
        };
        // Link to project if one is selected
        if (currentProjectId) {
            payload.project_id = currentProjectId;
            payload.save_result = true;
            payload.title = outputTitle;
        }
        const { response, data } = await apiPost('/api/dsw/analysis/', payload);
        showLoading(false);
        if (data.error) { alert(data.error); return; }
        renderStatsOutput(data, outputTitle);
        svendTrack('feature_use', {category: 'dsw', action: analysisId, label: outputTitle});
    } catch (err) { showLoading(false); alert('Analysis failed: ' + err.message); }
}

function renderStatsOutput(result, title) {
    let html = '';

    if (result.summary) {
        let formatted = result.summary
            .replace(/<<COLOR:accent>>(.*?)<<\/COLOR>>/g, '<span class="color-accent">$1</span>')
            .replace(/<<COLOR:title>>(.*?)<<\/COLOR>>/g, '<span class="color-title">$1</span>')
            .replace(/<<COLOR:highlight>>(.*?)<<\/COLOR>>/g, '<span class="color-highlight">$1</span>')
            .replace(/<<COLOR:text>>(.*?)<<\/COLOR>>/g, '<span class="color-text">$1</span>')
            .replace(/<<COLOR:dim>>(.*?)<<\/COLOR>>/g, '<span class="color-dim">$1</span>')
            .replace(/<<COLOR:success>>(.*?)<<\/COLOR>>/g, '<span class="color-success">$1</span>')
            .replace(/<<COLOR:good>>(.*?)<<\/COLOR>>/g, '<span class="color-success">$1</span>')
            .replace(/<<COLOR:warning>>(.*?)<<\/COLOR>>/g, '<span class="color-warning">$1</span>')
            .replace(/<<COLOR:danger>>(.*?)<<\/COLOR>>/g, '<span class="color-danger">$1</span>')
            .replace(/<<COLOR:bad>>(.*?)<<\/COLOR>>/g, '<span class="color-danger">$1</span>');
        html += `<pre class="stats-summary">${formatted}</pre>`;
    }

    if (result.plots && result.plots.length > 0) {
        const plotIds = [];
        html += '<div class="stats-plots">';
        result.plots.forEach((plot, i) => {
            const plotId = `plot-${outputCounter}-${i}`;
            plotIds.push({ id: plotId, plot });
            html += `<div id="${plotId}" class="stats-plot"></div>`;
        });
        html += '</div>';

        const blockId = addOutput(title, html);

        // Render Plotly charts after DOM update
        setTimeout(() => {
            plotIds.forEach(({ id, plot }) => {
                const layout = {
                    ...plot.layout,
                    template: 'plotly_dark',
                    paper_bgcolor: 'transparent',
                    plot_bgcolor: 'transparent',
                    margin: { t: 40, r: 20, b: 40, l: 60 },
                    title: { text: plot.title, font: { size: 14, color: '#b0b0b0' } }
                };
                Plotly.newPlot(id, plot.data, layout, { responsive: true, displayModeBar: false });
            });
        }, 50);
    } else {
        addOutput(title, html);
    }
}

// =============================================================================
// DOE
// =============================================================================
function openDOEDialog(doeType) {
    const types = [
        ['full_factorial', 'Full Factorial (2\u1d4f)'],
        ['fractional_factorial', 'Fractional Factorial (2\u1d4f\u207b\u1d56)'],
        ['plackett_burman', 'Plackett-Burman (Screening)'],
        ['definitive_screening', 'Definitive Screening (DSD)'],
        ['ccd', 'Central Composite (CCD)'],
        ['box_behnken', 'Box-Behnken'],
        ['taguchi', 'Taguchi (Orthogonal Array)'],
        ['latin_square', 'Latin Square'],
        ['rcbd', 'Randomized Complete Block'],
        ['d_optimal', 'D-Optimal'],
        ['i_optimal', 'I-Optimal'],
    ];
    const sel = doeType === 'all' ? '' : doeType;
    const typeOpts = types.map(([v, l]) => `<option value="${v}" ${v === sel ? 'selected' : ''}>${l}</option>`).join('');

    let html = `<div class="form-row"><label>Design Type</label>
        <select id="dlg-doe-type" onchange="updateDOEConditionalFields()">${typeOpts}</select></div>
        <div id="dlg-doe-conditional"></div>
        <div class="form-row"><label>Factors</label>
            <div id="dlg-factors">
                <div class="form-row-inline" style="margin-bottom:0.5rem;">
                    <input type="text" placeholder="Factor name" class="dlg-factor-name" style="padding:0.5rem;">
                    <input type="text" placeholder="Levels (comma sep)" class="dlg-factor-levels" style="padding:0.5rem;">
                </div>
                <div class="form-row-inline" style="margin-bottom:0.5rem;">
                    <input type="text" placeholder="Factor name" class="dlg-factor-name" style="padding:0.5rem;">
                    <input type="text" placeholder="Levels (comma sep)" class="dlg-factor-levels" style="padding:0.5rem;">
                </div>
            </div>
            <button type="button" class="wb-btn wb-btn-sm" onclick="addDOEFactor()">+ Add Factor</button>
        </div>
        <div class="form-row-inline">
            <div class="form-row"><label>Replicates</label><input type="number" id="dlg-doe-replicates" value="1" min="1" max="10" step="1"></div>
            <div class="form-row"><label>Center Points</label><input type="number" id="dlg-doe-centerpts" value="0" min="0" max="10" step="1"></div>
        </div>`;
    openModal('Design of Experiments', html, 'Generate Design', runDOE);
    setTimeout(() => updateDOEConditionalFields(), 10);
}

function updateDOEConditionalFields() {
    const type = document.getElementById('dlg-doe-type').value;
    const container = document.getElementById('dlg-doe-conditional');
    let html = '';
    if (type === 'fractional_factorial') {
        html = `<div class="form-row"><label>Resolution</label><select id="dlg-doe-resolution">
            <option value="3">III (main effects only)</option>
            <option value="4" selected>IV (main effects + some 2FI)</option>
            <option value="5">V (main effects + all 2FI)</option>
        </select></div>`;
    } else if (type === 'ccd') {
        html = `<div class="form-row"><label>Alpha Type</label><select id="dlg-doe-alpha-type">
            <option value="rotatable" selected>Rotatable</option>
            <option value="face">Face-centered</option>
            <option value="orthogonal">Orthogonal</option>
        </select></div>`;
    } else if (type === 'taguchi') {
        html = `<div class="form-row"><label>Orthogonal Array</label><select id="dlg-doe-taguchi-array">
            <option value="auto" selected>Auto-select</option>
            <option value="L4">L4</option><option value="L8">L8</option>
            <option value="L9">L9</option><option value="L12">L12</option>
            <option value="L16">L16</option><option value="L18">L18</option>
            <option value="L27">L27</option>
        </select></div>`;
    } else if (type === 'd_optimal' || type === 'i_optimal') {
        html = `<div class="form-row-inline">
            <div class="form-row"><label>Number of Runs</label><input type="number" id="dlg-doe-num-runs" value="12" min="4" max="200" step="1"></div>
            <div class="form-row"><label>Model Type</label><select id="dlg-doe-model">
                <option value="linear">Linear</option>
                <option value="interaction" selected>Linear + Interactions</option>
                <option value="quadratic">Quadratic</option>
            </select></div>
        </div>`;
    } else if (type === 'box_behnken') {
        html = `<div class="form-row"><label>Center Points</label><input type="number" id="dlg-doe-bb-center" value="3" min="1" max="10" step="1"></div>`;
    }
    container.innerHTML = html;
}

function addDOEFactor() {
    const div = document.getElementById('dlg-factors');
    const row = document.createElement('div');
    row.className = 'form-row-inline';
    row.style.marginBottom = '0.5rem';
    row.innerHTML = `<input type="text" placeholder="Factor name" class="dlg-factor-name" style="padding:0.5rem;"><input type="text" placeholder="Levels (comma sep)" class="dlg-factor-levels" style="padding:0.5rem;">`;
    div.appendChild(row);
}

async function runDOE() {
    const doeType = document.getElementById('dlg-doe-type').value;
    const names = document.querySelectorAll('.dlg-factor-name');
    const levels = document.querySelectorAll('.dlg-factor-levels');
    const factors = [];
    names.forEach((el, i) => {
        const name = el.value.trim();
        const lvls = levels[i].value.split(',').map(v => v.trim()).filter(v => v);
        if (name && lvls.length > 0) factors.push({ name, levels: lvls });
    });
    if (factors.length < 2) { alert('Add at least 2 factors'); return; }

    const payload = { design_type: doeType, factors };
    // Collect common options
    const repEl = document.getElementById('dlg-doe-replicates');
    if (repEl) payload.replicates = parseInt(repEl.value) || 1;
    const cpEl = document.getElementById('dlg-doe-centerpts');
    if (cpEl) payload.center_points = parseInt(cpEl.value) || 0;
    // Collect conditional fields
    const resEl = document.getElementById('dlg-doe-resolution');
    if (resEl) payload.resolution = parseInt(resEl.value);
    const alphaEl = document.getElementById('dlg-doe-alpha-type');
    if (alphaEl) payload.alpha_type = alphaEl.value;
    const tagEl = document.getElementById('dlg-doe-taguchi-array');
    if (tagEl) payload.taguchi_array = tagEl.value;
    const numRunsEl = document.getElementById('dlg-doe-num-runs');
    if (numRunsEl) payload.num_runs = parseInt(numRunsEl.value);
    const modelEl = document.getElementById('dlg-doe-model');
    if (modelEl) payload.model = modelEl.value;
    const bbCenterEl = document.getElementById('dlg-doe-bb-center');
    if (bbCenterEl) payload.center_points = parseInt(bbCenterEl.value);

    closeModal();
    showLoading(true, 'Generating design...');
    try {
        const { response, data } = await apiPost('/api/experimenter/design/', payload);
        showLoading(false);
        if (data.error) { alert(data.error); return; }
        const design = data.design || data;
        const runs = design.runs || data.runs || [];
        // Store for later analysis
        currentDoeDesign = { design, factors, doeType, runs };

        let html = '';
        if (runs.length > 0) {
            const factorNames = Object.keys(runs[0].levels || {});
            const cols = ['Run', ...factorNames, 'Response'];
            html += '<table class="doe-table" id="doe-results-table"><thead><tr>' + cols.map(c => `<th>${c}</th>`).join('') + '</tr></thead><tbody>';
            runs.forEach((run, idx) => {
                const lvls = run.levels || {};
                html += '<tr>';
                html += `<td>${run.run_order || run.run_id || (idx + 1)}</td>`;
                factorNames.forEach(f => { html += `<td>${lvls[f] || ''}</td>`; });
                html += `<td><input type="number" class="doe-response-input" data-run="${idx}" step="any" style="width:80px;padding:0.3rem;background:var(--bg-secondary);color:var(--text);border:1px solid var(--border);border-radius:4px;"></td>`;
                html += '</tr>';
            });
            html += '</tbody></table>';
            const designName = design.name || design.design_type || doeType;
            html += `<p style="margin-top:0.75rem;color:var(--text-dim);font-size:0.8rem;">${designName} â ${runs.length} runs</p>`;
            html += `<div style="margin-top:1rem;display:flex;gap:0.5rem;flex-wrap:wrap;">
                <button class="wb-btn wb-btn-primary" onclick="analyzeDOEResults()">Analyze Results</button>
                <button class="wb-btn" onclick="importDOEToWorkbench()">Import to Workbench</button>
                <button class="wb-btn" onclick="exportDOECSV()">Export CSV</button>
            </div>`;
        } else if (data.markdown) {
            html = `<pre class="stats-summary">${data.markdown}</pre>`;
        } else {
            html = `<pre class="stats-summary">${JSON.stringify(design, null, 2)}</pre>`;
        }
        addOutput('DOE: ' + doeType.replace(/_/g, ' '), html);
    } catch (err) { showLoading(false); alert('Error: ' + err.message); }
}

// =============================================================================
// DOE Analysis, Import & Export
// =============================================================================
async function analyzeDOEResults() {
    if (!currentDoeDesign) { alert('Generate a design first'); return; }
    const inputs = document.querySelectorAll('.doe-response-input');
    const results = [];
    let hasEmpty = false;
    inputs.forEach((inp, i) => {
        const val = parseFloat(inp.value);
        if (isNaN(val)) { hasEmpty = true; return; }
        results.push({ run_id: i + 1, response: val });
    });
    if (hasEmpty || results.length === 0) { alert('Enter response values for all runs'); return; }

    showLoading(true, 'Analyzing DOE results...');
    try {
        const { response, data } = await apiPost('/api/experimenter/analyze/', {
            design: currentDoeDesign.design,
            results,
            response_name: 'Response',
            alpha: 0.05,
            include_interactions: true,
        });
        showLoading(false);
        if (data.error) { alert(data.error); return; }
        renderExperimenterAnalysis(data, 'DOE Analysis');
    } catch (err) { showLoading(false); alert('Analysis failed: ' + err.message); }
}

function renderExperimenterAnalysis(data, title) {
    let html = '';
    const analysis = data.analysis || {};

    // ANOVA table
    if (analysis.anova_table) {
        const at = analysis.anova_table;
        html += '<h4 style="color:var(--text);margin:0 0 0.5rem;">ANOVA Table</h4>';
        html += '<table class="doe-table"><thead><tr><th>Source</th><th>DF</th><th>SS</th><th>MS</th><th>F</th><th>P</th></tr></thead><tbody>';
        const n = (at.source || []).length;
        for (let i = 0; i < n; i++) {
            const p = at.p?.[i];
            const pStyle = p != null && p < 0.05 ? 'color:var(--accent)' : '';
            html += `<tr><td>${at.source[i]}</td><td>${at.df?.[i] ?? ''}</td><td>${fmt(at.ss?.[i])}</td><td>${fmt(at.ms?.[i])}</td><td>${fmt(at.f?.[i])}</td><td style="${pStyle}">${fmt(at.p?.[i])}</td></tr>`;
        }
        html += '</tbody></table>';
    }

    // Model summary
    if (analysis.model_summary) {
        const ms = analysis.model_summary;
        html += `<p style="margin:0.75rem 0 0.25rem;color:var(--text-dim);font-size:0.85rem;">S = ${fmt(ms.s)} &emsp; R\u00B2 = ${fmt(ms.r_squared)} &emsp; R\u00B2(adj) = ${fmt(ms.r_squared_adj)} &emsp; R\u00B2(pred) = ${fmt(ms.r_squared_pred)}</p>`;
    }

    // Model equation
    if (analysis.model_equation) {
        html += `<pre class="stats-summary" style="margin-top:0.5rem;font-size:0.8rem;">${analysis.model_equation}</pre>`;
    }

    // Interpretation
    if (data.interpretation && data.interpretation.length) {
        html += '<div style="margin-top:0.75rem;padding:0.5rem;background:var(--bg-secondary);border-radius:6px;font-size:0.85rem;color:var(--text-dim);">';
        data.interpretation.forEach(line => { html += `<p style="margin:0.25rem 0;">${line}</p>`; });
        html += '</div>';
    }

    // Plots from experimenter (keyed object, not array)
    const plots = data.plots || {};
    const plotItems = [];
    ['main_effects', 'interactions', 'pareto', 'normal_probability', 'residual_vs_fitted', 'residual_vs_order'].forEach(key => {
        const p = plots[key];
        if (!p) return;
        (Array.isArray(p) ? p : [p]).forEach(item => plotItems.push(item));
    });

    if (plotItems.length > 0) {
        const plotIds = [];
        html += '<div class="stats-plots">';
        plotItems.forEach((plot, i) => {
            const plotId = `doe-plot-${outputCounter}-${i}`;
            plotIds.push({ id: plotId, plot });
            html += `<div id="${plotId}" class="stats-plot"></div>`;
        });
        html += '</div>';
        addOutput(title, html);
        setTimeout(() => {
            plotIds.forEach(({ id, plot }) => {
                const plotData = plot.data || plot.traces || [];
                const layout = { ...(plot.layout || {}), template: 'plotly_dark', paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
                    margin: { t: 40, r: 20, b: 40, l: 60 }, title: { text: plot.title || '', font: { size: 14, color: '#b0b0b0' } } };
                Plotly.newPlot(id, plotData, layout, { responsive: true, displayModeBar: false });
            });
        }, 50);
    } else {
        addOutput(title, html);
    }
}

async function importDOEToWorkbench() {
    if (!currentDoeDesign) { alert('Generate a design first'); return; }
    const { runs } = currentDoeDesign;
    if (!runs || runs.length === 0) { alert('No design runs to import'); return; }

    const factorNames = Object.keys(runs[0].levels || {});
    const inputs = document.querySelectorAll('.doe-response-input');
    const hasResponses = Array.from(inputs).some(inp => inp.value.trim() !== '');
    const cols = [...factorNames, ...(hasResponses ? ['Response'] : [])];
    let csv = cols.join(',') + '\n';
    runs.forEach((run, i) => {
        const lvls = run.levels || {};
        const row = factorNames.map(f => lvls[f] ?? '');
        if (hasResponses) row.push(inputs[i]?.value || '');
        csv += row.join(',') + '\n';
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const formData = new FormData();
    formData.append('file', blob, 'doe_design.csv');

    showLoading(true, 'Importing DOE data...');
    try {
        const { response, data } = await apiPost('/api/dsw/upload-data/', formData, true);
        showLoading(false);
        if (data.error) { alert(data.error); return; }
        dswDataId = data.id;
        uploadedData = { filename: 'doe_design.csv', row_count: data.rows, columns: data.columns, preview: data.preview };
        displayDataTable(uploadedData);
        showToast('DOE data imported \u2014 all DSW analyses now available');
    } catch (err) { showLoading(false); alert('Import failed: ' + err.message); }
}

function exportDOECSV() {
    if (!currentDoeDesign) { alert('No design to export'); return; }
    const { runs } = currentDoeDesign;
    if (!runs || runs.length === 0) return;

    const factorNames = Object.keys(runs[0].levels || {});
    const inputs = document.querySelectorAll('.doe-response-input');
    const hasResponses = Array.from(inputs).some(inp => inp.value.trim() !== '');
    const cols = ['Run', ...factorNames, ...(hasResponses ? ['Response'] : [])];
    let csv = cols.join(',') + '\n';
    runs.forEach((run, i) => {
        const lvls = run.levels || {};
        const row = [run.run_order || run.run_id || (i + 1), ...factorNames.map(f => lvls[f] ?? '')];
        if (hasResponses) row.push(inputs[i]?.value || '');
        csv += row.join(',') + '\n';
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `doe_${currentDoeDesign.doeType}_${runs.length}runs.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
}

function openDOEAnalysisDialog(type) {
    if (!dswDataId) {
        if (currentDoeDesign) {
            alert('Import the DOE design to the workbench first (click "Import to Workbench")');
        } else {
            alert('Upload data or import a DOE design first');
        }
        return;
    }
    const numCols = getNumericColumns();
    const allCols = getAllColumns();
    const numOpts = numCols.map(c => `<option value="${c}">${c}</option>`).join('');
    const allOpts = allCols.map(c => `<option value="${c}">${c}</option>`).join('');

    if (type === 'main_effects') {
        const factorChecks = allCols.map(c => `<label><input type="checkbox" value="${c}"> ${c}</label>`).join('');
        const html = `
            <div class="form-row"><label>Response Variable</label><select id="dlg-doe-response">${numOpts}</select></div>
            <div class="form-row"><label>Factors</label>
                <div class="checkbox-grid" id="dlg-doe-factors">
                    <div class="select-actions">
                        <a onclick="document.querySelectorAll('#dlg-doe-factors input').forEach(c=>c.checked=true)">Select All</a>
                        <a onclick="document.querySelectorAll('#dlg-doe-factors input').forEach(c=>c.checked=false)">Clear All</a>
                    </div>
                    ${factorChecks}
                </div>
            </div>`;
        openModal('Main Effects Plot', html, 'Run', async () => {
            const response = document.getElementById('dlg-doe-response').value;
            const factors = Array.from(document.querySelectorAll('#dlg-doe-factors input:checked')).map(c => c.value);
            if (!response || factors.length === 0) { alert('Select response and at least one factor'); return; }
            closeModal();
            runStatsAnalysis('stats', 'main_effects', { response, factors }, 'Main Effects');
        });
    } else if (type === 'interaction') {
        const html = `
            <div class="form-row"><label>Response Variable</label><select id="dlg-doe-response">${numOpts}</select></div>
            <div class="form-row"><label>Factor 1</label><select id="dlg-doe-factor1">${allOpts}</select></div>
            <div class="form-row"><label>Factor 2</label><select id="dlg-doe-factor2">${allOpts}</select></div>`;
        openModal('Interaction Plot', html, 'Run', async () => {
            const response = document.getElementById('dlg-doe-response').value;
            const factor1 = document.getElementById('dlg-doe-factor1').value;
            const factor2 = document.getElementById('dlg-doe-factor2').value;
            if (!response || !factor1 || !factor2 || factor1 === factor2) { alert('Select response and two different factors'); return; }
            closeModal();
            runStatsAnalysis('stats', 'interaction', { response, factor1, factor2 }, 'Interaction');
        });
    }
}

function openDOEContourDialog() {
    if (!currentDoeDesign) { alert('Generate a design and enter response values first'); return; }
    const inputs = document.querySelectorAll('.doe-response-input');
    const hasResponses = Array.from(inputs).some(inp => inp.value.trim() !== '');
    if (!hasResponses) { alert('Enter response values in the DOE table first'); return; }

    const factorNames = Object.keys(currentDoeDesign.runs[0]?.levels || {});
    const opts = factorNames.map(f => `<option value="${f}">${f}</option>`).join('');
    const html = `
        <div class="form-row"><label>X-axis Factor</label><select id="dlg-contour-x">${opts}</select></div>
        <div class="form-row"><label>Y-axis Factor</label><select id="dlg-contour-y">${opts}</select></div>
        <div class="form-row"><label>Grid Resolution</label><input type="number" id="dlg-contour-res" value="25" min="10" max="100" step="5"></div>`;
    openModal('Contour Plot', html, 'Generate', async () => {
        const xFactor = document.getElementById('dlg-contour-x').value;
        const yFactor = document.getElementById('dlg-contour-y').value;
        if (xFactor === yFactor) { alert('Select two different factors'); return; }
        const resolution = parseInt(document.getElementById('dlg-contour-res').value) || 25;

        // Collect response values
        const results = [];
        inputs.forEach((inp, i) => {
            const val = parseFloat(inp.value);
            if (!isNaN(val)) results.push({ run_id: i + 1, response: val });
        });

        closeModal();
        showLoading(true, 'Generating contour plot...');
        try {
            const { response, data } = await apiPost('/api/experimenter/contour/', {
                design: currentDoeDesign.design,
                results,
                x_factor: xFactor,
                y_factor: yFactor,
                resolution,
                include_quadratic: true,
            });
            showLoading(false);
            if (data.error) { alert(data.error); return; }

            const c = data.contour || {};
            const plotId = `contour-${outputCounter}`;
            let html = `<div id="${plotId}" class="stats-plot" style="height:500px;"></div>`;
            if (data.optimal_point) {
                const op = data.optimal_point;
                html += `<p style="margin-top:0.5rem;color:var(--text-dim);font-size:0.85rem;">Optimal: ${xFactor} = ${fmt(op.x, 2)}, ${yFactor} = ${fmt(op.y, 2)}, Response = ${fmt(op.z, 2)}</p>`;
            }
            addOutput('Contour: ' + xFactor + ' vs ' + yFactor, html);
            setTimeout(() => {
                Plotly.newPlot(plotId, [{
                    type: 'contour', x: c.x, y: c.y, z: c.z,
                    colorscale: 'Viridis', contours: { showlabels: true },
                }], {
                    template: 'plotly_dark', paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
                    margin: { t: 40, r: 20, b: 50, l: 60 },
                    xaxis: { title: c.x_label || xFactor }, yaxis: { title: c.y_label || yFactor },
                    title: { text: 'Response Surface', font: { size: 14, color: '#b0b0b0' } },
                }, { responsive: true, displayModeBar: false });
            }, 50);
        } catch (err) { showLoading(false); alert('Contour failed: ' + err.message); }
    });
}

function openDOEOptimizeDialog() {
    if (!currentDoeDesign) { alert('Generate a design and enter response values first'); return; }
    const inputs = document.querySelectorAll('.doe-response-input');
    const hasResponses = Array.from(inputs).some(inp => inp.value.trim() !== '');
    if (!hasResponses) { alert('Enter response values in the DOE table first'); return; }

    const html = `
        <div class="form-row"><label>Response Name</label><input type="text" id="dlg-opt-name" value="Response"></div>
        <div class="form-row"><label>Goal</label><select id="dlg-opt-goal">
            <option value="maximize">Maximize</option>
            <option value="minimize">Minimize</option>
            <option value="target">Hit Target</option>
        </select></div>
        <div class="form-row"><label>Target Value (for target goal)</label><input type="number" id="dlg-opt-target" step="any" value="0"></div>
        <div class="form-row-inline">
            <div class="form-row"><label>Lower Bound</label><input type="number" id="dlg-opt-lower" step="any" value=""></div>
            <div class="form-row"><label>Upper Bound</label><input type="number" id="dlg-opt-upper" step="any" value=""></div>
        </div>`;
    openModal('Optimize Response', html, 'Optimize', async () => {
        const results = [];
        inputs.forEach((inp, i) => {
            const val = parseFloat(inp.value);
            if (!isNaN(val)) results.push({ run_id: i + 1, response: val });
        });

        const respConfig = {
            name: document.getElementById('dlg-opt-name').value || 'Response',
            results,
            goal: document.getElementById('dlg-opt-goal').value,
            target: parseFloat(document.getElementById('dlg-opt-target').value) || 0,
            lower: parseFloat(document.getElementById('dlg-opt-lower').value) || undefined,
            upper: parseFloat(document.getElementById('dlg-opt-upper').value) || undefined,
            weight: 1,
        };

        closeModal();
        showLoading(true, 'Optimizing response...');
        try {
            const { response, data } = await apiPost('/api/experimenter/optimize/', {
                design: currentDoeDesign.design,
                responses: [respConfig],
            });
            showLoading(false);
            if (data.error) { alert(data.error); return; }

            const opt = data.optimization || {};
            let html = '<h4 style="color:var(--text);margin:0 0 0.5rem;">Optimization Results</h4>';
            if (opt.optimal_settings) {
                html += '<table class="doe-table"><thead><tr><th>Factor</th><th>Optimal Setting</th></tr></thead><tbody>';
                Object.entries(opt.optimal_settings).forEach(([k, v]) => {
                    html += `<tr><td>${k}</td><td>${fmt(v, 3)}</td></tr>`;
                });
                html += '</tbody></table>';
            }
            if (opt.predicted_responses) {
                html += '<p style="margin-top:0.5rem;color:var(--text-dim);font-size:0.85rem;"><strong>Predicted:</strong> ';
                html += Object.entries(opt.predicted_responses).map(([k, v]) => `${k} = ${fmt(v, 3)}`).join(', ');
                html += '</p>';
            }
            if (opt.composite_desirability != null) {
                html += `<p style="color:var(--text-dim);font-size:0.85rem;">Composite Desirability: ${fmt(opt.composite_desirability, 4)}</p>`;
            }
            if (data.interpretation && data.interpretation.length) {
                html += '<div style="margin-top:0.75rem;padding:0.5rem;background:var(--bg-secondary);border-radius:6px;font-size:0.85rem;color:var(--text-dim);">';
                data.interpretation.forEach(line => { html += `<p style="margin:0.25rem 0;">${line}</p>`; });
                html += '</div>';
            }
            addOutput('DOE Optimization', html);
        } catch (err) { showLoading(false); alert('Optimization failed: ' + err.message); }
    });
}

let doeChat = [];
function openDOEChatDialog() {
    const ctx = {};
    if (currentDoeDesign) {
        ctx.design = currentDoeDesign.design;
        ctx.factors = currentDoeDesign.factors;
    }

    const historyHtml = doeChat.map(m =>
        `<div style="margin-bottom:0.5rem;${m.role === 'assistant' ? 'color:var(--accent);' : ''}"><strong>${m.role === 'user' ? 'You' : 'DOE Guide'}:</strong> ${m.content}</div>`
    ).join('');

    const html = `
        <div id="doe-chat-history" style="max-height:300px;overflow-y:auto;margin-bottom:0.75rem;padding:0.5rem;background:var(--bg-secondary);border-radius:6px;font-size:0.85rem;">
            ${historyHtml || '<p style="color:var(--text-dim);">Ask questions about DOE design, factor selection, analysis interpretation, or optimization.</p>'}
        </div>
        <div class="form-row"><label>Your Question</label><textarea id="dlg-doe-chat-msg" rows="3" placeholder="e.g., How many runs do I need for 5 factors? Should I use CCD or Box-Behnken?"></textarea></div>`;
    openModal('DOE Guidance', html, 'Ask', async () => {
        const msg = document.getElementById('dlg-doe-chat-msg').value.trim();
        if (!msg) return;

        doeChat.push({ role: 'user', content: msg });
        closeModal();
        showLoading(true, 'Consulting DOE guide...');
        try {
            const { response, data } = await apiPost('/api/experimenter/chat/', {
                message: msg,
                context: ctx,
                history: doeChat.slice(0, -1),
            });
            showLoading(false);
            if (data.error) { alert(data.error); return; }
            const reply = data.response || 'No response';
            doeChat.push({ role: 'assistant', content: reply });
            addOutput('DOE Guide', `<pre class="stats-summary">${reply}</pre>`);
            // Reopen chat so user can continue
            openDOEChatDialog();
        } catch (err) { showLoading(false); alert('Chat failed: ' + err.message); }
    });
}

// =============================================================================
// Power Analysis
// =============================================================================
function openPowerDialog() {
    const powerTests = {
        'power_z': { name: '1-Sample Z', fields: [
            {id:'delta', label:'Difference (Î´)', val:'0.5', step:'0.1'},
            {id:'sigma', label:'Std Dev (Ï)', val:'1.0', step:'0.1'}
        ]},
        'power_1prop': { name: '1-Proportion', fields: [
            {id:'p0', label:'Null proportion (pâ)', val:'0.5', step:'0.01'},
            {id:'pa', label:'Alt proportion (pâ)', val:'0.65', step:'0.01'}
        ]},
        'power_2prop': { name: '2-Proportion', fields: [
            {id:'p1', label:'Proportion 1 (pâ)', val:'0.5', step:'0.01'},
            {id:'p2', label:'Proportion 2 (pâ)', val:'0.65', step:'0.01'},
            {id:'ratio', label:'nâ/nâ ratio', val:'1.0', step:'0.1'}
        ]},
        'power_1variance': { name: '1-Variance', fields: [
            {id:'sigma0', label:'Null Ïâ', val:'1.0', step:'0.1'},
            {id:'sigma1', label:'Alt Ïâ', val:'1.5', step:'0.1'}
        ]},
        'power_2variance': { name: '2-Variance', fields: [
            {id:'variance_ratio', label:'Variance ratio (ÏâÂ²/ÏâÂ²)', val:'2.0', step:'0.1'},
            {id:'ratio', label:'nâ/nâ ratio', val:'1.0', step:'0.1'}
        ]},
        'power_equivalence': { name: 'Equivalence (TOST)', fields: [
            {id:'delta', label:'True difference (Î´)', val:'0.0', step:'0.1'},
            {id:'margin', label:'Equivalence margin (Â±)', val:'0.5', step:'0.1'},
            {id:'sigma', label:'Std Dev (Ï)', val:'1.0', step:'0.1'}
        ]},
        'power_doe': { name: 'DOE (2áµ Factorial)', fields: [
            {id:'factors', label:'Number of factors (k)', val:'3', step:'1', type:'int'},
            {id:'delta', label:'Min detectable effect (Î)', val:'1.0', step:'0.1'},
            {id:'sigma', label:'Std Dev (Ï)', val:'1.0', step:'0.1'}
        ]},
        'sample_size_ci': { name: 'Sample Size for CI', fields: [
            {id:'type', label:'Estimate type', val:'mean', select:['mean','proportion']},
            {id:'half_width', label:'Target half-width (margin of error)', val:'0.5', step:'0.1'},
            {id:'sigma', label:'Ï (for mean only)', val:'1.0', step:'0.1'},
            {id:'p_est', label:'p estimate (for proportion)', val:'0.5', step:'0.01'}
        ]},
        'sample_size_tolerance': { name: 'Tolerance Interval n', fields: [
            {id:'coverage', label:'Coverage (e.g. 0.99)', val:'0.99', step:'0.01'},
            {id:'confidence', label:'Confidence (e.g. 0.95)', val:'0.95', step:'0.01'},
            {id:'type', label:'Interval type', val:'two-sided', select:['two-sided','one-sided']}
        ]}
    };

    const testOpts = Object.entries(powerTests).map(([k,v]) => `<option value="${k}">${v.name}</option>`).join('');

    function buildFields(testId) {
        const t = powerTests[testId];
        return t.fields.map(f => {
            if (f.select) {
                const opts = f.select.map(o => `<option value="${o}" ${o===f.val?'selected':''}>${o}</option>`).join('');
                return `<div class="form-row"><label>${f.label}</label><select id="dlg-pwr-${f.id}">${opts}</select></div>`;
            }
            return `<div class="form-row"><label>${f.label}</label><input type="number" id="dlg-pwr-${f.id}" step="${f.step||'0.1'}" value="${f.val}"></div>`;
        }).join('');
    }

    let html = `
        <div class="form-row"><label>Calculator</label><select id="dlg-pwr-test" onchange="document.getElementById('dlg-pwr-fields').innerHTML=window._pwrBuildFields(this.value)">${testOpts}</select></div>
        <div id="dlg-pwr-fields">${buildFields('power_z')}</div>
        <div class="form-row-inline">
            <div class="form-row"><label>Alpha</label><input type="number" id="dlg-pwr-alpha" step="0.01" value="0.05"></div>
            <div class="form-row"><label>Power (1-Î²)</label><input type="number" id="dlg-pwr-power" step="0.01" value="0.80"></div>
            <div class="form-row"><label>Confidence %</label><input type="number" id="dlg-pwr-conf" step="1" value="95"></div>
        </div>`;
    window._pwrBuildFields = buildFields;
    openModal('Power & Sample Size Calculator', html, 'Calculate', runPower);
}

async function runPower() {
    const testType = document.getElementById('dlg-pwr-test').value;
    const config = {
        alpha: parseFloat(document.getElementById('dlg-pwr-alpha').value),
        power: parseFloat(document.getElementById('dlg-pwr-power').value),
        conf: parseInt(document.getElementById('dlg-pwr-conf').value),
    };
    // Collect all dlg-pwr-* fields
    document.querySelectorAll('#dlg-pwr-fields input, #dlg-pwr-fields select').forEach(el => {
        const key = el.id.replace('dlg-pwr-', '');
        config[key] = el.value;
    });
    closeModal();
    runStatsAnalysis('stats', testType, config, testType.replace(/_/g, ' '));
}

// =============================================================================
// ML: From Intent / From Data
// =============================================================================
function openMLDialog(mode) {
    let html = '';
    if (mode === 'intent') {
        html = `
            <div class="form-row"><label>What do you want to predict?</label>
                <textarea id="dlg-ml-intent" rows="3" placeholder="e.g., Predict which customers will churn in the next 30 days based on usage patterns"></textarea></div>
            <div class="form-row-inline">
                <div class="form-row"><label>Domain</label><select id="dlg-ml-domain">
                    <option value="">Auto-detect</option>
                    <option value="churn">Customer Churn</option><option value="fraud">Fraud Detection</option>
                    <option value="lead_scoring">Lead Scoring</option><option value="quality">Quality Prediction</option>
                </select></div>
                <div class="form-row"><label>Sample Size</label><select id="dlg-ml-n">
                    <option value="100">100</option><option value="500" selected>500</option><option value="1000">1,000</option><option value="5000">5,000</option>
                </select></div>
            </div>
            <div class="form-row"><label>Priority</label><select id="dlg-ml-priority">
                <option value="balanced">Balanced</option><option value="accuracy">Max Accuracy</option>
                <option value="interpretability">Interpretability</option><option value="speed">Speed</option>
            </select></div>`;
        openModal('Train Model from Intent', html, 'Generate & Train', async () => {
            const data = {
                intent: document.getElementById('dlg-ml-intent').value,
                domain: document.getElementById('dlg-ml-domain').value || null,
                n_records: parseInt(document.getElementById('dlg-ml-n').value),
                priority: document.getElementById('dlg-ml-priority').value,
            };
            closeModal();
            showLoading(true, 'Generating schema, data, and training model...');
            try {
                const { response: r, data: result } = await apiPost('/api/dsw/from-intent/', data);
                showLoading(false);
                if (result.error) { alert(result.error); return; }
                renderMLOutput(result);
            } catch (err) { showLoading(false); alert('Error: ' + err.message); }
        });
    } else {
        html = `
            <div class="form-row"><label>Upload CSV</label><input type="file" id="dlg-ml-file" accept=".csv"></div>
            <div class="form-row-inline">
                <div class="form-row"><label>Target Column</label><input type="text" id="dlg-ml-target" placeholder="e.g., churned"></div>
                <div class="form-row"><label>Priority</label><select id="dlg-ml-data-priority">
                    <option value="balanced">Balanced</option><option value="accuracy">Max Accuracy</option><option value="interpretability">Interpretability</option>
                </select></div>
            </div>
            <div class="form-row"><label>Intent (optional)</label><textarea id="dlg-ml-data-intent" rows="2" placeholder="What are you trying to predict?"></textarea></div>`;
        openModal('Train Model from Data', html, 'Clean & Train', async () => {
            const formData = new FormData();
            const fileEl = document.getElementById('dlg-ml-file');
            if (!fileEl.files[0]) { alert('Please select a file'); return; }
            formData.append('file', fileEl.files[0]);
            formData.append('target', document.getElementById('dlg-ml-target').value);
            formData.append('intent', document.getElementById('dlg-ml-data-intent').value);
            formData.append('priority', document.getElementById('dlg-ml-data-priority').value);
            closeModal();
            showLoading(true, 'Cleaning data and training model...');
            try {
                const { response: r, data: result } = await apiPost('/api/dsw/from-data/', formData, true);
                showLoading(false);
                if (result.error) { alert(result.error); return; }
                renderMLOutput(result);
            } catch (err) { showLoading(false); alert('Error: ' + err.message); }
        });
    }
}

// =============================================================================
// ML: Ribbon-based dialogs for ML methods
// =============================================================================
function openMLStatsDialog(type) {
    if (!dswDataId) { alert('Please import a data file first'); return; }
    const numCols = getNumericColumns();
    const allCols = getAllColumns();
    const numOpts = numCols.map(c => `<option value="${c}">${c}</option>`).join('');
    const allOpts = allCols.map(c => `<option value="${c}">${c}</option>`).join('');
    const featChecks = numCols.map(c => `<label><input type="checkbox" value="${c}"> ${c}</label>`).join('');
    const allFeatChecks = allCols.map(c => `<label><input type="checkbox" value="${c}"> ${c}</label>`).join('');
    const selectActions = `<div class="select-actions">
        <a onclick="document.querySelectorAll('#dlg-ml-features input').forEach(c=>c.checked=true)">Select All</a>
        <a onclick="document.querySelectorAll('#dlg-ml-features input').forEach(c=>c.checked=false)">Clear All</a></div>`;

    let html = '', title = '', handler;

    if (type === 'classification' || type === 'regression_ml') {
        const isClass = type === 'classification';
        title = isClass ? 'Classification' : 'ML Regression';
        html = `
            <div class="form-row"><label>Target</label><select id="dlg-mls-target">${isClass ? allOpts : numOpts}</select></div>
            <div class="form-row"><label>Features</label>
                <div class="checkbox-grid" id="dlg-ml-features">${selectActions}${featChecks}</div></div>
            ${isClass ? `<div class="form-row"><label>Algorithm</label><select id="dlg-mls-algo">
                <option value="rf">Random Forest</option><option value="logistic">Logistic Regression</option>
            </select></div>` : ''}
            <div class="form-row"><label>Test Split</label><select id="dlg-mls-split">
                <option value="20" selected>20%</option><option value="30">30%</option></select></div>`;
        handler = async () => {
            const target = document.getElementById('dlg-mls-target').value;
            const features = Array.from(document.querySelectorAll('#dlg-ml-features input:checked')).map(c => c.value).filter(f => f !== target);
            if (features.length === 0) { alert('Select at least one feature'); return; }
            const config = { target, features, split: parseInt(document.getElementById('dlg-mls-split').value) };
            if (isClass) config.algorithm = document.getElementById('dlg-mls-algo').value;
            closeModal();
            await runStatsAnalysis('ml', type, config, title);
        };
    } else if (['pca', 'clustering', 'isolation_forest', 'feature'].includes(type)) {
        const titles = { pca: 'Principal Component Analysis', clustering: 'K-Means Clustering', isolation_forest: 'Anomaly Detection (Isolation Forest)', feature: 'Feature Importance' };
        title = titles[type];
        html = `<div class="form-row"><label>Features</label>
            <div class="checkbox-grid" id="dlg-ml-features">${selectActions}${featChecks}</div></div>`;
        if (type === 'clustering') {
            html += `<div class="form-row"><label>Clusters (k)</label><select id="dlg-mls-k">
                <option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option><option value="8">8</option>
            </select></div>`;
        }
        if (type === 'feature') {
            html = `<div class="form-row"><label>Target</label><select id="dlg-mls-target">${allOpts}</select></div>` + html;
        }
        if (type === 'isolation_forest') {
            html += `<div class="form-row"><label>Contamination</label><select id="dlg-mls-contam">
                <option value="auto">Auto</option><option value="0.05">5%</option><option value="0.1" selected>10%</option><option value="0.2">20%</option>
            </select></div>`;
        }
        handler = async () => {
            const features = Array.from(document.querySelectorAll('#dlg-ml-features input:checked')).map(c => c.value);
            if (features.length < 2) { alert('Select at least 2 features'); return; }
            const config = { features };
            if (type === 'clustering') config.k = parseInt(document.getElementById('dlg-mls-k').value);
            if (type === 'feature') { config.target = document.getElementById('dlg-mls-target').value; config.features = features.filter(f => f !== config.target); }
            if (type === 'isolation_forest') config.contamination = document.getElementById('dlg-mls-contam').value;
            closeModal();
            await runStatsAnalysis('ml', type, config, title);
        };
    } else if (['gam', 'gaussian_process', 'bayesian_regression', 'pls'].includes(type)) {
        const titles = { gam: 'Generalized Additive Model', gaussian_process: 'Gaussian Process Regression', bayesian_regression: 'Bayesian Regression', pls: 'Partial Least Squares' };
        title = titles[type];
        html = `
            <div class="form-row"><label>Target</label><select id="dlg-mls-target">${numOpts}</select></div>
            <div class="form-row"><label>Predictors</label>
                <div class="checkbox-grid" id="dlg-ml-features">${selectActions}${featChecks}</div></div>`;
        if (type === 'pls') {
            html += `<div class="form-row"><label>Components</label><select id="dlg-mls-nc">
                <option value="2" selected>2</option><option value="3">3</option><option value="5">5</option>
            </select></div>`;
        }
        handler = async () => {
            const target = document.getElementById('dlg-mls-target').value;
            const features = Array.from(document.querySelectorAll('#dlg-ml-features input:checked')).map(c => c.value).filter(f => f !== target);
            if (features.length === 0) { alert('Select at least one predictor'); return; }
            const config = { target, features };
            if (type === 'pls') config.n_components = parseInt(document.getElementById('dlg-mls-nc').value);
            closeModal();
            await runStatsAnalysis('ml', type, config, title);
        };
    } else if (type === 'sem') {
        title = 'Structural Equation Modeling';
        html = `
            <div class="form-row"><label>Observed Variables</label>
                <div class="checkbox-grid" id="dlg-ml-features">${selectActions}${featChecks}</div></div>
            <div class="form-row"><label>Latent Factors</label><select id="dlg-mls-nfac">
                <option value="2" selected>2</option><option value="3">3</option><option value="4">4</option>
            </select></div>`;
        handler = async () => {
            const features = Array.from(document.querySelectorAll('#dlg-ml-features input:checked')).map(c => c.value);
            if (features.length < 3) { alert('Select at least 3 variables'); return; }
            closeModal();
            await runStatsAnalysis('ml', 'sem', { features, n_factors: parseInt(document.getElementById('dlg-mls-nfac').value) }, title);
        };
    }

    openModal(title, html, 'Run', handler);
}

function renderMLOutput(result) {
    let html = '';
    if (result.schema) html += `<p style="margin-bottom:0.5rem;"><strong>Schema:</strong> ${result.schema.name} (${result.schema.domain})</p>`;
    if (result.data_shape) html += `<p style="margin-bottom:0.5rem;"><strong>Data:</strong> ${result.data_shape[0]} rows, ${result.data_shape[1]} columns</p>`;
    if (result.model_type) html += `<p style="margin-bottom:0.75rem;"><strong>Model:</strong> ${result.model_type}</p>`;

    if (result.metrics) {
        html += '<div class="metric-grid">';
        for (const [name, value] of Object.entries(result.metrics)) {
            const v = typeof value === 'number' ? value.toFixed(3) : value;
            html += `<div class="metric-card"><div class="metric-value">${v}</div><div class="metric-label">${name}</div></div>`;
        }
        html += '</div>';
    }

    if (result.feature_importance && result.feature_importance.length > 0) {
        html += '<h4 style="margin:0.75rem 0 0.5rem;font-size:0.9rem;">Top Features</h4><ol style="margin:0;padding-left:1.5rem;">';
        result.feature_importance.slice(0, 10).forEach(f => {
            const name = f.feature || f[0];
            const imp = f.importance || f[1];
            html += `<li style="font-size:0.85rem;margin-bottom:0.25rem;">${name}: ${(imp * 100).toFixed(1)}%</li>`;
        });
        html += '</ol>';
    }

    addOutput('ML Model', html);
}

// =============================================================================
// THINKING TAB: Artifact CRUD (notes, hypotheses, evidence, etc.)
// =============================================================================
function createArtifact(type) {
    const typeLabels = {
        note: 'Note', hypothesis: 'Hypothesis', evidence: 'Evidence',
        conclusion: 'Conclusion', process_map: 'Process Map', fishbone: 'Fishbone',
        five_whys: '5 Whys', action_item: 'Action Item', control_plan: 'Control Plan'
    };

    let html = `<div class="form-row"><label>Title</label><input type="text" id="dlg-art-title" placeholder="Enter title..."></div>`;
    html += `<div class="form-row"><label>Content</label><textarea id="dlg-art-content" placeholder="Enter content..."></textarea></div>`;

    if (type === 'hypothesis') {
        html += `<div class="form-row"><label>Initial Probability (0-100%)</label><input type="number" id="dlg-art-prob" min="0" max="100" value="50"></div>`;
    }
    if (type === 'action_item') {
        html += `<div class="form-row-inline">
            <div class="form-row"><label>Assignee</label><input type="text" id="dlg-art-assignee"></div>
            <div class="form-row"><label>Due Date</label><input type="date" id="dlg-art-due"></div>
        </div>`;
    }

    openModal('New ' + (typeLabels[type] || type), html, 'Create', async () => {
        const title = document.getElementById('dlg-art-title').value;
        if (!title) { alert('Enter a title'); return; }
        const content = { text: document.getElementById('dlg-art-content').value };
        if (type === 'hypothesis') content.initial_probability = parseInt(document.getElementById('dlg-art-prob')?.value || 50) / 100;
        if (type === 'action_item') {
            content.assignee = document.getElementById('dlg-art-assignee')?.value;
            content.due_date = document.getElementById('dlg-art-due')?.value;
        }

        closeModal();

        // Show in output immediately
        let artHtml = `<p><strong>${title}</strong></p><p>${content.text || ''}</p>`;
        if (content.initial_probability != null) artHtml += `<p>Initial probability: ${(content.initial_probability * 100).toFixed(0)}%</p>`;
        if (content.assignee) artHtml += `<p><em>Assignee: ${content.assignee}</em></p>`;
        if (content.due_date) artHtml += `<p><em>Due: ${content.due_date}</em></p>`;
        addOutput(typeLabels[type] || type, artHtml);

        // Persist to backend if workbench is saved
        if (currentWorkbench) {
            try {
                const data = await apiCall(`${currentWorkbench.id}/artifacts/`, 'POST', {
                    type, title, content, source: 'user',
                    probability: type === 'hypothesis' ? content.initial_probability : null
                });
                if (data.artifact) artifacts.push(data.artifact);
            } catch (err) { console.warn('Could not save artifact to server:', err); }
        }
    });
}

// =============================================================================
// WORKBENCH CRUD
// =============================================================================
async function loadWorkbench(id) {
    try {
        const data = await apiCall(`${id}/`);
        currentWorkbench = data;
        document.getElementById('workbench-title').value = data.inquiry || '';
        document.getElementById('workbench-template').value = data.template || 'blank';
        document.getElementById('workbench-status').textContent = data.status || 'Active';
        updatePhaseBar(data.template);
        artifacts = data.artifacts || [];
        history.replaceState({}, '', `/app/new/?id=${id}`);
    } catch (err) { console.error('Failed to load workbench:', err); }
}

async function saveWorkbench() {
    const title = document.getElementById('workbench-title').value.trim();
    const template = document.getElementById('workbench-template').value;
    if (!title) { alert('Enter a title'); return; }
    try {
        if (currentWorkbench) {
            const result = await apiCall(`${currentWorkbench.id}/update/`, 'PATCH', { title, template });
            if (result.error === 'auth') { alert('Please log in to save'); return; }
        } else {
            const data = await apiCall('create/', 'POST', { title, template });
            if (data.error === 'auth') { alert('Please log in to save'); return; }
            if (data.workbench) {
                currentWorkbench = { id: data.workbench.id };
                history.replaceState({}, '', `/app/new/?id=${currentWorkbench.id}`);
            }
        }
        showToast('Saved');
    } catch (err) { alert('Save failed: ' + err.message); }
}

function showWorkbenchList() {
    document.getElementById('workbench-list-modal').style.display = 'flex';
    loadWorkbenchList();
}
function closeWorkbenchList() { document.getElementById('workbench-list-modal').style.display = 'none'; }

async function loadWorkbenchList() {
    try {
        const data = await apiCall('');
        const list = document.getElementById('workbench-list');
        if (data.error === 'auth') {
            list.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--text-dim);"><a href="/login/?next=/app/new/" style="color:var(--accent);">Log in</a> to save and load workbenches.</div>';
            return;
        }
        if (!data.workbenches || data.workbenches.length === 0) {
            list.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--text-dim);">No workbenches yet. Create your first one!</div>';
            return;
        }
        list.innerHTML = data.workbenches.map(wb => `
            <div class="workbench-list-item" onclick="closeWorkbenchList(); loadWorkbench('${wb.id}')">
                <div class="workbench-list-info">
                    <h4>${wb.title}</h4>
                    <div class="workbench-list-meta">${wb.artifact_count} artifacts &middot; ${new Date(wb.updated_at).toLocaleDateString()}</div>
                </div>
                <div class="workbench-list-badge">${wb.template}</div>
            </div>
        `).join('');
    } catch (err) { console.error(err); }
}

function createNewWorkbench() {
    closeWorkbenchList();
    currentWorkbench = null;
    artifacts = [];
    document.getElementById('workbench-title').value = '';
    document.getElementById('workbench-template').value = 'blank';
    document.getElementById('phase-bar').style.display = 'none';
    clearOutput();
    history.replaceState({}, '', '/app/new/');
}

async function exportWorkbench() {
    if (!currentWorkbench) { alert('Save first'); return; }
    try {
        const data = await apiCall(`${currentWorkbench.id}/`);
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `${data.inquiry || 'workbench'}.json`; a.click();
    } catch (err) { console.error(err); }
}

async function advancePhase() {
    if (!currentWorkbench) return;
    try {
        await apiCall(`${currentWorkbench.id}/advance-phase/`, 'POST');
        await loadWorkbench(currentWorkbench.id);
    } catch (err) { console.error(err); }
}
</script>
{% endblock %}
