{% extends "base_app.html" %}

{% block title %}My Models - SVEND{% endblock %}

{% block content %}
<div class="models-page">
    <div class="page-header">
        <h1>Saved Models</h1>
        <p class="subtitle">Your trained ML models from DSW pipeline runs</p>
    </div>

    <div id="models-list" class="models-grid">
        <div class="loading">Loading models...</div>
    </div>

    <div id="empty-state" class="empty-state" style="display: none;">
        <p>No saved models yet.</p>
        <p>Run a DSW pipeline to train and save a model.</p>
        <a href="/app/dsw/" class="btn btn-primary">Go to DSW Pipeline</a>
    </div>
</div>

<!-- Model Details Modal -->
<div id="model-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-title">Model Details</h2>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="modal-details"></div>

            <h3>Run Inference</h3>
            <div class="inference-section">
                <p>Upload a CSV file to get predictions:</p>
                <input type="file" id="inference-file" accept=".csv">
                <button class="btn btn-primary" onclick="runInference()">Run Prediction</button>
            </div>

            <div id="inference-results" style="display: none;">
                <h4>Results</h4>
                <pre id="predictions-output"></pre>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="downloadModel()">Download Model (.pkl)</button>
            <button class="btn btn-danger" onclick="deleteModel()">Delete Model</button>
        </div>
    </div>
</div>

<style>
    .models-page {
        max-width: 1200px;
        margin: 0 auto;
    }

    .page-header {
        margin-bottom: 2rem;
    }

    .subtitle {
        color: var(--text-dim);
    }

    .models-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .model-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 1.5rem;
        cursor: pointer;
        transition: border-color 0.2s;
    }

    .model-card:hover {
        border-color: var(--accent-primary);
    }

    .model-card h3 {
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
    }

    .model-type {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        background: rgba(74, 159, 110, 0.15);
        color: var(--accent-primary);
        border-radius: 4px;
        font-size: 0.8rem;
        margin-bottom: 0.75rem;
    }

    .model-meta {
        font-size: 0.85rem;
        color: var(--text-dim);
    }

    .model-meta p {
        margin-bottom: 0.25rem;
    }

    .metrics-preview {
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid var(--border);
    }

    .metrics-preview span {
        display: inline-block;
        margin-right: 1rem;
        font-size: 0.85rem;
    }

    .metric-value {
        color: var(--accent-primary);
        font-weight: 500;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--text-dim);
    }

    .loading {
        text-align: center;
        padding: 2rem;
        color: var(--text-dim);
    }

    /* Modal styles */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background-color: var(--card-bg) !important;
        border: 1px solid var(--border);
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid var(--border);
    }

    .modal-header h2 {
        margin: 0;
        font-size: 1.25rem;
    }

    .close-btn {
        background: none;
        border: none;
        color: var(--text-dim);
        font-size: 1.5rem;
        cursor: pointer;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-body h3 {
        font-size: 1rem;
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
    }

    .modal-footer {
        display: flex;
        gap: 1rem;
        padding: 1.5rem;
        border-top: 1px solid var(--border);
    }

    .inference-section {
        margin-top: 0.75rem;
    }

    .inference-section input {
        margin: 0.5rem 0;
    }

    #predictions-output {
        background: var(--bg-primary);
        padding: 1rem;
        border-radius: 4px;
        font-size: 0.85rem;
        max-height: 200px;
        overflow-y: auto;
    }

    .btn-danger {
        background: var(--error-dim);
        border: 1px solid var(--error-border);
        color: var(--error);
    }
</style>

<script>
    let models = [];
    let selectedModel = null;

    async function loadModels() {
        try {
            const response = await fetch('/api/dsw/models/', { credentials: 'include' });
            const data = await response.json();
            models = data.models || [];
            renderModels();
        } catch (err) {
            console.error('Failed to load models:', err);
            document.getElementById('models-list').innerHTML = '<p class="error">Failed to load models</p>';
        }
    }

    function renderModels() {
        const container = document.getElementById('models-list');
        const emptyState = document.getElementById('empty-state');

        if (models.length === 0) {
            container.style.display = 'none';
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';
        container.style.display = 'grid';

        container.innerHTML = models.map(model => {
            const metrics = model.metrics || {};
            const accuracy = metrics.accuracy ? (metrics.accuracy * 100).toFixed(1) + '%' : '-';
            const date = new Date(model.created_at).toLocaleDateString();

            return `
                <div class="model-card" onclick="showModel('${model.id}')">
                    <h3>${model.name}</h3>
                    <span class="model-type">${model.model_type}</span>
                    <div class="model-meta">
                        <p>Target: ${model.target || 'N/A'}</p>
                        <p>Created: ${date}</p>
                    </div>
                    <div class="metrics-preview">
                        <span>Accuracy: <span class="metric-value">${accuracy}</span></span>
                    </div>
                </div>
            `;
        }).join('');
    }

    function showModel(modelId) {
        selectedModel = models.find(m => m.id === modelId);
        if (!selectedModel) return;

        document.getElementById('modal-title').textContent = selectedModel.name;

        const metrics = selectedModel.metrics || {};
        const features = selectedModel.features || [];

        document.getElementById('modal-details').innerHTML = `
            <p><strong>Model Type:</strong> ${selectedModel.model_type}</p>
            <p><strong>Target:</strong> ${selectedModel.target || 'N/A'}</p>
            <p><strong>Features:</strong> ${features.length > 0 ? features.join(', ') : 'N/A'}</p>
            <p><strong>Metrics:</strong></p>
            <ul>
                ${Object.entries(metrics).map(([k, v]) => `<li>${k}: ${typeof v === 'number' ? v.toFixed(4) : v}</li>`).join('')}
            </ul>
        `;

        document.getElementById('inference-results').style.display = 'none';
        document.getElementById('model-modal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('model-modal').style.display = 'none';
        selectedModel = null;
    }

    async function downloadModel() {
        if (!selectedModel) return;
        window.location.href = `/api/dsw/models/${selectedModel.id}/`;
    }

    async function deleteModel() {
        if (!selectedModel) return;
        if (!confirm('Are you sure you want to delete this model?')) return;

        try {
            const response = await fetch(`/api/dsw/models/${selectedModel.id}/delete/`, {
                method: 'DELETE',
                credentials: 'include',
            });

            if (response.ok) {
                closeModal();
                loadModels();
            } else {
                alert('Failed to delete model');
            }
        } catch (err) {
            alert('Error: ' + err.message);
        }
    }

    async function runInference() {
        if (!selectedModel) return;

        const fileInput = document.getElementById('inference-file');
        if (!fileInput.files[0]) {
            alert('Please select a CSV file');
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        try {
            const response = await fetch(`/api/dsw/models/${selectedModel.id}/run/`, {
                method: 'POST',
                credentials: 'include',
                body: formData,
            });

            const data = await response.json();

            if (response.ok) {
                document.getElementById('predictions-output').textContent = JSON.stringify(data.predictions, null, 2);
                document.getElementById('inference-results').style.display = 'block';
            } else {
                alert('Error: ' + (data.error || 'Inference failed'));
            }
        } catch (err) {
            alert('Error: ' + err.message);
        }
    }

    // Close modal on outside click
    document.getElementById('model-modal').addEventListener('click', (e) => {
        if (e.target.id === 'model-modal') closeModal();
    });

    // Load models on page load
    loadModels();
</script>
{% endblock %}
