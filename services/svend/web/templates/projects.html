{% extends "base_app.html" %}
{% block title %}Studies - SVEND{% endblock %}

{% block content %}
<div class="projects-page">
    <!-- Header -->
    <div class="page-header">
        <div>
            <h1>Studies</h1>
            <p class="subtitle">Track hypotheses. Gather evidence. Find answers.</p>
        </div>
        <button class="btn btn-primary" onclick="showCreateModal()">+ New Study</button>
    </div>

    <!-- Status Filter -->
    <div class="status-filter">
        <button class="filter-btn active" data-status="all" onclick="filterByStatus('all')">All</button>
        <button class="filter-btn" data-status="active" onclick="filterByStatus('active')">Active</button>
        <button class="filter-btn" data-status="completed" onclick="filterByStatus('completed')">Completed</button>
    </div>

    <!-- Projects List -->
    <div id="projects-list">
        <div class="loading" id="loading-projects">
            <div class="spinner"></div>
            <span>Loading studies...</span>
        </div>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="empty-state" style="display: none;">
        <h3>No studies yet</h3>
        <p>Start by creating a hypothesis you want to investigate.</p>
        <button class="btn btn-primary" onclick="showCreateModal()">Create Your First Study</button>
    </div>
</div>

<!-- Create Project Modal (Charter Form) -->
<div id="create-modal" class="modal" style="display: none;">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h2>New Study Charter</h2>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>

        <form id="project-form" onsubmit="createProject(event)">
            <!-- Basic Info -->
            <div class="charter-section">
                <div class="form-row">
                    <div class="form-group flex-2">
                        <label for="project-title">Study Title *</label>
                        <input type="text" id="project-title" placeholder="e.g., Q4 Defect Rate Reduction" required>
                    </div>
                    <div class="form-group flex-1">
                        <label for="project-domain">Domain</label>
                        <select id="project-domain">
                            <option value="">Select...</option>
                            <option value="manufacturing">Manufacturing</option>
                            <option value="software">Software/SaaS</option>
                            <option value="healthcare">Healthcare</option>
                            <option value="finance">Finance</option>
                            <option value="retail">Retail</option>
                            <option value="research">Research</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Problem Definition (5W2H) -->
            <div class="charter-section collapsible">
                <h3 class="section-toggle" onclick="toggleSection(this)">
                    <span class="toggle-icon">▼</span> Problem Definition
                </h3>
                <div class="section-content">
                    <div class="form-group">
                        <label>What is happening? <small>(defect, issue, symptom)</small></label>
                        <div id="problem-whats-list" class="multi-input-list"></div>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="addListItem('problem-whats')">+ Add What</button>
                    </div>

                    <div class="form-group">
                        <label>Where is it occurring? <small>(location, process step, product line)</small></label>
                        <div id="problem-wheres-list" class="multi-input-list"></div>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="addListItem('problem-wheres')">+ Add Where</button>
                    </div>

                    <div class="form-group">
                        <label>When does it happen? <small>(time patterns, shifts, seasons)</small></label>
                        <div id="problem-whens-list" class="multi-input-list"></div>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="addListItem('problem-whens')">+ Add When</button>
                    </div>

                    <div class="form-row">
                        <div class="form-group flex-2">
                            <label for="problem-magnitude">How much / How often?</label>
                            <input type="text" id="problem-magnitude" placeholder="e.g., 15% defect rate, 3x per week">
                        </div>
                        <div class="form-group flex-1">
                            <label for="problem-trend">Trend</label>
                            <select id="problem-trend">
                                <option value="unknown">Unknown</option>
                                <option value="increasing">Getting Worse</option>
                                <option value="stable">Stable</option>
                                <option value="decreasing">Improving</option>
                            </select>
                        </div>
                        <div class="form-group flex-1">
                            <label for="problem-since">Since when?</label>
                            <input type="text" id="problem-since" placeholder="e.g., Jan 2026">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="problem-statement">Problem Statement <small>(auto-generated or custom)</small></label>
                        <textarea id="problem-statement" rows="2" placeholder="Will be generated from fields above, or write your own..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Business Impact -->
            <div class="charter-section collapsible">
                <h3 class="section-toggle" onclick="toggleSection(this)">
                    <span class="toggle-icon">▶</span> Business Impact
                </h3>
                <div class="section-content" style="display: none;">
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label for="impact-financial">Financial Impact</label>
                            <input type="text" id="impact-financial" placeholder="e.g., $50K/month scrap cost">
                        </div>
                        <div class="form-group flex-1">
                            <label for="impact-customer">Customer Impact</label>
                            <input type="text" id="impact-customer" placeholder="e.g., 12 complaints this quarter">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label for="impact-quality">Quality Impact</label>
                            <input type="text" id="impact-quality" placeholder="e.g., 15% yield loss">
                        </div>
                        <div class="form-group flex-1">
                            <label for="impact-delivery">Delivery Impact</label>
                            <input type="text" id="impact-delivery" placeholder="e.g., 5 late shipments">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label for="impact-safety">Safety Impact</label>
                            <input type="text" id="impact-safety" placeholder="e.g., 2 near-misses">
                        </div>
                        <div class="form-group flex-1">
                            <label for="impact-regulatory">Regulatory Impact</label>
                            <input type="text" id="impact-regulatory" placeholder="e.g., audit finding">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Goal Statement (SMART) -->
            <div class="charter-section collapsible">
                <h3 class="section-toggle" onclick="toggleSection(this)">
                    <span class="toggle-icon">▶</span> Goal Statement
                </h3>
                <div class="section-content" style="display: none;">
                    <div class="form-row">
                        <div class="form-group flex-2">
                            <label for="goal-metric">Metric to Improve</label>
                            <input type="text" id="goal-metric" placeholder="e.g., First Pass Yield">
                        </div>
                        <div class="form-group flex-1">
                            <label for="goal-unit">Unit</label>
                            <input type="text" id="goal-unit" placeholder="e.g., %">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label for="goal-baseline">Current Baseline</label>
                            <input type="text" id="goal-baseline" placeholder="e.g., 87%">
                        </div>
                        <div class="form-group flex-1">
                            <label for="goal-target">Target</label>
                            <input type="text" id="goal-target" placeholder="e.g., 95%">
                        </div>
                        <div class="form-group flex-1">
                            <label for="goal-deadline">Deadline</label>
                            <input type="date" id="goal-deadline">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="goal-statement">Goal Statement <small>(auto-generated or custom)</small></label>
                        <textarea id="goal-statement" rows="2" placeholder="Will be generated from fields above..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Scope -->
            <div class="charter-section collapsible">
                <h3 class="section-toggle" onclick="toggleSection(this)">
                    <span class="toggle-icon">▶</span> Scope
                </h3>
                <div class="section-content" style="display: none;">
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label>In Scope</label>
                            <div id="scope-in-list" class="multi-input-list"></div>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="addListItem('scope-in')">+ Add</button>
                        </div>
                        <div class="form-group flex-1">
                            <label>Out of Scope</label>
                            <div id="scope-out-list" class="multi-input-list"></div>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="addListItem('scope-out')">+ Add</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Constraints</label>
                        <div id="constraints-list" class="multi-input-list"></div>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="addListItem('constraints')">+ Add</button>
                    </div>
                    <div class="form-group">
                        <label>Assumptions</label>
                        <div id="assumptions-list" class="multi-input-list"></div>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="addListItem('assumptions')">+ Add</button>
                    </div>
                </div>
            </div>

            <!-- Team -->
            <div class="charter-section collapsible">
                <h3 class="section-toggle" onclick="toggleSection(this)">
                    <span class="toggle-icon">▶</span> Team
                </h3>
                <div class="section-content" style="display: none;">
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label for="champion-name">Champion (Sponsor)</label>
                            <input type="text" id="champion-name" placeholder="Name">
                        </div>
                        <div class="form-group flex-1">
                            <label for="champion-title">Title</label>
                            <input type="text" id="champion-title" placeholder="Title">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label for="leader-name">Study Lead</label>
                            <input type="text" id="leader-name" placeholder="Name">
                        </div>
                        <div class="form-group flex-1">
                            <label for="leader-title">Title</label>
                            <input type="text" id="leader-title" placeholder="Title">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Team Members</label>
                        <div id="team-members-list" class="multi-input-list"></div>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="addTeamMember()">+ Add Member</button>
                    </div>
                </div>
            </div>

            <!-- Timeline -->
            <div class="charter-section collapsible">
                <h3 class="section-toggle" onclick="toggleSection(this)">
                    <span class="toggle-icon">▶</span> Timeline
                </h3>
                <div class="section-content" style="display: none;">
                    <div class="form-group">
                        <label for="target-completion">Target Completion Date</label>
                        <input type="date" id="target-completion">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="can-experiment" checked>
                            Can run controlled experiments
                        </label>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Study</button>
            </div>
        </form>
    </div>
</div>

<!-- Project Detail View -->
<div id="detail-view" class="detail-view" style="display: none;">
    <div class="detail-header">
        <button class="btn btn-secondary btn-sm" onclick="backToList()">&larr; Back to Studies</button>
        <div class="detail-actions">
            <button class="btn btn-secondary btn-sm" onclick="editProject()">Edit</button>
            <button class="btn btn-secondary btn-sm" onclick="archiveProject()">Archive</button>
        </div>
    </div>

    <div class="detail-content">
        <div class="project-info">
            <div class="project-header">
                <h1 id="detail-title">Study Title</h1>
                <span class="status-badge" id="detail-status">active</span>
            </div>
            <div class="hypothesis-box">
                <label>Hypothesis</label>
                <p id="detail-hypothesis"></p>
            </div>
            <p class="project-description" id="detail-description"></p>
        </div>

        <!-- Hypotheses Section -->
        <div class="section">
            <div class="section-header">
                <h2>Hypotheses</h2>
                <button class="btn btn-primary btn-sm" onclick="showAddHypothesisModal()">+ Add Hypothesis</button>
            </div>
            <div id="hypotheses-list" class="hypotheses-list">
                <p class="empty-text">No hypotheses yet. Add one to start testing.</p>
            </div>
        </div>

        <!-- Workbenches Section -->
        <div class="section">
            <div class="section-header">
                <h2>Workbenches</h2>
                <button class="btn btn-primary btn-sm" onclick="showAddWorkbenchModal()">+ Add Workbench</button>
            </div>
            <div id="workbenches-list" class="workbenches-list">
                <p class="empty-text">No workbenches yet. Add one to start gathering evidence.</p>
            </div>
        </div>

        <!-- Datasets Section -->
        <div class="section">
            <div class="section-header">
                <h2>Datasets</h2>
                <div class="header-actions">
                    <button class="btn btn-secondary btn-sm" onclick="showUploadDatasetModal()">+ Upload</button>
                </div>
            </div>
            <div id="datasets-list" class="datasets-list">
                <p class="empty-text">No datasets yet. Upload data to begin analysis.</p>
            </div>
        </div>

        <!-- Experiment Designs Section -->
        <div class="section">
            <div class="section-header">
                <h2>Experiment Designs</h2>
                <button class="btn btn-secondary btn-sm" onclick="window.location.href='/app/experimenter/'">+ New Design</button>
            </div>
            <div id="designs-list" class="designs-list">
                <p class="empty-text">No experiment designs yet. Create one in the DOE Workbench.</p>
            </div>
        </div>

        <!-- DSW Analyses Section -->
        <div class="section">
            <div class="section-header">
                <h2>DSW Analyses</h2>
                <button class="btn btn-primary btn-sm" onclick="window.location.href='/app/dsw/?project=' + currentProject.id">+ New Analysis</button>
            </div>
            <div id="dsw-list" class="tool-list">
                <p class="empty-text">No analyses yet. Run analyses in DSW to build evidence.</p>
            </div>
        </div>

        <!-- Whiteboards Section -->
        <div class="section">
            <div class="section-header">
                <h2>Whiteboards</h2>
                <button class="btn btn-primary btn-sm" onclick="window.location.href='/app/whiteboard/?project=' + currentProject.id">+ New Whiteboard</button>
            </div>
            <div id="whiteboards-list" class="tool-list">
                <p class="empty-text">No whiteboards yet. Create one to visualize relationships.</p>
            </div>
        </div>

        <!-- A3 Reports Section -->
        <div class="section">
            <div class="section-header">
                <h2>A3 Reports</h2>
                <button class="btn btn-primary btn-sm" onclick="window.location.href='/app/a3/?project=' + currentProject.id">+ New A3</button>
            </div>
            <div id="a3-list" class="tool-list">
                <p class="empty-text">No A3 reports yet. Create one to structure problem-solving.</p>
            </div>
        </div>

        <!-- VSM Maps Section -->
        <div class="section">
            <div class="section-header">
                <h2>Value Stream Maps</h2>
                <button class="btn btn-primary btn-sm" onclick="window.location.href='/app/vsm/?project=' + currentProject.id">+ New VSM</button>
            </div>
            <div id="vsm-list" class="tool-list">
                <p class="empty-text">No value stream maps yet. Create one to analyze process flow.</p>
            </div>
        </div>

        <!-- Knowledge Graph Section -->
        <div class="section">
            <div class="section-header">
                <h2>Knowledge Graph</h2>
                <button class="btn btn-secondary btn-sm" onclick="openKnowledgeGraph()">Open Graph</button>
            </div>
            <div id="graph-summary" class="graph-summary">
                <p class="empty-text">No knowledge graph yet. Connect hypotheses to build causal relationships.</p>
            </div>
        </div>

        <!-- Conclusion Section (when resolved) -->
        <div class="section" id="conclusion-section" style="display: none;">
            <h2>Conclusion</h2>
            <div class="conclusion-box">
                <span class="conclusion-status" id="conclusion-status-badge"></span>
                <p id="detail-conclusion"></p>
            </div>
        </div>
    </div>
</div>

<!-- Hypothesis Detail View -->
<div id="hypothesis-view" class="detail-view" style="display: none;">
    <div class="detail-header">
        <button class="btn btn-secondary btn-sm" onclick="backToProject()">&larr; Back to Study</button>
        <div class="detail-actions">
            <button class="btn btn-primary btn-sm" onclick="editHypothesis()">Edit</button>
        </div>
    </div>

    <div class="detail-content">
        <div class="hypothesis-info">
            <div class="hypothesis-header">
                <h1 id="hyp-statement">Hypothesis Statement</h1>
                <div class="hyp-meta">
                    <span class="prob-badge" id="hyp-prob">50%</span>
                    <span class="status-badge investigating" id="hyp-status">investigating</span>
                </div>
            </div>
            <div class="mechanism-box" id="mechanism-box">
                <label>Mechanism</label>
                <p id="hyp-mechanism"></p>
            </div>
        </div>

        <!-- Evidence Section -->
        <div class="section">
            <div class="section-header">
                <h2>Evidence</h2>
                <button class="btn btn-primary btn-sm" onclick="showAddEvidenceModal()">+ Add Evidence</button>
            </div>
            <div id="evidence-list" class="evidence-list">
                <p class="empty-text">No evidence yet. Run analyses to gather evidence.</p>
            </div>
        </div>

        <!-- Conversations Section -->
        <div class="section">
            <div class="section-header">
                <h2>Conversations</h2>
                <button class="btn btn-primary btn-sm" onclick="startNewConversation()">+ New Conversation</button>
            </div>
            <div id="conversations-list" class="conversations-list">
                <p class="empty-text">No conversations yet. Start one to explore this hypothesis.</p>
            </div>
        </div>
    </div>
</div>

<!-- Add Workbench Modal -->
<div id="workbench-modal" class="modal" style="display: none;">
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h2>Add Workbench</h2>
            <button class="modal-close" onclick="closeWorkbenchModal()">&times;</button>
        </div>

        <form id="workbench-form" onsubmit="addWorkbench(event)">
            <div class="form-group">
                <label for="wb-title">Title</label>
                <input type="text" id="wb-title" placeholder="e.g., January Batch Analysis" required>
            </div>

            <div class="form-group">
                <label for="wb-template">Template</label>
                <select id="wb-template">
                    <option value="blank">Blank</option>
                    <option value="dmaic">DMAIC</option>
                    <option value="kaizen">Kaizen Event</option>
                    <option value="8d">8D Report</option>
                    <option value="a3">A3 Problem Solving</option>
                </select>
            </div>

            <div class="form-group">
                <label for="wb-description">Description (optional)</label>
                <textarea id="wb-description" rows="2" placeholder="What will this workbench investigate?"></textarea>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeWorkbenchModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Workbench</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Hypothesis Modal (Structured If/Then/Because) -->
<div id="hypothesis-modal" class="modal" style="display: none;">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h2>Add Hypothesis</h2>
            <button class="modal-close" onclick="closeHypothesisModal()">&times;</button>
        </div>

        <form id="hypothesis-form" onsubmit="addHypothesis(event)">
            <!-- Structured Format -->
            <div class="hypothesis-builder">
                <div class="form-group">
                    <label for="hyp-if"><span class="clause-label">IF</span> (condition/change)</label>
                    <textarea id="hyp-if" rows="2" placeholder="e.g., ambient temperature exceeds 85°F during molding"></textarea>
                </div>

                <div class="form-group">
                    <label for="hyp-then"><span class="clause-label">THEN</span> (expected outcome)</label>
                    <textarea id="hyp-then" rows="2" placeholder="e.g., defect rate will increase above 5%"></textarea>
                </div>

                <div class="form-group">
                    <label for="hyp-because"><span class="clause-label">BECAUSE</span> (mechanism)</label>
                    <textarea id="hyp-because" rows="2" placeholder="e.g., thermal expansion causes dimensional variation"></textarea>
                </div>
            </div>

            <!-- Variables -->
            <div class="charter-section collapsible">
                <h3 class="section-toggle" onclick="toggleSection(this)">
                    <span class="toggle-icon">▶</span> Variables
                </h3>
                <div class="section-content" style="display: none;">
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label for="hyp-indep-var">Independent Variable (X)</label>
                            <input type="text" id="hyp-indep-var" placeholder="e.g., Ambient Temperature">
                        </div>
                        <div class="form-group flex-1">
                            <label for="hyp-dep-var">Dependent Variable (Y)</label>
                            <input type="text" id="hyp-dep-var" placeholder="e.g., Defect Rate">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label for="hyp-direction">Expected Direction</label>
                            <select id="hyp-direction">
                                <option value="change">Change</option>
                                <option value="increase">Increase</option>
                                <option value="decrease">Decrease</option>
                                <option value="no_change">No Change</option>
                            </select>
                        </div>
                        <div class="form-group flex-1">
                            <label for="hyp-magnitude">Expected Magnitude</label>
                            <input type="text" id="hyp-magnitude" placeholder="e.g., >10%, ~5 units">
                        </div>
                        <div class="form-group flex-1">
                            <label for="hyp-dep-unit">Unit of Y</label>
                            <input type="text" id="hyp-dep-unit" placeholder="e.g., %, ppm">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Testing Plan -->
            <div class="charter-section collapsible">
                <h3 class="section-toggle" onclick="toggleSection(this)">
                    <span class="toggle-icon">▶</span> Testing Plan
                </h3>
                <div class="section-content" style="display: none;">
                    <div class="form-group">
                        <label for="hyp-rationale">Rationale <small>(why do you think this might be true?)</small></label>
                        <textarea id="hyp-rationale" rows="2" placeholder="Prior observations, domain knowledge..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="hyp-test-method">Test Method <small>(how will you test this?)</small></label>
                        <textarea id="hyp-test-method" rows="2" placeholder="e.g., 2-factor DOE with temperature levels at 70°F and 90°F"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="hyp-success">Success Criteria <small>(what would confirm or refute?)</small></label>
                        <textarea id="hyp-success" rows="2" placeholder="e.g., Confirmed if defect rate > 8% at high temp, refuted if < 3%"></textarea>
                    </div>
                </div>
            </div>

            <!-- Prior Probability -->
            <div class="form-group">
                <label for="hyp-prior">Prior Probability</label>
                <div class="slider-row">
                    <input type="range" id="hyp-prior" min="0" max="1" step="0.05" value="0.5">
                    <span id="hyp-prior-value">50%</span>
                </div>
                <small class="form-hint">Your initial belief before seeing evidence</small>
            </div>

            <!-- Generated Statement Preview -->
            <div class="form-group">
                <label>Generated Statement</label>
                <div id="hyp-statement-preview" class="statement-preview">
                    <em>Fill in the If/Then/Because fields above...</em>
                </div>
                <input type="hidden" id="hyp-statement-input">
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeHypothesisModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Hypothesis</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Evidence Modal -->
<div id="evidence-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add Evidence</h2>
            <button class="modal-close" onclick="closeEvidenceModal()">&times;</button>
        </div>

        <form id="evidence-form" onsubmit="addEvidence(event)">
            <div class="form-group">
                <label for="ev-summary">Summary</label>
                <textarea id="ev-summary" rows="3" required
                    placeholder="What did you observe or discover?"></textarea>
            </div>

            <div class="form-group">
                <label>Source Type</label>
                <select id="ev-type">
                    <option value="observation">Observation</option>
                    <option value="statistical">Data Analysis</option>
                    <option value="simulation">Simulation/Code</option>
                    <option value="experiment">Experiment</option>
                    <option value="research">Literature</option>
                    <option value="expert">Expert Opinion</option>
                </select>
            </div>

            <div class="form-group">
                <label>How much does this evidence support or oppose the hypothesis?</label>
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="ev-direction" value="supports" checked>
                        <span class="radio-badge supports">Supports</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="ev-direction" value="weakens">
                        <span class="radio-badge weakens">Opposes</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="ev-direction" value="neutral">
                        <span class="radio-badge neutral">Neutral</span>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label for="ev-strength">Evidence Strength (Likelihood Ratio)</label>
                <div class="slider-row">
                    <input type="range" id="ev-strength" min="0" max="1" step="0.1" value="0.5">
                    <span id="ev-strength-value">LR: 5.5</span>
                </div>
                <small class="form-hint">
                    How much more likely is this evidence if the hypothesis is true vs. false?
                    <br>LR=1: No effect | LR=3: Weak | LR=10: Strong | LR=30: Very Strong
                </small>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="ev-auto-update" checked>
                    Automatically update hypothesis probability (Bayesian update)
                </label>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEvidenceModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Evidence</button>
            </div>
        </form>
    </div>
</div>

<!-- Upload Dataset Modal -->
<div id="dataset-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Upload Dataset</h2>
            <button class="modal-close" onclick="closeDatasetModal()">&times;</button>
        </div>

        <form id="dataset-form" onsubmit="uploadDataset(event)">
            <div class="form-group">
                <label for="ds-name">Dataset Name</label>
                <input type="text" id="ds-name" placeholder="e.g., Q4 Production Data" required>
            </div>

            <div class="form-group">
                <label for="ds-description">Description (optional)</label>
                <textarea id="ds-description" rows="2" placeholder="What does this data contain?"></textarea>
            </div>

            <div class="form-group">
                <label for="ds-type">Data Type</label>
                <select id="ds-type">
                    <option value="csv">CSV</option>
                    <option value="excel">Excel</option>
                    <option value="json">JSON</option>
                </select>
            </div>

            <div class="form-group">
                <label for="ds-file">File</label>
                <input type="file" id="ds-file" accept=".csv,.xlsx,.xls,.json" required>
                <small class="form-hint">Supported formats: CSV, Excel (.xlsx, .xls), JSON</small>
            </div>

            <div class="form-group">
                <label for="ds-source">Source (optional)</label>
                <input type="text" id="ds-source" placeholder="e.g., ERP System, Manual Entry">
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeDatasetModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" id="upload-btn">Upload Dataset</button>
            </div>
        </form>
    </div>
</div>

<!-- Dataset Detail Modal -->
<div id="dataset-detail-modal" class="modal" style="display: none;">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h2 id="dataset-detail-title">Dataset</h2>
            <button class="modal-close" onclick="closeDatasetDetailModal()">&times;</button>
        </div>
        <div id="dataset-detail-content" class="dataset-detail-content">
            <!-- Filled dynamically -->
        </div>
    </div>
</div>

<style>
.projects-page {
    max-width: 900px;
    margin: 0 auto;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
}

.subtitle {
    color: var(--text-dim);
    margin: 0.25rem 0 0 0;
}

.status-filter {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
}

.filter-btn {
    padding: 0.4rem 0.75rem;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-secondary);
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
}

.filter-btn.active {
    background: var(--accent-primary);
    border-color: var(--accent-primary);
    color: white;
}

.project-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.25rem;
    margin-bottom: 1rem;
    cursor: pointer;
    transition: border-color 0.2s;
}

.project-card:hover {
    border-color: var(--accent-primary);
}

.project-card h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.project-card .hypothesis-preview {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-bottom: 0.75rem;
    font-style: italic;
}

.project-card .meta {
    display: flex;
    gap: 1.5rem;
    font-size: 0.85rem;
    color: var(--text-dim);
}

.status-badge {
    display: inline-block;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    text-transform: uppercase;
    font-weight: 500;
}

.status-badge.active { background: rgba(74, 159, 110, 0.2); color: #4a9f6e; }
.status-badge.completed { background: rgba(99, 102, 241, 0.2); color: #6366f1; }
.status-badge.archived { background: rgba(100, 100, 100, 0.2); color: #888; }

/* Detail View */
.detail-view {
    max-width: 900px;
    margin: 0 auto;
}

.detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.detail-actions {
    display: flex;
    gap: 0.5rem;
}

.project-info {
    margin-bottom: 2rem;
}

.project-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.project-header h1 {
    margin: 0;
    font-size: 1.5rem;
}

.hypothesis-box {
    background: var(--bg-secondary);
    border-left: 3px solid var(--accent-primary);
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 0 4px 4px 0;
}

.hypothesis-box label {
    display: block;
    font-size: 0.75rem;
    color: var(--text-dim);
    text-transform: uppercase;
    margin-bottom: 0.25rem;
}

.hypothesis-box p {
    margin: 0;
    font-size: 1rem;
}

.project-description {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.section {
    margin-bottom: 2rem;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.section-header h2 {
    margin: 0;
    font-size: 1.1rem;
}

.workbenches-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.workbench-item {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: border-color 0.2s;
}

.workbench-item:hover {
    border-color: var(--accent-primary);
}

.workbench-info h4 {
    margin: 0 0 0.25rem 0;
    font-size: 0.95rem;
}

.workbench-info .meta {
    font-size: 0.8rem;
    color: var(--text-dim);
}

.workbench-item .template-badge {
    font-size: 0.7rem;
    padding: 0.2rem 0.4rem;
    background: var(--bg-tertiary);
    border-radius: 3px;
    text-transform: uppercase;
}

.graph-summary {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 1rem;
}

.graph-stats {
    display: flex;
    gap: 2rem;
}

.stat {
    text-align: center;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--accent-primary);
}

.stat-label {
    font-size: 0.75rem;
    color: var(--text-dim);
}

.conclusion-box {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 1rem;
}

.conclusion-status {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    margin-bottom: 0.5rem;
}

.conclusion-status.supported { background: rgba(74, 159, 110, 0.2); color: #4a9f6e; }
.conclusion-status.refuted { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
.conclusion-status.inconclusive { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
.conclusion-status.modified { background: rgba(99, 102, 241, 0.2); color: #6366f1; }

/* Modals */
.modal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background-color: var(--card-bg) !important;
    border: 1px solid var(--border);
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
}

.modal-sm {
    max-width: 400px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border);
}

.modal-header h2 {
    margin: 0;
    font-size: 1.1rem;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--text-dim);
    cursor: pointer;
    line-height: 1;
}

.modal-content form {
    padding: 1.25rem;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    padding-top: 1rem;
    margin-top: 0.5rem;
    border-top: 1px solid var(--border);
}

/* Utilities */
.loading {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 2rem;
    color: var(--text-dim);
}

.spinner {
    width: 24px;
    height: 24px;
    border: 2px solid var(--bg-tertiary);
    border-top-color: var(--accent-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.empty-state {
    text-align: center;
    padding: 3rem;
}

.empty-state h3 {
    margin-bottom: 0.5rem;
}

.empty-state p {
    color: var(--text-dim);
    margin-bottom: 1.5rem;
}

.empty-text {
    color: var(--text-dim);
    font-size: 0.9rem;
}

.btn-sm {
    padding: 0.35rem 0.75rem;
    font-size: 0.85rem;
}

/* Hypotheses */
.hypotheses-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.hypothesis-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 1rem;
    cursor: pointer;
    transition: border-color 0.2s;
}

.hypothesis-card:hover {
    border-color: var(--accent-primary);
}

.hypothesis-card .statement {
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.hypothesis-card .meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.85rem;
}

.prob-badge {
    background: var(--accent-primary);
    color: white;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
}

.prob-badge.low { background: #ef4444; }
.prob-badge.med { background: #f59e0b; }
.prob-badge.high { background: #4a9f6e; }

.status-badge.investigating { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
.status-badge.supported { background: rgba(74, 159, 110, 0.2); color: #4a9f6e; }
.status-badge.refuted { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
.status-badge.inconclusive { background: rgba(100, 100, 100, 0.2); color: #888; }

/* Hypothesis Detail */
.hypothesis-info {
    margin-bottom: 1.5rem;
}

.hypothesis-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 1rem;
}

.hypothesis-header h1 {
    margin: 0;
    font-size: 1.25rem;
    flex: 1;
}

.hyp-meta {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
}

.mechanism-box {
    background: var(--bg-secondary);
    border-left: 3px solid var(--text-dim);
    padding: 0.75rem 1rem;
    border-radius: 0 4px 4px 0;
}

.mechanism-box label {
    display: block;
    font-size: 0.7rem;
    color: var(--text-dim);
    text-transform: uppercase;
    margin-bottom: 0.25rem;
}

.mechanism-box p {
    margin: 0;
    font-size: 0.9rem;
    color: var(--text-secondary);
}

/* Evidence */
.evidence-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.evidence-item {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.75rem 1rem;
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
}

.evidence-item .direction-icon {
    font-size: 1.25rem;
    flex-shrink: 0;
}

.evidence-item .direction-icon.supports { color: #4a9f6e; }
.evidence-item .direction-icon.weakens { color: #ef4444; }
.evidence-item .direction-icon.neutral { color: #888; }

.evidence-item .content {
    flex: 1;
}

.evidence-item .summary {
    margin-bottom: 0.25rem;
}

.evidence-item .meta {
    font-size: 0.75rem;
    color: var(--text-dim);
}

/* Conversations */
.conversations-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.conversation-item {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.75rem 1rem;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: border-color 0.2s;
}

.conversation-item:hover {
    border-color: var(--accent-primary);
}

.conversation-item .title {
    font-weight: 500;
}

.conversation-item .meta {
    font-size: 0.8rem;
    color: var(--text-dim);
}

/* Form extras */
.slider-row {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.slider-row input[type="range"] {
    flex: 1;
}

.slider-row span {
    min-width: 40px;
    text-align: right;
    font-weight: 500;
}

.form-hint {
    display: block;
    color: var(--text-dim);
    font-size: 0.8rem;
    margin-top: 0.25rem;
}

.radio-group {
    display: flex;
    gap: 0.75rem;
}

.radio-label {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    cursor: pointer;
}

.radio-badge {
    padding: 0.25rem 0.6rem;
    border-radius: 4px;
    font-size: 0.85rem;
}

.radio-badge.supports { background: rgba(74, 159, 110, 0.2); color: #4a9f6e; }
.radio-badge.weakens { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
.radio-badge.neutral { background: rgba(100, 100, 100, 0.2); color: #888; }

.form-group input[type="checkbox"] {
    margin-right: 0.5rem;
}

/* Datasets & Experiment Designs */
.datasets-list, .designs-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.dataset-card, .design-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.875rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: border-color 0.2s;
}

.dataset-card:hover, .design-card:hover {
    border-color: var(--accent-primary);
}

.dataset-info, .design-info {
    flex: 1;
}

.dataset-info h4, .design-info h4 {
    margin: 0 0 0.25rem 0;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.dataset-info .meta, .design-info .meta {
    font-size: 0.8rem;
    color: var(--text-dim);
    display: flex;
    gap: 1rem;
}

.dataset-actions, .design-actions {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
}

.type-badge {
    font-size: 0.65rem;
    padding: 0.15rem 0.4rem;
    background: var(--bg-tertiary);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
}

.type-badge.csv { background: rgba(74, 159, 110, 0.2); color: #4a9f6e; }
.type-badge.excel { background: rgba(99, 102, 241, 0.2); color: #6366f1; }
.type-badge.json { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
.type-badge.experiment { background: rgba(168, 85, 247, 0.2); color: #a855f7; }

.design-status {
    font-size: 0.7rem;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    text-transform: uppercase;
}

.design-status.planned { background: rgba(100, 100, 100, 0.2); color: #888; }
.design-status.in_progress { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
.design-status.completed { background: rgba(74, 159, 110, 0.2); color: #4a9f6e; }
.design-status.reviewed { background: rgba(99, 102, 241, 0.2); color: #6366f1; }

.execution-score {
    font-size: 0.8rem;
    font-weight: 600;
}

.execution-score.high { color: #4a9f6e; }
.execution-score.med { color: #f59e0b; }
.execution-score.low { color: #ef4444; }

/* Modal large variant */
.modal-lg {
    max-width: 800px !important;
}

.dataset-detail-content {
    padding: 1.25rem;
    max-height: 70vh;
    overflow-y: auto;
}

.dataset-preview {
    margin-top: 1rem;
    overflow-x: auto;
}

.dataset-preview table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
}

.dataset-preview th, .dataset-preview td {
    padding: 0.5rem;
    border: 1px solid var(--border);
    text-align: left;
}

.dataset-preview th {
    background: var(--bg-secondary);
    font-weight: 500;
}

.header-actions {
    display: flex;
    gap: 0.5rem;
}

/* Tool Lists (DSW, Whiteboards, A3, VSM) */
.tool-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.tool-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.875rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: border-color 0.2s;
}

.tool-card:hover {
    border-color: var(--accent-primary);
}

.tool-info {
    flex: 1;
}

.tool-info h4 {
    margin: 0 0 0.25rem 0;
    font-size: 0.95rem;
}

.tool-info .meta {
    font-size: 0.8rem;
    color: var(--text-dim);
    display: flex;
    gap: 0.75rem;
    align-items: center;
}

.tool-arrow {
    color: var(--text-dim);
    font-size: 1.25rem;
}

.type-badge.current { background: rgba(99, 102, 241, 0.2); color: #6366f1; }
.type-badge.future { background: rgba(74, 159, 110, 0.2); color: #4a9f6e; }

.status-badge.draft { background: rgba(100, 100, 100, 0.2); color: #888; }
.status-badge.in_progress { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
.status-badge.review { background: rgba(99, 102, 241, 0.2); color: #6366f1; }

/* Charter Form Styles */
.charter-section {
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border);
}

.charter-section:last-of-type {
    border-bottom: none;
}

.charter-section.collapsible .section-toggle {
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0;
    padding: 0.5rem 0;
    font-size: 0.95rem;
    color: var(--text-secondary);
    user-select: none;
}

.charter-section.collapsible .section-toggle:hover {
    color: var(--text-primary);
}

.toggle-icon {
    font-size: 0.7rem;
    transition: transform 0.2s;
}

.form-row {
    display: flex;
    gap: 1rem;
    margin-bottom: 0.75rem;
}

.form-row .form-group {
    margin-bottom: 0;
}

.flex-1 { flex: 1; }
.flex-2 { flex: 2; }

.multi-input-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.multi-input-item {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.multi-input-item input {
    flex: 1;
}

.multi-input-item .remove-btn {
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    padding: 0.25rem;
    font-size: 1.25rem;
    line-height: 1;
}

.multi-input-item .remove-btn:hover {
    color: #ef4444;
}

/* Team member inputs */
.team-member-item {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    margin-bottom: 0.5rem;
}

.team-member-item input {
    flex: 1;
}

.team-member-item select {
    width: 120px;
}

/* Hypothesis builder */
.hypothesis-builder {
    background: var(--bg-secondary);
    border-radius: 6px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.clause-label {
    display: inline-block;
    background: var(--accent-primary);
    color: white;
    padding: 0.15rem 0.4rem;
    border-radius: 3px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-right: 0.25rem;
}

.statement-preview {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 0.75rem;
    font-style: italic;
    color: var(--text-secondary);
    min-height: 3rem;
}

/* Charter Detail View */
.charter-display {
    display: grid;
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.charter-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem;
}

.charter-card h3 {
    margin: 0 0 0.75rem 0;
    font-size: 0.85rem;
    text-transform: uppercase;
    color: var(--text-dim);
    letter-spacing: 0.5px;
}

.charter-card .field-row {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 0.5rem;
}

.charter-card .field {
    flex: 1;
}

.charter-card .field-label {
    font-size: 0.75rem;
    color: var(--text-dim);
    margin-bottom: 0.25rem;
}

.charter-card .field-value {
    font-size: 0.9rem;
}

.charter-card .field-value.empty {
    color: var(--text-dim);
    font-style: italic;
}

.charter-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.charter-list li {
    padding: 0.25rem 0;
    padding-left: 1rem;
    position: relative;
}

.charter-list li::before {
    content: "•";
    position: absolute;
    left: 0;
    color: var(--accent-primary);
}

.impact-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 0.75rem;
}

.impact-item {
    background: var(--bg-secondary);
    padding: 0.5rem 0.75rem;
    border-radius: 4px;
}

.impact-item .label {
    font-size: 0.7rem;
    color: var(--text-dim);
    text-transform: uppercase;
}

.impact-item .value {
    font-size: 0.85rem;
}

.goal-display {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
}

.goal-metric {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--accent-primary);
}

.goal-arrow {
    font-size: 1.25rem;
    color: var(--text-dim);
}

.goal-target {
    font-size: 1.5rem;
    font-weight: 600;
    color: #4a9f6e;
}

.goal-deadline {
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.team-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.team-member {
    background: var(--bg-secondary);
    padding: 0.4rem 0.75rem;
    border-radius: 4px;
    font-size: 0.85rem;
}

.team-member .role {
    color: var(--text-dim);
    font-size: 0.75rem;
}

/* Hypothesis clause display */
.clause-row {
    margin-bottom: 0.5rem;
    padding: 0.5rem;
    background: var(--bg-secondary);
    border-radius: 4px;
}

.clause-row:last-child {
    margin-bottom: 0;
}
</style>

<script>
let projects = [];
let currentProject = null;
let currentHypothesis = null;
let currentFilter = 'all';

document.addEventListener('DOMContentLoaded', () => {
    loadProjects();

    // Slider value displays
    document.getElementById('hyp-prior').addEventListener('input', (e) => {
        document.getElementById('hyp-prior-value').textContent = Math.round(e.target.value * 100) + '%';
    });
    document.getElementById('ev-strength').addEventListener('input', (e) => {
        // Map 0-1 slider to likelihood ratio display
        const strength = parseFloat(e.target.value);
        const lr = 1 + strength * 9; // Maps 0→1, 1→10
        document.getElementById('ev-strength-value').textContent = `LR: ${lr.toFixed(1)}`;
    });

    // Hypothesis statement preview
    ['hyp-if', 'hyp-then', 'hyp-because'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', updateHypothesisPreview);
    });
});

// =============================================================================
// Charter Form Helpers
// =============================================================================

function toggleSection(header) {
    const content = header.nextElementSibling;
    const icon = header.querySelector('.toggle-icon');
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '▼';
    } else {
        content.style.display = 'none';
        icon.textContent = '▶';
    }
}

function addListItem(listId) {
    const list = document.getElementById(listId + '-list');
    const item = document.createElement('div');
    item.className = 'multi-input-item';
    item.innerHTML = `
        <input type="text" placeholder="Enter value...">
        <button type="button" class="remove-btn" onclick="this.parentElement.remove()">&times;</button>
    `;
    list.appendChild(item);
    item.querySelector('input').focus();
}

function getListValues(listId) {
    const list = document.getElementById(listId + '-list');
    if (!list) return [];
    return Array.from(list.querySelectorAll('input'))
        .map(input => input.value.trim())
        .filter(val => val !== '');
}

function addTeamMember() {
    const list = document.getElementById('team-members-list');
    const item = document.createElement('div');
    item.className = 'team-member-item';
    item.innerHTML = `
        <input type="text" placeholder="Name">
        <select>
            <option value="member">Member</option>
            <option value="sme">SME</option>
            <option value="facilitator">Facilitator</option>
            <option value="stakeholder">Stakeholder</option>
        </select>
        <input type="text" placeholder="Department" style="width: 120px;">
        <button type="button" class="remove-btn" onclick="this.parentElement.remove()">&times;</button>
    `;
    list.appendChild(item);
    item.querySelector('input').focus();
}

function getTeamMembers() {
    const list = document.getElementById('team-members-list');
    if (!list) return [];
    return Array.from(list.querySelectorAll('.team-member-item'))
        .map(item => {
            const inputs = item.querySelectorAll('input');
            const select = item.querySelector('select');
            return {
                name: inputs[0]?.value.trim() || '',
                role: select?.value || 'member',
                department: inputs[1]?.value.trim() || ''
            };
        })
        .filter(m => m.name !== '');
}

function updateHypothesisPreview() {
    const ifClause = document.getElementById('hyp-if')?.value.trim() || '';
    const thenClause = document.getElementById('hyp-then')?.value.trim() || '';
    const becauseClause = document.getElementById('hyp-because')?.value.trim() || '';

    const preview = document.getElementById('hyp-statement-preview');
    const hidden = document.getElementById('hyp-statement-input');

    if (!ifClause && !thenClause && !becauseClause) {
        preview.innerHTML = '<em>Fill in the If/Then/Because fields above...</em>';
        hidden.value = '';
        return;
    }

    let statement = '';
    if (ifClause) statement += `If ${ifClause}`;
    if (thenClause) statement += `${statement ? ', then ' : 'Then '}${thenClause}`;
    if (becauseClause) statement += `${statement ? ', because ' : 'Because '}${becauseClause}`;
    statement += '.';

    preview.textContent = statement;
    hidden.value = statement;
}

// Close modals when clicking backdrop
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal')) {
        e.target.style.display = 'none';
    }
});

async function loadProjects() {
    const loading = document.getElementById('loading-projects');
    const emptyState = document.getElementById('empty-state');
    const container = document.getElementById('projects-list');

    try {
        let url = '/api/core/projects/';
        if (currentFilter !== 'all') {
            url += `?status=${currentFilter}`;
        }

        const response = await fetch(url, { credentials: 'include' });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        projects = await response.json();
        renderProjects();
    } catch (err) {
        console.error('Failed to load projects:', err);
        // Always hide loading and show empty state on error
        if (loading) loading.style.display = 'none';
        if (container) container.style.display = 'none';
        if (emptyState) {
            emptyState.style.display = 'block';
            emptyState.querySelector('h3').textContent = 'Failed to load projects';
            emptyState.querySelector('p').textContent = 'Please refresh the page or try again later.';
        }
    }
}

function renderProjects() {
    const container = document.getElementById('projects-list');
    const emptyState = document.getElementById('empty-state');
    const loading = document.getElementById('loading-projects');

    loading.style.display = 'none';

    if (projects.length === 0) {
        container.style.display = 'none';
        emptyState.style.display = 'block';
        return;
    }

    emptyState.style.display = 'none';
    container.style.display = 'block';

    container.innerHTML = projects.map(p => `
        <div class="project-card" onclick="viewProject('${p.id}')">
            <h3>
                ${p.title}
                <span class="status-badge ${p.status}">${p.status}</span>
            </h3>
            <p class="hypothesis-preview">"${truncate(p.problem_statement || p.description, 120)}"</p>
            <div class="meta">
                <span>${p.hypothesis_count || 0} hypothes${p.hypothesis_count !== 1 ? 'es' : 'is'}</span>
                <span>${p.evidence_count || 0} evidence</span>
                ${p.domain ? `<span>${p.domain}</span>` : ''}
                <span>Phase: ${p.current_phase || 'define'}</span>
                <span>Updated ${formatDate(p.updated_at)}</span>
            </div>
        </div>
    `).join('');
}

function truncate(str, len) {
    if (!str) return '';
    return str.length > len ? str.slice(0, len) + '...' : str;
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const diff = now - date;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));

    if (days === 0) return 'today';
    if (days === 1) return 'yesterday';
    if (days < 7) return `${days} days ago`;
    return date.toLocaleDateString();
}

function filterByStatus(status) {
    currentFilter = status;
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.status === status);
    });
    loadProjects();
}

function showCreateModal() {
    document.getElementById('create-modal').style.display = 'flex';
    document.getElementById('project-title').focus();
}

function closeModal() {
    document.getElementById('create-modal').style.display = 'none';
    document.getElementById('project-form').reset();
    // Clear multi-input lists
    ['problem-whats', 'problem-wheres', 'problem-whens', 'scope-in', 'scope-out', 'constraints', 'assumptions', 'team-members'].forEach(id => {
        const list = document.getElementById(id + '-list');
        if (list) list.innerHTML = '';
    });
    // Collapse all sections
    document.querySelectorAll('#create-modal .section-content').forEach((el, i) => {
        if (i > 0) el.style.display = 'none';
    });
    document.querySelectorAll('#create-modal .toggle-icon').forEach((el, i) => {
        el.textContent = i === 0 ? '▼' : '▶';
    });
}

async function createProject(e) {
    e.preventDefault();

    // Gather all charter fields
    const data = {
        // Basic
        title: document.getElementById('project-title').value,
        domain: document.getElementById('project-domain').value,

        // Problem Definition (5W2H)
        problem_whats: getListValues('problem-whats'),
        problem_wheres: getListValues('problem-wheres'),
        problem_whens: getListValues('problem-whens'),
        problem_magnitude: document.getElementById('problem-magnitude')?.value || '',
        problem_trend: document.getElementById('problem-trend')?.value || 'unknown',
        problem_since: document.getElementById('problem-since')?.value || '',
        problem_statement: document.getElementById('problem-statement')?.value || '',

        // Business Impact
        impact_financial: document.getElementById('impact-financial')?.value || '',
        impact_customer: document.getElementById('impact-customer')?.value || '',
        impact_quality: document.getElementById('impact-quality')?.value || '',
        impact_delivery: document.getElementById('impact-delivery')?.value || '',
        impact_safety: document.getElementById('impact-safety')?.value || '',
        impact_regulatory: document.getElementById('impact-regulatory')?.value || '',

        // Goal Statement (SMART)
        goal_metric: document.getElementById('goal-metric')?.value || '',
        goal_unit: document.getElementById('goal-unit')?.value || '',
        goal_baseline: document.getElementById('goal-baseline')?.value || '',
        goal_target: document.getElementById('goal-target')?.value || '',
        goal_deadline: document.getElementById('goal-deadline')?.value || null,
        goal_statement: document.getElementById('goal-statement')?.value || '',

        // Scope
        scope_in: getListValues('scope-in'),
        scope_out: getListValues('scope-out'),
        constraints: getListValues('constraints'),
        assumptions: getListValues('assumptions'),

        // Team
        champion_name: document.getElementById('champion-name')?.value || '',
        champion_title: document.getElementById('champion-title')?.value || '',
        leader_name: document.getElementById('leader-name')?.value || '',
        leader_title: document.getElementById('leader-title')?.value || '',
        team_members: getTeamMembers(),

        // Timeline
        target_completion: document.getElementById('target-completion')?.value || null,
        can_experiment: document.getElementById('can-experiment')?.checked ?? true,
    };

    try {
        const response = await fetch('/api/core/projects/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(data),
        });

        const result = await response.json();
        if (response.ok) {
            closeModal();
            viewProject(result.id);
        } else {
            alert(result.error || 'Failed to create study');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

async function viewProject(id) {
    try {
        // Use hub endpoint to get project + all linked tools
        const response = await fetch(`/api/core/projects/${id}/hub/`, { credentials: 'include' });
        const hubData = await response.json();
        currentProject = hubData.project;
        currentProject._tools = hubData.tools;
        currentProject._counts = hubData.counts;
        renderProjectDetail();
    } catch (err) {
        alert('Failed to load study: ' + err.message);
    }
}

async function renderProjectDetail() {
    document.querySelector('.projects-page').style.display = 'none';
    document.getElementById('detail-view').style.display = 'block';
    document.getElementById('hypothesis-view').style.display = 'none';

    const p = currentProject;

    document.getElementById('detail-title').textContent = p.title;
    document.getElementById('detail-status').textContent = p.status;
    document.getElementById('detail-status').className = `status-badge ${p.status}`;

    // Render charter display instead of basic hypothesis box
    renderCharterDisplay(p);

    // Load hypotheses (already in project response from new API)
    renderHypothesesFromProject();

    // Load datasets and experiment designs
    loadDatasets();
    loadExperimentDesigns();

    // Render linked tools from hub API
    renderLinkedTools();

    // Show methodology and phase
    const wbList = document.getElementById('workbenches-list');
    wbList.innerHTML = `
        <div class="methodology-info" style="padding: 1rem; background: var(--bg-secondary); border-radius: 6px;">
            <div style="display: flex; gap: 2rem; margin-bottom: 1rem;">
                <div>
                    <span style="font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase;">Methodology</span>
                    <div style="font-weight: 500;">${p.methodology || 'bayesian'}</div>
                </div>
                <div>
                    <span style="font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase;">Current Phase</span>
                    <div style="font-weight: 500;">${p.current_phase || 'define'}</div>
                </div>
                <div>
                    <span style="font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase;">Can Experiment</span>
                    <div style="font-weight: 500;">${p.can_experiment ? 'Yes' : 'No'}</div>
                </div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-secondary btn-sm" onclick="window.location.href='/app/dsw/?project=${p.id}'">Open in DSW</button>
                <button class="btn btn-secondary btn-sm" onclick="advancePhase()">Advance Phase</button>
            </div>
        </div>
    `;

    // Knowledge Graph summary - use counts from hub API
    const counts = currentProject._counts || {};
    const graphSummary = document.getElementById('graph-summary');
    graphSummary.innerHTML = `
        <div class="graph-stats">
            <div class="stat">
                <div class="stat-value">${p.hypothesis_count || 0}</div>
                <div class="stat-label">Hypotheses</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="evidence-count-stat">-</div>
                <div class="stat-label">Evidence Items</div>
            </div>
            <div class="stat">
                <div class="stat-value">${counts.dsw_analyses || 0}</div>
                <div class="stat-label">Analyses</div>
            </div>
            <div class="stat">
                <div class="stat-value">${counts.whiteboards || 0}</div>
                <div class="stat-label">Whiteboards</div>
            </div>
            <div class="stat">
                <div class="stat-value">${counts.a3_reports || 0}</div>
                <div class="stat-label">A3 Reports</div>
            </div>
            <div class="stat">
                <div class="stat-value">${counts.vsm_maps || 0}</div>
                <div class="stat-label">VSM Maps</div>
            </div>
        </div>
    `;

    // Load evidence count
    loadEvidenceCount();

    // Resolution/Conclusion
    const conclusionSection = document.getElementById('conclusion-section');
    if (p.resolution_summary) {
        conclusionSection.style.display = 'block';
        const status = p.resolution_confidence > 0.7 ? 'supported' : p.resolution_confidence < 0.3 ? 'refuted' : 'inconclusive';
        document.getElementById('conclusion-status-badge').textContent = `${Math.round(p.resolution_confidence * 100)}% confidence`;
        document.getElementById('conclusion-status-badge').className = `conclusion-status ${status}`;
        document.getElementById('detail-conclusion').textContent = p.resolution_summary;
    } else {
        conclusionSection.style.display = 'none';
    }
}

async function loadEvidenceCount() {
    try {
        const response = await fetch(`/api/core/projects/${currentProject.id}/evidence/`, { credentials: 'include' });
        const evidence = await response.json();
        document.getElementById('evidence-count-stat').textContent = evidence.length;
    } catch (err) {
        document.getElementById('evidence-count-stat').textContent = '0';
    }
}

function renderHypothesesFromProject() {
    const hypotheses = currentProject.hypotheses || [];
    const list = document.getElementById('hypotheses-list');

    if (hypotheses.length === 0) {
        list.innerHTML = '<p class="empty-text">No hypotheses yet. Add one to start testing.</p>';
        return;
    }

    list.innerHTML = hypotheses.map(h => {
        const prob = h.current_probability;
        const probClass = prob < 0.3 ? 'low' : prob > 0.7 ? 'high' : 'med';
        const probPct = Math.round(prob * 100);

        // Create a mini probability bar
        const probBar = `
            <div class="prob-bar" style="width: 60px; height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden;">
                <div style="width: ${probPct}%; height: 100%; background: ${prob < 0.3 ? '#ef4444' : prob > 0.7 ? '#4a9f6e' : '#f59e0b'};"></div>
            </div>
        `;

        return `
            <div class="hypothesis-card" onclick="viewHypothesis('${h.id}')">
                <div class="statement">${truncate(h.statement, 100)}</div>
                <div class="meta">
                    <span class="prob-badge ${probClass}">${probPct}%</span>
                    ${probBar}
                    <span class="status-badge ${h.status}">${h.status}</span>
                    <span>${h.evidence_count || 0} evidence</span>
                </div>
            </div>
        `;
    }).join('');
}

async function advancePhase() {
    if (!confirm('Advance to the next phase? This will update the study status.')) return;

    try {
        const response = await fetch(`/api/core/projects/${currentProject.id}/advance-phase/`, {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
            await viewProject(currentProject.id);
        } else {
            const err = await response.json();
            alert(err.error || 'Failed to advance phase');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

// =============================================================================
// Charter Display
// =============================================================================

function renderCharterDisplay(p) {
    const container = document.querySelector('.project-info');

    // Build charter HTML
    let html = `
        <div class="project-header">
            <h1 id="detail-title">${p.title}</h1>
            <span class="status-badge ${p.status}" id="detail-status">${p.status}</span>
        </div>
        <div class="charter-display">
    `;

    // Problem Statement
    if (p.problem_statement || (p.problem_whats && p.problem_whats.length)) {
        html += `
            <div class="charter-card">
                <h3>Problem Statement</h3>
                ${p.problem_statement ? `<p style="margin-bottom: 0.75rem;">${p.problem_statement}</p>` : ''}
                <div class="field-row">
        `;

        if (p.problem_whats && p.problem_whats.length) {
            html += `
                <div class="field">
                    <div class="field-label">What</div>
                    <ul class="charter-list">${p.problem_whats.map(w => `<li>${w}</li>`).join('')}</ul>
                </div>
            `;
        }
        if (p.problem_wheres && p.problem_wheres.length) {
            html += `
                <div class="field">
                    <div class="field-label">Where</div>
                    <ul class="charter-list">${p.problem_wheres.map(w => `<li>${w}</li>`).join('')}</ul>
                </div>
            `;
        }
        if (p.problem_whens && p.problem_whens.length) {
            html += `
                <div class="field">
                    <div class="field-label">When</div>
                    <ul class="charter-list">${p.problem_whens.map(w => `<li>${w}</li>`).join('')}</ul>
                </div>
            `;
        }

        html += `</div>`;

        // Magnitude, trend, since
        if (p.problem_magnitude || p.problem_trend !== 'unknown' || p.problem_since) {
            html += `<div class="field-row" style="margin-top: 0.75rem;">`;
            if (p.problem_magnitude) {
                html += `<div class="field"><div class="field-label">Magnitude</div><div class="field-value">${p.problem_magnitude}</div></div>`;
            }
            if (p.problem_trend && p.problem_trend !== 'unknown') {
                const trendLabels = {increasing: 'Getting Worse', stable: 'Stable', decreasing: 'Improving'};
                html += `<div class="field"><div class="field-label">Trend</div><div class="field-value">${trendLabels[p.problem_trend] || p.problem_trend}</div></div>`;
            }
            if (p.problem_since) {
                html += `<div class="field"><div class="field-label">Since</div><div class="field-value">${p.problem_since}</div></div>`;
            }
            html += `</div>`;
        }

        html += `</div>`;
    }

    // Business Impact
    const impacts = [
        {key: 'impact_financial', label: 'Financial'},
        {key: 'impact_customer', label: 'Customer'},
        {key: 'impact_quality', label: 'Quality'},
        {key: 'impact_delivery', label: 'Delivery'},
        {key: 'impact_safety', label: 'Safety'},
        {key: 'impact_regulatory', label: 'Regulatory'}
    ].filter(i => p[i.key]);

    if (impacts.length > 0) {
        html += `
            <div class="charter-card">
                <h3>Business Impact</h3>
                <div class="impact-grid">
                    ${impacts.map(i => `
                        <div class="impact-item">
                            <div class="label">${i.label}</div>
                            <div class="value">${p[i.key]}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    // Goal Statement
    if (p.goal_statement || p.goal_metric) {
        html += `
            <div class="charter-card">
                <h3>Goal</h3>
                ${p.goal_statement ? `<p style="margin-bottom: 0.75rem;">${p.goal_statement}</p>` : ''}
                ${p.goal_metric ? `
                    <div class="goal-display">
                        <span class="goal-metric">${p.goal_baseline || '?'}</span>
                        <span class="goal-arrow">→</span>
                        <span class="goal-target">${p.goal_target || '?'}</span>
                        <span class="goal-unit">${p.goal_unit || ''}</span>
                        ${p.goal_deadline ? `<span class="goal-deadline">by ${new Date(p.goal_deadline).toLocaleDateString()}</span>` : ''}
                    </div>
                    <div style="margin-top: 0.5rem; color: var(--text-dim); font-size: 0.85rem;">
                        Metric: ${p.goal_metric}
                    </div>
                ` : ''}
            </div>
        `;
    }

    // Scope
    if ((p.scope_in && p.scope_in.length) || (p.scope_out && p.scope_out.length)) {
        html += `
            <div class="charter-card">
                <h3>Scope</h3>
                <div class="field-row">
                    ${p.scope_in && p.scope_in.length ? `
                        <div class="field">
                            <div class="field-label">In Scope</div>
                            <ul class="charter-list">${p.scope_in.map(s => `<li>${s}</li>`).join('')}</ul>
                        </div>
                    ` : ''}
                    ${p.scope_out && p.scope_out.length ? `
                        <div class="field">
                            <div class="field-label">Out of Scope</div>
                            <ul class="charter-list">${p.scope_out.map(s => `<li>${s}</li>`).join('')}</ul>
                        </div>
                    ` : ''}
                </div>
                ${p.constraints && p.constraints.length ? `
                    <div class="field" style="margin-top: 0.75rem;">
                        <div class="field-label">Constraints</div>
                        <ul class="charter-list">${p.constraints.map(c => `<li>${c}</li>`).join('')}</ul>
                    </div>
                ` : ''}
                ${p.assumptions && p.assumptions.length ? `
                    <div class="field" style="margin-top: 0.75rem;">
                        <div class="field-label">Assumptions</div>
                        <ul class="charter-list">${p.assumptions.map(a => `<li>${a}</li>`).join('')}</ul>
                    </div>
                ` : ''}
            </div>
        `;
    }

    // Team
    if (p.champion_name || p.leader_name || (p.team_members && p.team_members.length)) {
        html += `
            <div class="charter-card">
                <h3>Team</h3>
                <div class="field-row">
                    ${p.champion_name ? `
                        <div class="field">
                            <div class="field-label">Champion</div>
                            <div class="field-value">${p.champion_name}${p.champion_title ? ` <span style="color: var(--text-dim);">(${p.champion_title})</span>` : ''}</div>
                        </div>
                    ` : ''}
                    ${p.leader_name ? `
                        <div class="field">
                            <div class="field-label">Project Leader</div>
                            <div class="field-value">${p.leader_name}${p.leader_title ? ` <span style="color: var(--text-dim);">(${p.leader_title})</span>` : ''}</div>
                        </div>
                    ` : ''}
                </div>
                ${p.team_members && p.team_members.length ? `
                    <div class="field" style="margin-top: 0.75rem;">
                        <div class="field-label">Team Members</div>
                        <div class="team-list">
                            ${p.team_members.map(m => `
                                <div class="team-member">
                                    ${m.name}
                                    ${m.role ? `<span class="role">${m.role}</span>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            </div>
        `;
    }

    html += `</div>`; // Close charter-display

    container.innerHTML = html;
}

// =============================================================================
// Hypotheses
// =============================================================================

async function loadHypotheses() {
    try {
        const response = await fetch(`/api/core/projects/${currentProject.id}/hypotheses/`, { credentials: 'include' });
        const hypotheses = await response.json();

        const list = document.getElementById('hypotheses-list');
        if (hypotheses.length === 0) {
            list.innerHTML = '<p class="empty-text">No hypotheses yet. Add one to start testing.</p>';
            return;
        }

        list.innerHTML = hypotheses.map(h => {
            const prob = h.current_probability;
            const probClass = prob < 0.3 ? 'low' : prob > 0.7 ? 'high' : 'med';
            const probPct = Math.round(prob * 100);
            const probBar = `
                <div class="prob-bar" style="width: 60px; height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden;">
                    <div style="width: ${probPct}%; height: 100%; background: ${prob < 0.3 ? '#ef4444' : prob > 0.7 ? '#4a9f6e' : '#f59e0b'};"></div>
                </div>
            `;
            return `
                <div class="hypothesis-card" onclick="viewHypothesis('${h.id}')">
                    <div class="statement">${truncate(h.statement, 100)}</div>
                    <div class="meta">
                        <span class="prob-badge ${probClass}">${probPct}%</span>
                        ${probBar}
                        <span class="status-badge ${h.status}">${h.status}</span>
                        <span>${h.evidence_count || 0} evidence</span>
                    </div>
                </div>
            `;
        }).join('');
    } catch (err) {
        console.error('Failed to load hypotheses:', err);
    }
}

function showAddHypothesisModal() {
    document.getElementById('hypothesis-modal').style.display = 'flex';
    document.getElementById('hyp-statement-input').focus();
}

function closeHypothesisModal() {
    document.getElementById('hypothesis-modal').style.display = 'none';
    document.getElementById('hypothesis-form').reset();
    document.getElementById('hyp-prior-value').textContent = '50%';
    document.getElementById('hyp-statement-preview').innerHTML = '<em>Fill in the If/Then/Because fields above...</em>';
    // Collapse sections
    document.querySelectorAll('#hypothesis-modal .section-content').forEach(el => {
        el.style.display = 'none';
    });
    document.querySelectorAll('#hypothesis-modal .toggle-icon').forEach(el => {
        el.textContent = '▶';
    });
}

async function addHypothesis(e) {
    e.preventDefault();

    // Generate statement from structured fields if not manually set
    const ifClause = document.getElementById('hyp-if')?.value.trim() || '';
    const thenClause = document.getElementById('hyp-then')?.value.trim() || '';
    const becauseClause = document.getElementById('hyp-because')?.value.trim() || '';

    let statement = document.getElementById('hyp-statement-input')?.value || '';
    if (!statement && (ifClause || thenClause)) {
        if (ifClause) statement += `If ${ifClause}`;
        if (thenClause) statement += `${statement ? ', then ' : 'Then '}${thenClause}`;
        if (becauseClause) statement += `${statement ? ', because ' : 'Because '}${becauseClause}`;
        statement += '.';
    }

    if (!statement) {
        alert('Please fill in at least the IF and THEN fields');
        return;
    }

    const data = {
        // Statement (generated or manual)
        statement: statement,

        // Structured clauses
        if_clause: ifClause,
        then_clause: thenClause,
        because_clause: becauseClause,

        // Variables
        independent_variable: document.getElementById('hyp-indep-var')?.value || '',
        dependent_variable: document.getElementById('hyp-dep-var')?.value || '',
        dependent_var_unit: document.getElementById('hyp-dep-unit')?.value || '',
        predicted_direction: document.getElementById('hyp-direction')?.value || 'change',
        predicted_magnitude: document.getElementById('hyp-magnitude')?.value || '',

        // Testing
        rationale: document.getElementById('hyp-rationale')?.value || '',
        test_method: document.getElementById('hyp-test-method')?.value || '',
        success_criteria: document.getElementById('hyp-success')?.value || '',

        // Probability
        prior_probability: parseFloat(document.getElementById('hyp-prior').value),
    };

    try {
        const response = await fetch(`/api/core/projects/${currentProject.id}/hypotheses/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(data),
        });

        const result = await response.json();
        if (response.ok) {
            closeHypothesisModal();
            await loadHypotheses();
        } else {
            alert(result.error || 'Failed to add hypothesis');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

async function viewHypothesis(id) {
    try {
        const response = await fetch(`/api/core/projects/${currentProject.id}/hypotheses/${id}/`, { credentials: 'include' });
        currentHypothesis = await response.json();
        renderHypothesisDetail();
    } catch (err) {
        alert('Failed to load hypothesis: ' + err.message);
    }
}

function renderHypothesisDetail() {
    document.getElementById('detail-view').style.display = 'none';
    document.getElementById('hypothesis-view').style.display = 'block';

    const h = currentHypothesis;
    const prob = h.current_probability;
    const prior = h.prior_probability;

    document.getElementById('hyp-statement').textContent = h.statement;
    const probClass = prob < 0.3 ? 'low' : prob > 0.7 ? 'high' : 'med';
    document.getElementById('hyp-prob').textContent = Math.round(prob * 100) + '%';
    document.getElementById('hyp-prob').className = `prob-badge ${probClass}`;
    document.getElementById('hyp-status').textContent = h.status;
    document.getElementById('hyp-status').className = `status-badge ${h.status}`;

    // Build structured hypothesis display
    const mechBox = document.getElementById('mechanism-box');
    let structuredHtml = '';

    // If/Then/Because structure
    if (h.if_clause || h.then_clause || h.because_clause) {
        structuredHtml += `<div class="hypothesis-structure" style="margin-bottom: 1rem;">`;
        if (h.if_clause) {
            structuredHtml += `<div class="clause-row"><span class="clause-label">IF</span> ${h.if_clause}</div>`;
        }
        if (h.then_clause) {
            structuredHtml += `<div class="clause-row"><span class="clause-label">THEN</span> ${h.then_clause}</div>`;
        }
        if (h.because_clause) {
            structuredHtml += `<div class="clause-row"><span class="clause-label">BECAUSE</span> ${h.because_clause}</div>`;
        }
        structuredHtml += `</div>`;
    }

    // Variables
    if (h.independent_variable || h.dependent_variable) {
        structuredHtml += `
            <div class="variables-display" style="display: flex; gap: 1.5rem; margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px;">
                ${h.independent_variable ? `
                    <div>
                        <div style="font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase;">X (Independent)</div>
                        <div style="font-weight: 500;">${h.independent_variable}</div>
                    </div>
                ` : ''}
                ${h.dependent_variable ? `
                    <div>
                        <div style="font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase;">Y (Dependent)</div>
                        <div style="font-weight: 500;">${h.dependent_variable}${h.dependent_var_unit ? ` (${h.dependent_var_unit})` : ''}</div>
                    </div>
                ` : ''}
                ${h.predicted_direction && h.predicted_direction !== 'change' ? `
                    <div>
                        <div style="font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase;">Expected</div>
                        <div style="font-weight: 500;">${h.predicted_direction}${h.predicted_magnitude ? ` ${h.predicted_magnitude}` : ''}</div>
                    </div>
                ` : ''}
            </div>
        `;
    }

    // Testing info
    if (h.rationale || h.test_method || h.success_criteria) {
        structuredHtml += `<div class="testing-info" style="margin-bottom: 1rem;">`;
        if (h.rationale) {
            structuredHtml += `<div style="margin-bottom: 0.5rem;"><span style="font-weight: 500;">Rationale:</span> ${h.rationale}</div>`;
        }
        if (h.test_method) {
            structuredHtml += `<div style="margin-bottom: 0.5rem;"><span style="font-weight: 500;">Test Method:</span> ${h.test_method}</div>`;
        }
        if (h.success_criteria) {
            structuredHtml += `<div><span style="font-weight: 500;">Success Criteria:</span> ${h.success_criteria}</div>`;
        }
        structuredHtml += `</div>`;
    }

    mechBox.innerHTML = structuredHtml || '<p style="color: var(--text-dim);">No structured details available.</p>';
    mechBox.querySelector('label')?.remove(); // Remove old label

    // Add Bayesian probability evolution display
    const probEvolution = `
        <div class="prob-evolution" style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 6px;">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                <span style="font-size: 0.8rem; color: var(--text-dim);">Prior: ${Math.round(prior * 100)}%</span>
                <div style="flex: 1; height: 8px; background: var(--bg-tertiary); border-radius: 4px; position: relative;">
                    <div style="position: absolute; left: ${prior * 100}%; width: 2px; height: 100%; background: var(--text-dim);"></div>
                    <div style="position: absolute; left: 0; width: ${prob * 100}%; height: 100%; background: ${prob < 0.3 ? '#ef4444' : prob > 0.7 ? '#4a9f6e' : '#f59e0b'}; border-radius: 4px;"></div>
                </div>
                <span style="font-size: 0.8rem; font-weight: 600; color: ${prob < 0.3 ? '#ef4444' : prob > 0.7 ? '#4a9f6e' : '#f59e0b'};">
                    Current: ${Math.round(prob * 100)}%
                </span>
            </div>
            ${h.odds ? `<span style="font-size: 0.75rem; color: var(--text-dim);">Odds: ${h.odds.toFixed(2)}:1</span>` : ''}
        </div>
    `;

    // Insert probability evolution after mechanism box
    const existingProbEvo = document.querySelector('.prob-evolution');
    if (existingProbEvo) existingProbEvo.remove();
    mechBox.insertAdjacentHTML('afterend', probEvolution);

    // Evidence - now using evidence_links with likelihood ratios
    const evList = document.getElementById('evidence-list');
    const evidenceLinks = h.evidence_links || [];

    if (evidenceLinks.length > 0) {
        evList.innerHTML = evidenceLinks.map(link => {
            const lr = link.likelihood_ratio;
            const direction = link.direction;
            const icon = direction === 'supports' ? '↑' : direction === 'opposes' ? '↓' : '→';

            // Format likelihood ratio nicely
            let lrDisplay;
            if (lr >= 1) {
                lrDisplay = `LR: ${lr.toFixed(2)}`;
            } else {
                lrDisplay = `LR: 1/${(1/lr).toFixed(2)}`;
            }

            return `
                <div class="evidence-item">
                    <span class="direction-icon ${direction === 'supports' ? 'supports' : direction === 'opposes' ? 'weakens' : 'neutral'}">${icon}</span>
                    <div class="content">
                        <div class="summary">${link.evidence_summary}</div>
                        <div class="meta">
                            <span class="lr-badge" style="background: ${lr > 1 ? 'rgba(74, 159, 110, 0.2)' : lr < 1 ? 'rgba(239, 68, 68, 0.2)' : 'rgba(100, 100, 100, 0.2)'}; color: ${lr > 1 ? '#4a9f6e' : lr < 1 ? '#ef4444' : '#888'}; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.75rem;">
                                ${lrDisplay}
                            </span>
                            <span>${link.evidence_source || 'manual'}</span>
                            ${link.reasoning ? `<span title="${link.reasoning}">...</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    } else {
        evList.innerHTML = '<p class="empty-text">No evidence yet. Run analyses in DSW to gather evidence.</p>';
    }

    // Conversations - simplified for now
    const convList = document.getElementById('conversations-list');
    convList.innerHTML = `
        <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-secondary btn-sm" onclick="window.location.href='/app/dsw/?project=${currentProject.id}'">Analyze in DSW</button>
        </div>
    `;
}

function backToProject() {
    document.getElementById('hypothesis-view').style.display = 'none';
    document.getElementById('detail-view').style.display = 'block';
    currentHypothesis = null;
    loadHypotheses();
}

function editHypothesis() {
    alert('Edit functionality coming soon');
}

// =============================================================================
// Evidence
// =============================================================================

function showAddEvidenceModal() {
    document.getElementById('evidence-modal').style.display = 'flex';
    document.getElementById('ev-summary').focus();
}

function closeEvidenceModal() {
    document.getElementById('evidence-modal').style.display = 'none';
    document.getElementById('evidence-form').reset();
    document.getElementById('ev-strength-value').textContent = '0.5';
}

async function addEvidence(e) {
    e.preventDefault();

    const direction = document.querySelector('input[name="ev-direction"]:checked').value;
    const strength = parseFloat(document.getElementById('ev-strength').value);

    // Convert strength + direction to likelihood ratio
    // strength 0.5 = mild (LR ~2), strength 1.0 = strong (LR ~10)
    const baseLR = 1 + strength * 9; // Maps 0→1, 1→10
    const lr = direction === 'supports' ? baseLR : direction === 'weakens' ? 1/baseLR : 1.0;

    // Map old evidence types to new source_type
    const typeMapping = {
        'observation': 'observation',
        'statistical': 'data_analysis',
        'simulation': 'simulation',
        'experiment': 'experiment',
        'research': 'literature',
        'expert': 'observation'
    };

    const data = {
        project_id: currentProject.id,
        hypothesis_ids: [currentHypothesis.id],
        summary: document.getElementById('ev-summary').value,
        source_type: typeMapping[document.getElementById('ev-type').value] || 'observation',
        code: '',
        output: {},
        likelihood_ratios: {
            [currentHypothesis.id]: lr
        },
        confidence: 0.8
    };

    try {
        const response = await fetch('/api/core/evidence/from-code/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(data),
        });

        const result = await response.json();
        if (response.ok) {
            closeEvidenceModal();
            await viewHypothesis(currentHypothesis.id);
        } else {
            alert(result.error || 'Failed to add evidence');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

// =============================================================================
// Conversations
// =============================================================================

async function startNewConversation() {
    // Navigate to chat with hypothesis context
    window.location.href = `/chat/?hypothesis=${currentHypothesis.id}&project=${currentProject.id}`;
}

function openConversation(id) {
    window.location.href = `/chat/?conversation=${id}&hypothesis=${currentHypothesis.id}&project=${currentProject.id}`;
}

function backToList() {
    document.getElementById('detail-view').style.display = 'none';
    document.querySelector('.projects-page').style.display = 'block';
    currentProject = null;
    loadProjects();
}

function showAddWorkbenchModal() {
    document.getElementById('workbench-modal').style.display = 'flex';
    document.getElementById('wb-title').focus();
}

function closeWorkbenchModal() {
    document.getElementById('workbench-modal').style.display = 'none';
    document.getElementById('workbench-form').reset();
}

async function addWorkbench(e) {
    e.preventDefault();
    // Navigate to DSW with project context - workbenches are now sessions in DSW
    closeWorkbenchModal();
    window.location.href = `/app/dsw/?project=${currentProject.id}`;
}

function openWorkbench(id) {
    // Navigate to DSW with workbench context
    window.location.href = `/app/dsw/?workbench=${id}`;
}

function openKnowledgeGraph() {
    window.location.href = `/app/knowledge/?project=${currentProject.id}`;
}

function editProject() {
    // TODO: implement edit modal
    alert('Edit functionality coming soon');
}

async function archiveProject() {
    if (!confirm('Archive this study? You can restore it later.')) return;

    try {
        const response = await fetch(`/api/core/projects/${currentProject.id}/`, {
            method: 'DELETE',
            credentials: 'include',
        });

        if (response.ok) {
            backToList();
        } else {
            const result = await response.json();
            alert(result.error || 'Failed to archive study');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

// =============================================================================
// Datasets
// =============================================================================

async function loadDatasets() {
    const datasets = currentProject.datasets || [];
    const list = document.getElementById('datasets-list');

    if (datasets.length === 0) {
        list.innerHTML = '<p class="empty-text">No datasets yet. Upload data to begin analysis.</p>';
        return;
    }

    list.innerHTML = datasets.map(ds => `
        <div class="dataset-card" onclick="viewDataset('${ds.id}')">
            <div class="dataset-info">
                <h4>
                    ${ds.name}
                    <span class="type-badge ${ds.data_type}">${ds.data_type}</span>
                </h4>
                <div class="meta">
                    <span>${ds.row_count || 0} rows</span>
                    ${ds.columns?.length ? `<span>${ds.columns.length} columns</span>` : ''}
                    ${ds.size_display ? `<span>${ds.size_display}</span>` : ''}
                    <span>${formatDate(ds.created_at)}</span>
                </div>
            </div>
            <div class="dataset-actions" onclick="event.stopPropagation()">
                <button class="btn btn-primary btn-sm" onclick="openDatasetInDSW('${ds.id}')">Open in DSW</button>
                <button class="btn btn-secondary btn-sm" onclick="deleteDataset('${ds.id}')">Delete</button>
            </div>
        </div>
    `).join('');
}

function showUploadDatasetModal() {
    document.getElementById('dataset-modal').style.display = 'flex';
    document.getElementById('ds-name').focus();
}

function closeDatasetModal() {
    document.getElementById('dataset-modal').style.display = 'none';
    document.getElementById('dataset-form').reset();
}

async function uploadDataset(e) {
    e.preventDefault();

    const uploadBtn = document.getElementById('upload-btn');
    uploadBtn.textContent = 'Uploading...';
    uploadBtn.disabled = true;

    const formData = new FormData();
    formData.append('name', document.getElementById('ds-name').value);
    formData.append('description', document.getElementById('ds-description').value);
    formData.append('data_type', document.getElementById('ds-type').value);
    formData.append('source', document.getElementById('ds-source').value);
    formData.append('file', document.getElementById('ds-file').files[0]);

    try {
        const response = await fetch(`/api/core/projects/${currentProject.id}/datasets/`, {
            method: 'POST',
            credentials: 'include',
            body: formData,
        });

        const result = await response.json();
        if (response.ok) {
            closeDatasetModal();
            // Reload project to get updated datasets
            await viewProject(currentProject.id);
        } else {
            alert(result.error || 'Failed to upload dataset');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    } finally {
        uploadBtn.textContent = 'Upload Dataset';
        uploadBtn.disabled = false;
    }
}

async function viewDataset(id) {
    try {
        const response = await fetch(`/api/core/projects/${currentProject.id}/datasets/${id}/data/`, { credentials: 'include' });
        const data = await response.json();

        // Find dataset info
        const dataset = currentProject.datasets.find(d => d.id === id);

        document.getElementById('dataset-detail-title').textContent = dataset?.name || 'Dataset';

        const content = document.getElementById('dataset-detail-content');

        // Build preview table (first 20 rows)
        let tableHtml = '';
        if (data.data && data.data.length > 0) {
            const columns = data.columns || Object.keys(data.data[0]);
            const previewRows = data.data.slice(0, 20);

            const rowCount = data.data.length;
            tableHtml = `
                <div class="dataset-meta" style="margin-bottom: 1rem;">
                    <p><strong>Rows:</strong> ${rowCount}</p>
                    <p><strong>Columns:</strong> ${columns.length}</p>
                    ${dataset?.description ? `<p><strong>Description:</strong> ${dataset.description}</p>` : ''}
                </div>
                <div class="dataset-preview">
                    <table>
                        <thead>
                            <tr>${columns.map(c => `<th>${typeof c === 'object' ? c.name : c}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                            ${previewRows.map(row => `
                                <tr>${columns.map(c => {
                                    const colName = typeof c === 'object' ? c.name : c;
                                    const val = row[colName];
                                    return `<td>${val !== null && val !== undefined ? val : ''}</td>`;
                                }).join('')}</tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ${rowCount > 20 ? `<p style="margin-top: 0.5rem; color: var(--text-dim); font-size: 0.85rem;">Showing first 20 of ${rowCount} rows</p>` : ''}
                </div>
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                    <button class="btn btn-primary" onclick="openDatasetInDSW('${id}'); closeDatasetDetailModal();">Open in DSW</button>
                    <button class="btn btn-secondary" onclick="closeDatasetDetailModal()">Close</button>
                </div>
            `;
        } else {
            tableHtml = '<p>No data available for preview.</p>';
        }

        content.innerHTML = tableHtml;
        document.getElementById('dataset-detail-modal').style.display = 'flex';
    } catch (err) {
        alert('Failed to load dataset: ' + err.message);
    }
}

function closeDatasetDetailModal() {
    document.getElementById('dataset-detail-modal').style.display = 'none';
}

function openDatasetInDSW(datasetId) {
    window.location.href = `/app/dsw/?project=${currentProject.id}&dataset=${datasetId}`;
}

async function deleteDataset(id) {
    if (!confirm('Delete this dataset? This cannot be undone.')) return;

    try {
        const response = await fetch(`/api/core/projects/${currentProject.id}/datasets/${id}/`, {
            method: 'DELETE',
            credentials: 'include',
        });

        if (response.ok) {
            await viewProject(currentProject.id);
        } else {
            const result = await response.json();
            alert(result.error || 'Failed to delete dataset');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

// =============================================================================
// Experiment Designs
// =============================================================================

async function loadExperimentDesigns() {
    const designs = currentProject.experiment_designs || [];
    const list = document.getElementById('designs-list');

    if (designs.length === 0) {
        list.innerHTML = '<p class="empty-text">No experiment designs yet. Create one in the DOE Workbench.</p>';
        return;
    }

    list.innerHTML = designs.map(d => {
        const scoreClass = d.execution_score ? (d.execution_score >= 80 ? 'high' : d.execution_score >= 60 ? 'med' : 'low') : '';

        return `
            <div class="design-card" onclick="viewExperimentDesign('${d.id}')">
                <div class="design-info">
                    <h4>
                        ${d.name}
                        <span class="design-status ${d.status}">${d.status.replace('_', ' ')}</span>
                    </h4>
                    <div class="meta">
                        <span>${formatDesignType(d.design_type)}</span>
                        <span>${d.num_runs} runs</span>
                        ${d.factors?.length ? `<span>${d.factors.length} factors</span>` : ''}
                        ${d.execution_score ? `<span class="execution-score ${scoreClass}">Score: ${d.execution_score.toFixed(0)}%</span>` : ''}
                        <span>${formatDate(d.created_at)}</span>
                    </div>
                </div>
                <div class="design-actions" onclick="event.stopPropagation()">
                    ${d.status === 'completed' ? `<button class="btn btn-primary btn-sm" onclick="reviewDesignExecution('${d.id}')">Review Execution</button>` : ''}
                    <button class="btn btn-secondary btn-sm" onclick="openDesignInExperimenter('${d.id}')">View Design</button>
                </div>
            </div>
        `;
    }).join('');
}

function formatDesignType(type) {
    const types = {
        'full_factorial': 'Full Factorial',
        'fractional_factorial': 'Fractional Factorial',
        'ccd': 'Central Composite',
        'box_behnken': 'Box-Behnken',
        'plackett_burman': 'Plackett-Burman',
        'definitive_screening': 'Definitive Screening',
        'taguchi': 'Taguchi',
        'rcbd': 'Randomized Block',
        'latin_square': 'Latin Square',
        'custom': 'Custom'
    };
    return types[type] || type;
}

function viewExperimentDesign(id) {
    // Navigate to experimenter with design loaded
    window.location.href = `/app/experimenter/?design=${id}&project=${currentProject.id}`;
}

function openDesignInExperimenter(id) {
    window.location.href = `/app/experimenter/?design=${id}&project=${currentProject.id}`;
}

async function reviewDesignExecution(designId) {
    // Find the design
    const design = currentProject.experiment_designs?.find(d => d.id === designId);
    if (!design) {
        alert('Design not found');
        return;
    }

    // Find result datasets
    const resultDatasets = currentProject.datasets?.filter(d => d.experiment_design === designId) || [];

    if (resultDatasets.length === 0) {
        alert('No result datasets found for this design. Upload experiment results first.');
        return;
    }

    // Use first result dataset
    const datasetId = resultDatasets[0].id;

    try {
        // First get the data
        const dataResponse = await fetch(`/api/core/projects/${currentProject.id}/datasets/${datasetId}/data/`, { credentials: 'include' });
        const dataResult = await dataResponse.json();

        // Then request execution review
        const response = await fetch(`/api/core/projects/${currentProject.id}/designs/${designId}/review/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ data: dataResult.data }),
        });

        const result = await response.json();
        if (response.ok) {
            // Show review results (backend returns { success, review, design })
            showExecutionReviewModal(result.review);
        } else {
            alert(result.error || 'Failed to review design execution');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

function showExecutionReviewModal(review) {
    // Create a modal to show the execution review
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'flex';
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

    const scoreClass = review.overall_score >= 80 ? 'high' : review.overall_score >= 60 ? 'med' : 'low';
    const grade = review.overall_score >= 90 ? 'A' : review.overall_score >= 80 ? 'B' : review.overall_score >= 70 ? 'C' : review.overall_score >= 60 ? 'D' : 'F';

    modal.innerHTML = `
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2>Design Execution Review</h2>
                <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div style="padding: 1.25rem;">
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <div style="font-size: 3rem; font-weight: 700; color: ${scoreClass === 'high' ? '#4a9f6e' : scoreClass === 'med' ? '#f59e0b' : '#ef4444'}">
                        ${review.overall_score.toFixed(0)}%
                    </div>
                    <div style="font-size: 1.5rem; color: var(--text-dim);">Grade: ${review.grade || grade}</div>
                    <p style="color: var(--text-secondary); margin-top: 0.5rem;">${review.grade_description || ''}</p>
                </div>

                <h3 style="margin-bottom: 1rem;">Metric Breakdown</h3>
                <div style="display: grid; gap: 1rem;">
                    ${Object.entries(review.scores || {}).map(([key, metric]) => `
                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <strong>${formatMetricName(key)}</strong>
                                <span style="color: ${metric.score >= 80 ? '#4a9f6e' : metric.score >= 60 ? '#f59e0b' : '#ef4444'}; font-weight: 600;">
                                    ${metric.score.toFixed(0)}%
                                </span>
                            </div>
                            <div style="height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                                <div style="width: ${metric.score}%; height: 100%; background: ${metric.score >= 80 ? '#4a9f6e' : metric.score >= 60 ? '#f59e0b' : '#ef4444'};"></div>
                            </div>
                            ${metric.description ? `<p style="font-size: 0.85rem; color: var(--text-dim); margin-top: 0.5rem;">${metric.description}</p>` : ''}
                        </div>
                    `).join('')}
                </div>

                ${review.issues?.length ? `
                    <h3 style="margin: 1.5rem 0 1rem;">Issues Found</h3>
                    <ul style="color: #ef4444; padding-left: 1.5rem;">
                        ${review.issues.map(issue => `<li>${issue}</li>`).join('')}
                    </ul>
                ` : ''}

                ${review.recommendations?.length ? `
                    <h3 style="margin: 1.5rem 0 1rem;">Recommendations</h3>
                    <ul style="color: var(--text-secondary); padding-left: 1.5rem;">
                        ${review.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                ` : ''}

                <div style="margin-top: 1.5rem; text-align: right;">
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
}

function formatMetricName(key) {
    const names = {
        'coverage': 'Run Coverage',
        'balance': 'Factor Balance',
        'fidelity': 'Value Fidelity',
        'randomization': 'Randomization Order',
        'sample_quality': 'Sample Quality'
    };
    return names[key] || key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
}

// =============================================================================
// Linked Tools (from Hub API)
// =============================================================================

function renderLinkedTools() {
    const tools = currentProject._tools || {};

    renderDSWAnalyses(tools.dsw_analyses || []);
    renderWhiteboards(tools.whiteboards || []);
    renderA3Reports(tools.a3_reports || []);
    renderVSMMaps(tools.vsm_maps || []);
}

function renderDSWAnalyses(analyses) {
    const list = document.getElementById('dsw-list');

    if (analyses.length === 0) {
        list.innerHTML = '<p class="empty-text">No analyses yet. Run analyses in DSW to build evidence.</p>';
        return;
    }

    list.innerHTML = analyses.map(a => `
        <div class="tool-card" onclick="window.location.href='/app/dsw/?result=${a.id}'">
            <div class="tool-info">
                <h4>${a.title || a.type || 'Analysis'}</h4>
                <div class="meta">
                    <span class="type-badge">${formatAnalysisType(a.type)}</span>
                    ${a.summary ? `<span>${truncate(a.summary, 40)}</span>` : ''}
                    <span>${formatDate(a.created_at)}</span>
                </div>
            </div>
            <span class="tool-arrow">&rarr;</span>
        </div>
    `).join('');
}

function renderWhiteboards(boards) {
    const list = document.getElementById('whiteboards-list');

    if (boards.length === 0) {
        list.innerHTML = '<p class="empty-text">No whiteboards yet. Create one to visualize relationships.</p>';
        return;
    }

    list.innerHTML = boards.map(b => `
        <div class="tool-card" onclick="window.location.href='/app/whiteboard/${b.room_code}/'">
            <div class="tool-info">
                <h4>${b.name || 'Untitled Whiteboard'}</h4>
                <div class="meta">
                    <span>${b.element_count || 0} elements</span>
                    <span>${formatDate(b.updated_at)}</span>
                </div>
            </div>
            <span class="tool-arrow">&rarr;</span>
        </div>
    `).join('');
}

function renderA3Reports(reports) {
    const list = document.getElementById('a3-list');

    if (reports.length === 0) {
        list.innerHTML = '<p class="empty-text">No A3 reports yet. Create one to structure problem-solving.</p>';
        return;
    }

    list.innerHTML = reports.map(r => `
        <div class="tool-card" onclick="window.location.href='/app/a3/${r.id}/'">
            <div class="tool-info">
                <h4>${r.title || 'Untitled A3'}</h4>
                <div class="meta">
                    <span class="status-badge ${r.status || 'draft'}">${r.status || 'draft'}</span>
                    <span>${formatDate(r.updated_at)}</span>
                </div>
            </div>
            <span class="tool-arrow">&rarr;</span>
        </div>
    `).join('');
}

function renderVSMMaps(maps) {
    const list = document.getElementById('vsm-list');

    if (maps.length === 0) {
        list.innerHTML = '<p class="empty-text">No value stream maps yet. Create one to analyze process flow.</p>';
        return;
    }

    list.innerHTML = maps.map(m => `
        <div class="tool-card" onclick="window.location.href='/app/vsm/${m.id}/'">
            <div class="tool-info">
                <h4>${m.name || 'Untitled VSM'}</h4>
                <div class="meta">
                    <span class="type-badge ${m.status || 'draft'}">${m.status || 'draft'}</span>
                    <span>${m.process_count || 0} steps</span>
                    ${m.lead_time ? `<span>Lead: ${formatDuration(m.lead_time)}</span>` : ''}
                    ${m.pce ? `<span>PCE: ${(m.pce * 100).toFixed(1)}%</span>` : ''}
                    <span>${formatDate(m.updated_at)}</span>
                </div>
            </div>
            <span class="tool-arrow">&rarr;</span>
        </div>
    `).join('');
}

function formatAnalysisType(type) {
    if (!type) return 'Analysis';
    // Convert result_type like "descriptive_summary" to "Descriptive"
    const first = type.split('_')[0];
    return first.charAt(0).toUpperCase() + first.slice(1);
}

function formatDuration(seconds) {
    if (!seconds) return '-';
    if (seconds < 60) return `${seconds.toFixed(0)}s`;
    if (seconds < 3600) return `${(seconds/60).toFixed(1)}m`;
    if (seconds < 86400) return `${(seconds/3600).toFixed(1)}h`;
    return `${(seconds/86400).toFixed(1)}d`;
}
</script>
{% endblock %}
