{% extends "base_app.html" %}
{% block title %}Triage - Data Cleaning{% endblock %}

{% block content %}
<div class="triage-container">
    <div class="triage-header">
        <h1>Triage</h1>
        <p class="subtitle">Data cleaning with human review. Upload, preview issues, clean, download.</p>
    </div>

    <!-- Upload Panel -->
    <div class="panel upload-panel">
        <div class="panel-header">
            <span class="panel-title">Upload Data</span>
        </div>
        <div class="panel-content">
            <div class="upload-zone" id="upload-zone">
                <input type="file" id="file-input" accept=".csv" style="display: none;">
                <div class="upload-icon">üìÅ</div>
                <p>Drop CSV file here or <a href="#" onclick="document.getElementById('file-input').click(); return false;">browse</a></p>
                <p class="upload-hint">Supports CSV files up to 50MB</p>
            </div>
            <div id="file-info" style="display: none;">
                <span id="file-name"></span>
                <button class="btn btn-secondary btn-sm" onclick="clearFile()">Clear</button>
            </div>
        </div>
    </div>

    <!-- Preview/Issues Panel -->
    <div class="panel issues-panel" id="issues-panel" style="display: none;">
        <div class="panel-header">
            <span class="panel-title">Data Issues</span>
            <button class="btn btn-primary" onclick="runCleaning()">Clean Data</button>
        </div>
        <div class="panel-content" id="issues-content"></div>
    </div>

    <!-- Config Panel -->
    <div class="panel config-panel" id="config-panel" style="display: none;">
        <div class="panel-header">
            <span class="panel-title">Cleaning Options</span>
            <button class="btn-icon" onclick="toggleConfig()" title="Toggle">‚ñº</button>
        </div>
        <div class="panel-content" id="config-content">
            <div class="config-grid">
                <label class="config-option">
                    <input type="checkbox" id="opt-outliers" checked>
                    <span>Detect outliers</span>
                </label>
                <label class="config-option">
                    <input type="checkbox" id="opt-missing" checked>
                    <span>Handle missing data</span>
                </label>
                <label class="config-option">
                    <input type="checkbox" id="opt-normalize" checked>
                    <span>Normalize factors</span>
                </label>
                <label class="config-option">
                    <input type="checkbox" id="opt-types" checked>
                    <span>Correct types</span>
                </label>
            </div>
            <div class="config-row">
                <label>Case style:</label>
                <select id="case-style">
                    <option value="title">Title Case</option>
                    <option value="lower">lowercase</option>
                    <option value="upper">UPPERCASE</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Results Panel -->
    <div class="panel results-panel" id="results-panel" style="display: none;">
        <div class="panel-header">
            <span class="panel-title">Cleaning Results</span>
            <div class="panel-actions">
                <button class="btn btn-primary" id="download-btn" onclick="downloadCleanedData()">Download CSV</button>
            </div>
        </div>
        <div class="panel-content">
            <div id="results-summary"></div>
            <div id="results-report" class="markdown-output"></div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay" style="display: none;">
    <div class="spinner"></div>
    <div class="loading-text" id="loading-text">Processing...</div>
</div>

<style>
.triage-container {
    max-width: 900px;
    margin: 0 auto;
}

.triage-header {
    margin-bottom: 1.5rem;
}

.triage-header h1 {
    font-size: 1.75rem;
    margin-bottom: 0.25rem;
}

.triage-header .subtitle {
    color: var(--text-dim);
    font-size: 0.9rem;
}

.panel {
    background: var(--bg-tertiary);
    border-radius: 8px;
    border: 1px solid rgba(74, 159, 110, 0.2);
    margin-bottom: 1rem;
    overflow: hidden;
}

.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: rgba(0, 0, 0, 0.2);
    border-bottom: 1px solid rgba(74, 159, 110, 0.1);
}

.panel-title {
    font-weight: 600;
    font-size: 0.95rem;
}

.panel-content {
    padding: 1.25rem;
}

.upload-zone {
    border: 2px dashed rgba(74, 159, 110, 0.3);
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
}

.upload-zone:hover, .upload-zone.dragover {
    border-color: var(--accent-primary);
    background: rgba(74, 159, 110, 0.05);
}

.upload-icon {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

.upload-zone p {
    margin: 0.25rem 0;
}

.upload-zone a {
    color: var(--accent-primary);
}

.upload-hint {
    font-size: 0.8rem;
    color: var(--text-dim);
}

#file-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem;
    background: var(--bg-secondary);
    border-radius: 4px;
    margin-top: 1rem;
}

#file-name {
    flex: 1;
    font-family: monospace;
}

.config-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.config-option {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
}

.config-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.config-row label {
    font-size: 0.9rem;
}

.config-row select {
    padding: 0.4rem 0.75rem;
    background: var(--bg-secondary);
    border: 1px solid rgba(74, 159, 110, 0.2);
    border-radius: 4px;
    color: var(--text-primary);
}

.issue-card {
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 4px;
    margin-bottom: 0.75rem;
}

.issue-card h4 {
    margin: 0 0 0.5rem 0;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.issue-card p {
    margin: 0;
    font-size: 0.85rem;
    color: var(--text-dim);
}

.issue-badge {
    font-size: 0.7rem;
    padding: 0.15rem 0.4rem;
    border-radius: 3px;
    font-weight: 600;
}

.issue-badge.warning {
    background: rgba(232, 197, 71, 0.2);
    color: #e8c547;
}

.issue-badge.info {
    background: rgba(74, 159, 110, 0.2);
    color: var(--accent-primary);
}

.recommendations {
    margin-top: 1rem;
    padding: 1rem;
    background: rgba(74, 159, 110, 0.1);
    border-radius: 4px;
    border-left: 3px solid var(--accent-primary);
}

.recommendations h4 {
    margin: 0 0 0.5rem 0;
    font-size: 0.9rem;
}

.recommendations ul {
    margin: 0;
    padding-left: 1.25rem;
}

.recommendations li {
    font-size: 0.85rem;
    margin-bottom: 0.25rem;
}

#results-summary {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.summary-stat {
    text-align: center;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 6px;
}

.summary-stat .value {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--accent-primary);
}

.summary-stat .label {
    font-size: 0.8rem;
    color: var(--text-dim);
    margin-top: 0.25rem;
}

.markdown-output {
    line-height: 1.6;
}

.markdown-output h1, .markdown-output h2, .markdown-output h3 {
    margin-top: 1.25rem;
    margin-bottom: 0.5rem;
}

.markdown-output table {
    width: 100%;
    border-collapse: collapse;
    margin: 0.75rem 0;
    font-size: 0.85rem;
}

.markdown-output th, .markdown-output td {
    padding: 0.5rem;
    border: 1px solid rgba(74, 159, 110, 0.2);
    text-align: left;
}

.markdown-output th {
    background: var(--bg-secondary);
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--bg-tertiary);
    border-top-color: var(--accent-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-text {
    margin-top: 1rem;
    color: var(--text-secondary);
}

.btn-sm {
    padding: 0.3rem 0.6rem;
    font-size: 0.8rem;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
let uploadedFile = null;
let currentJobId = null;

// File upload handling
const uploadZone = document.getElementById('upload-zone');
const fileInput = document.getElementById('file-input');

uploadZone.addEventListener('click', () => fileInput.click());

uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragover');
});

uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragover');
});

uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    if (e.dataTransfer.files.length) {
        handleFile(e.dataTransfer.files[0]);
    }
});

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length) {
        handleFile(e.target.files[0]);
    }
});

function handleFile(file) {
    if (!file.name.endsWith('.csv')) {
        alert('Only CSV files are supported');
        return;
    }
    uploadedFile = file;
    document.getElementById('file-name').textContent = file.name;
    document.getElementById('file-info').style.display = 'flex';
    document.getElementById('upload-zone').style.display = 'none';
    previewIssues();
}

function clearFile() {
    uploadedFile = null;
    fileInput.value = '';
    document.getElementById('file-info').style.display = 'none';
    document.getElementById('upload-zone').style.display = 'block';
    document.getElementById('issues-panel').style.display = 'none';
    document.getElementById('config-panel').style.display = 'none';
    document.getElementById('results-panel').style.display = 'none';
}

async function previewIssues() {
    showLoading('Analyzing data...');

    const formData = new FormData();
    formData.append('file', uploadedFile);

    try {
        const response = await fetch('/api/triage/preview/', {
            method: 'POST',
            body: formData,
            credentials: 'include',
        });
        const data = await response.json();
        hideLoading();

        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }

        renderIssues(data.issues, data.recommendations);
        document.getElementById('issues-panel').style.display = 'block';
        document.getElementById('config-panel').style.display = 'block';

    } catch (err) {
        hideLoading();
        alert('Failed to preview: ' + err.message);
    }
}

function renderIssues(issues, recommendations) {
    const container = document.getElementById('issues-content');
    let html = `
        <div class="issue-card">
            <h4>üìä Dataset Shape</h4>
            <p>${issues.shape.rows.toLocaleString()} rows √ó ${issues.shape.columns} columns</p>
        </div>
    `;

    // Missing data
    const missingCols = Object.keys(issues.missing);
    if (missingCols.length > 0) {
        html += `
            <div class="issue-card">
                <h4>‚ö†Ô∏è Missing Data <span class="issue-badge warning">${missingCols.length} columns</span></h4>
                <p>${missingCols.slice(0, 5).map(col =>
                    `${col}: ${issues.missing[col].count} (${issues.missing[col].percent.toFixed(1)}%)`
                ).join(', ')}${missingCols.length > 5 ? '...' : ''}</p>
            </div>
        `;
    }

    // Outliers
    const outlierCols = Object.keys(issues.outliers);
    if (outlierCols.length > 0) {
        const totalOutliers = outlierCols.reduce((sum, col) => sum + issues.outliers[col].count, 0);
        html += `
            <div class="issue-card">
                <h4>üîç Potential Outliers <span class="issue-badge warning">${totalOutliers} values</span></h4>
                <p>Found in: ${outlierCols.join(', ')}</p>
            </div>
        `;
    }

    // Type issues
    if (issues.type_issues.length > 0) {
        html += `
            <div class="issue-card">
                <h4>üîÑ Type Suggestions <span class="issue-badge info">${issues.type_issues.length}</span></h4>
                <p>${issues.type_issues.slice(0, 3).map(t =>
                    `${t.column}: ${t.current} ‚Üí ${t.suggested}`
                ).join(', ')}</p>
            </div>
        `;
    }

    // Recommendations
    if (recommendations.length > 0) {
        html += `
            <div class="recommendations">
                <h4>üí° Recommendations</h4>
                <ul>${recommendations.map(r => `<li>${r}</li>`).join('')}</ul>
            </div>
        `;
    }

    container.innerHTML = html;
}

async function runCleaning() {
    showLoading('Cleaning data...');

    const formData = new FormData();
    formData.append('file', uploadedFile);
    formData.append('config', JSON.stringify({
        detect_outliers: document.getElementById('opt-outliers').checked,
        handle_missing: document.getElementById('opt-missing').checked,
        normalize_factors: document.getElementById('opt-normalize').checked,
        correct_types: document.getElementById('opt-types').checked,
        case_style: document.getElementById('case-style').value,
    }));

    try {
        const response = await fetch('/api/triage/clean/', {
            method: 'POST',
            body: formData,
            credentials: 'include',
        });
        const data = await response.json();
        hideLoading();

        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }

        currentJobId = data.job_id;
        renderResults(data);
        document.getElementById('results-panel').style.display = 'block';

    } catch (err) {
        hideLoading();
        alert('Failed to clean: ' + err.message);
    }
}

function renderResults(data) {
    // Summary stats
    document.getElementById('results-summary').innerHTML = `
        <div class="summary-stat">
            <div class="value">${data.preview.original_rows.toLocaleString()}</div>
            <div class="label">Original Rows</div>
        </div>
        <div class="summary-stat">
            <div class="value">${data.preview.cleaned_rows.toLocaleString()}</div>
            <div class="label">Cleaned Rows</div>
        </div>
        <div class="summary-stat">
            <div class="value">${data.outliers_flagged}</div>
            <div class="label">Outliers Flagged</div>
        </div>
        <div class="summary-stat">
            <div class="value">${data.missing_filled}</div>
            <div class="label">Missing Filled</div>
        </div>
    `;

    // Markdown report
    document.getElementById('results-report').innerHTML = marked.parse(data.report);
}

function downloadCleanedData() {
    if (!currentJobId) {
        alert('No cleaned data available');
        return;
    }
    window.location.href = `/api/triage/${currentJobId}/download/`;
}

function toggleConfig() {
    const content = document.getElementById('config-content');
    content.style.display = content.style.display === 'none' ? 'block' : 'none';
}

function showLoading(text) {
    document.getElementById('loading-text').textContent = text;
    document.getElementById('loading-overlay').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loading-overlay').style.display = 'none';
}
</script>
{% endblock %}
