{% extends "base.html" %}
{% block title %}Scrub - Data Cleaning{% endblock %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <a href="/" style="color: var(--text-dim); text-decoration: none;">&larr; Back to Home</a>
</div>

<h1 style="margin-bottom: 0.5rem;">Scrub</h1>
<p style="color: var(--text-dim); margin-bottom: 2rem;">
    Automatic data cleaning: outliers, missing values, type correction, normalization.
</p>

<!-- Features Overview -->
<div class="grid grid-2" style="margin-bottom: 2rem;">
    <div class="card">
        <span class="tag tag-orange" style="margin-bottom: 0.5rem;">Outlier Detection</span>
        <p style="margin: 0; font-size: 0.9rem;">IQR, Z-score, Isolation Forest. Outliers are <strong>flagged, not removed</strong> - you decide.</p>
    </div>
    <div class="card">
        <span class="tag tag-blue" style="margin-bottom: 0.5rem;">Missing Data</span>
        <p style="margin: 0; font-size: 0.9rem;">Smart imputation: mean, median, mode, forward fill. Reports what was filled.</p>
    </div>
    <div class="card">
        <span class="tag tag-purple" style="margin-bottom: 0.5rem;">Type Correction</span>
        <p style="margin: 0; font-size: 0.9rem;">Automatic type inference and conversion. Strings to numbers, dates, booleans.</p>
    </div>
    <div class="card">
        <span class="tag tag-green" style="margin-bottom: 0.5rem;">Normalization</span>
        <p style="margin: 0; font-size: 0.9rem;">Case normalization, whitespace trimming, fuzzy matching for typos.</p>
    </div>
</div>

<!-- Upload Form -->
<div class="card">
    <h3>Upload Data</h3>
    <form id="scrub-form" enctype="multipart/form-data">
        <div class="form-group">
            <label for="file">CSV File</label>
            <input type="file" id="file" name="file" accept=".csv" class="file-input" required>
        </div>

        <div class="form-group">
            <label for="domain-rules">Domain Rules (optional)</label>
            <p style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 0.5rem;">
                Define valid ranges for numeric columns. JSON format.
            </p>
            <textarea id="domain-rules" name="domain_rules" rows="4" placeholder='{
  "age": [0, 120],
  "salary": [0, null],
  "score": [0, 100]
}'></textarea>
        </div>

        <button type="submit" class="btn btn-primary">Clean Data</button>
    </form>
</div>

<!-- Results -->
<div id="results" class="card" style="display: none; margin-top: 2rem;">
    <h3>Cleaning Results</h3>
    <div id="results-content"></div>

    <div id="download-section" style="margin-top: 1.5rem; display: none;">
        <a id="download-data" class="btn btn-primary" href="#">Download Cleaned Data</a>
    </div>
</div>

<!-- Loading -->
<div id="loading" style="display: none; text-align: center; padding: 3rem;">
    <div class="spinner"></div>
    <p style="margin-top: 1rem; color: var(--text-dim);">Cleaning data...</p>
</div>

<style>
.spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--card-bg);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.stat-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 1rem;
    margin: 1.5rem 0;
}

.stat-card {
    background: var(--card-bg);
    border: 1px solid rgba(74, 159, 110, 0.2);
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
}

.stat-value {
    font-size: 1.75rem;
    font-weight: 600;
    color: var(--accent);
}

.stat-label {
    font-size: 0.8rem;
    color: var(--text-dim);
    margin-top: 0.25rem;
}

.warning-list {
    background: rgba(255, 183, 77, 0.1);
    border: 1px solid rgba(255, 183, 77, 0.3);
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
}

.warning-list h4 {
    color: var(--orange);
    margin-bottom: 0.5rem;
}

.warning-list ul {
    margin: 0;
    padding-left: 1.25rem;
}

.summary-box {
    background: rgba(74, 159, 110, 0.1);
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1.5rem;
}

.summary-box pre {
    white-space: pre-wrap;
    margin: 0;
    font-family: inherit;
    font-size: 0.9rem;
}
</style>

<script>
document.getElementById('scrub-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const loading = document.getElementById('loading');
    const results = document.getElementById('results');

    loading.style.display = 'block';
    results.style.display = 'none';

    const formData = new FormData();
    formData.append('file', document.getElementById('file').files[0]);

    const domainRules = document.getElementById('domain-rules').value.trim();
    if (domainRules) {
        formData.append('domain_rules', domainRules);
    }

    try {
        const response = await fetch('/api/scrub', {
            method: 'POST',
            body: formData,
        });

        const result = await response.json();

        if (result.error) {
            showError(result.error);
            return;
        }

        showResults(result);

    } catch (err) {
        showError(err.message);
    } finally {
        loading.style.display = 'none';
    }
});

function showResults(result) {
    const container = document.getElementById('results-content');
    const download = document.getElementById('download-section');

    let html = `
        <div class="stat-grid">
            <div class="stat-card">
                <div class="stat-value">${result.original_shape[0]}</div>
                <div class="stat-label">Original Rows</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${result.cleaned_shape[0]}</div>
                <div class="stat-label">Cleaned Rows</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${result.outliers_flagged}</div>
                <div class="stat-label">Outliers Flagged</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${result.high_severity}</div>
                <div class="stat-label">High Severity</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${result.missing_filled}</div>
                <div class="stat-label">Missing Filled</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${result.normalizations}</div>
                <div class="stat-label">Normalizations</div>
            </div>
        </div>
    `;

    // Warnings
    if (result.warnings && result.warnings.length > 0) {
        html += `
            <div class="warning-list">
                <h4>Warnings</h4>
                <ul>${result.warnings.map(w => `<li>${w}</li>`).join('')}</ul>
            </div>
        `;
    }

    // Summary
    if (result.summary) {
        html += `
            <div class="summary-box">
                <pre>${result.summary}</pre>
            </div>
        `;
    }

    container.innerHTML = html;

    // Download button
    if (result.result_id) {
        document.getElementById('download-data').href = `/api/download/${result.result_id}/data`;
        download.style.display = 'block';
    }

    document.getElementById('results').style.display = 'block';
}

function showError(message) {
    const container = document.getElementById('results-content');
    container.innerHTML = `
        <div style="color: #ff6b6b; padding: 1rem; background: rgba(255, 107, 107, 0.1); border-radius: 8px;">
            <strong>Error:</strong> ${message}
        </div>
    `;
    document.getElementById('results').style.display = 'block';
    document.getElementById('download-section').style.display = 'none';
}
</script>
{% endblock %}
